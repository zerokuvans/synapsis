{% extends "base.html" %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Edición de Asistencia</h1>
    
    <!-- Información de zona horaria -->
    <div class="alert alert-info mb-4">
        <div class="d-flex align-items-center">
            <div>
                <i class="fas fa-clock me-2"></i>
            </div>
            <div>
                <p class="mb-1"><strong>Zona horaria:</strong> Bogotá, Colombia</p>
                <p class="mb-0">Fecha y hora actual: <span id="reloj-bogota" class="badge bg-secondary"></span></p>
            </div>
        </div>
    </div>
    
    <!-- Cuadro de Resumen de Asistencia por Grupos -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Resumen de Asistencia por Grupos
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Filtros para el resumen -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="supervisorResumen" class="form-label">Supervisor:</label>
                            <select class="form-select" id="supervisorResumen">
                                <option value="">Todos los supervisores</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="fechaInicioResumen" class="form-label">Fecha:</label>
                            <input type="date" class="form-control" id="fechaInicioResumen">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-primary w-100" id="btnActualizarResumen">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Contenedor para las tablas lado a lado -->
                    <div class="row">
                        <!-- Nueva Tabla: OPERACIÓN X RECURSO OPERATIVO -->
                        <div class="col-md-6">
                            <div id="tablaOperacionCard" class="mb-4">
                                <h6 class="text-primary mb-3">
                                    <i class="fas fa-cogs me-2"></i>OPERACIÓN X RECURSO OPERATIVO
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="tablaOperacionRecurso">
                                        <thead class="table-primary">
                                            <tr>
                                                <th>GRUPO</th>
                                                <th>CARPETA</th>
                                                <th>TÉCNICOS</th>
                                                <th>PORCENTAJE</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cuerpoTablaOperacion">
                                            <!-- Los datos se cargarán dinámicamente -->
                                        </tbody>
                                        <tfoot class="table-info">
                                            <tr>
                                                <th colspan="2">TOTAL OPERATIVO</th>
                                                <th id="totalTecnicosOperativo">0</th>
                                                <th>100%</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tabla de resumen agrupado tradicional -->
                        <div class="col-md-6">
                            <div id="tablaResumenCard" class="mb-4">
                                <h6 class="text-secondary mb-3">
                                    <i class="fas fa-chart-pie me-2"></i>OPERACIÓN X CARPETA DIA
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="tablaResumenAgrupado">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>GRUPO</th>
                                                <th>CARPETA</th>
                                                <th>TÉCNICOS</th>
                                                <th>PORCENTAJE</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cuerpoTablaResumen">
                                            <!-- Los datos se cargarán dinámicamente -->
                                        </tbody>
                                        <tfoot class="table-secondary">
                                            <tr>
                                                <th colspan="2">TOTAL GENERAL</th>
                                                <th id="totalTecnicosGeneral">0</th>
                                                <th>100%</th>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mensaje de carga -->
                    <div id="mensajeCargaResumen" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando resumen de asistencia...</p>
                    </div>
                    
                    <!-- Mensaje cuando no hay datos -->
                    <div id="mensajeSinDatosResumen" class="alert alert-info" style="display: none;">
                        <i class="fas fa-info-circle me-2"></i>
                        No se encontraron registros de asistencia para los filtros seleccionados.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Asistencias Generales por Carpetas
                    </h5>
                </div>
                <div class="card-body">
                    <div id="mensajeCargaCategorias" class="text-center" style="display: none;">
                        <div class="spinner-border text-info" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando categorías...</p>
                    </div>
                    <div id="mensajeSinDatosCategorias" class="alert alert-info" style="display: none;">
                        No se encontraron registros para los filtros seleccionados.
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-3">OPERACIÓN</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tablaOperacionesCarpeta">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>carpeta_dia</th>
                                            <th>Cuenta de cédula</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cuerpoTablaOperaciones"></tbody>
                                    <tfoot class="table-info">
                                        <tr>
                                            <th>Total general</th>
                                            <th id="totalOperacionesGeneral">0</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-3">AUXILIARES Y CAMIONETA</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tablaAuxiliaresCamioneta">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>carpeta_dia</th>
                                            <th>Cuenta de cédula</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cuerpoTablaAuxCam"></tbody>
                                    <tfoot class="table-info">
                                        <tr>
                                            <th>Total general</th>
                                            <th id="totalAuxCamGeneral">0</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-3">INCAPACIDAD U OTROS</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tablaIncapacidadOtros">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>carpeta</th>
                                            <th>Cuenta de cédula</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cuerpoTablaIncapacidad"></tbody>
                                    <tfoot class="table-info">
                                        <tr>
                                            <th>Total general</th>
                                            <th id="totalIncapacidadGeneral">0</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-secondary mb-3">AUSENCIAS</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="tablaAusencias">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>carpeta</th>
                                            <th>Cuenta de cédula</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cuerpoTablaAusencias"></tbody>
                                    <tfoot class="table-info">
                                        <tr>
                                            <th>Total general</th>
                                            <th id="totalAusenciasGeneral">0</th>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="modalDetalleAsistencia" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalDetalleTitulo">Detalle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modalDetalleCarga" class="text-center" style="display:none;">
                        <div class="spinner-border" role="status"></div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Técnico</th>
                                    <th>Cédula</th>
                                    <th>Supervisor</th>
                                    <th>Carpeta</th>
                                    <th>Carpeta Día</th>
                                </tr>
                            </thead>
                            <tbody id="modalDetalleCuerpo"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de Gráficas Temporales -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>Análisis Temporal por Grupos
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Controles de las gráficas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="fechaInicioGraficas" class="form-label">Fecha Inicio:</label>
                            <input type="date" class="form-control" id="fechaInicioGraficas">
                        </div>
                        <div class="col-md-3">
                            <label for="fechaFinGraficas" class="form-label">Fecha Fin:</label>
                            <input type="date" class="form-control" id="fechaFinGraficas">
                        </div>
                        <div class="col-md-3">
                            <label for="supervisorGraficas" class="form-label">Supervisor:</label>
                            <select class="form-select" id="supervisorGraficas">
                                <option value="">Todos los supervisores</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-success w-100" id="btnActualizarGraficas">
                                <i class="fas fa-sync-alt me-1"></i>Actualizar Gráficas
                            </button>
                        </div>
                    </div>
                    
                    <!-- Pestañas para las gráficas -->
                    <ul class="nav nav-tabs" id="graficasTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="operacion-recurso-tab" data-bs-toggle="tab" data-bs-target="#operacion-recurso" type="button" role="tab">
                                <i class="fas fa-cogs me-2"></i>OPERACIÓN X RECURSO OPERATIVO
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="carpeta-dia-tab" data-bs-toggle="tab" data-bs-target="#carpeta-dia" type="button" role="tab">
                                <i class="fas fa-chart-pie me-2"></i>OPERACIÓN X CARPETA DIA
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Contenido de las pestañas -->
                    <div class="tab-content" id="graficasTabContent">
                        <!-- Gráfica Operación x Recurso Operativo -->
                        <div class="tab-pane fade show active" id="operacion-recurso" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-12">
                                    <!-- Controles de visualización -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="tipoOperacionRecurso" id="mesOperacionRecurso" value="mes" checked>
                                            <label class="btn btn-outline-primary" for="mesOperacionRecurso">MES A MES</label>
                                            
                                            <input type="radio" class="btn-check" name="tipoOperacionRecurso" id="diaOperacionRecurso" value="dia">
                                            <label class="btn btn-outline-primary" for="diaOperacionRecurso">DÍA A DÍA</label>
                                        </div>
                                        
                                        <!-- Controles de visibilidad de grupos -->
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="toggleArreglosOR" data-grupo="ARREGLOS">
                                                <i class="fas fa-eye me-1"></i>ARREGLOS
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="toggleInstalacionesOR" data-grupo="INSTALACIONES">
                                                <i class="fas fa-eye me-1"></i>INSTALACIONES
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" id="togglePostventaOR" data-grupo="POSTVENTA">
                                                <i class="fas fa-eye me-1"></i>POSTVENTA
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Canvas para la gráfica -->
                                    <div class="chart-container" style="position: relative; height: 400px;">
                                        <canvas id="graficaOperacionRecurso"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Gráfica Operación x Carpeta Día -->
                        <div class="tab-pane fade" id="carpeta-dia" role="tabpanel">
                            <div class="row mt-3">
                                <div class="col-12">
                                    <!-- Controles de visualización -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="btn-group" role="group">
                                            <input type="radio" class="btn-check" name="tipoCarpetaDia" id="mesCarpetaDia" value="mes" checked>
                                            <label class="btn btn-outline-primary" for="mesCarpetaDia">MES A MES</label>
                                            
                                            <input type="radio" class="btn-check" name="tipoCarpetaDia" id="diaCarpetaDia" value="dia">
                                            <label class="btn btn-outline-primary" for="diaCarpetaDia">DÍA A DÍA</label>
                                        </div>
                                        
                                        <!-- Controles de visibilidad de grupos -->
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-danger" id="toggleArreglosCD" data-grupo="ARREGLOS">
                                                <i class="fas fa-eye me-1"></i>ARREGLOS
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="toggleInstalacionesCD" data-grupo="INSTALACIONES">
                                                <i class="fas fa-eye me-1"></i>INSTALACIONES
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-warning" id="togglePostventaCD" data-grupo="POSTVENTA">
                                                <i class="fas fa-eye me-1"></i>POSTVENTA
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Canvas para la gráfica -->
                                    <div class="chart-container" style="position: relative; height: 400px;">
                                        <canvas id="graficaCarpetaDia"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Mensaje de carga para gráficas -->
                    <div id="mensajeCargaGraficas" class="text-center mt-3" style="display: none;">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando datos de las gráficas...</p>
                    </div>
                    
                    <!-- Mensaje cuando no hay datos para gráficas -->
                    <div id="mensajeSinDatosGraficas" class="alert alert-warning mt-3" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No se encontraron datos para generar las gráficas en el período seleccionado.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sección de registro oculta -->
    <div style="display: none;">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-user-clock me-1"></i>
                Registrar Nueva Asistencia
            </div>
            <div class="card-body">
                <form id="formAsistencia" class="row g-3">
                    <div class="col-md-4">
                        <label for="supervisor" class="form-label">Supervisor</label>
                        <select class="form-select" id="supervisor" name="supervisor" required onchange="cargarTecnicosPorSupervisor()">
                            <option value="">Seleccione un supervisor</option>
                            {% for supervisor in supervisores %}
                            <option value="{{ supervisor }}">{{ supervisor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabla de técnicos del supervisor seleccionado -->
        <div class="card mt-4" id="tablaTecnicosCard" style="display: none;">
            <div class="card-header pb-0">
                <h6>Técnicos del Supervisor</h6>
                <p class="text-sm mb-0">Seleccione la carpeta día para cada técnico</p>
            </div>
            <div class="card-body px-0 pt-0 pb-2">
                <div class="table-responsive p-0">
                    <table class="table align-items-center mb-0" id="tablaTecnicos">
                        <thead>
                            <tr>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Técnico</th>
                                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Cédula</th>
                                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Carpeta Día</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTablaTecnicos">
                            <!-- Los técnicos se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-primary" id="btnRegistrarAsistencia" onclick="registrarAsistenciaCompleta()" disabled>
                        <i class="fas fa-save me-2"></i>Registrar Asistencia
                    </button>
                </div>
        
        <div class="card mb-4" style="display: none;">
            <div class="card-header">
                <i class="fas fa-table me-1"></i>
                Asistencias por Registrar
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="tablaAsistencias">
                        <thead>
                            <tr>
                                <th>Cédula</th>
                                <th>Técnico</th>
                                <th>Carpeta Día</th>
                                <th>Carpeta</th>
                                <th>Supervisor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
                
                <button type="button" class="btn btn-success" onclick="guardarAsistencias()" id="btnGuardar" disabled>
                    <i class="fas fa-save me-1"></i> Guardar Todas las Asistencias
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Sección de Exportación a Excel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-file-excel me-2"></i>Exportación a Excel
                </h5>
            </div>
            <div class="card-body">
                <!-- Filtros para exportación -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="supervisorExportacion" class="form-label">Supervisor:</label>
                        <select class="form-select" id="supervisorExportacion">
                            <option value="">Seleccione un supervisor</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="fechaInicio" class="form-label">Fecha Inicio:</label>
                        <input type="date" class="form-control" id="fechaInicio">
                    </div>
                    <div class="col-md-3">
                        <label for="fechaFin" class="form-label">Fecha Fin:</label>
                        <input type="date" class="form-control" id="fechaFin">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-success w-100" id="btnExportarExcel" onclick="exportarAsistenciaExcel()">
                            <i class="fas fa-file-excel me-1"></i>Exportar
                        </button>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Seleccione un supervisor y el rango de fechas para exportar los registros de asistencia a Excel.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sección de Edición de Asistencia -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>Edición de Asistencia
                </h5>
            </div>
            <div class="card-body">
                <!-- Filtros de búsqueda -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="supervisorEdicion" class="form-label">Supervisor:</label>
                        <select class="form-select" id="supervisorEdicion" onchange="cargarRegistrosAsistencia()">
                            <option value="">Seleccione un supervisor</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="fechaEdicion" class="form-label">Fecha:</label>
                        <input type="date" class="form-control" id="fechaEdicion" onchange="cargarRegistrosAsistencia()">
                    </div>
                </div>
                
                <!-- Tabla de registros para edición -->
                <div id="tablaEdicionCard" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tablaEdicionAsistencias">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cédula</th>
                                    <th>Técnico</th>
                                    <th>Carpeta Día</th>
                                    <th>Carpeta</th>
                                    <th>Supervisor</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los registros se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-success" id="btnGuardarCambios" onclick="guardarCambiosEdicion()" disabled>
                            <i class="fas fa-save me-2"></i>Guardar Cambios
                        </button>
                        <button type="button" class="btn btn-secondary ms-2" onclick="cancelarEdicion()">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </button>
                    </div>
                </div>
                
                <!-- Mensaje cuando no hay registros -->
                <div id="mensajeSinRegistros" class="alert alert-info" style="display: none;">
                    <i class="fas fa-info-circle me-2"></i>
                    No se encontraron registros de asistencia para el supervisor y fecha seleccionados.
                </div>
                
                <!-- Alerta informativa sobre restricciones de edición -->
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Restricciones de edición:</strong> Solo se pueden editar registros de asistencia de los últimos 4 días (incluyendo el día actual). 
                    Los registros más antiguos aparecerán deshabilitados y marcados con <i class="fas fa-lock"></i>.
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let asistencias = [];

// Inicializar reloj de Bogotá
document.addEventListener('DOMContentLoaded', function() {
    actualizarRelojBogota();
    setInterval(actualizarRelojBogota, 1000);
});

// Función para actualizar el reloj de Bogotá
function actualizarRelojBogota() {
    const relojBogota = document.getElementById('reloj-bogota');
    if (relojBogota) {
        const ahora = new Date();
        // Opciones para formatear fecha y hora en Colombia
        const opcionesBogota = { 
            timeZone: 'America/Bogota',
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: true
        };
        
        // Formatear fecha y hora de Bogotá
        const fechaHoraFormateada = ahora.toLocaleString('es-CO', opcionesBogota);
        relojBogota.textContent = fechaHoraFormateada;
    }
}

// Obtener fecha y hora actual en Bogotá en formato ISO
function obtenerFechaHoraBogota() {
    try {
        // Crear un objeto Date con la zona horaria actual
        const ahora = new Date();
        
        // Obtener el offset en minutos para Bogotá (America/Bogota = UTC-5)
        const offsetBogota = -5 * 60; // -5 horas en minutos
        
        // Obtener el offset local del navegador en minutos
        const offsetLocal = ahora.getTimezoneOffset();
        
        // Calcular la diferencia en milisegundos entre la zona horaria local y Bogotá
        const diferencia = (offsetLocal - offsetBogota) * 60 * 1000;
        
        // Ajustar el timestamp para obtener la hora de Bogotá
        const timestampBogota = ahora.getTime() + diferencia;
        
        // Crear una nueva fecha con el timestamp ajustado
        const fechaBogota = new Date(timestampBogota);
        
        // Formatear la fecha en formato estándar para la base de datos (YYYY-MM-DD HH:MM:SS)
        const año = fechaBogota.getFullYear();
        const mes = String(fechaBogota.getMonth() + 1).padStart(2, '0');
        const dia = String(fechaBogota.getDate()).padStart(2, '0');
        const hora = String(fechaBogota.getHours()).padStart(2, '0');
        const minutos = String(fechaBogota.getMinutes()).padStart(2, '0');
        const segundos = String(fechaBogota.getSeconds()).padStart(2, '0');
        
        const fechaFormateada = `${año}-${mes}-${dia} ${hora}:${minutos}:${segundos}`;
        
        console.log("Fecha y hora en Bogotá:", fechaFormateada);
        
        return fechaFormateada;
    } catch (error) {
        console.error("Error al calcular fecha de Bogotá:", error);
        // En caso de error, enviar un objeto con información sobre el error
        return new Date().toLocaleString('es-CO');
    }
}

// Variable global para almacenar técnicos del supervisor
let tecnicosDelSupervisor = [];

// Función para cargar técnicos por supervisor
async function cargarTecnicosPorSupervisor() {
    const supervisorSelect = document.getElementById('supervisor');
    const supervisor = supervisorSelect.value;
    
    if (!supervisor) {
        document.getElementById('tablaTecnicosCard').style.display = 'none';
        document.getElementById('btnRegistrarAsistencia').disabled = true;
        tecnicosDelSupervisor = [];
        return;
    }
    
    try {
        const response = await fetch(`/api/tecnicos_por_supervisor?supervisor=${encodeURIComponent(supervisor)}`);
        const data = await response.json();
        
        if (data.success) {
            tecnicosDelSupervisor = data.tecnicos;
            console.log('Técnicos cargados:', tecnicosDelSupervisor.length);
            mostrarTablaTecnicos(data.tecnicos);
            document.getElementById('tablaTecnicosCard').style.display = 'block';
            // Validar después de cargar los técnicos
            validarFormularioCompleto();
        } else {
            alert('Error al cargar técnicos: ' + data.message);
            tecnicosDelSupervisor = [];
            document.getElementById('btnRegistrarAsistencia').disabled = true;
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al cargar técnicos del supervisor');
        tecnicosDelSupervisor = [];
        document.getElementById('btnRegistrarAsistencia').disabled = true;
    }
}

// Función para mostrar la tabla de técnicos
function mostrarTablaTecnicos(tecnicos) {
    const cuerpoTabla = document.getElementById('cuerpoTablaTecnicos');
    cuerpoTabla.innerHTML = '';
    
    tecnicos.forEach(tecnico => {
        const fila = document.createElement('tr');
        fila.innerHTML = `
            <td>
                <div class="d-flex px-2 py-1">
                    <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">${tecnico.nombre}</h6>
                    </div>
                </div>
            </td>
            <td>
                <p class="text-xs font-weight-bold mb-0">${tecnico.recurso_operativo_cedula}</p>
            </td>
            <td class="align-middle text-center">
                <select class="form-select form-select-sm" id="carpeta_${tecnico.id_codigo_consumidor}" onchange="validarFormularioCompleto()">
                    <option value="">Seleccione carpeta día...</option>
                    {% for carpeta in carpetas_dia %}
                    <option value="{{ carpeta.codigo_tipificacion }}">
                        {{ carpeta.codigo_tipificacion }} - {{ carpeta.nombre_tipificacion }}
                    </option>
                    {% endfor %}
                </select>
            </td>
        `;
        cuerpoTabla.appendChild(fila);
    });
}

// Función para validar que todos los técnicos tengan carpeta día seleccionada
function validarFormularioCompleto() {
    const supervisor = document.getElementById('supervisor').value;
    
    // Si no hay supervisor seleccionado, deshabilitar botón
    if (!supervisor) {
        document.getElementById('btnRegistrarAsistencia').disabled = true;
        return;
    }
    
    // Si no hay técnicos cargados, deshabilitar botón
    if (!tecnicosDelSupervisor || tecnicosDelSupervisor.length === 0) {
        document.getElementById('btnRegistrarAsistencia').disabled = true;
        return;
    }
    
    let todoCompleto = true;
    
    tecnicosDelSupervisor.forEach(tecnico => {
        const select = document.getElementById(`carpeta_${tecnico.id_codigo_consumidor}`);
        if (!select || !select.value) {
            todoCompleto = false;
        }
    });
    
    console.log('Validación completa:', {
        supervisor: supervisor,
        tecnicosCount: tecnicosDelSupervisor.length,
        todoCompleto: todoCompleto
    });
    
    document.getElementById('btnRegistrarAsistencia').disabled = !todoCompleto;
}

// Función para registrar asistencia completa
async function registrarAsistenciaCompleta() {
    const supervisor = document.getElementById('supervisor').value;
    const fechaAsistencia = obtenerFechaHoraBogota();
    
    const asistenciasCompletas = [];
    
    tecnicosDelSupervisor.forEach(tecnico => {
        const carpetaSelect = document.getElementById(`carpeta_${tecnico.id_codigo_consumidor}`);
        if (carpetaSelect && carpetaSelect.value) {
            asistenciasCompletas.push({
                id_codigo_consumidor: tecnico.id_codigo_consumidor,
                cedula: tecnico.recurso_operativo_cedula,
                tecnico: tecnico.nombre,
                carpeta_dia: carpetaSelect.value,
                carpeta: tecnico.carpeta || '',
                super: supervisor,
                fecha_registro_bogota: fechaAsistencia
            });
        }
    });
    
    if (asistenciasCompletas.length === 0) {
        alert('No hay asistencias para registrar');
        return;
    }
    
    try {
        const response = await fetch('/api/asistencia/guardar', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ asistencias: asistenciasCompletas })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Asistencias registradas exitosamente: ${asistenciasCompletas.length} técnicos`);
            // Limpiar formulario
            document.getElementById('supervisor').value = '';
            document.getElementById('tablaTecnicosCard').style.display = 'none';
            document.getElementById('btnRegistrarAsistencia').disabled = true;
            tecnicosDelSupervisor = [];
        } else {
            alert('Error al guardar asistencias: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error al guardar las asistencias');
    }
}

function agregarAsistencia() {
    const tecnicoSelect = document.getElementById('tecnico');
    const tecnicoOption = tecnicoSelect.selectedOptions[0];
    
    if (!validarFormulario()) {
        return;
    }
    
    const asistencia = {
        id_codigo_consumidor: tecnicoSelect.value,
        cedula: tecnicoOption.dataset.cedula,
        tecnico: tecnicoOption.dataset.nombre,
        carpeta_dia: document.getElementById('carpeta_dia').value,
        carpeta: tecnicoOption.dataset.carpeta,
        super: document.getElementById('super').value,
        // Agregar zona horaria de Bogotá
        fecha_registro_bogota: obtenerFechaHoraBogota()
    };
    
    asistencias.push(asistencia);
    actualizarTabla();
    limpiarFormulario();
    document.getElementById('btnGuardar').disabled = false;
}

function validarFormulario() {
    const campos = ['tecnico', 'carpeta_dia', 'super'];
    let valido = true;
    
    campos.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (!elemento.value) {
            elemento.classList.add('is-invalid');
            valido = false;
        } else {
            elemento.classList.remove('is-invalid');
        }
    });
    
    if (!valido) {
        mostrarAlerta('Por favor complete todos los campos requeridos', 'danger');
    }
    
    return valido;
}

function actualizarTabla() {
    const tbody = document.querySelector('#tablaAsistencias tbody');
    tbody.innerHTML = '';
    
    asistencias.forEach((asistencia, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${asistencia.cedula}</td>
            <td>${asistencia.tecnico}</td>
            <td>${asistencia.carpeta_dia}</td>
            <td>${asistencia.carpeta}</td>
            <td>${asistencia.super}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="eliminarAsistencia(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function eliminarAsistencia(index) {
    asistencias.splice(index, 1);
    actualizarTabla();
    document.getElementById('btnGuardar').disabled = asistencias.length === 0;
}

function limpiarFormulario() {
    document.getElementById('formAsistencia').reset();
}

function guardarAsistencias() {
    if (asistencias.length === 0) {
        mostrarAlerta('No hay asistencias para guardar', 'warning');
        return;
    }
    
    // Actualizar la fecha y hora en todas las asistencias al momento de guardar
    const fechaHoraBogota = obtenerFechaHoraBogota();
    asistencias.forEach(asistencia => {
        asistencia.fecha_registro_bogota = fechaHoraBogota;
    });
    
    // Crear objeto de datos a enviar con información explícita sobre zona horaria
    const datosEnvio = {
        asistencias: asistencias,
        zona_horaria: 'America/Bogota',
        offset_horas: -5, // Bogotá está en UTC-5
        formato_fecha: 'YYYY-MM-DD HH:MM:SS'
    };
    
    // Mostrar lo que se está enviando (para depuración)
    console.log("Enviando datos al servidor:", JSON.stringify(datosEnvio, null, 2));
    
    fetch('/api/asistencia/guardar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(datosEnvio)
    })
    .then(response => {
        if (!response.ok) {
            console.error("Error en respuesta HTTP:", response.status, response.statusText);
            // Intenta obtener el texto de error
            return response.text().then(text => {
                throw new Error(`Error HTTP: ${response.status}. Detalles: ${text}`);
            });
        }
        return response.json();
    })
    .then(data => {
        console.log("Respuesta del servidor:", data);
        if (data.success) {
            mostrarAlerta('Asistencias guardadas correctamente', 'success');
            asistencias = [];
            actualizarTabla();
            document.getElementById('btnGuardar').disabled = true;
        } else {
            mostrarAlerta(data.message || 'Error desconocido al guardar las asistencias', 'danger');
        }
    })
    .catch(error => {
        console.error('Error completo:', error);
        mostrarAlerta(`Error al guardar las asistencias: ${error.message}`, 'danger');
    });
}

function mostrarAlerta(mensaje, tipo) {
    const alertaDiv = document.createElement('div');
    alertaDiv.className = `alert alert-${tipo} alert-dismissible fade show`;
    alertaDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertaDiv, container.firstChild);
    
    setTimeout(() => {
        alertaDiv.remove();
    }, 5000);
}

// Variables para la edición
let registrosEdicion = [];
let registrosModificados = [];
let tipificacionesDisponibles = [];
let supervisoresDisponibles = [];

// Cargar tipificaciones disponibles
async function cargarTipificaciones() {
    try {
        const response = await fetch('/api/asistencia/tipificacion', {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            tipificacionesDisponibles = data.tipificaciones;
        }
    } catch (error) {
        console.error('Error cargando tipificaciones:', error);
    }
}

// Cargar supervisores disponibles
async function cargarSupervisoresDisponibles() {
    try {
        const response = await fetch('/api/asistencia/supervisores', {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (data.success) {
            supervisoresDisponibles = data.supervisores;
        }
    } catch (error) {
        console.error('Error cargando supervisores:', error);
    }
}

// Cargar supervisores para ambas secciones
async function cargarSupervisoresEdicion() {
    try {
        const response = await fetch('/api/supervisores');
        const data = await response.json();
        
        if (data.success) {
            // Cargar supervisores para la sección de edición
            const selectEdicion = document.getElementById('supervisorEdicion');
            selectEdicion.innerHTML = '<option value="">Seleccione un supervisor</option>';
            
            // Cargar supervisores para la sección de exportación
            const selectExportacion = document.getElementById('supervisorExportacion');
            selectExportacion.innerHTML = '<option value="">Seleccione un supervisor</option>';
            
            // Agregar opción "Todos" solo para exportación
            const optionTodos = document.createElement('option');
            optionTodos.value = 'TODOS';
            optionTodos.textContent = 'Todos los supervisores';
            selectExportacion.appendChild(optionTodos);
            
            data.supervisores.forEach(supervisor => {
                // Opción para edición
                const optionEdicion = document.createElement('option');
                optionEdicion.value = supervisor;
                optionEdicion.textContent = supervisor;
                selectEdicion.appendChild(optionEdicion);
                
                // Opción para exportación
                const optionExportacion = document.createElement('option');
                optionExportacion.value = supervisor;
                optionExportacion.textContent = supervisor;
                selectExportacion.appendChild(optionExportacion);
            });
        }
    } catch (error) {
        console.error('Error cargando supervisores:', error);
        mostrarAlerta('Error al cargar supervisores', 'danger');
    }
}

// Cargar registros de asistencia para edición
async function cargarRegistrosAsistencia() {
    const supervisor = document.getElementById('supervisorEdicion').value;
    const fechaEdicion = document.getElementById('fechaEdicion').value;
    
    if (!supervisor || !fechaEdicion) {
        const tablaEdicionCard = document.getElementById('tablaEdicionCard');
        const mensajeSinRegistros = document.getElementById('mensajeSinRegistros');
        if (tablaEdicionCard) tablaEdicionCard.style.display = 'none';
        if (mensajeSinRegistros) mensajeSinRegistros.style.display = 'none';
        return;
    }
    
    try {
        // Cargar tipificaciones y supervisores si no están cargados
        if (tipificacionesDisponibles.length === 0) {
            await cargarTipificaciones();
        }
        if (supervisoresDisponibles.length === 0) {
            await cargarSupervisoresDisponibles();
        }
        
        // Construir URL con parámetros
        let url = `/api/asistencia/consultar?supervisor=${encodeURIComponent(supervisor)}&fecha=${fechaEdicion}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
            registrosEdicion = data.registros;
            registrosModificados = [];
            
            if (registrosEdicion.length > 0) {
                mostrarTablaEdicion();
                const tablaEdicionCard = document.getElementById('tablaEdicionCard');
                const mensajeSinRegistros = document.getElementById('mensajeSinRegistros');
                if (tablaEdicionCard) tablaEdicionCard.style.display = 'block';
                if (mensajeSinRegistros) mensajeSinRegistros.style.display = 'none';
            } else {
                const tablaEdicionCard = document.getElementById('tablaEdicionCard');
                const mensajeSinRegistros = document.getElementById('mensajeSinRegistros');
                if (tablaEdicionCard) tablaEdicionCard.style.display = 'none';
                if (mensajeSinRegistros) mensajeSinRegistros.style.display = 'block';
            }
        } else {
            mostrarAlerta('Error al cargar registros: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('Error al cargar registros de asistencia', 'danger');
    }
}

// Función para validar si una fecha está dentro del rango editable (4 días hacia atrás)
function esFechaEditable(fechaAsistencia) {
    const fechaRegistro = new Date(fechaAsistencia);
    const fechaActual = new Date();
    
    // Normalizar fechas a medianoche para comparación exacta de días
    fechaRegistro.setHours(0, 0, 0, 0);
    fechaActual.setHours(0, 0, 0, 0);
    
    const diferenciaDias = Math.floor((fechaActual - fechaRegistro) / (1000 * 60 * 60 * 24));
    
    return diferenciaDias >= 0 && diferenciaDias <= 4;
}

// Crear select de tipificaciones
function crearSelectTipificacion(valorActual, index, disabled = false) {
    let options = '<option value="">Seleccione...</option>';
    tipificacionesDisponibles.forEach(tip => {
        const selected = tip.codigo === valorActual ? 'selected' : '';
        options += `<option value="${tip.codigo}" ${selected}>${tip.codigo} - ${tip.descripcion}</option>`;
    });
    return `<select class="form-control form-control-sm" ${disabled ? 'disabled' : ''} onchange="marcarModificado(${index}, 'carpeta_dia', this.value)">${options}</select>`;
}

// Crear select de supervisores
function crearSelectSupervisor(valorActual, index, disabled = false) {
    console.log('crearSelectSupervisor - valorActual:', valorActual);
    console.log('crearSelectSupervisor - supervisoresDisponibles:', supervisoresDisponibles);
    
    let options = '<option value="">Seleccione...</option>';
    let encontrado = false;
    
    supervisoresDisponibles.forEach(sup => {
        const selected = sup === valorActual ? 'selected' : '';
        if (selected) encontrado = true;
        options += `<option value="${sup}" ${selected}>${sup}</option>`;
    });
    
    // Si no se encontró el supervisor en la lista, agregarlo como opción seleccionada
    if (!encontrado && valorActual && valorActual.trim() !== '') {
        console.log('Supervisor no encontrado en lista, agregando:', valorActual);
        options += `<option value="${valorActual}" selected>${valorActual}</option>`;
    }
    
    return `<select class="form-control form-control-sm" ${disabled ? 'disabled' : ''} onchange="marcarModificado(${index}, 'super', this.value)">${options}</select>`;
}

// Mostrar tabla de edición
function mostrarTablaEdicion() {
    const tbody = document.querySelector('#tablaEdicionAsistencias tbody');
    tbody.innerHTML = '';
    
    registrosEdicion.forEach((registro, index) => {
        const esEditable = esFechaEditable(registro.fecha_asistencia);
        const fechaRegistro = new Date(registro.fecha_asistencia);
        const fechaActual = new Date();
        fechaRegistro.setHours(0, 0, 0, 0);
        fechaActual.setHours(0, 0, 0, 0);
        const diferenciaDias = Math.floor((fechaActual - fechaRegistro) / (1000 * 60 * 60 * 24));
        
        const tr = document.createElement('tr');
        
        // Agregar clase visual para registros no editables
        if (!esEditable) {
            tr.classList.add('table-secondary');
            tr.style.opacity = '0.6';
        }
        
        tr.innerHTML = `
            <td>
                <input type="text" class="form-control form-control-sm" 
                       value="${registro.cedula}" 
                       readonly style="background-color: #f8f9fa;">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm" 
                       value="${registro.tecnico}" 
                       readonly style="background-color: #f8f9fa;">
            </td>
            <td>
                ${crearSelectTipificacion(registro.carpeta_dia, index, !esEditable)}
            </td>
            <td>
                <input type="text" class="form-control form-control-sm" 
                       value="${registro.carpeta}" 
                       ${!esEditable ? 'disabled' : ''}
                       onchange="marcarModificado(${index}, 'carpeta', this.value)">
            </td>
            <td>
                ${crearSelectSupervisor(registro.super, index, !esEditable)}
            </td>
            <td>
                <small class="text-muted">${new Date(registro.fecha_asistencia).toLocaleString()}</small>
                ${!esEditable ? `<br><small class="text-danger"><i class="fas fa-lock me-1"></i>No editable (${diferenciaDias} días)</small>` : ''}
            </td>
            <td>
                <button class="btn btn-danger btn-sm" 
                        onclick="eliminarRegistroEdicion(${index})" 
                        ${!esEditable ? 'disabled' : ''}
                        title="${esEditable ? 'Eliminar' : 'No se puede eliminar (más de 3 días)'}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Marcar registro como modificado
function marcarModificado(index, campo, valor) {
    // Validación especial para carpeta_dia: no permitir cambiar a "Seleccione..." si ya tiene un valor
    if (campo === 'carpeta_dia') {
        const valorOriginal = registrosEdicion[index][campo];
        
        // Si el registro ya tiene una carpeta_dia asignada y se intenta cambiar a vacío
        if (valorOriginal && valorOriginal.trim() !== '' && (!valor || valor.trim() === '')) {
            // Mostrar alerta de error
            mostrarAlerta('No se puede cambiar la Carpeta Día a "Seleccione...". Debe seleccionar otra carpeta válida.', 'warning');
            
            // Restaurar el valor original en el select
            const selectElement = document.querySelector(`#tablaEdicionAsistencias tbody tr:nth-child(${index + 1}) td:nth-child(3) select`);
            if (selectElement) {
                selectElement.value = valorOriginal;
            }
            
            return; // No continuar con la modificación
        }
    }
    
    registrosEdicion[index][campo] = valor;
    
    // Agregar a la lista de modificados si no está ya
    if (!registrosModificados.find(r => r.id_asistencia === registrosEdicion[index].id_asistencia)) {
        registrosModificados.push(registrosEdicion[index]);
    }
    
    // Habilitar botón de guardar
    document.getElementById('btnGuardarCambios').disabled = false;
}

// Eliminar registro de edición
async function eliminarRegistroEdicion(index) {
    if (!confirm('¿Está seguro de que desea eliminar este registro?')) {
        return;
    }
    
    const registro = registrosEdicion[index];
    
    try {
        const response = await fetch('/api/asistencia/eliminar', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id_asistencia: registro.id_asistencia })
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarAlerta('Registro eliminado correctamente', 'success');
            // Recargar la tabla
            cargarRegistrosAsistencia();
        } else {
            mostrarAlerta('Error al eliminar registro: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('Error al eliminar registro', 'danger');
    }
}

// Guardar cambios de edición
async function guardarCambiosEdicion() {
    if (registrosModificados.length === 0) {
        mostrarAlerta('No hay cambios para guardar', 'warning');
        return;
    }
    
    // Validar que todos los registros modificados sean editables
    const registrosNoEditables = registrosModificados.filter(registro => {
        const registroOriginal = registrosEdicion.find(r => r.id_asistencia === registro.id_asistencia);
        return registroOriginal && !esFechaEditable(registroOriginal.fecha_asistencia);
    });
    
    if (registrosNoEditables.length > 0) {
        mostrarAlerta('Algunos registros que intentas modificar tienen más de 4 días de antigüedad y no pueden ser editados.', 'danger');
        return;
    }
    
    if (!confirm(`¿Confirmar cambios? Se actualizarán ${registrosModificados.length} registro(s).`)) {
        return;
    }
    
    try {
        const promesas = registrosModificados.map(registro => 
            fetch('/api/asistencia/actualizar', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(registro)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Error al actualizar registro');
                    });
                }
                return response.json();
            })
        );
        
        const resultados = await Promise.all(promesas);
        
        const exitosos = resultados.filter(r => r.success).length;
        const fallidos = resultados.filter(r => !r.success).length;
        
        if (exitosos > 0) {
            mostrarAlerta(`Se actualizaron ${exitosos} registros correctamente`, 'success');
            registrosModificados = [];
            document.getElementById('btnGuardarCambios').disabled = true;
            // Recargar la tabla para mostrar los cambios
            cargarRegistrosAsistencia();
        }
        
        if (fallidos > 0) {
            mostrarAlerta(`${fallidos} registros no pudieron actualizarse`, 'warning');
        }
        
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('Error al guardar cambios: ' + (error.message || 'Error desconocido'), 'danger');
    }
}

// Cancelar edición
function cancelarEdicion() {
    const supervisorEdicion = document.getElementById('supervisorEdicion');
    const fechaEdicion = document.getElementById('fechaEdicion');
    const tablaEdicionCard = document.getElementById('tablaEdicionCard');
    const mensajeSinRegistros = document.getElementById('mensajeSinRegistros');
    const btnGuardarCambios = document.getElementById('btnGuardarCambios');
    
    if (supervisorEdicion) supervisorEdicion.value = '';
    if (fechaEdicion) fechaEdicion.value = '';
    if (tablaEdicionCard) tablaEdicionCard.style.display = 'none';
    if (mensajeSinRegistros) mensajeSinRegistros.style.display = 'none';
    if (btnGuardarCambios) btnGuardarCambios.disabled = true;
    
    registrosEdicion = [];
    registrosModificados = [];
}

// Función para exportar asistencias a Excel
async function exportarAsistenciaExcel() {
    const supervisor = document.getElementById('supervisorExportacion').value;
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    
    if (!supervisor) {
        mostrarAlerta('Debe seleccionar un supervisor', 'warning');
        return;
    }
    
    if (!fechaInicio || !fechaFin) {
        mostrarAlerta('Debe seleccionar fecha de inicio y fecha de fin', 'warning');
        return;
    }
    
    if (new Date(fechaInicio) > new Date(fechaFin)) {
        mostrarAlerta('La fecha de inicio no puede ser mayor que la fecha de fin', 'warning');
        return;
    }
    
    try {
        // Mostrar indicador de carga
        const btnExportar = document.getElementById('btnExportarExcel');
        const textoOriginal = btnExportar.innerHTML;
        btnExportar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Exportando...';
        btnExportar.disabled = true;
        
        // Construir URL para exportación
        let url = `/api/asistencia/exportar_excel?supervisor=${encodeURIComponent(supervisor)}&fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`;
        
        const response = await fetch(url);
        
        if (response.ok) {
            // Crear un blob con el archivo Excel
            const blob = await response.blob();
            
            // Crear un enlace temporal para descargar el archivo
            const urlBlob = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = urlBlob;
            
            // Generar nombre del archivo
            a.download = `asistencia_${supervisor}_${fechaInicio}_${fechaFin}.xlsx`;
            
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(urlBlob);
            
            mostrarAlerta('Archivo Excel exportado correctamente', 'success');
        } else {
            const errorData = await response.json();
            mostrarAlerta('Error al exportar: ' + (errorData.message || 'Error desconocido'), 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarAlerta('Error al exportar archivo Excel', 'danger');
    } finally {
        // Restaurar botón
        const btnExportar = document.getElementById('btnExportarExcel');
        btnExportar.innerHTML = textoOriginal;
        btnExportar.disabled = false;
    }
}

// Variables globales para el manejo de peticiones
let currentResumenRequest = null;
let isLoadingResumen = false;
let debounceTimer = null;

// Funciones para el resumen agrupado
async function cargarSupervisoresResumen() {
    try {
        const response = await fetch('/api/supervisores');
        const data = await response.json();
        
        const selectSupervisor = document.getElementById('supervisorResumen');
        selectSupervisor.innerHTML = '<option value="">Todos los supervisores</option>';
        
        if (data.supervisores) {
            data.supervisores.forEach(supervisor => {
                const option = document.createElement('option');
                option.value = supervisor;
                option.textContent = supervisor;
                selectSupervisor.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error al cargar supervisores:', error);
        mostrarAlerta('Error al cargar supervisores', 'danger');
    }
}

// Función con debounce para evitar múltiples peticiones rápidas
function cargarResumenAgrupadoDebounced() {
    // Limpiar timer anterior si existe
    if (debounceTimer) {
        clearTimeout(debounceTimer);
    }
    
    // Establecer nuevo timer con delay de 300ms
    debounceTimer = setTimeout(() => {
        cargarResumenAgrupado();
    }, 300);
}

async function cargarResumenAgrupado() {
    // Prevenir múltiples peticiones simultáneas
    if (isLoadingResumen) {
        console.log('Ya hay una petición en curso, cancelando la anterior...');
        if (currentResumenRequest) {
            currentResumenRequest.abort();
        }
    }
    
    const supervisor = document.getElementById('supervisorResumen').value;
    const fechaSeleccionada = document.getElementById('fechaInicioResumen').value;
    
    // Validaciones de fecha
    if (!fechaSeleccionada) {
        mostrarAlerta('Debe seleccionar una fecha', 'warning');
        return;
    }
    
    // Validar formato de fecha
    const fechaObj = new Date(fechaSeleccionada);
    
    if (isNaN(fechaObj.getTime())) {
        mostrarAlerta('La fecha seleccionada no es válida', 'danger');
        return;
    }
    
    // Validar que la fecha no sea futura
    const hoy = new Date();
    hoy.setHours(23, 59, 59, 999); // Fin del día actual
    
    if (fechaObj > hoy) {
        mostrarAlerta('No se pueden seleccionar fechas futuras', 'warning');
        return;
    }
    
    // Marcar como cargando y limpiar estados anteriores
    isLoadingResumen = true;
    
    // Deshabilitar botón de actualizar mientras se carga
    const btnActualizar = document.getElementById('btnActualizarResumen');
    if (btnActualizar) {
        btnActualizar.disabled = true;
        btnActualizar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Cargando...';
    }
    
    // Limpiar contenido anterior inmediatamente
    const cuerpoTabla = document.getElementById('cuerpoTablaResumen');
    const totalTecnicos = document.getElementById('totalTecnicosGeneral');
    const mensajeCarga = document.getElementById('mensajeCargaResumen');
    const tablaCard = document.getElementById('tablaResumenCard');
    const mensajeSinDatos = document.getElementById('mensajeSinDatosResumen');
    
    if (cuerpoTabla) cuerpoTabla.innerHTML = '';
    if (totalTecnicos) totalTecnicos.textContent = '0';
    
    // Mostrar indicador de carga
    if (mensajeCarga) mensajeCarga.style.display = 'block';
    if (tablaCard) tablaCard.style.display = 'none';
    if (mensajeSinDatos) mensajeSinDatos.style.display = 'none';
    
    // Crear AbortController para poder cancelar la petición
    const abortController = new AbortController();
    currentResumenRequest = abortController;
    
    try {
        let url = `/api/asistencia/resumen_agrupado?fecha_inicio=${fechaSeleccionada}&fecha_fin=${fechaSeleccionada}`;
        if (supervisor) {
            url += `&supervisor=${encodeURIComponent(supervisor)}`;
        }
        
        console.log('Llamando a URL:', url); // Debug
        
        // Configurar timeout de 30 segundos
        const timeoutId = setTimeout(() => {
            abortController.abort();
        }, 30000);
        
        const response = await fetch(url, {
            signal: abortController.signal,
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        // Limpiar timeout si la petición fue exitosa
        clearTimeout(timeoutId);
        
        // Verificar si la petición fue cancelada
        if (abortController.signal.aborted) {
            console.log('Petición cancelada');
            return;
        }
        
        // Verificar si la respuesta es HTML (redirección a login)
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('text/html')) {
            console.error('Respuesta HTML recibida, posible problema de autenticación');
            mostrarAlerta('Sesión expirada. Por favor, recargue la página e inicie sesión nuevamente.', 'warning');
            if (mensajeSinDatos) mensajeSinDatos.style.display = 'block';
            return;
        }
        
        // Verificar si la respuesta es exitosa
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Respuesta del servidor:', data); // Debug
        
        // Verificar nuevamente si la petición fue cancelada después de recibir la respuesta
        if (abortController.signal.aborted) {
            console.log('Petición cancelada después de recibir respuesta');
            return;
        }
        
        if (data.success) {
            mostrarTablaResumen(data.data);
        } else {
            mostrarAlerta('Error al cargar resumen: ' + (data.message || 'Error desconocido'), 'danger');
            const mensajeSinDatos = document.getElementById('mensajeSinDatosResumen');
            if (mensajeSinDatos) mensajeSinDatos.style.display = 'block';
        }
    } catch (error) {
        // No mostrar error si la petición fue cancelada intencionalmente
        if (error.name === 'AbortError') {
            console.log('Petición cancelada por el usuario o por timeout');
            // Si fue por timeout, mostrar mensaje específico
            if (isLoadingResumen) {
                mostrarAlerta('La petición tardó demasiado tiempo. Intente con un rango de fechas más pequeño.', 'warning');
                const mensajeSinDatos = document.getElementById('mensajeSinDatosResumen');
                if (mensajeSinDatos) mensajeSinDatos.style.display = 'block';
            }
            return;
        }
        
        console.error('Error al cargar resumen agrupado:', error);
        
        // Manejo específico de diferentes tipos de errores
        let mensajeError = 'Error al cargar resumen agrupado';
        
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            mensajeError = 'Error de conexión. Verifique su conexión a internet';
        } else if (error.message.includes('HTTP')) {
            mensajeError = 'Error del servidor. Intente nuevamente en unos momentos';
        } else if (error.message.includes('NetworkError')) {
            mensajeError = 'Error de red. Verifique su conexión';
        } else if (error.message) {
            mensajeError += ': ' + error.message;
        }
        
        mostrarAlerta(mensajeError, 'danger');
        const mensajeSinDatos = document.getElementById('mensajeSinDatosResumen');
        if (mensajeSinDatos) mensajeSinDatos.style.display = 'block';
    } finally {
        // Limpiar estado de carga solo si esta es la petición actual
        if (currentResumenRequest === abortController) {
            isLoadingResumen = false;
            currentResumenRequest = null;
            
            const mensajeCarga = document.getElementById('mensajeCargaResumen');
            if (mensajeCarga) mensajeCarga.style.display = 'none';
            
            // Rehabilitar botón de actualizar
            const btnActualizar = document.getElementById('btnActualizarResumen');
            if (btnActualizar) {
                btnActualizar.disabled = false;
                btnActualizar.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Actualizar';
            }
        }
    }
}

// Función auxiliar para calcular totales por grupo
function calcularTotalesPorGrupo(datos, totalGeneral) {
    const grupos = {};
    
    // Agrupar datos por grupo
    datos.forEach(item => {
        const grupo = item.grupo || 'Sin Grupo';
        if (!grupos[grupo]) {
            grupos[grupo] = {
                totalTecnicos: 0,
                items: []
            };
        }
        grupos[grupo].totalTecnicos += parseInt(item.total_tecnicos) || 0;
        grupos[grupo].items.push(item);
    });
    
    // Calcular porcentajes unificados
    Object.keys(grupos).forEach(grupo => {
        grupos[grupo].porcentajeUnificado = totalGeneral > 0 ? 
            (grupos[grupo].totalTecnicos / totalGeneral * 100) : 0;
    });
    
    return grupos;
}

function mostrarTablaResumen(data) {
    // ===== NUEVA TABLA: OPERACIÓN X RECURSO OPERATIVO =====
    mostrarTablaOperacionRecurso(data);
    
    // ===== TABLA TRADICIONAL: RESUMEN POR GRUPOS =====
    const tbody = document.getElementById('cuerpoTablaResumen');
    const totalTecnicos = document.getElementById('totalTecnicosGeneral');
    
    // Limpiar tabla completamente
    tbody.innerHTML = '';
    
    // Ocultar todos los mensajes primero
    const mensajeCarga = document.getElementById('mensajeCargaResumen');
    const mensajeSinDatos = document.getElementById('mensajeSinDatosResumen');
    const tablaCard = document.getElementById('tablaResumenCard');
    
    if (mensajeCarga) mensajeCarga.style.display = 'none';
    if (mensajeSinDatos) mensajeSinDatos.style.display = 'none';
    // Mostrar la tarjeta de resumen siempre para que la sección sea visible
    if (tablaCard) tablaCard.style.display = 'block';
    
    // Usar datos detallados que incluyen las carpetas específicas (nombre_tipificacion)
    const datosParaMostrar = data.detallado || [];
    
    if (datosParaMostrar.length === 0) {
        // Actualizar total a 0 cuando no hay datos y mantener visible la sección
        if (totalTecnicos) {
            totalTecnicos.textContent = '0';
        }
        if (mensajeSinDatos) mensajeSinDatos.style.display = 'block';
        // Mantener visible la tarjeta aunque no haya datos
        if (tablaCard) tablaCard.style.display = 'block';
        return;
    }
    
    // Separar datos operativos de ausencias
    const datosOperativos = datosParaMostrar.filter(item => !item.es_ausencia);
    const datosAusencias = datosParaMostrar.filter(item => item.es_ausencia);
    
    // Calcular total general operativo
    const totalGeneralOperativo = parseInt(data.total_general_operativo) || 0;
    
    // Calcular totales por grupo para datos operativos
    const totalesPorGrupo = calcularTotalesPorGrupo(datosOperativos, totalGeneralOperativo);
    
    // Agregar filas de datos operativos agrupados con totales
    const gruposOrdenados = ['ARREGLOS', 'INSTALACIONES', 'POSTVENTA'];
    
    gruposOrdenados.forEach(nombreGrupo => {
        if (totalesPorGrupo[nombreGrupo]) {
            const grupoData = totalesPorGrupo[nombreGrupo];
            
            // Agregar filas individuales del grupo
            grupoData.items.forEach(item => {
                const tr = document.createElement('tr');
                
                // Validar y formatear datos
                const grupo = item.grupo || 'Sin Grupo';
                const carpeta = item.carpeta || '-';
                const totalTecnicosItem = parseInt(item.total_tecnicos) || 0;
                const porcentaje = parseFloat(item.porcentaje) || 0;
                
                tr.innerHTML = `
                    <td class="fw-bold">${grupo}</td>
                    <td>${carpeta}</td>
                    <td class="text-center">
                        <span class="badge bg-primary detalle-cantidad" data-seccion="operacion" data-clave="${carpeta}" style="cursor:pointer;">${totalTecnicosItem}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${porcentaje.toFixed(2)}%</span>
                    </td>
                `;
                
                tbody.appendChild(tr);
            });
            
            // Agregar fila de total del grupo
            const totalTr = document.createElement('tr');
            totalTr.className = 'tabla-total-grupo';
            totalTr.style.backgroundColor = '#e3f2fd';
            totalTr.style.borderTop = '2px solid #1976d2';
            totalTr.style.borderBottom = '2px solid #1976d2';
            const clavesGrupo = grupoData.items.map(it => it.carpeta).filter(Boolean).join(',');
            
            totalTr.innerHTML = `
                <td class="fw-bold text-primary">
                    <i class="fas fa-calculator me-2"></i>TOTAL ${nombreGrupo}
                </td>
                <td class="fw-bold text-primary">-</td>
                <td class="text-center">
                    <span class="badge bg-primary fs-6 detalle-cantidad" data-seccion="operacion-total" data-clave="${clavesGrupo}" style="cursor:pointer;">${grupoData.totalTecnicos}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary fs-6">${grupoData.porcentajeUnificado.toFixed(2)}%</span>
                </td>
            `;
            
            tbody.appendChild(totalTr);
            
            // Agregar separador entre grupos (excepto después del último)
            if (nombreGrupo !== 'POSTVENTA') {
                const separadorTr = document.createElement('tr');
                separadorTr.innerHTML = `<td colspan="4" style="height: 10px; border: none;"></td>`;
                tbody.appendChild(separadorTr);
            }
        }
    });
    
    // Agregar separador de ausencias si hay ausencias
    if (datosAusencias.length > 0) {
        const separadorTr = document.createElement('tr');
        separadorTr.style.backgroundColor = '#f8f9fa';
        separadorTr.style.borderTop = '2px solid #dee2e6';
        separadorTr.innerHTML = `
            <td colspan="4" class="text-center fw-bold text-muted py-2">
                <i class="fas fa-user-times me-2"></i>AUSENCIAS
            </td>
        `;
        tbody.appendChild(separadorTr);
        
        // Agregar filas de ausencias
        datosAusencias.forEach(item => {
            const tr = document.createElement('tr');
            
            // Validar y formatear datos
            const grupo = item.grupo || 'Sin Grupo';
            const carpeta = item.carpeta || '-';
            const totalTecnicosItem = parseInt(item.total_tecnicos) || 0;
            const porcentaje = parseFloat(item.porcentaje) || 0;
            
            tr.style.backgroundColor = '#ffebee'; // Fondo rojo claro para ausencias
            tr.innerHTML = `
                <td class="fw-bold text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>${grupo}
                </td>
                <td class="fw-bold text-danger">${carpeta}</td>
                <td class="text-center">
                    <span class="badge bg-danger detalle-cantidad" data-seccion="operacion" data-clave="${carpeta}" style="cursor:pointer;">${totalTecnicosItem}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-danger">${porcentaje.toFixed(2)}%</span>
                </td>
            `;
            
            tbody.appendChild(tr);
        });
    }
    
    // Actualizar total de técnicos con validación (usar total operativo sin ausencias)
    if (totalTecnicos) {
        totalTecnicos.textContent = totalGeneralOperativo;
    }
    
    // Mostrar la tabla solo después de que todo esté listo
    if (tablaCard) tablaCard.style.display = 'block';
    // Activar clic en badges de detalles
    document.querySelectorAll('.detalle-cantidad').forEach(el => {
        el.onclick = () => abrirDetalleAsistencia(el.dataset.seccion, el.dataset.clave);
    });
}

function mostrarTablaOperacionRecurso(data) {
    const tbodyOperacion = document.getElementById('cuerpoTablaOperacion');
    const totalOperativo = document.getElementById('totalTecnicosOperativo');
    const tablaOperacionCard = document.getElementById('tablaOperacionCard');
    
    // Limpiar tabla de operación
    if (tbodyOperacion) tbodyOperacion.innerHTML = '';
    
    // Obtener datos de operación por recurso operativo
    const datosOperacion = data.operacion_recurso || [];
    const ausenciasOperacion = data.ausencias_operacion || [];
    
    if (datosOperacion.length === 0 && ausenciasOperacion.length === 0) {
        // Actualizar total operativo a 0 cuando no hay datos
        if (totalOperativo) {
            totalOperativo.textContent = '0';
        }
        if (tablaOperacionCard) tablaOperacionCard.style.display = 'none';
        return;
    }
    
    // Calcular total operativo
    const totalOperativoValue = parseInt(data.total_operativo) || 0;
    
    // Calcular totales por grupo para datos operativos
    const totalesPorGrupoOperacion = calcularTotalesPorGrupo(datosOperacion, totalOperativoValue);
    
    // Agregar filas de datos operativos agrupados con totales
    const gruposOrdenados = ['ARREGLOS', 'INSTALACIONES', 'POSTVENTA'];
    
    gruposOrdenados.forEach(nombreGrupo => {
        if (totalesPorGrupoOperacion[nombreGrupo]) {
            const grupoData = totalesPorGrupoOperacion[nombreGrupo];
            
            // Agregar filas individuales del grupo
            grupoData.items.forEach(item => {
                const tr = document.createElement('tr');
                
                // Validar y formatear datos
                const grupo = item.grupo || '-';
                const carpeta = item.carpeta || '-';
                const totalTecnicosItem = parseInt(item.total_tecnicos) || 0;
                const porcentaje = parseFloat(item.porcentaje) || 0;
                
                tr.innerHTML = `
                    <td class="fw-bold">${grupo}</td>
                    <td class="fw-bold">${carpeta}</td>
                    <td class="text-center">
                        <span class="badge bg-info detalle-cantidad" data-seccion="operacion" data-clave="${carpeta}" style="cursor:pointer;">${totalTecnicosItem}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-warning text-dark">${porcentaje.toFixed(2)}%</span>
                    </td>
                `;
                tbodyOperacion.appendChild(tr);
            });
            
            // Agregar fila de total del grupo
            const totalTr = document.createElement('tr');
            totalTr.className = 'tabla-total-grupo';
            totalTr.style.backgroundColor = '#e3f2fd';
            totalTr.style.borderTop = '2px solid #2196f3';
            totalTr.style.borderBottom = '2px solid #2196f3';
            const clavesGrupoOp = grupoData.items.map(it => it.carpeta).filter(Boolean).join(',');
            
            totalTr.innerHTML = `
                <td class="fw-bold text-primary">
                    <i class="fas fa-calculator me-2"></i>TOTAL ${nombreGrupo}
                </td>
                <td class="fw-bold text-primary">-</td>
                <td class="text-center">
                    <span class="badge bg-primary fs-6 detalle-cantidad" data-seccion="operacion-total" data-clave="${clavesGrupoOp}" style="cursor:pointer;">${grupoData.totalTecnicos}</span>
                </td>
                <td class="text-center">
                    <span class="badge bg-primary fs-6">${grupoData.porcentajeUnificado.toFixed(2)}%</span>
                </td>
            `;
            
            tbodyOperacion.appendChild(totalTr);
            
            // Agregar separador entre grupos (excepto después del último)
            if (nombreGrupo !== 'POSTVENTA') {
                const separadorTr = document.createElement('tr');
                separadorTr.innerHTML = `<td colspan="4" style="height: 10px; border: none;"></td>`;
                tbodyOperacion.appendChild(separadorTr);
            }
        }
    });
    
    // Agregar separador si hay ausencias
    if (ausenciasOperacion.length > 0) {
        const separadorTr = document.createElement('tr');
        separadorTr.innerHTML = `
            <td colspan="4" class="text-center fw-bold text-muted" style="background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                <i class="fas fa-user-times me-2"></i>AUSENCIAS
            </td>
        `;
        tbodyOperacion.appendChild(separadorTr);
    }
    
    // Agregar filas de ausencias al final
    ausenciasOperacion.forEach(item => {
        const tr = document.createElement('tr');
        tr.style.backgroundColor = '#ffebee'; // Fondo rojo claro para ausencias
        
        // Validar y formatear datos
        const grupo = item.grupo || '-';
        const carpeta = item.carpeta || '-';
        const totalTecnicosItem = parseInt(item.total_tecnicos) || 0;
        const porcentaje = parseFloat(item.porcentaje) || 0;
        
        tr.innerHTML = `
            <td class="fw-bold text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${grupo}
            </td>
            <td class="fw-bold text-danger">${carpeta}</td>
            <td class="text-center">
                <span class="badge bg-danger detalle-cantidad" data-seccion="operacion" data-clave="${carpeta}" style="cursor:pointer;">${totalTecnicosItem}</span>
            </td>
            <td class="text-center">
                <span class="badge bg-danger">${porcentaje.toFixed(2)}%</span>
            </td>
        `;
        tbodyOperacion.appendChild(tr);
    });
    
    // Actualizar total operativo (solo técnicos operativos, sin ausencias)
    if (totalOperativo) {
        totalOperativo.textContent = totalOperativoValue;
    }
    
    // Mostrar la tabla de operación
    if (tablaOperacionCard) tablaOperacionCard.style.display = 'block';
    // Activar clic en badges de detalles
    document.querySelectorAll('.detalle-cantidad').forEach(el => {
        el.onclick = () => abrirDetalleAsistencia(el.dataset.seccion, el.dataset.clave);
    });
}

function obtenerFechaBogotaISO() {
    // Obtener fecha en formato YYYY-MM-DD usando zona horaria de Bogotá
    const formatter = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'America/Bogota',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
    const parts = formatter.formatToParts(new Date());
    const y = parts.find(p => p.type === 'year').value;
    const m = parts.find(p => p.type === 'month').value;
    const d = parts.find(p => p.type === 'day').value;
    return `${y}-${m}-${d}`;
}

function inicializarResumen() {
    // Establecer fecha actual según zona horaria de Bogotá
    const hoy = obtenerFechaBogotaISO();
    document.getElementById('fechaInicioResumen').value = hoy;

    // Configurar event listeners para los filtros
    document.getElementById('supervisorResumen').addEventListener('change', cargarResumenAgrupadoDebounced);
    document.getElementById('fechaInicioResumen').addEventListener('change', cargarResumenAgrupadoDebounced);
    document.getElementById('btnActualizarResumen').addEventListener('click', cargarResumenAgrupado);

    document.getElementById('supervisorResumen').addEventListener('change', cargarResumenCategoriasDebounced);
    document.getElementById('fechaInicioResumen').addEventListener('change', cargarResumenCategoriasDebounced);
    document.getElementById('btnActualizarResumen').addEventListener('click', cargarResumenCategorias);

    // Cargar supervisores y resumen inicial
    cargarSupervisoresResumen();
    cargarResumenAgrupado();
    cargarResumenCategorias();
}

// Variables globales para las gráficas
let graficaOperacionRecurso = null;
let graficaCarpetaDia = null;

// Función para inicializar las gráficas
function inicializarGraficas() {
    // Establecer rango de fechas de los últimos 30 días por defecto
    const hoy = new Date();
    const fechaFin = hoy.toISOString().split('T')[0];
    
    // Calcular fecha de inicio (30 días antes)
    const fechaInicio = new Date(hoy);
    fechaInicio.setDate(hoy.getDate() - 30);
    const fechaInicioStr = fechaInicio.toISOString().split('T')[0];
    
    document.getElementById('fechaInicioGraficas').value = fechaInicioStr;
    document.getElementById('fechaFinGraficas').value = fechaFin;
    
    // Configurar event listeners para los controles de las gráficas
    document.getElementById('btnActualizarGraficas').addEventListener('click', actualizarGraficas);
    
    // Event listeners para cambio de tipo de visualización
    document.querySelectorAll('input[name="tipoOperacionRecurso"]').forEach(radio => {
        radio.addEventListener('change', () => cargarGraficaOperacionRecurso());
    });
    
    document.querySelectorAll('input[name="tipoCarpetaDia"]').forEach(radio => {
        radio.addEventListener('change', () => cargarGraficaCarpetaDia());
    });
    
    // Event listeners para toggles de grupos
    document.querySelectorAll('.toggle-grupo-operacion').forEach(toggle => {
        toggle.addEventListener('click', () => toggleGrupoOperacion(toggle.dataset.grupo));
    });
    
    document.querySelectorAll('.toggle-grupo-carpeta').forEach(toggle => {
        toggle.addEventListener('click', () => toggleGrupoCarpeta(toggle.dataset.grupo));
    });
    
    // Cargar supervisores para gráficas
    cargarSupervisoresGraficas();
}

// Función para cargar supervisores en el select de gráficas
async function cargarSupervisoresGraficas() {
    try {
        const response = await fetch('/api/supervisores');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('supervisorGraficas');
            select.innerHTML = '<option value="">Todos los supervisores</option>';
            
            data.supervisores.forEach(supervisor => {
                const option = document.createElement('option');
                option.value = supervisor;
                option.textContent = supervisor;
                select.appendChild(option);
            });
        }
        
        // Cargar las gráficas automáticamente después de cargar los supervisores
        actualizarGraficas();
    } catch (error) {
        console.error('Error al cargar supervisores para gráficas:', error);
    }
}

// Función para actualizar ambas gráficas
function actualizarGraficas() {
    cargarGraficaOperacionRecurso();
    cargarGraficaCarpetaDia();
}

// Función para cargar gráfica de Operación x Recurso Operativo
async function cargarGraficaOperacionRecurso() {
    const loadingOperacion = document.getElementById('loadingGraficaOperacion');
    const noDataOperacion = document.getElementById('noDataGraficaOperacion');
    const canvasOperacion = document.getElementById('graficaOperacionRecurso');
    
    // Verificar que el canvas existe
    if (!canvasOperacion) {
        console.error('Canvas graficaOperacionRecurso no encontrado');
        return;
    }
    
    // Mostrar loading solo si el elemento existe
    if (loadingOperacion) loadingOperacion.style.display = 'block';
    if (noDataOperacion) noDataOperacion.style.display = 'none';
    canvasOperacion.style.display = 'none';
    
    try {
        const fechaInicio = document.getElementById('fechaInicioGraficas').value;
        const fechaFin = document.getElementById('fechaFinGraficas').value;
        const supervisor = document.getElementById('supervisorGraficas').value;
        const tipoAgrupacion = document.querySelector('input[name="tipoOperacionRecurso"]:checked').value;
        
        const params = new URLSearchParams({
            fecha_inicio: fechaInicio,
            fecha_fin: fechaFin,
            agrupacion: tipoAgrupacion
        });
        
        if (supervisor) {
            params.append('supervisor', supervisor);
        }
        
        const response = await fetch(`/api/asistencia/graficas/operacion-recurso?${params}`);
        const data = await response.json();
        
        if (loadingOperacion) loadingOperacion.style.display = 'none';
        
        if (data.success && data.datos && data.datos.length > 0) {
            renderizarGraficaOperacionRecurso(data);
            canvasOperacion.style.display = 'block';
        } else {
            if (noDataOperacion) noDataOperacion.style.display = 'block';
        }
    } catch (error) {
        console.error('Error al cargar gráfica de operación recurso:', error);
        if (loadingOperacion) loadingOperacion.style.display = 'none';
        if (noDataOperacion) noDataOperacion.style.display = 'block';
    }
}

// Función para cargar gráfica de Operación x Carpeta Día
async function cargarGraficaCarpetaDia() {
    const loadingCarpeta = document.getElementById('loadingGraficaCarpeta');
    const noDataCarpeta = document.getElementById('noDataGraficaCarpeta');
    const canvasCarpeta = document.getElementById('graficaCarpetaDia');
    
    // Verificar que el canvas existe
    if (!canvasCarpeta) {
        console.error('Canvas graficaCarpetaDia no encontrado');
        return;
    }
    
    // Mostrar loading solo si el elemento existe
    if (loadingCarpeta) loadingCarpeta.style.display = 'block';
    if (noDataCarpeta) noDataCarpeta.style.display = 'none';
    canvasCarpeta.style.display = 'none';
    
    try {
        const fechaInicio = document.getElementById('fechaInicioGraficas').value;
        const fechaFin = document.getElementById('fechaFinGraficas').value;
        const supervisor = document.getElementById('supervisorGraficas').value;
        const tipoAgrupacion = document.querySelector('input[name="tipoCarpetaDia"]:checked').value;
        
        const params = new URLSearchParams({
            fecha_inicio: fechaInicio,
            fecha_fin: fechaFin,
            agrupacion: tipoAgrupacion
        });
        
        if (supervisor) {
            params.append('supervisor', supervisor);
        }
        
        const response = await fetch(`/api/asistencia/graficas/carpeta-dia?${params}`);
        const data = await response.json();
        
        if (loadingCarpeta) loadingCarpeta.style.display = 'none';
        
        if (data.success && data.datos && data.datos.length > 0) {
            renderizarGraficaCarpetaDia(data);
            canvasCarpeta.style.display = 'block';
        } else {
            if (noDataCarpeta) noDataCarpeta.style.display = 'block';
        }
    } catch (error) {
        console.error('Error al cargar gráfica de carpeta día:', error);
        if (loadingCarpeta) loadingCarpeta.style.display = 'none';
        if (noDataCarpeta) noDataCarpeta.style.display = 'block';
    }
}

// Función para renderizar gráfica de Operación x Recurso Operativo
function renderizarGraficaOperacionRecurso(data) {
    const ctx = document.getElementById('graficaOperacionRecurso').getContext('2d');
    
    // Destruir gráfica anterior si existe
    if (graficaOperacionRecurso) {
        graficaOperacionRecurso.destroy();
    }
    
    // Configurar datasets con colores específicos
    const datasets = data.datos.map(dataset => ({
        ...dataset,
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 8,
        tension: 0.4,
        fill: false
    }));
    
    graficaOperacionRecurso = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `Operación x Recurso Operativo - ${data.agrupacion === 'mes' ? 'Mes a Mes' : 'Día a Día'}`,
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        title: function(context) {
                            return `Período: ${context[0].label}`;
                        },
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} técnicos`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: data.agrupacion === 'mes' ? 'Mes' : 'Día'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Número de Técnicos'
                    },
                    beginAtZero: true
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

// Función para renderizar gráfica de Operación x Carpeta Día
function renderizarGraficaCarpetaDia(data) {
    const ctx = document.getElementById('graficaCarpetaDia').getContext('2d');
    
    // Destruir gráfica anterior si existe
    if (graficaCarpetaDia) {
        graficaCarpetaDia.destroy();
    }
    
    // Configurar datasets con colores específicos
    const datasets = data.datos.map(dataset => ({
        ...dataset,
        borderWidth: 3,
        pointRadius: 5,
        pointHoverRadius: 8,
        tension: 0.4,
        fill: false
    }));
    
    graficaCarpetaDia = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: `Operación x Carpeta Día - ${data.agrupacion === 'mes' ? 'Mes a Mes' : 'Día a Día'}`,
                    font: {
                        size: 16,
                        weight: 'bold'
                    }
                },
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        title: function(context) {
                            return `Período: ${context[0].label}`;
                        },
                        label: function(context) {
                            return `${context.dataset.label}: ${context.parsed.y} técnicos`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: data.agrupacion === 'mes' ? 'Mes' : 'Día'
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Número de Técnicos'
                    },
                    beginAtZero: true
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    });
}

// Función para toggle de grupos en gráfica de operación recurso
function toggleGrupoOperacion(grupo) {
    if (!graficaOperacionRecurso) return;
    
    const toggle = document.querySelector(`.toggle-grupo-operacion[data-grupo="${grupo}"]`);
    const dataset = graficaOperacionRecurso.data.datasets.find(d => d.label === grupo);
    
    if (dataset) {
        dataset.hidden = !dataset.hidden;
        toggle.classList.toggle('btn-outline-secondary');
        toggle.classList.toggle('btn-secondary');
        graficaOperacionRecurso.update();
    }
}

// Función para toggle de grupos en gráfica de carpeta día
function toggleGrupoCarpeta(grupo) {
    if (!graficaCarpetaDia) return;
    
    const toggle = document.querySelector(`.toggle-grupo-carpeta[data-grupo="${grupo}"]`);
    const dataset = graficaCarpetaDia.data.datasets.find(d => d.label === grupo);
    
    if (dataset) {
        dataset.hidden = !dataset.hidden;
        toggle.classList.toggle('btn-outline-secondary');
        toggle.classList.toggle('btn-secondary');
        graficaCarpetaDia.update();
    }
}

let currentCategoriasRequest = null;
let isLoadingCategorias = false;
let debounceTimerCategorias = null;

function cargarResumenCategoriasDebounced() {
    if (debounceTimerCategorias) clearTimeout(debounceTimerCategorias);
    debounceTimerCategorias = setTimeout(() => {
        cargarResumenCategorias();
    }, 300);
}

async function cargarResumenCategorias() {
    if (isLoadingCategorias) {
        if (currentCategoriasRequest) currentCategoriasRequest.abort();
    }
    const supervisor = document.getElementById('supervisorResumen').value;
    const fecha = document.getElementById('fechaInicioResumen').value;
    if (!fecha) return;
    isLoadingCategorias = true;
    const mensajeCarga = document.getElementById('mensajeCargaCategorias');
    const mensajeSinDatos = document.getElementById('mensajeSinDatosCategorias');
    if (mensajeCarga) mensajeCarga.style.display = 'block';
    if (mensajeSinDatos) mensajeSinDatos.style.display = 'none';
    const abortController = new AbortController();
    currentCategoriasRequest = abortController;
    try {
        let url = `/api/asistencia/resumen_categorias?fecha=${fecha}`;
        if (supervisor) url += `&supervisor=${encodeURIComponent(supervisor)}`;
        const response = await fetch(url, {
            signal: abortController.signal,
            headers: {
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (data.success) {
            renderResumenCategorias(data);
        } else {
            if (mensajeSinDatos) mensajeSinDatos.style.display = 'block';
        }
    } catch (e) {
        if (mensajeSinDatos) mensajeSinDatos.style.display = 'block';
    } finally {
        isLoadingCategorias = false;
        currentCategoriasRequest = null;
        if (mensajeCarga) mensajeCarga.style.display = 'none';
    }
}

function renderResumenCategorias(data) {
    const operBody = document.getElementById('cuerpoTablaOperaciones');
    const operTotal = document.getElementById('totalOperacionesGeneral');
    const auxBody = document.getElementById('cuerpoTablaAuxCam');
    const auxTotal = document.getElementById('totalAuxCamGeneral');
    const incBody = document.getElementById('cuerpoTablaIncapacidad');
    const incTotal = document.getElementById('totalIncapacidadGeneral');
    const ausBody = document.getElementById('cuerpoTablaAusencias');
    const ausTotal = document.getElementById('totalAusenciasGeneral');

    if (operBody) operBody.innerHTML = '';
    if (auxBody) auxBody.innerHTML = '';
    if (incBody) incBody.innerHTML = '';
    if (ausBody) ausBody.innerHTML = '';

    const operItems = (data.operacion && data.operacion.items) || [];
    const auxItems = (data.auxiliares_camioneta && data.auxiliares_camioneta.items) || [];
    const incItems = (data.incapacidad_otros && data.incapacidad_otros.items) || [];
    const ausItems = (data.ausencias && data.ausencias.items) || [];

    const operAllowedNames = new Set([
        'FTTH INSTALACIONES','POSTVENTA','INSTALACIONES DOBLES','MANTENIMIENTO FTTH',
        'ARREGLOS HFC','CAPACITACION','SUPERVISOR','BROWNFIELD','POSTVENTA FTTH','DX'
    ]);
    const operValidItems = operItems.filter(it => {
        const name = (it.carpeta_dia || '').toUpperCase().trim();
        return operAllowedNames.has(name);
    });
    operValidItems.forEach(it => {
        const tr = document.createElement('tr');
        const nombre = it.carpeta_dia || '-';
        const total = parseInt(it.total) || 0;
        tr.innerHTML = `<td>${nombre}</td><td class="text-center"><span class="badge bg-primary detalle-cantidad" data-seccion="operacion" data-clave="${nombre}" style="cursor:pointer;">${total}</span></td>`;
        operBody.appendChild(tr);
    });
    const auxAllowedNames = new Set(['AUXILIAR','APOYO CAMIONETAS','AUXILIAR DE MOTO','AUXILIAR CAMIONETA','AUXMOTO','APOCAMIONETA','AUXCAM']);
    const auxValidItems = auxItems.filter(it => {
        const n = (it.carpeta_dia || '').toUpperCase().trim();
        return auxAllowedNames.has(n);
    });
    auxValidItems.forEach(it => {
        const tr = document.createElement('tr');
        const nombre = it.carpeta_dia || '-';
        const total = parseInt(it.total) || 0;
        tr.innerHTML = `<td>${nombre}</td><td class="text-center"><span class="badge bg-info detalle-cantidad" data-seccion="aux" data-clave="${nombre}" style="cursor:pointer;">${total}</span></td>`;
        auxBody.appendChild(tr);
    });
    const incAllowed = new Set(['I.ARL','D/F','LM','LL','SUS','PER','VAC','DFAM','RM','RN','I.MED']);
    const incValidItems = incItems.filter(it => {
        const code = ((it.carpeta_dia || it.carpeta || '') + '').toUpperCase().trim();
        return incAllowed.has(code);
    });
    incValidItems.forEach(it => {
        const tr = document.createElement('tr');
        const nombre = (it.carpeta_dia || it.carpeta || '-');
        const total = parseInt(it.total) || 0;
        tr.innerHTML = `<td>${nombre}</td><td class="text-center"><span class="badge bg-warning text-dark detalle-cantidad" data-seccion="inc" data-clave="${nombre}" style="cursor:pointer;">${total}</span></td>`;
        incBody.appendChild(tr);
    });
    const ausAllowed = new Set(['0','0-A','A-O']);
    const ausValidItems = ausItems.filter(it => {
        const code = ((it.carpeta_dia || it.carpeta || '') + '').toUpperCase().trim();
        return ausAllowed.has(code);
    });
    ausValidItems.forEach(it => {
        const tr = document.createElement('tr');
        const nombre = it.carpeta_dia || it.carpeta || '-';
        const total = parseInt(it.total) || 0;
        tr.innerHTML = `<td>${nombre}</td><td class="text-center"><span class="badge bg-danger detalle-cantidad" data-seccion="aus" data-clave="${nombre}" style="cursor:pointer;">${total}</span></td>`;
        ausBody.appendChild(tr);
    });

    if (operTotal) operTotal.textContent = String(operValidItems.reduce((s, it) => s + (parseInt(it.total) || 0), 0));
    if (auxTotal) auxTotal.textContent = String(auxValidItems.reduce((s, it) => s + (parseInt(it.total) || 0), 0));
    if (incTotal) incTotal.textContent = String(incValidItems.reduce((s, it) => s + (parseInt(it.total) || 0), 0));
    if (ausTotal) ausTotal.textContent = String(ausValidItems.reduce((s, it) => s + (parseInt(it.total) || 0), 0));

    document.querySelectorAll('.detalle-cantidad').forEach(el => {
        el.onclick = () => abrirDetalleAsistencia(el.dataset.seccion, el.dataset.clave);
    });
}

async function abrirDetalleAsistencia(seccion, clave) {
    const fecha = document.getElementById('fechaInicioResumen').value;
    const supervisor = document.getElementById('supervisorResumen').value;
    let url = '';
    if (seccion === 'operacion' || seccion === 'operacion-total') {
        url = `/api/asistencia/listado_por_tipificacion?fecha=${encodeURIComponent(fecha)}&nombre_tipificacion=${encodeURIComponent(clave)}`;
    } else {
        url = `/api/asistencia/listado_por_carpeta_dia?fecha=${encodeURIComponent(fecha)}&carpeta_dia=${encodeURIComponent(clave)}`;
    }
    if (supervisor) url += `&supervisor=${encodeURIComponent(supervisor)}`;
    const titulo = document.getElementById('modalDetalleTitulo');
    const cuerpo = document.getElementById('modalDetalleCuerpo');
    const carga = document.getElementById('modalDetalleCarga');
    cuerpo.innerHTML = '';
    if (titulo) titulo.textContent = `${clave}`;
    if (carga) carga.style.display = 'block';
    try {
        const resp = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await resp.json();
        const items = (data.items || []).sort((a,b) => (a.tecnico || '').localeCompare(b.tecnico || ''));
        items.forEach(it => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${it.tecnico || ''}</td><td>${it.cedula || ''}</td><td>${it.super || ''}</td><td>${it.carpeta || ''}</td><td>${it.carpeta_dia || ''}</td>`;
            cuerpo.appendChild(tr);
        });
    } catch (e) {
        cuerpo.innerHTML = '<tr><td colspan="5">Error al cargar detalle</td></tr>';
    } finally {
        if (carga) carga.style.display = 'none';
        const modalEl = document.getElementById('modalDetalleAsistencia');
        const modal = new bootstrap.Modal(modalEl);
        modal.show();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    cargarSupervisoresEdicion();
    inicializarResumen();
    inicializarGraficas();
});
</script>

<style>
/* Estilos para las filas de totales por grupo */
.tabla-total-grupo {
    font-weight: bold !important;
    transition: all 0.3s ease;
}

.tabla-total-grupo:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.tabla-total-grupo .badge {
    font-size: 0.9rem !important;
    padding: 0.5rem 0.75rem !important;
    font-weight: bold !important;
}

/* Animación suave para las filas de totales */
@keyframes fadeInTotal {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.tabla-total-grupo {
    animation: fadeInTotal 0.5s ease-in-out;
}

/* Mejoras visuales para las tablas */
.table tbody tr {
    transition: background-color 0.2s ease;
}

.table tbody tr:hover:not(.tabla-total-grupo) {
    background-color: rgba(0,123,255,0.1) !important;
}
</style>

{% endblock %}
