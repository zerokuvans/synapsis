{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Avisos</h5>
      <div class="d-flex gap-2">
        <button class="btn btn-success btn-sm" data-bs-toggle="collapse" data-bs-target="#formAviso">
          <i class="fas fa-plus me-1"></i>Nuevo aviso
        </button>
      </div>
    </div>
    <div class="card-body">
      <div id="formAviso" class="collapse mb-3">
        <form id="crearAvisoForm" enctype="multipart/form-data" method="post" action="/api/avisos">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" name="titulo" required>
            </div>
            <div class="col-md-12">
              <label class="form-label">Mensaje</label>
              <textarea class="form-control" name="mensaje" rows="3" required></textarea>
            </div>
            <div class="col-md-3">
              <label class="form-label">Fecha inicio</label>
              <input type="datetime-local" class="form-control" name="fecha_inicio">
            </div>
            <div class="col-md-3">
              <label class="form-label">Fecha fin</label>
              <input type="datetime-local" class="form-control" name="fecha_fin">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="activo" id="activoCheck" checked>
                <label class="form-check-label" for="activoCheck">Activo</label>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Imagen (opcional)</label>
              <input type="file" class="form-control" name="imagen" accept="image/*">
              <div id="imagenPreview" class="form-text mt-2"></div>
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>Guardar aviso
            </button>
          </div>
        </form>
      </div>

      <div class="table-responsive">
        <table class="table table-striped align-middle" id="tablaAvisos">
          <thead>
            <tr>
              <th>ID</th>
              <th>Título</th>
              <th>Activo</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Imagen</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="mt-3 text-muted"><small>Los avisos activos se mostrarán en un popup al iniciar sesión.</small></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let avisosCache = [];
let modoEdicion = false;
let avisoEditandoId = null;

function setModoEdicion(on){
  modoEdicion = !!on;
  const btnSubmit = document.querySelector('#crearAvisoForm button[type="submit"]');
  if(btnSubmit){ btnSubmit.innerHTML = modoEdicion ? '<i class="fas fa-save me-1"></i>Actualizar aviso' : '<i class="fas fa-save me-1"></i>Guardar aviso'; }
  const colForm = document.getElementById('formAviso');
  if(colForm){ const collapse = bootstrap.Collapse.getOrCreateInstance(colForm); collapse.show(); }
}

function limpiarEdicion(){
  modoEdicion = false;
  avisoEditandoId = null;
  const form = document.getElementById('crearAvisoForm');
  if(form){ form.reset(); }
  const btnSubmit = document.querySelector('#crearAvisoForm button[type="submit"]');
  if(btnSubmit){ btnSubmit.innerHTML = '<i class="fas fa-save me-1"></i>Guardar aviso'; }
}

function llenarFormulario(aviso){
  const form = document.getElementById('crearAvisoForm');
  if(!form || !aviso) return;
  form.querySelector('[name="titulo"]').value = aviso.titulo || '';
  form.querySelector('[name="mensaje"]').value = aviso.mensaje || '';
  const toLocal = (s)=>{
    if(!s) return '';
    // s viene como 'YYYY-MM-DD HH:MM:SS' → input datetime-local espera 'YYYY-MM-DDTHH:MM'
    const m = String(s).trim().match(/^(\d{4}-\d{2}-\d{2}) (\d{2}:\d{2})/);
    return m ? `${m[1]}T${m[2]}` : '';
  };
  form.querySelector('[name="fecha_inicio"]').value = toLocal(aviso.fecha_inicio);
  form.querySelector('[name="fecha_fin"]').value = toLocal(aviso.fecha_fin);
  const chk = document.getElementById('activoCheck');
  if(chk){ chk.checked = !!aviso.activo; }
  const prev = document.getElementById('imagenPreview');
  if(prev){
    prev.innerHTML = aviso.imagen_url ? `Imagen actual:<br><img src="${aviso.imagen_url}" class="img-fluid rounded mt-1" style="max-width:100%; height:auto; max-height:50vh">` : 'Sin imagen actual';
  }
}

function iniciarEdicion(id){
  try{
    const aviso = avisosCache.find(a => Number(a.id) === Number(id));
    if(!aviso){ console.warn('Aviso no encontrado en cache', id); return; }
    avisoEditandoId = id;
    llenarFormulario(aviso);
    setModoEdicion(true);
  }catch(e){ console.error('Error iniciando edición', e); }
}

async function cargarAvisos(){
  try{
    const res = await fetch('/api/avisos', { credentials: 'same-origin' });
    const data = await res.json();
    if(!data.success){ throw new Error(data.message || 'Error'); }
    const tbody = document.querySelector('#tablaAvisos tbody');
    tbody.innerHTML = '';
    avisosCache = data.avisos || [];
    avisosCache.forEach(a => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.id}</td>
        <td>${a.titulo}</td>
        <td>${a.activo ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-secondary">No</span>'}</td>
        <td>${a.fecha_inicio || ''}</td>
        <td>${a.fecha_fin || ''}</td>
        <td>${a.imagen_url ? `<img src="${a.imagen_url}" style="height:40px">` : ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary" onclick="toggleActivo(${a.id}, ${a.activo ? 0 : 1})">
            <i class="fas ${a.activo ? 'fa-eye-slash' : 'fa-eye'}"></i>
          </button>
          <button class="btn btn-sm btn-outline-secondary ms-1" onclick="iniciarEdicion(${a.id})" title="Editar">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger ms-1" onclick="eliminarAviso(${a.id})" title="Eliminar">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }catch(e){
    console.error('Error cargando avisos', e);
  }
}

async function eliminarAviso(id){
  try{
    const ok = confirm('¿Está seguro de eliminar este aviso?');
    if(!ok) return;
    const res = await fetch(`/api/avisos/${id}`, { method: 'DELETE' });
    const data = await res.json();
    if(data.success){
      cargarAvisos();
    }else{
      alert(data.message || 'Error al eliminar aviso');
    }
  }catch(e){
    console.error('Error eliminando aviso', e);
    alert('Error eliminando aviso');
  }
}

async function toggleActivo(id, nuevoActivo){
  try{
    const res = await fetch(`/api/avisos/${id}`, {
      method: 'PATCH', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ activo: nuevoActivo })
    });
    const data = await res.json();
    if(data.success){ cargarAvisos(); }
  }catch(e){ console.error(e); }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const form = document.getElementById('crearAvisoForm');
  if(!form) return;
  form.addEventListener('submit', async (ev) => {
  ev.preventDefault();
  console.debug('[Avisos] submit crearAvisoForm');
  const fd = new FormData(ev.target);
  // Checkbox activo
  fd.set('activo', document.getElementById('activoCheck').checked ? '1' : '0');
  // Normalizar fechas de inputs datetime-local a 'YYYY-MM-DD HH:MM:SS'
  const fi = fd.get('fecha_inicio');
  const ff = fd.get('fecha_fin');
  const norm = (s)=>{
    if (!s) return '';
    const v = String(s).trim();
    if (!v) return '';
    const base = v.replace('T', ' ').replace('Z', '');
    return /\d{4}-\d{2}-\d{2} \d{2}:\d{2}$/.test(base) ? `${base}:00` : base;
  };
  if (fi) fd.set('fecha_inicio', norm(fi));
  if (ff) fd.set('fecha_fin', norm(ff));
  try{
    if(modoEdicion && avisoEditandoId){
      // En edición: enviar PATCH con FormData para permitir reemplazar imagen
      const res = await fetch(`/api/avisos/${avisoEditandoId}`, {
        method: 'PATCH',
        body: fd,
        credentials: 'same-origin'
      });
      console.debug('[Avisos] PATCH /api/avisos/'+avisoEditandoId+' status:', res.status);
      const data = await res.json();
      if(data.success){
        limpiarEdicion();
        const collapse = bootstrap.Collapse.getOrCreateInstance(document.getElementById('formAviso'));
        collapse.hide();
        cargarAvisos();
      } else {
        console.error('[Avisos] Error actualizando aviso:', data);
        alert(data.message || 'Error actualizando aviso');
      }
    } else {
      // Creación normal
      const res = await fetch('/api/avisos', { method: 'POST', body: fd, credentials: 'same-origin' });
      console.debug('[Avisos] POST /api/avisos status:', res.status);
      const data = await res.json();
      if(data.success){
        ev.target.reset();
        const collapse = bootstrap.Collapse.getOrCreateInstance(document.getElementById('formAviso'));
        collapse.hide();
        cargarAvisos();
      } else {
        console.error('[Avisos] Error creando aviso:', data);
        alert(data.message || 'Error creando aviso');
      }
    }
  }catch(e){ console.error('Error creando aviso', e); }
  });

  // Agregar botón cancelar edición si estamos en modo edición
  const contForm = document.getElementById('formAviso');
  if(contForm){
    const cancelarBtn = document.createElement('button');
    cancelarBtn.type = 'button';
    cancelarBtn.className = 'btn btn-outline-secondary ms-2';
    cancelarBtn.textContent = 'Cancelar';
    cancelarBtn.addEventListener('click', ()=>{ limpiarEdicion(); });
    const acciones = form.querySelector('.mt-3');
    if(acciones){ acciones.appendChild(cancelarBtn); }
  }
});

document.addEventListener('DOMContentLoaded', cargarAvisos);
</script>
{% endblock %}