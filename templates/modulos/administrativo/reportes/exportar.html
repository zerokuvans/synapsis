{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Exportar Reportes</h2>
        <div class="btn-group" role="group">
            <a href="{{ url_for('admin_reportes') }}" class="btn btn-outline-secondary">
                <i class="fas fa-chart-bar me-2"></i>Dashboard
            </a>
            <a href="{{ url_for('reportes_detallado') }}" class="btn btn-outline-primary">
                <i class="fas fa-table me-2"></i>Detallado
            </a>
            <a href="{{ url_for('admin_reportes') }}" class="btn btn-outline-info">
                <i class="fas fa-chart-line me-2"></i>Análisis
            </a>
            <a href="{{ url_for('admin_reportes') }}" class="btn btn-outline-warning">
                <i class="fas fa-cog me-2"></i>Configuración
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Panel de Configuración de Exportación -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-download me-2"></i>Configuración de Exportación
                    </h5>
                </div>
                <div class="card-body">
                    <form id="form-exportar">
                        <!-- Tipo de Reporte -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Tipo de Reporte</label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="tipo_reporte" id="reporte-preoperacional" value="preoperacional" checked>
                                            <label class="form-check-label" for="reporte-preoperacional">
                                                <i class="fas fa-clipboard-check me-2"></i>Preoperacional
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="tipo_reporte" id="reporte-vencimientos" value="vencimientos">
                                            <label class="form-check-label" for="reporte-vencimientos">
                                                <i class="fas fa-calendar-times me-2"></i>Vencimientos
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="tipo_reporte" id="reporte-usuarios" value="usuarios">
                                            <label class="form-check-label" for="reporte-usuarios">
                                                <i class="fas fa-users me-2"></i>Usuarios
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="tipo_reporte" id="reporte-consolidado" value="consolidado">
                                            <label class="form-check-label" for="reporte-consolidado">
                                                <i class="fas fa-chart-pie me-2"></i>Consolidado
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filtros de Datos -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Filtros de Datos</label>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="fecha-inicio-export" class="form-label">Fecha Inicio</label>
                                    <input type="date" class="form-control" id="fecha-inicio-export" name="fecha_inicio" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="fecha-fin-export" class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" id="fecha-fin-export" name="fecha_fin" required>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="supervisor-export" class="form-label">Supervisor</label>
                                    <select class="form-select" id="supervisor-export" name="supervisor">
                                        <option value="">Todos los supervisores</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="centro-trabajo-export" class="form-label">Centro de Trabajo</label>
                                    <select class="form-select" id="centro-trabajo-export" name="centro_trabajo">
                                        <option value="">Todos los centros</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Formato de Exportación -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Formato de Exportación</label>
                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="card text-center formato-card" data-formato="excel">
                                            <div class="card-body py-3">
                                                <i class="fas fa-file-excel fa-2x text-success mb-2"></i>
                                                <h6 class="card-title mb-0">Excel</h6>
                                                <small class="text-muted">.xlsx</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center formato-card" data-formato="pdf">
                                            <div class="card-body py-3">
                                                <i class="fas fa-file-pdf fa-2x text-danger mb-2"></i>
                                                <h6 class="card-title mb-0">PDF</h6>
                                                <small class="text-muted">.pdf</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center formato-card" data-formato="csv">
                                            <div class="card-body py-3">
                                                <i class="fas fa-file-csv fa-2x text-primary mb-2"></i>
                                                <h6 class="card-title mb-0">CSV</h6>
                                                <small class="text-muted">.csv</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center formato-card" data-formato="json">
                                            <div class="card-body py-3">
                                                <i class="fas fa-file-code fa-2x text-warning mb-2"></i>
                                                <h6 class="card-title mb-0">JSON</h6>
                                                <small class="text-muted">.json</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center formato-card" data-formato="word">
                                            <div class="card-body py-3">
                                                <i class="fas fa-file-word fa-2x text-info mb-2"></i>
                                                <h6 class="card-title mb-0">Word</h6>
                                                <small class="text-muted">.docx</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="card text-center formato-card" data-formato="xml">
                                            <div class="card-body py-3">
                                                <i class="fas fa-file-code fa-2x text-secondary mb-2"></i>
                                                <h6 class="card-title mb-0">XML</h6>
                                                <small class="text-muted">.xml</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <input type="hidden" id="formato-seleccionado" name="formato" value="excel">
                            </div>
                        </div>

                        <!-- Opciones Avanzadas -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Opciones Avanzadas</label>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="incluir-graficos" name="incluir_graficos" checked>
                                    <label class="form-check-label" for="incluir-graficos">
                                        Incluir gráficos y visualizaciones
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="incluir-estadisticas" name="incluir_estadisticas" checked>
                                    <label class="form-check-label" for="incluir-estadisticas">
                                        Incluir estadísticas resumidas
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="incluir-filtros" name="incluir_filtros" checked>
                                    <label class="form-check-label" for="incluir-filtros">
                                        Incluir información de filtros aplicados
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="agrupar-por-fecha" name="agrupar_por_fecha">
                                    <label class="form-check-label" for="agrupar-por-fecha">
                                        Agrupar datos por fecha
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="incluir-totales" name="incluir_totales" checked>
                                    <label class="form-check-label" for="incluir-totales">
                                        Incluir totales y subtotales
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="formato-profesional" name="formato_profesional" checked>
                                    <label class="form-check-label" for="formato-profesional">
                                        Aplicar formato profesional
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Configuración de Envío -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <label class="form-label fw-bold">Configuración de Envío (Opcional)</label>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email-destinatario" class="form-label">Email del destinatario</label>
                                    <input type="email" class="form-control" id="email-destinatario" name="email_destinatario" placeholder="ejemplo@empresa.com">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="asunto-email" class="form-label">Asunto del email</label>
                                    <input type="text" class="form-control" id="asunto-email" name="asunto_email" placeholder="Reporte de datos">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="mensaje-email" class="form-label">Mensaje personalizado</label>
                                    <textarea class="form-control" id="mensaje-email" name="mensaje_email" rows="3" placeholder="Mensaje opcional para acompañar el reporte..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acción -->
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary btn-lg me-3">
                                    <i class="fas fa-download me-2"></i>Exportar Ahora
                                </button>
                                <button type="button" class="btn btn-outline-secondary me-3" id="vista-previa">
                                    <i class="fas fa-eye me-2"></i>Vista Previa
                                </button>
                                <button type="button" class="btn btn-outline-info me-3" id="programar-exportacion">
                                    <i class="fas fa-clock me-2"></i>Programar Exportación
                                </button>
                                <button type="button" class="btn btn-outline-warning" id="guardar-plantilla">
                                    <i class="fas fa-save me-2"></i>Guardar como Plantilla
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Panel Lateral -->
        <div class="col-md-4">
            <!-- Plantillas Guardadas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bookmark me-2"></i>Plantillas Guardadas
                    </h5>
                </div>
                <div class="card-body">
                    <div id="lista-plantillas">
                        <!-- Las plantillas se cargarán dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Historial de Exportaciones -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Historial de Exportaciones
                    </h5>
                </div>
                <div class="card-body">
                    <div id="historial-exportaciones">
                        <!-- El historial se cargará dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Estadísticas de Exportación -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Estadísticas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <h6 class="text-muted">Este Mes</h6>
                                <h4 id="exportaciones-mes">--</h4>
                            </div>
                        </div>
                        <div class="col-6">
                            <h6 class="text-muted">Total</h6>
                            <h4 id="exportaciones-total">--</h4>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <h6 class="text-muted">Formato Más Usado</h6>
                        <h5 id="formato-popular">--</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Vista Previa -->
<div class="modal fade" id="modalVistaPrevia" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vista Previa del Reporte</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="contenido-vista-previa">
                    <!-- El contenido se cargará dinámicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="exportar-desde-preview">Exportar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Programar Exportación -->
<div class="modal fade" id="modalProgramarExportacion" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Programar Exportación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-programar">
                    <div class="mb-3">
                        <label for="nombre-programacion" class="form-label">Nombre de la programación</label>
                        <input type="text" class="form-control" id="nombre-programacion" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="frecuencia" class="form-label">Frecuencia</label>
                        <select class="form-select" id="frecuencia" name="frecuencia" required>
                            <option value="">Seleccionar frecuencia</option>
                            <option value="diario">Diario</option>
                            <option value="semanal">Semanal</option>
                            <option value="mensual">Mensual</option>
                            <option value="trimestral">Trimestral</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="hora-ejecucion" class="form-label">Hora de ejecución</label>
                        <input type="time" class="form-control" id="hora-ejecucion" name="hora" required>
                    </div>
                    <div class="mb-3">
                        <label for="email-programado" class="form-label">Email de envío</label>
                        <input type="email" class="form-control" id="email-programado" name="email" required>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="activo-programacion" name="activo" checked>
                        <label class="form-check-label" for="activo-programacion">
                            Activar programación
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmar-programacion">Programar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Guardar Plantilla -->
<div class="modal fade" id="modalGuardarPlantilla" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Guardar Plantilla</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-guardar-plantilla">
                    <div class="mb-3">
                        <label for="nombre-plantilla" class="form-label">Nombre de la plantilla</label>
                        <input type="text" class="form-control" id="nombre-plantilla" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="descripcion-plantilla" class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcion-plantilla" name="descripcion" rows="3"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="plantilla-publica" name="publica">
                        <label class="form-check-label" for="plantilla-publica">
                            Hacer plantilla pública (disponible para otros usuarios)
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmar-guardar-plantilla">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let formatoSeleccionado = 'excel';
    
    // Configuración de fechas por defecto
    const hoy = new Date();
    const hace30Dias = new Date(hoy.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('fecha-inicio-export').value = hace30Dias.toISOString().split('T')[0];
    document.getElementById('fecha-fin-export').value = hoy.toISOString().split('T')[0];
    
    // Función para cargar selectores
    const cargarSelectores = async () => {
        try {
            const response = await fetch('/api/reportes/filtros/avanzados');
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Cargar supervisores
            const supervisorSelect = document.getElementById('supervisor-export');
            supervisorSelect.innerHTML = '<option value="">Todos los supervisores</option>';
            data.supervisores.forEach(supervisor => {
                const option = document.createElement('option');
                option.value = supervisor.id;
                option.textContent = supervisor.nombre;
                supervisorSelect.appendChild(option);
            });
            
            // Cargar centros de trabajo
            const centroSelect = document.getElementById('centro-trabajo-export');
            centroSelect.innerHTML = '<option value="">Todos los centros</option>';
            data.centros_trabajo.forEach(centro => {
                const option = document.createElement('option');
                option.value = centro.id;
                option.textContent = centro.nombre;
                centroSelect.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error al cargar selectores:', error);
            mostrarError(error.message);
        }
    };
    
    // Función para cargar plantillas
    const cargarPlantillas = async () => {
        try {
            const response = await fetch('/api/reportes/plantillas');
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            const contenedor = document.getElementById('lista-plantillas');
            contenedor.innerHTML = '';
            
            if (data.plantillas.length === 0) {
                contenedor.innerHTML = '<p class="text-muted text-center">No hay plantillas guardadas</p>';
                return;
            }
            
            data.plantillas.forEach(plantilla => {
                const div = document.createElement('div');
                div.className = 'border rounded p-2 mb-2 plantilla-item';
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${plantilla.nombre}</h6>
                            <small class="text-muted">${plantilla.descripcion || 'Sin descripción'}</small>
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="cargarPlantilla(${plantilla.id})">
                                <i class="fas fa-upload"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="eliminarPlantilla(${plantilla.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                contenedor.appendChild(div);
            });
            
        } catch (error) {
            console.error('Error al cargar plantillas:', error);
        }
    };
    
    // Función para cargar historial
    const cargarHistorial = async () => {
        try {
            const response = await fetch('/api/reportes/historial-exportaciones');
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            const contenedor = document.getElementById('historial-exportaciones');
            contenedor.innerHTML = '';
            
            if (data.historial.length === 0) {
                contenedor.innerHTML = '<p class="text-muted text-center">No hay exportaciones recientes</p>';
                return;
            }
            
            data.historial.slice(0, 5).forEach(item => {
                const div = document.createElement('div');
                div.className = 'border-bottom pb-2 mb-2';
                div.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${item.tipo_reporte}</h6>
                            <small class="text-muted">${item.fecha} - ${item.formato}</small>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="descargarArchivo('${item.archivo}')">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
                contenedor.appendChild(div);
            });
            
        } catch (error) {
            console.error('Error al cargar historial:', error);
        }
    };
    
    // Función para cargar estadísticas
    const cargarEstadisticas = async () => {
        try {
            const response = await fetch('/api/reportes/estadisticas-exportacion');
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            document.getElementById('exportaciones-mes').textContent = data.exportaciones_mes || '0';
            document.getElementById('exportaciones-total').textContent = data.exportaciones_total || '0';
            document.getElementById('formato-popular').textContent = data.formato_popular || 'N/A';
            
        } catch (error) {
            console.error('Error al cargar estadísticas:', error);
        }
    };
    
    // Función para exportar reporte
    const exportarReporte = async (configuracion) => {
        try {
            mostrarCargando(true);
            
            const response = await fetch('/api/reportes/exportar', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(configuracion)
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `reporte_${configuracion.tipo_reporte}_${new Date().toISOString().split('T')[0]}.${configuracion.formato}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                mostrarExito('Reporte exportado exitosamente');
                cargarHistorial();
                cargarEstadisticas();
            } else {
                const data = await response.json();
                throw new Error(data.error || 'Error al exportar reporte');
            }
            
        } catch (error) {
            console.error('Error al exportar:', error);
            mostrarError(error.message);
        } finally {
            mostrarCargando(false);
        }
    };
    
    // Función para mostrar vista previa
    const mostrarVistaPrevia = async (configuracion) => {
        try {
            const response = await fetch('/api/reportes/vista-previa', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(configuracion)
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            const contenedor = document.getElementById('contenido-vista-previa');
            contenedor.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                ${data.columnas.map(col => `<th>${col}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.filas.slice(0, 10).map(fila => 
                                `<tr>${fila.map(celda => `<td>${celda}</td>`).join('')}</tr>`
                            ).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">Mostrando las primeras 10 filas de ${data.total_filas} registros</small>
                </div>
            `;
            
            new bootstrap.Modal(document.getElementById('modalVistaPrevia')).show();
            
        } catch (error) {
            console.error('Error al generar vista previa:', error);
            mostrarError(error.message);
        }
    };
    
    // Función para obtener configuración del formulario
    const obtenerConfiguracion = () => {
        const formData = new FormData(document.getElementById('form-exportar'));
        return {
            tipo_reporte: formData.get('tipo_reporte'),
            fecha_inicio: formData.get('fecha_inicio'),
            fecha_fin: formData.get('fecha_fin'),
            supervisor: formData.get('supervisor'),
            centro_trabajo: formData.get('centro_trabajo'),
            formato: formatoSeleccionado,
            incluir_graficos: formData.has('incluir_graficos'),
            incluir_estadisticas: formData.has('incluir_estadisticas'),
            incluir_filtros: formData.has('incluir_filtros'),
            agrupar_por_fecha: formData.has('agrupar_por_fecha'),
            incluir_totales: formData.has('incluir_totales'),
            formato_profesional: formData.has('formato_profesional'),
            email_destinatario: formData.get('email_destinatario'),
            asunto_email: formData.get('asunto_email'),
            mensaje_email: formData.get('mensaje_email')
        };
    };
    
    // Función para mostrar/ocultar indicador de carga
    const mostrarCargando = (mostrar) => {
        const btn = document.querySelector('#form-exportar button[type="submit"]');
        if (mostrar) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Exportando...';
        } else {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-download me-2"></i>Exportar Ahora';
        }
    };
    
    // Función para mostrar errores
    const mostrarError = (mensaje) => {
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            <strong>Error:</strong> ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').prepend(alert);
    };
    
    // Función para mostrar éxito
    const mostrarExito = (mensaje) => {
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show';
        alert.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container-fluid').prepend(alert);
    };
    
    // Event Listeners
    
    // Selección de formato
    document.querySelectorAll('.formato-card').forEach(card => {
        card.addEventListener('click', () => {
            document.querySelectorAll('.formato-card').forEach(c => c.classList.remove('border-primary', 'bg-light'));
            card.classList.add('border-primary', 'bg-light');
            formatoSeleccionado = card.dataset.formato;
            document.getElementById('formato-seleccionado').value = formatoSeleccionado;
        });
    });
    
    // Formulario de exportación
    document.getElementById('form-exportar').addEventListener('submit', (e) => {
        e.preventDefault();
        const configuracion = obtenerConfiguracion();
        exportarReporte(configuracion);
    });
    
    // Vista previa
    document.getElementById('vista-previa').addEventListener('click', () => {
        const configuracion = obtenerConfiguracion();
        mostrarVistaPrevia(configuracion);
    });
    
    // Exportar desde vista previa
    document.getElementById('exportar-desde-preview').addEventListener('click', () => {
        const configuracion = obtenerConfiguracion();
        bootstrap.Modal.getInstance(document.getElementById('modalVistaPrevia')).hide();
        exportarReporte(configuracion);
    });
    
    // Programar exportación
    document.getElementById('programar-exportacion').addEventListener('click', () => {
        new bootstrap.Modal(document.getElementById('modalProgramarExportacion')).show();
    });
    
    // Confirmar programación
    document.getElementById('confirmar-programacion').addEventListener('click', async () => {
        const form = document.getElementById('form-programar');
        const formData = new FormData(form);
        const configuracionExportacion = obtenerConfiguracion();
        
        try {
            const response = await fetch('/api/reportes/programar-exportacion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nombre: formData.get('nombre'),
                    frecuencia: formData.get('frecuencia'),
                    hora: formData.get('hora'),
                    email: formData.get('email'),
                    activo: formData.has('activo'),
                    configuracion_exportacion: configuracionExportacion
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('modalProgramarExportacion')).hide();
            form.reset();
            mostrarExito('Exportación programada exitosamente');
            
        } catch (error) {
            console.error('Error al programar exportación:', error);
            mostrarError(error.message);
        }
    });
    
    // Guardar plantilla
    document.getElementById('guardar-plantilla').addEventListener('click', () => {
        new bootstrap.Modal(document.getElementById('modalGuardarPlantilla')).show();
    });
    
    // Confirmar guardar plantilla
    document.getElementById('confirmar-guardar-plantilla').addEventListener('click', async () => {
        const form = document.getElementById('form-guardar-plantilla');
        const formData = new FormData(form);
        const configuracion = obtenerConfiguracion();
        
        try {
            const response = await fetch('/api/reportes/plantillas', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nombre: formData.get('nombre'),
                    descripcion: formData.get('descripcion'),
                    publica: formData.has('publica'),
                    configuracion: configuracion
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('modalGuardarPlantilla')).hide();
            form.reset();
            mostrarExito('Plantilla guardada exitosamente');
            cargarPlantillas();
            
        } catch (error) {
            console.error('Error al guardar plantilla:', error);
            mostrarError(error.message);
        }
    });
    
    // Funciones globales para plantillas
    window.cargarPlantilla = async (id) => {
        try {
            const response = await fetch(`/api/reportes/plantillas/${id}`);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            const config = data.configuracion;
            
            // Cargar configuración en el formulario
            document.querySelector(`input[name="tipo_reporte"][value="${config.tipo_reporte}"]`).checked = true;
            document.getElementById('fecha-inicio-export').value = config.fecha_inicio;
            document.getElementById('fecha-fin-export').value = config.fecha_fin;
            document.getElementById('supervisor-export').value = config.supervisor || '';
            document.getElementById('centro-trabajo-export').value = config.centro_trabajo || '';
            
            // Seleccionar formato
            document.querySelectorAll('.formato-card').forEach(c => c.classList.remove('border-primary', 'bg-light'));
            document.querySelector(`[data-formato="${config.formato}"]`).classList.add('border-primary', 'bg-light');
            formatoSeleccionado = config.formato;
            
            // Configurar checkboxes
            document.getElementById('incluir-graficos').checked = config.incluir_graficos;
            document.getElementById('incluir-estadisticas').checked = config.incluir_estadisticas;
            document.getElementById('incluir-filtros').checked = config.incluir_filtros;
            document.getElementById('agrupar-por-fecha').checked = config.agrupar_por_fecha;
            document.getElementById('incluir-totales').checked = config.incluir_totales;
            document.getElementById('formato-profesional').checked = config.formato_profesional;
            
            mostrarExito('Plantilla cargada exitosamente');
            
        } catch (error) {
            console.error('Error al cargar plantilla:', error);
            mostrarError(error.message);
        }
    };
    
    window.eliminarPlantilla = async (id) => {
        if (!confirm('¿Está seguro de que desea eliminar esta plantilla?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/reportes/plantillas/${id}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            mostrarExito('Plantilla eliminada exitosamente');
            cargarPlantillas();
            
        } catch (error) {
            console.error('Error al eliminar plantilla:', error);
            mostrarError(error.message);
        }
    };
    
    window.descargarArchivo = (archivo) => {
        const a = document.createElement('a');
        a.href = `/api/reportes/descargar/${archivo}`;
        a.download = archivo;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    };
    
    // Inicialización
    cargarSelectores();
    cargarPlantillas();
    cargarHistorial();
    cargarEstadisticas();
    
    // Seleccionar formato Excel por defecto
    document.querySelector('[data-formato="excel"]').classList.add('border-primary', 'bg-light');
});
</script>
{% endblock %}