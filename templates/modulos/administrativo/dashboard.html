<!-- filepath: /c:/Users/vansn/OneDrive/DESARROLLO/TECNICOS/templates/modulos/administrativo/dashboard.html -->
{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white fw-bold">
                    <h3 class="mb-0">
                        <i class="fas fa-user-shield me-2"></i>Panel Administrativo
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Bienvenido al panel administrativo. Aquí podrás gestionar usuarios y ver reportes.
                    </div>

                    <!-- Contenido específico del módulo administrativo -->
                    <div class="row mt-4">
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Gestión de Usuarios</h5>
                                    <p class="card-text">Administrar usuarios del sistema.</p>
                                    <a href="{{ url_for('usuarios') }}" class="btn btn-info">
                                        <i class="fas fa-user-cog me-2"></i>Administrar Usuarios
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-clipboard-check fa-3x text-success mb-3"></i>
                                    <h5 class="card-title">Inspecciones Preoperacionales</h5>
                                    <p class="card-text">Ver listado y reportes de inspecciones.</p>
                                    <a href="{{ url_for('listado_preoperacional') }}" class="btn btn-success">
                                        <i class="fas fa-list me-2"></i>Ver Listado
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-bar fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Estadísticas</h5>
                                    <p class="card-text">
                                        Total usuarios: {{ total_users }}<br>
                                        Total roles: {{ total_roles }}<br>
                                        Usuarios activos: {{ active_users }}
                                    </p>
                                    <a href="{{ url_for('admin_reportes') }}" class="btn btn-primary">Ver Reportes Detallados</a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-cog fa-3x text-warning mb-3"></i>
                                    <h5 class="card-title">Configuración</h5>
                                    <p class="card-text">Configura parámetros del sistema.</p>
                                    <a href="#" class="btn btn-warning">
                                        <i class="fas fa-sliders-h me-2"></i>Configurar
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-clock fa-3x text-danger mb-3"></i>
                                    <h5 class="card-title">Hora Preoperacional</h5>
                                    <p class="card-text">Configurar hora límite para inspecciones preoperacionales.</p>
                                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalHoraPreoperacional">
                                        <i class="fas fa-clock me-2"></i>Configurar Hora
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-user-clock fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Hora Inicio Operación Analistas</h5>
                                    <p class="card-text">Configurar hora límite para registro de inicio de operación.</p>
                                    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalHoraInicioAnalistas">
                                        <i class="fas fa-clock me-2"></i>Configurar Hora
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-boxes fa-3x text-primary mb-3"></i>
                                    <h5 class="card-title">Suministros</h5>
                                    <p class="card-text">Administrar suministros y materiales.</p>
                                    <a href="{{ url_for('suministros') }}" class="btn btn-primary">
                                        <i class="fas fa-box-open me-2"></i>Gestionar Suministros
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-pie fa-3x text-success mb-3"></i>
                                    <h5 class="card-title">Estadísticas de Inventario</h5>
                                    <p class="card-text">Visualizar estadísticas de herramientas, EPPs y materiales.</p>
                                    <a href="{{ url_for('estadisticas_inventario') }}" class="btn btn-success">
                                        <i class="fas fa-chart-line me-2"></i>Ver Estadísticas
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Segunda fila de módulos administrativos -->
                    <div class="row mt-4">
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-cogs fa-3x text-secondary mb-3"></i>
                                    <h5 class="card-title">Límites Ferretero</h5>
                                    <p class="card-text">Configuración de límites por área de trabajo.</p>
                                    <a href="/logistica/limites_ferretero" class="btn btn-secondary">
                                        <i class="fas fa-sliders-h me-2"></i>Gestionar Límites
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-database fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Base de Datos</h5>
                                    <p class="card-text">Administración y mantenimiento de BD.</p>
                                    <a href="#" class="btn btn-info">
                                        <i class="fas fa-server me-2"></i>Administrar BD
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                                    <h5 class="card-title">Seguridad</h5>
                                    <p class="card-text">Configuración de seguridad y permisos.</p>
                                    <a href="#" class="btn btn-danger">
                                        <i class="fas fa-lock me-2"></i>Configurar Seguridad
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-file-export fa-3x text-dark mb-3"></i>
                                    <h5 class="card-title">Exportaciones</h5>
                                    <p class="card-text">Exportar datos y generar respaldos.</p>
                                    <a href="#" class="btn btn-dark">
                                        <i class="fas fa-download me-2"></i>Exportar Datos
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cards -->
                    <!--<div class="row">-->
                        <!-- Card Gestión de Usuarios 
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 border-0 shadow">
                                <div class="card-body text-center">
                                    <i class="fas fa-users fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Gestión de Usuarios</h5>
                                    <p class="card-text">Administra los usuarios del sistema, permisos y roles.</p>
                                    <a href="{{ url_for('buscar_usuarios') }}" class="btn btn-info">Administrar Usuarios</a>
                                </div>
                            </div>
                        </div>
                    -->
                        <!-- Card Estadísticas de Inventario -->
                        <!--<div class="col-md-4 mb-4">
                            <div class="card h-100 border-0 shadow">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-bar fa-3x text-success mb-3"></i>
                                    <h5 class="card-title">Estadísticas de Inventario</h5>
                                    <p class="card-text">Visualiza datos y gráficos sobre el inventario de herramientas y materiales.</p>
                                    <a href="{{ url_for('estadisticas_inventario') }}" class="btn btn-success">Ver Estadísticas</a>
                                </div>
                            </div>
                        </div>
                    -->
                        <!-- Card Estadísticas de Usuarios -->
                       <!-- <div class="col-md-4 mb-4">
                            <div class="card h-100 border-0 shadow">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                                    <h5 class="card-title">Estadísticas de Usuarios</h5>
                                    <p class="card-text">Visualiza datos y gráficos sobre el uso del sistema por parte de los usuarios.</p>
                                    <a href="{{ url_for('estadisticas_usuarios') }}" class="btn btn-primary">Ver Estadísticas</a>
                                </div>
                            </div>
                        </div>
                    -->
                        <!-- Más cards aquí -->
                    </div>

                    
                </div>
            </div>
        </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Usuario -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Gestionar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId" name="id_codigo_consumidor">
                    <div class="mb-3">
                        <label for="cedula" class="form-label">Cédula</label>
                        <input type="text" class="form-control" id="cedula" name="cedula" required>
                    </div>
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" name="nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="cargo" class="form-label">Cargo</label>
                        <select class="form-select" id="cargo" name="cargo" required>
                            <option value="">Seleccione un cargo</option>
                            <!-- Los cargos se cargarán dinámicamente desde la API -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="rol" class="form-label">Rol</label>
                        <select class="form-select" id="rol" name="rol" required>
                            {% for key, value in ROLES.items() %}
                            <option value="{{ key }}">{{ value }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="estado" class="form-label">Estado</label>
                        <select class="form-select" id="estado" name="estado" required>
                            <option value="Activo">Activo</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="password" name="password">
                        <small class="text-muted">Dejar en blanco para mantener la contraseña actual</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" id="saveUser">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar cargos desde la API
    function cargarCargos() {
        fetch('/api/cargos')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const cargoSelect = document.getElementById('cargo');
                    // Mantener solo la primera opción (Seleccione un cargo)
                    cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
                    
                    // Agregar los cargos obtenidos de la API
                    data.cargos.forEach(cargo => {
                        const option = document.createElement('option');
                        option.value = cargo;
                        option.textContent = cargo;
                        cargoSelect.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error al cargar cargos:', error));
    }
    
    // Cargar cargos al iniciar la página
    cargarCargos();
    
    // Funcionalidad para editar usuario
    document.querySelectorAll('.edit-user').forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            // Asegurarse de que los cargos estén cargados
            cargarCargos();
            
            fetch(`/get_user/${userId}`)
                .then(response => response.json())
                .then(user => {
                    document.getElementById('userId').value = user.id_codigo_consumidor;
                    document.getElementById('cedula').value = user.recurso_operativo_cedula;
                    document.getElementById('nombre').value = user.nombre;
                    document.getElementById('cargo').value = user.cargo;
                    document.getElementById('rol').value = user.id_roles;
                    document.getElementById('estado').value = user.estado;
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                });
        });
    });

    // Funcionalidad para eliminar usuario
    document.querySelectorAll('.delete-user').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('¿Está seguro de eliminar este usuario?')) {
                const userId = this.dataset.userId;
                fetch(`/user/delete/${userId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        location.reload();
                    } else {
                        alert(data.message);
                    }
                });
            }
        });
    });

    // Funcionalidad para guardar usuario
    document.getElementById('saveUser').addEventListener('click', function() {
        const form = document.getElementById('userForm');
    const formData = new FormData(form);
        const userId = document.getElementById('userId').value;
    
        fetch(userId ? '/update_user' : '/create_user', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
        } else {
                alert(data.message);
            }
        });
    });
});

// Función para abrir el modal de creación de usuario
function abrirModalNuevoUsuario() {
    // Limpiar formulario
    document.getElementById('userForm').reset();
    document.getElementById('userId').value = '';
    document.getElementById('userModalLabel').textContent = 'Crear Nuevo Usuario';
    
    // Cargar cargos disponibles
    fetch('/api/cargos')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const cargoSelect = document.getElementById('cargo');
                // Mantener solo la primera opción (Seleccione un cargo)
                cargoSelect.innerHTML = '<option value="">Seleccione un cargo</option>';
                
                // Agregar los cargos obtenidos de la API
                data.cargos.forEach(cargo => {
                    const option = document.createElement('option');
                    option.value = cargo;
                    option.textContent = cargo;
                    cargoSelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error al cargar cargos:', error));
    
    // Mostrar modal
    new bootstrap.Modal(document.getElementById('userModal')).show();
}
</script>

<!-- Modal para configuración de hora preoperacional -->
<div class="modal fade" id="modalHoraPreoperacional" tabindex="-1" aria-labelledby="modalHoraPreoperacionalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalHoraPreoperacionalLabel">
                    <i class="fas fa-clock me-2"></i>Configurar Hora Límite Preoperacional
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Configure la hora límite hasta la cual los técnicos pueden registrar inspecciones preoperacionales.
                </div>
                
                <form id="formHoraPreoperacional">
                    <div class="mb-3">
                        <label for="horaLimite" class="form-label">
                            <i class="fas fa-clock me-2"></i>Hora Límite (formato 24 horas)
                        </label>
                        <input type="time" class="form-control" id="horaLimite" name="horaLimite" required>
                        <div class="form-text">
                            Los técnicos podrán registrar inspecciones hasta esta hora (hora de Bogotá).
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-info-circle me-2"></i>Configuración Actual
                                </h6>
                                <p class="card-text mb-0">
                                    Hora límite actual: <span id="horaActual" class="fw-bold text-primary">Cargando...</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-danger" id="btnGuardarHora">
                    <i class="fas fa-save me-2"></i>Guardar Configuración
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalHoraInicioAnalistas" tabindex="-1" aria-labelledby="modalHoraInicioAnalistasLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalHoraInicioAnalistasLabel"><i class="fas fa-clock me-2"></i>Configurar Hora Límite Inicio Operación Analistas</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formHoraInicioAnalistas">
                    <div class="mb-3">
                        <label for="horaLimiteAnalistas" class="form-label"><i class="fas fa-clock me-2"></i>Hora Límite (24 horas)</label>
                        <input type="time" class="form-control" id="horaLimiteAnalistas" name="horaLimiteAnalistas" required>
                        <div class="form-text">Hora actual configurada: <span id="horaActualAnalistas" class="fw-bold">--:--</span></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-info" id="btnGuardarHoraAnalistas"><i class="fas fa-save me-2"></i>Guardar Configuración</button>
            </div>
        </div>
    </div>
 </div>

<script>
// JavaScript para gestión de hora preoperacional
document.addEventListener('DOMContentLoaded', function() {
    const modalHoraPreoperacional = document.getElementById('modalHoraPreoperacional');
    const formHoraPreoperacional = document.getElementById('formHoraPreoperacional');
    const horaLimiteInput = document.getElementById('horaLimite');
    const horaActualSpan = document.getElementById('horaActual');
    const btnGuardarHora = document.getElementById('btnGuardarHora');
    
    // Cargar hora actual cuando se abre el modal
    modalHoraPreoperacional.addEventListener('show.bs.modal', function() {
        cargarHoraActual();
    });
    
    // Función para cargar la hora actual
    async function cargarHoraActual() {
        try {
            const response = await fetch('/api/configuracion/hora-preoperacional');
            const data = await response.json();
            
            if (data.success && data.data) {
                const horaActual = data.data.hora_limite_formatted;
                horaActualSpan.textContent = horaActual;
                horaLimiteInput.value = horaActual;
            } else {
                horaActualSpan.textContent = 'Error al cargar';
                console.error('Error al obtener hora actual:', data.error);
            }
        } catch (error) {
            horaActualSpan.textContent = 'Error al cargar';
            console.error('Error al cargar hora actual:', error);
        }
    }
    
    // Guardar nueva configuración
    btnGuardarHora.addEventListener('click', async function() {
        const nuevaHora = horaLimiteInput.value;
        
        if (!nuevaHora) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo requerido',
                text: 'Por favor, seleccione una hora límite.'
            });
            return;
        }
        
        // Deshabilitar botón mientras se procesa
        btnGuardarHora.disabled = true;
        btnGuardarHora.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
        
        try {
            const response = await fetch('/api/configuracion/hora-preoperacional', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    hora_limite: nuevaHora
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Configuración actualizada',
                    text: `La hora límite se ha actualizado a ${nuevaHora}`,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Cerrar modal
                bootstrap.Modal.getInstance(modalHoraPreoperacional).hide();
                
                // Actualizar la hora mostrada
                horaActualSpan.textContent = nuevaHora;
                
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error al actualizar',
                    text: data.error || 'No se pudo actualizar la configuración'
                });
            }
        } catch (error) {
            console.error('Error al actualizar hora:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo conectar con el servidor'
            });
        } finally {
            // Rehabilitar botón
            btnGuardarHora.disabled = false;
            btnGuardarHora.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Configuración';
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modalHoraInicioAnalistas = document.getElementById('modalHoraInicioAnalistas');
    const horaActualAnalistas = document.getElementById('horaActualAnalistas');
    const horaLimiteAnalistas = document.getElementById('horaLimiteAnalistas');
    const btnGuardarHoraAnalistas = document.getElementById('btnGuardarHoraAnalistas');

    modalHoraInicioAnalistas.addEventListener('show.bs.modal', async function() {
        try {
            const response = await fetch('/api/configuracion/hora-inicio-operacion');
            const data = await response.json();
            if (data.success && data.data && data.data.hora_limite_formatted) {
                horaActualAnalistas.textContent = data.data.hora_limite_formatted;
                horaLimiteAnalistas.value = data.data.hora_limite_formatted;
            }
        } catch (e) {}
    });

    btnGuardarHoraAnalistas.addEventListener('click', async function() {
        const nuevaHora = horaLimiteAnalistas.value;
        if (!nuevaHora) { return; }
        btnGuardarHoraAnalistas.disabled = true;
        btnGuardarHoraAnalistas.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
        try {
            const response = await fetch('/api/configuracion/hora-inicio-operacion', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ hora_limite: nuevaHora })
            });
            const data = await response.json();
            if (data.success) {
                horaActualAnalistas.textContent = nuevaHora;
                bootstrap.Modal.getInstance(modalHoraInicioAnalistas).hide();
            }
        } catch (e) {
        } finally {
            btnGuardarHoraAnalistas.disabled = false;
            btnGuardarHoraAnalistas.innerHTML = '<i class="fas fa-save me-2"></i>Guardar Configuración';
        }
    });
});
</script>
{% endblock %}
