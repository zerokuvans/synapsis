{% extends "base.html" %}

{% block title %}Gestión de Usuarios{% endblock %}

{% block head %}
<!-- Agregar Animate.css para animaciones -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
<style>
    /* Estilos personalizados para mejorar la interfaz */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.1) !important;
        transition: background-color 0.3s ease;
    }
    
    .btn-group .btn {
        transition: all 0.2s ease;
    }
    
    .btn-group .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .card {
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }
    
    .card:hover {
        box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }
    
    .badge {
        font-weight: 500;
        padding: 0.4em 0.6em;
    }
    
    #contadorRegistros, #totalRegistros, #paginaActual, #totalPaginas {
        transition: color 0.3s ease;
    }
    
    /* Estilos para paginación personalizada */
    .pagination-info {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
    }
    
    .pagination-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }
    
    .pagination-controls .btn {
        transition: all 0.2s ease;
    }
    
    .pagination-controls .btn:hover:not(:disabled) {
        transform: translateY(-2px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Gestión de Usuarios</h1>
    
    <!-- Filtros de búsqueda -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-search me-1"></i>
            Buscar Usuarios
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="buscarUsuario" placeholder="Buscar por cédula o nombre...">
                    </div>
                </div>
                <div class="col-md-2 mb-3">
                    <select class="form-select" id="filtroRol">
                        <option value="">Todos los roles</option>
                        {% for id, rol in ROLES.items() %}
                        <option value="{{ rol }}">{{ rol|title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <select class="form-select" id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="Activo">Activo</option>
                        <option value="Inactivo">Inactivo</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <select class="form-select" id="filtroCargo">
                        <option value="">Todos los cargos</option>
                        <!-- Las opciones se cargarán dinámicamente desde /api/cargos -->
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <button class="btn btn-primary w-100" id="btnLimpiarFiltros">
                        <i class="fas fa-eraser me-2"></i>Limpiar
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="form-text text-muted">
                        <i class="fas fa-info-circle me-1"></i> Los filtros se aplican automáticamente al escribir o seleccionar. Mostrando <span id="contadorRegistros">0</span> de <span id="totalRegistros">0</span> usuarios.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <div>
                <i class="fas fa-users me-1"></i>
                Usuarios Registrados
            </div>
            <div>
                <button id="btnExportarExcel" class="btn btn-info me-2">
                    <i class="fas fa-file-excel me-1"></i> Exportar a Excel
                </button>
                <button class="btn btn-light" data-bs-toggle="modal" data-bs-target="#crearUsuarioModal">
                    <i class="fas fa-user-plus me-1"></i> Crear Usuario
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover table-bordered" id="tablaUsuarios">
                    <thead class="table-dark">
                        <tr>
                            <th>Código</th>
                            <th>Cédula</th>
                            <th>Nombre</th>
                            <th>Rol</th>
                            <th>Estado</th>
                            <th>Cargo</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for usuario in usuarios %}
                        <tr>
                            <td data-cargo="{{ usuario.cargo }}">{{ usuario.id_codigo_consumidor }}</td>
                            <td>{{ usuario.recurso_operativo_cedula }}</td>
                            <td>{{ usuario.nombre }}</td>
                            <td>
                                <span class="badge bg-{{ 'primary' if usuario.role == 'admin' else 'secondary' }}">
                                    {{ usuario.role|title }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if usuario.estado == 'Activo' else 'danger' }}">
                                    {{ usuario.estado }}
                                </span>
                            </td>
                            <td>{{ usuario.cargo }}</td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-warning editar-usuario" 
                                            data-id="{{ usuario.id_codigo_consumidor }}"
                                            data-bs-toggle="tooltip" data-bs-placement="top" title="Editar usuario">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger eliminar-usuario" 
                                            data-id="{{ usuario.id_codigo_consumidor }}"
                                            data-cedula="{{ usuario.recurso_operativo_cedula }}"
                                            data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar usuario">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Paginación (Frontend) -->
            <div class="mt-4">
                <div class="pagination-info mb-2">
                    <span class="text-muted">Mostrando página <span id="paginaActual" class="fw-bold">1</span> de <span id="totalPaginas" class="fw-bold">{{ total_pages }}</span></span>
                </div>
                <div class="pagination-controls">
                    <button id="btnPaginaAnterior" class="btn btn-outline-primary" disabled>
                        <i class="fas fa-chevron-left me-1"></i> Anterior
                    </button>
                    <select id="selectorPagina" class="form-select mx-2" style="width: auto;">
                        {% for i in range(1, total_pages + 1) %}
                            <option value="{{ i }}">Página {{ i }}</option>
                        {% endfor %}
                    </select>
                    <button id="btnPaginaSiguiente" class="btn btn-outline-primary">
                        Siguiente <i class="fas fa-chevron-right ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar usuario -->
<div class="modal fade" id="editarUsuarioModal" tabindex="-1" aria-labelledby="editarUsuarioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="editarUsuarioModalLabel">Editar Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Indicador de carga -->
                <div id="loadingSpinner" class="text-center my-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando datos del usuario...</p>
                </div>
                
                <form id="formEditarUsuario" method="post" action="{{ url_for('actualizar_usuario') }}" class="needs-validation" novalidate>
                    <input type="hidden" id="edit_id_codigo_consumidor" name="id_codigo_consumidor">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_recurso_operativo_cedula" class="form-label">Cédula *</label>
                            <input type="text" class="form-control" id="edit_recurso_operativo_cedula" name="recurso_operativo_cedula" required>
                            <div class="invalid-feedback">Por favor ingrese la cédula del usuario.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="edit_nombre" name="nombre" required>
                            <div class="invalid-feedback">Por favor ingrese el nombre del usuario.</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_id_roles" class="form-label">Rol *</label>
                            <select class="form-select" id="edit_id_roles" name="id_roles" required>
                                {% for id, rol in ROLES.items() %}
                                <option value="{{ id }}">{{ rol|title }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Por favor seleccione un rol.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_estado" class="form-label">Estado *</label>
                            <select class="form-select" id="edit_estado" name="estado" required>
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                            <div class="invalid-feedback">Por favor seleccione un estado.</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_cargo" class="form-label">Cargo</label>
                            <select class="form-select" id="edit_cargo" name="cargo">
                                <option value="">Seleccione un cargo</option>
                                <!-- Las opciones se cargarán dinámicamente desde /api/cargos -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="edit_password" name="password" placeholder="Dejar en blanco para mantener la actual">
                            <div class="form-text">Dejar en blanco para mantener la contraseña actual.</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_carpeta" class="form-label">Carpeta</label>
                            <select class="form-select" id="edit_carpeta" name="carpeta">
                                <option value="">Seleccione una carpeta</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_cliente" class="form-label">Cliente</label>
                            <select class="form-select" id="edit_cliente" name="cliente">
                                <option value="">Seleccione un cliente</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_ciudad" class="form-label">Ciudad</label>
                            <select class="form-select" id="edit_ciudad" name="ciudad">
                                <option value="">Seleccione una ciudad</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit_super" class="form-label">Super</label>
                            <select class="form-select" id="edit_super" name="super">
                                <option value="">Seleccione un super</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit_analista" class="form-label">Analista</label>
                            <select class="form-select" id="edit_analista" name="analista">
                                <option value="">Seleccione un analista</option>
                                <!-- Las opciones se cargarán dinámicamente desde /api/analistas -->
                            </select>
                            <div class="form-text">Analista asignado al técnico (solo para técnicos).</div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Los campos marcados con * son obligatorios.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarEdicionUsuario">
                    <i class="fas fa-save me-1"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear usuario -->
<div class="modal fade" id="crearUsuarioModal" tabindex="-1" aria-labelledby="crearUsuarioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="crearUsuarioModalLabel">Crear Nuevo Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Indicador de carga para creación -->
                <div id="loadingSpinnerCrear" class="text-center my-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                    <p class="mt-2">Procesando solicitud...</p>
                </div>
                
                <form id="formCrearUsuario" method="post" action="{{ url_for('create_user') }}" class="needs-validation" novalidate>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nuevo_recurso_operativo_cedula" class="form-label">Cédula *</label>
                            <input type="text" class="form-control" id="nuevo_recurso_operativo_cedula" name="recurso_operativo_cedula" required>
                            <div class="invalid-feedback">Por favor ingrese la cédula del usuario.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="nuevo_nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nuevo_nombre" name="nombre" required>
                            <div class="invalid-feedback">Por favor ingrese el nombre del usuario.</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nuevo_password" class="form-label">Contraseña *</label>
                            <input type="password" class="form-control" id="nuevo_password" name="password" required>
                            <div class="invalid-feedback">Por favor ingrese una contraseña.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="nuevo_id_roles" class="form-label">Rol *</label>
                            <select class="form-select" id="nuevo_id_roles" name="role_id" required>
                                {% for id, rol in ROLES.items() %}
                                <option value="{{ id }}">{{ rol|title }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">Por favor seleccione un rol.</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nuevo_estado" class="form-label">Estado</label>
                            <select class="form-select" id="nuevo_estado" name="estado">
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="nuevo_cargo" class="form-label">Cargo</label>
                            <select class="form-select" id="nuevo_cargo" name="cargo">
                                <option value="">Seleccione un cargo</option>
                                <option value="Administrador">Administrador</option>
                                <option value="ANALISTA">ANALISTA</option>
                                <option value="ANALISTA LOGISTICA">ANALISTA LOGISTICA</option>
                                <option value="CONDUCTOR">CONDUCTOR</option>
                                <option value="DESARROLLADOR">DESARROLLADOR</option>
                                <option value="TECNICO">TECNICO</option>
                                <option value="TECNICO CONDUCTOR">TECNICO CONDUCTOR</option>
                                <option value="TECNICO DE TELECOMUNICACIONES">TECNICO DE TELECOMUNICACIONES</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nuevo_carpeta" class="form-label">Carpeta</label>
                            <select class="form-select" id="nuevo_carpeta" name="carpeta">
                                <option value="">Seleccione una carpeta</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="nuevo_cliente" class="form-label">Cliente</label>
                            <select class="form-select" id="nuevo_cliente" name="cliente">
                                <option value="">Seleccione un cliente</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="nuevo_ciudad" class="form-label">Ciudad</label>
                            <select class="form-select" id="nuevo_ciudad" name="ciudad">
                                <option value="">Seleccione una ciudad</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="nuevo_super" class="form-label">Super</label>
                            <select class="form-select" id="nuevo_super" name="super">
                                <option value="">Seleccione un super</option>
                                <!-- Las opciones se cargarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Los campos marcados con * son obligatorios.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarNuevoUsuario">
                    <i class="fas fa-user-plus me-1"></i> Crear Usuario
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Agregar librería para exportar a Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    // Función para cargar las opciones de los dropdowns
    function cargarOpcionesUsuario() {
        return new Promise((resolve, reject) => {
            fetch('/obtener_opciones_usuario')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener opciones');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Opciones recibidas:', data); // Para depuración
                    
                    // Cargar opciones para carpetas
                    cargarOpciones('edit_carpeta', data.carpetas);
                    cargarOpciones('nuevo_carpeta', data.carpetas);
                    
                    // Cargar opciones para clientes
                    cargarOpciones('edit_cliente', data.clientes);
                    cargarOpciones('nuevo_cliente', data.clientes);
                    
                    // Cargar opciones para ciudades
                    cargarOpciones('edit_ciudad', data.ciudades);
                    cargarOpciones('nuevo_ciudad', data.ciudades);
                    
                    // Cargar opciones para super
                    cargarOpciones('edit_super', data.supers);
                    cargarOpciones('nuevo_super', data.supers);
                    
                    // Resolver la promesa cuando se completa la carga
                    resolve();
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarAlerta('Error al cargar las opciones: ' + error.message, 'danger');
                    reject(error);
                });
        });
    }
    
    // Función auxiliar para cargar opciones en un select
    function cargarOpciones(selectId, opciones) {
        const select = document.getElementById(selectId);
        // Mantener la primera opción (placeholder)
        const primeraOpcion = select.options[0];
        select.innerHTML = '';
        select.appendChild(primeraOpcion);
        
        // Agregar las opciones desde la API
        opciones.forEach(opcion => {
            const option = document.createElement('option');
            option.value = opcion;
            option.textContent = opcion;
            select.appendChild(option);
        });
    }
    
    // Función para cargar cargos desde la API
    function cargarCargos() {
        return new Promise((resolve, reject) => {
            fetch('/api/cargos')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener cargos: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Respuesta completa de cargos:', data); // Para depuración
                    
                    // Verificar que la respuesta sea exitosa y contenga cargos
                    if (!data.success) {
                        throw new Error(data.message || 'Error al obtener cargos');
                    }
                    
                    if (!data.cargos || !Array.isArray(data.cargos)) {
                        throw new Error('La respuesta no contiene un array de cargos válido');
                    }
                    
                    console.log('Cargos obtenidos:', data.cargos); // Para depuración
                    
                    // Cargar cargos en el select de filtro
                    const filtroCargoSelect = document.getElementById('filtroCargo');
                    if (filtroCargoSelect) {
                        // Mantener la opción "Todos los cargos"
                        const primeraOpcion = filtroCargoSelect.options[0];
                        filtroCargoSelect.innerHTML = '';
                        filtroCargoSelect.appendChild(primeraOpcion);
                        
                        // Agregar los cargos obtenidos
                        data.cargos.forEach(cargo => {
                            const option = document.createElement('option');
                            option.value = cargo;
                            option.textContent = cargo;
                            filtroCargoSelect.appendChild(option);
                        });
                    }
                    
                    // Cargar cargos en el select de edición
                    const editCargoSelect = document.getElementById('edit_cargo');
                    if (editCargoSelect) {
                        // Mantener la opción "Seleccione un cargo"
                        const primeraOpcion = editCargoSelect.options[0];
                        editCargoSelect.innerHTML = '';
                        editCargoSelect.appendChild(primeraOpcion);
                        
                        // Agregar los cargos obtenidos
                        data.cargos.forEach(cargo => {
                            const option = document.createElement('option');
                            option.value = cargo;
                            option.textContent = cargo;
                            editCargoSelect.appendChild(option);
                        });
                    }
                    
                    resolve();
                })
                .catch(error => {
                    console.error('Error al cargar cargos:', error);
                    mostrarAlerta('Error al cargar los cargos: ' + error.message, 'danger');
                    reject(error);
                });
        });
    }

    // Función para cargar analistas desde la API
    function cargarAnalistas() {
        return new Promise((resolve, reject) => {
            fetch('/api/analistas')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al obtener analistas: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Respuesta completa de analistas:', data); // Para depuración
                    
                    // Verificar que la respuesta sea exitosa y contenga analistas
                    if (!data.success) {
                        throw new Error(data.message || 'Error al obtener analistas');
                    }
                    
                    if (!data.analistas || !Array.isArray(data.analistas)) {
                        throw new Error('La respuesta no contiene un array de analistas válido');
                    }
                    
                    console.log('Analistas obtenidos:', data.analistas); // Para depuración
                    
                    // Cargar analistas en el select de edición
                    const editAnalistaSelect = document.getElementById('edit_analista');
                    if (editAnalistaSelect) {
                        // Mantener la opción "Seleccione un analista"
                        const primeraOpcion = editAnalistaSelect.options[0];
                        editAnalistaSelect.innerHTML = '';
                        editAnalistaSelect.appendChild(primeraOpcion);
                        
                        // Agregar los analistas obtenidos
                        data.analistas.forEach(analista => {
                            const option = document.createElement('option');
                            option.value = analista.nombre; // Usar el nombre como value para que coincida con el campo analista de la BD
                            option.textContent = `${analista.nombre} (${analista.recurso_operativo_cedula})`;
                            editAnalistaSelect.appendChild(option);
                        });
                    }
                    
                    resolve();
                })
                .catch(error => {
                    console.error('Error al cargar analistas:', error);
                    mostrarAlerta('Error al cargar los analistas: ' + error.message, 'danger');
                    reject(error);
                });
        });
    }
</script>

<script>
    // Función para mostrar alertas con animación mejorada
    function mostrarAlerta(mensaje, tipo) {
        // Crear elemento de alerta
        const alertaDiv = document.createElement('div');
        alertaDiv.className = `alert alert-${tipo} alert-dismissible fade show animate__animated animate__fadeInDown`;
        alertaDiv.setAttribute('role', 'alert');
        alertaDiv.style.position = 'fixed';
        alertaDiv.style.top = '20px';
        alertaDiv.style.left = '50%';
        alertaDiv.style.transform = 'translateX(-50%)';
        alertaDiv.style.zIndex = '9999';
        alertaDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        alertaDiv.style.minWidth = '300px';
        alertaDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'warning' ? 'exclamation-triangle' : tipo === 'danger' ? 'times-circle' : 'info-circle'} me-2"></i>
                <div>${mensaje}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insertar alerta en el body
        document.body.appendChild(alertaDiv);
        
        // Eliminar automáticamente después de 5 segundos
        setTimeout(() => {
            alertaDiv.classList.remove('show');
            alertaDiv.classList.add('animate__fadeOutUp');
            setTimeout(() => alertaDiv.remove(), 500);
        }, 5000);
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        // Cargar opciones para los dropdowns
        cargarOpcionesUsuario();
        
        // Cargar cargos dinámicamente
        cargarCargos();
        
        // Cargar analistas dinámicamente
        cargarAnalistas();
        
        // Variables para el contador de registros y paginación
        let totalRegistros = 0;
        let registrosFiltrados = 0;
        let filasFiltradas = [];
        let paginaActual = {{ current_page }};
        let itemsPorPagina = {{ items_per_page }};
        let totalPaginas = {{ total_pages }};
        
        // Inicializar contadores y paginación
        function inicializarContadores() {
            const filas = document.getElementById('tablaUsuarios').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            totalRegistros = filas.length;
            document.getElementById('totalRegistros').textContent = totalRegistros;
            
            // Inicializar filasFiltradas con todas las filas al principio
            filasFiltradas = Array.from(filas).filter(fila => fila.id !== 'mensajeNoResultados');
            registrosFiltrados = filasFiltradas.length;
            
            // Actualizar el total de páginas basado en los registros filtrados
            totalPaginas = Math.max(1, Math.ceil(registrosFiltrados / itemsPorPagina));
            document.getElementById('totalPaginas').textContent = totalPaginas;
            
            // Actualizar el contador de registros y la paginación
            document.getElementById('contadorRegistros').textContent = registrosFiltrados;
            document.getElementById('paginaActual').textContent = paginaActual;
            
            // Actualizar selector de páginas y botones
            actualizarSelectorPaginas();
            actualizarBotonesPaginacion();
            
            // Mostrar las filas correspondientes a la página actual
            mostrarPaginaActual();
        }
        
        // Actualizar contador de registros filtrados
        function actualizarContadorRegistros() {
            registrosFiltrados = filasFiltradas.length;
            document.getElementById('contadorRegistros').textContent = registrosFiltrados;
            
            // Cambiar el color del contador según la cantidad de registros
            const contadorElement = document.getElementById('contadorRegistros');
            if (registrosFiltrados === 0) {
                contadorElement.className = 'text-danger fw-bold';
            } else if (registrosFiltrados < totalRegistros) {
                contadorElement.className = 'text-warning fw-bold';
            } else {
                contadorElement.className = 'text-success fw-bold';
            }
        }
        
        // Actualizar el selector de páginas
        function actualizarSelectorPaginas() {
            const selector = document.getElementById('selectorPagina');
            selector.innerHTML = '';
            
            for (let i = 1; i <= totalPaginas; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = 'Página ' + i;
                selector.appendChild(option);
            }
            
            selector.value = paginaActual;
        }
        
        // Actualizar estado de los botones de paginación
        function actualizarBotonesPaginacion() {
            document.getElementById('btnPaginaAnterior').disabled = paginaActual <= 1;
            document.getElementById('btnPaginaSiguiente').disabled = paginaActual >= totalPaginas;
        }
        
        // Mostrar las filas correspondientes a la página actual
        function mostrarPaginaActual() {
            const filas = document.getElementById('tablaUsuarios').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = Math.min(inicio + itemsPorPagina, filasFiltradas.length);
            
            // Ocultar todas las filas primero
            for (let i = 0; i < filas.length; i++) {
                if (filas[i].id !== 'mensajeNoResultados') {
                    filas[i].style.display = 'none';
                }
            }
            
            // Mostrar solo las filas de la página actual
            for (let i = inicio; i < fin; i++) {
                filasFiltradas[i].style.display = '';
            }
        }
        
        // Filtrar usuarios (mejorado)
        window.filtrarUsuarios = function() {
            const busqueda = document.getElementById('buscarUsuario').value.toLowerCase();
            const rol = document.getElementById('filtroRol').value.toLowerCase();
            const estado = document.getElementById('filtroEstado').value;
            const cargo = document.getElementById('filtroCargo').value;
            
            const filas = document.getElementById('tablaUsuarios').getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            filasFiltradas = [];
            let coincidencias = 0;
            
            for (let i = 0; i < filas.length; i++) {
                if (filas[i].id === 'mensajeNoResultados') continue;
                
                let mostrar = true;
                const celdas = filas[i].getElementsByTagName('td');
                
                // Obtener datos de la fila
                const codigo = celdas[0].textContent.toLowerCase();
                const cedula = celdas[1].textContent.toLowerCase();
                const nombre = celdas[2].textContent.toLowerCase();
                const rolUsuario = celdas[3].textContent.toLowerCase();
                const estadoUsuario = celdas[4].textContent.trim();
                const cargoUsuario = celdas[5].textContent.trim(); // Ahora el cargo está en la columna 5
                
                // Filtrar por búsqueda (código, cédula o nombre)
                if (busqueda && !codigo.includes(busqueda) && !cedula.includes(busqueda) && !nombre.includes(busqueda)) {
                    mostrar = false;
                }
                
                // Filtrar por rol
                if (rol && !rolUsuario.toLowerCase().includes(rol)) {
                    mostrar = false;
                }
                
                // Filtrar por estado
                if (estado && !estadoUsuario.includes(estado)) {
                    mostrar = false;
                }
                
                // Filtrar por cargo
                if (cargo && cargoUsuario !== cargo) {
                    mostrar = false;
                }
                
                // Aplicar estilo a la fila y guardar referencia si coincide
                if (mostrar) {
                    filasFiltradas.push(filas[i]);
                    coincidencias++;
                    
                    // Resaltar términos de búsqueda si hay texto en el campo de búsqueda
                    if (busqueda) {
                        // Resaltar en código, cédula y nombre
                        resaltarTexto(celdas[0], busqueda);
                        resaltarTexto(celdas[1], busqueda);
                        resaltarTexto(celdas[2], busqueda);
                    } else {
                        // Restaurar texto original si no hay búsqueda
                        restaurarTextoOriginal(celdas[0]);
                        restaurarTextoOriginal(celdas[1]);
                        restaurarTextoOriginal(celdas[2]);
                    }
                }
            }
            
            // Resetear a la primera página cuando se aplica un filtro
            paginaActual = 1;
            
            // Actualizar el contador de registros
            registrosFiltrados = filasFiltradas.length;
            document.getElementById('contadorRegistros').textContent = registrosFiltrados;
            
            // Recalcular total de páginas basado en registros filtrados
            totalPaginas = Math.max(1, Math.ceil(registrosFiltrados / itemsPorPagina));
            document.getElementById('totalPaginas').textContent = totalPaginas;
            document.getElementById('paginaActual').textContent = paginaActual;
            
            // Actualizar selector de páginas
            actualizarSelectorPaginas();
            
            // Actualizar estado de los botones de paginación
            actualizarBotonesPaginacion();
            
            // Mostrar las filas correspondientes a la página actual
            mostrarPaginaActual();
            
            // Mostrar mensaje si no hay coincidencias
            const tablaBody = document.querySelector('#tablaUsuarios tbody');
            const mensajeNoResultados = document.getElementById('mensajeNoResultados');
            
            if (coincidencias === 0) {
                if (!mensajeNoResultados) {
                    const tr = document.createElement('tr');
                    tr.id = 'mensajeNoResultados';
                    tr.innerHTML = `<td colspan="7" class="text-center py-3">
                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No se encontraron usuarios que coincidan con los filtros aplicados.
                            <button class="btn btn-sm btn-outline-secondary ms-3" onclick="document.getElementById('btnLimpiarFiltros').click()">
                                <i class="fas fa-eraser me-1"></i>Limpiar filtros
                            </button>
                        </div>
                    </td>`;
                    tablaBody.appendChild(tr);
                }
            } else if (mensajeNoResultados) {
                mensajeNoResultados.remove();
            }
        };
        
        // Función para resaltar texto que coincide con la búsqueda
        function resaltarTexto(celda, busqueda) {
            if (!celda.hasAttribute('data-texto-original')) {
                celda.setAttribute('data-texto-original', celda.textContent);
            }
            
            const textoOriginal = celda.getAttribute('data-texto-original');
            const regex = new RegExp('(' + busqueda + ')', 'gi');
            celda.innerHTML = textoOriginal.replace(regex, '<span class="bg-warning text-dark">$1</span>');
        }
        
        // Función para restaurar el texto original
        function restaurarTextoOriginal(celda) {
            if (celda.hasAttribute('data-texto-original')) {
                celda.textContent = celda.getAttribute('data-texto-original');
            }
        }
        
        // Inicializar contadores y paginación al cargar la página
        inicializarContadores();
        filtrarUsuarios(); // Aplicar filtrado inicial para configurar filasFiltradas
        
        // Eventos para filtrado en tiempo real
        document.getElementById('buscarUsuario').addEventListener('input', filtrarUsuarios);
        document.getElementById('filtroRol').addEventListener('change', filtrarUsuarios);
        document.getElementById('filtroEstado').addEventListener('change', filtrarUsuarios);
        document.getElementById('filtroCargo').addEventListener('change', filtrarUsuarios);
        
        // Botón para limpiar filtros
        document.getElementById('btnLimpiarFiltros').addEventListener('click', function() {
            document.getElementById('buscarUsuario').value = '';
            document.getElementById('filtroRol').value = '';
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroCargo').value = '';
            filtrarUsuarios();
        });
        
        // Eventos para paginación
        document.getElementById('btnPaginaAnterior').addEventListener('click', function() {
            if (paginaActual > 1) {
                paginaActual--;
                document.getElementById('paginaActual').textContent = paginaActual;
                document.getElementById('selectorPagina').value = paginaActual;
                actualizarBotonesPaginacion();
                mostrarPaginaActual();
            }
        });
        
        document.getElementById('btnPaginaSiguiente').addEventListener('click', function() {
            if (paginaActual < totalPaginas) {
                paginaActual++;
                document.getElementById('paginaActual').textContent = paginaActual;
                document.getElementById('selectorPagina').value = paginaActual;
                actualizarBotonesPaginacion();
                mostrarPaginaActual();
            }
        });
        
        document.getElementById('selectorPagina').addEventListener('change', function() {
            paginaActual = parseInt(this.value);
            document.getElementById('paginaActual').textContent = paginaActual;
            actualizarBotonesPaginacion();
            mostrarPaginaActual();
        });
        
        // Inicializar tooltips de Bootstrap
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Añadir efecto de resaltado a las filas al pasar el mouse
        const filasTabla = document.querySelectorAll('#tablaUsuarios tbody tr');
        filasTabla.forEach(fila => {
            fila.addEventListener('mouseenter', function() {
                this.classList.add('table-active');
            });
            fila.addEventListener('mouseleave', function() {
                this.classList.remove('table-active');
            });
        });
        
        // Función para exportar tabla a Excel
        document.getElementById('btnExportarExcel').addEventListener('click', function() {
            // Mostrar indicador de carga
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Exportando...';
            this.disabled = true;
            
            setTimeout(() => {
                try {
                    // Crear un nuevo libro de trabajo
                    const wb = XLSX.utils.book_new();
                    const datos = [];
                    
                    // Obtener la tabla
                    const tabla = document.getElementById('tablaUsuarios');
                    
                    // Agregar encabezados
                    const encabezados = [];
                    tabla.querySelectorAll('thead th').forEach((th, index) => {
                        if (index !== 6) { // Excluir la columna de acciones
                            encabezados.push(th.textContent.trim());
                        }
                    });
                    datos.push(encabezados);
                    
                    // Agregar datos de todas las filas filtradas (no solo las visibles en la página actual)
                    filasFiltradas.forEach(fila => {
                        if (fila.id !== 'mensajeNoResultados') {
                            const filaDatos = [];
                            fila.querySelectorAll('td').forEach((celda, index) => {
                                // Para las celdas con badges, obtener solo el texto
                                if (index === 3 || index === 4) { // Columnas de rol y estado
                                    const badge = celda.querySelector('.badge');
                                    filaDatos.push(badge ? badge.textContent.trim() : celda.textContent.trim());
                                } else if (index !== 6) { // Excluir la columna de acciones
                                    filaDatos.push(celda.textContent.trim());
                                }
                            });
                            datos.push(filaDatos);
                        }
                    });
                    
                    // Crear hoja de cálculo
                    const ws = XLSX.utils.aoa_to_sheet(datos);
                    
                    // Añadir la hoja al libro
                    XLSX.utils.book_append_sheet(wb, ws, 'Usuarios');
                    
                    // Generar el archivo Excel
                    const fechaActual = new Date().toISOString().slice(0, 10);
                    
                    // Verificar si hay filtros aplicados
                    const busqueda = document.getElementById('buscarUsuario').value;
                    const rol = document.getElementById('filtroRol').value;
                    const estado = document.getElementById('filtroEstado').value;
                    const cargo = document.getElementById('filtroCargo').value;
                    
                    let nombreArchivo = `Usuarios_${fechaActual}`;
                    if (busqueda || rol || estado || cargo) {
                        nombreArchivo += '_Filtrado';
                    }
                    
                    XLSX.writeFile(wb, `${nombreArchivo}.xlsx`);
                    
                    // Mostrar mensaje de éxito con información sobre los registros exportados
                    mostrarAlerta(`Se han exportado ${datos.length - 1} registros a Excel`, 'success');
                } catch (error) {
                    console.error('Error al exportar a Excel:', error);
                    mostrarAlerta('Error al exportar la tabla a Excel', 'danger');
                } finally {
                    // Restaurar el botón
                    this.innerHTML = '<i class="fas fa-file-excel me-1"></i> Exportar a Excel';
                    this.disabled = false;
                }
            }, 500); // Pequeño retraso para mostrar la animación
        });
        
        // Editar usuario
        document.querySelectorAll('.editar-usuario').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var id = this.getAttribute('data-id');
                obtenerUsuario(id);
            });
        });
        
        // Eliminar usuario
        document.querySelectorAll('.eliminar-usuario').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var id = this.getAttribute('data-id');
                var cedula = this.getAttribute('data-cedula');
                if (confirm('¿Está seguro que desea eliminar el usuario con cédula ' + cedula + '?')) {
                    eliminarUsuario(id);
                }
            });
        });
        
        // Guardar edición
        document.getElementById('btnGuardarEdicionUsuario').addEventListener('click', function() {
            // Validar el formulario antes de enviar
            const form = document.getElementById('formEditarUsuario');
            if (form.checkValidity()) {
                // Mostrar indicador de carga
                const btnGuardar = document.getElementById('btnGuardarEdicionUsuario');
                const textoOriginal = btnGuardar.innerHTML;
                btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';
                btnGuardar.disabled = true;
                
                // Recopilar datos del formulario
                const formData = new FormData(form);
                
                // Si la contraseña está vacía, eliminarla del formData para no actualizarla
                if (formData.get('password') === '') {
                    formData.delete('password');
                }
                
                // Enviar datos mediante fetch en lugar de submit normal
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostrar mensaje de éxito
                        mostrarAlerta('Usuario actualizado correctamente', 'success');
                        // Cerrar el modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editarUsuarioModal'));
                        modal.hide();
                        // Recargar la página para mostrar los cambios
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        // Mostrar mensaje de error
                        mostrarAlerta('Error al actualizar usuario: ' + data.message, 'danger');
                        btnGuardar.innerHTML = textoOriginal;
                        btnGuardar.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error al actualizar usuario:', error);
                    mostrarAlerta('Error al actualizar usuario', 'danger');
                    btnGuardar.innerHTML = textoOriginal;
                    btnGuardar.disabled = false;
                });
            } else {
                // Mostrar validaciones del formulario
                form.classList.add('was-validated');
            }
        });
        
        // Guardar nuevo usuario
        document.getElementById('btnGuardarNuevoUsuario').addEventListener('click', function() {
            // Validar el formulario antes de enviar
            const form = document.getElementById('formCrearUsuario');
            if (form.checkValidity()) {
                // Mostrar indicador de carga
                const btnGuardar = document.getElementById('btnGuardarNuevoUsuario');
                const textoOriginal = btnGuardar.innerHTML;
                btnGuardar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creando...';
                btnGuardar.disabled = true;
                
                // Recopilar datos del formulario
                const formData = new FormData(form);
                
                // Enviar datos mediante fetch en lugar de submit normal
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostrar mensaje de éxito
                        mostrarAlerta('Usuario creado correctamente', 'success');
                        // Cerrar el modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('crearUsuarioModal'));
                        modal.hide();
                        // Recargar la página para mostrar los cambios
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        // Mostrar mensaje de error
                        mostrarAlerta('Error al crear usuario: ' + data.message, 'danger');
                        btnGuardar.innerHTML = textoOriginal;
                        btnGuardar.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error al crear usuario:', error);
                    mostrarAlerta('Error al crear usuario', 'danger');
                    btnGuardar.innerHTML = textoOriginal;
                    btnGuardar.disabled = false;
                });
            } else {
                // Mostrar validaciones del formulario
                form.classList.add('was-validated');
            }
        });
    });
    
    function obtenerUsuario(id) {
        // Mostrar indicador de carga
        document.getElementById('loadingSpinner').classList.remove('d-none');
        console.log('Obteniendo usuario con ID:', id); // Para depuración
        
        // Función para establecer el valor seleccionado en un dropdown
        function establecerValorDropdown(selectId, valor) {
            if (valor) {
                const select = document.getElementById(selectId);
                console.log(`Estableciendo ${valor} en ${selectId}, opciones disponibles:`, select.options.length); // Para depuración
                for (let i = 0; i < select.options.length; i++) {
                    if (select.options[i].value === valor) {
                        select.selectedIndex = i;
                        console.log(`Valor ${valor} encontrado en índice ${i}`); // Para depuración
                        break;
                    }
                }
            }
        }
        
        // Primero cargar las opciones para los dropdowns
        Promise.all([cargarOpcionesUsuario(), cargarAnalistas()])
            .then(() => {
                console.log('Opciones y analistas cargados correctamente, obteniendo datos del usuario'); // Para depuración
                // Luego obtener los datos del usuario
                return fetch('/obtener_usuario/' + id);
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data); // Para depuración
                
                // Llenar el formulario con los datos recibidos
                document.getElementById('edit_id_codigo_consumidor').value = data.id_codigo_consumidor;
                document.getElementById('edit_recurso_operativo_cedula').value = data.recurso_operativo_cedula;
                document.getElementById('edit_nombre').value = data.nombre;
                document.getElementById('edit_id_roles').value = data.id_roles;
                document.getElementById('edit_estado').value = data.estado;
                
                // Llenar los nuevos campos si existen en la respuesta
                if (data.cargo) {
                    // Seleccionar el cargo en el dropdown
                    const cargoSelect = document.getElementById('edit_cargo');
                    // Buscar la opción que coincida con el cargo del usuario
                    for (let i = 0; i < cargoSelect.options.length; i++) {
                        if (cargoSelect.options[i].value === data.cargo) {
                            cargoSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
                
                // Establecer los valores en los dropdowns
                establecerValorDropdown('edit_carpeta', data.carpeta);
                establecerValorDropdown('edit_cliente', data.cliente);
                establecerValorDropdown('edit_ciudad', data.ciudad);
                establecerValorDropdown('edit_super', data.super);
                establecerValorDropdown('edit_analista', data.analista);
                
                // Limpiar el campo de contraseña ya que no se muestra por seguridad
                document.getElementById('edit_password').value = '';
                
                // Ocultar indicador de carga
                document.getElementById('loadingSpinner').classList.add('d-none');
                
                // Mostrar el modal
                var modal = new bootstrap.Modal(document.getElementById('editarUsuarioModal'));
                modal.show();
            })
            .catch(error => {
                console.error('Error en el proceso:', error);
                mostrarAlerta('Error: ' + error.message, 'danger');
                document.getElementById('loadingSpinner').classList.add('d-none');
            });
    }
    
    function eliminarUsuario(id) {
        // Mostrar indicador de carga en el botón de eliminar
        const btnEliminar = document.querySelector(`.eliminar-usuario[data-id="${id}"]`);
        const iconoOriginal = btnEliminar.innerHTML;
        btnEliminar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        btnEliminar.disabled = true;
        
        fetch('/eliminar_usuario/' + id, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Error en la respuesta del servidor: ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito
                mostrarAlerta('Usuario eliminado correctamente', 'success');
                // Recargar la página después de un breve retraso
                setTimeout(() => location.reload(), 1500);
            } else {
                // Mostrar mensaje de error
                mostrarAlerta('Error al eliminar usuario: ' + data.message, 'danger');
                btnEliminar.innerHTML = iconoOriginal;
                btnEliminar.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error al eliminar usuario:', error);
            mostrarAlerta('Error al eliminar usuario: ' + error.message, 'danger');
            btnEliminar.innerHTML = iconoOriginal;
            btnEliminar.disabled = false;
        });
    }
</script>
{% endblock %}