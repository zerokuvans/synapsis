{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #1e293b 0%, #1e293b 100%) !important;">
          <h3 class="mb-0">
            <i class="fas fa-shield-halved me-2"></i>Sistema de Gestión Integrado de Seguridad (SGIS)
          </h3>
        </div>
        <div class="card-body">
          <style>
            .sgis-section{border:1px solid #e5e7eb; border-radius:.5rem; padding:1rem}
            .sgis-section.nc{border-color:#dc2626; box-shadow:0 0 0 .15rem rgba(220,38,38,.15)}
            .badge-nc{display:inline-block; color:#dc2626}
          </style>
          {% if session.get('user_role') == 'administrativo' %}
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card bg-primary text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h4 id="sgis-total-preop">0</h4>
                      <p class="mb-0">Pre-operacionales hoy</p>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-clipboard-check fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-success text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h4 id="sgis-epp-ok">0</h4>
                      <p class="mb-0">EPP en buen estado</p>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-hard-hat fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-warning text-dark">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h4 id="sgis-epp-alertas">0</h4>
                      <p class="mb-0">Alertas EPP</p>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-info text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h4 id="sgis-reportes">0</h4>
                      <p class="mb-0">Reportes generados</p>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-chart-bar fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          {% if session.get('user_role') in ['tecnicos', 'operativo', 'sstt', 'SSTT', 'tecnico', 'Tecnico'] %}
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="fas fa-wrench me-2"></i>Técnicos</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button id="btnPreop" type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalPreop">
                      <i class="fas fa-hard-hat me-2"></i>Pre-operacional de EPP
                    </button>
                    <button id="btnPreopEsc" type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalEscaleras" {% if not habilitar_escaleras %}disabled title="Disponible para APOYO CAMIONETAS, CONDUCTOR y TECNICO CONDUCTOR"{% endif %}>
                      <i class="fas fa-stairs me-2"></i>Pre-operacional de Escaleras
                    </button>
                    <button id="btnTSR" type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#modalTSR">
                      <i class="fas fa-clipboard-list me-2"></i>Trabajo Seguro Rutinario
                    </button>
                    <button id="btnPreopCaidas" type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalCaidas">
                      <i class="fas fa-user-shield me-2"></i>Pre-operacional Control Caídas
                    </button>
                    <button id="btnPermisoTrabajo" type="button" class="btn btn-outline-dark" data-bs-toggle="modal" data-bs-target="#permisoTrabajoModal">
                      <i class="fas fa-file-signature me-2"></i>Permiso de Trabajo
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% elif session.get('user_role') == 'administrativo' %}
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Administrativo</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <a href="/sgis/reportes" class="btn btn-outline-success">
                      <i class="fas fa-chart-line me-2"></i>Reportes SGIS
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="permisoTrabajoModal" tabindex="-1" aria-labelledby="permisoTrabajoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="permisoTrabajoModalLabel">Permiso de Trabajo SGIS</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="permisoTrabajoAlert" class="mb-3" style="display:none"></div>
        <form id="permisoTrabajoForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Supervisor</label>
              <input type="text" class="form-control" id="emitido_por" value="{{ ro_info.super or '' }}" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Proyecto</label>
              <input type="text" class="form-control" id="proyecto" value="{{ ro_info.cliente or '' }}" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Ciudad</label>
              <input type="text" class="form-control" id="ciudad_permiso" value="{{ ro_info.ciudad or '' }}" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Responsable</label>
              <input type="text" class="form-control" id="responsable_trabajo" value="{{ ro_info.nombre or '' }}" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Cargo</label>
              <input type="text" class="form-control" id="cargo_resp" value="{{ ro_info.cargo or '' }}" readonly>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Cédula</label>
              <input type="text" class="form-control" id="cedula_resp" value="{{ ro_info.recurso_operativo_cedula or '' }}" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Trabajo a ejecutar</label>
              <input type="text" class="form-control" id="trabajo_ejecutar">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Herramienta</label>
              <input type="text" class="form-control" id="herramienta">
            </div>
            <div class="col-12 mb-3">
              <label class="form-label">Descripción de la tarea</label>
              <textarea class="form-control" id="descripcion_tarea" rows="3"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col-12"><hr></div>
            <div class="col-12">
              <div class="accordion" id="sgisPermisoAccordion">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="accHerr">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseHerr" aria-expanded="false" aria-controls="collapseHerr">Verificación de herramientas</button>
                  </h2>
                  <div id="collapseHerr" class="accordion-collapse collapse" aria-labelledby="accHerr" data-bs-parent="#sgisPermisoAccordion">
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-4 mb-3">
                          <label class="form-label">Herramienta eléctrica/mecánica</label>
                          <select class="form-select" id="sgis_permiso_trabajo_herramienta_electrica"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select>
                        </div>
                        <div class="col-md-4 mb-3">
                          <label class="form-label">Herramienta manual</label>
                          <select class="form-select" id="sgis_permiso_trabajo_herramienta_manual"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select>
                        </div>
                        <div class="col-md-4 mb-3">
                          <label class="form-label">Equipos Alturas</label>
                          <select class="form-select" id="sgis_permiso_trabajo_equipos_alturas"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select>
                        </div>
                        <div class="col-12 mb-3">
                          <label class="form-label">Otros (especifique)</label>
                          <input type="text" class="form-control" id="sgis_permiso_trabajo_otros_herramientas">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="accCond">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCond" aria-expanded="false" aria-controls="collapseCond">Condiciones en el área de trabajo</button>
                  </h2>
                  <div id="collapseCond" class="accordion-collapse collapse" aria-labelledby="accCond" data-bs-parent="#sgisPermisoAccordion">
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Iluminación</label><select class="form-select" id="sgis_permiso_trabajo_iluminacion"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Vectores/Animales</label><select class="form-select" id="sgis_permiso_trabajo_animales"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Izaje de cargas</label><select class="form-select" id="sgis_permiso_trabajo_izaje_alturas"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Obstáculos evacuación</label><select class="form-select" id="sgis_permiso_trabajo_obstaculos_evacuacion"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Tránsito de vehículos</label><select class="form-select" id="sgis_permiso_trabajo_vehiculos_area"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Trabajos en altura</label><select class="form-select" id="sgis_permiso_trabajo_trabajo_alturas"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Piso húmedo</label><select class="form-select" id="sgis_permiso_trabajo_trabajo_piso_humedo"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Energías peligrosas</label><select class="form-select" id="sgis_permiso_trabajo_manejo_energia_peligrosa"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Trabajo manual</label><select class="form-select" id="sgis_permiso_trabajo_trabajo_manual"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Caída de objetos</label><select class="form-select" id="sgis_permiso_trabajo_caida_objetos"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-12 mb-3"><label class="form-label">Otros (especifique)</label><input type="text" class="form-control" id="sgis_permiso_trabajo_otros_area"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="accPeligros">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePeligros" aria-expanded="false" aria-controls="collapsePeligros">Identificación de peligros</button>
                  </h2>
                  <div id="collapsePeligros" class="accordion-collapse collapse" aria-labelledby="accPeligros" data-bs-parent="#sgisPermisoAccordion">
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Proyección de partículas</label><select class="form-select" id="sgis_permiso_trabajo_proyeccion_particulas"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Caídas menores a 2 m</label><select class="form-select" id="sgis_permiso_trabajo_caidas_menor_2m"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Caídas mayores a 2 m</label><select class="form-select" id="sgis_permiso_trabajo_caidas_mayor_2m"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Acceso en mal estado</label><select class="form-select" id="sgis_permiso_trabajo_acceso_mal_estado"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Levantamiento carga mecánico</label><select class="form-select" id="sgis_permiso_trabajo_levantamiento_carga_mecanica"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Condiciones climáticas</label><select class="form-select" id="sgis_permiso_trabajo_condicion_clima"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Qué condiciones climáticas</label><input type="text" class="form-control" id="sgis_permiso_trabajo_clima"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Proximidad red energizada (Dist. Min)</label><select class="form-select" id="sgis_permiso_trabajo_proxi_red_energizasa"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Qué red energizada y proximidad</label><input type="text" class="form-control" id="sgis_permiso_trabajo_proxi_red"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Vibraciones</label><select class="form-select" id="sgis_permiso_trabajo_vibraciones"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Contacto eléctrico</label><select class="form-select" id="sgis_permiso_trabajo_contacto_electrico"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Atrapamiento</label><select class="form-select" id="sgis_permiso_trabajo_atrapamiento"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Cables expuestos</label><select class="form-select" id="sgis_permiso_trabajo_cable_expuesto"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Corte no visible</label><select class="form-select" id="sgis_permiso_trabajo_corte_no_visible"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Atmósfera explosiva</label><select class="form-select" id="sgis_permiso_trabajo_atmosfera_explosiva"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Fuentes de ignición</label><select class="form-select" id="sgis_permiso_trabajo_fuentes_ignicion"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Vapores/emisiones/polvo</label><select class="form-select" id="sgis_permiso_trabajo_vapores"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Altas temperaturas</label><select class="form-select" id="sgis_permiso_trabajo_alta_temperatura"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Bajas temperaturas</label><select class="form-select" id="sgis_permiso_trabajo_baja_temperatura"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Deficiencias de iluminación</label><select class="form-select" id="sgis_permiso_trabajo_iluminacion_deficiente"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Quemaduras</label><select class="form-select" id="sgis_permiso_trabajo_quemaduras"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Almacenamiento de químicos</label><select class="form-select" id="sgis_permiso_trabajo_almacenamientos_quimicos"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Extensiones en mal estado</label><select class="form-select" id="sgis_permiso_trabajo_extensiones_mal_estado"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Ruido</label><select class="form-select" id="sgis_permiso_trabajo_ruido"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Contacto directo/indirecto</label><select class="form-select" id="sgis_permiso_trabajo_contacto_directo_indirecto"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Caída de objetos</label><select class="form-select" id="sgis_permiso_trabajo_caida_objeto"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Espacio reducido</label><select class="form-select" id="sgis_permiso_trabajo_espacio_reducido"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Levantamiento manual de cargas</label><select class="form-select" id="sgis_permiso_trabajo_levantamiento_manual_cargas"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Subestación inundada</label><select class="form-select" id="sgis_permiso_trabajo_subestacion_inundada"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Excavaciones</label><select class="form-select" id="sgis_permiso_trabajo_excavaciones"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-12 mb-3"><label class="form-label">Otros peligros (especifique)</label><input type="text" class="form-control" id="sgis_permiso_trabajo_otros"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="accEpp">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEpp" aria-expanded="false" aria-controls="collapseEpp">Elementos de protección requeridos</button>
                  </h2>
                  <div id="collapseEpp" class="accordion-collapse collapse" aria-labelledby="accEpp" data-bs-parent="#sgisPermisoAccordion">
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Calzado dieléctrico</label><select class="form-select" id="sgis_permiso_trabajo_calzado_dielectrico"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Guantes de Nitrilo</label><select class="form-select" id="sgis_permiso_trabajo_guantes_nitrilo"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Guantes de Vaqueta</label><select class="form-select" id="sgis_permiso_trabajo_guantes_vaqueta"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Gafas de protección</label><select class="form-select" id="sgis_permiso_trabajo_gafas_proteccion"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Casco dieléctrico + Barbuquejo</label><select class="form-select" id="sgis_permiso_trabajo_casco_dielectrico"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Tie Off</label><select class="form-select" id="sgis_permiso_trabajo_tie_off"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Mosquetón</label><select class="form-select" id="sgis_permiso_trabajo_mosqueton"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Eslinga</label><select class="form-select" id="sgis_permiso_trabajo_eslinga"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Arrestador</label><select class="form-select" id="sgis_permiso_trabajo_arrestador"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Arnés de seguridad</label><select class="form-select" id="sgis_permiso_trabajo_arnes"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Línea de vida</label><select class="form-select" id="sgis_permiso_trabajo_linea_vida"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Escalera tipo tijera</label><select class="form-select" id="sgis_permiso_trabajo_escalera_tijera"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Escalera extensible</label><select class="form-select" id="sgis_permiso_trabajo_escalera_extensible"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Cinta de precaución</label><select class="form-select" id="sgis_permiso_trabajo_cinta_precaucion"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Conos</label><select class="form-select" id="sgis_permiso_trabajo_conos"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Botiquín</label><select class="form-select" id="sgis_permiso_trabajo_botiquin"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="accComunicacion">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseComunicacion" aria-expanded="false" aria-controls="collapseComunicacion">Comunicación de riesgos</button>
                  </h2>
                  <div id="collapseComunicacion" class="accordion-collapse collapse" aria-labelledby="accComunicacion" data-bs-parent="#sgisPermisoAccordion">
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-4 mb-3"><label class="form-label">Notificación del trabajo</label><select class="form-select" id="sgis_permiso_trabajo_notificacion_trabajo"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Responsabilidades del permiso</label><select class="form-select" id="sgis_permiso_trabajo_responsabilidades_permiso"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Condiciones para interrumpir</label><select class="form-select" id="sgis_permiso_trabajo_condicion_interrupcion"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Cambios que afectan seguridad</label><select class="form-select" id="sgis_permiso_trabajo_cambios_seguridad_trabajo"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Inducción de seguridad</label><select class="form-select" id="sgis_permiso_trabajo_induccion_seguridad"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Capacitación en el tema</label><select class="form-select" id="sgis_permiso_trabajo_capacitacion_tema"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Métodos de inspección</label><select class="form-select" id="sgis_permiso_trabajo_metodos_inspeccion"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Responsables del área</label><select class="form-select" id="sgis_permiso_trabajo_responsables_area"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Mecanismos de control</label><select class="form-select" id="sgis_permiso_trabajo_mecanismo_control_riesgo"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Alarmas y puntos de reunión</label><select class="form-select" id="sgis_permiso_trabajo_alarmas_puntos_reunion"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Ubicación equipos contra incendios</label><select class="form-select" id="sgis_permiso_trabajo_ubicacion_equipos_incendio"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Riesgos del trabajo y área</label><select class="form-select" id="sgis_permiso_trabajo_riesgos_trabajo_area"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                        <div class="col-md-4 mb-3"><label class="form-label">Impacto ambiental</label><select class="form-select" id="sgis_permiso_trabajo_impacto_ambiental"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="accDocumentacion">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDocumentacion" aria-expanded="false" aria-controls="collapseDocumentacion">Verificación de documentación</button>
                  </h2>
                  <div id="collapseDocumentacion" class="accordion-collapse collapse" aria-labelledby="accDocumentacion" data-bs-parent="#sgisPermisoAccordion">
                    <div class="accordion-body">
                      <div class="row">
                        <div class="col-md-3 mb-3"><label class="form-label">ATS diligenciado</label><select class="form-select" id="sgis_permiso_trabajo_ats"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Inspecciones realizadas</label><select class="form-select" id="sgis_permiso_trabajo_inspecciones_relizadas"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Procedimientos de trabajo</label><select class="form-select" id="sgis_permiso_trabajo_procedimientos_trabajo"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-3 mb-3"><label class="form-label">Afiliación ARL/AFP/EPS</label><select class="form-select" id="sgis_permiso_trabajo_arl_afp_eps"><option value="">Seleccione</option><option value="C">C</option><option value="NC">NC</option><option value="NA">NA</option></select></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Espacios confinados</label><select class="form-select" id="sgis_permiso_trabajo_confinado_aplica"><option value="">Seleccione</option><option value="APLICA">APLICA</option><option value="NO_APLICA">NO_APLICA</option></select></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Trabajos en altura</label><select class="form-select" id="sgis_permiso_trabajo_altura_aplica"><option value="">Seleccione</option><option value="APLICA">APLICA</option><option value="NO_APLICA">NO_APLICA</option></select></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-12" id="secConfinado" style="display:none">
              <hr>
              <div class="mb-2"><strong>Espacios Confinados</strong></div>
              <div class="row">
                <div class="col-md-4 mb-3"><label class="form-label">El sitio está aislado de energía</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_1" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_1" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_1" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Ventilación adecuada u operando</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_2" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_2" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_2" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Vigilancia y comunicación permanente</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_3" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_3" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_3" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Iluminación suficiente/antiexplosiva</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_4" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_4" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_4" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Equipos de acceso en buen estado</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_5" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_5" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_5" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Procedimiento de rescate conocido</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_6" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_6" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_6" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Se requieren 2 o más trabajadores</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_7" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_7" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_7" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Cortar suministro de sustancias</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_8" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_8" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_8" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Cortar energía eléctrica</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_9" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_9" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_9" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Trabajador consciente de riesgos</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_10" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_confinado_10" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_confinado_10" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Condiciones de trabajo/salud adecuadas</label><select class="form-select" id="sgis_permiso_trabajo_historial_confinado_11"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                <div class="col-md-4 mb-3 d-none"><label class="form-label">Fecha</label><input type="date" class="form-control" id="sgis_permiso_trabajo_historial_confinado_fecha" readonly></div>
                <div class="col-md-4 mb-3 d-none"><label class="form-label">Firma técnico</label><input type="text" class="form-control" id="sgis_permiso_trabajo_historial_confinado_firma_tecnico" readonly></div>
                <div class="col-md-4 mb-3 d-none"><label class="form-label">Firma supervisor</label><input type="text" class="form-control" id="sgis_permiso_trabajo_historial_confinado_firma_supervisor"></div>
                <div class="col-12 mb-3"><button type="button" class="btn btn-outline-dark" id="guardarHistorialConfinado">Guardar Espacios Confinados</button></div>
              </div>
            </div>
            <div class="col-12" id="secAltura" style="display:none">
              <hr>
              <div class="mb-2"><strong>Trabajos en Altura</strong></div>
              <div class="row">
                <div class="col-md-6 mb-3"><label class="form-label">Altura aproximada del trabajo</label><input type="text" class="form-control" id="sgis_permiso_trabajo_historial_altura_1"></div>
                <div class="col-md-6 mb-3 d-none"><label class="form-label">Fecha</label><input type="date" class="form-control" id="sgis_permiso_trabajo_historial_altura_fecha" readonly></div>
                <div class="col-md-4 mb-3"><label class="form-label">Señalizar y aislar la zona</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_2" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_2" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_2" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Área libre de obstáculos</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_3" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_3" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_3" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Procedimiento de trabajo seguro</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_4" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_4" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_4" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">EPCC en buenas condiciones</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_5" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_5" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_5" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Personal apto y capacitado</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_6" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_6" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_6" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Arnés en óptimas condiciones</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_7" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_7" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_7" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Línea de vida/eslinga óptima</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_8" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_8" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_8" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Absorbedor de energía aplica</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_9" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_9" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_9" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Anclaje distinto a estructura soporte</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_10" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_10" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_10" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Conector en buen estado</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_11" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_11" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_11" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Conexión a punto de anclaje</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_12" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_12" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_12" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Sistemas de acceso verificados</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_13" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_13" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_13" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Andamio apto</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_14" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_14" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_14" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Escalera apta</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_15" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_15" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_15" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Línea de vida adicional</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_16" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_16" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_16" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Herramientas/materiales asegurados</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_17" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_17" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_17" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Proximidad a puntos de energía analizada</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_18" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_18" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_18" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Se verifican las condiciones ambientales (lluvía, velocidad del viento, iluminación).</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_19" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_19" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_19" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">¿El punto de anclaje está en una posición segura para evitar golpes contra estructuras?</label><select class="form-select" id="sgis_permiso_trabajo_historial_altura_20"><option value="">Seleccione</option><option value="SI">SI</option><option value="NO">NO</option></select></div>
                <div class="col-md-4 mb-3"><label class="form-label">Se elaboró el procedimiento escrito para el rescate.</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_21" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_21" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_21" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Se cuenta con Brigadista que active el procedimiento de rescate.</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_22" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_22" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_22" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">Se realizó el análisis de riesgos y se verificó el cumplimiento de los controles.</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_23" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_23" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_23" value="NA"> N/A</label></div></div>
                <div class="col-md-4 mb-3"><label class="form-label">En general, ¿las condiciones de trabajo y salud del personal son adecuadas para la labor?</label><div><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_24" value="C"> C</label><label class="me-2"><input type="radio" name="sgis_permiso_trabajo_historial_altura_24" value="NC"> NC</label><label><input type="radio" name="sgis_permiso_trabajo_historial_altura_24" value="NA"> N/A</label></div></div>
                <div class="col-md-6 mb-3 d-none"><label class="form-label">Firma técnico</label><input type="text" class="form-control" id="sgis_permiso_trabajo_historial_semanal_altura_firma_tecnico" readonly></div>
                <div class="col-md-6 mb-3 d-none"><label class="form-label">Firma supervisor</label><input type="text" class="form-control" id="sgis_permiso_trabajo_historial_semanal_altura_firma_supervisor"></div>
                <div class="col-12 mb-3"><button type="button" class="btn btn-outline-dark" id="guardarHistorialAltura">Guardar Trabajos en Altura</button></div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-dark" id="guardarPermisoTrabajo">Guardar</button>
      </div>
    </div>
  </div>
 </div>

<script>
const TRI_FIELDS=['sgis_permiso_trabajo_herramienta_electrica','sgis_permiso_trabajo_herramienta_manual','sgis_permiso_trabajo_equipos_alturas','sgis_permiso_trabajo_iluminacion','sgis_permiso_trabajo_animales','sgis_permiso_trabajo_izaje_alturas','sgis_permiso_trabajo_obstaculos_evacuacion','sgis_permiso_trabajo_vehiculos_area','sgis_permiso_trabajo_trabajo_alturas','sgis_permiso_trabajo_trabajo_piso_humedo','sgis_permiso_trabajo_manejo_energia_peligrosa','sgis_permiso_trabajo_trabajo_manual','sgis_permiso_trabajo_caida_objetos','sgis_permiso_trabajo_proyeccion_particulas','sgis_permiso_trabajo_caidas_menor_2m','sgis_permiso_trabajo_caidas_mayor_2m','sgis_permiso_trabajo_acceso_mal_estado','sgis_permiso_trabajo_levantamiento_carga_mecanica','sgis_permiso_trabajo_condicion_clima','sgis_permiso_trabajo_proxi_red_energizasa','sgis_permiso_trabajo_vibraciones','sgis_permiso_trabajo_contacto_electrico','sgis_permiso_trabajo_atrapamiento','sgis_permiso_trabajo_cable_expuesto','sgis_permiso_trabajo_corte_no_visible','sgis_permiso_trabajo_atmosfera_explosiva','sgis_permiso_trabajo_fuentes_ignicion','sgis_permiso_trabajo_vapores','sgis_permiso_trabajo_alta_temperatura','sgis_permiso_trabajo_baja_temperatura','sgis_permiso_trabajo_iluminacion_deficiente','sgis_permiso_trabajo_quemaduras','sgis_permiso_trabajo_almacenamientos_quimicos','sgis_permiso_trabajo_extensiones_mal_estado','sgis_permiso_trabajo_ruido','sgis_permiso_trabajo_contacto_directo_indirecto','sgis_permiso_trabajo_caida_objeto','sgis_permiso_trabajo_espacio_reducido','sgis_permiso_trabajo_levantamiento_manual_cargas','sgis_permiso_trabajo_subestacion_inundada','sgis_permiso_trabajo_excavaciones','sgis_permiso_trabajo_calzado_dielectrico','sgis_permiso_trabajo_guantes_nitrilo','sgis_permiso_trabajo_guantes_vaqueta','sgis_permiso_trabajo_gafas_proteccion','sgis_permiso_trabajo_casco_dielectrico','sgis_permiso_trabajo_tie_off','sgis_permiso_trabajo_mosqueton','sgis_permiso_trabajo_eslinga','sgis_permiso_trabajo_arrestador','sgis_permiso_trabajo_arnes','sgis_permiso_trabajo_linea_vida','sgis_permiso_trabajo_escalera_tijera','sgis_permiso_trabajo_escalera_extensible','sgis_permiso_trabajo_cinta_precaucion','sgis_permiso_trabajo_conos','sgis_permiso_trabajo_botiquin','sgis_permiso_trabajo_ats','sgis_permiso_trabajo_inspecciones_relizadas','sgis_permiso_trabajo_procedimientos_trabajo','sgis_permiso_trabajo_arl_afp_eps'];
const YN_FIELDS=['sgis_permiso_trabajo_notificacion_trabajo','sgis_permiso_trabajo_responsabilidades_permiso','sgis_permiso_trabajo_condicion_interrupcion','sgis_permiso_trabajo_cambios_seguridad_trabajo','sgis_permiso_trabajo_induccion_seguridad','sgis_permiso_trabajo_capacitacion_tema','sgis_permiso_trabajo_metodos_inspeccion','sgis_permiso_trabajo_responsables_area','sgis_permiso_trabajo_mecanismo_control_riesgo','sgis_permiso_trabajo_alarmas_puntos_reunion','sgis_permiso_trabajo_ubicacion_equipos_incendio','sgis_permiso_trabajo_riesgos_trabajo_area','sgis_permiso_trabajo_impacto_ambiental'];
const TEXT_FIELDS=['sgis_permiso_trabajo_otros_herramientas','sgis_permiso_trabajo_otros_area','sgis_permiso_trabajo_clima','sgis_permiso_trabajo_proxi_red','sgis_permiso_trabajo_otros'];
const AP_FIELDS=['sgis_permiso_trabajo_confinado_aplica','sgis_permiso_trabajo_altura_aplica'];
let currentPermisoId=null;
function getTri(id){var rs=document.querySelectorAll('input[name="'+id+'"]');for(var i=0;i<rs.length;i++){if(rs[i].checked)return rs[i].value;}return ''}
function setTri(id,val){var v=(val||'').toUpperCase();var rs=document.querySelectorAll('input[name="'+id+'"]');for(var i=0;i<rs.length;i++){rs[i].checked=(rs[i].value===v)}}
function renderTriAsRadios(id){var sel=document.getElementById(id);if(!sel)return;var parent=sel.parentNode;var name=id;var v=(sel.value||'').toUpperCase();var div=document.createElement('div');div.innerHTML='<label class="me-2"><input type="radio" name="'+name+'" value="C"> C</label><label class="me-2"><input type="radio" name="'+name+'" value="NC"> NC</label><label><input type="radio" name="'+name+'" value="NA"> N/A</label>';parent.replaceChild(div, sel);setTri(id,v)}
function cargarPermisoTrabajoActual(){
  fetch('/api/sgis/permiso-trabajo/current').then(r=>r.json()).then(d=>{
    if(d && d.success && d.data){
      const x=d.data;
      currentPermisoId = x.id_sgis_permiso_trabajo || null;
      document.getElementById('emitido_por').value=x.sgis_permiso_trabajo_emitido_por||'';
      document.getElementById('proyecto').value=x.sgis_permiso_trabajo_proyecto||'';
      document.getElementById('ciudad_permiso').value=x.sgis_permiso_trabajo_ciudad||'';
      document.getElementById('responsable_trabajo').value=x.sgis_permiso_trabajo_responsable_trabajo||x.nombre||'';
      document.getElementById('cargo_resp').value=x.sgis_permiso_trabajo_cargo||x.cargo||'';
      document.getElementById('cedula_resp').value=x.recurso_operativo_cedula||x.cedula||'';
      document.getElementById('trabajo_ejecutar').value=x.sgis_permiso_trabajo_trabajo_ejecutar||'';
      document.getElementById('herramienta').value=x.sgis_permiso_trabajo_herramienta||'';
      document.getElementById('descripcion_tarea').value=x.sgis_permiso_trabajo_descripcion_tarea||'';
      TRI_FIELDS.forEach(function(id){setTri(id,x[id]||'')});
      YN_FIELDS.forEach(function(id){var el=document.getElementById(id); if(el){el.value=(x[id]||'');}});
      TEXT_FIELDS.forEach(function(id){var el=document.getElementById(id); if(el){el.value=(x[id]||'');}});
      AP_FIELDS.forEach(function(id){var el=document.getElementById(id); if(el){el.value=(x[id]||'');}});
      var ftc=document.getElementById('sgis_permiso_trabajo_historial_confinado_firma_tecnico');
      if(ftc && !ftc.value){ftc.value=x.nombre||''}
      var fta=document.getElementById('sgis_permiso_trabajo_historial_semanal_altura_firma_tecnico');
      if(fta && !fta.value){fta.value=x.nombre||''}
      toggleSeccionesAplica();
      cargarHistorialesDelDia();
    }
  });
}
function showPermisoAlert(msg,cls){
  const a=document.getElementById('permisoTrabajoAlert');
  a.className='alert '+cls;
  a.textContent=msg;
  a.style.display='block';
}
function guardarPermisoTrabajo(){
  const body={
    sgis_permiso_trabajo_trabajo_ejecutar:document.getElementById('trabajo_ejecutar').value,
    sgis_permiso_trabajo_descripcion_tarea:document.getElementById('descripcion_tarea').value,
    sgis_permiso_trabajo_herramienta:document.getElementById('herramienta').value
  };
  TRI_FIELDS.forEach(function(id){body[id]=getTri(id)});
  YN_FIELDS.forEach(function(id){var el=document.getElementById(id); body[id]=el?el.value:''});
  TEXT_FIELDS.forEach(function(id){var el=document.getElementById(id); body[id]=el?el.value:''});
  AP_FIELDS.forEach(function(id){var el=document.getElementById(id); body[id]=el?el.value:''});
  fetch('/api/sgis/permiso-trabajo',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()).then(d=>{
    if(d && d.success){
      showPermisoAlert('Permiso guardado','alert-success');
      currentPermisoId = d.id_sgis_permiso_trabajo || currentPermisoId;
      toggleSeccionesAplica();
      const pm = document.getElementById('permisoTrabajoModal');
      const modal = bootstrap.Modal.getInstance(pm);
      if(modal) modal.hide();
      cargarPermisoTrabajoActual();
    }else{
      showPermisoAlert((d&&d.message)||'Error','alert-danger');
    }
  }).catch(()=>{showPermisoAlert('Error','alert-danger');});
}
function toggleSeccionesAplica(){
  var c=document.getElementById('sgis_permiso_trabajo_confinado_aplica');
  var a=document.getElementById('sgis_permiso_trabajo_altura_aplica');
  var sc=document.getElementById('secConfinado');
  var sa=document.getElementById('secAltura');
  var cv=c?c.value:'';
  var av=a?a.value:'';
  if(cv==='APLICA' && av==='APLICA' && a){a.value='NO_APLICA'; av='NO_APLICA'}
  if(sc){sc.style.display=(cv==='APLICA')?'block':'none'}
  if(sa){sa.style.display=(av==='APLICA')?'block':'none'}
  var dc=document.getElementById('sgis_permiso_trabajo_historial_confinado_fecha');
  var da=document.getElementById('sgis_permiso_trabajo_historial_altura_fecha');
  var today=new Date();
  var iso=today.toISOString().slice(0,10);
  if(dc){dc.value=iso; dc.readOnly=true}
  if(da){da.value=iso; da.readOnly=true}
  var acc=document.getElementById('collapseDocumentacion');
  if(acc){var cInst=new bootstrap.Collapse(acc,{toggle:false}); cInst.show()}
}
function hoyIso(){var t=new Date();return t.toISOString().slice(0,10)}
function cargarHistorialesDelDia(){
  if(!currentPermisoId){return}
  var iso=hoyIso();
  fetch('/api/sgis/permiso-trabajo/historial/confinado?id_sgis_permiso_trabajo='+currentPermisoId).then(r=>r.json()).then(d=>{
    if(d && d.success && Array.isArray(d.data)){
      var row=null; for(var i=0;i<d.data.length;i++){var fe=(d.data[i].sgis_permiso_trabajo_historial_confinado_fecha||''); if(String(fe).slice(0,10)===iso){row=d.data[i]; break}}
      var btn=document.getElementById('guardarHistorialConfinado');
      if(row){for(var j=1;j<=11;j++){if(j===11){var el=document.getElementById('sgis_permiso_trabajo_historial_confinado_11'); if(el){el.value=row['sgis_permiso_trabajo_historial_confinado_11']||''}} else {setTri('sgis_permiso_trabajo_historial_confinado_'+j,row['sgis_permiso_trabajo_historial_confinado_'+j])}} if(btn){btn.disabled=true}}
      else{if(btn){btn.disabled=false}}
    }
  });
  fetch('/api/sgis/permiso-trabajo/historial/alturas?id_sgis_permiso_trabajo='+currentPermisoId).then(r=>r.json()).then(d=>{
    if(d && d.success && Array.isArray(d.data)){
      var row=null; for(var i=0;i<d.data.length;i++){var fe=(d.data[i].sgis_permiso_trabajo_historial_altura_fecha||''); if(String(fe).slice(0,10)===iso){row=d.data[i]; break}}
      var btn=document.getElementById('guardarHistorialAltura');
      if(row){var h1=document.getElementById('sgis_permiso_trabajo_historial_altura_1'); if(h1){h1.value=row.sgis_permiso_trabajo_historial_altura_1||''} for(var j=2;j<=24;j++){if(j===20){var el=document.getElementById('sgis_permiso_trabajo_historial_altura_20'); if(el){el.value=row['sgis_permiso_trabajo_historial_altura_20']||''}} else {setTri('sgis_permiso_trabajo_historial_altura_'+j,row['sgis_permiso_trabajo_historial_altura_'+j])}} if(btn){btn.disabled=true}}
      else{if(btn){btn.disabled=false}}
    }
  });
}
function guardarHistorialConfinado(){
  if(!currentPermisoId){showPermisoAlert('Primero guarde el permiso semanal','alert-warning');return}
  openFirmaModal(function(sig){
    var iso=hoyIso();
    var body={id_sgis_permiso_trabajo: currentPermisoId,
      sgis_permiso_trabajo_historial_confinado_1:getTri('sgis_permiso_trabajo_historial_confinado_1'),
      sgis_permiso_trabajo_historial_confinado_2:getTri('sgis_permiso_trabajo_historial_confinado_2'),
      sgis_permiso_trabajo_historial_confinado_3:getTri('sgis_permiso_trabajo_historial_confinado_3'),
      sgis_permiso_trabajo_historial_confinado_4:getTri('sgis_permiso_trabajo_historial_confinado_4'),
      sgis_permiso_trabajo_historial_confinado_5:getTri('sgis_permiso_trabajo_historial_confinado_5'),
      sgis_permiso_trabajo_historial_confinado_6:getTri('sgis_permiso_trabajo_historial_confinado_6'),
      sgis_permiso_trabajo_historial_confinado_7:getTri('sgis_permiso_trabajo_historial_confinado_7'),
      sgis_permiso_trabajo_historial_confinado_8:getTri('sgis_permiso_trabajo_historial_confinado_8'),
      sgis_permiso_trabajo_historial_confinado_9:getTri('sgis_permiso_trabajo_historial_confinado_9'),
      sgis_permiso_trabajo_historial_confinado_10:getTri('sgis_permiso_trabajo_historial_confinado_10'),
      sgis_permiso_trabajo_historial_confinado_11:document.getElementById('sgis_permiso_trabajo_historial_confinado_11')?document.getElementById('sgis_permiso_trabajo_historial_confinado_11').value:'',
      sgis_permiso_trabajo_historial_confinado_fecha:iso,
      sgis_permiso_trabajo_historial_confinado_firma_tecnico:sig,
      sgis_permiso_trabajo_historial_confinado_firma_supervisor:document.getElementById('sgis_permiso_trabajo_historial_confinado_firma_supervisor')?document.getElementById('sgis_permiso_trabajo_historial_confinado_firma_supervisor').value:''
    };
    fetch('/api/sgis/permiso-trabajo/historial/confinado',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()).then(d=>{
      if(d && d.success){
        showPermisoAlert('Historial de confinados guardado','alert-success');
        const pm = document.getElementById('permisoTrabajoModal');
        const modal = bootstrap.Modal.getInstance(pm);
        if(modal) modal.hide();
        cargarHistorialesDelDia();
      } else {
        showPermisoAlert((d&&d.message)||'Error','alert-danger')
      }
    }).catch(()=>{showPermisoAlert('Error','alert-danger')});
  });
}
function guardarHistorialAltura(){
  if(!currentPermisoId){showPermisoAlert('Primero guarde el permiso semanal','alert-warning');return}
  openFirmaModal(function(sig){
    var iso=hoyIso();
    var body={id_sgis_permiso_trabajo: currentPermisoId,
      sgis_permiso_trabajo_historial_altura_1:document.getElementById('sgis_permiso_trabajo_historial_altura_1')?document.getElementById('sgis_permiso_trabajo_historial_altura_1').value:'',
      sgis_permiso_trabajo_historial_altura_2:getTri('sgis_permiso_trabajo_historial_altura_2'),
      sgis_permiso_trabajo_historial_altura_3:getTri('sgis_permiso_trabajo_historial_altura_3'),
      sgis_permiso_trabajo_historial_altura_4:getTri('sgis_permiso_trabajo_historial_altura_4'),
      sgis_permiso_trabajo_historial_altura_5:getTri('sgis_permiso_trabajo_historial_altura_5'),
      sgis_permiso_trabajo_historial_altura_6:getTri('sgis_permiso_trabajo_historial_altura_6'),
      sgis_permiso_trabajo_historial_altura_7:getTri('sgis_permiso_trabajo_historial_altura_7'),
      sgis_permiso_trabajo_historial_altura_8:getTri('sgis_permiso_trabajo_historial_altura_8'),
      sgis_permiso_trabajo_historial_altura_9:getTri('sgis_permiso_trabajo_historial_altura_9'),
      sgis_permiso_trabajo_historial_altura_10:getTri('sgis_permiso_trabajo_historial_altura_10'),
      sgis_permiso_trabajo_historial_altura_11:getTri('sgis_permiso_trabajo_historial_altura_11'),
      sgis_permiso_trabajo_historial_altura_12:getTri('sgis_permiso_trabajo_historial_altura_12'),
      sgis_permiso_trabajo_historial_altura_13:getTri('sgis_permiso_trabajo_historial_altura_13'),
      sgis_permiso_trabajo_historial_altura_14:getTri('sgis_permiso_trabajo_historial_altura_14'),
      sgis_permiso_trabajo_historial_altura_15:getTri('sgis_permiso_trabajo_historial_altura_15'),
      sgis_permiso_trabajo_historial_altura_16:getTri('sgis_permiso_trabajo_historial_altura_16'),
      sgis_permiso_trabajo_historial_altura_17:getTri('sgis_permiso_trabajo_historial_altura_17'),
      sgis_permiso_trabajo_historial_altura_18:getTri('sgis_permiso_trabajo_historial_altura_18'),
      sgis_permiso_trabajo_historial_altura_19:getTri('sgis_permiso_trabajo_historial_altura_19'),
      sgis_permiso_trabajo_historial_altura_20:document.getElementById('sgis_permiso_trabajo_historial_altura_20')?document.getElementById('sgis_permiso_trabajo_historial_altura_20').value:'',
      sgis_permiso_trabajo_historial_altura_21:getTri('sgis_permiso_trabajo_historial_altura_21'),
      sgis_permiso_trabajo_historial_altura_22:getTri('sgis_permiso_trabajo_historial_altura_22'),
      sgis_permiso_trabajo_historial_altura_23:getTri('sgis_permiso_trabajo_historial_altura_23'),
      sgis_permiso_trabajo_historial_altura_24:getTri('sgis_permiso_trabajo_historial_altura_24'),
      sgis_permiso_trabajo_historial_altura_fecha:iso,
      sgis_permiso_trabajo_historial_semanal_altura_firma_tecnico:sig,
      sgis_permiso_trabajo_historial_semanal_altura_firma_supervisor:document.getElementById('sgis_permiso_trabajo_historial_semanal_altura_firma_supervisor')?document.getElementById('sgis_permiso_trabajo_historial_semanal_altura_firma_supervisor').value:''
    };
    fetch('/api/sgis/permiso-trabajo/historial/alturas',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}).then(r=>r.json()).then(d=>{
      if(d && d.success){
        showPermisoAlert('Historial de alturas guardado','alert-success');
        const pm = document.getElementById('permisoTrabajoModal');
        const modal = bootstrap.Modal.getInstance(pm);
        if(modal) modal.hide();
        cargarHistorialesDelDia();
      } else {
        showPermisoAlert((d&&d.message)||'Error','alert-danger')
      }
    }).catch(()=>{showPermisoAlert('Error','alert-danger')});
  });
}
document.addEventListener('DOMContentLoaded',function(){
  const m=document.getElementById('permisoTrabajoModal');
  if(m){m.addEventListener('shown.bs.modal',cargarPermisoTrabajoActual);}    
  const g=document.getElementById('guardarPermisoTrabajo');
  if(g){g.addEventListener('click',guardarPermisoTrabajo);}    
  TRI_FIELDS.forEach(renderTriAsRadios);
  cargarPermisoTrabajoActual();
  var c=document.getElementById('sgis_permiso_trabajo_confinado_aplica');
  var a=document.getElementById('sgis_permiso_trabajo_altura_aplica');
  function aplicaChange(e){
    var cv=c?c.value:'';
    var av=a?a.value:'';
    var t=e && e.target;
    if(t===c){
      if(cv==='APLICA' && a){a.value='NO_APLICA'}
      else if(cv==='NO_APLICA' && a){a.value='APLICA'}
    } else if(t===a){
      if(av==='APLICA' && c){c.value='NO_APLICA'}
      else if(av==='NO_APLICA' && c){c.value='APLICA'}
    }
    toggleSeccionesAplica();
  }
  if(c){c.addEventListener('change',aplicaChange)}
  if(a){a.addEventListener('change',aplicaChange)}
  var gc=document.getElementById('guardarHistorialConfinado');
  var ga=document.getElementById('guardarHistorialAltura');
  if(gc){gc.addEventListener('click',guardarHistorialConfinado)}
  if(ga){ga.addEventListener('click',guardarHistorialAltura)}
});
</script>
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
function openFirmaModal(onSave){
  var el=document.getElementById('modalFirmaSgis');
  var modal=new bootstrap.Modal(el);
  var canvas=document.getElementById('sgis-signature-pad');
  var pad=new SignaturePad(canvas);
  function resize(){var ratio=Math.max(window.devicePixelRatio||1,1);canvas.width=canvas.offsetWidth*ratio;canvas.height=canvas.offsetHeight*ratio;canvas.getContext('2d').scale(ratio,ratio);pad.clear()}
  el.addEventListener('shown.bs.modal', function(){resize()}, { once: true });
  window.onresize=resize;
  var clearBtn=document.getElementById('sgis-firma-clear');
  var saveBtn=document.getElementById('sgis-firma-save');
  if(clearBtn){clearBtn.onclick=function(){pad.clear()}}
  if(saveBtn){saveBtn.onclick=function(){if(pad.isEmpty()){return} var data=pad.toDataURL('image/png'); modal.hide(); onSave(data)}}
  modal.show();
}
</script>
<div class="modal fade" id="modalFirmaSgis" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-md">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Firma técnico</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="sgis-signature-pad" style="width:100%;height:200px;border:1px solid #ccc;border-radius:.25rem;"></canvas>
        <div class="mt-2">
          <button type="button" class="btn btn-outline-secondary me-2" id="sgis-firma-clear">Limpiar</button>
          <button type="button" class="btn btn-dark" id="sgis-firma-save">Guardar Firma</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal Preoperacional -->
<div class="modal fade" id="modalPreop" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Pre-operacional de Elementos de Protección Personal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="row g-3">
            <div class="col-md-3"><small class="text-muted">Nombre</small><div>{{ session.get('user_name') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cédula</small><div>{{ session.get('user_cedula') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cargo</small><div>{{ session.get('user_role') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Fecha</small><div id="fechaBogota"></div></div>
          </div>
        </div>
        <hr>
        <form id="formPreop">
          <div id="sec-casco" class="mb-3 sgis-section">
            <h6 class="mb-1"><i class="fas  me-2"></i>Casco</h6>
            <p class="text-muted small mb-3">Conforme a los hallazgos de inspección registre los siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</p>
            <div id="nc-casco" class="badge-nc d-none mb-2">NC seleccionado</div>
            <div class="row align-items-start g-3">
              <div class="col-md-4">
                <img class="img-fluid rounded border" alt="Casco"
                     src="{{ url_for('static', filename='img/sgis/casco.jpg') }}"
                     onerror="this.src='{{ url_for('static', filename='img/sgis/casco.svg') }}'">
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Estado General</label>
                    <div>
                      <label class="me-2"><input type="radio" name="casco_estado_general" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="casco_estado_general" value="NC"> NC</label>
                      <label><input type="radio" name="casco_estado_general" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Uso inferior a 2 Años</label>
                    <div>
                      <label class="me-2"><input type="radio" name="casco_uso_menor_2_anios" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="casco_uso_menor_2_anios" value="NC"> NC</label>
                      <label><input type="radio" name="casco_uso_menor_2_anios" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Estado del Talifete</label>
                    <div>
                      <label class="me-2"><input type="radio" name="casco_estado_talifete" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="casco_estado_talifete" value="NC"> NC</label>
                      <label><input type="radio" name="casco_estado_talifete" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Puntos de anclaje del barbuquejo</label>
                    <div>
                      <label class="me-2"><input type="radio" name="casco_puntos_anclaje_barbuquejo" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="casco_puntos_anclaje_barbuquejo" value="NC"> NC</label>
                      <label><input type="radio" name="casco_puntos_anclaje_barbuquejo" value="N/A"> N/A</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-3">
          </div>

          <div id="sec-barbuquejo" class="mb-3 sgis-section">
            <h6 class="mb-1"><i class="fas  me-2"></i>Barbuquejo</h6>
            <p class="text-muted small mb-3">Conforme a los hallazgos de inspección registre los siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</p>
            <div id="nc-barbuquejo" class="badge-nc d-none mb-2">NC seleccionado</div>
            <div class="row align-items-start g-3">
              <div class="col-md-4">
                <img class="img-fluid rounded border" alt="Barbuquejo"
                     src="{{ url_for('static', filename='img/sgis/barbuquejo.jpg') }}"
                     onerror="this.src='{{ url_for('static', filename='img/sgis/barbuquejo.svg') }}'">
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Estado puntos de apoyo</label>
                    <div>
                      <label class="me-2"><input type="radio" name="barbuquejo_puntos_apoyo" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="barbuquejo_puntos_apoyo" value="NC"> NC</label>
                      <label><input type="radio" name="barbuquejo_puntos_apoyo" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado sujetador del mentón</label>
                    <div>
                      <label class="me-2"><input type="radio" name="barbuquejo_sujetador_menton" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="barbuquejo_sujetador_menton" value="NC"> NC</label>
                      <label><input type="radio" name="barbuquejo_sujetador_menton" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado costuras y correas</label>
                    <div>
                      <label class="me-2"><input type="radio" name="barbuquejo_costuras_correas" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="barbuquejo_costuras_correas" value="NC"> NC</label>
                      <label><input type="radio" name="barbuquejo_costuras_correas" value="N/A"> N/A</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-3">
          </div>

          <div id="sec-guantes" class="mb-3 sgis-section">
            <h6 class="mb-1"><i class="fas  me-2"></i>Guantes</h6>
            <p class="text-muted small mb-3">Conforme a los hallazgos de inspección registre los siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</p>
            <div id="nc-guantes" class="badge-nc d-none mb-2">NC seleccionado</div>
            <div class="row align-items-start g-3">
              <div class="col-md-4">
                <img class="img-fluid rounded border" alt="Guantes"
                     src="{{ url_for('static', filename='img/sgis/guantes.jpg') }}"
                     onerror="this.src='{{ url_for('static', filename='img/sgis/guantes.svg') }}'">
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Estado costuras</label>
                    <div>
                      <label class="me-2"><input type="radio" name="guantes_costuras" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="guantes_costuras" value="NC"> NC</label>
                      <label><input type="radio" name="guantes_costuras" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado refuerzo palma</label>
                    <div>
                      <label class="me-2"><input type="radio" name="guantes_refuerzo_palma" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="guantes_refuerzo_palma" value="NC"> NC</label>
                      <label><input type="radio" name="guantes_refuerzo_palma" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado General (Sin rotos)</label>
                    <div>
                      <label class="me-2"><input type="radio" name="guantes_estado_general" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="guantes_estado_general" value="NC"> NC</label>
                      <label><input type="radio" name="guantes_estado_general" value="N/A"> N/A</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-3">
          </div>

          <div id="sec-monogafas" class="mb-3 sgis-section">
            <h6 class="mb-1"><i class="fas me-2"></i>Monogafas</h6>
            <p class="text-muted small mb-3">Conforme a los hallazgos de inspección registre los siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</p>
            <div id="nc-monogafas" class="badge-nc d-none mb-2">NC seleccionado</div>
            <div class="row align-items-start g-3">
              <div class="col-md-4">
                <img class="img-fluid rounded border" alt="Monogafas"
                     src="{{ url_for('static', filename='img/sgis/monogafas.jpg') }}"
                     onerror="this.src='{{ url_for('static', filename='img/sgis/monogafas.svg') }}'">
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Estado de lentes (Sin rayones)</label>
                    <div>
                      <label class="me-2"><input type="radio" name="monogafas_lentes" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="monogafas_lentes" value="NC"> NC</label>
                      <label><input type="radio" name="monogafas_lentes" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado patillas ajustables</label>
                    <div>
                      <label class="me-2"><input type="radio" name="monogafas_patillas_ajustables" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="monogafas_patillas_ajustables" value="NC"> NC</label>
                      <label><input type="radio" name="monogafas_patillas_ajustables" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado puente de nariz</label>
                    <div>
                      <label class="me-2"><input type="radio" name="monogafas_puente_nariz" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="monogafas_puente_nariz" value="NC"> NC</label>
                      <label><input type="radio" name="monogafas_puente_nariz" value="N/A"> N/A</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-3">
          </div>

          <div class="mb-3">
            <label class="form-label">Observaciones</label>
            <small class="text-muted d-block mb-2">Si existen hallazgos en "NC - No Cumple", por favor registre las OBSERVACIONES.</small>
            <textarea id="observaciones" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button id="btnGuardarPreop" type="button" class="btn btn-primary">Guardar preoperacional</button>
      </div>
    </div>
  </div>
  </div>

<!-- Modal Firma -->
<div class="modal fade" id="modalFirma" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvas" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirma" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarPreop" type="button" class="btn btn-success btn-sm">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Escaleras -->
<div class="modal fade" id="modalEscaleras" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-stairs me-2"></i>Pre-operacional de Escaleras</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="row g-3">
            <div class="col-md-3"><small class="text-muted">Nombre</small><div>{{ session.get('user_name') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cédula</small><div>{{ session.get('user_cedula') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cargo</small><div>{{ session.get('user_role') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Mes</small><div id="mesActualEsc"></div></div>
          </div>
        </div>
        <hr>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Marca de escalera</label>
            <input type="text" id="marcaEscaleraEsc" class="form-control" placeholder="Marca">
          </div>
          <div class="col-md-6">
            <label class="form-label">Número de peldaños</label>
            <input type="number" id="cantPeldanosEsc" min="0" class="form-control" placeholder="Cantidad">
          </div>
        </div>
        <div class="mb-3">
          <h6 class="mb-2">Generalidades</h6>
          <div class="row g-3 align-items-start">
            <div class="col-md-4 text-center">
              <img class="img-fluid border rounded" alt="Escalera"
                   src="{{ url_for('static', filename='img/sgis/escalera.jpeg') }}"
                   onerror="this.style.display='none'"
                   style="max-height:320px; object-fit:contain;">
            </div>
            <div class="col-md-8">
              <ul class="mb-0">
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Larguero o perfil</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_larguero" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_larguero" value="NC"> NC</label>
                    <label><input type="radio" name="esc_larguero" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Peldaños</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_peldanos" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_peldanos" value="NC"> NC</label>
                    <label><input type="radio" name="esc_peldanos" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Unión de peldaños y largueros</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_union" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_union" value="NC"> NC</label>
                    <label><input type="radio" name="esc_union" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Zapatas antideslizantes</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_zapatas" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_zapatas" value="NC"> NC</label>
                    <label><input type="radio" name="esc_zapatas" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Base de apoyo a poste</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_base_apoyo" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_base_apoyo" value="NC"> NC</label>
                    <label><input type="radio" name="esc_base_apoyo" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Piezas de ajuste</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_piezas_ajuste" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_piezas_ajuste" value="NC"> NC</label>
                    <label><input type="radio" name="esc_piezas_ajuste" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Ganchos Trabapeldaños y uñas de seguridad</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_ganchos" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_ganchos" value="NC"> NC</label>
                    <label><input type="radio" name="esc_ganchos" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Cuerda y polea</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_cuerda_polea" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_cuerda_polea" value="NC"> NC</label>
                    <label><input type="radio" name="esc_cuerda_polea" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Guías externas para unión de largueros</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_guias_externas" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_guias_externas" value="NC"> NC</label>
                    <label><input type="radio" name="esc_guias_externas" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-0">
                  <label class="form-label fw-bold mb-1">Señalización de seguridad en peldaño</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_senal_seguridad" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_senal_seguridad" value="NC"> NC</label>
                    <label><input type="radio" name="esc_senal_seguridad" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mt-2 mb-0">
                  <label class="form-label fw-bold mb-1">Aseo de escalera</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_aseo_escalera" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_aseo_escalera" value="NC"> NC</label>
                    <label><input type="radio" name="esc_aseo_escalera" value="N/A"> N/A</label>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Observaciones</label>
          <textarea id="observacionesEsc" class="form-control" rows="3" placeholder="Observaciones"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button id="btnGuardarPreopEsc" type="button" class="btn btn-primary">Guardar preoperacional</button>
      </div>
    </div>
  </div>
  </div>

<!-- Modal Firma Escaleras -->
<div class="modal fade" id="modalFirmaEsc" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvasEsc" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirmaEsc" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarPreopEsc" type="button" class="btn btn-success btn-sm">Enviar</button>
        </div>
      </div>
    </div>
  </div>
  </div>

<!-- Modal Preoperacional Control Caídas -->
<div class="modal fade" id="modalTSR" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clipboard-list me-2"></i>Trabajo Seguro Rutinario</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="row g-3">
            <div class="col-md-3"><small class="text-muted">Nombre</small><div>{{ session.get('user_name') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cédula</small><div>{{ session.get('user_cedula') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cargo</small><div>{{ session.get('user_role') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Fecha</small><div id="fechaBogotaTSR"></div></div>
          </div>
        </div>
        <hr>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Actividad asociada</label>
            <div id="actividadGroupTSR">
              <label class="me-2"><input type="radio" name="actividad_asociada" value="TRABAJO EN ALTURAS"> TRABAJO EN ALTURAS</label>
              <label class="me-2"><input type="radio" name="actividad_asociada" value="TRABAJO EN ESPACIOS CONFINADOS"> TRABAJO EN ESPACIOS CONFINADOS</label>
              <label class="me-2"><input type="radio" name="actividad_asociada" value="TRABAJOS CON ENERGIAS PELIGROSAS"> TRABAJOS CON ENERGIAS PELIGROSAS</label>
              <label class="me-2"><input type="radio" name="actividad_asociada" value="TRABAJOS EN CALIENTE"> TRABAJOS EN CALIENTE</label>
              <label><input type="radio" name="actividad_asociada" value="NINGUNO"> NINGUNO</label>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Descripción de tareas</label>
            <input id="descripcionTareasTSR" type="text" class="form-control" placeholder="Descripción breve de las tareas">
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label class="form-label">Número OT</label>
            <input id="otTSR" type="text" class="form-control" placeholder="OT" required inputmode="numeric" minlength="7" maxlength="9">
          </div>
          <div class="col-md-3">
            <label class="form-label">Cuenta</label>
            <input id="cuentaTSR" type="text" class="form-control" placeholder="Cuenta" required inputmode="numeric" minlength="6" maxlength="8">
          </div>
        </div>
        <div class="mb-3">
          <h6 class="mb-2">Evaluación</h6>
          <div class="row g-3">
            <div class="col-md-6">
              <ul class="mb-0">
                <li class="mb-2"><label class="form-label fw-bold mb-1">1. Planeación del trabajo</label><div><label class="me-2"><input type="radio" name="respuesta_1" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_1" value="NC"> NC</label><label><input type="radio" name="respuesta_1" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">2. Inspección del área</label><div><label class="me-2"><input type="radio" name="respuesta_2" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_2" value="NC"> NC</label><label><input type="radio" name="respuesta_2" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">3. Herramientas en buen estado</label><div><label class="me-2"><input type="radio" name="respuesta_3" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_3" value="NC"> NC</label><label><input type="radio" name="respuesta_3" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">4. EPP completo</label><div><label class="me-2"><input type="radio" name="respuesta_4" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_4" value="NC"> NC</label><label><input type="radio" name="respuesta_4" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">5. Riesgos identificados</label><div><label class="me-2"><input type="radio" name="respuesta_5" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_5" value="NC"> NC</label><label><input type="radio" name="respuesta_5" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">6. Señalización adecuada</label><div><label class="me-2"><input type="radio" name="respuesta_6" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_6" value="NC"> NC</label><label><input type="radio" name="respuesta_6" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">7. Orden y limpieza</label><div><label class="me-2"><input type="radio" name="respuesta_7" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_7" value="NC"> NC</label><label><input type="radio" name="respuesta_7" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">8. Condiciones ambientales seguras</label><div><label class="me-2"><input type="radio" name="respuesta_8" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_8" value="NC"> NC</label><label><input type="radio" name="respuesta_8" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">9. Riesgos eléctricos controlados</label><div><label class="me-2"><input type="radio" name="respuesta_9" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_9" value="NC"> NC</label><label><input type="radio" name="respuesta_9" value="N/A"> N/A</label></div></li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="mb-0">
                <li class="mb-2"><label class="form-label fw-bold mb-1">10. Trabajo en alturas seguro</label><div><label class="me-2"><input type="radio" name="respuesta_10" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_10" value="NC"> NC</label><label><input type="radio" name="respuesta_10" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">11. Riesgo de caídas controlado</label><div><label class="me-2"><input type="radio" name="respuesta_11" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_11" value="NC"> NC</label><label><input type="radio" name="respuesta_11" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">12. Uso correcto de herramientas manuales</label><div><label class="me-2"><input type="radio" name="respuesta_12" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_12" value="NC"> NC</label><label><input type="radio" name="respuesta_12" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">13. Estado físico para la tarea</label><div><label class="me-2"><input type="radio" name="respuesta_13" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_13" value="NC"> NC</label><label><input type="radio" name="respuesta_13" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">14. Comunicación clara con el equipo</label><div><label class="me-2"><input type="radio" name="respuesta_14" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_14" value="NC"> NC</label><label><input type="radio" name="respuesta_14" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">15. Ruta y desplazamiento seguro</label><div><label class="me-2"><input type="radio" name="respuesta_15" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_15" value="NC"> NC</label><label><input type="radio" name="respuesta_15" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">16. Integridad de materiales</label><div><label class="me-2"><input type="radio" name="respuesta_16" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_16" value="NC"> NC</label><label><input type="radio" name="respuesta_16" value="N/A"> N/A</label></div></li>
                <li class="mb-2"><label class="form-label fw-bold mb-1">17. Control final antes de iniciar</label><div><label class="me-2"><input type="radio" name="respuesta_17" value="C"> C</label><label class="me-2"><input type="radio" name="respuesta_17" value="NC"> NC</label><label><input type="radio" name="respuesta_17" value="N/A"> N/A</label></div></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Riesgo</label>
            <select id="selRiesgoTSR" class="form-select">
              <option value="">Selecciona…</option>
            </select>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label class="form-label">Peligro</label>
            <select id="selPeligroTSR" class="form-select">
              <option value="">Selecciona…</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Consecuencia</label>
            <select id="selConsecuenciaTSR" class="form-select">
              <option value="">Selecciona…</option>
            </select>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-6">
            <label class="form-label">Controles</label>
            <select id="selControlTSR" class="form-select">
              <option value="">Selecciona…</option>
            </select>
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-12">
            <label class="form-label">Observaciones</label>
            <textarea id="observacionesTSR" class="form-control" rows="3" placeholder="Observaciones"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button id="btnFirmarEnviarTSR" type="button" class="btn btn-primary">Firmar y Enviar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalFirmaTSR" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvasTSR" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirmaTSR" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarTSR" type="button" class="btn btn-success btn-sm">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modalCaidas" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-user-shield me-2"></i>Pre-operacional Control de Caídas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="row g-3">
            <div class="col-md-3"><small class="text-muted">Nombre</small><div>{{ session.get('user_name') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cédula</small><div>{{ session.get('user_cedula') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cargo</small><div>{{ session.get('user_role') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Fecha</small><div id="fechaBogotaCaidas"></div></div>
          </div>
        </div>
        <hr>
        <form id="formCaidas">
          <div class="mb-4 caidas-step" data-step="1">
            <h6 class="mb-2">Arnés</h6>
            <hr class="mt-0 mb-2">
            <div class="mb-2 fw-bold">Información</div>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="arnes_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="arnes_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="arnes_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="arnes_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="arnes_fecha_fabri"></div>
            </div>
            <div class="mb-2 fw-bold">Generalidades</div>
            <div class="small text-muted mb-2">Conforme a los hallazgos de inspección registre lo siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</div>
            <div class="row align-items-start">
              <div class="col-12 col-md-2 d-flex justify-content-center mb-2 mb-md-0">
                <img src="/static/img/sgis/arnes.jpg" onerror="this.src='/static/img/sgis/arnes.png'" class="img-fluid" style="max-width:180px; max-height:180px; object-fit:contain">
              </div>
              <div class="col-12 col-md-10">
                <ul class="mb-0">
                  <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                    <div><label class="me-2"><input type="radio" name="arnes_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_fisura" value="NC"> NC</label><label><input type="radio" name="arnes_fisura" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Fibras rotas o grietas en reatas, cintas o cuerdas.</label>
                    <div><label class="me-2"><input type="radio" name="arnes_fibra_rota" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_fibra_rota" value="NC"> NC</label><label><input type="radio" name="arnes_fibra_rota" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                    <div><label class="me-2"><input type="radio" name="arnes_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_deterioro" value="NC"> NC</label><label><input type="radio" name="arnes_deterioro" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Manchas brillantes o duras.</label>
                    <div><label class="me-2"><input type="radio" name="arnes_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_manchas" value="NC"> NC</label><label><input type="radio" name="arnes_manchas" value="N/A"> N/A</label></div></li>
                  <li class="mb-0"><label class="form-label">Indicador de impacto.</label>
                    <div><label class="me-2"><input type="radio" name="arnes_impacto" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_impacto" value="NC"> NC</label><label><input type="radio" name="arnes_impacto" value="N/A"> N/A</label></div></li>
                </ul>
              </div>
            </div>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="2">
            <h6 class="mb-2">Eslinga</h6>
            <hr class="mt-0 mb-2">
            <div class="mb-2 fw-bold">Información</div>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="eslinga_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="eslinga_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="eslinga_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="eslinga_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="eslinga_fecha_fabri"></div>
            </div>
            <div class="mb-2 fw-bold">Generalidades</div>
            <div class="small text-muted mb-2">Conforme a los hallazgos de inspección registre lo siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</div>
            <div class="row align-items-start">
              <div class="col-12 col-md-2 d-flex justify-content-center mb-2 mb-md-0">
                <img src="/static/img/sgis/eslinga.jpg" onerror="this.src='/static/img/sgis/eslinga.png'" class="img-fluid" style="max-width:180px; max-height:180px; object-fit:contain">
              </div>
              <div class="col-12 col-md-10">
                <ul class="mb-0">
                  <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                    <div><label class="me-2"><input type="radio" name="eslinga_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_fisura" value="NC"> NC</label><label><input type="radio" name="eslinga_fisura" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Fibras rotas o grietas en reatas, cintas o cuerdas.</label>
                    <div><label class="me-2"><input type="radio" name="eslinga_fibra_rota" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_fibra_rota" value="NC"> NC</label><label><input type="radio" name="eslinga_fibra_rota" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                    <div><label class="me-2"><input type="radio" name="eslinga_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_deterioro" value="NC"> NC</label><label><input type="radio" name="eslinga_deterioro" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Manchas brillantes o duras.</label>
                    <div><label class="me-2"><input type="radio" name="eslinga_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_manchas" value="NC"> NC</label><label><input type="radio" name="eslinga_manchas" value="N/A"> N/A</label></div></li>
                  <li class="mb-0"><label class="form-label">Indicador de impacto.</label>
                    <div><label class="me-2"><input type="radio" name="eslinga_impacto" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_impacto" value="NC"> NC</label><label><input type="radio" name="eslinga_impacto" value="N/A"> N/A</label></div></li>
                </ul>
              </div>
            </div>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="3">
            <h6 class="mb-2">Anclaje Portátil (Tie-Off)</h6>
            <hr class="mt-0 mb-2">
            <div class="mb-2 fw-bold">Información</div>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="anclaje_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="anclaje_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="anclaje_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="anclaje_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="anclaje_fecha_fabri"></div>
            </div>
            <div class="mb-2 fw-bold">Generalidades</div>
            <div class="small text-muted mb-2">Conforme a los hallazgos de inspección registre lo siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</div>
            <div class="row align-items-start">
              <div class="col-12 col-md-2 d-flex justify-content-center mb-2 mb-md-0">
                <img src="/static/img/sgis/anclaje.jpg" onerror="this.src='/static/img/sgis/anclaje.png'" class="img-fluid" style="max-width:180px; max-height:180px; object-fit:contain">
              </div>
              <div class="col-12 col-md-10">
                <ul class="mb-0">
                  <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                    <div><label class="me-2"><input type="radio" name="anclaje_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_fisura" value="NC"> NC</label><label><input type="radio" name="anclaje_fisura" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Fibras rotas o grietas en reatas, cintas o cuerdas.</label>
                    <div><label class="me-2"><input type="radio" name="anclaje_fibra_rota" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_fibra_rota" value="NC"> NC</label><label><input type="radio" name="anclaje_fibra_rota" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                    <div><label class="me-2"><input type="radio" name="anclaje_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_deterioro" value="NC"> NC</label><label><input type="radio" name="anclaje_deterioro" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Manchas brillantes o duras.</label>
                    <div><label class="me-2"><input type="radio" name="anclaje_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_manchas" value="NC"> NC</label><label><input type="radio" name="anclaje_manchas" value="N/A"> N/A</label></div></li>
                  <li class="mb-0"><label class="form-label">Indicador de impacto.</label>
                    <div><label class="me-2"><input type="radio" name="anclaje_impacto" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_impacto" value="NC"> NC</label><label><input type="radio" name="anclaje_impacto" value="N/A"> N/A</label></div></li>
                </ul>
              </div>
            </div>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="4">
            <h6 class="mb-2">Línea de Vida</h6>
            <hr class="mt-0 mb-2">
            <div class="mb-2 fw-bold">Información</div>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="linea_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="linea_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="linea_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="linea_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="linea_fecha_fabri"></div>
            </div>
            <div class="mb-2 fw-bold">Generalidades</div>
            <div class="small text-muted mb-2">Conforme a los hallazgos de inspección registre lo siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</div>
            <div class="row align-items-start">
              <div class="col-12 col-md-2 d-flex justify-content-center mb-2 mb-md-0">
                <img src="/static/img/sgis/linea_de_vida.jpg" onerror="this.src='/static/img/sgis/linea_de_vida.png'" class="img-fluid" style="max-width:180px; max-height:180px; object-fit:contain">
              </div>
              <div class="col-12 col-md-10">
                <ul class="mb-0">
                  <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                    <div><label class="me-2"><input type="radio" name="linea_vida_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_fisura" value="NC"> NC</label><label><input type="radio" name="linea_vida_fisura" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Fibras rotas o grietas en reatas, cintas o cuerdas.</label>
                    <div><label class="me-2"><input type="radio" name="linea_vida_fibra_rota" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_fibra_rota" value="NC"> NC</label><label><input type="radio" name="linea_vida_fibra_rota" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                    <div><label class="me-2"><input type="radio" name="linea_vida_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_deterioro" value="NC"> NC</label><label><input type="radio" name="linea_vida_deterioro" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Manchas brillantes o duras.</label>
                    <div><label class="me-2"><input type="radio" name="linea_vida_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_manchas" value="NC"> NC</label><label><input type="radio" name="linea_vida_manchas" value="N/A"> N/A</label></div></li>
                  <li class="mb-0"><label class="form-label">Indicador de impacto.</label>
                    <div><label class="me-2"><input type="radio" name="linea_vida_impacto" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_impacto" value="NC"> NC</label><label><input type="radio" name="linea_vida_impacto" value="N/A"> N/A</label></div></li>
                </ul>
              </div>
            </div>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="5">
            <h6 class="mb-2">Mosquetón</h6>
            <hr class="mt-0 mb-2">
            <div class="mb-2 fw-bold">Información</div>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="mosqueton_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="mosqueton_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="mosqueton_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="mosqueton_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="mosqueton_fecha_fabri"></div>
            </div>
            <div class="mb-2 fw-bold">Generalidades</div>
            <div class="small text-muted mb-2">Conforme a los hallazgos de inspección registre lo siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</div>
            <div class="row align-items-start">
              <div class="col-12 col-md-2 d-flex justify-content-center mb-2 mb-md-0">
                <img src="/static/img/sgis/mosqueton.jpg" onerror="this.src='/static/img/sgis/mosqueton.png'" class="img-fluid" style="max-width:180px; max-height:180px; object-fit:contain">
              </div>
              <div class="col-12 col-md-10">
                <ul class="mb-0">
                  <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                    <div><label class="me-2"><input type="radio" name="mosqueton_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="mosqueton_deterioro" value="NC"> NC</label><label><input type="radio" name="mosqueton_deterioro" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                    <div><label class="me-2"><input type="radio" name="mosqueton_fisural" value="C"> C</label><label class="me-2"><input type="radio" name="mosqueton_fisural" value="NC"> NC</label><label><input type="radio" name="mosqueton_fisural" value="N/A"> N/A</label></div></li>
                  <li class="mb-0"><label class="form-label">Manchas brillantes o duras.</label>
                    <div><label class="me-2"><input type="radio" name="mosqueton_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="mosqueton_manchas" value="NC"> NC</label><label><input type="radio" name="mosqueton_manchas" value="N/A"> N/A</label></div></li>
                </ul>
              </div>
            </div>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="6">
            <h6 class="mb-2">Pretales</h6>
            <hr class="mt-0 mb-2">
            <div class="mb-2 fw-bold">Información</div>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="pretales_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="pretales_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="pretales_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="pretales_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="pretales_fecha_fabri"></div>
            </div>
            <div class="mb-2 fw-bold">Generalidades</div>
            <div class="small text-muted mb-2">Conforme a los hallazgos de inspección registre lo siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</div>
            <div class="row align-items-start">
              <div class="col-12 col-md-2 d-flex justify-content-center mb-2 mb-md-0">
                <img src="/static/img/sgis/pretales.jpg" onerror="this.src='/static/img/sgis/pretales.png'" class="img-fluid" style="max-width:180px; max-height:180px; object-fit:contain">
              </div>
              <div class="col-12 col-md-10">
                <ul class="mb-0">
                  <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                    <div><label class="me-2"><input type="radio" name="pretales_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="pretales_deterioro" value="NC"> NC</label><label><input type="radio" name="pretales_deterioro" value="N/A"> N/A</label></div></li>
                  <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                    <div><label class="me-2"><input type="radio" name="pretales_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="pretales_fisura" value="NC"> NC</label><label><input type="radio" name="pretales_fisura" value="N/A"> N/A</label></div></li>
                  <li class="mb-0"><label class="form-label">Manchas brillantes o duras.</label>
                    <div><label class="me-2"><input type="radio" name="pretales_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="pretales_manchas" value="NC"> NC</label><label><input type="radio" name="pretales_manchas" value="N/A"> N/A</label></div></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Observaciones</label>
            <textarea id="observacionesCaidas" class="form-control" rows="3" placeholder="Observaciones"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button id="btnGuardarPreopCaidas" type="button" class="btn btn-primary" style="display:none">Guardar preoperacional</button>
      </div>
    </div>
  </div>
  </div>

<!-- Modal Firma Caídas -->
<div class="modal fade" id="modalFirmaCaidas" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvasCaidas" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirmaCaidas" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarPreopCaidas" type="button" class="btn btn-success btn-sm">Enviar</button>
        </div>
      </div>
    </div>
  </div>
  </div>

<script>
function setFechaBogota(){
  const nowStr = new Date().toLocaleString('es-CO', { timeZone: 'America/Bogota' });
  const el = document.getElementById('fechaBogota');
  if(el) el.textContent = nowStr;
}
function getRadio(name){
  const els = document.querySelectorAll(`input[name="${name}"]`);
  for(const e of els){ if(e.checked) return e.value; }
  return null;
}
function validarCampos(){
  const req = [
    'casco_estado_general','casco_uso_menor_2_anios','casco_estado_talifete','casco_puntos_anclaje_barbuquejo',
    'barbuquejo_puntos_apoyo','barbuquejo_sujetador_menton','barbuquejo_costuras_correas',
    'guantes_costuras','guantes_refuerzo_palma','guantes_estado_general',
    'monogafas_lentes','monogafas_patillas_ajustables','monogafas_puente_nariz'
  ];
  for(const n of req){
    const v = getRadio(n);
    if(!v){
      Swal.fire('Campos incompletos', 'Completa todas las secciones', 'warning');
      return false;
    }
  }
  let hasNC = false;
  for(const n of req){
    if(getRadio(n) === 'NC'){ hasNC = true; break; }
  }
  if(hasNC){
    const obs = (document.getElementById('observaciones').value || '').trim();
    if(!obs){
      Swal.fire('Observaciones requeridas', 'Registra observaciones para los hallazgos en NC', 'warning');
      return false;
    }
  }
  return true;
}
function recolectar(){
  return {
    casco_estado_general: getRadio('casco_estado_general'),
    casco_uso_menor_2_anios: getRadio('casco_uso_menor_2_anios'),
    casco_estado_talifete: getRadio('casco_estado_talifete'),
    casco_puntos_anclaje_barbuquejo: getRadio('casco_puntos_anclaje_barbuquejo'),
    barbuquejo_puntos_apoyo: getRadio('barbuquejo_puntos_apoyo'),
    barbuquejo_sujetador_menton: getRadio('barbuquejo_sujetador_menton'),
    barbuquejo_costuras_correas: getRadio('barbuquejo_costuras_correas'),
    guantes_costuras: getRadio('guantes_costuras'),
    guantes_refuerzo_palma: getRadio('guantes_refuerzo_palma'),
    guantes_estado_general: getRadio('guantes_estado_general'),
    monogafas_lentes: getRadio('monogafas_lentes'),
    monogafas_patillas_ajustables: getRadio('monogafas_patillas_ajustables'),
    monogafas_puente_nariz: getRadio('monogafas_puente_nariz'),
    observaciones: document.getElementById('observaciones').value || ''
  };
}
function calcSectionNC(section){
  if(section==='casco'){
    return ['casco_estado_general','casco_uso_menor_2_anios','casco_estado_talifete','casco_puntos_anclaje_barbuquejo'].some(n=>getRadio(n)==='NC');
  } else if(section==='barbuquejo'){
    return ['barbuquejo_puntos_apoyo','barbuquejo_sujetador_menton','barbuquejo_costuras_correas'].some(n=>getRadio(n)==='NC');
  } else if(section==='guantes'){
    return ['guantes_costuras','guantes_refuerzo_palma','guantes_estado_general'].some(n=>getRadio(n)==='NC');
  } else if(section==='monogafas'){
    return ['monogafas_lentes','monogafas_patillas_ajustables','monogafas_puente_nariz'].some(n=>getRadio(n)==='NC');
  }
  return false;
}
function updateSectionUI(section){
  const hasNC = calcSectionNC(section);
  const block = document.getElementById('sec-'+section);
  const badge = document.getElementById('nc-'+section);
  if(block){ block.classList.toggle('nc', !!hasNC); }
  if(badge){ badge.classList.toggle('d-none', !hasNC); }
}
let firmaCtx, firmando = false;
function initFirma(){
  const c = document.getElementById('firmaCanvas');
  firmaCtx = c.getContext('2d');
  firmaCtx.strokeStyle = '#222';
  firmaCtx.lineWidth = 2;
  const pos = (e)=>{
    const r = c.getBoundingClientRect();
    const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
    return {x,y};
  };
  const start = (e)=>{ firmando = true; const p = pos(e); firmaCtx.beginPath(); firmaCtx.moveTo(p.x,p.y); e.preventDefault(); };
  const move = (e)=>{ if(!firmando) return; const p = pos(e); firmaCtx.lineTo(p.x,p.y); firmaCtx.stroke(); e.preventDefault(); };
  const end = ()=>{ firmando = false; };
  c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
  c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
  document.getElementById('btnLimpiarFirma').addEventListener('click', ()=>{ firmaCtx.clearRect(0,0,c.width,c.height); });
}
function enviarConFirma(){
  const c = document.getElementById('firmaCanvas');
  const firma = c.toDataURL('image/png');
  const payload = recolectar();
  payload.firma_base64 = firma;
  const req = [
    'casco_estado_general','casco_uso_menor_2_anios','casco_estado_talifete','casco_puntos_anclaje_barbuquejo',
    'barbuquejo_puntos_apoyo','barbuquejo_sujetador_menton','barbuquejo_costuras_correas',
    'guantes_costuras','guantes_refuerzo_palma','guantes_estado_general',
    'monogafas_lentes','monogafas_patillas_ajustables','monogafas_puente_nariz'
  ];
  let hasNC = false;
  for(const n of req){ if(payload[n] === 'NC'){ hasNC = true; break; } }
  if(hasNC){
    const obs = (payload.observaciones || '').trim();
    if(!obs){
      Swal.fire('Observaciones requeridas', 'Registra observaciones para los hallazgos en NC', 'warning');
      return;
    }
  }
  fetch('/api/sgis/pre-proteccion-personal', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  }).then(r=>r.json()).then(d=>{
    if(d && d.success){
      Swal.fire('Éxito','Preoperacional registrado','success');
      const btn = document.getElementById('btnPreop');
      if(btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
      const mf = document.getElementById('modalFirma');
      const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
      const mp = document.getElementById('modalPreop');
      const modal2 = bootstrap.Modal.getInstance(mp); if(modal2) modal2.hide();
    } else {
      Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
    }
  }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
}
document.addEventListener('DOMContentLoaded', function(){
  {% if session.get('user_role') == 'administrativo' %}
  fetch('/api/sgis/dashboard-stats').then(r=>r.json()).then(d=>{
    if(d && d.success){
      document.getElementById('sgis-total-preop').textContent = d.data.total_preop || 0;
      document.getElementById('sgis-epp-ok').textContent = d.data.epp_ok || 0;
      document.getElementById('sgis-epp-alertas').textContent = d.data.epp_alertas || 0;
      document.getElementById('sgis-reportes').textContent = d.data.reportes || 0;
    }
  }).catch(()=>{});
  {% endif %}
  fetch('/api/sgis/pre-proteccion-personal/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnPreop');
    if(d && d.success && d.already_today && btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
  }).catch(()=>{});
  setFechaBogota();
  document.getElementById('btnGuardarPreop').addEventListener('click', function(){
    if(!validarCampos()) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirma'));
    mf.show();
    initFirma();
  });
  document.getElementById('btnEnviarPreop').addEventListener('click', enviarConFirma);
  function escGet(name){ const el = document.querySelector('input[name="'+name+'"]:checked'); return el ? el.value : ''; }
  function construirPayloadEsc(){
    return {
      larguero: escGet('esc_larguero'),
      peldanos: escGet('esc_peldanos'),
      union: escGet('esc_union'),
      zapatas: escGet('esc_zapatas'),
      base_apoyo: escGet('esc_base_apoyo'),
      piezas_ajuste: escGet('esc_piezas_ajuste'),
      ganchos: escGet('esc_ganchos'),
      cuerda_polea: escGet('esc_cuerda_polea'),
      guias_externas: escGet('esc_guias_externas'),
      senal_seguridad: escGet('esc_senal_seguridad'),
      aseo_escalera: escGet('esc_aseo_escalera'),
      marca: (document.getElementById('marcaEscaleraEsc').value || '').trim(),
      cant_peldano: parseInt(document.getElementById('cantPeldanosEsc').value || '0', 10),
      observacion: (document.getElementById('observacionesEsc').value || '').trim()
    };
  }
  function validarCamposEsc(){
    const req = ['larguero','peldanos','union','zapatas','base_apoyo','piezas_ajuste','ganchos','cuerda_polea','guias_externas','senal_seguridad','aseo_escalera'];
    const p = construirPayloadEsc();
    for(const k of req){ if(!p[k] || !(['C','NC','N/A'].includes(p[k]))){ Swal.fire('Campos incompletos','Completa todas las generalidades','warning'); return false; } }
    const hasNC = req.some(k => p[k] === 'NC');
    if(hasNC && !p.observacion){ Swal.fire('Observaciones requeridas','Registra observaciones para los hallazgos en NC','warning'); return false; }
    return true;
  }
  let firmaCtxEsc, firmandoEsc = false;
  function initFirmaEsc(){
    const c = document.getElementById('firmaCanvasEsc');
    firmaCtxEsc = c.getContext('2d');
    firmaCtxEsc.strokeStyle = '#222';
    firmaCtxEsc.lineWidth = 2;
    const pos = (e)=>{ const r = c.getBoundingClientRect(); const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x,y}; };
    const start = (e)=>{ firmandoEsc = true; const p = pos(e); firmaCtxEsc.beginPath(); firmaCtxEsc.moveTo(p.x,p.y); e.preventDefault(); };
    const move = (e)=>{ if(!firmandoEsc) return; const p = pos(e); firmaCtxEsc.lineTo(p.x,p.y); firmaCtxEsc.stroke(); e.preventDefault(); };
    const end = ()=>{ firmandoEsc = false; };
    c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
    c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
    document.getElementById('btnLimpiarFirmaEsc').addEventListener('click', ()=>{ firmaCtxEsc.clearRect(0,0,c.width,c.height); });
  }
  function enviarConFirmaEsc(){
    const c = document.getElementById('firmaCanvasEsc');
    const firma = c.toDataURL('image/png');
    const payload = construirPayloadEsc();
    if(!validarCamposEsc()) return;
    payload.firma_base64 = firma;
    fetch('/api/sgis/pre-escaleras', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      .then(r=>r.json()).then(d=>{
        if(d && d.success){
          Swal.fire('Éxito','Preoperacional de escaleras registrado','success');
          const btn = document.getElementById('btnPreopEsc'); if(btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
          const mf = document.getElementById('modalFirmaEsc'); const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
          const me = document.getElementById('modalEscaleras'); const modal2 = bootstrap.Modal.getInstance(me); if(modal2) modal2.hide();
        } else {
          Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
        }
      }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
  }
  document.getElementById('btnGuardarPreopEsc').addEventListener('click', function(){
    if(!validarCamposEsc()) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirmaEsc'));
    mf.show();
    initFirmaEsc();
  });
  document.getElementById('btnEnviarPreopEsc').addEventListener('click', enviarConFirmaEsc);
  fetch('/api/sgis/pre-escaleras/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnPreopEsc');
    if(d && d.success && d.already_today && btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
  }).catch(()=>{});
  fetch('/api/sgis/pre-caidas/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnPreopCaidas');
    if(d && d.success && d.already_today && btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
  }).catch(()=>{});
  try { const d = new Date(); const m = String(d.getMonth()+1).padStart(2,'0'); document.getElementById('mesActualEsc').textContent = `${d.getFullYear()}-${m}`; } catch(e) {}
  try {
    const params = new URLSearchParams(window.location.search);
    if(params.get('open') === 'preop'){
      const mp = new bootstrap.Modal(document.getElementById('modalPreop'));
      mp.show();
    }
  } catch(e) {}
  ['casco','barbuquejo','guantes','monogafas'].forEach(updateSectionUI);
  document.querySelectorAll('input[type="radio"]').forEach(el=>{
    el.addEventListener('change', ()=>{
      const n = el.name;
      if(n.startsWith('casco_')) updateSectionUI('casco');
      else if(n.startsWith('barbuquejo_')) updateSectionUI('barbuquejo');
      else if(n.startsWith('guantes_')) updateSectionUI('guantes');
      else if(n.startsWith('monogafas_')) updateSectionUI('monogafas');
    });
  });
  function setFechaBogotaCaidas(){
    try{ document.getElementById('fechaBogotaCaidas').textContent = new Date().toLocaleString('es-CO',{ timeZone:'America/Bogota' }); }catch(e){}
  }
  setFechaBogotaCaidas();
  const caidasSteps = Array.from(document.querySelectorAll('#modalCaidas .caidas-step'));
  let caidasStepIndex = 0;
  function showCaidasStep(i){
    caidasSteps.forEach((s,idx)=>{ s.style.display = idx===i ? 'block' : 'none'; });
    const saveBtn = document.getElementById('btnGuardarPreopCaidas');
    if(saveBtn) saveBtn.style.display = i === caidasSteps.length - 1 ? 'inline-block' : 'none';
  }
  showCaidasStep(0);
  document.getElementById('modalCaidas').addEventListener('shown.bs.modal', function(){
    fetch('/api/sgis/pre-caidas/current').then(r=>r.json()).then(d=>{
      if(d && d.success && d.data){
        const x = d.data;
        const setVal = (id,val)=>{ var el=document.getElementById(id); if(el && val) el.value = val; };
        setVal('arnes_marca', x.sgis_pre_proteccion_caidas_arnes_marca);
        setVal('arnes_modelo', x.sgis_pre_proteccion_caidas_arnes_modelo);
        setVal('arnes_serie', x.sgis_pre_proteccion_caidas_arnes_serie);
        setVal('arnes_lote', x.sgis_pre_proteccion_caidas_arnes_lote);
        setVal('arnes_fecha_fabri', x.sgis_pre_proteccion_caidas_arnes_fecha_fabri);
        setVal('eslinga_marca', x.sgis_pre_proteccion_caidas_eslinga_marca);
        setVal('eslinga_modelo', x.sgis_pre_proteccion_caidas_eslinga_modelo);
        setVal('eslinga_serie', x.sgis_pre_proteccion_caidas_eslinga_serie);
        setVal('eslinga_lote', x.sgis_pre_proteccion_caidas_eslinga_lote);
        setVal('eslinga_fecha_fabri', x.sgis_pre_proteccion_caidas_eslinga_fecha_fabri);
        setVal('anclaje_marca', x.sgis_pre_proteccion_caidas_anclaje_marca);
        setVal('anclaje_modelo', x.sgis_pre_proteccion_caidas_anclaje_modelo);
        setVal('anclaje_serie', x.sgis_pre_proteccion_caidas_anclaje_serie);
        setVal('anclaje_lote', x.sgis_pre_proteccion_caidas_anclaje_lote);
        setVal('anclaje_fecha_fabri', x.sgis_pre_proteccion_caidas_anclaje_fecha_fabri);
        setVal('linea_marca', x.sgis_pre_proteccion_caidas_linea_vida_marca);
        setVal('linea_modelo', x.sgis_pre_proteccion_caidas_linea_vida_modelo);
        setVal('linea_serie', x.sgis_pre_proteccion_caidas_linea_vida_serie);
        setVal('linea_lote', x.sgis_pre_proteccion_caidas_linea_vida_lote);
        setVal('linea_fecha_fabri', x.sgis_pre_proteccion_caidas_linea_vida_fecha_fabri);
        setVal('mosqueton_marca', x.sgis_pre_proteccion_caidas_mosqueton_marca);
        setVal('mosqueton_modelo', x.sgis_pre_proteccion_caidas_mosqueton_modelo);
        setVal('mosqueton_serie', x.sgis_pre_proteccion_caidas_mosqueton_serie);
        setVal('mosqueton_lote', x.sgis_pre_proteccion_caidas_mosqueton_lote);
        setVal('mosqueton_fecha_fabri', x.sgis_pre_proteccion_caidas_mosqueton_fecha_fabri);
        setVal('pretales_marca', x.sgis_pre_proteccion_caidas_pretales_marca);
        setVal('pretales_modelo', x.sgis_pre_proteccion_caidas_pretales_modelo);
        setVal('pretales_serie', x.sgis_pre_proteccion_caidas_pretales_serie);
        setVal('pretales_lote', x.sgis_pre_proteccion_caidas_pretales_lote);
        setVal('pretales_fecha_fabri', x.sgis_pre_proteccion_caidas_pretales_fecha_fabri);
      }
    }).catch(()=>{});
  });
  function validarSeccionCaidas(idx){
    const reqs = [
      ['arnes_fisura','arnes_fibra_rota','arnes_deterioro','arnes_manchas','arnes_impacto'],
      ['eslinga_fisura','eslinga_fibra_rota','eslinga_deterioro','eslinga_manchas','eslinga_impacto'],
      ['anclaje_fisura','anclaje_fibra_rota','anclaje_deterioro','anclaje_manchas','anclaje_impacto'],
      ['linea_vida_fisura','linea_vida_fibra_rota','linea_vida_deterioro','linea_vida_manchas','linea_vida_impacto'],
      ['mosqueton_deterioro','mosqueton_fisural','mosqueton_manchas'],
      ['pretales_deterioro','pretales_fisura','pretales_manchas']
    ];
    const current = reqs[idx] || [];
    for(const k of current){ const v = caidasGet(k); if(!v){ Swal.fire('Campos incompletos','Completa la sección actual','warning'); return false; } }
    return true;
  }
  document.querySelectorAll('#modalCaidas .btn-next-caidas').forEach(btn=>{
    btn.addEventListener('click', function(){
      const idx = caidasSteps.findIndex(s=>s.contains(btn));
      if(idx === -1) return;
      if(!validarSeccionCaidas(idx)) return;
      const next = idx + 1;
      if(next < caidasSteps.length){ caidasStepIndex = next; showCaidasStep(next); }
    });
  });
  function caidasGet(name){ const el = document.querySelector('input[name="'+name+'"]:checked'); return el ? el.value : ''; }
  function construirPayloadCaidas(){
    return {
      sgis_pre_proteccion_caidas_arnes_marca: document.getElementById('arnes_marca').value || '',
      sgis_pre_proteccion_caidas_arnes_modelo: document.getElementById('arnes_modelo').value || '',
      sgis_pre_proteccion_caidas_arnes_serie: document.getElementById('arnes_serie').value || '',
      sgis_pre_proteccion_caidas_arnes_lote: document.getElementById('arnes_lote').value || '',
      sgis_pre_proteccion_caidas_arnes_fecha_fabri: document.getElementById('arnes_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_arnes_fisura: caidasGet('arnes_fisura'),
      sgis_pre_proteccion_caidas_arnes_fibra_rota: caidasGet('arnes_fibra_rota'),
      sgis_pre_proteccion_caidas_arnes_deterioro: caidasGet('arnes_deterioro'),
      sgis_pre_proteccion_caidas_arnes_manchas: caidasGet('arnes_manchas'),
      sgis_pre_proteccion_caidas_arnes_impacto: caidasGet('arnes_impacto'),
      sgis_pre_proteccion_caidas_eslinga_marca: document.getElementById('eslinga_marca').value || '',
      sgis_pre_proteccion_caidas_eslinga_modelo: document.getElementById('eslinga_modelo').value || '',
      sgis_pre_proteccion_caidas_eslinga_serie: document.getElementById('eslinga_serie').value || '',
      sgis_pre_proteccion_caidas_eslinga_lote: document.getElementById('eslinga_lote').value || '',
      sgis_pre_proteccion_caidas_eslinga_fecha_fabri: document.getElementById('eslinga_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_eslinga_fisura: caidasGet('eslinga_fisura'),
      sgis_pre_proteccion_caidas_eslinga_fibra_rota: caidasGet('eslinga_fibra_rota'),
      sgis_pre_proteccion_caidas_eslinga_deterioro: caidasGet('eslinga_deterioro'),
      sgis_pre_proteccion_caidas_eslinga_manchas: caidasGet('eslinga_manchas'),
      sgis_pre_proteccion_caidas_eslinga_impacto: caidasGet('eslinga_impacto'),
      sgis_pre_proteccion_caidas_anclaje_marca: document.getElementById('anclaje_marca').value || '',
      sgis_pre_proteccion_caidas_anclaje_modelo: document.getElementById('anclaje_modelo').value || '',
      sgis_pre_proteccion_caidas_anclaje_serie: document.getElementById('anclaje_serie').value || '',
      sgis_pre_proteccion_caidas_anclaje_lote: document.getElementById('anclaje_lote').value || '',
      sgis_pre_proteccion_caidas_anclaje_fecha_fabri: document.getElementById('anclaje_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_anclaje_fisura: caidasGet('anclaje_fisura'),
      sgis_pre_proteccion_caidas_anclaje_fibra_rota: caidasGet('anclaje_fibra_rota'),
      sgis_pre_proteccion_caidas_anclaje_deterioro: caidasGet('anclaje_deterioro'),
      sgis_pre_proteccion_caidas_anclaje_manchas: caidasGet('anclaje_manchas'),
      sgis_pre_proteccion_caidas_anclaje_impacto: caidasGet('anclaje_impacto'),
      sgis_pre_proteccion_caidas_linea_vida_marca: document.getElementById('linea_marca').value || '',
      sgis_pre_proteccion_caidas_linea_vida_modelo: document.getElementById('linea_modelo').value || '',
      sgis_pre_proteccion_caidas_linea_vida_serie: document.getElementById('linea_serie').value || '',
      sgis_pre_proteccion_caidas_linea_vida_lote: document.getElementById('linea_lote').value || '',
      sgis_pre_proteccion_caidas_linea_vida_fecha_fabri: document.getElementById('linea_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_linea_vida_fisura: caidasGet('linea_vida_fisura'),
      sgis_pre_proteccion_caidas_linea_vida_fibra_rota: caidasGet('linea_vida_fibra_rota'),
      sgis_pre_proteccion_caidas_linea_vida_deterioro: caidasGet('linea_vida_deterioro'),
      sgis_pre_proteccion_caidas_linea_vida_manchas: caidasGet('linea_vida_manchas'),
      sgis_pre_proteccion_caidas_linea_vida_impacto: caidasGet('linea_vida_impacto'),
      sgis_pre_proteccion_caidas_mosqueton_marca: document.getElementById('mosqueton_marca').value || '',
      sgis_pre_proteccion_caidas_mosqueton_modelo: document.getElementById('mosqueton_modelo').value || '',
      sgis_pre_proteccion_caidas_mosqueton_serie: document.getElementById('mosqueton_serie').value || '',
      sgis_pre_proteccion_caidas_mosqueton_lote: document.getElementById('mosqueton_lote').value || '',
      sgis_pre_proteccion_caidas_mosqueton_fecha_fabri: document.getElementById('mosqueton_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_mosqueton_fisural: caidasGet('mosqueton_fisural'),
      sgis_pre_proteccion_caidas_mosqueton_deterioro: caidasGet('mosqueton_deterioro'),
      sgis_pre_proteccion_caidas_mosqueton_manchas: caidasGet('mosqueton_manchas'),
      sgis_pre_proteccion_caidas_pretales_marca: document.getElementById('pretales_marca').value || '',
      sgis_pre_proteccion_caidas_pretales_modelo: document.getElementById('pretales_modelo').value || '',
      sgis_pre_proteccion_caidas_pretales_serie: document.getElementById('pretales_serie').value || '',
      sgis_pre_proteccion_caidas_pretales_lote: document.getElementById('pretales_lote').value || '',
      sgis_pre_proteccion_caidas_pretales_fecha_fabri: document.getElementById('pretales_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_pretales_fisura: caidasGet('pretales_fisura'),
      sgis_pre_proteccion_caidas_pretales_deterioro: caidasGet('pretales_deterioro'),
      sgis_pre_proteccion_caidas_pretales_manchas: caidasGet('pretales_manchas'),
      observacion: (document.getElementById('observacionesCaidas').value || '').trim()
    };
  }
  function validarCamposCaidas(){
    const req = [
      'arnes_fisura','arnes_fibra_rota','arnes_deterioro','arnes_manchas','arnes_impacto',
      'eslinga_fisura','eslinga_fibra_rota','eslinga_deterioro','eslinga_manchas','eslinga_impacto',
      'anclaje_fisura','anclaje_fibra_rota','anclaje_deterioro','anclaje_manchas','anclaje_impacto',
      'linea_vida_fisura','linea_vida_fibra_rota','linea_vida_deterioro','linea_vida_manchas','linea_vida_impacto',
      'mosqueton_deterioro','mosqueton_fisural','mosqueton_manchas',
      'pretales_deterioro','pretales_fisura','pretales_manchas'
    ];
    for(const k of req){ const v = caidasGet(k); if(!v){ Swal.fire('Campos incompletos','Completa todas las generalidades','warning'); return false; } }
    const hasNC = req.some(k => caidasGet(k) === 'NC');
    if(hasNC){ const obs = (document.getElementById('observacionesCaidas').value || '').trim(); if(!obs){ Swal.fire('Observaciones requeridas','Registra observaciones para los hallazgos en NC','warning'); return false; } }
    return true;
  }
  let firmaCtxCaidas, firmandoCaidas = false;
  function initFirmaCaidas(){
    const c = document.getElementById('firmaCanvasCaidas');
    firmaCtxCaidas = c.getContext('2d');
    firmaCtxCaidas.strokeStyle = '#222';
    firmaCtxCaidas.lineWidth = 2;
    const pos = (e)=>{ const r = c.getBoundingClientRect(); const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x,y}; };
    const start = (e)=>{ firmandoCaidas = true; const p = pos(e); firmaCtxCaidas.beginPath(); firmaCtxCaidas.moveTo(p.x,p.y); e.preventDefault(); };
    const move = (e)=>{ if(!firmandoCaidas) return; const p = pos(e); firmaCtxCaidas.lineTo(p.x,p.y); firmaCtxCaidas.stroke(); e.preventDefault(); };
    const end = ()=>{ firmandoCaidas = false; };
    c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
    c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
    document.getElementById('btnLimpiarFirmaCaidas').addEventListener('click', ()=>{ firmaCtxCaidas.clearRect(0,0,c.width,c.height); });
  }
  function enviarConFirmaCaidas(){
    const c = document.getElementById('firmaCanvasCaidas');
    const firma = c.toDataURL('image/png');
    const payload = construirPayloadCaidas();
    payload.firma_base64 = firma;
    fetch('/api/sgis/pre-caidas', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      .then(r=>r.json()).then(d=>{
        if(d && d.success){
          Swal.fire('Éxito','Preoperacional de control caídas registrado','success');
          const btn = document.getElementById('btnPreopCaidas'); if(btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
          const mf = document.getElementById('modalFirmaCaidas'); const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
          const me = document.getElementById('modalCaidas'); const modal2 = bootstrap.Modal.getInstance(me); if(modal2) modal2.hide();
        } else {
          Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
        }
      }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
  }
  document.getElementById('btnGuardarPreopCaidas').addEventListener('click', function(){
    if(!validarCamposCaidas()) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirmaCaidas'));
    mf.show();
    initFirmaCaidas();
  });
  document.getElementById('btnEnviarPreopCaidas').addEventListener('click', enviarConFirmaCaidas);
  function setFechaBogotaTSR(){ try{ document.getElementById('fechaBogotaTSR').textContent = new Date().toLocaleString('es-CO',{ timeZone:'America/Bogota' }); }catch(e){} }
  setFechaBogotaTSR();
  function getValTSR(n){ const el = document.querySelector('#modalTSR input[name="'+n+'"]:checked'); return el ? el.value : ''; }
  function construirPayloadTSR(){
    const payload = { observaciones: (document.getElementById('observacionesTSR').value || '').trim() };
    const actEl = document.querySelector('#modalTSR input[name="actividad_asociada"]:checked');
    payload.actividad_asociada = actEl ? actEl.value : '';
    payload.descripcion_tareas = (document.getElementById('descripcionTareasTSR').value || '').trim();
    payload.ot = (document.getElementById('otTSR')?.value || '').trim();
    payload.cuenta = (document.getElementById('cuentaTSR')?.value || '').trim();
    for(let i=1;i<=17;i++){ payload['respuesta_'+i] = getValTSR('respuesta_'+i); }
    payload.riesgo = document.getElementById('selRiesgoTSR').value || '';
    payload.peligro = document.getElementById('selPeligroTSR').value || '';
    payload.consecuencia = document.getElementById('selConsecuenciaTSR').value || '';
    payload.controles = document.getElementById('selControlTSR').value || '';
    return payload;
  }
  function validarTSR(payload){
    const otRegex = /^[0-9]{7,9}$/;
    const cuentaRegex = /^[0-9]{6,8}$/;
    if(!payload.ot || !otRegex.test(payload.ot)){
      Swal.fire('Error','OT debe ser 7-9 dígitos numéricos','error');
      return false;
    }
    if(!payload.cuenta || !cuentaRegex.test(payload.cuenta)){
      Swal.fire('Error','Cuenta debe ser 6-8 dígitos numéricos','error');
      return false;
    }
    for(let i=1;i<=17;i++){ const v = (payload['respuesta_'+i]||'').toUpperCase(); if(!v || !(['C','NC','N/A'].includes(v))){ Swal.fire('Campos incompletos','Responde todas las preguntas','warning'); return false; } }
    const anyNC = Array.from({length:17}).some((_,idx)=> (payload['respuesta_'+(idx+1)]||'').toUpperCase()==='NC');
    if(anyNC && !payload.observaciones){ Swal.fire('Observaciones requeridas','Registra observaciones para los hallazgos en NC','warning'); return false; }
    return true;
  }
  let firmaCtxTSR, firmandoTSR = false;
  function initFirmaTSR(){
    const c = document.getElementById('firmaCanvasTSR');
    firmaCtxTSR = c.getContext('2d');
    firmaCtxTSR.strokeStyle = '#222';
    firmaCtxTSR.lineWidth = 2;
    const pos = (e)=>{ const r = c.getBoundingClientRect(); const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x,y}; };
    const start = (e)=>{ firmandoTSR = true; const p = pos(e); firmaCtxTSR.beginPath(); firmaCtxTSR.moveTo(p.x,p.y); e.preventDefault(); };
    const move = (e)=>{ if(!firmandoTSR) return; const p = pos(e); firmaCtxTSR.lineTo(p.x,p.y); firmaCtxTSR.stroke(); e.preventDefault(); };
    const end = ()=>{ firmandoTSR = false; };
    c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
    c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
    document.getElementById('btnLimpiarFirmaTSR').addEventListener('click', ()=>{ firmaCtxTSR.clearRect(0,0,c.width,c.height); });
    document.getElementById('btnEnviarTSR').addEventListener('click', enviarTSR);
  }
  function resetFormularioTSR(){
    for(let i=1;i<=17;i++){
      document.querySelectorAll('#modalTSR input[name="respuesta_'+i+'"]').forEach(el=>{ el.checked = false; });
    }
    document.querySelectorAll('#modalTSR input[name="actividad_asociada"]').forEach(el=>{ el.checked = false; });
    const d1 = document.getElementById('descripcionTareasTSR'); if(d1) d1.value = '';
    const d2 = document.getElementById('observacionesTSR'); if(d2) d2.value = '';
    const d3 = document.getElementById('otTSR'); if(d3) d3.value = '';
    const d4 = document.getElementById('cuentaTSR'); if(d4) d4.value = '';
    const sr = document.getElementById('selRiesgoTSR'); if(sr) sr.value = '';
    const sp = document.getElementById('selPeligroTSR'); if(sp) sp.value = '';
    const sc = document.getElementById('selConsecuenciaTSR'); if(sc) sc.value = '';
    const sctrl = document.getElementById('selControlTSR'); if(sctrl) sctrl.value = '';
    const btn = document.getElementById('btnFirmarEnviarTSR'); if(btn){ btn.disabled = false; btn.textContent = 'Firmar y Enviar'; }
    const c = document.getElementById('firmaCanvasTSR'); if(c && firmaCtxTSR){ firmaCtxTSR.clearRect(0,0,c.width,c.height); }
  }
  function enviarTSR(){
    const c = document.getElementById('firmaCanvasTSR');
    const firma = c.toDataURL('image/png');
    const payload = construirPayloadTSR();
    if(!validarTSR(payload)) return;
    payload.firma_base64 = firma;
    fetch('/api/sgis/trabajo-seguridad-rutina', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      .then(r=>r.json()).then(d=>{
        if(d && d.success){
          Swal.fire('Éxito','Trabajo Seguro Rutinario registrado','success');
          resetFormularioTSR();
          const mf = document.getElementById('modalFirmaTSR'); const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
          fetch('/api/sgis/trabajo-seguro-rutinario/status').then(r=>r.json()).then(s=>{
            const btn = document.getElementById('btnFirmarEnviarTSR');
            if(s && s.success && s.limit_reached && btn){ btn.disabled = true; btn.textContent = 'Límite diario alcanzado (10)'; }
          }).catch(()=>{});
        } else {
          Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
        }
      }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
  }
  let tsrDataTSR = [];
  function fillSelectTSR(sel, items){ sel.innerHTML = '<option value="">Selecciona…</option>'; items.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); }
  function cargarRiesgosTSR(){
    fetch('/api/sgis/trabajo-seguridad-rutina/riesgos').then(r=>r.json()).then(d=>{
      if(d && d.success){
        tsrDataTSR = Array.isArray(d.data)? d.data : [];
        const riesgos = Array.from(new Set(tsrDataTSR.map(x=>x.riesgo).filter(Boolean)));
        const sr = document.getElementById('selRiesgoTSR');
        const sp = document.getElementById('selPeligroTSR');
        const sc = document.getElementById('selConsecuenciaTSR');
        const sctrl = document.getElementById('selControlTSR');
        fillSelectTSR(sr, riesgos);
        fillSelectTSR(sp, []);
        fillSelectTSR(sc, []);
        fillSelectTSR(sctrl, []);
        sr.addEventListener('change', function(){
          const r = this.value || '';
          const peligros = Array.from(new Set(tsrDataTSR.filter(x=>x.riesgo===r).map(x=>x.peligro).filter(Boolean)));
          fillSelectTSR(sp, peligros);
          fillSelectTSR(sc, []);
          fillSelectTSR(sctrl, []);
        });
        sp.addEventListener('change', function(){
          const r = sr.value || '';
          const p = this.value || '';
          const consecuencias = Array.from(new Set(tsrDataTSR.filter(x=>x.riesgo===r && x.peligro===p).map(x=>x.consecuencia).filter(Boolean)));
          fillSelectTSR(sc, consecuencias);
          fillSelectTSR(sctrl, []);
        });
        sc.addEventListener('change', function(){
          const r = sr.value || '';
          const p = sp.value || '';
          const c = this.value || '';
          const controles = Array.from(new Set(tsrDataTSR.filter(x=>x.riesgo===r && x.peligro===p && x.consecuencia===c).map(x=>x.controles).filter(Boolean)));
          fillSelectTSR(sctrl, controles);
        });
      }
    }).catch(()=>{});
  }
  document.getElementById('btnFirmarEnviarTSR').addEventListener('click', function(){
    const payload = construirPayloadTSR();
    if(!validarTSR(payload)) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirmaTSR'));
    mf.show();
    initFirmaTSR();
  });
  cargarRiesgosTSR();
  fetch('/api/sgis/trabajo-seguro-rutinario/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnFirmarEnviarTSR');
    if(d && d.success && d.limit_reached && btn){ btn.disabled = true; btn.textContent = 'Límite diario alcanzado (10)'; }
  }).catch(()=>{});
})
</script>
{% endblock %}
