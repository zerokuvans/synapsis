{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #1e293b 0%, #1e293b 100%) !important;">
          <h3 class="mb-0">
            <i class="fas fa-shield-halved me-2"></i>Sistema de Gestión Integrado de Seguridad (SGIS)
          </h3>
        </div>
        <div class="card-body">
          <style>
            .sgis-section{border:1px solid #e5e7eb; border-radius:.5rem; padding:1rem}
            .sgis-section.nc{border-color:#dc2626; box-shadow:0 0 0 .15rem rgba(220,38,38,.15)}
            .badge-nc{display:inline-block; color:#dc2626}
          </style>
          {% if session.get('user_role') == 'administrativo' %}
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card bg-primary text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h4 id="sgis-total-preop">0</h4>
                      <p class="mb-0">Pre-operacionales hoy</p>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-clipboard-check fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-success text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h4 id="sgis-epp-ok">0</h4>
                      <p class="mb-0">EPP en buen estado</p>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-hard-hat fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-warning text-dark">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h4 id="sgis-epp-alertas">0</h4>
                      <p class="mb-0">Alertas EPP</p>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-exclamation-triangle fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-info text-white">
                <div class="card-body">
                  <div class="d-flex justify-content-between">
                    <div>
                      <h4 id="sgis-reportes">0</h4>
                      <p class="mb-0">Reportes generados</p>
                    </div>
                    <div class="align-self-center">
                      <i class="fas fa-chart-bar fa-2x"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          {% if session.get('user_role') in ['tecnicos', 'operativo', 'sstt', 'SSTT', 'tecnico', 'Tecnico'] %}
          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="fas fa-wrench me-2"></i>Técnicos</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button id="btnPreop" type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalPreop">
                      <i class="fas fa-hard-hat me-2"></i>Pre-operacional de EPP
                    </button>
                    <button id="btnPreopEsc" type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalEscaleras" {% if not habilitar_escaleras %}disabled title="Disponible solo para APOYO CAMIONETAS"{% endif %}>
                      <i class="fas fa-stairs me-2"></i>Pre-operacional de Escaleras
                    </button>
                    <button id="btnPreopCaidas" type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modalCaidas">
                      <i class="fas fa-user-shield me-2"></i>Pre-operacional Control Caídas
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% elif session.get('user_role') == 'administrativo' %}
          <div class="row">
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="fas fa-user-tie me-2"></i>Administrativo</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <a href="/sgis/reportes" class="btn btn-outline-success">
                      <i class="fas fa-chart-line me-2"></i>Reportes SGIS
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Preoperacional -->
<div class="modal fade" id="modalPreop" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Pre-operacional de Elementos de Protección Personal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="row g-3">
            <div class="col-md-3"><small class="text-muted">Nombre</small><div>{{ session.get('user_name') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cédula</small><div>{{ session.get('user_cedula') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cargo</small><div>{{ session.get('user_role') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Fecha</small><div id="fechaBogota"></div></div>
          </div>
        </div>
        <hr>
        <form id="formPreop">
          <div id="sec-casco" class="mb-3 sgis-section">
            <h6 class="mb-1"><i class="fas  me-2"></i>Casco</h6>
            <p class="text-muted small mb-3">Conforme a los hallazgos de inspección registre los siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</p>
            <div id="nc-casco" class="badge-nc d-none mb-2">NC seleccionado</div>
            <div class="row align-items-start g-3">
              <div class="col-md-4">
                <img class="img-fluid rounded border" alt="Casco"
                     src="{{ url_for('static', filename='img/sgis/casco.jpg') }}"
                     onerror="this.src='{{ url_for('static', filename='img/sgis/casco.svg') }}'">
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Estado General</label>
                    <div>
                      <label class="me-2"><input type="radio" name="casco_estado_general" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="casco_estado_general" value="NC"> NC</label>
                      <label><input type="radio" name="casco_estado_general" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Uso inferior a 2 Años</label>
                    <div>
                      <label class="me-2"><input type="radio" name="casco_uso_menor_2_anios" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="casco_uso_menor_2_anios" value="NC"> NC</label>
                      <label><input type="radio" name="casco_uso_menor_2_anios" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Estado del Talifete</label>
                    <div>
                      <label class="me-2"><input type="radio" name="casco_estado_talifete" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="casco_estado_talifete" value="NC"> NC</label>
                      <label><input type="radio" name="casco_estado_talifete" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Puntos de anclaje del barbuquejo</label>
                    <div>
                      <label class="me-2"><input type="radio" name="casco_puntos_anclaje_barbuquejo" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="casco_puntos_anclaje_barbuquejo" value="NC"> NC</label>
                      <label><input type="radio" name="casco_puntos_anclaje_barbuquejo" value="N/A"> N/A</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-3">
          </div>

          <div id="sec-barbuquejo" class="mb-3 sgis-section">
            <h6 class="mb-1"><i class="fas  me-2"></i>Barbuquejo</h6>
            <p class="text-muted small mb-3">Conforme a los hallazgos de inspección registre los siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</p>
            <div id="nc-barbuquejo" class="badge-nc d-none mb-2">NC seleccionado</div>
            <div class="row align-items-start g-3">
              <div class="col-md-4">
                <img class="img-fluid rounded border" alt="Barbuquejo"
                     src="{{ url_for('static', filename='img/sgis/barbuquejo.jpg') }}"
                     onerror="this.src='{{ url_for('static', filename='img/sgis/barbuquejo.svg') }}'">
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Estado puntos de apoyo</label>
                    <div>
                      <label class="me-2"><input type="radio" name="barbuquejo_puntos_apoyo" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="barbuquejo_puntos_apoyo" value="NC"> NC</label>
                      <label><input type="radio" name="barbuquejo_puntos_apoyo" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado sujetador del mentón</label>
                    <div>
                      <label class="me-2"><input type="radio" name="barbuquejo_sujetador_menton" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="barbuquejo_sujetador_menton" value="NC"> NC</label>
                      <label><input type="radio" name="barbuquejo_sujetador_menton" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado costuras y correas</label>
                    <div>
                      <label class="me-2"><input type="radio" name="barbuquejo_costuras_correas" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="barbuquejo_costuras_correas" value="NC"> NC</label>
                      <label><input type="radio" name="barbuquejo_costuras_correas" value="N/A"> N/A</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-3">
          </div>

          <div id="sec-guantes" class="mb-3 sgis-section">
            <h6 class="mb-1"><i class="fas  me-2"></i>Guantes</h6>
            <p class="text-muted small mb-3">Conforme a los hallazgos de inspección registre los siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</p>
            <div id="nc-guantes" class="badge-nc d-none mb-2">NC seleccionado</div>
            <div class="row align-items-start g-3">
              <div class="col-md-4">
                <img class="img-fluid rounded border" alt="Guantes"
                     src="{{ url_for('static', filename='img/sgis/guantes.jpg') }}"
                     onerror="this.src='{{ url_for('static', filename='img/sgis/guantes.svg') }}'">
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Estado costuras</label>
                    <div>
                      <label class="me-2"><input type="radio" name="guantes_costuras" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="guantes_costuras" value="NC"> NC</label>
                      <label><input type="radio" name="guantes_costuras" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado refuerzo palma</label>
                    <div>
                      <label class="me-2"><input type="radio" name="guantes_refuerzo_palma" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="guantes_refuerzo_palma" value="NC"> NC</label>
                      <label><input type="radio" name="guantes_refuerzo_palma" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado General (Sin rotos)</label>
                    <div>
                      <label class="me-2"><input type="radio" name="guantes_estado_general" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="guantes_estado_general" value="NC"> NC</label>
                      <label><input type="radio" name="guantes_estado_general" value="N/A"> N/A</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-3">
          </div>

          <div id="sec-monogafas" class="mb-3 sgis-section">
            <h6 class="mb-1"><i class="fas me-2"></i>Monogafas</h6>
            <p class="text-muted small mb-3">Conforme a los hallazgos de inspección registre los siguiente: "C - Cumple" "NC - No Cumple" "N/A - No Aplica".</p>
            <div id="nc-monogafas" class="badge-nc d-none mb-2">NC seleccionado</div>
            <div class="row align-items-start g-3">
              <div class="col-md-4">
                <img class="img-fluid rounded border" alt="Monogafas"
                     src="{{ url_for('static', filename='img/sgis/monogafas.jpg') }}"
                     onerror="this.src='{{ url_for('static', filename='img/sgis/monogafas.svg') }}'">
              </div>
              <div class="col-md-8">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Estado de lentes (Sin rayones)</label>
                    <div>
                      <label class="me-2"><input type="radio" name="monogafas_lentes" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="monogafas_lentes" value="NC"> NC</label>
                      <label><input type="radio" name="monogafas_lentes" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado patillas ajustables</label>
                    <div>
                      <label class="me-2"><input type="radio" name="monogafas_patillas_ajustables" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="monogafas_patillas_ajustables" value="NC"> NC</label>
                      <label><input type="radio" name="monogafas_patillas_ajustables" value="N/A"> N/A</label>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Estado puente de nariz</label>
                    <div>
                      <label class="me-2"><input type="radio" name="monogafas_puente_nariz" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="monogafas_puente_nariz" value="NC"> NC</label>
                      <label><input type="radio" name="monogafas_puente_nariz" value="N/A"> N/A</label>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <hr class="my-3">
          </div>

          <div class="mb-3">
            <label class="form-label">Observaciones</label>
            <small class="text-muted d-block mb-2">Si existen hallazgos en "NC - No Cumple", por favor registre las OBSERVACIONES.</small>
            <textarea id="observaciones" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button id="btnGuardarPreop" type="button" class="btn btn-primary">Guardar preoperacional</button>
      </div>
    </div>
  </div>
  </div>

<!-- Modal Firma -->
<div class="modal fade" id="modalFirma" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvas" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirma" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarPreop" type="button" class="btn btn-success btn-sm">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Escaleras -->
<div class="modal fade" id="modalEscaleras" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-stairs me-2"></i>Pre-operacional de Escaleras</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="row g-3">
            <div class="col-md-3"><small class="text-muted">Nombre</small><div>{{ session.get('user_name') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cédula</small><div>{{ session.get('user_cedula') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cargo</small><div>{{ session.get('user_role') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Mes</small><div id="mesActualEsc"></div></div>
          </div>
        </div>
        <hr>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label">Marca de escalera</label>
            <input type="text" id="marcaEscaleraEsc" class="form-control" placeholder="Marca">
          </div>
          <div class="col-md-6">
            <label class="form-label">Número de peldaños</label>
            <input type="number" id="cantPeldanosEsc" min="0" class="form-control" placeholder="Cantidad">
          </div>
        </div>
        <div class="mb-3">
          <h6 class="mb-2">Generalidades</h6>
          <div class="row g-3 align-items-start">
            <div class="col-md-4 text-center">
              <img class="img-fluid border rounded" alt="Escalera"
                   src="{{ url_for('static', filename='img/sgis/escalera.jpeg') }}"
                   onerror="this.style.display='none'"
                   style="max-height:320px; object-fit:contain;">
            </div>
            <div class="col-md-8">
              <ul class="mb-0">
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Larguero o perfil</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_larguero" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_larguero" value="NC"> NC</label>
                    <label><input type="radio" name="esc_larguero" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Peldaños</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_peldanos" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_peldanos" value="NC"> NC</label>
                    <label><input type="radio" name="esc_peldanos" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Unión de peldaños y largueros</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_union" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_union" value="NC"> NC</label>
                    <label><input type="radio" name="esc_union" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Zapatas antideslizantes</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_zapatas" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_zapatas" value="NC"> NC</label>
                    <label><input type="radio" name="esc_zapatas" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Base de apoyo a poste</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_base_apoyo" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_base_apoyo" value="NC"> NC</label>
                    <label><input type="radio" name="esc_base_apoyo" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Piezas de ajuste</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_piezas_ajuste" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_piezas_ajuste" value="NC"> NC</label>
                    <label><input type="radio" name="esc_piezas_ajuste" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Ganchos Trabapeldaños y uñas de seguridad</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_ganchos" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_ganchos" value="NC"> NC</label>
                    <label><input type="radio" name="esc_ganchos" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Cuerda y polea</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_cuerda_polea" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_cuerda_polea" value="NC"> NC</label>
                    <label><input type="radio" name="esc_cuerda_polea" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-2">
                  <label class="form-label fw-bold mb-1">Guías externas para unión de largueros</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_guias_externas" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_guias_externas" value="NC"> NC</label>
                    <label><input type="radio" name="esc_guias_externas" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mb-0">
                  <label class="form-label fw-bold mb-1">Señalización de seguridad en peldaño</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_senal_seguridad" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_senal_seguridad" value="NC"> NC</label>
                    <label><input type="radio" name="esc_senal_seguridad" value="N/A"> N/A</label>
                  </div>
                </li>
                <li class="mt-2 mb-0">
                  <label class="form-label fw-bold mb-1">Aseo de escalera</label>
                  <div>
                    <label class="me-2"><input type="radio" name="esc_aseo_escalera" value="C"> C</label>
                    <label class="me-2"><input type="radio" name="esc_aseo_escalera" value="NC"> NC</label>
                    <label><input type="radio" name="esc_aseo_escalera" value="N/A"> N/A</label>
                  </div>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Observaciones</label>
          <textarea id="observacionesEsc" class="form-control" rows="3" placeholder="Observaciones"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button id="btnGuardarPreopEsc" type="button" class="btn btn-primary">Guardar preoperacional</button>
      </div>
    </div>
  </div>
  </div>

<!-- Modal Firma Escaleras -->
<div class="modal fade" id="modalFirmaEsc" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvasEsc" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirmaEsc" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarPreopEsc" type="button" class="btn btn-success btn-sm">Enviar</button>
        </div>
      </div>
    </div>
  </div>
  </div>

<!-- Modal Preoperacional Control Caídas -->
<div class="modal fade" id="modalCaidas" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-user-shield me-2"></i>Pre-operacional Control de Caídas</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <div class="row g-3">
            <div class="col-md-3"><small class="text-muted">Nombre</small><div>{{ session.get('user_name') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cédula</small><div>{{ session.get('user_cedula') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Cargo</small><div>{{ session.get('user_role') }}</div></div>
            <div class="col-md-3"><small class="text-muted">Fecha</small><div id="fechaBogotaCaidas"></div></div>
          </div>
        </div>
        <hr>
        <form id="formCaidas">
          <div class="mb-4 caidas-step" data-step="1">
            <h6 class="mb-2">Arnés</h6>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="arnes_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="arnes_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="arnes_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="arnes_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="arnes_fecha_fabri"></div>
            </div>
            <ul class="mb-0">
              <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                <div><label class="me-2"><input type="radio" name="arnes_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_fisura" value="NC"> NC</label><label><input type="radio" name="arnes_fisura" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Fibras rotas o grietas en reatas, cintas o cuerdas.</label>
                <div><label class="me-2"><input type="radio" name="arnes_fibra_rota" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_fibra_rota" value="NC"> NC</label><label><input type="radio" name="arnes_fibra_rota" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                <div><label class="me-2"><input type="radio" name="arnes_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_deterioro" value="NC"> NC</label><label><input type="radio" name="arnes_deterioro" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Manchas brillantes o duras.</label>
                <div><label class="me-2"><input type="radio" name="arnes_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_manchas" value="NC"> NC</label><label><input type="radio" name="arnes_manchas" value="N/A"> N/A</label></div></li>
              <li class="mb-0"><label class="form-label">Indicador de impacto.</label>
                <div><label class="me-2"><input type="radio" name="arnes_impacto" value="C"> C</label><label class="me-2"><input type="radio" name="arnes_impacto" value="NC"> NC</label><label><input type="radio" name="arnes_impacto" value="N/A"> N/A</label></div></li>
            </ul>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="2">
            <h6 class="mb-2">Eslinga</h6>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="eslinga_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="eslinga_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="eslinga_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="eslinga_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="eslinga_fecha_fabri"></div>
            </div>
            <ul class="mb-0">
              <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                <div><label class="me-2"><input type="radio" name="eslinga_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_fisura" value="NC"> NC</label><label><input type="radio" name="eslinga_fisura" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Fibras rotas o grietas en reatas, cintas o cuerdas.</label>
                <div><label class="me-2"><input type="radio" name="eslinga_fibra_rota" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_fibra_rota" value="NC"> NC</label><label><input type="radio" name="eslinga_fibra_rota" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                <div><label class="me-2"><input type="radio" name="eslinga_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_deterioro" value="NC"> NC</label><label><input type="radio" name="eslinga_deterioro" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Manchas brillantes o duras.</label>
                <div><label class="me-2"><input type="radio" name="eslinga_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_manchas" value="NC"> NC</label><label><input type="radio" name="eslinga_manchas" value="N/A"> N/A</label></div></li>
              <li class="mb-0"><label class="form-label">Indicador de impacto.</label>
                <div><label class="me-2"><input type="radio" name="eslinga_impacto" value="C"> C</label><label class="me-2"><input type="radio" name="eslinga_impacto" value="NC"> NC</label><label><input type="radio" name="eslinga_impacto" value="N/A"> N/A</label></div></li>
            </ul>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="3">
            <h6 class="mb-2">Anclaje Portátil (Tie-Off)</h6>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="anclaje_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="anclaje_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="anclaje_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="anclaje_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="anclaje_fecha_fabri"></div>
            </div>
            <ul class="mb-0">
              <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                <div><label class="me-2"><input type="radio" name="anclaje_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_fisura" value="NC"> NC</label><label><input type="radio" name="anclaje_fisura" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Fibras rotas o grietas en reatas, cintas o cuerdas.</label>
                <div><label class="me-2"><input type="radio" name="anclaje_fibra_rota" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_fibra_rota" value="NC"> NC</label><label><input type="radio" name="anclaje_fibra_rota" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                <div><label class="me-2"><input type="radio" name="anclaje_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_deterioro" value="NC"> NC</label><label><input type="radio" name="anclaje_deterioro" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Manchas brillantes o duras.</label>
                <div><label class="me-2"><input type="radio" name="anclaje_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_manchas" value="NC"> NC</label><label><input type="radio" name="anclaje_manchas" value="N/A"> N/A</label></div></li>
              <li class="mb-0"><label class="form-label">Indicador de impacto.</label>
                <div><label class="me-2"><input type="radio" name="anclaje_impacto" value="C"> C</label><label class="me-2"><input type="radio" name="anclaje_impacto" value="NC"> NC</label><label><input type="radio" name="anclaje_impacto" value="N/A"> N/A</label></div></li>
            </ul>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="4">
            <h6 class="mb-2">Línea de Vida</h6>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="linea_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="linea_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="linea_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="linea_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="linea_fecha_fabri"></div>
            </div>
            <ul class="mb-0">
              <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                <div><label class="me-2"><input type="radio" name="linea_vida_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_fisura" value="NC"> NC</label><label><input type="radio" name="linea_vida_fisura" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Fibras rotas o grietas en reatas, cintas o cuerdas.</label>
                <div><label class="me-2"><input type="radio" name="linea_vida_fibra_rota" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_fibra_rota" value="NC"> NC</label><label><input type="radio" name="linea_vida_fibra_rota" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                <div><label class="me-2"><input type="radio" name="linea_vida_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_deterioro" value="NC"> NC</label><label><input type="radio" name="linea_vida_deterioro" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Manchas brillantes o duras.</label>
                <div><label class="me-2"><input type="radio" name="linea_vida_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_manchas" value="NC"> NC</label><label><input type="radio" name="linea_vida_manchas" value="N/A"> N/A</label></div></li>
              <li class="mb-0"><label class="form-label">Indicador de impacto.</label>
                <div><label class="me-2"><input type="radio" name="linea_vida_impacto" value="C"> C</label><label class="me-2"><input type="radio" name="linea_vida_impacto" value="NC"> NC</label><label><input type="radio" name="linea_vida_impacto" value="N/A"> N/A</label></div></li>
            </ul>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="5">
            <h6 class="mb-2">Mosquetón</h6>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="mosqueton_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="mosqueton_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="mosqueton_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="mosqueton_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="mosqueton_fecha_fabri"></div>
            </div>
            <ul class="mb-0">
              <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                <div><label class="me-2"><input type="radio" name="mosqueton_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="mosqueton_deterioro" value="NC"> NC</label><label><input type="radio" name="mosqueton_deterioro" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                <div><label class="me-2"><input type="radio" name="mosqueton_fisural" value="C"> C</label><label class="me-2"><input type="radio" name="mosqueton_fisural" value="NC"> NC</label><label><input type="radio" name="mosqueton_fisural" value="N/A"> N/A</label></div></li>
              <li class="mb-0"><label class="form-label">Manchas brillantes o duras.</label>
                <div><label class="me-2"><input type="radio" name="mosqueton_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="mosqueton_manchas" value="NC"> NC</label><label><input type="radio" name="mosqueton_manchas" value="N/A"> N/A</label></div></li>
            </ul>
            <div class="text-end mt-3"><button type="button" class="btn btn-primary btn-next-caidas">Siguiente</button></div>
          </div>
          <div class="mb-4 caidas-step" data-step="6">
            <h6 class="mb-2">Pretales</h6>
            <div class="row g-3 mb-2">
              <div class="col-md-2"><label class="form-label">Marca</label><input type="text" class="form-control" id="pretales_marca"></div>
              <div class="col-md-2"><label class="form-label">Modelo</label><input type="text" class="form-control" id="pretales_modelo"></div>
              <div class="col-md-2"><label class="form-label">No Serie</label><input type="text" class="form-control" id="pretales_serie"></div>
              <div class="col-md-2"><label class="form-label">No Lote</label><input type="text" class="form-control" id="pretales_lote"></div>
              <div class="col-md-2"><label class="form-label">Fecha fabricación</label><input type="date" class="form-control" id="pretales_fecha_fabri"></div>
            </div>
            <ul class="mb-0">
              <li class="mb-2"><label class="form-label">Deterioro, desgaste y abrasión general del elemento.</label>
                <div><label class="me-2"><input type="radio" name="pretales_deterioro" value="C"> C</label><label class="me-2"><input type="radio" name="pretales_deterioro" value="NC"> NC</label><label><input type="radio" name="pretales_deterioro" value="N/A"> N/A</label></div></li>
              <li class="mb-2"><label class="form-label">Fisura, óxido, Rotura, Deformación en hebillas y Argollas.</label>
                <div><label class="me-2"><input type="radio" name="pretales_fisura" value="C"> C</label><label class="me-2"><input type="radio" name="pretales_fisura" value="NC"> NC</label><label><input type="radio" name="pretales_fisura" value="N/A"> N/A</label></div></li>
              <li class="mb-0"><label class="form-label">Manchas brillantes o duras.</label>
                <div><label class="me-2"><input type="radio" name="pretales_manchas" value="C"> C</label><label class="me-2"><input type="radio" name="pretales_manchas" value="NC"> NC</label><label><input type="radio" name="pretales_manchas" value="N/A"> N/A</label></div></li>
            </ul>
          </div>
          <div class="mb-3">
            <label class="form-label">Observaciones</label>
            <textarea id="observacionesCaidas" class="form-control" rows="3" placeholder="Observaciones"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button id="btnGuardarPreopCaidas" type="button" class="btn btn-primary" style="display:none">Guardar preoperacional</button>
      </div>
    </div>
  </div>
  </div>

<!-- Modal Firma Caídas -->
<div class="modal fade" id="modalFirmaCaidas" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvasCaidas" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirmaCaidas" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarPreopCaidas" type="button" class="btn btn-success btn-sm">Enviar</button>
        </div>
      </div>
    </div>
  </div>
  </div>

<script>
function setFechaBogota(){
  const nowStr = new Date().toLocaleString('es-CO', { timeZone: 'America/Bogota' });
  const el = document.getElementById('fechaBogota');
  if(el) el.textContent = nowStr;
}
function getRadio(name){
  const els = document.querySelectorAll(`input[name="${name}"]`);
  for(const e of els){ if(e.checked) return e.value; }
  return null;
}
function validarCampos(){
  const req = [
    'casco_estado_general','casco_uso_menor_2_anios','casco_estado_talifete','casco_puntos_anclaje_barbuquejo',
    'barbuquejo_puntos_apoyo','barbuquejo_sujetador_menton','barbuquejo_costuras_correas',
    'guantes_costuras','guantes_refuerzo_palma','guantes_estado_general',
    'monogafas_lentes','monogafas_patillas_ajustables','monogafas_puente_nariz'
  ];
  for(const n of req){
    const v = getRadio(n);
    if(!v){
      Swal.fire('Campos incompletos', 'Completa todas las secciones', 'warning');
      return false;
    }
  }
  let hasNC = false;
  for(const n of req){
    if(getRadio(n) === 'NC'){ hasNC = true; break; }
  }
  if(hasNC){
    const obs = (document.getElementById('observaciones').value || '').trim();
    if(!obs){
      Swal.fire('Observaciones requeridas', 'Registra observaciones para los hallazgos en NC', 'warning');
      return false;
    }
  }
  return true;
}
function recolectar(){
  return {
    casco_estado_general: getRadio('casco_estado_general'),
    casco_uso_menor_2_anios: getRadio('casco_uso_menor_2_anios'),
    casco_estado_talifete: getRadio('casco_estado_talifete'),
    casco_puntos_anclaje_barbuquejo: getRadio('casco_puntos_anclaje_barbuquejo'),
    barbuquejo_puntos_apoyo: getRadio('barbuquejo_puntos_apoyo'),
    barbuquejo_sujetador_menton: getRadio('barbuquejo_sujetador_menton'),
    barbuquejo_costuras_correas: getRadio('barbuquejo_costuras_correas'),
    guantes_costuras: getRadio('guantes_costuras'),
    guantes_refuerzo_palma: getRadio('guantes_refuerzo_palma'),
    guantes_estado_general: getRadio('guantes_estado_general'),
    monogafas_lentes: getRadio('monogafas_lentes'),
    monogafas_patillas_ajustables: getRadio('monogafas_patillas_ajustables'),
    monogafas_puente_nariz: getRadio('monogafas_puente_nariz'),
    observaciones: document.getElementById('observaciones').value || ''
  };
}
function calcSectionNC(section){
  if(section==='casco'){
    return ['casco_estado_general','casco_uso_menor_2_anios','casco_estado_talifete','casco_puntos_anclaje_barbuquejo'].some(n=>getRadio(n)==='NC');
  } else if(section==='barbuquejo'){
    return ['barbuquejo_puntos_apoyo','barbuquejo_sujetador_menton','barbuquejo_costuras_correas'].some(n=>getRadio(n)==='NC');
  } else if(section==='guantes'){
    return ['guantes_costuras','guantes_refuerzo_palma','guantes_estado_general'].some(n=>getRadio(n)==='NC');
  } else if(section==='monogafas'){
    return ['monogafas_lentes','monogafas_patillas_ajustables','monogafas_puente_nariz'].some(n=>getRadio(n)==='NC');
  }
  return false;
}
function updateSectionUI(section){
  const hasNC = calcSectionNC(section);
  const block = document.getElementById('sec-'+section);
  const badge = document.getElementById('nc-'+section);
  if(block){ block.classList.toggle('nc', !!hasNC); }
  if(badge){ badge.classList.toggle('d-none', !hasNC); }
}
let firmaCtx, firmando = false;
function initFirma(){
  const c = document.getElementById('firmaCanvas');
  firmaCtx = c.getContext('2d');
  firmaCtx.strokeStyle = '#222';
  firmaCtx.lineWidth = 2;
  const pos = (e)=>{
    const r = c.getBoundingClientRect();
    const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left;
    const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top;
    return {x,y};
  };
  const start = (e)=>{ firmando = true; const p = pos(e); firmaCtx.beginPath(); firmaCtx.moveTo(p.x,p.y); e.preventDefault(); };
  const move = (e)=>{ if(!firmando) return; const p = pos(e); firmaCtx.lineTo(p.x,p.y); firmaCtx.stroke(); e.preventDefault(); };
  const end = ()=>{ firmando = false; };
  c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
  c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
  document.getElementById('btnLimpiarFirma').addEventListener('click', ()=>{ firmaCtx.clearRect(0,0,c.width,c.height); });
}
function enviarConFirma(){
  const c = document.getElementById('firmaCanvas');
  const firma = c.toDataURL('image/png');
  const payload = recolectar();
  payload.firma_base64 = firma;
  const req = [
    'casco_estado_general','casco_uso_menor_2_anios','casco_estado_talifete','casco_puntos_anclaje_barbuquejo',
    'barbuquejo_puntos_apoyo','barbuquejo_sujetador_menton','barbuquejo_costuras_correas',
    'guantes_costuras','guantes_refuerzo_palma','guantes_estado_general',
    'monogafas_lentes','monogafas_patillas_ajustables','monogafas_puente_nariz'
  ];
  let hasNC = false;
  for(const n of req){ if(payload[n] === 'NC'){ hasNC = true; break; } }
  if(hasNC){
    const obs = (payload.observaciones || '').trim();
    if(!obs){
      Swal.fire('Observaciones requeridas', 'Registra observaciones para los hallazgos en NC', 'warning');
      return;
    }
  }
  fetch('/api/sgis/pre-proteccion-personal', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  }).then(r=>r.json()).then(d=>{
    if(d && d.success){
      Swal.fire('Éxito','Preoperacional registrado','success');
      const btn = document.getElementById('btnPreop');
      if(btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
      const mf = document.getElementById('modalFirma');
      const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
      const mp = document.getElementById('modalPreop');
      const modal2 = bootstrap.Modal.getInstance(mp); if(modal2) modal2.hide();
    } else {
      Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
    }
  }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
}
document.addEventListener('DOMContentLoaded', function(){
  {% if session.get('user_role') == 'administrativo' %}
  fetch('/api/sgis/dashboard-stats').then(r=>r.json()).then(d=>{
    if(d && d.success){
      document.getElementById('sgis-total-preop').textContent = d.data.total_preop || 0;
      document.getElementById('sgis-epp-ok').textContent = d.data.epp_ok || 0;
      document.getElementById('sgis-epp-alertas').textContent = d.data.epp_alertas || 0;
      document.getElementById('sgis-reportes').textContent = d.data.reportes || 0;
    }
  }).catch(()=>{});
  {% endif %}
  fetch('/api/sgis/pre-proteccion-personal/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnPreop');
    if(d && d.success && d.already_today && btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
  }).catch(()=>{});
  setFechaBogota();
  document.getElementById('btnGuardarPreop').addEventListener('click', function(){
    if(!validarCampos()) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirma'));
    mf.show();
    initFirma();
  });
  document.getElementById('btnEnviarPreop').addEventListener('click', enviarConFirma);
  function escGet(name){ const el = document.querySelector('input[name="'+name+'"]:checked'); return el ? el.value : ''; }
  function construirPayloadEsc(){
    return {
      larguero: escGet('esc_larguero'),
      peldanos: escGet('esc_peldanos'),
      union: escGet('esc_union'),
      zapatas: escGet('esc_zapatas'),
      base_apoyo: escGet('esc_base_apoyo'),
      piezas_ajuste: escGet('esc_piezas_ajuste'),
      ganchos: escGet('esc_ganchos'),
      cuerda_polea: escGet('esc_cuerda_polea'),
      guias_externas: escGet('esc_guias_externas'),
      senal_seguridad: escGet('esc_senal_seguridad'),
      aseo_escalera: escGet('esc_aseo_escalera'),
      marca: (document.getElementById('marcaEscaleraEsc').value || '').trim(),
      cant_peldano: parseInt(document.getElementById('cantPeldanosEsc').value || '0', 10),
      observacion: (document.getElementById('observacionesEsc').value || '').trim()
    };
  }
  function validarCamposEsc(){
    const req = ['larguero','peldanos','union','zapatas','base_apoyo','piezas_ajuste','ganchos','cuerda_polea','guias_externas','senal_seguridad','aseo_escalera'];
    const p = construirPayloadEsc();
    for(const k of req){ if(!p[k] || !(['C','NC','N/A'].includes(p[k]))){ Swal.fire('Campos incompletos','Completa todas las generalidades','warning'); return false; } }
    const hasNC = req.some(k => p[k] === 'NC');
    if(hasNC && !p.observacion){ Swal.fire('Observaciones requeridas','Registra observaciones para los hallazgos en NC','warning'); return false; }
    return true;
  }
  let firmaCtxEsc, firmandoEsc = false;
  function initFirmaEsc(){
    const c = document.getElementById('firmaCanvasEsc');
    firmaCtxEsc = c.getContext('2d');
    firmaCtxEsc.strokeStyle = '#222';
    firmaCtxEsc.lineWidth = 2;
    const pos = (e)=>{ const r = c.getBoundingClientRect(); const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x,y}; };
    const start = (e)=>{ firmandoEsc = true; const p = pos(e); firmaCtxEsc.beginPath(); firmaCtxEsc.moveTo(p.x,p.y); e.preventDefault(); };
    const move = (e)=>{ if(!firmandoEsc) return; const p = pos(e); firmaCtxEsc.lineTo(p.x,p.y); firmaCtxEsc.stroke(); e.preventDefault(); };
    const end = ()=>{ firmandoEsc = false; };
    c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
    c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
    document.getElementById('btnLimpiarFirmaEsc').addEventListener('click', ()=>{ firmaCtxEsc.clearRect(0,0,c.width,c.height); });
  }
  function enviarConFirmaEsc(){
    const c = document.getElementById('firmaCanvasEsc');
    const firma = c.toDataURL('image/png');
    const payload = construirPayloadEsc();
    if(!validarCamposEsc()) return;
    payload.firma_base64 = firma;
    fetch('/api/sgis/pre-escaleras', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      .then(r=>r.json()).then(d=>{
        if(d && d.success){
          Swal.fire('Éxito','Preoperacional de escaleras registrado','success');
          const btn = document.getElementById('btnPreopEsc'); if(btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
          const mf = document.getElementById('modalFirmaEsc'); const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
          const me = document.getElementById('modalEscaleras'); const modal2 = bootstrap.Modal.getInstance(me); if(modal2) modal2.hide();
        } else {
          Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
        }
      }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
  }
  document.getElementById('btnGuardarPreopEsc').addEventListener('click', function(){
    if(!validarCamposEsc()) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirmaEsc'));
    mf.show();
    initFirmaEsc();
  });
  document.getElementById('btnEnviarPreopEsc').addEventListener('click', enviarConFirmaEsc);
  fetch('/api/sgis/pre-escaleras/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnPreopEsc');
    if(d && d.success && d.already_today && btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
  }).catch(()=>{});
  fetch('/api/sgis/pre-caidas/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnPreopCaidas');
    if(d && d.success && d.already_today && btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
  }).catch(()=>{});
  try { const d = new Date(); const m = String(d.getMonth()+1).padStart(2,'0'); document.getElementById('mesActualEsc').textContent = `${d.getFullYear()}-${m}`; } catch(e) {}
  try {
    const params = new URLSearchParams(window.location.search);
    if(params.get('open') === 'preop'){
      const mp = new bootstrap.Modal(document.getElementById('modalPreop'));
      mp.show();
    }
  } catch(e) {}
  ['casco','barbuquejo','guantes','monogafas'].forEach(updateSectionUI);
  document.querySelectorAll('input[type="radio"]').forEach(el=>{
    el.addEventListener('change', ()=>{
      const n = el.name;
      if(n.startsWith('casco_')) updateSectionUI('casco');
      else if(n.startsWith('barbuquejo_')) updateSectionUI('barbuquejo');
      else if(n.startsWith('guantes_')) updateSectionUI('guantes');
      else if(n.startsWith('monogafas_')) updateSectionUI('monogafas');
    });
  });
  function setFechaBogotaCaidas(){
    try{ document.getElementById('fechaBogotaCaidas').textContent = new Date().toLocaleString('es-CO',{ timeZone:'America/Bogota' }); }catch(e){}
  }
  setFechaBogotaCaidas();
  const caidasSteps = Array.from(document.querySelectorAll('#modalCaidas .caidas-step'));
  let caidasStepIndex = 0;
  function showCaidasStep(i){
    caidasSteps.forEach((s,idx)=>{ s.style.display = idx===i ? 'block' : 'none'; });
    const saveBtn = document.getElementById('btnGuardarPreopCaidas');
    if(saveBtn) saveBtn.style.display = i === caidasSteps.length - 1 ? 'inline-block' : 'none';
  }
  showCaidasStep(0);
  function validarSeccionCaidas(idx){
    const reqs = [
      ['arnes_fisura','arnes_fibra_rota','arnes_deterioro','arnes_manchas','arnes_impacto'],
      ['eslinga_fisura','eslinga_fibra_rota','eslinga_deterioro','eslinga_manchas','eslinga_impacto'],
      ['anclaje_fisura','anclaje_fibra_rota','anclaje_deterioro','anclaje_manchas','anclaje_impacto'],
      ['linea_vida_fisura','linea_vida_fibra_rota','linea_vida_deterioro','linea_vida_manchas','linea_vida_impacto'],
      ['mosqueton_deterioro','mosqueton_fisural','mosqueton_manchas'],
      ['pretales_deterioro','pretales_fisura','pretales_manchas']
    ];
    const current = reqs[idx] || [];
    for(const k of current){ const v = caidasGet(k); if(!v){ Swal.fire('Campos incompletos','Completa la sección actual','warning'); return false; } }
    return true;
  }
  document.querySelectorAll('#modalCaidas .btn-next-caidas').forEach(btn=>{
    btn.addEventListener('click', function(){
      const idx = caidasSteps.findIndex(s=>s.contains(btn));
      if(idx === -1) return;
      if(!validarSeccionCaidas(idx)) return;
      const next = idx + 1;
      if(next < caidasSteps.length){ caidasStepIndex = next; showCaidasStep(next); }
    });
  });
  function caidasGet(name){ const el = document.querySelector('input[name="'+name+'"]:checked'); return el ? el.value : ''; }
  function construirPayloadCaidas(){
    return {
      sgis_pre_proteccion_caidas_arnes_marca: document.getElementById('arnes_marca').value || '',
      sgis_pre_proteccion_caidas_arnes_modelo: document.getElementById('arnes_modelo').value || '',
      sgis_pre_proteccion_caidas_arnes_serie: document.getElementById('arnes_serie').value || '',
      sgis_pre_proteccion_caidas_arnes_lote: document.getElementById('arnes_lote').value || '',
      sgis_pre_proteccion_caidas_arnes_fecha_fabri: document.getElementById('arnes_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_arnes_fisura: caidasGet('arnes_fisura'),
      sgis_pre_proteccion_caidas_arnes_fibra_rota: caidasGet('arnes_fibra_rota'),
      sgis_pre_proteccion_caidas_arnes_deterioro: caidasGet('arnes_deterioro'),
      sgis_pre_proteccion_caidas_arnes_manchas: caidasGet('arnes_manchas'),
      sgis_pre_proteccion_caidas_arnes_impacto: caidasGet('arnes_impacto'),
      sgis_pre_proteccion_caidas_eslinga_marca: document.getElementById('eslinga_marca').value || '',
      sgis_pre_proteccion_caidas_eslinga_modelo: document.getElementById('eslinga_modelo').value || '',
      sgis_pre_proteccion_caidas_eslinga_serie: document.getElementById('eslinga_serie').value || '',
      sgis_pre_proteccion_caidas_eslinga_lote: document.getElementById('eslinga_lote').value || '',
      sgis_pre_proteccion_caidas_eslinga_fecha_fabri: document.getElementById('eslinga_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_eslinga_fisura: caidasGet('eslinga_fisura'),
      sgis_pre_proteccion_caidas_eslinga_fibra_rota: caidasGet('eslinga_fibra_rota'),
      sgis_pre_proteccion_caidas_eslinga_deterioro: caidasGet('eslinga_deterioro'),
      sgis_pre_proteccion_caidas_eslinga_manchas: caidasGet('eslinga_manchas'),
      sgis_pre_proteccion_caidas_eslinga_impacto: caidasGet('eslinga_impacto'),
      sgis_pre_proteccion_caidas_anclaje_marca: document.getElementById('anclaje_marca').value || '',
      sgis_pre_proteccion_caidas_anclaje_modelo: document.getElementById('anclaje_modelo').value || '',
      sgis_pre_proteccion_caidas_anclaje_serie: document.getElementById('anclaje_serie').value || '',
      sgis_pre_proteccion_caidas_anclaje_lote: document.getElementById('anclaje_lote').value || '',
      sgis_pre_proteccion_caidas_anclaje_fecha_fabri: document.getElementById('anclaje_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_anclaje_fisura: caidasGet('anclaje_fisura'),
      sgis_pre_proteccion_caidas_anclaje_fibra_rota: caidasGet('anclaje_fibra_rota'),
      sgis_pre_proteccion_caidas_anclaje_deterioro: caidasGet('anclaje_deterioro'),
      sgis_pre_proteccion_caidas_anclaje_manchas: caidasGet('anclaje_manchas'),
      sgis_pre_proteccion_caidas_anclaje_impacto: caidasGet('anclaje_impacto'),
      sgis_pre_proteccion_caidas_linea_vida_marca: document.getElementById('linea_marca').value || '',
      sgis_pre_proteccion_caidas_linea_vida_modelo: document.getElementById('linea_modelo').value || '',
      sgis_pre_proteccion_caidas_linea_vida_serie: document.getElementById('linea_serie').value || '',
      sgis_pre_proteccion_caidas_linea_vida_lote: document.getElementById('linea_lote').value || '',
      sgis_pre_proteccion_caidas_linea_vida_fecha_fabri: document.getElementById('linea_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_linea_vida_fisura: caidasGet('linea_vida_fisura'),
      sgis_pre_proteccion_caidas_linea_vida_fibra_rota: caidasGet('linea_vida_fibra_rota'),
      sgis_pre_proteccion_caidas_linea_vida_deterioro: caidasGet('linea_vida_deterioro'),
      sgis_pre_proteccion_caidas_linea_vida_manchas: caidasGet('linea_vida_manchas'),
      sgis_pre_proteccion_caidas_linea_vida_impacto: caidasGet('linea_vida_impacto'),
      sgis_pre_proteccion_caidas_mosqueton_marca: document.getElementById('mosqueton_marca').value || '',
      sgis_pre_proteccion_caidas_mosqueton_modelo: document.getElementById('mosqueton_modelo').value || '',
      sgis_pre_proteccion_caidas_mosqueton_serie: document.getElementById('mosqueton_serie').value || '',
      sgis_pre_proteccion_caidas_mosqueton_lote: document.getElementById('mosqueton_lote').value || '',
      sgis_pre_proteccion_caidas_mosqueton_fecha_fabri: document.getElementById('mosqueton_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_mosqueton_fisural: caidasGet('mosqueton_fisural'),
      sgis_pre_proteccion_caidas_mosqueton_deterioro: caidasGet('mosqueton_deterioro'),
      sgis_pre_proteccion_caidas_mosqueton_manchas: caidasGet('mosqueton_manchas'),
      sgis_pre_proteccion_caidas_pretales_marca: document.getElementById('pretales_marca').value || '',
      sgis_pre_proteccion_caidas_pretales_modelo: document.getElementById('pretales_modelo').value || '',
      sgis_pre_proteccion_caidas_pretales_serie: document.getElementById('pretales_serie').value || '',
      sgis_pre_proteccion_caidas_pretales_lote: document.getElementById('pretales_lote').value || '',
      sgis_pre_proteccion_caidas_pretales_fecha_fabri: document.getElementById('pretales_fecha_fabri').value || null,
      sgis_pre_proteccion_caidas_pretales_fisura: caidasGet('pretales_fisura'),
      sgis_pre_proteccion_caidas_pretales_deterioro: caidasGet('pretales_deterioro'),
      sgis_pre_proteccion_caidas_pretales_manchas: caidasGet('pretales_manchas'),
      observacion: (document.getElementById('observacionesCaidas').value || '').trim()
    };
  }
  function validarCamposCaidas(){
    const req = [
      'arnes_fisura','arnes_fibra_rota','arnes_deterioro','arnes_manchas','arnes_impacto',
      'eslinga_fisura','eslinga_fibra_rota','eslinga_deterioro','eslinga_manchas','eslinga_impacto',
      'anclaje_fisura','anclaje_fibra_rota','anclaje_deterioro','anclaje_manchas','anclaje_impacto',
      'linea_vida_fisura','linea_vida_fibra_rota','linea_vida_deterioro','linea_vida_manchas','linea_vida_impacto',
      'mosqueton_deterioro','mosqueton_fisural','mosqueton_manchas',
      'pretales_deterioro','pretales_fisura','pretales_manchas'
    ];
    for(const k of req){ const v = caidasGet(k); if(!v){ Swal.fire('Campos incompletos','Completa todas las generalidades','warning'); return false; } }
    const hasNC = req.some(k => caidasGet(k) === 'NC');
    if(hasNC){ const obs = (document.getElementById('observacionesCaidas').value || '').trim(); if(!obs){ Swal.fire('Observaciones requeridas','Registra observaciones para los hallazgos en NC','warning'); return false; } }
    return true;
  }
  let firmaCtxCaidas, firmandoCaidas = false;
  function initFirmaCaidas(){
    const c = document.getElementById('firmaCanvasCaidas');
    firmaCtxCaidas = c.getContext('2d');
    firmaCtxCaidas.strokeStyle = '#222';
    firmaCtxCaidas.lineWidth = 2;
    const pos = (e)=>{ const r = c.getBoundingClientRect(); const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x,y}; };
    const start = (e)=>{ firmandoCaidas = true; const p = pos(e); firmaCtxCaidas.beginPath(); firmaCtxCaidas.moveTo(p.x,p.y); e.preventDefault(); };
    const move = (e)=>{ if(!firmandoCaidas) return; const p = pos(e); firmaCtxCaidas.lineTo(p.x,p.y); firmaCtxCaidas.stroke(); e.preventDefault(); };
    const end = ()=>{ firmandoCaidas = false; };
    c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
    c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
    document.getElementById('btnLimpiarFirmaCaidas').addEventListener('click', ()=>{ firmaCtxCaidas.clearRect(0,0,c.width,c.height); });
  }
  function enviarConFirmaCaidas(){
    const c = document.getElementById('firmaCanvasCaidas');
    const firma = c.toDataURL('image/png');
    const payload = construirPayloadCaidas();
    payload.firma_base64 = firma;
    fetch('/api/sgis/pre-caidas', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      .then(r=>r.json()).then(d=>{
        if(d && d.success){
          Swal.fire('Éxito','Preoperacional de control caídas registrado','success');
          const btn = document.getElementById('btnPreopCaidas'); if(btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
          const mf = document.getElementById('modalFirmaCaidas'); const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
          const me = document.getElementById('modalCaidas'); const modal2 = bootstrap.Modal.getInstance(me); if(modal2) modal2.hide();
        } else {
          Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
        }
      }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
  }
  document.getElementById('btnGuardarPreopCaidas').addEventListener('click', function(){
    if(!validarCamposCaidas()) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirmaCaidas'));
    mf.show();
    initFirmaCaidas();
  });
  document.getElementById('btnEnviarPreopCaidas').addEventListener('click', enviarConFirmaCaidas);
})
</script>
{% endblock %}
