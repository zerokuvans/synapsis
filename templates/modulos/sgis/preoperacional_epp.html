{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #0ea5e9 0%, #22c55e 100%) !important;">
          <h4 class="mb-0"><i class="fas fa-hard-hat me-2"></i>Pre-operacional de EPP</h4>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="epp_casco" checked>
                <label class="form-check-label" for="epp_casco">Casco</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="epp_gafas" checked>
                <label class="form-check-label" for="epp_gafas">Gafas de seguridad</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="epp_guantes" checked>
                <label class="form-check-label" for="epp_guantes">Guantes</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="epp_botas" checked>
                <label class="form-check-label" for="epp_botas">Botas</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="epp_chaleco" checked>
                <label class="form-check-label" for="epp_chaleco">Chaleco reflectivo</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="epp_respirador">
                <label class="form-check-label" for="epp_respirador">Respirador</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="epp_arnes">
                <label class="form-check-label" for="epp_arnes">Arnés</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="epp_protector_auditivo">
                <label class="form-check-label" for="epp_protector_auditivo">Protector auditivo</label>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Observaciones</label>
            <textarea id="observaciones" class="form-control" rows="3" placeholder="Observaciones opcionales"></textarea>
          </div>
          <div class="mt-4 d-flex gap-2">
            <a href="/sgis" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
            </a>
            <button id="btnRegistrar" class="btn btn-primary">
              <i class="fas fa-pen-nib me-2"></i>Firmar y Enviar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function mapValor(b){ return b ? 'C' : 'NC'; }
function construirPayload(){
  const datos = {
    casco: document.getElementById('epp_casco').checked,
    gafas: document.getElementById('epp_gafas').checked,
    guantes: document.getElementById('epp_guantes').checked
  };
  return {
    casco_estado_general: mapValor(datos.casco),
    casco_uso_menor_2_anios: 'C',
    casco_estado_talifete: 'C',
    casco_puntos_anclaje_barbuquejo: 'C',
    barbuquejo_puntos_apoyo: 'C',
    barbuquejo_sujetador_menton: 'C',
    barbuquejo_costuras_correas: 'C',
    guantes_costuras: mapValor(datos.guantes),
    guantes_refuerzo_palma: 'C',
    guantes_estado_general: 'C',
    monogafas_lentes: mapValor(datos.gafas),
    monogafas_patillas_ajustables: 'C',
    monogafas_puente_nariz: 'C',
    observaciones: document.getElementById('observaciones').value || ''
  };
}
function validarCampos(payload){
  const req = [
    'casco_estado_general','casco_uso_menor_2_anios','casco_estado_talifete','casco_puntos_anclaje_barbuquejo',
    'barbuquejo_puntos_apoyo','barbuquejo_sujetador_menton','barbuquejo_costuras_correas',
    'guantes_costuras','guantes_refuerzo_palma','guantes_estado_general',
    'monogafas_lentes','monogafas_patillas_ajustables','monogafas_puente_nariz'
  ];
  for(const n of req){ if(!payload[n]) { Swal.fire('Campos incompletos','Completa todas las secciones','warning'); return false; } }
  let hasNC = false; for(const n of req){ if(payload[n] === 'NC'){ hasNC = true; break; } }
  if(hasNC){ const obs = (payload.observaciones || '').trim(); if(!obs){ Swal.fire('Observaciones requeridas','Registra observaciones para los hallazgos en NC','warning'); return false; } }
  return true;
}
let firmaCtx, firmando = false;
function initFirma(){
  const c = document.getElementById('firmaCanvas');
  firmaCtx = c.getContext('2d');
  firmaCtx.strokeStyle = '#222';
  firmaCtx.lineWidth = 2;
  const pos = (e)=>{ const r = c.getBoundingClientRect(); const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x,y}; };
  const start = (e)=>{ firmando = true; const p = pos(e); firmaCtx.beginPath(); firmaCtx.moveTo(p.x,p.y); e.preventDefault(); };
  const move = (e)=>{ if(!firmando) return; const p = pos(e); firmaCtx.lineTo(p.x,p.y); firmaCtx.stroke(); e.preventDefault(); };
  const end = ()=>{ firmando = false; };
  c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
  c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
  document.getElementById('btnLimpiarFirma').addEventListener('click', ()=>{ firmaCtx.clearRect(0,0,c.width,c.height); });
}
function enviar(){
  const c = document.getElementById('firmaCanvas');
  const firma = c.toDataURL('image/png');
  const payload = construirPayload();
  if(!validarCampos(payload)) return;
  payload.firma_base64 = firma;
  fetch('/api/sgis/pre-proteccion-personal', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  }).then(r=>r.json()).then(d=>{
    if(d && d.success){
      Swal.fire('Éxito','Preoperacional registrado','success');
      const btn = document.getElementById('btnRegistrar'); if(btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
      const mf = document.getElementById('modalFirma'); const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
    } else {
      Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
    }
  }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
}
document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('btnRegistrar').addEventListener('click', function(){
    const payload = construirPayload();
    if(!validarCampos(payload)) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirma'));
    mf.show();
    initFirma();
  });
  fetch('/api/sgis/pre-proteccion-personal/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnRegistrar');
    if(d && d.success && d.already_today && btn){ btn.disabled = true; btn.textContent = 'Pre-operacional diligenciado'; }
  }).catch(()=>{});
  document.getElementById('btnEnviarPreop').addEventListener('click', enviar);
});
</script>

<div class="modal fade" id="modalFirma" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvas" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirma" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarPreop" type="button" class="btn btn-success btn-sm">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
