{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #1e293b 0%, #0ea5e9 100%) !important;">
          <h4 class="mb-0"><i class="fas fa-file-alt me-2"></i>Reportes SGIS · Pre-operacional Escaleras</h4>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Mes</label>
              <input type="month" id="filtroMes" class="form-control">
            </div>
            <div class="col-md-4 align-self-end">
              <button id="btnCargar" class="btn btn-primary w-100"><i class="fas fa-sync me-2"></i>Cargar técnicos</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped" id="tablaTecnicos">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Cédula</th>
                  <th>% Registros Escaleras</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalDetallePreop" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Pre-operacional mensual</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <style>
          .tpl-bar{background:#0f3d61;color:#fff;border-radius:4px;padding:.35rem .6rem;font-weight:600;letter-spacing:.2px}
          .tpl-grid{border:1px solid #0f3d61;border-radius:6px;overflow:hidden}
          .tpl-grid .row{margin:0}
          .tpl-label{font-size:.8rem;color:#6c757d}
          .tpl-box{border:1px solid #dee2e6;border-radius:4px;min-height:32px;padding:.25rem .5rem}
          .tpl-seccion-title{display:flex;align-items:center;gap:.5rem;background:#0f3d61;color:#fff;padding:.4rem .6rem;border-radius:4px;margin:10px 0}
          .tpl-seccion-title i{font-size:1.1rem}
          .tpl-head-merge{background:#143c60;color:#fff}
          .tpl-head-days th{min-width:28px;text-align:center}
          .tpl-firma{border-top:3px solid #0f3d61;margin-top:12px;padding-top:10px}
          .tpl-firma .firma-box{border:1px solid #0f3d61;border-radius:4px;height:120px}
          .firma-img{width:120px;height:120px;object-fit:contain}
          .tpl-observ{border-top:3px solid #0f3d61;margin-top:12px;padding-top:8px}
          .tpl-observ .observ-box{border:1px dashed #adb5bd;border-radius:4px;min-height:60px;padding:.5rem}
          #modalDetallePreop .modal-dialog{max-width:96vw}
          #contenedorMatriz{overflow-x:auto}
          #contenedorMatriz table{table-layout:auto;width:100%}
          #contenedorMatriz thead th:first-child{width:180px;text-align:center}
          #contenedorMatriz thead th:nth-child(2){width:300px;white-space:nowrap;text-align:left}
          #contenedorMatriz thead th:nth-child(n+3),#contenedorMatriz tbody td{min-width:28px;text-align:center}
          #contenedorMatriz tbody th{font-weight:500}
          #contenedorMatriz tbody th.item-img-cell{width:180px;text-align:center}
          #contenedorMatriz tbody th.item-label{width:300px;white-space:nowrap;text-align:left}
          .item-icon{margin-right:.5rem;color:#0f3d61}
          .item-img{width:150px;height:320px;object-fit:contain;margin-right:.5rem;vertical-align:middle}
        </style>
        <div class="tpl-grid p-3 mb-3">
          <div class="tpl-bar mb-2">INSPECCIÓN PRE-OPERACIONAL DE ESCALERAS</div>
          <div class="row g-2 mb-2">
            <div class="col-sm-6">
              <div class="tpl-label">Nombre y apellidos</div>
              <div class="tpl-box" id="plantNombre"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Identificación</div>
              <div class="tpl-box" id="plantCedula"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Mes</div>
              <div class="tpl-box" id="plantMes"></div>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-sm-3">
              <div class="tpl-label">Cargo</div>
              <div class="tpl-box" id="plantCargo"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Área</div>
              <div class="tpl-box" id="plantArea"></div>
            </div>
          </div>
        </div>
        <div id="contenedorMatriz"></div>
        <div class="tpl-observ">
          <div class="tpl-bar mb-2">Si existen hallazgos en "NC - No cumple", registre las observaciones</div>
          <div class="observ-box" id="plantObservaciones"></div>
        </div>
        <div class="tpl-firma">
          <div class="tpl-bar mb-2">Firma trabajador</div>
          <div class="row g-2">
            <div class="col-6 col-md-3"><div class="tpl-box firma-box d-flex align-items-center justify-content-center" id="firmaSemana1">SEMANA 1</div></div>
            <div class="col-6 col-md-3"><div class="tpl-box firma-box d-flex align-items-center justify-content-center" id="firmaSemana2">SEMANA 2</div></div>
            <div class="col-6 col-md-3"><div class="tpl-box firma-box d-flex align-items-center justify-content-center" id="firmaSemana3">SEMANA 3</div></div>
            <div class="col-6 col-md-3"><div class="tpl-box firma-box d-flex align-items-center justify-content-center" id="firmaSemana4">SEMANA 4</div></div>
          </div>
        </div>
        <div class="small text-muted mt-2">Leyenda: C = Cumple · NC = No Cumple · N/A = No Aplica</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-danger" id="btnExportarPDF"><i class="fas fa-file-pdf me-2"></i>Exportar PDF</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
let ultimoDetalle = null;
let ultimoNoLaborales = null;
function addDays(base, days){ const d = new Date(base.getFullYear(), base.getMonth(), base.getDate()); d.setDate(d.getDate()+days); return d; }
function easterDate(year){ const a = year % 19; const b = Math.floor(year / 100); const c = year % 100; const d = Math.floor(b / 4); const e = b % 4; const f = Math.floor((b + 8) / 25); const g = Math.floor((b - f + 1) / 3); const h = (19 * a + b - d - g + 15) % 30; const i = Math.floor(c / 4); const k = c % 4; const l = (32 + 2 * e + 2 * i - h - k) % 7; const m = Math.floor((a + 11 * h + 22 * l) / 451); const month = Math.floor((h + l - 7 * m + 114) / 31) - 1; const day = ((h + l - 7 * m + 114) % 31) + 1; return new Date(year, month, day); }
function observedMonday(year, month, day){ const d = new Date(year, month, day); const dow = d.getDay(); const shift = (8 - dow) % 7; d.setDate(d.getDate() + shift); return d; }
function colombiaFestivos(year){ const res = []; res.push(new Date(year,0,1)); res.push(new Date(year,4,1)); res.push(new Date(year,6,20)); res.push(new Date(year,7,7)); res.push(new Date(year,11,8)); res.push(new Date(year,11,25)); const easter = easterDate(year); res.push(addDays(easter,-3)); res.push(addDays(easter,-2)); res.push(observedMonday(year,0,6)); res.push(observedMonday(year,2,19)); res.push(observedMonday(year,5,29)); res.push(observedMonday(year,7,15)); res.push(observedMonday(year,9,12)); res.push(observedMonday(year,10,1)); res.push(observedMonday(year,10,11)); res.push(addDays(easter,43)); res.push(addDays(easter,64)); res.push(addDays(easter,69)); return res; }
function computeNoLaboralSet(mes, ultimoDia){ const parts = mes.split('-'); const year = Number(parts[0]); const month = Number(parts[1]) - 1; const hol = colombiaFestivos(year); const set = new Set(); for(let d=1; d<=ultimoDia; d++){ const dt = new Date(year, month, d); if(dt.getDay() === 0) set.add(d); } hol.forEach(h=>{ if(h.getFullYear() === year && h.getMonth() === month) set.add(h.getDate()); }); return set; }
function valorMesActual(){
  const d = new Date();
  const m = String(d.getMonth()+1).padStart(2,'0');
  return `${d.getFullYear()}-${m}`;
}
function setMesInicial(){
  const i = document.getElementById('filtroMes');
  if(i && !i.value) i.value = valorMesActual();
}
function cargarTecnicos(){
  const mes = document.getElementById('filtroMes').value;
  fetch(`/api/sgis/reportes/tecnicos-mes?mes=${encodeURIComponent(mes)}`)
    .then(r=>r.json())
    .then(d=>{
      const tbody = document.querySelector('#tablaTecnicos tbody');
      tbody.innerHTML = '';
      if(d && d.success && Array.isArray(d.data)){
        d.data.forEach(t=>{
          const tr = document.createElement('tr');
          const pct = Number(typeof t.porcentaje_escaleras === 'number' ? t.porcentaje_escaleras : (t.porcentaje_escaleras || 0));
          tr.innerHTML = `
            <td>${t.nombre || ''}</td>
            <td>${t.cedula || ''}</td>
            <td>${pct}% (${t.escaleras_dias || 0}/${t.asistencia_dias || 0})</td>
            <td>
              <button class="btn btn-outline-secondary btn-sm" data-cedula="${t.cedula}" data-nombre="${t.nombre}">
                <i class="fas fa-stairs me-1"></i>Preoperacional
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click',()=>{
            abrirDetalle(btn.getAttribute('data-cedula'), btn.getAttribute('data-nombre'));
          });
        });
      } else {
        Swal.fire('Sin datos','No hay técnicos con asistencia en el mes','info');
      }
    }).catch(()=>{ Swal.fire('Error','No se pudo cargar técnicos','error'); });
}
function renderHeaderDias(ultimoDia){
  const tr = document.createElement('tr');
  const thImg = document.createElement('th');
  thImg.textContent = '';
  tr.appendChild(thImg);
  const thItem = document.createElement('th');
  thItem.textContent = 'GENERALIDADES';
  tr.appendChild(thItem);
  for(let d=1; d<=31; d++){
    const th = document.createElement('th');
    th.textContent = d <= ultimoDia ? d : '';
    tr.appendChild(th);
  }
  return tr;
}
function renderFila(label, valores, icon, imgUrl){
  const tr = document.createElement('tr');
  const th = document.createElement('th');
  const img = imgUrl ? `<img class="item-img" src="${imgUrl}" onerror="this.style.display='none'"/>` : '';
  const ico = icon ? `<i class="item-icon ${icon}"></i>` : '';
  th.innerHTML = `${img}${ico}<span>${label}</span>`;
  tr.appendChild(th);
  for(let i=0;i<31;i++){
    const td = document.createElement('td');
    const v = valores[i] || '';
    td.textContent = v;
    if(v === 'NC') td.className = 'table-danger';
    else if(v === 'C') td.className = 'table-success';
    else if(v === 'N/A') td.className = 'table-secondary';
    tr.appendChild(td);
  }
  return tr;
}
function renderSeccion(titulo, filas, ultimoDia){
  const div = document.createElement('div');
  div.className = 'mb-3';
  const h6 = document.createElement('h6');
  h6.className = 'mb-2';
  h6.textContent = titulo;
  div.appendChild(h6);
  const table = document.createElement('table');
  table.className = 'table table-bordered';
  const thead = document.createElement('thead');
  thead.appendChild(renderHeaderDias(ultimoDia));
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  const trImgAdded = false;
  filas.forEach((f, idx)=>{
    const tr = document.createElement('tr');
    if(idx===0){
      const thImg = document.createElement('th');
      thImg.className = 'item-img-cell';
      thImg.setAttribute('rowspan', String(filas.length));
      const imgEl = document.createElement('img');
      imgEl.className = 'item-img';
      imgEl.crossOrigin = 'anonymous';
      const fallbackSvg = encodeURI(`<svg xmlns='http://www.w3.org/2000/svg' width='70' height='70'><rect width='70' height='70' fill='#e9f2fb'/><text x='35' y='38' text-anchor='middle' font-size='12' fill='#0f3d61'>ESCALERA</text></svg>`);
      imgEl.src = '/static/img/sgis/escalera.jpeg';
      imgEl.onerror = function(){ this.src = 'data:image/svg+xml;utf8,' + fallbackSvg; };
      thImg.appendChild(imgEl);
      tr.appendChild(thImg);
    }
    const thLabel = document.createElement('th');
    thLabel.className = 'item-label';
    thLabel.innerHTML = `<span>${f.label}</span>`;
    tr.appendChild(thLabel);
    for(let i=0;i<31;i++){
      const td = document.createElement('td');
      const day = i+1;
      let v = (f.valores[i] || '').trim();
      if(day <= ultimoDia && !v && ultimoNoLaborales && ultimoNoLaborales.has(day)) v = 'N/A';
      td.textContent = v;
      if(v === 'NC') td.className = 'table-danger';
      else if(v === 'C') td.className = 'table-success';
      else if(v === 'N/A') td.className = 'table-secondary';
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  div.appendChild(table);
  return div;
}
function abrirDetalle(cedula, nombre){
  const mes = document.getElementById('filtroMes').value;
  fetch(`/api/sgis/reportes/preop-matriz-escaleras?cedula=${encodeURIComponent(cedula)}&mes=${encodeURIComponent(mes)}`)
    .then(r=>r.json())
    .then(d=>{
      if(d && d.success){
        const info = d.info || {};
        document.getElementById('plantNombre').textContent = info.nombre || nombre || '';
        document.getElementById('plantCedula').textContent = info.cedula || cedula || '';
        document.getElementById('plantMes').textContent = d.mes || '';
        document.getElementById('plantCargo').textContent = info.cargo || '';
        document.getElementById('plantArea').textContent = info.area || '';
        const cont = document.getElementById('contenedorMatriz');
        cont.innerHTML = '';
        const u = d.ultimo_dia || new Date(Number(d.mes.split('-')[0]), Number(d.mes.split('-')[1]), 0).getDate();
        const m = d.matriz || {};
        const obs = Array.isArray(d.observaciones) ? d.observaciones : [];
        const obsLines = [];
        obs.forEach((txt, idx)=>{
          const t = (txt || '').trim();
          if(t){ obsLines.push(`Día ${idx+1}: ${t}`); }
        });
        document.getElementById('plantObservaciones').innerHTML = obsLines.length ? obsLines.join('<br>') : '';
        ultimoDetalle = { mes: d.mes, ultimoDia: u, info: { nombre: info.nombre || nombre || '', cedula: info.cedula || cedula || '', cargo: info.cargo || '', area: info.area || '' }, matriz: m, observaciones: obs };
        ultimoNoLaborales = computeNoLaboralSet(d.mes, u);
        const gen = (m.generalidades || {});
        const filas = [
          {label:'Larguero o perfil', valores: gen.larguero || []},
          {label:'Peldaños', valores: gen.peldanos || []},
          {label:'Unión de peldaños y largueros', valores: gen.union || []},
          {label:'Zapatas antideslizantes', valores: gen.zapatas || []},
          {label:'Base de apoyo a poste', valores: gen.base_apoyo || []},
          {label:'Piezas de ajuste', valores: gen.piezas_ajuste || []},
          {label:'Ganchos', valores: gen.ganchos || []},
          {label:'Cuerda polea', valores: gen.cuerda_polea || []},
          {label:'Guías externas', valores: gen.guias_externas || []},
          {label:'Señal de seguridad', valores: gen.senal_seguridad || []},
          {label:'Aseo de la escalera', valores: gen.aseo_escalera || []}
        ];
        cont.appendChild(renderSeccion('GENERALIDADES', filas, u));
        aplicarFirmasSemana({ mes: d.mes, ultimo_dia: u, matriz: m, firmas: Array.isArray(d.firmas) ? d.firmas : [] });
        const modal = new bootstrap.Modal(document.getElementById('modalDetallePreop'));
        modal.show();
      } else {
        Swal.fire('Sin datos','No hay registros para este técnico','info');
      }
    }).catch(()=>{ Swal.fire('Error','No se pudo cargar detalle','error'); });
}
function aplicarFirmasSemana(det){
  const u = det.ultimo_dia || new Date(Number(det.mes.split('-')[0]), Number(det.mes.split('-')[1]), 0).getDate();
  const m = det.matriz || {};
  const firmasArr = Array.isArray(det.firmas) ? det.firmas : [];
  function normalizar(v){
    const t = (v || '').trim();
    if(!t) return '';
    if(t.startsWith('data:image')) return t;
    if(/^https?:\/\//.test(t) || t.startsWith('/')) return t;
    if(/^[A-Za-z0-9+/=]+$/.test(t) && t.length>100) return 'data:image/png;base64,'+t;
    return '';
  }
  function hayRegistroDia(dia){
    const gen = m.generalidades || {};
    return Object.values(gen).some(v=>Array.isArray(v) && (v[dia-1] || '') !== '');
  }
  const semanas = [
    {ini:1, fin:Math.min(7,u)},
    {ini:8, fin:Math.min(14,u)},
    {ini:15, fin:Math.min(21,u)},
    {ini:22, fin:u}
  ];
  const resultados = semanas.map(s=>{
    let src = '';
    let txt = '';
    for(let d=s.ini; d<=s.fin; d++){
      const f = firmasArr[d-1];
      const n = normalizar(f);
      if(n){ src = n; break; }
      if(!txt && hayRegistroDia(d)){ txt = `Firmado día ${d}`; }
    }
    return { src, txt };
  });
  ['firmaSemana1','firmaSemana2','firmaSemana3','firmaSemana4'].forEach((id, i)=>{
    const el = document.getElementById(id);
    if(el){
      el.innerHTML = '';
      const cont = document.createElement('div');
      cont.className = 'd-flex align-items-center justify-content-center gap-2';
      const t = document.createElement('span');
      t.textContent = `SEMANA ${i+1}`;
      cont.appendChild(t);
      const r = resultados[i] || {};
      if(r.src){
        const img = document.createElement('img');
        img.className = 'firma-img';
        img.src = r.src;
        if(!r.src.startsWith('data:')) img.crossOrigin = 'anonymous';
        cont.appendChild(img);
      } else if(r.txt){
        const sm = document.createElement('small');
        sm.textContent = r.txt;
        cont.appendChild(sm);
      }
      el.appendChild(cont);
    }
  });
}
function exportarPDF(){
  if(!ultimoDetalle){ Swal.fire('Sin datos','Abre un técnico antes de exportar','info'); return; }
  const el = document.querySelector('#modalDetallePreop .modal-content');
  const nombre = (ultimoDetalle.info?.nombre || '').replace(/[^A-Za-z0-9_\- ]/g,'');
  const ced = (ultimoDetalle.info?.cedula || '').replace(/[^0-9]/g,'');
  const archivo = `Preop_Escaleras_${ced || nombre}_${ultimoDetalle.mes}.pdf`;
  const margin = 5;
  const hasH2C = !!(window.html2canvas);
  const hasJspdf = !!((window.jspdf && window.jspdf.jsPDF) || window.jsPDF);
  if(hasH2C && hasJspdf){
    window.html2canvas(el, { scale: 2, useCORS: true, scrollY: 0 }).then(canvas=>{
      const jsPDFCtor = window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : window.jsPDF;
      const pdf = new jsPDFCtor({ unit: 'pt', format: 'letter', orientation: 'landscape' });
      const pdfW = pdf.internal.pageSize.getWidth();
      const pdfH = pdf.internal.pageSize.getHeight();
      const maxW = pdfW - margin*2;
      const maxH = pdfH - margin*2;
      const ratio = Math.min(maxW / canvas.width, maxH / canvas.height);
      const imgW = canvas.width * ratio;
      const imgH = canvas.height * ratio;
      const x = margin + (maxW - imgW) / 2;
      const y = margin + (maxH - imgH) / 2;
      const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
      pdf.addImage(dataUrl, 'JPEG', x, y, imgW, imgH);
      pdf.save(archivo);
    });
  } else if(window.html2pdf){
    const opt = {
      margin: 10,
      filename: archivo,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
      jsPDF: { unit: 'pt', format: 'letter', orientation: 'landscape' },
      pagebreak: { mode: ['avoid-all'] }
    };
    window.html2pdf().from(el).set(opt).save();
  } else {
    Swal.fire('Error','No se encontraron librerías de exportación','error');
  }
}
document.addEventListener('DOMContentLoaded', function(){
  setMesInicial();
  cargarTecnicos();
  document.getElementById('btnCargar').addEventListener('click', cargarTecnicos);
  const bp = document.getElementById('btnExportarPDF');
  if(bp){ bp.addEventListener('click', exportarPDF); }
});
</script>
{% endblock %}
