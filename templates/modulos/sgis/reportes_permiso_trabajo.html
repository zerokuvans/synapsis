{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #1e293b 0%, #f59e0b 100%) !important;">
          <h4 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Reportes SGIS · Permiso de Trabajo</h4>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Mes</label>
              <input type="month" id="filtroMes" class="form-control">
            </div>
            <div class="col-md-4 align-self-end">
              <button id="btnCargar" class="btn btn-warning w-100"><i class="fas fa-sync me-2"></i>Cargar técnicos</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped" id="tablaTecnicos">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Cédula</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalDetallePermiso" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog" style="max-width:1300px">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Permiso de Trabajo mensual</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <style>
          .tpl-bar{background:#0f3d61;color:#fff;border-radius:4px;padding:.35rem .6rem;font-weight:600;letter-spacing:.2px}
          .tpl-grid{border:1px solid #0f3d61;border-radius:6px;overflow:hidden}
          .tpl-grid, #contenedorPermiso, .modal-body{font-family: Calibri, Arial, sans-serif}
          .tpl-grid .row{margin:0}
          .tpl-label{font-size:.8rem;color:#6c757d}
          .tpl-box{border:1px solid #dee2e6;border-radius:4px;min-height:32px;padding:.25rem .5rem}
          #contenedorPermiso{overflow-x:auto}
          #contenedorPermiso table{table-layout:auto;width:100%}
          #contenedorPermiso thead th:first-child{width:260px;text-align:left}
          #contenedorPermiso thead th:nth-child(n+2),#contenedorPermiso tbody td{min-width:22px;text-align:center;font-size:.8rem;padding:.25rem}
          #contenedorPermiso tbody th{font-weight:500}
          .pt-semana{border:1px solid #9aa9b2;border-radius:6px;margin-bottom:12px;padding:10px}
          .pt-semana-title{background:#e9f2ff;color:#1f2937;border-radius:4px;padding:.35rem .6rem;font-weight:600;margin-bottom:8px}
          .head-days th{min-width:28px;text-align:center}
          .item-label{width:260px;text-align:left}
          .table-success{background:#d1e7dd}
          .table-danger{background:#f8d7da}
          .table-secondary{background:#e2e3e5}
          .pt-semana-dias{font-size:.85rem;color:#0f3d61;margin:6px 0}
          .firmas-semana{border-top:2px solid #0f3d61;margin-top:10px;padding-top:8px}
          .firmas-titulo{font-weight:600;color:#0f3d61;margin-bottom:6px}
          .firma-tabla{width:100%;border-collapse:collapse}
          .firma-tabla th,.firma-tabla td{border:1.2px solid #9aa9b2;padding:6px;text-align:center;font-size:.85rem}
          .firma-tabla th{background:#e9f2ff;color:#0f3d61}
          .firma-mini-img{width:80px;height:40px;object-fit:contain}
          .firma-click{cursor:pointer}
          .no-firma{opacity:.45;cursor:not-allowed;background:#f8f9fa}
          .html2pdf__page-break{page-break-before:always}
          .avoid-break{break-inside:avoid-page;page-break-inside:avoid}
          .pt-seccion{border:1px solid #9aa9b2;border-radius:6px;margin-bottom:8px;padding:8px}
          .pt-sec-title{background:#e9f2ff;color:#1f2937;border-radius:4px;padding:.3rem .5rem;font-weight:600;margin-bottom:6px}
          .pt-item{display:flex;align-items:center;justify-content:space-between;border:1px solid #e5e7eb;border-radius:6px;padding:.35rem .6rem}
          .pt-item-label{font-size:.85rem;color:#475569;margin-right:8px}
          .pt-item-value{min-width:80px;text-align:center;border-radius:4px;padding:.2rem .4rem}
        </style>
        <div class="modal fade" id="modalFirmaSupervisor" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma Supervisor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <canvas id="firmaCanvasSupervisor" width="400" height="200" style="border:1px solid #ddd; border-radius:6px; cursor:crosshair; width:100%; height:200px"></canvas>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="btnLimpiarFirmaSupervisor">Limpiar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarFirmaSupervisor">Guardar firma</button>
              </div>
            </div>
          </div>
        </div>
        <div class="tpl-grid p-3 mb-3" id="encabezadoGlobal" style="display:none">
          <div class="tpl-bar mb-2">1. INFORMACIÓN GENERAL</div>
          <div class="row g-2 mb-2">
            <div class="col-sm-6">
              <div class="tpl-label">Nombre y apellidos</div>
              <div class="tpl-box" id="plantNombre"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Identificación</div>
              <div class="tpl-box" id="plantCedula"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Mes</div>
              <div class="tpl-box" id="plantMes"></div>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-sm-3">
              <div class="tpl-label">Cargo</div>
              <div class="tpl-box" id="plantCargo"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Área</div>
              <div class="tpl-box" id="plantArea"></div>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-sm-4">
              <div class="tpl-label">Supervisor</div>
              <div class="tpl-box" id="plantSupervisor"></div>
            </div>
            <div class="col-sm-4">
              <div class="tpl-label">Cliente</div>
              <div class="tpl-box" id="plantCliente"></div>
            </div>
            <div class="col-sm-4">
              <div class="tpl-label">Ciudad</div>
              <div class="tpl-box" id="plantCiudad"></div>
            </div>
          </div>
        </div>
        <div id="contenedorPermiso"></div>
        <div class="small text-muted mt-2">Leyenda: C = Cumple · NC = No Cumple · N/A = No Aplica · SI/NO</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-warning" id="btnExportarPDF"><i class="fas fa-file-pdf me-2"></i>Exportar PDF</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
let ultimoMesPT = null;
let ultimoDetallePT = null;
function valorMesActual(){ const d = new Date(); const m = String(d.getMonth()+1).padStart(2,'0'); return `${d.getFullYear()}-${m}`; }
function setMesInicial(){ const i = document.getElementById('filtroMes'); if(i && !i.value) i.value = valorMesActual(); }
function cargarTecnicos(){ const mes = document.getElementById('filtroMes').value; fetch(`/api/sgis/reportes/tecnicos-mes?mes=${encodeURIComponent(mes)}`).then(r=>r.json()).then(d=>{ const tbody = document.querySelector('#tablaTecnicos tbody'); tbody.innerHTML=''; if(d && d.success && Array.isArray(d.data)){ d.data.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.nombre||''}</td><td>${t.cedula||''}</td><td><button class="btn btn-outline-warning btn-sm" data-cedula="${t.cedula}" data-nombre="${t.nombre}"><i class="fas fa-clipboard-check me-1"></i>Permiso</button></td>`; tbody.appendChild(tr); }); tbody.querySelectorAll('button').forEach(btn=>{ btn.addEventListener('click',()=>{ abrirDetalle(btn.getAttribute('data-cedula'), btn.getAttribute('data-nombre')); }); }); } else { Swal.fire('Sin datos','No hay técnicos con asistencia en el mes','info'); } }).catch(()=>{ Swal.fire('Error','No se pudo cargar técnicos','error'); }); }
function formatLabel(key){ const s=String(key||'').replace(/^sgis_permiso_trabajo_/,'').replace(/_/g,' '); return s.charAt(0).toUpperCase()+s.slice(1); }
function renderTablaRespuestas(respuestas){ const wrap=document.createElement('div'); const keys=Object.keys(respuestas||{}); const norm=k=>String(k||'').replace(/^sgis_permiso_trabajo_/,''); const groups={ 'Descripción y Herramienta':['descripcion_tarea','herramienta'], 'Herramientas (Inspección)':['herramienta_electrica','herramienta_manual','equipos_alturas','otros_herramientas'], 'Condiciones del Área':['iluminacion','animales','izaje_alturas','obstaculos_evacuacion','vehiculos_area','trabajo_alturas','trabajo_piso_humedo','manejo_energia_peligrosa','trabajo_manual','caida_objetos','otros_area'], 'Peligros Identificados':['proyeccion_particulas','caidas_menor_2m','caidas_mayor_2m','acceso_mal_estado','levantamiento_carga_mecanica','condicion_clima','clima','proxi_red_energizasa','proxi_red','vibraciones','contacto_electrico','atrapamiento','cable_expuesto','corte_no_visible','atmosfera_explosiva','fuentes_ignicion','vapores','alta_temperatura','baja_temperatura','iluminacion_deficiente','quemaduras','almacenamientos_quimicos','extensiones_mal_estado','ruido','contacto_directo_indirecto','caida_objeto','espacio_reducido','levantamiento_manual_cargas','subestacion_inundada','excavaciones','otros'], 'Elementos de Protección':['calzado_dielectrico','guantes_nitrilo','guantes_vaqueta','gafas_proteccion','casco_dielectrico','tie_off','mosqueton','eslinga','arrestador','arnes','linea_vida','escalera_tijera','escalera_extensible','cinta_precaucion','conos','botiquin'], 'Comunicación de Riesgos':['notificacion_trabajo','responsabilidades_permiso','condicion_interrupcion','cambios_seguridad_trabajo','induccion_seguridad','capacitacion_tema','metodos_inspeccion','responsables_area','mecanismo_control_riesgo','alarmas_puntos_reunion','ubicacion_equipos_incendio','riesgos_trabajo_area','impacto_ambiental'], 'Verificación de Documentación':['ats','inspecciones_relizadas','procedimientos_trabajo','arl_afp_eps'] }; function makeSection(title, list){ if(!list.length) return null; const sec=document.createElement('div'); sec.className='pt-seccion'; const tt=document.createElement('div'); tt.className='pt-sec-title'; tt.textContent=title; sec.appendChild(tt); const row=document.createElement('div'); row.className='row g-2'; list.forEach(k=>{ const full=keys.find(kk=>norm(kk)===k); if(!full) return; const v=respuestas[full]; const col=document.createElement('div'); col.className='col-md-6'; const item=document.createElement('div'); item.className='pt-item'; const lab=document.createElement('div'); lab.className='pt-item-label'; lab.textContent=formatLabel(full); const val=document.createElement('div'); val.className='pt-item-value'; const txt=v==null? '' : String(v); val.textContent=txt; if(txt==='C' || txt==='SI') val.className+=' table-success'; else if(txt==='NC' || txt==='NO') val.className+=' table-danger'; else if(txt==='N/A' || txt==='NA') val.className+=' table-secondary'; item.appendChild(lab); item.appendChild(val); col.appendChild(item); row.appendChild(col); }); sec.appendChild(row); return sec; } const used=new Set(); Object.entries(groups).forEach(([title, arr])=>{ const present=arr.filter(k=>keys.some(kk=>norm(kk)===k)); const sec=makeSection(title, present); if(sec) wrap.appendChild(sec); present.forEach(k=>used.add(k)); }); const restantes=keys.filter(kk=>!used.has(norm(kk))); if(restantes.length){ const sec=makeSection('Otros', restantes.map(k=>norm(k))); if(sec) wrap.appendChild(sec); } return wrap; }
function renderMatrizHeader(ultimoDia, titulo){ const div=document.createElement('div'); const h6=document.createElement('h6'); h6.className='mb-2'; h6.textContent=titulo; div.appendChild(h6); const table=document.createElement('table'); table.className='table table-bordered avoid-break'; const thead=document.createElement('thead'); const tr=document.createElement('tr'); const thItem=document.createElement('th'); thItem.textContent='Ítem'; tr.appendChild(thItem); for(let d=1; d<=31; d++){ const th=document.createElement('th'); th.textContent=d<=ultimoDia? d : ''; tr.appendChild(th); } thead.appendChild(tr); table.appendChild(thead); const tbody=document.createElement('tbody'); table.tbodyRef = tbody; table.appendChild(tbody); div.appendChild(table); return {wrap: div, tbody}; }
function appendMatrizFila(tbody, label, valores, ultimoDia){ const tr=document.createElement('tr'); const th=document.createElement('th'); th.className='item-label'; th.innerHTML=`<span>${label}</span>`; tr.appendChild(th); for(let i=0;i<31;i++){ const td=document.createElement('td'); const day=i+1; const v=(valores[i]||'').trim(); td.textContent=v; if(day<=ultimoDia){ if(v==='NC') td.className='table-danger'; else if(v==='C') td.className='table-success'; else if(v==='N/A' || v==='NA') td.className='table-secondary'; else if(v==='SI') td.className='table-success'; else if(v==='NO') td.className='table-danger'; } tr.appendChild(td); } tbody.appendChild(tr); }

function renderMatrizHeaderDias(dias, titulo){ const div=document.createElement('div'); const h6=document.createElement('h6'); h6.className='mb-2'; h6.textContent=titulo; div.appendChild(h6); const table=document.createElement('table'); table.className='table table-bordered'; const thead=document.createElement('thead'); const tr=document.createElement('tr'); const thItem=document.createElement('th'); thItem.textContent='Ítem'; tr.appendChild(thItem); (dias||[]).forEach(d=>{ const th=document.createElement('th'); th.textContent=String(d); tr.appendChild(th); }); thead.appendChild(tr); table.appendChild(thead); const tbody=document.createElement('tbody'); table.tbodyRef = tbody; table.appendChild(tbody); div.appendChild(table); return {wrap: div, tbody}; }
function appendMatrizFilaDias(tbody, label, valores, dias){ const tr=document.createElement('tr'); const th=document.createElement('th'); th.className='item-label'; th.innerHTML=`<span>${label}</span>`; tr.appendChild(th); (dias||[]).forEach(day=>{ const td=document.createElement('td'); const v=(valores[day-1]||'').trim(); td.textContent=v; if(v==='NC' || v==='NO') td.className='table-danger'; else if(v==='C' || v==='SI') td.className='table-success'; else if(v==='N/A' || v==='NA') td.className='table-secondary'; tr.appendChild(td); }); tbody.appendChild(tr); }
function diasEntre(fi, ff, mes){ const a=[]; try{ const parts=(mes||'').split('-'); const my=parseInt(parts[0]||'0',10); const mm=parseInt(parts[1]||'0',10)-1; function toLocalDate(iso){ if(!iso) return null; const p=String(iso).split('-'); if(p.length>=3){ const y=parseInt(p[0],10); const m=parseInt(p[1],10)-1; const d=parseInt(p[2],10); return new Date(y, m, d); } return new Date(iso); } const df=toLocalDate(ff||fi) || new Date(); const start=new Date(df.getFullYear(), df.getMonth(), df.getDate()-6); const end=new Date(df.getFullYear(), df.getMonth(), df.getDate()); const cur=new Date(start.getFullYear(), start.getMonth(), start.getDate()); while(cur.getTime()<=end.getTime()){ if(cur.getFullYear()===my && cur.getMonth()===mm){ a.push(cur.getDate()); } cur.setDate(cur.getDate()+1); } }catch(e){} return a; }
function diasConRegistro(matriz, ultimoDia){ const set={}; try{ const items=(matriz&&matriz.items)||{}; for(let d=1; d<=ultimoDia; d++){ for(const k in items){ const arr=items[k]||[]; const val=String(arr[d-1]||'').trim(); if(val){ set[d]=true; break; } } } }catch(e){} return set; }
function aplicarBloqueoFirmas(mes, ultimoDia, matrizCon, matrizAlt){ try{ const now=new Date(); const y=now.getFullYear(); const m=String(now.getMonth()+1).padStart(2,'0'); const mesActual=`${y}-${m}`; const diaActual=now.getDate(); const diasCon=diasConRegistro(matrizCon||{}, ultimoDia); const diasAlt=diasConRegistro(matrizAlt||{}, ultimoDia); document.querySelectorAll('.firma-click').forEach(td=>{ const d=parseInt(td.dataset.day||'0',10); const tipo=String(td.dataset.tipo||''); const isMonth=mes===mesActual; const isToday=isMonth && d===diaActual; const hasReg=(tipo==='confinado')? !!diasCon[d] : !!diasAlt[d]; const allow=isToday && hasReg; if(!allow){ td.classList.add('no-firma'); td.style.pointerEvents='none'; const msg=!isToday? 'Solo se puede firmar el día actual' : 'Solo se puede firmar si ya existe registro del día'; td.setAttribute('title', msg); } }); }catch(e){} }
function renderFirmasSemana(dias, tit, fTec, fSup){ function norm(v){ const t=(v||'').trim(); if(!t) return ''; if(t.startsWith('data:image')) return t; if(/^https?:\/\//.test(t) || t.startsWith('/')) return t; if(/^[A-Za-z0-9+/=]+$/.test(t) && t.length>100) return 'data:image/png;base64,'+t; return ''; } const wrap=document.createElement('div'); wrap.className='firmas-semana'; const h=document.createElement('div'); h.className='firmas-titulo'; h.textContent=tit; wrap.appendChild(h); const table=document.createElement('table'); table.className='firma-tabla'; const thead=document.createElement('thead'); const trh=document.createElement('tr'); const th0=document.createElement('th'); th0.textContent='Rol'; trh.appendChild(th0); dias.forEach(d=>{ const th=document.createElement('th'); th.textContent=String(d); trh.appendChild(th); }); thead.appendChild(trh); table.appendChild(thead); const tbody=document.createElement('tbody'); const trT=document.createElement('tr'); const thT=document.createElement('th'); thT.textContent='Técnico'; trT.appendChild(thT); dias.forEach(d=>{ const td=document.createElement('td'); const idx=d-1; const raw=(Array.isArray(fTec)? fTec[idx] : '')||''; const src=norm(raw); if(src){ const img=document.createElement('img'); img.className='firma-mini-img'; img.src=src; if(!src.startsWith('data:')) img.crossOrigin='anonymous'; td.appendChild(img); } else { td.textContent=raw; } trT.appendChild(td); }); const trS=document.createElement('tr'); const thS=document.createElement('th'); thS.textContent='Supervisor'; trS.appendChild(thS); dias.forEach(d=>{ const td=document.createElement('td'); td.className='firma-click'; const idx=d-1; const raw=(Array.isArray(fSup)? fSup[idx] : '')||''; const src=norm(raw); if(src){ const img=document.createElement('img'); img.className='firma-mini-img'; img.src=src; if(!src.startsWith('data:')) img.crossOrigin='anonymous'; td.appendChild(img); } else { td.textContent=raw; } const tipo=(tit.toLowerCase().indexOf('altura')>=0)?'altura':'confinado'; td.dataset.day=String(d); td.dataset.tipo=tipo; td.addEventListener('click',()=>{ const card=td.closest('.pt-semana'); const pidAttr=card? card.getAttribute('data-pid') : ''; const pid=pidAttr? parseInt(pidAttr,10):null; if(!pid){ Swal.fire('Error','No se encontró el ID del permiso para esa semana','error'); return; } abrirModalFirmaSupervisor({ tipo, dia:d, pid, td }); }); trS.appendChild(td); }); tbody.appendChild(trT); tbody.appendChild(trS); table.appendChild(tbody); wrap.appendChild(table); return wrap; }
function renderPermisoSemanal(permiso, info, mes, ultimoDia, firmas){ const frag=document.createDocumentFragment(); const semanas=Array.isArray(permiso?.semanas)? permiso.semanas : []; semanas.forEach((sem, idx)=>{ const card=document.createElement('div'); card.className='pt-semana avoid-break'; if(sem.id){ card.setAttribute('data-pid', String(sem.id)); } const title=document.createElement('div'); title.className='pt-semana-title'; const fi=(sem.fecha_emision||''); const ff=(sem.fecha_finalizacion||''); title.textContent=`SEMANA ${idx+1} · ${fi? fi:''}${ff? ' - '+ff:''}`; card.appendChild(title); let dias=diasEntre(fi, ff, mes).filter(d=>d<=ultimoDia); const dv=document.createElement('div'); dv.className='pt-semana-dias'; dv.textContent=dias.length? `Días: ${dias.join(', ')}` : ''; card.appendChild(dv); card.appendChild(renderTablaRespuestas(sem.respuestas||{})); card.appendChild(renderFirmasSemana(dias,'Espacios Confinados', firmas.firmas_confinado_tecnico||[], firmas.firmas_confinado_supervisor||[])); card.appendChild(renderFirmasSemana(dias,'Trabajos en Altura', firmas.firmas_altura_tecnico||[], firmas.firmas_altura_supervisor||[])); frag.appendChild(card); }); const br=document.createElement('div'); br.className='html2pdf__page-break'; frag.appendChild(br); return frag; }
function renderConfinado(matriz, ultimoDia){ const labels=[
  '1. Sitio aislado de energía','2. Ventilación adecuada u operando','3. Vigilancia y comunicación permanente','4. Iluminación suficiente/antiexplosiva','5. Equipos de acceso en buen estado','6. Procedimiento de rescate conocido','7. Se requieren 2 o más trabajadores','8. Cortar suministro de sustancias','9. Cortar energía eléctrica','10. Trabajador consciente de riesgos','11. Condiciones de trabajo/salud adecuadas'
]; const section=renderMatrizHeader(ultimoDia,'Espacios Confinados'); labels.forEach((lbl, i)=>{ const key=String(i+1); appendMatrizFila(section.tbody, lbl, (matriz?.items?.[key]||[]), ultimoDia); }); return section.wrap; }
function renderConfinadoDias(matriz, dias){ const labels=[
  '1. Sitio aislado de energía','2. Ventilación adecuada u operando','3. Vigilancia y comunicación permanente','4. Iluminación suficiente/antiexplosiva','5. Equipos de acceso en buen estado','6. Procedimiento de rescate conocido','7. Se requieren 2 o más trabajadores','8. Cortar suministro de sustancias','9. Cortar energía eléctrica','10. Trabajador consciente de riesgos','11. Condiciones de trabajo/salud adecuadas'
]; const section=renderMatrizHeaderDias(dias,'Espacios Confinados'); labels.forEach((lbl, i)=>{ const key=String(i+1); appendMatrizFilaDias(section.tbody, lbl, (matriz?.items?.[key]||[]), dias); }); return section.wrap; }
function renderAltura(matriz, ultimoDia){ const labels=[
  '1. Altura aproximada del trabajo','2. Señalizar y aislar la zona','3. Área libre de obstáculos','4. Procedimiento de trabajo seguro','5. EPCC en buenas condiciones','6. Personal apto y capacitado','7. Arnés en óptimas condiciones','8. Línea de vida/eslinga óptima','9. Absorbedor de energía aplica','10. Anclaje distinto a estructura soporte','11. Conector en buen estado','12. Conexión a punto de anclaje','13. Sistemas de acceso verificados','14. Andamio apto','15. Escalera apta','16. Línea de vida adicional','17. Herramientas/materiales asegurados','18. Proximidad a puntos de energía analizada','19. Condiciones ambientales verificadas','20. Punto de anclaje en posición segura','21. Procedimiento escrito de rescate','22. Brigadista disponible','23. Análisis de riesgos y controles','24. Condiciones de trabajo y salud adecuadas'
]; const section=renderMatrizHeader(ultimoDia,'Trabajos en Altura'); labels.forEach((lbl, i)=>{ const key=String(i+1); appendMatrizFila(section.tbody, lbl, (matriz?.items?.[key]||[]), ultimoDia); }); return section.wrap; }
function renderAlturaDias(matriz, dias){ const labels=[
  '1. Altura aproximada del trabajo','2. Señalizar y aislar la zona','3. Área libre de obstáculos','4. Procedimiento de trabajo seguro','5. EPCC en buenas condiciones','6. Personal apto y capacitado','7. Arnés en óptimas condiciones','8. Línea de vida/eslinga óptima','9. Absorbedor de energía aplica','10. Anclaje distinto a estructura soporte','11. Conector en buen estado','12. Conexión a punto de anclaje','13. Sistemas de acceso verificados','14. Andamio apto','15. Escalera apta','16. Línea de vida adicional','17. Herramientas/materiales asegurados','18. Proximidad a puntos de energía analizada','19. Condiciones ambientales verificadas','20. Punto de anclaje en posición segura','21. Procedimiento escrito de rescate','22. Brigadista disponible','23. Análisis de riesgos y controles','24. Condiciones de trabajo y salud adecuadas'
]; const section=renderMatrizHeaderDias(dias,'Trabajos en Altura'); labels.forEach((lbl, i)=>{ const key=String(i+1); appendMatrizFilaDias(section.tbody, lbl, (matriz?.items?.[key]||[]), dias); }); return section.wrap; }
function abrirDetalle(cedula, nombre){ const mes=document.getElementById('filtroMes').value; fetch(`/api/sgis/reportes/permiso-trabajo-matriz?cedula=${encodeURIComponent(cedula)}&mes=${encodeURIComponent(mes)}`).then(r=>r.json()).then(d=>{ if(d && d.success){ const info=d.info||{}; document.getElementById('plantNombre').textContent=info.nombre||nombre||''; document.getElementById('plantCedula').textContent=info.cedula||cedula||''; document.getElementById('plantMes').textContent=d.mes||''; document.getElementById('plantCargo').textContent=info.cargo||''; document.getElementById('plantArea').textContent=info.area||''; document.getElementById('plantSupervisor').textContent=info.super||''; document.getElementById('plantCliente').textContent=info.cliente||''; document.getElementById('plantCiudad').textContent=info.ciudad||''; const cont=document.getElementById('contenedorPermiso'); cont.innerHTML=''; ultimoMesPT=d.mes; ultimoDetallePT={ info:{ nombre:info.nombre||nombre||'', cedula:info.cedula||cedula||'' }, mes:d.mes }; const frag=document.createDocumentFragment(); const permiso=d.permiso||{}; const firmas={ firmas_confinado_tecnico:d.firmas_confinado_tecnico||[], firmas_confinado_supervisor:d.firmas_confinado_supervisor||[], firmas_altura_tecnico:d.firmas_altura_tecnico||[], firmas_altura_supervisor:d.firmas_altura_supervisor||[] }; frag.appendChild(renderPermisoSemanal(permiso, info, d.mes, d.ultimo_dia, firmas)); const sep1=document.createElement('div'); sep1.className='tpl-bar mb-2'; sep1.textContent='HISTORIAL DIARIO'; frag.appendChild(sep1); let diasCon=diasConRegistro(d.matriz_confinado||{}, d.ultimo_dia); let diasAlt=diasConRegistro(d.matriz_altura||{}, d.ultimo_dia); let diasAll=Array.from(new Set(Object.keys(diasCon).map(Number).concat(Object.keys(diasAlt).map(Number)))).sort((a,b)=>a-b); if(diasAll.length===0){ for(let i=1;i<=d.ultimo_dia;i++){ diasAll.push(i); } } const MAX_COLS=16; for(let i=0;i<diasAll.length;i+=MAX_COLS){ const chunk=diasAll.slice(i,i+MAX_COLS); frag.appendChild(renderConfinadoDias(d.matriz_confinado||{}, chunk)); frag.appendChild(renderAlturaDias(d.matriz_altura||{}, chunk)); if(i+MAX_COLS<diasAll.length){ const br=document.createElement('div'); br.className='html2pdf__page-break'; frag.appendChild(br); } } cont.appendChild(frag); const el=document.getElementById('encabezadoGlobal'); el.style.display='block';
          aplicarBloqueoFirmas(d.mes, d.ultimo_dia, d.matriz_confinado||{}, d.matriz_altura||{});
          new bootstrap.Modal(document.getElementById('modalDetallePermiso')).show(); } else { Swal.fire('Error', d.error||'No se pudo cargar el reporte', 'error'); } }).catch(()=>{ Swal.fire('Error','No se pudo cargar el reporte', 'error'); }); }
function exportarPDF(){ if(!ultimoDetallePT){ Swal.fire('Sin datos','Abre un técnico antes de exportar','info'); return; } const nombre=(ultimoDetallePT.info?.nombre||'').replace(/[^A-Za-z0-9_\- ]/g,''); const ced=(ultimoDetallePT.info?.cedula||'').replace(/[^0-9]/g,''); const archivo=`Permiso_Trabajo_${ced || nombre}_${ultimoDetallePT.mes}.pdf`; const hasH2C=!!window.html2canvas; const jsPDFCtor=(window.jspdf&&window.jspdf.jsPDF)? window.jspdf.jsPDF : window.jsPDF; const hasJspdf=!!jsPDFCtor; if(!(hasH2C && hasJspdf)){ const el=document.querySelector('#modalDetallePermiso .modal-content'); if(window.html2pdf){ const opt={ margin:10, filename:archivo, image:{ type:'jpeg', quality:0.95 }, html2canvas:{ scale:2, useCORS:true, scrollY:0 }, jsPDF:{ unit:'pt', format:'letter', orientation:'landscape' }, pagebreak:{ mode:['css','legacy'], avoid: ['.avoid-break'] } }; window.html2pdf().from(el).set(opt).save(); } else { Swal.fire('Error','No se encontraron librerías de exportación','error'); } return; } const enc=document.getElementById('encabezadoGlobal'); const cont=document.getElementById('contenedorPermiso'); const semanas=Array.from(cont.querySelectorAll('.pt-semana')); const g1=['Descripción y Herramienta','Herramientas (Inspección)','Condiciones del Área','Peligros Identificados']; const g2=['Elementos de Protección','Comunicación de Riesgos','Verificación de Documentación','Otros']; const gAll=g1.concat(g2); function makePage(allowed, includeFirmas, includeHeader){ const page=document.createElement('div'); page.style.padding='10px'; page.style.background='#fff'; page.style.position='fixed'; page.style.left='-10000px'; page.style.top='0'; if(enc && includeHeader){ page.appendChild(enc.cloneNode(true)); } semanas.forEach(card=>{ const c=card.cloneNode(true); Array.from(c.querySelectorAll('.pt-seccion')).forEach(sec=>{ const t=sec.querySelector('.pt-sec-title'); const txt=(t?t.textContent:'').trim(); if(allowed && !allowed.includes(txt)){ sec.remove(); } }); if(!includeFirmas){ Array.from(c.querySelectorAll('.firmas-semana')).forEach(n=>n.remove()); } page.appendChild(c); }); document.body.appendChild(page); return page; } function getRangoUltimaSemana(){ if(semanas.length){ const last=semanas[semanas.length-1]; const dv=last.querySelector('.pt-semana-dias'); const txt=(dv? dv.textContent:'').trim().replace(/^Días:\s*/, ''); const arr=txt.split(',').map(s=>parseInt(s.trim(),10)).filter(n=>!isNaN(n)); if(arr.length){ const a=Math.min.apply(null, arr); const b=Math.max.apply(null, arr); return a+' - '+b; } } const pm=(ultimoDetallePT && ultimoDetallePT.mes) || ''; const sp=String(pm).split('-'); const u=new Date(parseInt(sp[0]||'0',10), parseInt(sp[1]||'0',10), 0).getDate(); return '22 - '+u; } function makeSingleFromTitle(title, includeHeader, showHistHeader){ const h=Array.from(cont.querySelectorAll('h6')).find(x=>String(x.textContent||'').indexOf(title)>=0); if(!h){ return null; } const page=document.createElement('div'); page.style.padding='10px'; page.style.background='#fff'; page.style.position='fixed'; page.style.left='-10000px'; page.style.top='0'; if(enc && includeHeader){ page.appendChild(enc.cloneNode(true)); } if(showHistHeader){ const bar=document.createElement('div'); bar.className='tpl-bar mb-2'; bar.textContent=`HISTORIAL DIARIO · ${title}`; page.appendChild(bar); const sub=document.createElement('div'); sub.className='pt-semana-dias'; sub.textContent='Semana: '+getRangoUltimaSemana(); page.appendChild(sub); } page.appendChild(h.parentElement.cloneNode(true)); document.body.appendChild(page); return page; } function cleanup(nodes){ nodes.forEach(n=>{ if(n && n.parentNode) n.parentNode.removeChild(n); }); } const p1=makePage(gAll,true,false); const p2=makeSingleFromTitle('Espacios Confinados',true,true); const p3=makeSingleFromTitle('Trabajos en Altura',true,true); const pdf=new jsPDFCtor({ unit:'pt', format:'letter', orientation:'landscape' }); const margin=20; function renderAdd(el, first){ return window.html2canvas(el,{ scale:2, useCORS:true, scrollY:0 }).then(canvas=>{ if(!first){ pdf.addPage('letter','landscape'); } const pdfW=pdf.internal.pageSize.getWidth(); const pdfH=pdf.internal.pageSize.getHeight(); const maxW=pdfW - margin*2; const maxH=pdfH - margin*2; const ratio=Math.min(maxW / canvas.width, maxH / canvas.height); const imgW=canvas.width * ratio; const imgH=canvas.height * ratio; const x=margin + (maxW - imgW)/2; const y=margin + (maxH - imgH)/2; const dataUrl=canvas.toDataURL('image/jpeg',0.95); pdf.addImage(dataUrl,'JPEG',x,y,imgW,imgH); }); } renderAdd(p1,true).then(()=>renderAdd(p2,false)).then(()=>renderAdd(p3,false)).then(()=>{ pdf.save(archivo); cleanup([p1,p2,p3]); }).catch(()=>{ cleanup([p1,p2,p3]); Swal.fire('Error','No se pudo exportar el PDF','error'); }); }
let firmaSupCtx=null, firmaSupFirmando=false, firmaSupModal=null, firmaSupTarget=null;
function abrirModalFirmaSupervisor(ctx){ firmaSupTarget=ctx; if(!firmaSupModal){ firmaSupModal=new bootstrap.Modal(document.getElementById('modalFirmaSupervisor')); } firmaSupModal.show(); const c=document.getElementById('firmaCanvasSupervisor'); const pos=(e)=>{ const r=c.getBoundingClientRect(); const x=(e.touches? e.touches[0].clientX : e.clientX)-r.left; const y=(e.touches? e.touches[0].clientY : e.clientY)-r.top; return {x,y}; }; firmaSupCtx=c.getContext('2d'); firmaSupCtx.strokeStyle='#222'; firmaSupCtx.lineWidth=2; const start=(e)=>{ firmaSupFirmando=true; const p=pos(e); firmaSupCtx.beginPath(); firmaSupCtx.moveTo(p.x,p.y); e.preventDefault(); }; const move=(e)=>{ if(!firmaSupFirmando) return; const p=pos(e); firmaSupCtx.lineTo(p.x,p.y); firmaSupCtx.stroke(); e.preventDefault(); }; const end=()=>{ firmaSupFirmando=false; }; c.onmousedown=start; c.onmousemove=move; window.onmouseup=end; c.ontouchstart=(e)=>start(e); c.ontouchmove=(e)=>move(e); window.ontouchend=end; }
function limpiarFirmaSupervisor(){ const c=document.getElementById('firmaCanvasSupervisor'); const ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height); }
function guardarFirmaSupervisor(){
  if(!firmaSupTarget) return;
  const c=document.getElementById('firmaCanvasSupervisor');
  const dataUrl=c.toDataURL('image/png');
  const dia=firmaSupTarget.dia;
  const tipo=firmaSupTarget.tipo;
  const pid=firmaSupTarget.pid;
  const fecha=(ultimoMesPT||'')+'-'+String(dia).padStart(2,'0');
  let url='', payload={};
  if(tipo==='confinado'){
    url='/api/sgis/permiso-trabajo/historial/confinado';
    payload={ id_sgis_permiso_trabajo: pid, sgis_permiso_trabajo_historial_confinado_fecha: fecha, sgis_permiso_trabajo_historial_confinado_firma_supervisor: dataUrl };
  } else {
    url='/api/sgis/permiso-trabajo/historial/alturas';
    payload={ id_sgis_permiso_trabajo: pid, sgis_permiso_trabajo_historial_altura_fecha: fecha, sgis_permiso_trabajo_historial_semanal_altura_firma_supervisor: dataUrl };
  }
  fetch(url,{ method:'POST', headers:{ 'Content-Type':'application/json' }, body:JSON.stringify(payload) })
    .then(async r=>{
      const ct=r.headers.get('Content-Type')||'';
      let data=null;
      try{ data=ct.includes('application/json')? await r.json() : null; }catch(e){ data=null; }
      if(r.ok) return data||{};
      const msg=(data && (data.message||data.error)) || 'No se pudo guardar la firma';
      throw new Error(msg);
    })
    .then(()=>{
      const td=firmaSupTarget.td;
      td.innerHTML='';
      const img=document.createElement('img');
      img.className='firma-mini-img';
      img.src=dataUrl;
      td.appendChild(img);
      if(firmaSupModal){ firmaSupModal.hide(); }
      limpiarFirmaSupervisor();
    })
    .catch(err=>{
      Swal.fire('Error', err.message||'No se pudo guardar la firma', 'error');
    });
}
function exportarPDFMejorado(){ if(!ultimoDetallePT){ Swal.fire('Sin datos','Abre un técnico antes de exportar','info'); return; } const nombre=(ultimoDetallePT.info?.nombre||'').replace(/[^A-Za-z0-9_\- ]/g,''); const ced=(ultimoDetallePT.info?.cedula||'').replace(/[^0-9]/g,''); const archivo=`Permiso_Trabajo_${ced || nombre}_${ultimoDetallePT.mes}.pdf`; const el=document.querySelector('#modalDetallePermiso .modal-content'); if(window.html2pdf){ const opt={ margin:12, filename:archivo, image:{ type:'jpeg', quality:0.98 }, html2canvas:{ scale:2, useCORS:true, scrollY:0, background:'#ffffff' }, jsPDF:{ unit:'pt', format:'letter', orientation:'portrait' }, pagebreak:{ mode:['css','legacy'], avoid: ['.avoid-break'] } }; window.html2pdf().from(el).set(opt).save(); } else { exportarPDF(); } }
document.addEventListener('DOMContentLoaded', function(){ setMesInicial(); const btn=document.getElementById('btnCargar'); if(btn) btn.addEventListener('click', cargarTecnicos); const bp=document.getElementById('btnExportarPDF'); if(bp){ bp.addEventListener('click', exportarPDFMejorado); } const bl=document.getElementById('btnLimpiarFirmaSupervisor'); if(bl){ bl.addEventListener('click', limpiarFirmaSupervisor); } const bg=document.getElementById('btnGuardarFirmaSupervisor'); if(bg){ bg.addEventListener('click', guardarFirmaSupervisor); } });
</script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
{% endblock %}
