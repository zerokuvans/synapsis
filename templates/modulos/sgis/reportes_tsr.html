{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #1e293b 0%, #06b6d4 100%) !important;">
          <h4 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Reportes SGIS · Análisis de Trabajo Seguro Rutinario</h4>
        </div>
        <div class="card-body">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Mes</label>
              <input type="month" id="filtroMes" class="form-control">
            </div>
            <div class="col-md-4 align-self-end">
              <button id="btnCargar" class="btn btn-info w-100"><i class="fas fa-sync me-2"></i>Cargar técnicos</button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped" id="tablaTecnicos">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Cédula</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalDetalleTSR" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clipboard-list me-2"></i>Análisis mensual TSR</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <style>
          .tpl-bar{background:#0f3d61;color:#fff;border-radius:4px;padding:.35rem .6rem;font-weight:600;letter-spacing:.2px}
          .tpl-grid{border:1px solid #0f3d61;border-radius:6px;overflow:hidden}
          .tpl-grid .row{margin:0}
          .tpl-label{font-size:.8rem;color:#6c757d}
          .tpl-box{border:1px solid #dee2e6;border-radius:4px;min-height:32px;padding:.25rem .5rem}
          .tpl-seccion-title{display:flex;align-items:center;gap:.5rem;background:#0f3d61;color:#fff;padding:.4rem .6rem;border-radius:4px;margin:10px 0}
          .tpl-head-days th{min-width:28px;text-align:center}
          .tpl-firma{border-top:3px solid #0f3d61;margin-top:12px;padding-top:10px}
          .tpl-firma .firma-box{border:1px solid #0f3d61;border-radius:4px;height:120px}
          .firma-img{width:120px;height:120px;object-fit:contain}
          .tpl-observ{border-top:3px solid #0f3d61;margin-top:12px;padding-top:8px}
          .tpl-observ .observ-box{border:1px dashed #adb5bd;border-radius:4px;min-height:60px;padding:.5rem}
          #modalDetalleTSR .modal-dialog{max-width:96vw}
          #contenedorTSR{overflow-x:auto}
          #contenedorTSR table{table-layout:auto;width:100%}
          #contenedorTSR thead th:first-child{width:360px;text-align:left}
          #contenedorTSR thead th:nth-child(n+2),#contenedorTSR tbody td{min-width:28px;text-align:center}
          #contenedorTSR tbody th{font-weight:500}
          .tsr-semana{border:1px solid #0f3d61;border-radius:6px;margin-bottom:12px;padding:10px}
          .tsr-semana-title{background:#0f3d61;color:#fff;border-radius:4px;padding:.35rem .6rem;font-weight:600;margin-bottom:8px}
          .tpl-week-head th{text-align:center}
          .day-label{font-weight:600}
          .day-sub{font-size:.8rem;color:#6c757d}
          .visit-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
          .visit-cell{border:1px solid #dee2e6;min-height:22px;font-size:.75rem;line-height:22px}
          .visit-cell-success{background:#d1e7dd}
          .visit-cell-danger{background:#f8d7da}
          .visit-cell-secondary{background:#e2e3e5}
          .firma-dia-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
          .firma-day-title{font-weight:600;margin-bottom:4px}
          .firma-box-mini{border:1px solid #0f3d61;border-radius:4px;height:90px;display:flex;align-items:center;justify-content:center}
          .firma-mini-img{max-width:100%;max-height:88px;object-fit:contain}
          .firma-mini-label{font-size:.75rem;color:#6c757d;margin-bottom:2px;min-height:16px}
          .firma-mini-label-tec{color:#0d6efd}
          .firma-mini-label-sup{color:#198754}
        </style>
        <div class="tpl-grid p-3 mb-3" id="encabezadoGlobal" style="display:none">
          <div class="tpl-bar mb-2">ANÁLISIS DE TRABAJO SEGURO RUTINARIO</div>
          <div class="row g-2 mb-2">
            <div class="col-sm-6">
              <div class="tpl-label">Nombre y apellidos</div>
              <div class="tpl-box" id="plantNombre"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Identificación</div>
              <div class="tpl-box" id="plantCedula"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Mes</div>
              <div class="tpl-box" id="plantMes"></div>
            </div>
          </div>
          <div class="row g-2">
            <div class="col-sm-3">
              <div class="tpl-label">Cargo</div>
              <div class="tpl-box" id="plantCargo"></div>
            </div>
            <div class="col-sm-3">
              <div class="tpl-label">Área</div>
              <div class="tpl-box" id="plantArea"></div>
            </div>
          </div>
        </div>
        <div id="contenedorTSR"></div>
        
        <div class="small text-muted mt-2">Leyenda: C = Cumple · NC = No Cumple · N/A = No Aplica</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-info" id="btnExportarPDF"><i class="fas fa-file-pdf me-2"></i>Exportar PDF</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<script>
let ultimoDetalle = null;
let ultimoNoLaborales = null;
function valorMesActual(){ const d = new Date(); const m = String(d.getMonth()+1).padStart(2,'0'); return `${d.getFullYear()}-${m}`; }
function setMesInicial(){ const i = document.getElementById('filtroMes'); if(i && !i.value) i.value = valorMesActual(); }
function cargarTecnicos(){ const mes = document.getElementById('filtroMes').value; fetch(`/api/sgis/reportes/tecnicos-mes?mes=${encodeURIComponent(mes)}`).then(r=>r.json()).then(d=>{ const tbody = document.querySelector('#tablaTecnicos tbody'); tbody.innerHTML=''; if(d && d.success && Array.isArray(d.data)){ d.data.forEach(t=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${t.nombre||''}</td><td>${t.cedula||''}</td><td><button class="btn btn-outline-info btn-sm" data-cedula="${t.cedula}" data-nombre="${t.nombre}"><i class="fas fa-clipboard-list me-1"></i>Analisis TSR</button></td>`; tbody.appendChild(tr); }); tbody.querySelectorAll('button').forEach(btn=>{ btn.addEventListener('click',()=>{ abrirDetalle(btn.getAttribute('data-cedula'), btn.getAttribute('data-nombre')); }); }); } else { Swal.fire('Sin datos','No hay técnicos con asistencia en el mes','info'); } }).catch(()=>{ Swal.fire('Error','No se pudo cargar técnicos','error'); }); }
function renderHeaderDias(ultimoDia){ const tr=document.createElement('tr'); const thItem=document.createElement('th'); thItem.textContent='EVALUACIÓN'; tr.appendChild(thItem); for(let d=1; d<=31; d++){ const th=document.createElement('th'); th.textContent=d<=ultimoDia? d : ''; tr.appendChild(th); } return tr; }
function renderFila(label, valores, ultimoDia){ const tr=document.createElement('tr'); const th=document.createElement('th'); th.innerHTML=`<span>${label}</span>`; tr.appendChild(th); for(let i=0;i<31;i++){ const td=document.createElement('td'); const day=i+1; let v=(valores[i]||'').trim(); if(day<=ultimoDia && !v && ultimoNoLaborales && ultimoNoLaborales.has(day)) v='N/A'; td.textContent=v; if(v==='NC') td.className='table-danger'; else if(v==='C') td.className='table-success'; else if(v==='N/A') td.className='table-secondary'; tr.appendChild(td); } return tr; }
function renderSeccionEvaluacion(evals, ultimoDia){ const div=document.createElement('div'); div.className='mb-3'; const h6=document.createElement('h6'); h6.className='mb-2'; h6.textContent='EVALUACIÓN'; div.appendChild(h6); const table=document.createElement('table'); table.className='table table-bordered'; const thead=document.createElement('thead'); thead.appendChild(renderHeaderDias(ultimoDia)); table.appendChild(thead); const tbody=document.createElement('tbody'); const labels=[
  '1. Planeación del trabajo','2. Inspección del área','3. Herramientas en buen estado','4. EPP completo','5. Riesgos identificados','6. Señalización adecuada','7. Orden y limpieza','8. Condiciones ambientales seguras','9. Riesgos eléctricos controlados','10. Trabajo en alturas seguro','11. Riesgo de caídas controlado','12. Uso correcto de herramientas manuales','13. Estado físico para la tarea','14. Comunicación clara con el equipo','15. Ruta y desplazamiento seguro','16. Integridad de materiales','17. Control final antes de iniciar'
]; const keys=['res1','res2','res3','res4','res5','res6','res7','res8','res9','res10','res11','res12','res13','res14','res15','res16','res17']; keys.forEach((k, idx)=>{ tbody.appendChild(renderFila(labels[idx], evals[k]||[], ultimoDia)); }); table.appendChild(tbody); div.appendChild(table); return div; }
function renderSeccionRiesgos(riesgos, ultimoDia){ const div=document.createElement('div'); div.className='mb-3'; const h6=document.createElement('h6'); h6.className='mb-2'; h6.textContent='RIESGOS Y CONTROLES'; div.appendChild(h6); const table=document.createElement('table'); table.className='table table-bordered'; const thead=document.createElement('thead'); const trh=document.createElement('tr'); const thItem=document.createElement('th'); thItem.textContent='GENERALIDADES'; trh.appendChild(thItem); for(let d=1; d<=31; d++){ const th=document.createElement('th'); th.textContent=d<=ultimoDia? d : ''; trh.appendChild(th); } thead.appendChild(trh); table.appendChild(thead); const tbody=document.createElement('tbody'); const filas=[
  {label:'Riesgo', valores: riesgos.riesgo||[]},
  {label:'Peligro', valores: riesgos.peligro||[]},
  {label:'Consecuencia', valores: riesgos.consecuencia||[]},
  {label:'Controles', valores: riesgos.control||[]}
]; filas.forEach(f=>{ const tr=document.createElement('tr'); const th=document.createElement('th'); th.className='item-label'; th.innerHTML=`<span>${f.label}</span>`; tr.appendChild(th); for(let i=0;i<31;i++){ const td=document.createElement('td'); const day=i+1; let v=(f.valores[i]||'').trim(); if(day<=ultimoDia && !v && ultimoNoLaborales && ultimoNoLaborales.has(day)) v=''; td.textContent=v; tr.appendChild(td); } tbody.appendChild(tr); }); table.appendChild(tbody); div.appendChild(table); return div; }
function colombiaFestivos(year){ const res=[]; res.push(new Date(year,0,1)); res.push(new Date(year,4,1)); res.push(new Date(year,6,20)); res.push(new Date(year,7,7)); res.push(new Date(year,11,8)); res.push(new Date(year,11,25)); return res; }
function computeNoLaboralSet(mes, ultimoDia){ const parts=mes.split('-'); const year=Number(parts[0]); const month=Number(parts[1])-1; const hol=colombiaFestivos(year); const set=new Set(); for(let d=1; d<=ultimoDia; d++){ const dt=new Date(year, month, d); if(dt.getDay()===0) set.add(d); } hol.forEach(h=>{ if(h.getFullYear()===year && h.getMonth()===month) set.add(h.getDate()); }); return set; }
function diasSemana(){ return ['Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Domingo']; }
function computeWeeksCalendar(mes, ultimoDia){ const parts=mes.split('-'); const year=Number(parts[0]); const month=Number(parts[1])-1; const weeks=[]; let week=new Array(7).fill(null); let firstDow=(new Date(year, month, 1)).getDay(); let idx=((firstDow+6)%7); week[idx]=1; for(let d=2; d<=ultimoDia; d++){ const dow=(new Date(year, month, d)).getDay(); const i=((dow+6)%7); if(i===0){ weeks.push(week); week=new Array(7).fill(null); } week[i]=d; } weeks.push(week); return weeks; }
function renderTablaSemanaEvaluacion(evals, semana, mes, ultimoDia, semanaIndex){ const table=document.createElement('table'); table.className='table table-bordered'; const thead=document.createElement('thead'); const trh=document.createElement('tr'); const th0=document.createElement('th'); th0.textContent='EVALUACIÓN'; trh.appendChild(th0); const dsem=diasSemana(); for(let i=0;i<7;i++){ const th=document.createElement('th'); const dom=semana[i]; const cont=document.createElement('div'); const lbl=document.createElement('div'); lbl.className='day-label'; lbl.textContent=dsem[i]; const sub=document.createElement('div'); sub.className='day-sub'; sub.textContent=dom? String(dom) : ''; cont.appendChild(lbl); cont.appendChild(sub); th.appendChild(cont); trh.appendChild(th); } thead.appendChild(trh); table.appendChild(thead); const tbody=document.createElement('tbody'); const labels=['1. Planeación del trabajo','2. Inspección del área','3. Herramientas en buen estado','4. EPP completo','5. Riesgos identificados','6. Señalización adecuada','7. Orden y limpieza','8. Condiciones ambientales seguras','9. Riesgos eléctricos controlados','10. Trabajo en alturas seguro','11. Riesgo de caídas controlado','12. Uso correcto de herramientas manuales','13. Estado físico para la tarea','14. Comunicación clara con el equipo','15. Ruta y desplazamiento seguro','16. Integridad de materiales','17. Control final antes de iniciar']; const keys=['res1','res2','res3','res4','res5','res6','res7','res8','res9','res10','res11','res12','res13','res14','res15','res16','res17']; keys.forEach((k, idx)=>{ const tr=document.createElement('tr'); const th=document.createElement('th'); th.innerHTML=`<span>${labels[idx]}</span>`; tr.appendChild(th); for(let i=0;i<7;i++){ const td=document.createElement('td'); const dom=semana[i]; if(dom){ const valoresDia=Array.isArray((evals[k]||[])[dom-1])? (evals[k]||[])[dom-1] : []; const grid=document.createElement('div'); grid.className='visit-grid'; const isNAL=ultimoNoLaborales && ultimoNoLaborales.has(dom); for(let vIdx=0; vIdx<7; vIdx++){ const v=(valoresDia[vIdx]||'').trim() || (isNAL? 'N/A' : ''); const cell=document.createElement('div'); cell.className='visit-cell'; cell.textContent=v; if(v==='C') cell.classList.add('visit-cell-success'); else if(v==='NC') cell.classList.add('visit-cell-danger'); else if(v==='N/A') cell.classList.add('visit-cell-secondary'); grid.appendChild(cell); } td.appendChild(grid); } tr.appendChild(td); } tbody.appendChild(tr); }); table.appendChild(tbody); return table; }
function renderTablaSemanaRiesgos(riesgos, semana){ const table=document.createElement('table'); table.className='table table-bordered'; const thead=document.createElement('thead'); const trh=document.createElement('tr'); const th0=document.createElement('th'); th0.textContent='GENERALIDADES'; trh.appendChild(th0); const dsem=diasSemana(); for(let i=0;i<7;i++){ const th=document.createElement('th'); const dom=semana[i]; const cont=document.createElement('div'); const lbl=document.createElement('div'); lbl.className='day-label'; lbl.textContent=dsem[i]; const sub=document.createElement('div'); sub.className='day-sub'; sub.textContent=dom? String(dom) : ''; cont.appendChild(lbl); cont.appendChild(sub); th.appendChild(cont); trh.appendChild(th); } thead.appendChild(trh); table.appendChild(thead); const tbody=document.createElement('tbody'); const filas=[ {label:'Riesgo', valores: riesgos.riesgo||[]}, {label:'Peligro', valores: riesgos.peligro||[]}, {label:'Consecuencia', valores: riesgos.consecuencia||[]}, {label:'Controles', valores: riesgos.control||[]} ]; filas.forEach(f=>{ const tr=document.createElement('tr'); const th=document.createElement('th'); th.innerHTML=`<span>${f.label}</span>`; tr.appendChild(th); for(let i=0;i<7;i++){ const td=document.createElement('td'); const dom=semana[i]; if(dom){ const v=(f.valores[dom-1]||'').trim(); td.textContent=v; } tr.appendChild(td); } tbody.appendChild(tr); }); table.appendChild(tbody); return table; }
function renderEncabezado(info, mes){ const grid=document.createElement('div'); grid.className='tpl-grid p-3 mb-3'; const bar=document.createElement('div'); bar.className='tpl-bar mb-2'; bar.textContent='ANÁLISIS DE TRABAJO SEGURO RUTINARIO'; grid.appendChild(bar); const row1=document.createElement('div'); row1.className='row g-2 mb-2'; const c1=document.createElement('div'); c1.className='col-sm-6'; const l1=document.createElement('div'); l1.className='tpl-label'; l1.textContent='Nombre y apellidos'; const b1=document.createElement('div'); b1.className='tpl-box'; b1.textContent=info?.nombre||''; c1.appendChild(l1); c1.appendChild(b1); const c2=document.createElement('div'); c2.className='col-sm-3'; const l2=document.createElement('div'); l2.className='tpl-label'; l2.textContent='Identificación'; const b2=document.createElement('div'); b2.className='tpl-box'; b2.textContent=info?.cedula||''; c2.appendChild(l2); c2.appendChild(b2); const c3=document.createElement('div'); c3.className='col-sm-3'; const l3=document.createElement('div'); l3.className='tpl-label'; l3.textContent='Mes'; const b3=document.createElement('div'); b3.className='tpl-box'; b3.textContent=mes||''; c3.appendChild(l3); c3.appendChild(b3); row1.appendChild(c1); row1.appendChild(c2); row1.appendChild(c3); grid.appendChild(row1); const row2=document.createElement('div'); row2.className='row g-2'; const c4=document.createElement('div'); c4.className='col-sm-3'; const l4=document.createElement('div'); l4.className='tpl-label'; l4.textContent='Cargo'; const b4=document.createElement('div'); b4.className='tpl-box'; b4.textContent=info?.cargo||''; c4.appendChild(l4); c4.appendChild(b4); const c5=document.createElement('div'); c5.className='col-sm-3'; const l5=document.createElement('div'); l5.className='tpl-label'; l5.textContent='Área'; const b5=document.createElement('div'); b5.className='tpl-box'; b5.textContent=info?.area||''; c5.appendChild(l5); c5.appendChild(b5); row2.appendChild(c4); row2.appendChild(c5); grid.appendChild(row2); return grid; }
function renderSemanasTSR(matriz, mes, ultimoDia, info){ const frag=document.createDocumentFragment(); const weeks=computeWeeksCalendar(mes, ultimoDia); weeks.forEach((semana, idx)=>{ const wrap=document.createElement('div'); wrap.className='tsr-semana'; wrap.appendChild(renderEncabezado(info, mes)); const title=document.createElement('div'); title.className='tsr-semana-title'; title.textContent=`SEMANA ${idx+1}`; wrap.appendChild(title); wrap.appendChild(renderTablaSemanaEvaluacion(matriz.evaluacion||{}, semana, mes, ultimoDia, idx)); const sep=document.createElement('div'); sep.className='tpl-seccion-title'; sep.textContent='RIESGOS Y CONTROLES'; wrap.appendChild(sep); wrap.appendChild(renderTablaSemanaRiesgos(matriz.riesgos_controles||{}, semana)); frag.appendChild(wrap); }); return frag; }
function renderObservacionesSemana(observaciones, semana){ const div=document.createElement('div'); div.className='tpl-observ'; const bar=document.createElement('div'); bar.className='tpl-bar mb-2'; bar.textContent='Observaciones por día'; const box=document.createElement('div'); box.className='observ-box'; const lines=[]; for(let i=0;i<7;i++){ const dom=semana[i]; if(dom){ const t=(observaciones[dom-1]||'').trim(); if(t){ lines.push(`Día ${dom}: ${t}`); } } } box.innerHTML=lines.length? lines.join('<br>') : ''; div.appendChild(bar); div.appendChild(box); return div; }
function normalizarFirma(v){ const t=(v||'').trim(); if(!t) return ''; if(t.startsWith('data:image')) return t; if(/^https?:\/\//.test(t) || t.startsWith('/')) return t; if(/^[A-Za-z0-9+/=]+$/.test(t) && t.length>100) return 'data:image/png;base64,'+t; return ''; }
function renderFirmasSemana(firmasTrab, firmasSup, semana){ const div=document.createElement('div'); div.className='tpl-firma'; const bar=document.createElement('div'); bar.className='tpl-bar mb-2'; bar.textContent='Firmas por día'; div.appendChild(bar); const grid=document.createElement('div'); grid.className='firma-dia-grid'; for(let i=0;i<7;i++){ const dom=semana[i]; const cell=document.createElement('div'); const title=document.createElement('div'); title.className='firma-day-title'; title.textContent=dom? `Día ${dom}` : ''; cell.appendChild(title); const rowLabels=document.createElement('div'); rowLabels.className='d-flex gap-2'; const lblTec=document.createElement('div'); lblTec.className='firma-mini-label'; const lblSup=document.createElement('div'); lblSup.className='firma-mini-label'; const row=document.createElement('div'); row.className='d-flex gap-2'; const boxTecn=document.createElement('div'); boxTecn.className='firma-box-mini'; const boxSup=document.createElement('div'); boxSup.className='firma-box-mini'; let s1=''; let s2=''; if(dom){ s1=normalizarFirma((firmasTrab[dom-1]||'')); s2=normalizarFirma((firmasSup[dom-1]||'')); if(s1){ lblTec.textContent='Técnico'; lblTec.className='firma-mini-label firma-mini-label-tec'; const img1=document.createElement('img'); img1.className='firma-mini-img'; img1.src=s1; if(!s1.startsWith('data:')) img1.crossOrigin='anonymous'; boxTecn.appendChild(img1); } else { boxTecn.textContent='Técnico'; } if(s2){ lblSup.textContent='Supervisor'; lblSup.className='firma-mini-label firma-mini-label-sup'; const img2=document.createElement('img'); img2.className='firma-mini-img'; img2.src=s2; if(!s2.startsWith('data:')) img2.crossOrigin='anonymous'; boxSup.appendChild(img2); } else { boxSup.textContent='Supervisor'; } } else { boxTecn.textContent='Técnico'; boxSup.textContent='Supervisor'; } const labels=[]; if(lblTec.textContent) labels.push(lblTec); if(lblSup.textContent) labels.push(lblSup); if(labels.length){ labels.forEach(el=>rowLabels.appendChild(el)); cell.appendChild(rowLabels); } row.appendChild(boxTecn); row.appendChild(boxSup); cell.appendChild(row); grid.appendChild(cell); } div.appendChild(grid); return div; }
function abrirDetalle(cedula, nombre){ const mes=document.getElementById('filtroMes').value; fetch(`/api/sgis/reportes/tsr-matriz?cedula=${encodeURIComponent(cedula)}&mes=${encodeURIComponent(mes)}`).then(r=>r.json()).then(d=>{ if(d && d.success){ const info=d.info||{}; document.getElementById('plantNombre').textContent=info.nombre||nombre||''; document.getElementById('plantCedula').textContent=info.cedula||cedula||''; document.getElementById('plantMes').textContent=d.mes||''; document.getElementById('plantCargo').textContent=info.cargo||''; document.getElementById('plantArea').textContent=info.area||''; const cont=document.getElementById('contenedorTSR'); cont.innerHTML=''; const u=d.ultimo_dia||new Date(Number(d.mes.split('-')[0]), Number(d.mes.split('-')[1]), 0).getDate(); const m=d.matriz||{}; const obs=Array.isArray(d.observaciones)? d.observaciones : []; ultimoDetalle={ mes:d.mes, ultimoDia:u, info:{ nombre: info.nombre||nombre||'', cedula: info.cedula||cedula||'', cargo: info.cargo||'', area: info.area||'' }, matriz:m, observaciones: obs, firmas: Array.isArray(d.firmas)? d.firmas : [], firmasSupervisor: Array.isArray(d.firmas_supervisor)? d.firmas_supervisor : [] }; ultimoNoLaborales=computeNoLaboralSet(d.mes, u); const weeks=computeWeeksCalendar(d.mes, u); const frag=document.createDocumentFragment(); weeks.forEach((semana, idx)=>{ const wrap=document.createElement('div'); wrap.className='tsr-semana'; wrap.appendChild(renderEncabezado(ultimoDetalle.info, d.mes)); const title=document.createElement('div'); title.className='tsr-semana-title'; title.textContent=`SEMANA ${idx+1}`; wrap.appendChild(title); wrap.appendChild(renderTablaSemanaEvaluacion(m.evaluacion||{}, semana, d.mes, u, idx)); const sep=document.createElement('div'); sep.className='tpl-seccion-title'; sep.textContent='RIESGOS Y CONTROLES'; wrap.appendChild(sep); wrap.appendChild(renderTablaSemanaRiesgos(m.riesgos_controles||{}, semana)); wrap.appendChild(renderObservacionesSemana(ultimoDetalle.observaciones||[], semana)); wrap.appendChild(renderFirmasSemana(ultimoDetalle.firmas||[], ultimoDetalle.firmasSupervisor||[], semana)); frag.appendChild(wrap); }); cont.appendChild(frag); aplicarFirmasSemana(ultimoDetalle); const modal=new bootstrap.Modal(document.getElementById('modalDetalleTSR')); modal.show(); } else { Swal.fire('Sin datos','No hay registros para este técnico','info'); } }).catch(()=>{ Swal.fire('Error','No se pudo cargar detalle','error'); }); }
function aplicarFirmasSemana(det){ const u=det.ultimoDia||new Date(Number(det.mes.split('-')[0]), Number(det.mes.split('-')[1]), 0).getDate(); const firmasArr=Array.isArray(det.firmas)? det.firmas : []; function normalizar(v){ const t=(v||'').trim(); if(!t) return ''; if(t.startsWith('data:image')) return t; if(/^https?:\/\//.test(t) || t.startsWith('/')) return t; if(/^[A-Za-z0-9+/=]+$/.test(t) && t.length>100) return 'data:image/png;base64,'+t; return ''; } const semanas=computeWeeksCalendar(det.mes, u); const resultados=semanas.slice(0,4).map(semana=>{ let src=''; for(let i=0;i<7;i++){ const dom=semana[i]; if(dom){ const f=firmasArr[dom-1]; const n=normalizar(f); if(n){ src=n; break; } } } return { src }; }); ['firmaSemana1','firmaSemana2','firmaSemana3','firmaSemana4'].forEach((id, i)=>{ const el=document.getElementById(id); if(el){ el.innerHTML=''; const cont=document.createElement('div'); cont.className='d-flex align-items-center justify-content-center gap-2'; const t=document.createElement('span'); t.textContent=`SEMANA ${i+1}`; cont.appendChild(t); const r=resultados[i]||{}; if(r.src){ const img=document.createElement('img'); img.className='firma-img'; img.src=r.src; if(!r.src.startsWith('data:')) img.crossOrigin='anonymous'; cont.appendChild(img); } el.appendChild(cont); } }); }
function exportarPDF(){ if(!ultimoDetalle){ Swal.fire('Sin datos','Abre un técnico antes de exportar','info'); return; } const secciones=document.querySelectorAll('#contenedorTSR .tsr-semana'); const nombre=(ultimoDetalle.info?.nombre||'').replace(/[^A-Za-z0-9_\- ]/g,''); const ced=(ultimoDetalle.info?.cedula||'').replace(/[^0-9]/g,''); const archivo=`TSR_${ced||nombre}_${ultimoDetalle.mes}.pdf`; const margin=5; const hasH2C=!!(window.html2canvas); const hasJspdf=!!((window.jspdf && window.jspdf.jsPDF) || window.jsPDF); if(hasH2C && hasJspdf){ const jsPDFCtor=window.jspdf && window.jspdf.jsPDF ? window.jspdf.jsPDF : window.jsPDF; const pdf=new jsPDFCtor({ unit: 'pt', format: 'letter', orientation: 'landscape' }); const pdfW=pdf.internal.pageSize.getWidth(); const pdfH=pdf.internal.pageSize.getHeight(); const maxW=pdfW - margin*2; const maxH=pdfH - margin*2; const proc=Array.from(secciones); function addSection(i){ if(i>=proc.length){ pdf.save(archivo); return; } const el=proc[i]; window.html2canvas(el, { scale: 2, useCORS: true, scrollY: 0 }).then(canvas=>{ const ratio=Math.min(maxW / canvas.width, maxH / canvas.height); const imgW=canvas.width * ratio; const imgH=canvas.height * ratio; const x=margin + (maxW - imgW) / 2; const y=margin + (maxH - imgH) / 2; const dataUrl=canvas.toDataURL('image/jpeg', 0.95); if(i>0) pdf.addPage('letter','landscape'); pdf.addImage(dataUrl, 'JPEG', x, y, imgW, imgH); addSection(i+1); }); }
    addSection(0);
  } else if(window.html2pdf){ const el=document.querySelector('#modalDetalleTSR .modal-content'); const opt={ margin: 10, filename: archivo, image: { type: 'jpeg', quality: 0.95 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'pt', format: 'letter', orientation: 'landscape' }, pagebreak: { mode: ['css','legacy'] } }; window.html2pdf().from(el).set(opt).save(); } else { Swal.fire('Error','No se encontraron librerías de exportación','error'); } }
document.addEventListener('DOMContentLoaded', function(){ setMesInicial(); cargarTecnicos(); document.getElementById('btnCargar').addEventListener('click', cargarTecnicos); const bp=document.getElementById('btnExportarPDF'); if(bp){ bp.addEventListener('click', exportarPDF); } });
</script>
{% endblock %}
