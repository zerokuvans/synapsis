{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #1e293b 0%, #0ea5e9 100%) !important;">
          <h4 class="mb-0"><i class="fas fa-chart-line me-2"></i>Reportes SGIS</h4>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="card h-100 border-primary">
                <div class="card-body d-flex flex-column">
                  <div class="mb-3 text-primary"><i class="fas fa-hard-hat fa-2x"></i></div>
                  <h5 class="card-title mb-2">Pre-operacional EPP</h5>
                  <p class="text-muted mb-3">Reporte mensual de inspecciones de elementos de protección personal.</p>
                  <a href="/sgis/reportes/epp" class="btn btn-outline-primary mt-auto">
                    <i class="fas fa-file-alt me-2"></i>Abrir Reporte
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100 border-secondary">
                <div class="card-body d-flex flex-column">
                  <div class="mb-3 text-secondary"><i class="fas fa-stairs fa-2x"></i></div>
                  <h5 class="card-title mb-2">Pre-operacional Escaleras</h5>
                  <p class="text-muted mb-3">Reporte mensual de inspecciones de escaleras.</p>
                  <a href="/sgis/reportes/escaleras" class="btn btn-outline-secondary mt-auto">
                    <i class="fas fa-file-alt me-2"></i>Abrir Reporte
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100 border-success">
                <div class="card-body d-flex flex-column">
                  <div class="mb-3 text-success"><i class="fas fa-user-shield fa-2x"></i></div>
                  <h5 class="card-title mb-2">Pre-operacional Caídas</h5>
                  <p class="text-muted mb-3">Reporte mensual de inspección de protección contra caídas.</p>
                  <a href="/sgis/reportes/caidas" class="btn btn-outline-success mt-auto">
                    <i class="fas fa-file-alt me-2"></i>Abrir Reporte
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100 border-warning">
                <div class="card-body d-flex flex-column">
                  <div class="mb-3 text-warning"><i class="fas fa-clipboard-check fa-2x"></i></div>
                  <h5 class="card-title mb-2">Permiso de Trabajo</h5>
                  <p class="text-muted mb-3">Reporte mensual del permiso semanal y sus historiales.</p>
                  <a href="/sgis/reportes/permiso-trabajo" class="btn btn-outline-warning mt-auto">
                    <i class="fas fa-file-alt me-2"></i>Abrir Reporte
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100 border-info">
                <div class="card-body d-flex flex-column">
                  <div class="mb-3 text-info"><i class="fas fa-clipboard-list fa-2x"></i></div>
                  <h5 class="card-title mb-2">Análisis de Trabajo Seguro Rutinario</h5>
                  <p class="text-muted mb-3">Reporte mensual de análisis TSR por técnico.</p>
                  <a href="/sgis/reportes/tsr" class="btn btn-outline-info mt-auto">
                    <i class="fas fa-file-alt me-2"></i>Abrir Reporte
                  </a>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card h-100 border-secondary">
                <div class="card-body d-flex flex-column">
                  <div class="mb-3 text-secondary"><i class="fas fa-clipboard-check fa-2x"></i></div>
                  <h5 class="card-title mb-2">Otros reportes</h5>
                  <p class="text-muted mb-3">Más reportes SGIS en preparación.</p>
                  <button class="btn btn-outline-secondary mt-auto" disabled title="Próximamente">
                    <i class="fas fa-hourglass-half me-2"></i>Próximamente
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="container mt-3">
  <div class="card shadow-sm">
    <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #1e293b 0%, #22c55e 100%) !important;">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Indicadores SGIS por Supervisor</h5>
        <div class="d-flex align-items-center gap-2">
          <select id="filtroMesSupAnio" class="form-select form-select-sm" style="max-width: 110px;"></select>
          <select id="filtroMesSupMes" class="form-select form-select-sm" style="max-width: 150px;"></select>
          <button id="btnCargarSup" class="btn btn-light btn-sm">Cargar</button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div id="indicadoresSupervisores" class="row g-3"></div>
    </div>
  </div>
</div>
<script>
function initMesSupSelectors(){
  const selAnio = document.getElementById('filtroMesSupAnio');
  const selMes = document.getElementById('filtroMesSupMes');
  if(!selAnio || !selMes) return;
  const hoy = new Date();
  const anioActual = hoy.getFullYear();
  for(let y = anioActual - 2; y <= anioActual + 1; y++){
    const opt = document.createElement('option');
    opt.value = String(y);
    opt.textContent = String(y);
    if(y === anioActual) opt.selected = true;
    selAnio.appendChild(opt);
  }
  const mesesEs = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  mesesEs.forEach((nombre, idx)=>{
    const opt = document.createElement('option');
    opt.value = String(idx+1).padStart(2,'0');
    opt.textContent = nombre;
    if(idx === hoy.getMonth()) opt.selected = true;
    selMes.appendChild(opt);
  });
}
function getMesFiltro(){
  const y = document.getElementById('filtroMesSupAnio')?.value || new Date().getFullYear();
  const m = document.getElementById('filtroMesSupMes')?.value || String(new Date().getMonth()+1).padStart(2,'0');
  return `${y}-${m}`;
}
function renderSupervisorCard(item){
  const col = document.createElement('div'); col.className = 'col-12 col-md-6 col-xl-4';
  const card = document.createElement('div'); card.className = 'card h-100 border-success';
  const body = document.createElement('div'); body.className = 'card-body';
  const head = document.createElement('div'); head.className = 'd-flex justify-content-between align-items-center mb-2';
  const h6 = document.createElement('h6'); h6.className = 'mb-0'; h6.textContent = item.supervisor;
  const gen = document.createElement('span'); gen.className = 'badge bg-success'; gen.textContent = `${item.porcentaje_general}%`;
  head.appendChild(h6); head.appendChild(gen);
  const table = document.createElement('table'); table.className = 'table table-sm';
  const tbody = document.createElement('tbody');
  const rows = [
    ['Análisis de Trabajo Seguro Rutinario', item.porcentaje_tsr],
    ['Permiso de Trabajo', item.porcentaje_permiso],
    ['Pre-operacional Caídas', item.porcentaje_caidas],
    ['Pre-operacional EPP', item.porcentaje_epp],
    ['Pre-operacional Escaleras', item.porcentaje_escaleras]
  ];
  rows.forEach(r=>{ const tr=document.createElement('tr'); const td1=document.createElement('td'); td1.textContent=r[0]; const td2=document.createElement('td'); td2.className='text-end'; td2.textContent = `${r[1]}%`; tr.appendChild(td1); tr.appendChild(td2); tbody.appendChild(tr); });
  table.appendChild(tbody);
  body.appendChild(head); body.appendChild(table);
  card.appendChild(body); col.appendChild(card);
  return col;
}
function cargarIndicadores(){
  const mes = getMesFiltro();
  fetch(`/api/sgis/indicadores/supervisores?mes=${encodeURIComponent(mes)}`)
    .then(r=>r.json()).then(d=>{
      const cont = document.getElementById('indicadoresSupervisores');
      cont.innerHTML = '';
      if(d && d.success && Array.isArray(d.supervisores) && d.supervisores.length>0){
        d.supervisores.forEach(s=>{ cont.appendChild(renderSupervisorCard(s)); });
      } else {
        cont.innerHTML = '<div class="text-muted">Sin datos para el mes seleccionado</div>';
      }
    }).catch(()=>{
      const cont = document.getElementById('indicadoresSupervisores');
      cont.innerHTML = '<div class="text-danger">Error al cargar indicadores</div>';
    });
}
document.addEventListener('DOMContentLoaded',()=>{ initMesSupSelectors(); cargarIndicadores(); const btn=document.getElementById('btnCargarSup'); if(btn){ btn.addEventListener('click', cargarIndicadores); } });
</script>
{% endblock %}
