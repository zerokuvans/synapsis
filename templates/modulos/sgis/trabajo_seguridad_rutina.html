{% extends "header.html" %}
{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header text-white fw-bold" style="background: linear-gradient(135deg, #1e293b 0%, #0ea5e9 100%) !important;">
          <h4 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Trabajo Seguro Rutinario</h4>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <div class="row g-3">
              <div class="col-md-3"><small class="text-muted">Nombre</small><div>{{ (info.nombre or session.get('user_name')) if info is defined else session.get('user_name') }}</div></div>
              <div class="col-md-3"><small class="text-muted">Cédula</small><div>{{ session.get('user_cedula') }}</div></div>
              <div class="col-md-3"><small class="text-muted">Cargo</small><div>{{ (info.cargo or session.get('user_role')) if info is defined else session.get('user_role') }}</div></div>
              <div class="col-md-3"><small class="text-muted">Ciudad</small><div>{{ (info.ciudad or '-') if info is defined else '-' }}</div></div>
            </div>
            <div class="row g-3 mt-1">
              <div class="col-md-3"><small class="text-muted">Placa</small><div>{{ (info.placa or '-') if info is defined else '-' }}</div></div>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label class="form-label">Actividad asociada</label>
              <input id="actividad" type="text" class="form-control" placeholder="Actividad asociada">
            </div>
            <div class="col-md-8">
              <label class="form-label">Descripción de tareas</label>
              <input id="descripcionTareas" type="text" class="form-control" placeholder="Descripción breve de las tareas">
            </div>
          </div>

          <div class="mb-3">
            <h6 class="mb-2">Evaluación</h6>
            <div class="row g-3">
              <div class="col-md-6">
                <ul class="mb-0">
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">1. Planeación del trabajo</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_1" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_1" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_1" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">2. Inspección del área</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_2" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_2" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_2" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">3. Herramientas en buen estado</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_3" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_3" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_3" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">4. EPP completo</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_4" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_4" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_4" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">5. Riesgos identificados</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_5" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_5" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_5" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">6. Señalización adecuada</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_6" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_6" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_6" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">7. Orden y limpieza</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_7" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_7" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_7" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">8. Condiciones ambientales seguras</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_8" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_8" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_8" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">9. Riesgos eléctricos controlados</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_9" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_9" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_9" value="N/A"> N/A</label>
                    </div>
                  </li>
                </ul>
              </div>
              <div class="col-md-6">
                <ul class="mb-0">
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">10. Trabajo en alturas seguro</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_10" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_10" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_10" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">11. Riesgo de caídas controlado</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_11" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_11" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_11" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">12. Uso correcto de herramientas manuales</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_12" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_12" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_12" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">13. Estado físico para la tarea</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_13" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_13" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_13" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">14. Comunicación clara con el equipo</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_14" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_14" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_14" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">15. Ruta y desplazamiento seguro</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_15" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_15" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_15" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">16. Integridad de materiales</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_16" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_16" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_16" value="N/A"> N/A</label>
                    </div>
                  </li>
                  <li class="mb-2">
                    <label class="form-label fw-bold mb-1">17. Control final antes de iniciar</label>
                    <div>
                      <label class="me-2"><input type="radio" name="respuesta_17" value="C"> C</label>
                      <label class="me-2"><input type="radio" name="respuesta_17" value="NC"> NC</label>
                      <label><input type="radio" name="respuesta_17" value="N/A"> N/A</label>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Riesgo</label>
              <select id="selRiesgo" class="form-select">
                <option value="">Selecciona…</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Peligro</label>
              <select id="selPeligro" class="form-select">
                <option value="">Selecciona…</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Consecuencia</label>
              <select id="selConsecuencia" class="form-select">
                <option value="">Selecciona…</option>
              </select>
            </div>
          </div>
          <div class="row g-3 mt-2">
            <div class="col-md-6">
              <label class="form-label">Controles</label>
              <select id="selControl" class="form-select">
                <option value="">Selecciona…</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-12">
              <label class="form-label">Observaciones</label>
              <textarea id="observaciones" class="form-control" rows="3" placeholder="Observaciones"></textarea>
            </div>
          </div>

          <div class="mt-4 d-flex gap-2">
            <a href="/sgis" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
            </a>
            <button id="btnFirmarEnviar" class="btn btn-primary">
              <i class="fas fa-pen-nib me-2"></i>Firmar y Enviar
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function getVal(n){ const el = document.querySelector('input[name="'+n+'"]:checked'); return el ? el.value : ''; }
function construirPayload(){
  const payload = { observaciones: (document.getElementById('observaciones').value || '').trim() };
  payload.actividad_asociada = (document.getElementById('actividad').value || '').trim();
  payload.descripcion_tareas = (document.getElementById('descripcionTareas').value || '').trim();
  for(let i=1;i<=17;i++){ payload['respuesta_'+i] = getVal('respuesta_'+i); }
  payload.riesgo = document.getElementById('selRiesgo').value || '';
  payload.peligro = document.getElementById('selPeligro').value || '';
  payload.consecuencia = document.getElementById('selConsecuencia').value || '';
  payload.controles = document.getElementById('selControl').value || '';
  return payload;
}
function validar(payload){
  for(let i=1;i<=17;i++){ const v = (payload['respuesta_'+i]||'').toUpperCase(); if(!v || !(['C','NC','N/A'].includes(v))){ Swal.fire('Campos incompletos','Responde todas las preguntas','warning'); return false; } }
  const anyNC = Array.from({length:17}).some((_,idx)=> (payload['respuesta_'+(idx+1)]||'').toUpperCase()==='NC');
  if(anyNC && !payload.observaciones){ Swal.fire('Observaciones requeridas','Registra observaciones para los hallazgos en NC','warning'); return false; }
  return true;
}
let firmaCtxTSR, firmandoTSR = false;
function initFirmaTSR(){
  const c = document.getElementById('firmaCanvasTSR');
  firmaCtxTSR = c.getContext('2d');
  firmaCtxTSR.strokeStyle = '#222';
  firmaCtxTSR.lineWidth = 2;
  const pos = (e)=>{ const r = c.getBoundingClientRect(); const x = (e.touches? e.touches[0].clientX : e.clientX) - r.left; const y = (e.touches? e.touches[0].clientY : e.clientY) - r.top; return {x,y}; };
  const start = (e)=>{ firmandoTSR = true; const p = pos(e); firmaCtxTSR.beginPath(); firmaCtxTSR.moveTo(p.x,p.y); e.preventDefault(); };
  const move = (e)=>{ if(!firmandoTSR) return; const p = pos(e); firmaCtxTSR.lineTo(p.x,p.y); firmaCtxTSR.stroke(); e.preventDefault(); };
  const end = ()=>{ firmandoTSR = false; };
  c.addEventListener('mousedown', start); c.addEventListener('mousemove', move); window.addEventListener('mouseup', end);
  c.addEventListener('touchstart', start, {passive:false}); c.addEventListener('touchmove', move, {passive:false}); window.addEventListener('touchend', end);
  document.getElementById('btnLimpiarFirmaTSR').addEventListener('click', ()=>{ firmaCtxTSR.clearRect(0,0,c.width,c.height); });
}
function enviarTSR(){
  const c = document.getElementById('firmaCanvasTSR');
  const firma = c.toDataURL('image/png');
  const payload = construirPayload();
  if(!validar(payload)) return;
  payload.firma_base64 = firma;
  fetch('/api/sgis/trabajo-seguridad-rutina', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
    .then(r=>r.json()).then(d=>{
      if(d && d.success){
        Swal.fire('Éxito','Trabajo Seguro Rutinario registrado','success');
        const btn = document.getElementById('btnFirmarEnviar'); if(btn){ btn.disabled = true; btn.textContent = 'Análisis diligenciado'; }
        const mf = document.getElementById('modalFirmaTSR'); const modal = bootstrap.Modal.getInstance(mf); if(modal) modal.hide();
      } else {
        Swal.fire('Error', d.error || 'No se pudo registrar', 'error');
      }
    }).catch(()=>{ Swal.fire('Error','Error de red','error'); });
}
let tsrData = [];
function fillSelect(sel, items){ sel.innerHTML = '<option value="">Selecciona…</option>'; items.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); }); }
function cargarRiesgos(){
  fetch('/api/sgis/trabajo-seguridad-rutina/riesgos').then(r=>r.json()).then(d=>{
    if(d && d.success){
      tsrData = Array.isArray(d.data)? d.data : [];
      const riesgos = Array.from(new Set(tsrData.map(x=>x.riesgo).filter(Boolean)));
      const sr = document.getElementById('selRiesgo');
      const sp = document.getElementById('selPeligro');
      const sc = document.getElementById('selConsecuencia');
      const sctrl = document.getElementById('selControl');
      fillSelect(sr, riesgos);
      fillSelect(sp, []);
      fillSelect(sc, []);
      fillSelect(sctrl, []);
      sr.addEventListener('change', function(){
        const r = this.value || '';
        const peligros = Array.from(new Set(tsrData.filter(x=>x.riesgo===r).map(x=>x.peligro).filter(Boolean)));
        fillSelect(sp, peligros);
        fillSelect(sc, []);
        fillSelect(sctrl, []);
      });
      sp.addEventListener('change', function(){
        const r = sr.value || '';
        const p = this.value || '';
        const consecuencias = Array.from(new Set(tsrData.filter(x=>x.riesgo===r && x.peligro===p).map(x=>x.consecuencia).filter(Boolean)));
        fillSelect(sc, consecuencias);
        fillSelect(sctrl, []);
      });
      sc.addEventListener('change', function(){
        const r = sr.value || '';
        const p = sp.value || '';
        const c = this.value || '';
        const controles = Array.from(new Set(tsrData.filter(x=>x.riesgo===r && x.peligro===p && x.consecuencia===c).map(x=>x.controles).filter(Boolean)));
        fillSelect(sctrl, controles);
      });
    }
  }).catch(()=>{});
}
document.addEventListener('DOMContentLoaded', function(){
  document.getElementById('btnFirmarEnviar').addEventListener('click', function(){
    const payload = construirPayload();
    if(!validar(payload)) return;
    const mf = new bootstrap.Modal(document.getElementById('modalFirmaTSR'));
    mf.show();
    initFirmaTSR();
  });
  cargarRiesgos();
  fetch('/api/sgis/trabajo-seguro-rutinario/status').then(r=>r.json()).then(d=>{
    const btn = document.getElementById('btnFirmarEnviar');
    if(d && d.success && d.limit_reached && btn){ btn.disabled = true; btn.textContent = 'Límite diario alcanzado (10)'; }
  }).catch(()=>{});
});
</script>

<div class="modal fade" id="modalFirmaTSR" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvasTSR" width="300" height="150" style="border:1px solid #ddd; border-radius:4px; cursor:crosshair"></canvas>
        <div class="mt-2 d-flex gap-2">
          <button id="btnLimpiarFirmaTSR" type="button" class="btn btn-outline-secondary btn-sm">Limpiar</button>
          <button id="btnEnviarTSR" type="button" class="btn btn-success btn-sm" onclick="enviarTSR()">Enviar</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
