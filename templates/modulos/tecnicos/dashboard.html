{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white fw-bold">
                    <h3 class="mb-0">
                        <i class="fas fa-wrench me-2"></i>Panel de Técnicos
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Bienvenido al panel de técnicos. Aquí podrás gestionar las órdenes de trabajo y reportes técnicos.
                    </div>
                    
                    <!-- Contenido específico del módulo técnico -->
                    <div class="row mt-4">
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-check-circle fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Preoperacional</h5>
                                    <p class="card-text">Realiza y consulta inspecciones preoperacionales.</p>
                                    {% if tiene_asistencia %}
                                        <a href="#" class="btn btn-info" id="preoperacionalButton" data-bs-toggle="modal" data-bs-target="#preoperacionalModal">
                                            <i class="fas fa-clipboard-check me-2"></i>Ver Preoperacional
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary disabled" disabled title="Debe registrar asistencia primero">
                                            <i class="fas fa-clipboard-check me-2"></i>Ver Preoperacional
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-clipboard-list fa-3x text-primary mb-3"></i>
                                    <h5 class="card-title">Órdenes de Trabajo</h5>
                                    <p class="card-text">Gestiona las órdenes de trabajo asignadas.</p>
                                    {% if tiene_asistencia %}
                                        <a href="/tecnicos/ordenes_trabajo" class="btn btn-primary">
                                            <i class="fas fa-tasks me-2"></i>Ver Órdenes
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary disabled" disabled title="Debe registrar asistencia primero">
                                            <i class="fas fa-tasks me-2"></i>Ver Órdenes
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-tools fa-3x text-success mb-3"></i>
                                    <h5 class="card-title">Mantenimientos</h5>
                                    <p class="card-text">Registra y consulta mantenimientos realizados.</p>
                                    {% if tiene_asistencia %}
                                        <a href="/tecnicos/mantenimientos" class="btn btn-success">
                                            <i class="fas fa-wrench me-2"></i>Ver Mantenimientos
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary disabled" disabled title="Debe registrar asistencia primero">
                                            <i class="fas fa-wrench me-2"></i>Ver Mantenimientos
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-chart-line fa-3x text-warning mb-3"></i>
                                    <h5 class="card-title">Reportes</h5>
                                    <p class="card-text">Genera reportes de trabajo y estadísticas.</p>
                                    {% if tiene_asistencia %}
                                        <a href="#" class="btn btn-warning">
                                            <i class="fas fa-file-alt me-2"></i>Ver Reportes
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary disabled" disabled title="Debe registrar asistencia primero">
                                            <i class="fas fa-file-alt me-2"></i>Ver Reportes
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-toolbox fa-3x text-danger mb-3"></i>
                                    <h5 class="card-title">Asignaciones Ferretero</h5>
                                    <p class="card-text">Consulta tus asignaciones de materiales ferretero.</p>
                                    {% if tiene_asistencia %}
                                        <a href="/tecnicos/asignaciones_ferretero" class="btn btn-danger">
                                            <i class="fas fa-list-alt me-2"></i>Ver Asignaciones
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary disabled" disabled title="Debe registrar asistencia primero">
                                            <i class="fas fa-list-alt me-2"></i>Ver Asignaciones
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="col-md-3 mb-4">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    <i class="fas fa-search fa-3x text-info mb-3"></i>
                                    <h5 class="card-title">Causas de Cierre</h5>
                                    <p class="card-text">Consulta y filtra las causas de cierre disponibles en el sistema.</p>
                                    {% if tiene_asistencia %}
                                        <a href="/analistas/causas" class="btn btn-info">
                                            <i class="fas fa-list-alt me-2"></i>Ver Causas de Cierre
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary disabled" disabled title="Debe registrar asistencia primero">
                                            <i class="fas fa-list-alt me-2"></i>Ver Causas de Cierre
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        
                    </div> <!-- Close row mt-4 -->
                </div> <!-- Close card-body -->
            </div> <!-- Close card -->
        </div> <!-- Close col-12 -->
    </div> <!-- Close row -->
</div> <!-- Close container -->

<div class="modal fade" id="preoperacionalModal" tabindex="-1" aria-labelledby="preoperacionalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="preoperacionalModalLabel">Registrar Inspección Preoperacional</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Información de horario permitido -->
                <div class="alert alert-info mb-3">
                    <div class="d-flex align-items-center">
                        <div>
                            <i class="fas fa-info-circle fa-2x me-3"></i>
                        </div>
                        <div>
                            <p class="mb-1"><strong>Horario permitido:</strong> <span id="horario-permitido-text">Hasta las 10:00 (hora de Bogotá)</span>.</p>
                            <p class="mb-0">Hora actual: <span id="reloj-bogota" class="badge bg-secondary"></span></p>
                        </div>
                    </div>
                </div>
                
                <!-- Contenedor para alertas de documentos -->
                <div id="alertas_documentos" class="mb-3" style="display: none;"></div>
                
                <form id="preoperacionalForm" method="POST" action="/preoperacional">
                    <div class="card mb-3">
                        <div class="card-header fw-bold">Información del Centro de Trabajo</div>
                        <div class="card-body">
                            
                            <div class="mb-3">
                                <label for="ciudad" class="form-label fw-bold">Ciudad</label>
                                <input type="text" class="form-control" id="ciudad" name="ciudad" placeholder="Ciudad asignada" readonly>
                                <small class="form-text text-muted">Este campo se completa automáticamente con tu ciudad asignada</small>
                            </div>
                            <div class="mb-3">
                                <label for="supervisor" class="form-label fw-bold">Supervisor</label>
                                <select class="form-select" id="supervisor" name="supervisor" required>
                                    {% if supervisor %}
                                        <option value="{{ supervisor }}" selected>{{ supervisor }}</option>
                                    {% else %}
                                        <option value="">No se encontró supervisor asignado</option>
                                    {% endif %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header fw-bold">Información del Vehículo</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="vehiculo_asistio_operacion" class="form-label fw-bold">Vehículo Asistió a la Operación</label>
                                <select class="form-select" id="vehiculo_asistio_operacion" name="vehiculo_asistio_operacion" required>
                                    <option value="">Seleccione una opción</option>
                                    <option value="Sí">Sí</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="tipo_vehiculo" class="form-label fw-bold">Tipo de Vehículo</label>
                                <input type="text" class="form-control" id="tipo_vehiculo" name="tipo_vehiculo" placeholder="Tipo de vehículo asignado" readonly>
                                <small class="form-text text-muted">Este campo se completa automáticamente con el tipo de tu vehículo asignado</small>
                            </div>
                            <div class="mb-3">
                                <label for="placa_vehiculo" class="form-label fw-bold">Placa del Vehículo</label>
                                <input type="text" class="form-control" id="placa_vehiculo" name="placa_vehiculo" required>
                            </div>
                            <div class="mb-3">
                                <label for="modelo_vehiculo" class="form-label fw-bold">Modelo del Vehículo</label>
                                <input type="text" class="form-control" id="modelo_vehiculo" name="modelo_vehiculo" required>
                            </div>
                            <div class="mb-3">
                                <label for="marca_vehiculo" class="form-label fw-bold">Marca del Vehículo</label>
                                <input type="text" class="form-control" id="marca_vehiculo" name="marca_vehiculo" readonly required>
                            </div>
   
                            <div class="mb-3">
                                <label for="licencia_conduccion" class="form-label fw-bold">Licencia de Conducción</label>
                                <input type="text" class="form-control" id="licencia_conduccion" name="licencia_conduccion" readonly placeholder="Se completará automáticamente" required>
                                <small class="text-muted">Este campo se completa automáticamente con los datos de su licencia registrada</small>
                            </div>
                            <div class="mb-3">
                                <label for="fecha_vencimiento_licencia" class="form-label fw-bold">Fecha de Vencimiento de la Licencia</label>
                                <input type="date" class="form-control" id="fecha_vencimiento_licencia" name="fecha_vencimiento_licencia" required>
                            </div>
                            <div class="mb-3">
                                <label for="fecha_vencimiento_soat" class="form-label fw-bold">Fecha de Vencimiento del SOAT</label>
                                <input type="date" class="form-control" id="fecha_vencimiento_soat" name="fecha_vencimiento_soat" required>
                            </div>
                            <div class="mb-3">
                                <label for="fecha_vencimiento_tecnomecanica" class="form-label fw-bold">Fecha de Vencimiento de la Tecnomecánica</label>
                                <input type="date" class="form-control" id="fecha_vencimiento_tecnomecanica" name="fecha_vencimiento_tecnomecanica" required>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header fw-bold">Estado del Vehículo</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="estado_espejos" class="form-label fw-bold">Estado de los Espejos</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_espejos_bueno" name="estado_espejos" value="bueno">
                                        <label for="estado_espejos_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_espejos_regular" name="estado_espejos" value="regular">
                                        <label for="estado_espejos_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_espejos_malo" name="estado_espejos" value="malo">
                                        <label for="estado_espejos_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="bocina_pito" class="form-label fw-bold">Bocina o Pito</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="bocina_pito_bueno" name="bocina_pito" value="bueno">
                                        <label for="bocina_pito_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="bocina_pito_regular" name="bocina_pito" value="regular">
                                        <label for="bocina_pito_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="bocina_pito_malo" name="bocina_pito" value="malo">
                                        <label for="bocina_pito_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="frenos" class="form-label fw-bold">Frenos</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="frenos_bueno" name="frenos" value="bueno">
                                        <label for="frenos_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="frenos_regular" name="frenos" value="regular">
                                        <label for="frenos_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="frenos_malo" name="frenos" value="malo">
                                        <label for="frenos_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="encendido" class="form-label fw-bold">Encendido</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="encendido_bueno" name="encendido" value="bueno">
                                        <label for="encendido_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="encendido_regular" name="encendido" value="regular">
                                        <label for="encendido_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="encendido_malo" name="encendido" value="malo">
                                        <label for="encendido_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="estado_bateria" class="form-label fw-bold">Estado de la Batería</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_bateria_bueno" name="estado_bateria" value="bueno">
                                        <label for="estado_bateria_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_bateria_regular" name="estado_bateria" value="regular">
                                        <label for="estado_bateria_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_bateria_malo" name="estado_bateria" value="malo">
                                        <label for="estado_bateria_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="estado_amortiguadores" class="form-label fw-bold">Estado de los Amortiguadores</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_amortiguadores_bueno" name="estado_amortiguadores" value="bueno">
                                        <label for="estado_amortiguadores_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_amortiguadores_regular" name="estado_amortiguadores" value="regular">
                                        <label for="estado_amortiguadores_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_amortiguadores_malo" name="estado_amortiguadores" value="malo">
                                        <label for="estado_amortiguadores_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="estado_llantas" class="form-label fw-bold">Estado de las Llantas</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_llantas_bueno" name="estado_llantas" value="bueno">
                                        <label for="estado_llantas_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_llantas_regular" name="estado_llantas" value="regular">
                                        <label for="estado_llantas_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_llantas_malo" name="estado_llantas" value="malo">
                                        <label for="estado_llantas_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="kilometraje_actual" class="form-label fw-bold">Kilometraje Actual del Vehículo</label>
                                <input type="number" class="form-control" id="kilometraje_actual" name="kilometraje_actual" required min="0">
                                <div id="kilometraje_feedback" class="mt-2" style="display: none;"></div>
                                <small class="form-text text-muted" id="ultimo_kilometraje_info" style="display: none;"></small>
                            </div>
                            <div class="mb-3">
                                <label for="luces_altas_bajas" class="form-label fw-bold">Luces Altas y Bajas</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="luces_altas_bajas_bueno" name="luces_altas_bajas" value="bueno">
                                        <label for="luces_altas_bajas_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="luces_altas_bajas_regular" name="luces_altas_bajas" value="regular">
                                        <label for="luces_altas_bajas_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="luces_altas_bajas_malo" name="luces_altas_bajas" value="malo">
                                        <label for="luces_altas_bajas_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="direccionales_delanteras_traseras" class="form-label fw-bold">Direccionales Delanteras y Traseras</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="direccionales_delanteras_traseras_bueno" name="direccionales_delanteras_traseras" value="bueno">
                                        <label for="direccionales_delanteras_traseras_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="direccionales_delanteras_traseras_regular" name="direccionales_delanteras_traseras" value="regular">
                                        <label for="direccionales_delanteras_traseras_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="direccionales_delanteras_traseras_malo" name="direccionales_delanteras_traseras" value="malo">
                                        <label for="direccionales_delanteras_traseras_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header fw-bold">Elementos de Prevención y Seguridad Vial</div>
                        <div class="card-body" id="seccion_seguridad_moto">
                            <div class="mb-3">
                                <label for="elementos_prevencion_seguridad_vial_casco" class="form-label fw-bold">Elementos de Prevención y Seguridad Vial (Casco)</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="elementos_prevencion_seguridad_vial_casco_bueno" name="elementos_prevencion_seguridad_vial_casco" value="bueno">
                                        <label for="elementos_prevencion_seguridad_vial_casco_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="elementos_prevencion_seguridad_vial_casco_regular" name="elementos_prevencion_seguridad_vial_casco" value="regular">
                                        <label for="elementos_prevencion_seguridad_vial_casco_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="elementos_prevencion_seguridad_vial_casco_malo" name="elementos_prevencion_seguridad_vial_casco" value="malo">
                                        <label for="elementos_prevencion_seguridad_vial_casco_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="casco_certificado" class="form-label fw-bold">Casco Certificado</label>
                                <select class="form-select" id="casco_certificado" name="casco_certificado" required>
                                    <option value="">Seleccione una opción</option>
                                    <option value="Sí">Sí</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="estado_guantes" class="form-label fw-bold">Guantes</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_guantes_bueno" name="estado_guantes" value="bueno">
                                        <label for="estado_guantes_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_guantes_regular" name="estado_guantes" value="regular">
                                        <label for="estado_guantes_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_guantes_malo" name="estado_guantes" value="malo">
                                        <label for="estado_guantes_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="estado_rodilleras" class="form-label fw-bold">Estado de Rodilleras</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_rodilleras_bueno" name="estado_rodilleras" value="bueno">
                                        <label for="estado_rodilleras_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_rodilleras_regular" name="estado_rodilleras" value="regular">
                                        <label for="estado_rodilleras_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="estado_rodilleras_malo" name="estado_rodilleras" value="malo">
                                        <label for="estado_rodilleras_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="impermeable" class="form-label fw-bold">Impermeable</label>
                                <div class="d-flex justify-content-between">
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="impermeable_bueno" name="impermeable" value="bueno">
                                        <label for="impermeable_bueno" class="form-check-label">Bueno</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="impermeable_regular" name="impermeable" value="regular">
                                        <label for="impermeable_regular" class="form-check-label">Regular</label>
                                    </div>
                                    <div class="form-check">
                                        <input type="radio" class="form-check-input" id="impermeable_malo" name="impermeable" value="malo">
                                        <label for="impermeable_malo" class="form-check-label">Malo</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-3">
                        <div class="card-header fw-bold">Observaciones</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="observaciones" class="form-label fw-bold">Observaciones</label>
                                <textarea class="form-control" id="observaciones" name="observaciones" rows="3" required></textarea>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="id_codigo_consumidor" name="id_codigo_consumidor" value="{{ session['user_id'] }}">
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Variable global para almacenar la hora límite
window.horaLimitePreoperacional = '10:00'; // Valor por defecto

// Variables globales para el sistema preoperacional mejorado
let datosVehiculo = null;
let validacionKilometraje = {
    valido: false,
    ultimoKilometraje: 0,
    mensaje: ''
};

document.addEventListener('DOMContentLoaded', function() {
    const preoperacionalButton = document.getElementById('preoperacionalButton');
    const preoperacionalForm = document.getElementById('preoperacionalForm');
    const preoperacionalModal = document.getElementById('preoperacionalModal');
    const relojBogota = document.getElementById('reloj-bogota');
    const tipoVehiculoSelect = document.getElementById('tipo_vehiculo');
    const seccionSeguridadMoto = document.getElementById('seccion_seguridad_moto');
    
    // Elementos del formulario preoperacional mejorado
    const kilometrajeInput = document.getElementById('kilometraje_actual');
    const kilometrajeFeedback = document.getElementById('kilometraje_feedback');
    const ultimoKilometrajeInfo = document.getElementById('ultimo_kilometraje_info');
    const alertasDocumentos = document.getElementById('alertas_documentos');
    
    // Función para controlar la visibilidad de la sección de seguridad para motos
    function controlarSeccionMoto(tipoVehiculo) {
        if (seccionSeguridadMoto) {
            if (tipoVehiculo && (tipoVehiculo.toLowerCase().includes('moto') || tipoVehiculo.toLowerCase().includes('motocicleta'))) {
                // Mostrar sección de seguridad para motos
                seccionSeguridadMoto.closest('.card').style.display = 'block';
                
                // Habilitar campos obligatorios
                const campos = seccionSeguridadMoto.querySelectorAll('input, select');
                campos.forEach(campo => {
                    if (campo.hasAttribute('required-if-moto')) {
                        campo.setAttribute('required', '');
                    }
                });
            } else {
                // Ocultar sección de seguridad para motos
                seccionSeguridadMoto.closest('.card').style.display = 'none';
                
                // Desabilitar campos obligatorios
                const campos = seccionSeguridadMoto.querySelectorAll('input, select');
                campos.forEach(campo => {
                    if (campo.hasAttribute('required')) {
                        campo.removeAttribute('required');
                        // Guardar el estado para restaurar si se selecciona moto nuevamente
                        campo.setAttribute('required-if-moto', '');
                    }
                });
            }
        }
    }
    
    // Controlar la visibilidad de la sección de seguridad para motos
    if (seccionSeguridadMoto) {
        // Ocultar al inicio hasta que se carguen los datos del vehículo
        seccionSeguridadMoto.closest('.card').style.display = 'none';
    }
    
    // Inicializar la hora límite desde la API
    obtenerHoraLimite().then(() => {
        // Iniciar reloj en tiempo real de Bogotá después de obtener la hora límite
        actualizarRelojBogota();
        // Asegurar un único temporizador para evitar múltiples intervalos y spam de logs
        if (!window._relojBogotaInterval) {
            window._relojBogotaInterval = setInterval(actualizarRelojBogota, 1000);
        }
    });
    
    // Cargar datos del vehículo al abrir el modal
    if (preoperacionalModal) {
        preoperacionalModal.addEventListener('shown.bs.modal', function() {
            // Cargar datos del vehículo cuando se abre el modal
            cargarDatosVehiculo();
        });
    }
    
    // Validación en tiempo real del kilometraje
    if (kilometrajeInput) {
        kilometrajeInput.addEventListener('input', function() {
            const valor = this.value.trim();
            
            // Limpiar feedback anterior si el campo está vacío
            if (!valor) {
                if (kilometrajeFeedback) {
                    kilometrajeFeedback.style.display = 'none';
                }
                if (kilometrajeInput) {
                    kilometrajeInput.classList.remove('is-valid', 'is-invalid');
                }
                return;
            }
            
            // Validar que sea un número válido
            const kilometraje = parseInt(valor);
            if (isNaN(kilometraje) || kilometraje < 0) {
                mostrarFeedbackKilometraje(false, 'Ingrese un kilometraje válido (número positivo)');
                return;
            }
            
            // Validar contra el último kilometraje si tenemos los datos del vehículo
            if (datosVehiculo && datosVehiculo.placa) {
                validarKilometrajeEnTiempoReal(datosVehiculo.placa, kilometraje);
            }
        });
    }
    
    // Función para obtener la fecha y hora de Bogotá de forma confiable
    function obtenerFechaHoraBogota() {
        try {
            const ahora = new Date();
            const opcionesBogota = {
                timeZone: 'America/Bogota',
                hour12: false, // Usar formato 24 horas internamente para cálculos
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hourCycle: 'h23' // Asegurar formato 24 horas
            };
            
            // Formato para mostrar: 15:30:45
            const horaFormateada = ahora.toLocaleTimeString('es-CO', opcionesBogota);
            
            // Obtener componentes para uso interno
            const fechaHoraCompleta = ahora.toLocaleString('es-CO', opcionesBogota);
            const fechaBogota = new Date(fechaHoraCompleta.replace(/(\d+)\/(\d+)\/(\d+)/, '$3/$2/$1'));
            
            // Reducir ruido en consola: solo log si la bandera de depuración está activa
            if (window.DEBUG_HORARIO_PREOP) {
                console.debug("Fecha y hora en Bogotá:", fechaHoraCompleta);
                console.debug("Hora formateada:", horaFormateada);
            }
            
            return {
                fechaCompleta: fechaBogota,
                horaFormateada: horaFormateada,
                hora: fechaBogota.getHours(),
                minutos: fechaBogota.getMinutes()
            };
        } catch (error) {
            console.error("Error al obtener fecha y hora de Bogotá:", error);
            // Fallback en caso de error
            const ahora = new Date();
            return {
                fechaCompleta: ahora,
                horaFormateada: ahora.toLocaleTimeString('es-CO'),
                hora: ahora.getHours(),
                minutos: ahora.getMinutes()
            };
        }
    }
    
    function actualizarRelojBogota() {
        if (relojBogota) {
            // Obtener fecha y hora de Bogotá
            const datosBogota = obtenerFechaHoraBogota();
            
            // Formato amigable para mostrar (con AM/PM)
            const opcionesMostrar = { 
                timeZone: 'America/Bogota',
                hour12: true,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            const horaMostrar = new Date().toLocaleTimeString('es-CO', opcionesMostrar);
            
            // Determinar si está dentro del horario permitido
            const dentroHorario = estaEnHorarioPermitido();
            
            // Cambiar color según horario
            relojBogota.className = 'badge ' + (dentroHorario ? 'bg-success' : 'bg-danger');
            relojBogota.innerHTML = horaMostrar;
        }
    }
    
    // Verificar horario y registro al hacer clic en el botón
    if (preoperacionalButton) {
        preoperacionalButton.addEventListener('click', async function(e) {
            e.preventDefault();
            await verificarHorarioYRegistro();
        });
    }
    
    // Verificar horario y registro al cargar la página después de inicializar
    obtenerHoraLimite().then(() => {
        verificarHorarioYRegistro();
    });
    
    // Función para obtener la hora límite desde la API
    async function obtenerHoraLimite() {
        try {
            const response = await fetch('/api/configuracion/hora-preoperacional');
            const data = await response.json();
            
            if (data.success && data.data) {
                window.horaLimitePreoperacional = data.data.hora_limite_formatted;
                console.log(`Hora límite obtenida de la API: ${window.horaLimitePreoperacional}`);
            } else {
                console.warn('No se pudo obtener la hora límite de la API, usando valor por defecto:', window.horaLimitePreoperacional);
            }
        } catch (error) {
            console.error('Error al obtener hora límite:', error);
            console.log('Usando hora límite por defecto:', window.horaLimitePreoperacional);
        }
        
        // Actualizar el texto del horario permitido en la interfaz
        const horarioPermitidoText = document.getElementById('horario-permitido-text');
        if (horarioPermitidoText) {
            horarioPermitidoText.textContent = `Hasta las ${window.horaLimitePreoperacional} (hora de Bogotá)`;
        }
    }
    
    // Función para verificar si la hora actual es antes de la hora límite configurada (hora de Bogotá)
    function estaEnHorarioPermitido() {
        try {
            // Obtener datos de Bogotá usando nuestra función mejorada
            const datosBogota = obtenerFechaHoraBogota();
            
            // Parsear la hora límite
            const [horaLimite, minutosLimite] = window.horaLimitePreoperacional.split(':').map(Number);
            
            // Reducir ruido en consola: solo log si la bandera de depuración está activa
            if (window.DEBUG_HORARIO_PREOP) {
                console.debug(`Validando horario: Hora en Bogotá ${datosBogota.hora}:${datosBogota.minutos.toString().padStart(2, '0')} - Permitido hasta las ${window.horaLimitePreoperacional}`);
            }
            
            // Comprobar si es antes de la hora límite
            if (datosBogota.hora < horaLimite) {
                return true;
            } else if (datosBogota.hora === horaLimite && datosBogota.minutos <= minutosLimite) {
                return true;
            } else {
                return false;
            }
        } catch (error) {
            console.error("Error al validar horario:", error);
            // En caso de error, permitir el acceso
            return true;
        }
    }
    
    async function verificarHorarioYRegistro() {
        // Primero obtener la hora límite actual de la API
        await obtenerHoraLimite();
        
        // Luego verificar si estamos en el horario permitido
        if (!estaEnHorarioPermitido()) {
            // Si no está en horario permitido, mostrar mensaje y bloquear acceso
            Swal.fire({
                icon: 'warning',
                title: 'Fuera de Horario',
                text: `Las inspecciones preoperacionales solo pueden registrarse hasta las ${window.horaLimitePreoperacional} (hora de Bogotá).`,
                confirmButtonText: 'Entendido'
            });
            
            // Deshabilitar el formulario
            if (preoperacionalForm) {
                const inputs = preoperacionalForm.querySelectorAll('input, select, textarea');
                inputs.forEach(input => input.disabled = true);
            }
            
            // Agregar mensaje en el modal
            const modalBody = preoperacionalModal.querySelector('.modal-body');
            if (modalBody) {
                // Verificar si ya existe el mensaje
                if (!modalBody.querySelector('.horario-alerta')) {
                    const alertaHorario = document.createElement('div');
                    alertaHorario.className = 'alert alert-warning mb-3 horario-alerta';
                    alertaHorario.innerHTML = `<i class="fas fa-clock me-2"></i> <strong>Fuera de horario:</strong> Las inspecciones preoperacionales solo pueden registrarse hasta las ${window.horaLimitePreoperacional}.`;
                    modalBody.insertBefore(alertaHorario, modalBody.firstChild);
                }
            }
            return;
        }
        
        // Si está en horario permitido, continuar con la verificación de registro
        verificarRegistroPreoperacional();
    }
    
    function verificarRegistroPreoperacional() {
        fetch('/verificar_registro_preoperacional')
            .then(response => response.json())
            .then(data => {
                if (data.tiene_registro) {
                    // Si ya existe un registro, mostrar mensaje y deshabilitar el formulario
                    let mensajeHora = '';
                    
                    if (data.ultimo_registro) {
                        // Convertir la hora del último registro a formato local
                        const fechaRegistro = new Date(data.ultimo_registro);
                        mensajeHora = ` El último registro fue a las ${fechaRegistro.toLocaleTimeString('es-CO')}.`;
                    }
                    
                    Swal.fire({
                        icon: 'info',
                        title: 'Registro Existente',
                        text: `Ya has realizado la inspección preoperacional para hoy (${data.fecha_actual}).${mensajeHora}`,
                        confirmButtonText: 'Entendido'
                    });
                    
                    if (preoperacionalForm) {
                        const inputs = preoperacionalForm.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => input.disabled = true);
                    }
                } else {
                    // Si no existe registro, verificar vencimientos y habilitar/bloquear según corresponda
                    verificarVencimientosYBloqueo();
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al verificar el registro preoperacional.',
                    confirmButtonText: 'Cerrar'
                });
            });
    }

    function verificarVencimientosYBloqueo() {
        // Cache busting para evitar respuestas antiguas del navegador
        fetch(`/api/mi/vencimientos?dias=0&cb=${Date.now()}`)
            .then(response => response.json())
            .then(data => {
                const items = (data && Array.isArray(data.items)) ? data.items : [];
                // Bloquear únicamente cuando hay documentos realmente vencidos (dias<=0)
                const vencidos = items.filter(i => {
                    const dias = Number(i.dias_restantes);
                    if (Number.isFinite(dias)) return dias <= 0;
                    const estado = (i.estado || '').toLowerCase();
                    return estado === 'vencido';
                });

                const debeBloquear = vencidos.length > 0;
                console.debug('[Vencimientos] items:', items.length, 'vencidos:', vencidos.length, 'debeBloquear:', debeBloquear);

                if (debeBloquear) {
                    // Mostrar alerta y bloquear formulario
                    const detalles = vencidos.map(i => {
                        const fecha = i.fecha_vencimiento || 'N/A';
                        const dias = (i.dias_restantes !== undefined && i.dias_restantes !== null) ? i.dias_restantes : 'N/A';
                        const placa = i.placa ? ` - ${i.placa}` : '';
                        return `${i.tipo}${placa}: vence ${fecha} (${dias} días)`;
                    }).join('\n');
                    Swal.fire({
                        icon: 'error',
                        title: 'Documentos Vencidos',
                        text: 'No puedes registrar el preoperacional: tienes documentos vencidos.',
                        footer: `<pre style="text-align:left">${detalles}</pre>`,
                        confirmButtonText: 'Entendido'
                    });
                    if (preoperacionalForm) {
                        const inputs = preoperacionalForm.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => input.disabled = true);
                        const submitButton = preoperacionalForm.querySelector('button[type="submit"], #btn_guardar_preoperacional');
                        if (submitButton) {
                            submitButton.disabled = true;
                            submitButton.classList.remove('btn-primary');
                            submitButton.classList.add('btn-secondary');
                            submitButton.setAttribute('title', 'Bloqueado por documentos vencidos');
                        }
                    }
                } else {
                    // Habilitar el formulario
                    if (preoperacionalForm) {
                        const inputs = preoperacionalForm.querySelectorAll('input, select, textarea');
                        inputs.forEach(input => input.disabled = false);
                        const submitButton = preoperacionalForm.querySelector('button[type="submit"], #btn_guardar_preoperacional');
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.classList.remove('btn-secondary');
                            submitButton.classList.add('btn-primary');
                            submitButton.removeAttribute('title');
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error verificando vencimientos:', error);
                // En caso de error, no bloquear, permitir continuar
                if (preoperacionalForm) {
                    const inputs = preoperacionalForm.querySelectorAll('input, select, textarea');
                    inputs.forEach(input => input.disabled = false);
                }
            });
    }
    
    // Agregar validación al enviar el formulario
    if (preoperacionalForm) {
        preoperacionalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Verificar horario antes de enviar
            if (!estaEnHorarioPermitido()) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Fuera de Horario',
                    text: `Las inspecciones preoperacionales solo pueden registrarse hasta las ${window.horaLimitePreoperacional} (hora de Bogotá).`,
                    confirmButtonText: 'Entendido'
                });
                return;
            }
            
            // Verificar nuevamente antes de enviar
            fetch('/verificar_registro_preoperacional')
                .then(response => response.json())
                .then(data => {
                    if (data.tiene_registro) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Registro Duplicado',
                            text: 'Ya has realizado la inspección preoperacional para hoy.',
                            confirmButtonText: 'Entendido'
                        });
                    } else {
                        // Validación final de kilometraje antes de enviar
                        const valorKm = (document.getElementById('kilometraje_actual')?.value || '').trim();
                        const kmNumero = parseInt(valorKm);
                        if (!valorKm || isNaN(kmNumero) || kmNumero < 0) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Kilometraje inválido',
                                text: 'Ingrese un kilometraje válido (número positivo).',
                                confirmButtonText: 'Entendido'
                            });
                            return;
                        }
                        if (kmNumero > 1000000) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Límite excedido',
                                text: 'El kilometraje no puede superar los 1,000,000 km.',
                                confirmButtonText: 'Entendido'
                            });
                            return;
                        }
                        if (validacionKilometraje && validacionKilometraje.valido === false) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Kilometraje no válido',
                                text: validacionKilometraje.mensaje || 'El kilometraje propuesto no es válido.',
                                confirmButtonText: 'Entendido'
                            });
                            return;
                        }

                        // Si no hay registro previo y kilometraje es válido, enviar el formulario
                        const formData = new FormData(preoperacionalForm);
                        formData.append('id_codigo_consumidor', '{{ session.user_id }}');
                        
                        fetch('/preoperacional', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'error') {
                                throw new Error(data.message);
                            }
                            
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: `Inspección preoperacional registrada correctamente el ${data.fecha_registro} a las ${data.hora_registro}.`,
                                confirmButtonText: 'Aceptar'
                            }).then(() => {
                                // Cerrar el modal y recargar la página
                                const modal = bootstrap.Modal.getInstance(preoperacionalModal);
                                modal.hide();
                                location.reload();
                            });
                        })
                        .catch(error => {
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: error.message || 'Error al registrar la inspección preoperacional.',
                                confirmButtonText: 'Cerrar'
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error al verificar el registro preoperacional.',
                        confirmButtonText: 'Cerrar'
                    });
                });
        });
    }
    
    // Función para cargar datos del vehículo desde la API
    async function cargarDatosVehiculo() {
        try {
            const response = await fetch('/api/tecnicos/datos-preoperacional');
            const data = await response.json();
            
            if (data.success) {
                datosVehiculo = data.data;
                
                // Auto-completar campos del formulario
                autoCompletarFormulario(datosVehiculo);
                
                // Mostrar alertas de documentos
                mostrarAlertasDocumentos(data.alertas);
                
                // Mostrar información del último kilometraje
                if (datosVehiculo.ultimo_kilometraje > 0) {
                    mostrarInfoUltimoKilometraje(datosVehiculo.ultimo_kilometraje, datosVehiculo.fecha_ultimo_kilometraje);
                }
            } else {
                console.error('Error al cargar datos del vehículo:', data.message);
                mostrarAlerta('warning', 'No se pudieron cargar los datos del vehículo: ' + data.message);
            }
        } catch (error) {
            console.error('Error al cargar datos del vehículo:', error);
            mostrarAlerta('error', 'Error de conexión al cargar los datos del vehículo');
        }
    }
    
    // Función para auto-completar el formulario
    function autoCompletarFormulario(datos) {
        // Ciudad
        if (datos.ciudad) {
            const ciudadInput = document.getElementById('ciudad');
            if (ciudadInput) {
                ciudadInput.value = datos.ciudad;
            }
        }
        
        // Tipo de vehículo
        if (datos.tipo_vehiculo) {
            const tipoVehiculoInput = document.getElementById('tipo_vehiculo');
            if (tipoVehiculoInput) {
                tipoVehiculoInput.value = datos.tipo_vehiculo;
                // Controlar la sección de seguridad para motos
                controlarSeccionMoto(datos.tipo_vehiculo);
            }
        }
        
        // Placa del vehículo
        if (datos.placa) {
            const placaInput = document.getElementById('placa_vehiculo');
            if (placaInput) {
                placaInput.value = datos.placa;
                placaInput.readOnly = true; // Hacer solo lectura
            }
        }
        
        // Modelo del vehículo
        if (datos.modelo) {
            const modeloInput = document.getElementById('modelo_vehiculo');
            if (modeloInput) {
                modeloInput.value = datos.modelo;
                modeloInput.readOnly = true; // Hacer solo lectura
            }
        }
        
        // Marca del vehículo
        if (datos.marca) {
            const marcaInput = document.getElementById('marca_vehiculo');
            if (marcaInput) {
                marcaInput.value = datos.marca;
                marcaInput.readOnly = true; // Hacer solo lectura
            }
        }
        
        // Licencia de conducción
        if (datos.tipo_licencia) {
            const licenciaInput = document.getElementById('licencia_conduccion');
            if (licenciaInput) {
                licenciaInput.value = datos.tipo_licencia;
                // El campo ya es readonly por defecto
            }
        }
        
        // Fecha de vencimiento de licencia
        if (datos.fecha_venc_licencia) {
            const fechaLicenciaInput = document.getElementById('fecha_vencimiento_licencia');
            if (fechaLicenciaInput) {
                fechaLicenciaInput.value = datos.fecha_venc_licencia;
                fechaLicenciaInput.readOnly = true; // Hacer solo lectura
            }
        }
        
        // Fecha de vencimiento SOAT
        if (datos.fecha_venc_soat) {
            const fechaSoatInput = document.getElementById('fecha_vencimiento_soat');
            if (fechaSoatInput) {
                fechaSoatInput.value = datos.fecha_venc_soat;
                fechaSoatInput.readOnly = true; // Hacer solo lectura
            }
        }
        
        // Fecha de vencimiento técnico mecánica
        if (datos.fecha_venc_tecnico_mecanica) {
            const fechaTecnicoInput = document.getElementById('fecha_vencimiento_tecnomecanica');
            if (fechaTecnicoInput) {
                fechaTecnicoInput.value = datos.fecha_venc_tecnico_mecanica;
                fechaTecnicoInput.readOnly = true; // Hacer solo lectura
            }
        }
    }
    
    // Función para mostrar alertas de documentos
    function mostrarAlertasDocumentos(alertas) {
        if (!alertasDocumentos || !alertas || alertas.length === 0) {
            return;
        }
        
        let html = '';
        let tieneErrores = false;
        
        alertas.forEach(alerta => {
            const tipoClase = alerta.tipo === 'error' ? 'alert-danger' : 'alert-warning';
            const icono = alerta.tipo === 'error' ? 'fas fa-exclamation-triangle' : 'fas fa-exclamation-circle';
            
            if (alerta.tipo === 'error') {
                tieneErrores = true;
            }
            
            html += `
                <div class="alert ${tipoClase} mb-2">
                    <i class="${icono} me-2"></i>
                    ${alerta.mensaje}
                </div>
            `;
        });
        
        alertasDocumentos.innerHTML = html;
        alertasDocumentos.style.display = 'block';
        
        // Si hay errores (documentos vencidos), deshabilitar el formulario
        if (tieneErrores) {
            deshabilitarFormulario('No se puede registrar la inspección preoperacional con documentos vencidos');
        }
    }
    
    // Función para mostrar información del último kilometraje
    function mostrarInfoUltimoKilometraje(ultimoKm, fechaUltimo) {
        if (ultimoKilometrajeInfo) {
            ultimoKilometrajeInfo.innerHTML = `Último kilometraje registrado: <strong>${ultimoKm} km</strong> ${fechaUltimo ? `(${fechaUltimo})` : ''}`;
            ultimoKilometrajeInfo.style.display = 'block';
        }
    }
    
    // Función para validar kilometraje en tiempo real
    async function validarKilometrajeEnTiempoReal(placa, kilometrajePropuesto) {
        try {
            const response = await fetch('/api/tecnicos/validar-kilometraje', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    placa: placa,
                    kilometraje_propuesto: kilometrajePropuesto
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                validacionKilometraje = {
                    valido: data.valido,
                    ultimoKilometraje: data.ultimo_kilometraje,
                    mensaje: data.mensaje
                };
                
                mostrarFeedbackKilometraje(data.valido, data.mensaje);
            } else {
                console.error('Error en validación de kilometraje:', data.message);
                mostrarFeedbackKilometraje(false, 'Error al validar kilometraje');
            }
        } catch (error) {
            console.error('Error al validar kilometraje:', error);
            mostrarFeedbackKilometraje(false, 'Error de conexión al validar kilometraje');
        }
    }
    
    // Función para mostrar feedback del kilometraje
    function mostrarFeedbackKilometraje(valido, mensaje) {
        if (!kilometrajeFeedback) return;
        
        const claseAlerta = valido ? 'alert-success' : 'alert-danger';
        const icono = valido ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
        
        kilometrajeFeedback.innerHTML = `
            <div class="alert ${claseAlerta} mb-0 py-2">
                <i class="${icono} me-2"></i>
                ${mensaje}
            </div>
        `;
        kilometrajeFeedback.style.display = 'block';
        
        // Cambiar el color del borde del input
        if (kilometrajeInput) {
            kilometrajeInput.classList.remove('is-valid', 'is-invalid');
            kilometrajeInput.classList.add(valido ? 'is-valid' : 'is-invalid');
        }
    }
    
    // Función para deshabilitar el formulario
    function deshabilitarFormulario(mensaje) {
        if (preoperacionalForm) {
            const inputs = preoperacionalForm.querySelectorAll('input:not([readonly]), select:not([disabled]), textarea');
            inputs.forEach(input => {
                input.disabled = true;
            });
            
            const submitButton = preoperacionalForm.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = `<i class="fas fa-ban me-2"></i>${mensaje}`;
            }
        }
    }
    
    // Función para mostrar alertas generales
    function mostrarAlerta(tipo, mensaje) {
        const tipoClase = tipo === 'error' ? 'alert-danger' : tipo === 'warning' ? 'alert-warning' : 'alert-info';
        const icono = tipo === 'error' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle';
        
        if (alertasDocumentos) {
            alertasDocumentos.innerHTML = `
                <div class="alert ${tipoClase}">
                    <i class="${icono} me-2"></i>
                    ${mensaje}
                </div>
            `;
            alertasDocumentos.style.display = 'block';
        }
    }
});
</script>
{% endblock %}
