{% extends "base.html" %}

{% block title %}Órdenes de Trabajo - Técnicos{% endblock %}

{% block content %}
<div class="d-flex justify-content-center w-100">
  <div class="w-100" style="max-width: 1800px;">
    <div class="container-1800 mt-4">
    {% if not modal_only %}
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-tasks me-2"></i>Órdenes de Trabajo
                </h1>
                <button id="btnNuevaOT" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Nueva OT
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Filtros
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="filtroOT" class="form-label">OT</label>
                            <input type="text" id="filtroOT" class="form-control" placeholder="Número de OT">
                        </div>
                        <div class="col-md-6">
                            <label for="filtroCuenta" class="form-label">Cuenta</label>
                            <input type="text" id="filtroCuenta" class="form-control" placeholder="Número de cuenta">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button id="btnAplicarFiltros" class="btn btn-outline-primary me-2">
                                <i class="fas fa-search me-2"></i>Aplicar Filtros
                            </button>
                            <button id="btnLimpiarFiltros" class="btn btn-outline-secondary">
                                <i class="fas fa-eraser me-2"></i>Limpiar Filtros
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de Órdenes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Listado de Órdenes
                    </h5>
                    <div class="d-flex align-items-center">
                        <span id="totalRegistros" class="badge bg-secondary me-3">0 registros</span>
                        <div class="btn-group" role="group">
                            <button id="btnVistaTabla" class="btn btn-sm btn-outline-primary active">
                                <i class="fas fa-table"></i>
                            </button>
                            <button id="btnVistaTarjetas" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-th-large"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Vista Tabla -->
                    <div id="vistaTabla" class="table-responsive">
                        <table id="tablaOrdenes" class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>OT</th>
                                    <th>Cuenta</th>
                                    <th>Código</th>
                                    
                                    <th>Valor Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoTabla">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Cargando órdenes...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Vista Tarjetas -->
                    <div id="vistaTarjetas" class="row" style="display: none;">
                        <!-- Las tarjetas se generarán dinámicamente -->
                    </div>

                    <!-- Paginación -->
                    <nav aria-label="Paginación">
                        <ul id="paginacion" class="pagination justify-content-center mt-3">
                            <!-- La paginación se generará dinámicamente -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Nueva OT -->
<div class="modal fade" id="modalNuevaOT" tabindex="-1" aria-labelledby="modalNuevaOTLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevaOTLabel">
                    <i class="fas fa-plus me-2"></i>Nueva Orden de Trabajo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevaOT">
                    <!-- Información General -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-info-circle me-2"></i>Información General
                            </h6>
                        </div>
                        <div class="col-md-4">
                            <label for="inputOT" class="form-label">OT <span class="text-danger">*</span></label>
                            <input type="text" id="inputOT" name="ot" class="form-control" maxlength="12" pattern="[0-9]{7,12}" required>
                            <div class="invalid-feedback">La OT debe tener entre 7 y 12 dígitos numéricos</div>
                        </div>
                        <div class="col-md-4">
                            <label for="inputCuenta" class="form-label">Cuenta <span class="text-danger">*</span></label>
                            <input type="text" id="inputCuenta" name="cuenta" class="form-control" maxlength="8" pattern="[0-9]{8}" required>
                            <div class="invalid-feedback">La cuenta debe tener exactamente 8 dígitos numéricos</div>
                        </div>
                        
                    </div>

                    <!-- Filtros de Códigos -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-filter me-2"></i>Selección de Códigos
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <label for="selectTecnologia" class="form-label">Tecnología <span class="text-danger">*</span></label>
                            <select id="selectTecnologia" name="tecnologia" class="form-select" required>
                                <option value="">Seleccione tecnología</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="selectCategoria" class="form-label">Categoría <span class="text-danger">*</span></label>
                            <select id="selectCategoria" name="categoria" class="form-select" disabled required>
                                <option value="">Seleccione tecnología primero</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabla de Códigos Disponibles -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-list me-2"></i>Códigos Disponibles
                            </h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table id="tablaCodigosDisponibles" class="table table-sm table-striped">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Código</th>
                                            <th>Descripción</th>
                                            <th>Valor Unitario</th>
                                            <th>Cantidad</th>
                                            <th>Subtotal</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <i class="fas fa-info-circle me-2"></i>Seleccione tecnología y categoría para ver códigos disponibles
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Códigos Seleccionados -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">
                                <i class="fas fa-check-circle me-2"></i>Códigos Seleccionados
                            </h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table id="tablaCodigosSeleccionados" class="table table-sm table-striped">
                                    <thead class="table-success">
                                        <tr>
                                            <th>Código</th>
                                            <th>Descripción</th>
                                            <th>Valor Unitario</th>
                                            <th>Cantidad</th>
                                            <th>Subtotal</th>
                                            <th>Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">
                                                <i class="fas fa-shopping-cart me-2"></i>No hay códigos seleccionados
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Total -->
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-end">
                                <h5 class="text-end">
                                    <strong>Total: $<span id="valorTotal">0.00</span></strong>
                                </h5>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" id="btnGuardarOT" class="btn btn-primary" disabled>
                    <i class="fas fa-save me-2"></i>Guardar OT
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver OT -->
<div class="modal fade" id="modalVerOT" tabindex="-1" aria-labelledby="modalVerOTLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalVerOTLabel">
                    <i class="fas fa-eye me-2"></i>Detalles de la Orden de Trabajo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="contenidoVerOT">
                <!-- El contenido se cargará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalles de OT -->
<div class="modal fade" id="modalDetallesOT" tabindex="-1" aria-labelledby="modalDetallesOTLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalDetallesOTLabel">
                    <i class="fas fa-eye me-2"></i>Detalles de la Orden de Trabajo
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Información General -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">
                            <i class="fas fa-info-circle me-2"></i>Información General
                        </h6>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">OT:</small>
                        <div class="fw-bold" id="detalleOT">-</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Cuenta:</small>
                        <div class="fw-bold" id="detalleCuenta">-</div>
                    </div>
                    
                    <div class="col-md-3">
                        <small class="text-muted">Técnico:</small>
                        <div class="fw-bold" id="detalleTecnico">-</div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-3">
                        <small class="text-muted">Tecnología:</small>
                        <div class="fw-bold" id="detalleTecnologia">-</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Categoría:</small>
                        <div class="fw-bold" id="detalleCategoria">-</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Fecha:</small>
                        <div class="fw-bold" id="detalleFecha">-</div>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted">Total:</small>
                        <div class="fw-bold text-primary fs-5" id="detalleTotal">-</div>
                    </div>
                </div>

                <!-- Tabla de Códigos -->
                <div class="row">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">
                            <i class="fas fa-list me-2"></i>Códigos de Trabajo
                        </h6>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead class="table-light">
                                    <tr>
                                        <th>Código</th>
                                        <th>Nombre</th>
                                        <th>Descripción</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-end">Valor Unitario</th>
                                        <th class="text-end">Valor Total</th>
                                    </tr>
                                </thead>
                                <tbody id="cuerpoTablaDetalles">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Cargando códigos...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>
        </div>
</div>
</div>
</div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/tecnicos_ordenes.css') }}">
<style>
  /* Wrapper centrado que limita a 1800px */
  .d-flex.justify-content-center > div[style*="max-width: 1800px"] {
    max-width: 1800px !important;
    margin: 0 auto !important;
    padding: 0 15px !important;
    width: 100% !important;
  }
  /* Contenedor interno */
  .container-1800 {
    max-width: 1800px !important;
    width: 100% !important;
    padding: 0 !important;
  }
  .container-1800 .row { margin-left: 0; margin-right: 0; }
  .container-1800 .table-responsive { overflow-x: auto !important; }
  /* Evitar que el body cree scroll horizontal innecesario */
  body { overflow-x: hidden; }
  /* Override para Bootstrap container-fluid si se combina accidentalmente */
  .container-1800.container-fluid {
    max-width: 1800px !important;
    margin: 0 auto !important;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  window.TECNICOS_API_PREFIX = '/tecnicos';
  window.MODAL_ONLY = {{ 'true' if modal_only else 'false' }};
</script>
<script src="{{ url_for('static', filename='js/tecnicos_ordenes.js') }}"></script>
{% endblock %}
