{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white fw-bold">
                    <h3 class="mb-0">
                        <i class="fas fa-toolbox me-2"></i>Mis Asignaciones de Ferretero
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Aqu√≠ puedes consultar todas tus asignaciones de materiales ferretero.
                    </div>
                    
                    <!-- Cuadro informativo de estado de materiales -->
                    <div class="card mb-4 border-primary">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Estado de Asignaciones de Materiales
                                <button class="btn btn-sm btn-outline-light float-end" onclick="actualizarEstadoMateriales()" id="btnActualizar">
                                    <i class="fas fa-sync-alt me-1"></i>Actualizar
                                </button>
                            </h5>
                        </div>
                        <div class="card-body">
                            <!-- Silicona -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-primary"><i class="fas fa-tint me-2"></i>Silicona</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-primary fw-bold" id="siliconaAsignada">-</div>
                                        <small class="text-muted">Asignadas</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-success fw-bold" id="siliconaDisponible">-</div>
                                        <small class="text-muted">Disponible</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-info fw-bold" id="siliconaLimite">-</div>
                                        <small class="text-muted">Stock Maximo</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="progressBarSilicona" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="progressTextSilicona">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cinta Aislante -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-warning"><i class="fas fa-tape me-2"></i>Cinta Aislante</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-primary fw-bold" id="cintaAsignada">-</div>
                                        <small class="text-muted">Asignadas</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-success fw-bold" id="cintaDisponible">-</div>
                                        <small class="text-muted">Disponible</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-info fw-bold" id="cintaLimite">-</div>
                                        <small class="text-muted">Stock Maximo</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="progressBarCinta" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="progressTextCinta">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Amarres Negros -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-dark"><i class="fas fa-link me-2"></i>Amarres Negros</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-primary fw-bold" id="amarresNegrosAsignados">-</div>
                                        <small class="text-muted">Asignados</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-success fw-bold" id="amarresNegrosDisponibles">-</div>
                                        <small class="text-muted">Disponible</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-info fw-bold" id="amarresNegrosLimite">-</div>
                                        <small class="text-muted">Stock Maximo</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="progressBarAmarresNegros" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="progressTextAmarresNegros">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Amarres Blancos -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-secondary"><i class="fas fa-link me-2"></i>Amarres Blancos</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-primary fw-bold" id="amarresBlancosAsignados">-</div>
                                        <small class="text-muted">Asignados</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-success fw-bold" id="amarresBlancosDisponibles">-</div>
                                        <small class="text-muted">Disponible</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-info fw-bold" id="amarresBlancosLimite">-</div>
                                        <small class="text-muted">Stock Maximo</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="progressBarAmarresBlancos" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="progressTextAmarresBlancos">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Grapas Blancas -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-info"><i class="fas fa-paperclip me-2"></i>Grapas Blancas</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-primary fw-bold" id="grapasBlancasAsignadas">-</div>
                                        <small class="text-muted">Asignadas</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-success fw-bold" id="grapasBlancasDisponibles">-</div>
                                        <small class="text-muted">Disponible</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-info fw-bold" id="grapasBlancasLimite">-</div>
                                        <small class="text-muted">Stock Maximo</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="progressBarGrapasBlancas" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="progressTextGrapasBlancas">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Grapas Negras -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <h6 class="text-secondary"><i class="fas fa-paperclip me-2"></i>Grapas Negras</h6>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-primary fw-bold" id="grapasNegrasAsignadas">-</div>
                                        <small class="text-muted">Asignadas</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-success fw-bold" id="grapasNegrasDisponibles">-</div>
                                        <small class="text-muted">Disponible</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="text-center">
                                        <div class="h5 text-info fw-bold" id="grapasNegrasLimite">-</div>
                                        <small class="text-muted">Stock Maximo</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" id="progressBarGrapasNegras" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                            <span id="progressTextGrapasNegras">0%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-light border-0 mb-0" id="estadoAlert">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <span id="estadoTexto">Cargando informaci√≥n...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {% if asignaciones %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 20%;">N√∫mero de Asignaci√≥n</th>
                                    <th style="width: 20%;">Fecha</th>
                                    <th style="width: 60%;">Materiales Asignados</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asignacion in asignaciones %}
                                <tr>
                                    <td style="width: 20%;">
                                        <a href="#" class="text-primary fw-bold text-decoration-none" 
                                           onclick="verDetalle({{ asignacion.id_ferretero }})">
                                            #{{ asignacion.id_ferretero }}
                                        </a>
                                    </td>
                                    <td style="width: 20%;">{{ asignacion.fecha_asignacion.strftime('%d/%m/%Y') if asignacion.fecha_asignacion else 'N/A' }}</td>
                                    <td style="width: 60%;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                {% if asignacion.silicona and asignacion.silicona|int > 0 %}
                                                    <span class="badge bg-primary me-1 mb-1">Silicona: {{ asignacion.silicona }}</span><br>
                                                {% endif %}
                                                {% if asignacion.amarres_negros and asignacion.amarres_negros|int > 0 %}
                                                    <span class="badge bg-dark me-1 mb-1">Amarres Negros: {{ asignacion.amarres_negros }}</span><br>
                                                {% endif %}
                                                {% if asignacion.amarres_blancos and asignacion.amarres_blancos|int > 0 %}
                                                    <span class="badge bg-light text-dark me-1 mb-1">Amarres Blancos: {{ asignacion.amarres_blancos }}</span><br>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                {% if asignacion.cinta_aislante and asignacion.cinta_aislante|int > 0 %}
                                                    <span class="badge bg-warning text-dark me-1 mb-1">Cinta Aislante: {{ asignacion.cinta_aislante }}</span><br>
                                                {% endif %}
                                                {% if asignacion.grapas_negras and asignacion.grapas_negras|int > 0 %}
                                                    <span class="badge bg-secondary me-1 mb-1">Grapas Negras: {{ asignacion.grapas_negras }}</span><br>
                                                {% endif %}
                                                {% if asignacion.grapas_blancas and asignacion.grapas_blancas|int > 0 %}
                                                    <span class="badge bg-info me-1 mb-1">Grapas Blancas: {{ asignacion.grapas_blancas }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <h5>No tienes asignaciones de ferretero</h5>
                        <p>Actualmente no tienes asignaciones de materiales ferretero registradas.</p>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="/tecnicos/dashboard" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar detalles de la asignaci√≥n -->
<div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="detalleModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Detalle de Asignaci√≥n
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>N√∫mero de Asignaci√≥n:</strong> <span id="modalNumeroAsignacion"></span></p>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Fecha:</strong> <span id="modalFecha"></span></p>
                        <p><strong>T√©cnico:</strong> <span id="modalTecnico"></span></p>
                        <p><strong>C√©dula:</strong> <span id="modalCedula"></span></p>
                        <p><strong>Silicona:</strong> <span id="modalSilicona"></span></p>
                        <p><strong>Amarres Negros:</strong> <span id="modalAmarresNegros"></span></p>
                        <p><strong>Amarres Blancos:</strong> <span id="modalAmarresBlancos"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Cinta Aislante:</strong> <span id="modalCinta"></span></p>
                        <p><strong>Grapas Negras:</strong> <span id="modalGrapasNegras"></span></p>
                        <p><strong>Grapas Blancas:</strong> <span id="modalGrapasBlancas"></span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <p><strong>Observaciones:</strong></p>
                        <p id="modalObservaciones" class="text-muted"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function verDetalle(idAsignacion) {
    // Prevenir comportamiento por defecto del enlace
    event.preventDefault();
    
    // Mostrar indicador de carga
    const loadingToast = document.createElement('div');
    loadingToast.className = 'toast-container position-fixed top-0 end-0 p-3';
    loadingToast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-body">
                <i class="fas fa-spinner fa-spin me-2"></i>Cargando detalles...
            </div>
        </div>
    `;
    document.body.appendChild(loadingToast);
    
    // Hacer petici√≥n AJAX para obtener detalles de la asignaci√≥n
    fetch(`/api/tecnicos/asignacion_ferretero/${idAsignacion}`)
        .then(response => {
            // Remover indicador de carga
            document.body.removeChild(loadingToast);
            
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error('Error en los datos:', data.error);
                showErrorToast('Error: ' + data.error);
                return;
            }
            
            // Llenar el modal con los datos
            document.getElementById('modalNumeroAsignacion').textContent = data.id_ferretero || 'N/A';
            document.getElementById('modalFecha').textContent = data.fecha_formateada || 'N/A';
            document.getElementById('modalTecnico').textContent = data.tecnico_nombre || 'N/A';
            document.getElementById('modalCedula').textContent = data.tecnico_cedula || 'N/A';
            document.getElementById('modalSilicona').textContent = data.silicona || '0';
            document.getElementById('modalAmarresNegros').textContent = data.amarres_negros || '0';
            document.getElementById('modalAmarresBlancos').textContent = data.amarres_blancos || '0';
            document.getElementById('modalCinta').textContent = data.cinta_aislante || '0';
            document.getElementById('modalGrapasNegras').textContent = data.grapas_negras || '0';
            document.getElementById('modalGrapasBlancas').textContent = data.grapas_blancas || '0';
            document.getElementById('modalObservaciones').textContent = data.observaciones || 'Sin observaciones disponibles';
            
            // Mostrar el modal usando Bootstrap 5
            const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
            modal.show();
        })
        .catch(error => {
            // Remover indicador de carga si a√∫n existe
            if (document.body.contains(loadingToast)) {
                document.body.removeChild(loadingToast);
            }
            
            console.error('Error en la petici√≥n:', error);
            showErrorToast('Error al cargar los detalles de la asignaci√≥n: ' + error.message);
        });
}

function showErrorToast(message) {
    const errorToast = document.createElement('div');
    errorToast.className = 'toast-container position-fixed top-0 end-0 p-3';
    errorToast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    document.body.appendChild(errorToast);
    
    // Auto-remover despu√©s de 5 segundos
    setTimeout(() => {
        if (document.body.contains(errorToast)) {
            document.body.removeChild(errorToast);
        }
    }, 5000);
}

// Funci√≥n para actualizar el estado de materiales
function actualizarEstadoMateriales() {
    const btnActualizar = document.getElementById('btnActualizar');
    const iconoBtn = btnActualizar.querySelector('i');
    
    // Mostrar estado de carga
    iconoBtn.className = 'fas fa-spinner fa-spin me-1';
    btnActualizar.disabled = true;
    
    fetch('/api/tecnico/obtener_estado_materiales')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Funci√≥n auxiliar para actualizar cada material
            function actualizarMaterial(material, datos) {
                const asignadas = datos.asignadas || 0;
                const disponible = datos.disponible || 0;
                const limite = datos.limite || 0;
                const porcentaje = limite > 0 ? Math.round((asignadas / limite) * 100) : 0;
                
                // Actualizar valores - corregir IDs para que coincidan con el HTML
                const asignadaId = material === 'silicona' ? 'siliconaAsignada' : `${material}Asignadas`;
                const disponibleId = material === 'silicona' ? 'siliconaDisponible' : `${material}Disponibles`;
                const limiteId = `${material}Limite`;
                
                const asignadaElement = document.getElementById(asignadaId);
                const disponibleElement = document.getElementById(disponibleId);
                const limiteElement = document.getElementById(limiteId);
                
                if (asignadaElement) asignadaElement.textContent = asignadas;
                if (disponibleElement) disponibleElement.textContent = disponible;
                if (limiteElement) limiteElement.textContent = limite;
                
                // Actualizar barra de progreso
                const progressBar = document.getElementById(`progressBar${material.charAt(0).toUpperCase() + material.slice(1)}`);
                const progressText = document.getElementById(`progressText${material.charAt(0).toUpperCase() + material.slice(1)}`);
                
                if (progressBar && progressText) {
                    progressBar.style.width = porcentaje + '%';
                    progressBar.setAttribute('aria-valuenow', porcentaje);
                    progressText.textContent = porcentaje + '%';
                    
                    // Cambiar color seg√∫n el porcentaje
                    progressBar.className = 'progress-bar';
                    if (porcentaje >= 90) {
                        progressBar.classList.add('bg-danger');
                    } else if (porcentaje >= 70) {
                        progressBar.classList.add('bg-warning');
                    } else {
                        progressBar.classList.add('bg-success');
                    }
                }
            }
            
            // Actualizar cada material
            if (data.silicona) actualizarMaterial('silicona', data.silicona);
            if (data.cinta_aislante) {
                const asignadas = data.cinta_aislante.asignadas || 0;
                const disponible = data.cinta_aislante.disponible || 0;
                const limite = data.cinta_aislante.limite || 0;
                const porcentaje = limite > 0 ? Math.round((asignadas / limite) * 100) : 0;
                
                document.getElementById('cintaAsignada').textContent = asignadas;
                document.getElementById('cintaDisponible').textContent = disponible;
                document.getElementById('cintaLimite').textContent = limite;
                
                const progressBar = document.getElementById('progressBarCinta');
                const progressText = document.getElementById('progressTextCinta');
                if (progressBar && progressText) {
                    progressBar.style.width = porcentaje + '%';
                    progressBar.setAttribute('aria-valuenow', porcentaje);
                    progressText.textContent = porcentaje + '%';
                    progressBar.className = 'progress-bar';
                    if (porcentaje >= 90) {
                        progressBar.classList.add('bg-danger');
                    } else if (porcentaje >= 70) {
                        progressBar.classList.add('bg-warning');
                    } else {
                        progressBar.classList.add('bg-success');
                    }
                }
            }
            if (data.amarres_negros) {
                const asignadas = data.amarres_negros.asignadas || 0;
                const disponible = data.amarres_negros.disponible || 0;
                const limite = data.amarres_negros.limite || 0;
                const porcentaje = limite > 0 ? Math.round((asignadas / limite) * 100) : 0;
                
                document.getElementById('amarresNegrosAsignados').textContent = asignadas;
                document.getElementById('amarresNegrosDisponibles').textContent = disponible;
                document.getElementById('amarresNegrosLimite').textContent = limite;
                
                const progressBar = document.getElementById('progressBarAmarresNegros');
                const progressText = document.getElementById('progressTextAmarresNegros');
                if (progressBar && progressText) {
                    progressBar.style.width = porcentaje + '%';
                    progressBar.setAttribute('aria-valuenow', porcentaje);
                    progressText.textContent = porcentaje + '%';
                    progressBar.className = 'progress-bar';
                    if (porcentaje >= 90) {
                        progressBar.classList.add('bg-danger');
                    } else if (porcentaje >= 70) {
                        progressBar.classList.add('bg-warning');
                    } else {
                        progressBar.classList.add('bg-success');
                    }
                }
            }
            if (data.amarres_blancos) {
                const asignadas = data.amarres_blancos.asignadas || 0;
                const disponible = data.amarres_blancos.disponible || 0;
                const limite = data.amarres_blancos.limite || 0;
                const porcentaje = limite > 0 ? Math.round((asignadas / limite) * 100) : 0;
                
                document.getElementById('amarresBlancosAsignados').textContent = asignadas;
                document.getElementById('amarresBlancosDisponibles').textContent = disponible;
                document.getElementById('amarresBlancosLimite').textContent = limite;
                
                const progressBar = document.getElementById('progressBarAmarresBlancos');
                const progressText = document.getElementById('progressTextAmarresBlancos');
                if (progressBar && progressText) {
                    progressBar.style.width = porcentaje + '%';
                    progressBar.setAttribute('aria-valuenow', porcentaje);
                    progressText.textContent = porcentaje + '%';
                    progressBar.className = 'progress-bar';
                    if (porcentaje >= 90) {
                        progressBar.classList.add('bg-danger');
                    } else if (porcentaje >= 70) {
                        progressBar.classList.add('bg-warning');
                    } else {
                        progressBar.classList.add('bg-success');
                    }
                }
            }
            if (data.grapas_blancas) {
                const asignadas = data.grapas_blancas.asignadas || 0;
                const disponible = data.grapas_blancas.disponible || 0;
                const limite = data.grapas_blancas.limite || 0;
                const porcentaje = limite > 0 ? Math.round((asignadas / limite) * 100) : 0;
                
                document.getElementById('grapasBlancasAsignadas').textContent = asignadas;
                document.getElementById('grapasBlancasDisponibles').textContent = disponible;
                document.getElementById('grapasBlancasLimite').textContent = limite;
                
                const progressBar = document.getElementById('progressBarGrapasBlancas');
                const progressText = document.getElementById('progressTextGrapasBlancas');
                if (progressBar && progressText) {
                    progressBar.style.width = porcentaje + '%';
                    progressBar.setAttribute('aria-valuenow', porcentaje);
                    progressText.textContent = porcentaje + '%';
                    progressBar.className = 'progress-bar';
                    if (porcentaje >= 90) {
                        progressBar.classList.add('bg-danger');
                    } else if (porcentaje >= 70) {
                        progressBar.classList.add('bg-warning');
                    } else {
                        progressBar.classList.add('bg-success');
                    }
                }
            }
            if (data.grapas_negras) {
                const asignadas = data.grapas_negras.asignadas || 0;
                const disponible = data.grapas_negras.disponible || 0;
                const limite = data.grapas_negras.limite || 0;
                const porcentaje = limite > 0 ? Math.round((asignadas / limite) * 100) : 0;
                
                document.getElementById('grapasNegrasAsignadas').textContent = asignadas;
                document.getElementById('grapasNegrasDisponibles').textContent = disponible;
                document.getElementById('grapasNegrasLimite').textContent = limite;
                
                const progressBar = document.getElementById('progressBarGrapasNegras');
                const progressText = document.getElementById('progressTextGrapasNegras');
                if (progressBar && progressText) {
                    progressBar.style.width = porcentaje + '%';
                    progressBar.setAttribute('aria-valuenow', porcentaje);
                    progressText.textContent = porcentaje + '%';
                    progressBar.className = 'progress-bar';
                    if (porcentaje >= 90) {
                        progressBar.classList.add('bg-danger');
                    } else if (porcentaje >= 70) {
                        progressBar.classList.add('bg-warning');
                    } else {
                        progressBar.classList.add('bg-success');
                    }
                }
            }
            
            // Actualizar mensaje de estado general
            const estadoAlert = document.getElementById('estadoAlert');
            const estadoTexto = document.getElementById('estadoTexto');
            
            estadoAlert.className = 'alert border-0 mb-0 alert-success';
            estadoTexto.innerHTML = '<i class="fas fa-check-circle me-2"></i>Informaci√≥n de materiales actualizada correctamente';
            
            // Actualizar timestamp
            const ahora = new Date().toLocaleString('es-ES');
            console.log(`Estado de materiales actualizado: ${ahora}`);
        })
        .catch(error => {
            console.error('Error al obtener estado:', error);
            document.getElementById('estadoTexto').innerHTML = '<i class="fas fa-times-circle me-2"></i>Error al cargar informaci√≥n: ' + error.message;
            document.getElementById('estadoAlert').className = 'alert alert-danger border-0 mb-0';
        })
        .finally(() => {
            // Restaurar bot√≥n
            iconoBtn.className = 'fas fa-sync-alt me-1';
            btnActualizar.disabled = false;
        });
}

// Cargar estado inicial al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    actualizarEstadoMateriales();
});

// Actualizar autom√°ticamente cada 5 minutos
setInterval(actualizarEstadoMateriales, 300000);

// Funci√≥n para actualizar despu√©s de una nueva asignaci√≥n
function onNuevaAsignacion() {
    setTimeout(actualizarEstadoMateriales, 1000); // Esperar 1 segundo para que se procese la asignaci√≥n
}
</script>
{% endblock %}