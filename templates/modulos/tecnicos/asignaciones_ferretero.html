{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-danger text-white fw-bold">
                    <h3 class="mb-0">
                        <i class="fas fa-toolbox me-2"></i>Mis Asignaciones de Ferretero
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Aquí puedes consultar todas tus asignaciones de materiales ferretero.
                    </div>
                    
                    {% if asignaciones %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 20%;">Número de Asignación</th>
                                    <th style="width: 20%;">Fecha</th>
                                    <th style="width: 60%;">Materiales Asignados</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for asignacion in asignaciones %}
                                <tr>
                                    <td style="width: 20%;">
                                        <a href="#" class="text-primary fw-bold text-decoration-none" 
                                           onclick="verDetalle({{ asignacion.id_ferretero }})">
                                            #{{ asignacion.id_ferretero }}
                                        </a>
                                    </td>
                                    <td style="width: 20%;">{{ asignacion.fecha_asignacion.strftime('%d/%m/%Y') if asignacion.fecha_asignacion else 'N/A' }}</td>
                                    <td style="width: 60%;">
                                        <div class="row">
                                            <div class="col-md-6">
                                                {% if asignacion.silicona and asignacion.silicona|int > 0 %}
                                                    <span class="badge bg-primary me-1 mb-1">Silicona: {{ asignacion.silicona }}</span><br>
                                                {% endif %}
                                                {% if asignacion.amarres_negros and asignacion.amarres_negros|int > 0 %}
                                                    <span class="badge bg-dark me-1 mb-1">Amarres Negros: {{ asignacion.amarres_negros }}</span><br>
                                                {% endif %}
                                                {% if asignacion.amarres_blancos and asignacion.amarres_blancos|int > 0 %}
                                                    <span class="badge bg-light text-dark me-1 mb-1">Amarres Blancos: {{ asignacion.amarres_blancos }}</span><br>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-6">
                                                {% if asignacion.cinta_aislante and asignacion.cinta_aislante|int > 0 %}
                                                    <span class="badge bg-warning text-dark me-1 mb-1">Cinta Aislante: {{ asignacion.cinta_aislante }}</span><br>
                                                {% endif %}
                                                {% if asignacion.grapas_negras and asignacion.grapas_negras|int > 0 %}
                                                    <span class="badge bg-secondary me-1 mb-1">Grapas Negras: {{ asignacion.grapas_negras }}</span><br>
                                                {% endif %}
                                                {% if asignacion.grapas_blancas and asignacion.grapas_blancas|int > 0 %}
                                                    <span class="badge bg-info me-1 mb-1">Grapas Blancas: {{ asignacion.grapas_blancas }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <h5>No tienes asignaciones de ferretero</h5>
                        <p>Actualmente no tienes asignaciones de materiales ferretero registradas.</p>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="/tecnicos/dashboard" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Volver al Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para mostrar detalles de la asignación -->
<div class="modal fade" id="detalleModal" tabindex="-1" aria-labelledby="detalleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="detalleModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Detalle de Asignación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Número de Asignación:</strong> <span id="modalNumeroAsignacion"></span></p>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Fecha:</strong> <span id="modalFecha"></span></p>
                        <p><strong>Técnico:</strong> <span id="modalTecnico"></span></p>
                        <p><strong>Cédula:</strong> <span id="modalCedula"></span></p>
                        <p><strong>Silicona:</strong> <span id="modalSilicona"></span></p>
                        <p><strong>Amarres Negros:</strong> <span id="modalAmarresNegros"></span></p>
                        <p><strong>Amarres Blancos:</strong> <span id="modalAmarresBlancos"></span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Cinta Aislante:</strong> <span id="modalCinta"></span></p>
                        <p><strong>Grapas Negras:</strong> <span id="modalGrapasNegras"></span></p>
                        <p><strong>Grapas Blancas:</strong> <span id="modalGrapasBlancas"></span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <p><strong>Observaciones:</strong></p>
                        <p id="modalObservaciones" class="text-muted"></p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function verDetalle(idAsignacion) {
    // Prevenir comportamiento por defecto del enlace
    event.preventDefault();
    
    // Mostrar indicador de carga
    const loadingToast = document.createElement('div');
    loadingToast.className = 'toast-container position-fixed top-0 end-0 p-3';
    loadingToast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-body">
                <i class="fas fa-spinner fa-spin me-2"></i>Cargando detalles...
            </div>
        </div>
    `;
    document.body.appendChild(loadingToast);
    
    // Hacer petición AJAX para obtener detalles de la asignación
    fetch(`/api/tecnicos/asignacion_ferretero/${idAsignacion}`)
        .then(response => {
            // Remover indicador de carga
            document.body.removeChild(loadingToast);
            
            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.error) {
                console.error('Error en los datos:', data.error);
                showErrorToast('Error: ' + data.error);
                return;
            }
            
            // Llenar el modal con los datos
            document.getElementById('modalNumeroAsignacion').textContent = data.id_ferretero || 'N/A';
            document.getElementById('modalFecha').textContent = data.fecha_formateada || 'N/A';
            document.getElementById('modalTecnico').textContent = data.tecnico_nombre || 'N/A';
            document.getElementById('modalCedula').textContent = data.tecnico_cedula || 'N/A';
            document.getElementById('modalSilicona').textContent = data.silicona || '0';
            document.getElementById('modalAmarresNegros').textContent = data.amarres_negros || '0';
            document.getElementById('modalAmarresBlancos').textContent = data.amarres_blancos || '0';
            document.getElementById('modalCinta').textContent = data.cinta_aislante || '0';
            document.getElementById('modalGrapasNegras').textContent = data.grapas_negras || '0';
            document.getElementById('modalGrapasBlancas').textContent = data.grapas_blancas || '0';
            document.getElementById('modalObservaciones').textContent = data.observaciones || 'Sin observaciones disponibles';
            
            // Mostrar el modal usando Bootstrap 5
            const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
            modal.show();
        })
        .catch(error => {
            // Remover indicador de carga si aún existe
            if (document.body.contains(loadingToast)) {
                document.body.removeChild(loadingToast);
            }
            
            console.error('Error en la petición:', error);
            showErrorToast('Error al cargar los detalles de la asignación: ' + error.message);
        });
}

function showErrorToast(message) {
    const errorToast = document.createElement('div');
    errorToast.className = 'toast-container position-fixed top-0 end-0 p-3';
    errorToast.innerHTML = `
        <div class="toast show" role="alert">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    document.body.appendChild(errorToast);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (document.body.contains(errorToast)) {
            document.body.removeChild(errorToast);
        }
    }, 5000);
}
</script>
{% endblock %}