{% extends "base.html" %}

{% block title %}Cambios de Dotación{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
        color: white;
    }
    .btn-primary {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
    }
    .form-control:focus {
        border-color: #3583E8;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .form-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #667eea;
    }
    .section-title {
        color: #667eea;
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }
    .required {
        color: #dc3545;
    }
    .form-row {
        margin-bottom: 15px;
    }
    .talla-input {
        max-width: 100px;
    }
    .cantidad-input {
        max-width: 80px;
    }
    
    /* Estilos para la tabla de historial */
    #tablaHistorialCambios {
        font-size: 0.9rem;
    }
    
    #tablaHistorialCambios .badge {
        font-size: 0.8rem;
    }
    
    .elementos-modificados {
        max-width: 350px;
        word-wrap: break-word;
        font-size: 0.85rem;
        line-height: 1.4;
    }
    
    .elemento-item {
        padding: 8px 12px;
        margin-bottom: 6px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #3583E8;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: all 0.2s ease;
    }
    
    .elemento-item:hover {
        background-color: #e9ecef;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    
    .elemento-item .badge {
        font-size: 0.75rem;
        padding: 4px 8px;
        font-weight: 600;
        border-radius: 4px;
    }
    
    .badge.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
        color: white;
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
    }
    
    .badge.bg-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
        color: white;
        box-shadow: 0 2px 4px rgba(108, 117, 125, 0.3);
    }
    
    .precio-info {
        font-size: 0.8rem;
        color: #28a745;
        font-weight: 500;
        margin-top: 2px;
    }
    
    .tecnico-info {
        min-width: 180px;
    }
    
    .tecnico-info strong {
        color: #2c3e50;
        font-size: 0.9rem;
    }
    
    .fecha-cambio {
        min-width: 140px;
        text-align: center;
        background: linear-gradient(135deg, #e3f2fd 0%, #e3f2fd 100%);
        border-radius: 8px;
        padding: 8px;
        border: 1px solid #e1f5fe;
    }
    
    .fecha-cambio strong {
        color: #1976d2;
        font-size: 0.95rem;
        font-weight: 600;
    }
    
    .fecha-cambio i {
        color: #1976d2;
    }
    
    .fecha-registro {
        min-width: 160px;
        text-align: center;
        font-size: 0.85rem;
        background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e8 100%);
        border-radius: 6px;
        padding: 6px;
        border: 1px solid #c8e6c9;
    }
    
    .fecha-registro i {
        color: #388e3c;
    }
    
    .observaciones-cell {
        max-width: 200px;
        word-wrap: break-word;
        font-size: 0.85rem;
    }
    
    #tablaHistorialCambios tbody tr:hover {
        background-color: rgba(53, 131, 232, 0.1);
        transition: background-color 0.2s ease;
    }
    
    .table-dark {
        background: linear-gradient(135deg, #3583E8 0%, #2c5aa0 100%);
    }
    
    .spinner-border {
        width: 2rem;
        height: 2rem;
    }
    
    .btn-outline-primary:hover {
        background: linear-gradient(135deg, #3583E8 0%, #2c5aa0 100%);
        border-color: #3583E8;
    }
    
    /* Técnico Selector Styles */
    .tecnico-selector {
        position: relative;
    }
    
    .tecnico-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        z-index: 1050;
        max-height: 400px;
        overflow: hidden;
    }
    
    .dropdown-header {
        padding: 0.75rem;
        border-bottom: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
    
    .dropdown-body {
        display: flex;
        flex-direction: column;
        height: 300px;
    }
    
    .tecnicos-list {
        flex: 1;
        overflow-y: auto;
        max-height: 250px;
    }
    
    .tecnico-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f1f3f4;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .tecnico-item:hover {
        background-color: #f8f9fa;
    }
    
    .tecnico-item.selected {
        background-color: #e3f2fd;
        border-left: 3px solid #2196f3;
    }
    
    .tecnico-nombre {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.25rem;
    }
    
    .tecnico-cedula {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .tecnico-ciudad {
        font-size: 0.8rem;
        color: #28a745;
        font-weight: 500;
    }
    
    .dropdown-footer {
        padding: 0.5rem 0.75rem;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
    
    .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .pagination-info {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    .no-results {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }
    
    .no-results i {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        opacity: 0.5;
    }
    
    /* Indicadores de estado mejorados */
    .estado-valoracion {
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    
    .indicador-valorado {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        box-shadow: 0 0 6px rgba(40, 167, 69, 0.4);
    }
    
    .indicador-no-valorado {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        box-shadow: 0 0 6px rgba(108, 117, 125, 0.4);
    }
    
    /* Mejoras en la tabla */
    .table-responsive {
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    #tablaHistorialCambios thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        border: none;
        font-weight: 600;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        font-size: 0.85rem;
    }
    
    /* Responsive adjustments */
    @media (max-width: 1200px) {
        .elementos-modificados {
            max-width: 300px;
        }
        
        .fecha-cambio, .fecha-registro {
            min-width: 120px;
        }
        
        /* Ocultar columna de observaciones en tablets */
        #tablaHistorialCambios th:nth-child(6),
        #tablaHistorialCambios td:nth-child(6) {
            display: none;
        }
    }
    
    @media (max-width: 992px) {
        /* Ocultar fecha de registro en pantallas medianas */
        #tablaHistorialCambios th:nth-child(5),
        #tablaHistorialCambios td:nth-child(5) {
            display: none;
        }
    }
    
    /* Breakpoint para tablets y móviles grandes (481px - 768px) */
    @media (max-width: 768px) and (min-width: 481px) {
        .table-responsive {
            display: block !important;
        }
        
        #tablaHistorialCambios {
            display: table !important;
            font-size: 0.85rem;
        }
        
        .mobile-cards-container {
            display: none !important;
        }
        
        .elementos-modificados {
            max-width: 200px;
            font-size: 0.8rem;
        }
        
        .tecnico-info {
            min-width: 120px;
        }
        
        .fecha-cambio, .fecha-registro {
            min-width: 100px;
            font-size: 0.8rem;
        }
    }
    
    /* Breakpoint para móviles normales (301px - 480px) */
    @media (max-width: 480px) and (min-width: 301px) {
        .table-responsive {
            display: none !important;
        }
        
        #tablaHistorialCambios {
            display: none !important;
        }
        
        .mobile-cards-container {
            display: block !important;
            width: 100%;
            padding: 0.5rem;
        }
        
        .mobile-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 8px;
        }
        
        .mobile-card-label {
            font-size: 0.9rem;
        }
        
        .mobile-card-value {
            font-size: 0.95rem;
        }
    }
    
    @media (max-width: 300px) {
        /* Mostrar tabla en modo tarjetas para móviles ultra pequeños */
        .table-responsive {
            display: none !important;
        }
        
        #tablaHistorialCambios {
            display: none !important;
        }
        
        .mobile-cards-container {
            display: block !important;
            width: 100%;
            padding: 0.25rem;
        }
        
        /* Optimización para pantallas de 300px */
        .mobile-card {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            font-size: 0.85rem;
        }
        
        .mobile-card-header {
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
        }
        
        .mobile-card-label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }
        
        .mobile-card-value {
            font-size: 0.85rem;
            line-height: 1.3;
        }
        
        .mobile-card-section {
            margin-bottom: 0.5rem;
            padding: 0.4rem;
            border-radius: 4px;
        }
        
        .mobile-elemento-item {
            font-size: 0.75rem;
            padding: 0.3rem;
            margin-bottom: 0.2rem;
        }
        
        .badge {
            font-size: 0.65rem !important;
            padding: 0.2rem 0.4rem !important;
        }
        
        /* Ajustes para el header de la página */
        .card-header h4 {
            font-size: 1rem;
        }
        
        .btn {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        
        /* Mejoras para legibilidad */
        .mobile-observaciones {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
        }
        
        .mobile-elementos-title {
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }
        
        /* Estilos para filas y tarjetas clickeables */
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        
        .clickable-row:hover {
            background-color: #f8f9fa !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .clickable-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .clickable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Animaciones para el modal */
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
            transform: translate(0, -50px);
        }
        
        .modal.show .modal-dialog {
            transform: none;
        }
        
        /* Estilos para el modal de detalles */
        #modalDetallesCambio .modal-header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-bottom: none;
        }
        
        #modalDetallesCambio .modal-header .btn-close {
            filter: invert(1);
        }
        
        #modalDetallesCambio .section-title {
            color: #007bff;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        
        #modalDetallesCambio .info-item {
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid #007bff;
        }
        
        #modalDetallesCambio .info-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.25rem;
        }
        
        #modalDetallesCambio .info-value {
            color: #212529;
            font-size: 1.1em;
        }
        
        /* Indicador visual para más información */
        .more-info-indicator {
            font-size: 0.85em;
            color: #6c757d;
            font-style: italic;
        }
        
        /* Responsive para el modal */
        @media (max-width: 300px) {
            #modalDetallesCambio .modal-dialog {
                margin: 0.25rem;
                max-width: calc(100% - 0.5rem);
            }
            
            #modalDetallesCambio .modal-body {
                padding: 0.75rem;
            }
            
            .clickable-row:hover {
                transform: none;
                box-shadow: none;
            }
        }
        
        .mobile-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 12px;
            margin-bottom: 1rem;
            padding: 1.25rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .mobile-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            border-color: #007bff;
        }
        
        .mobile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #e9ecef;
        }
        
        .mobile-card-section {
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #007bff;
        }
        
        .mobile-card-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
            display: block;
        }
        
        .mobile-card-value {
            color: #212529;
            font-size: 0.95rem;
            line-height: 1.4;
        }
        
        .mobile-elementos {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e9ecef;
        }
        
        .mobile-elementos-title {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .mobile-elemento-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
        }
        
        .mobile-observaciones {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e9ecef;
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .elementos-modificados {
            max-width: 250px;
        }
        
        .tecnico-info {
            min-width: 140px;
        }
        
        .fecha-cambio, .fecha-registro {
            min-width: 100px;
            padding: 4px;
        }
        
        #tablaHistorialCambios {
            font-size: 0.8rem;
        }
        
        .elemento-item {
            padding: 6px 8px;
            margin-bottom: 4px;
        }
        
        .badge {
            font-size: 0.7rem !important;
            padding: 2px 6px !important;
        }
        
        .tecnico-dropdown {
            max-height: 350px;
        }
        
        .dropdown-body {
            height: 250px;
        }
        
        .tecnicos-list {
            max-height: 200px;
        }
        
        .dropdown-header .row {
            margin: 0;
        }
        
        .dropdown-header .col-6 {
            padding: 0 0.25rem;
        }
        
        .form-section {
            padding: 15px;
            margin-bottom: 15px;
        }
    }
    
    @media (max-width: 576px) {
        .card-body {
            padding: 0.75rem;
        }
        
        .mobile-card {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .mobile-card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .mobile-card-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem;
        }
        
        .mobile-card-value {
            text-align: left;
        }
        
        .elementos-modificados {
            max-width: 200px;
        }
        
        .tecnico-info {
            min-width: 120px;
        }
        
        .fecha-cambio, .fecha-registro {
            min-width: 90px;
            font-size: 0.75rem;
        }
        
        .observaciones-cell {
            max-width: 150px;
        }
        
        #tablaHistorialCambios {
            font-size: 0.75rem;
        }
        
        .form-section {
            padding: 10px;
        }
        
        .section-title {
            font-size: 1rem;
        }
    }
    
    /* Ocultar contenedor de tarjetas móviles por defecto */
    .mobile-cards-container {
        display: none;
    }
    
    /* Estilos adicionales para mejor responsive */
    @media (max-width: 480px) {
        .card-header h4 {
            font-size: 1.1rem;
        }
        
        .mobile-cards-container {
            padding: 0.25rem;
        }
        
        .mobile-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
        }
        
        .mobile-card-label {
            font-size: 0.85rem;
        }
        
        .mobile-card-value {
            font-size: 0.9rem;
        }
        
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        .mobile-elemento-item {
            font-size: 0.75rem;
            padding: 0.4rem;
        }
        
        /* Mejoras adicionales para legibilidad móvil */
        .tecnico-info strong {
            font-size: 0.85rem;
            line-height: 1.2;
        }
        
        .tecnico-info small {
            font-size: 0.7rem;
        }
        
        .elementos-modificados {
            line-height: 1.3;
        }
        
        .elemento-item {
            margin-bottom: 0.3rem;
            padding: 0.3rem 0.5rem;
            border-radius: 0.25rem;
            background-color: rgba(0,123,255,0.05);
            border-left: 3px solid #007bff;
        }
        
        .badge.bg-success, .badge.bg-secondary {
            font-size: 0.6rem;
            padding: 0.15rem 0.3rem;
            margin-left: 0.25rem;
        }
        
        /* Espaciado mejorado para tabla */
        .table td {
            padding: 0.4rem 0.2rem;
            vertical-align: middle;
        }
        
        .table th {
            padding: 0.4rem 0.2rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Ajustes para observaciones */
        .observaciones-cell {
            font-size: 0.75rem;
            max-width: 120px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Mejoras para fechas */
        .fecha-cambio strong {
            font-size: 0.8rem;
        }
        
        .fecha-registro {
            font-size: 0.7rem;
        }
    }
    
    /* Estilos para elementos en líneas separadas */
    .item-row {
        background: #ffffff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 15px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        position: relative;
    }
    
    .item-row:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: #3583E8;
        transform: translateY(-2px);
    }
    
    .item-row::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: linear-gradient(135deg, #3583E8 0%, #667eea 100%);
        border-radius: 8px 0 0 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .item-row:hover::before {
        opacity: 1;
    }
    
    .item-row .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }
    
    .item-row .form-control,
    .item-row .form-select {
        border-radius: 6px;
        border: 1px solid #ced4da;
        transition: all 0.2s ease;
    }
    
    .item-row .form-control:focus,
    .item-row .form-select:focus {
        border-color: #3583E8;
        box-shadow: 0 0 0 0.2rem rgba(53, 131, 232, 0.25);
    }
    
    /* Estilos para validación inteligente */
    .is-warning {
        border-color: #ffc107 !important;
        background-color: #fff3cd !important;
    }
    
    .is-warning:focus {
        border-color: #ffc107 !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0" >
                        <i class="fas fa-exchange-alt me-2"></i>
                        Registro de Cambios de Dotación
                    </h4>
                    <!--
                    <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#modalCambiosDotacion">
                        <i class="fas fa-plus me-2"></i>
                        Nuevo Cambio
                    </button>
                    -->
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="{{ url_for('registrar_cambio_dotacion') }}" id="formCambiosDotacion">
                        <!-- Información General -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-info-circle me-2"></i>
                                Información General
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="id_codigo_consumidor" class="form-label">
                                        Técnico <span class="required">*</span>
                                    </label>
                                    <div class="tecnico-selector">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="buscarTecnico" placeholder="Buscar por nombre o cédula..." autocomplete="off">
                                            <button type="button" class="btn btn-outline-secondary" id="btnMostrarTecnicos">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>
                                        <input type="hidden" id="id_codigo_consumidor" name="id_codigo_consumidor" required>
                                        <div class="tecnico-dropdown" id="tecnicoDropdown" style="display: none;">
                                            <div class="dropdown-header">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <select class="form-select form-select-sm" id="ordenarPor">
                                                            <option value="nombre">Ordenar por Nombre</option>
                                                            <option value="cedula">Ordenar por Cédula</option>
                                                            <option value="ciudad">Ordenar por Ciudad</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-6">
                                                        <select class="form-select form-select-sm" id="filtrarCiudad">
                                                            <option value="">Todas las ciudades</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="dropdown-body">
                                                <div class="tecnicos-list" id="tecnicosList">
                                                    <div class="text-center p-3">
                                                        <div class="spinner-border spinner-border-sm" role="status">
                                                            <span class="visually-hidden">Cargando...</span>
                                                        </div>
                                                        <p class="mt-2 mb-0 small">Cargando técnicos...</p>
                                                    </div>
                                                </div>
                                                <div class="dropdown-footer">
                                                    <div class="pagination-controls" id="paginationControls">
                                                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnAnterior" disabled>
                                                            <i class="fas fa-chevron-left"></i> Anterior
                                                        </button>
                                                        <span class="pagination-info" id="paginationInfo">Página 1 de 1</span>
                                                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnSiguiente" disabled>
                                                            Siguiente <i class="fas fa-chevron-right"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="fecha_cambio" class="form-label">
                                        Fecha de Cambio <span class="required">*</span>
                                    </label>
                                    <input type="date" class="form-control" id="fecha_cambio" name="fecha_cambio" required>
                                </div>
                            </div>
                        </div>

                        <!-- Dotación de Vestimenta -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-tshirt me-2"></i>
                                Dotación de Vestimenta
                            </h5>
                            
                            <!-- Pantalón -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="pantalon" class="form-label">Pantalón</label>
                                    <input type="number" class="form-control cantidad-input" id="pantalon" name="pantalon" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('pantalon')">
                                    <small class="text-muted" id="stock_pantalon">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="pantalon_talla" class="form-label">Talla Pantalón</label>
                                    <select class="form-select talla-input" id="pantalon_talla" name="pantalon_talla">
                                        <option value="">Seleccionar...</option>
                                        <option value="28">28</option>
                                        <option value="30">30</option>
                                        <option value="32">32</option>
                                        <option value="34">34</option>
                                        <option value="36">36</option>
                                        <option value="38">38</option>
                                        <option value="40">40</option>
                                        <option value="42">42</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_pantalon" class="form-label">Estado Pantalón</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_pantalon" name="pantalon_valorado">
                                        <label class="form-check-label text-muted" for="estado_pantalon" id="label_estado_pantalon">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Camiseta Gris -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="camisetagris" class="form-label">Camiseta Gris</label>
                                    <input type="number" class="form-control cantidad-input" id="camisetagris" name="camisetagris" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('camisetagris')">
                                    <small class="text-muted" id="stock_camisetagris">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="camiseta_gris_talla" class="form-label">Talla Camiseta Gris</label>
                                    <select class="form-select talla-input" id="camiseta_gris_talla" name="camiseta_gris_talla">
                                        <option value="">Seleccionar...</option>
                                        <option value="XS">XS</option>
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="XXL">XXL</option>
                                        <option value="XXXL">XXXL</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_camiseta_gris" class="form-label">Estado Camiseta Gris</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_camiseta_gris" name="camisetagris_valorado">
                                        <label class="form-check-label text-muted" for="estado_camiseta_gris" id="label_estado_camiseta_gris">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Guerrera -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="guerrera" class="form-label">Guerrera</label>
                                    <input type="number" class="form-control cantidad-input" id="guerrera" name="guerrera" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('guerrera')">
                                    <small class="text-muted" id="stock_guerrera">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="guerrera_talla" class="form-label">Talla Guerrera</label>
                                    <select class="form-select talla-input" id="guerrera_talla" name="guerrera_talla">
                                        <option value="">Seleccionar...</option>
                                        <option value="XS">XS</option>
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="XXL">XXL</option>
                                        <option value="XXXL">XXXL</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_guerrera" class="form-label">Estado Guerrera</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_guerrera" name="guerrera_valorado">
                                        <label class="form-check-label text-muted" for="estado_guerrera" id="label_estado_guerrera">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Camiseta Polo -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="camisetapolo" class="form-label">Camiseta Polo</label>
                                    <input type="number" class="form-control cantidad-input" id="camisetapolo" name="camisetapolo" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('camisetapolo')">
                                    <small class="text-muted" id="stock_camisetapolo">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="camiseta_polo_talla" class="form-label">Talla Camiseta Polo</label>
                                    <select class="form-select talla-input" id="camiseta_polo_talla" name="camiseta_polo_talla">
                                        <option value="">Seleccionar...</option>
                                        <option value="XS">XS</option>
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="XXL">XXL</option>
                                        <option value="XXXL">XXXL</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_camiseta_polo" class="form-label">Estado Camiseta Polo</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_camiseta_polo" name="camisetapolo_valorado">
                                        <label class="form-check-label text-muted" for="estado_camiseta_polo" id="label_estado_camiseta_polo">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Elementos de Protección Personal -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-hard-hat me-2"></i>
                                Elementos de Protección Personal (EPP)
                            </h5>
                            
                            <!-- Guantes Nitrilo -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="guantes_nitrilo" class="form-label">Guantes Nitrilo</label>
                                    <input type="number" class="form-control cantidad-input" id="guantes_nitrilo" name="guantes_nitrilo" min="0" max="20" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('guantes_nitrilo')">
                                    <small class="text-muted" id="stock_guantes_nitrilo">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_guantes_nitrilo" class="form-label">Estado Guantes Nitrilo</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_guantes_nitrilo" name="guantesnitrilo_valorado">
                                        <label class="form-check-label text-muted" for="estado_guantes_nitrilo" id="label_estado_guantes_nitrilo">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Guantes Carnaza -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="guantes_carnaza" class="form-label">Guantes Carnaza</label>
                                    <input type="number" class="form-control cantidad-input" id="guantes_carnaza" name="guantes_carnaza" min="0" max="20" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('guantes_carnaza')">
                                    <small class="text-muted" id="stock_guantes_carnaza">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_guantes_carnaza" class="form-label">Estado Guantes Carnaza</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_guantes_carnaza" name="guantescarnaza_valorado">
                                        <label class="form-check-label text-muted" for="estado_guantes_carnaza" id="label_estado_guantes_carnaza">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gafas -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="gafas" class="form-label">Gafas</label>
                                    <input type="number" class="form-control cantidad-input" id="gafas" name="gafas" min="0" max="5" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('gafas')">
                                    <small class="text-muted" id="stock_gafas">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_gafas" class="form-label">Estado Gafas</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_gafas" name="gafas_valorado">
                                        <label class="form-check-label text-muted" for="estado_gafas" id="label_estado_gafas">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gorra -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="gorra" class="form-label">Gorra</label>
                                    <input type="number" class="form-control cantidad-input" id="gorra" name="gorra" min="0" max="5" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('gorra')">
                                    <small class="text-muted" id="stock_gorra">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_gorra" class="form-label">Estado Gorra</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_gorra" name="gorra_valorado">
                                        <label class="form-check-label text-muted" for="estado_gorra" id="label_estado_gorra">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Casco -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="casco" class="form-label">Casco</label>
                                    <input type="number" class="form-control cantidad-input" id="casco" name="casco" min="0" max="3" placeholder="Cantidad" oninput="debouncedValidarStockDisponible('casco')">
                                    <small class="text-muted" id="stock_casco">Stock: Cargando...</small>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_casco" class="form-label">Estado Casco</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_casco" name="casco_valorado">
                                        <label class="form-check-label text-muted" for="estado_casco" id="label_estado_casco">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Botas -->
                            <div class="row mb-3 item-row">
                                <div class="col-md-3">
                                    <label for="botas" class="form-label">Botas</label>
                                    <input type="number" class="form-control cantidad-input" id="botas" name="botas" min="0" max="3" placeholder="Cantidad">
                                </div>
                                <div class="col-md-3">
                                    <label for="botas_talla" class="form-label">Talla Botas</label>
                                    <select class="form-select talla-input" id="botas_talla" name="botas_talla">
                                        <option value="">Seleccionar...</option>
                                        {% for i in range(35, 46) %}
                                            <option value="{{ i }}">{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_botas" class="form-label">Estado Botas</label>
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="estado_botas" name="botas_valorado">
                                        <label class="form-check-label text-muted" for="estado_botas" id="label_estado_botas">
                                            <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-comment me-2"></i>
                                Observaciones
                            </h5>
                            <div class="row">
                                <div class="col-12">
                                    <label for="observaciones" class="form-label">Observaciones Adicionales</label>
                                    <textarea class="form-control" id="observaciones" name="observaciones" rows="3" placeholder="Ingrese cualquier observación adicional sobre el cambio de dotación..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <!-- <a href="{{ url_for('logistica_dashboard') }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Volver a Logística
                                    </a> -->
                                    <div>
                                        <button type="reset" class="btn btn-outline-secondary me-2">
                                            <i class="fas fa-undo me-2"></i>
                                            Limpiar
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>
                                            Registrar Cambio
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Historial de Cambios -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-history me-2"></i>
                        Historial de Cambios de Dotación
                    </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="tablaHistorialCambios" class="table table-striped table-hover clickable-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Técnico
                                        <small class="d-block text-light opacity-75 mt-1">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Haz clic para ver detalles
                                        </small>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Cargando historial de cambios...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Contenedor de tarjetas para móviles -->
                    <div class="mobile-cards-container" id="mobileCardsContainer">
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 mb-0">Cargando historial de cambios...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Registro de Cambios de Dotación -->
<div class="modal fade" id="modalCambiosDotacion" tabindex="-1" aria-labelledby="modalCambiosDotacionLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCambiosDotacionLabel">
                    <i class="fas fa-exchange-alt me-2"></i>
                    Registro de Cambios de Dotación
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCambiosDotacionModal">
                    <!-- Información General -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-info-circle me-2"></i>
                            Información General
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="id_codigo_consumidor_modal" class="form-label">
                                    Técnico <span class="required">*</span>
                                </label>
                                <div class="tecnico-selector">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="buscarTecnicoModal" placeholder="Buscar por nombre o cédula..." autocomplete="off">
                                        <button type="button" class="btn btn-outline-secondary" id="btnMostrarTecnicosModal">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <input type="hidden" id="id_codigo_consumidor_modal" name="id_codigo_consumidor" required>
                                    <div class="tecnico-dropdown" id="tecnicoDropdownModal" style="display: none;">
                                        <div class="dropdown-header">
                                            <div class="row">
                                                <div class="col-6">
                                                    <select class="form-select form-select-sm" id="ordenarPorModal">
                                                        <option value="nombre">Ordenar por Nombre</option>
                                                        <option value="cedula">Ordenar por Cédula</option>
                                                        <option value="ciudad">Ordenar por Ciudad</option>
                                                    </select>
                                                </div>
                                                <div class="col-6">
                                                    <select class="form-select form-select-sm" id="filtrarCiudadModal">
                                                        <option value="">Todas las ciudades</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="dropdown-body">
                                            <div class="tecnicos-list" id="tecnicosListModal">
                                                <div class="text-center p-3">
                                                    <div class="spinner-border spinner-border-sm" role="status">
                                                        <span class="visually-hidden">Cargando...</span>
                                                    </div>
                                                    <p class="mt-2 mb-0 small">Cargando técnicos...</p>
                                                </div>
                                            </div>
                                            <div class="dropdown-footer">
                                                <div class="pagination-controls" id="paginationControlsModal">
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnAnteriorModal" disabled>
                                                        <i class="fas fa-chevron-left"></i> Anterior
                                                    </button>
                                                    <span class="pagination-info" id="paginationInfoModal">Página 1 de 1</span>
                                                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnSiguienteModal" disabled>
                                                        Siguiente <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="fecha_cambio_modal" class="form-label">
                                    Fecha de Cambio <span class="required">*</span>
                                </label>
                                <input type="date" class="form-control" id="fecha_cambio_modal" name="fecha_cambio" required>
                            </div>
                        </div>
                    </div>

                    <!-- Dotación de Vestimenta -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-tshirt me-2"></i>
                            Dotación de Vestimenta
                        </h5>
                        
                        <!-- Pantalón -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-3">
                                <label for="pantalon_modal" class="form-label">Pantalón</label>
                                <input type="number" class="form-control cantidad-input" id="pantalon_modal" name="pantalon" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('pantalon')">
                                <small class="text-muted" id="stock_pantalon_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-3">
                                <label for="pantalon_talla_modal" class="form-label">Talla Pantalón</label>
                                <select class="form-select talla-input" id="pantalon_talla_modal" name="pantalon_talla">
                                    <option value="">Seleccionar...</option>
                                    <option value="28">28</option>
                                    <option value="30">30</option>
                                    <option value="32">32</option>
                                    <option value="34">34</option>
                                    <option value="36">36</option>
                                    <option value="38">38</option>
                                    <option value="40">40</option>
                                    <option value="42">42</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="estado_pantalon_modal" class="form-label">Estado Pantalón</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_pantalon_modal" name="pantalon_valorado">
                                    <label class="form-check-label text-muted" for="estado_pantalon_modal" id="label_estado_pantalon_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Camiseta Gris -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-3">
                                <label for="camisetagris_modal" class="form-label">Camiseta Gris</label>
                                <input type="number" class="form-control cantidad-input" id="camisetagris_modal" name="camisetagris" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('camisetagris')">
                                <small class="text-muted" id="stock_camisetagris_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-3">
                                <label for="camisetagris_talla_modal" class="form-label">Talla Camiseta Gris</label>
                                <select class="form-select talla-input" id="camisetagris_talla_modal" name="camisetagris_talla">
                                    <option value="">Seleccionar...</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="estado_camiseta_gris_modal" class="form-label">Estado Camiseta Gris</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_camiseta_gris_modal" name="camisetagris_valorado">
                                    <label class="form-check-label text-muted" for="estado_camiseta_gris_modal" id="label_estado_camiseta_gris_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Guerrera -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-3">
                                <label for="guerrera_modal" class="form-label">Guerrera</label>
                                <input type="number" class="form-control cantidad-input" id="guerrera_modal" name="guerrera" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('guerrera')">
                                <small class="text-muted" id="stock_guerrera_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-3">
                                <label for="guerrera_talla_modal" class="form-label">Talla Guerrera</label>
                                <select class="form-select talla-input" id="guerrera_talla_modal" name="guerrera_talla">
                                    <option value="">Seleccionar...</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="estado_guerrera_modal" class="form-label">Estado Guerrera</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_guerrera_modal" name="guerrera_valorado">
                                    <label class="form-check-label text-muted" for="estado_guerrera_modal" id="label_estado_guerrera_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Camiseta Polo -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-3">
                                <label for="camisetapolo_modal" class="form-label">Camiseta Polo</label>
                                <input type="number" class="form-control cantidad-input" id="camisetapolo_modal" name="camisetapolo" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('camisetapolo')">
                                <small class="text-muted" id="stock_camisetapolo_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-3">
                                <label for="camisetapolo_talla_modal" class="form-label">Talla Camiseta Polo</label>
                                <select class="form-select talla-input" id="camisetapolo_talla_modal" name="camisetapolo_talla">
                                    <option value="">Seleccionar...</option>
                                    <option value="XS">XS</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="estado_camiseta_polo_modal" class="form-label">Estado Camiseta Polo</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_camiseta_polo_modal" name="camisetapolo_valorado">
                                    <label class="form-check-label text-muted" for="estado_camiseta_polo_modal" id="label_estado_camiseta_polo_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Elementos de Protección Personal -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-hard-hat me-2"></i>
                            Elementos de Protección Personal
                        </h5>
                        
                        <!-- Guantes de Nitrilo -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-4">
                                <label for="guantes_nitrilo_modal" class="form-label">Guantes de Nitrilo</label>
                                <input type="number" class="form-control cantidad-input" id="guantes_nitrilo_modal" name="guantes_nitrilo" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('guantes_nitrilo')">
                                <small class="text-muted" id="stock_guantes_nitrilo_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label for="estado_guantes_nitrilo_modal" class="form-label">Estado Guantes Nitrilo</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_guantes_nitrilo_modal" name="guantes_nitrilo_valorado">
                                    <label class="form-check-label text-muted" for="estado_guantes_nitrilo_modal" id="label_estado_guantes_nitrilo_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Guantes de Carnaza -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-4">
                                <label for="guantes_carnaza_modal" class="form-label">Guantes de Carnaza</label>
                                <input type="number" class="form-control cantidad-input" id="guantes_carnaza_modal" name="guantes_carnaza" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('guantes_carnaza')">
                                <small class="text-muted" id="stock_guantes_carnaza_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label for="estado_guantes_carnaza_modal" class="form-label">Estado Guantes Carnaza</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_guantes_carnaza_modal" name="guantes_carnaza_valorado">
                                    <label class="form-check-label text-muted" for="estado_guantes_carnaza_modal" id="label_estado_guantes_carnaza_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Gafas -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-4">
                                <label for="gafas_modal" class="form-label">Gafas</label>
                                <input type="number" class="form-control cantidad-input" id="gafas_modal" name="gafas" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('gafas')">
                                <small class="text-muted" id="stock_gafas_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label for="estado_gafas_modal" class="form-label">Estado Gafas</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_gafas_modal" name="gafas_valorado">
                                    <label class="form-check-label text-muted" for="estado_gafas_modal" id="label_estado_gafas_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Gorra -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-4">
                                <label for="gorra_modal" class="form-label">Gorra</label>
                                <input type="number" class="form-control cantidad-input" id="gorra_modal" name="gorra" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('gorra')">
                                <small class="text-muted" id="stock_gorra_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label for="estado_gorra_modal" class="form-label">Estado Gorra</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_gorra_modal" name="gorra_valorado">
                                    <label class="form-check-label text-muted" for="estado_gorra_modal" id="label_estado_gorra_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Casco -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-4">
                                <label for="casco_modal" class="form-label">Casco</label>
                                <input type="number" class="form-control cantidad-input" id="casco_modal" name="casco" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('casco')">
                                <small class="text-muted" id="stock_casco_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label for="estado_casco_modal" class="form-label">Estado Casco</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_casco_modal" name="casco_valorado">
                                    <label class="form-check-label text-muted" for="estado_casco_modal" id="label_estado_casco_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Botas -->
                        <div class="row mb-3 item-row">
                            <div class="col-md-3">
                                <label for="botas_modal" class="form-label">Botas</label>
                                <input type="number" class="form-control cantidad-input" id="botas_modal" name="botas" min="0" max="10" placeholder="Cantidad" oninput="debouncedValidarStockDisponibleCambios('botas')">
                                <small class="text-muted" id="stock_botas_modal">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-3">
                                <label for="botas_talla_modal" class="form-label">Talla Botas</label>
                                <select class="form-select talla-input" id="botas_talla_modal" name="botas_talla">
                                    <option value="">Seleccionar...</option>
                                    <option value="35">35</option>
                                    <option value="36">36</option>
                                    <option value="37">37</option>
                                    <option value="38">38</option>
                                    <option value="39">39</option>
                                    <option value="40">40</option>
                                    <option value="41">41</option>
                                    <option value="42">42</option>
                                    <option value="43">43</option>
                                    <option value="44">44</option>
                                    <option value="45">45</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="estado_botas_modal" class="form-label">Estado Botas</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="estado_botas_modal" name="botas_valorado">
                                    <label class="form-check-label text-muted" for="estado_botas_modal" id="label_estado_botas_modal">
                                        <i class="fas fa-times-circle me-1"></i>NO VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones Adicionales -->
                    <div class="form-section">
                        <h5 class="section-title">
                            <i class="fas fa-comment me-2"></i>
                            Observaciones
                        </h5>
                        <div class="row">
                            <div class="col-12">
                                <label for="observaciones_modal" class="form-label">Observaciones Adicionales</label>
                                <textarea class="form-control" id="observaciones_modal" name="observaciones" rows="3" placeholder="Ingrese cualquier observación adicional sobre el cambio de dotación..."></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" onclick="limpiarFormularioCambios()">
                    <i class="fas fa-undo me-2"></i>
                    Limpiar
                </button>
                <button type="button" class="btn btn-primary" onclick="registrarCambioDotacion()">
                    <i class="fas fa-save me-2"></i>
                    Registrar Cambio
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalles del Cambio -->
<div class="modal fade" id="modalDetallesCambio" tabindex="-1" aria-labelledby="modalDetallesCambioLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalDetallesCambioLabel">
                    <i class="fas fa-info-circle me-2"></i>
                    Detalles del Cambio de Dotación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <!-- Información del Técnico -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                Información del Técnico
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Técnico:</strong>
                                    <p class="mb-1" id="detalle-tecnico">-</p>
                                </div>
                                <div class="col-md-6">
                                    <strong>Cédula:</strong>
                                    <p class="mb-1" id="detalle-cedula">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información del Cambio -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-calendar me-2"></i>
                                Información del Cambio
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Fecha de Cambio:</strong>
                                    <p class="mb-1" id="detalle-fecha-cambio">-</p>
                                </div>
                                <div class="col-md-6">
                                    <strong>Fecha de Registro:</strong>
                                    <p class="mb-1" id="detalle-fecha-registro">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Elementos de Dotación -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-tshirt me-2"></i>
                                Elementos de Dotación
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row" id="detalle-elementos">
                                <!-- Los elementos se cargarán dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-comment me-2"></i>
                                Observaciones
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-0" id="detalle-observaciones">Sin observaciones</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Cache busting - Forzar recarga del JavaScript
console.log('🔄 Cambios Dotación JS cargado - Versión:', new Date().getTime());

// Variables globales para el selector de técnicos
let tecnicosData = [];
let tecnicosFiltrados = [];
let paginaActual = 1;
const elementosPorPagina = 10;
let tecnicoSeleccionado = null;

// Variables para debouncing
let validationTimeouts = {};

// Función de debouncing para validación de stock
function debouncedValidarStockDisponible(elemento, delay = 300) {
    // Cancelar timeout anterior si existe
    if (validationTimeouts[elemento]) {
        clearTimeout(validationTimeouts[elemento]);
    }
    
    // Crear nuevo timeout
    validationTimeouts[elemento] = setTimeout(() => {
        validarStockDisponible(elemento);
    }, delay);
}

// Función de debouncing para validación de stock en cambios
function debouncedValidarStockDisponibleCambios(elemento, delay = 300) {
    // Cancelar timeout anterior si existe
    if (validationTimeouts[elemento + '_cambios']) {
        clearTimeout(validationTimeouts[elemento + '_cambios']);
    }
    
    // Crear nuevo timeout
    validationTimeouts[elemento + '_cambios'] = setTimeout(() => {
        validarStockDisponibleCambios(elemento);
    }, delay);
}

document.addEventListener('DOMContentLoaded', function() {
    // Establecer fecha actual por defecto
    const fechaInput = document.getElementById('fecha_cambio');
    const today = new Date().toISOString().split('T')[0];
    fechaInput.value = today;
    
    // Inicializar selector de técnicos
    inicializarSelectorTecnicos();
    
    // Cargar historial de cambios al cargar la página
    cargarHistorialCambios();
    
    // Validación del formulario
    const form = document.getElementById('formCambiosDotacion');
    form.addEventListener('submit', function(e) {
        const tecnico = document.getElementById('id_codigo_consumidor').value;
        const fecha = document.getElementById('fecha_cambio').value;
        
        if (!tecnico || !fecha) {
            e.preventDefault();
            alert('Por favor complete los campos obligatorios: Técnico y Fecha de Cambio');
            return false;
        }
        
        // Verificar que al menos un elemento de dotación tenga cantidad
        const campos = ['pantalon', 'camisetagris', 'guerrera', 'camisetapolo', 'guantes_nitrilo', 'guantes_carnaza', 'gafas', 'gorra', 'casco', 'botas'];
        let tieneElementos = false;
        
        campos.forEach(campo => {
            const valor = document.getElementById(campo).value;
            if (valor && parseInt(valor) > 0) {
                tieneElementos = true;
            }
        });
        
        if (!tieneElementos) {
            e.preventDefault();
            alert('Debe especificar al menos un elemento de dotación con cantidad mayor a 0');
            return false;
        }
        
        // Si la validación pasa, recargar historial después del envío
        setTimeout(() => {
            cargarHistorialCambios();
        }, 1000);
    });
});

// Función para inicializar el selector de técnicos
function inicializarSelectorTecnicos() {
    cargarTecnicos();
    
    const buscarInput = document.getElementById('buscarTecnico');
    const btnMostrar = document.getElementById('btnMostrarTecnicos');
    const dropdown = document.getElementById('tecnicoDropdown');
    const ordenarSelect = document.getElementById('ordenarPor');
    const filtrarCiudad = document.getElementById('filtrarCiudad');
    const btnAnterior = document.getElementById('btnAnterior');
    const btnSiguiente = document.getElementById('btnSiguiente');
    
    // Event listeners
    buscarInput.addEventListener('input', filtrarTecnicos);
    btnMostrar.addEventListener('click', toggleDropdown);
    ordenarSelect.addEventListener('change', aplicarOrdenamiento);
    filtrarCiudad.addEventListener('change', filtrarPorCiudad);
    btnAnterior.addEventListener('click', () => cambiarPagina(-1));
    btnSiguiente.addEventListener('click', () => cambiarPagina(1));
    
    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tecnico-selector')) {
            dropdown.style.display = 'none';
        }
    });
}

// Función para cargar técnicos desde el servidor
function cargarTecnicos() {
    fetch('/api/tecnicos', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            tecnicosData = data.data || [];
            tecnicosFiltrados = [...tecnicosData];
            llenarFiltrosCiudades();
            mostrarTecnicos();
        } else {
            console.error('Error al cargar técnicos:', data.error);
            mostrarErrorTecnicos('Error al cargar la lista de técnicos');
        }
    })
    .catch(error => {
        console.error('Error en la petición:', error);
        mostrarErrorTecnicos('Error de conexión al cargar técnicos');
    });
}

// Función para llenar el filtro de ciudades
function llenarFiltrosCiudades() {
    const filtrarCiudad = document.getElementById('filtrarCiudad');
    const ciudades = [...new Set(tecnicosData.map(t => t.ciudad).filter(c => c))];
    
    filtrarCiudad.innerHTML = '<option value="">Todas las ciudades</option>';
    ciudades.sort().forEach(ciudad => {
        const option = document.createElement('option');
        option.value = ciudad;
        option.textContent = ciudad;
        filtrarCiudad.appendChild(option);
    });
}

// Función para filtrar técnicos por búsqueda
function filtrarTecnicos() {
    const busqueda = document.getElementById('buscarTecnico').value.toLowerCase();
    const ciudadFiltro = document.getElementById('filtrarCiudad').value;
    
    tecnicosFiltrados = tecnicosData.filter(tecnico => {
        const coincideBusqueda = !busqueda || 
            tecnico.nombre.toLowerCase().includes(busqueda) ||
            (tecnico.recurso_operativo_cedula && tecnico.recurso_operativo_cedula.toString().includes(busqueda));
        
        const coincideCiudad = !ciudadFiltro || tecnico.ciudad === ciudadFiltro;
        
        return coincideBusqueda && coincideCiudad;
    });
    
    paginaActual = 1;
    aplicarOrdenamiento();
}

// Función para filtrar por ciudad
function filtrarPorCiudad() {
    filtrarTecnicos();
}

// Función para aplicar ordenamiento
function aplicarOrdenamiento() {
    const criterio = document.getElementById('ordenarPor').value;
    
    tecnicosFiltrados.sort((a, b) => {
        switch (criterio) {
            case 'nombre':
                return a.nombre.localeCompare(b.nombre);
            case 'cedula':
                return (a.recurso_operativo_cedula || '').toString().localeCompare((b.recurso_operativo_cedula || '').toString());
            case 'ciudad':
                return (a.ciudad || '').localeCompare(b.ciudad || '');
            default:
                return 0;
        }
    });
    
    mostrarTecnicos();
}

// Función para mostrar técnicos en la lista
function mostrarTecnicos() {
    const lista = document.getElementById('tecnicosList');
    const inicio = (paginaActual - 1) * elementosPorPagina;
    const fin = inicio + elementosPorPagina;
    const tecnicosPagina = tecnicosFiltrados.slice(inicio, fin);
    
    if (tecnicosFiltrados.length === 0) {
        lista.innerHTML = `
            <div class="no-results">
                <i class="fas fa-search"></i>
                <p>No se encontraron técnicos</p>
                <small>Intenta con otros criterios de búsqueda</small>
            </div>
        `;
    } else {
        lista.innerHTML = tecnicosPagina.map(tecnico => `
            <div class="tecnico-item" data-id="${tecnico.id_codigo_consumidor}" onclick="seleccionarTecnico(${tecnico.id_codigo_consumidor}, '${tecnico.nombre}', '${tecnico.recurso_operativo_cedula || ''}')">
                <div class="tecnico-nombre">${tecnico.nombre}</div>
                <div class="tecnico-cedula">Cédula: ${tecnico.recurso_operativo_cedula || 'No disponible'}</div>
                <div class="tecnico-ciudad">${tecnico.ciudad || 'Ciudad no especificada'}</div>
            </div>
        `).join('');
    }
    
    actualizarPaginacion();
}

// Función para actualizar controles de paginación
function actualizarPaginacion() {
    const totalPaginas = Math.ceil(tecnicosFiltrados.length / elementosPorPagina);
    const btnAnterior = document.getElementById('btnAnterior');
    const btnSiguiente = document.getElementById('btnSiguiente');
    const paginationInfo = document.getElementById('paginationInfo');
    
    btnAnterior.disabled = paginaActual <= 1;
    btnSiguiente.disabled = paginaActual >= totalPaginas;
    
    paginationInfo.textContent = `Página ${paginaActual} de ${totalPaginas || 1} (${tecnicosFiltrados.length} técnicos)`;
}

// Función para cambiar página
function cambiarPagina(direccion) {
    const totalPaginas = Math.ceil(tecnicosFiltrados.length / elementosPorPagina);
    const nuevaPagina = paginaActual + direccion;
    
    if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
        paginaActual = nuevaPagina;
        mostrarTecnicos();
    }
}

// Función para seleccionar un técnico
function seleccionarTecnico(id, nombre, cedula) {
    tecnicoSeleccionado = { id, nombre, cedula };
    
    document.getElementById('buscarTecnico').value = `${nombre} - ${cedula}`;
    document.getElementById('id_codigo_consumidor').value = id;
    document.getElementById('tecnicoDropdown').style.display = 'none';
    
    // Marcar como seleccionado visualmente
    document.querySelectorAll('.tecnico-item').forEach(item => {
        item.classList.remove('selected');
    });
    document.querySelector(`[data-id="${id}"]`).classList.add('selected');
}

// Función para mostrar/ocultar dropdown
function toggleDropdown() {
    const dropdown = document.getElementById('tecnicoDropdown');
    const isVisible = dropdown.style.display === 'block';
    
    if (isVisible) {
        dropdown.style.display = 'none';
    } else {
        dropdown.style.display = 'block';
        if (tecnicosData.length === 0) {
            cargarTecnicos();
        }
    }
}

// Función para mostrar error en la carga de técnicos
function mostrarErrorTecnicos(mensaje) {
    const lista = document.getElementById('tecnicosList');
    lista.innerHTML = `
        <div class="text-center p-3 text-danger">
            <i class="fas fa-exclamation-triangle mb-2"></i>
            <p>${mensaje}</p>
            <button class="btn btn-sm btn-outline-primary" onclick="cargarTecnicos()">
                <i class="fas fa-refresh me-1"></i>
                Reintentar
            </button>
        </div>
    `;
}

// Función para cargar el historial de cambios
function cargarHistorialCambios() {
    fetch('/api/cambios_dotacion/historial', {
        method: 'GET',
        credentials: 'include',
        headers: {
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            // Verificar si la respuesta es HTML (redirección a login)
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('text/html')) {
                throw new Error('AUTHENTICATION_REQUIRED');
            }
            
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarHistorialCambios(data.data);
            } else {
                console.error('Error al cargar historial:', data.error || data.message);
                mostrarErrorHistorial(data.error || 'Error al cargar el historial de cambios');
            }
        })
        .catch(error => {
            console.error('Error en la petición:', error);
            
            if (error.message === 'AUTHENTICATION_REQUIRED') {
                mostrarErrorHistorial('Sesión expirada. Por favor, inicie sesión nuevamente.');
            } else if (error.name === 'SyntaxError' && error.message.includes('JSON')) {
                mostrarErrorHistorial('Error de autenticación. Por favor, recargue la página e inicie sesión.');
            } else {
                mostrarErrorHistorial('Error de conexión al cargar el historial');
            }
        });
}

// Función para mostrar los datos del historial en la tabla
function mostrarHistorialCambios(cambios) {
    const tbody = document.querySelector('#tablaHistorialCambios tbody');
    
    if (cambios.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay cambios de dotación registrados
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = '';
    
    // Limpiar contenedor móvil
    const mobileContainer = document.getElementById('mobileCardsContainer');
    if (mobileContainer) {
        mobileContainer.innerHTML = '';
    }
    
    cambios.forEach(cambio => {
        const fechaCambio = formatearFecha(cambio.fecha_cambio);
        const fechaRegistro = formatearFechaHora(cambio.fecha_registro);
        const observaciones = cambio.observaciones || 'Sin observaciones';
        
        // Formatear elementos modificados con estado de valoración
        const elementosHTML = formatearElementosConValoracion(cambio.elementos_modificados_detalle || cambio.elementos_modificados);
        
        // Crear fila para tabla desktop
        const fila = document.createElement('tr');
        fila.className = 'clickable-row';
        fila.style.cursor = 'pointer';
        fila.setAttribute('data-cambio-id', cambio.id);
        fila.innerHTML = `
            <td>
                <div class="tecnico-info">
                    <strong>${cambio.tecnico_nombre || 'Técnico no encontrado'}</strong>
                    <br>
                    <small class="text-muted">
                        <i class="fas fa-id-card me-1"></i>
                        Cédula: ${cambio.tecnico_cedula || cambio.id_codigo_consumidor}
                    </small>
                    <br>
                    <small class="text-info">
                        <i class="fas fa-info-circle me-1"></i>
                        Haz clic para ver detalles
                    </small>
                </div>
            </td>
        `;
        
        // Agregar evento click para abrir modal de detalles
        fila.addEventListener('click', () => {
            mostrarDetallesCambio(cambio);
        });
        
        tbody.appendChild(fila);
        
        // Crear tarjeta para móvil
        if (mobileContainer) {
            const card = document.createElement('div');
            card.className = 'mobile-card clickable-card';
            card.style.cursor = 'pointer';
            card.setAttribute('data-cambio-id', cambio.id);
            card.innerHTML = `
                <div class="mobile-card-header">
                    <span class="badge bg-primary">#${cambio.id}</span>
                    <div class="mobile-card-date">
                        <i class="fas fa-calendar-alt me-1"></i>
                        ${fechaCambio}
                    </div>
                </div>
                <div class="mobile-card-body">
                    <div class="mobile-card-section">
                        <div class="mobile-card-label">
                            <i class="fas fa-user me-1"></i>
                            Técnico
                        </div>
                        <div class="mobile-card-value">
                            <strong>${cambio.tecnico_nombre || 'Técnico no encontrado'}</strong>
                            <br>
                            <small class="text-muted">
                                <i class="fas fa-id-card me-1"></i>
                                ${cambio.tecnico_cedula || cambio.id_codigo_consumidor}
                            </small>
                        </div>
                    </div>
                    <div class="mobile-card-section">
                        <div class="mobile-card-label">
                            <i class="fas fa-box me-1"></i>
                            Elementos Modificados
                        </div>
                        <div class="mobile-card-value">
                            ${elementosHTML}
                        </div>
                    </div>
                    <div class="mobile-card-section">
                        <div class="mobile-card-label">
                            <i class="fas fa-clock me-1"></i>
                            Fecha de Registro
                        </div>
                        <div class="mobile-card-value">
                            ${fechaRegistro}
                        </div>
                    </div>
                    ${observaciones !== 'Sin observaciones' ? `
                    <div class="mobile-card-section">
                        <div class="mobile-card-label">
                            <i class="fas fa-comment me-1"></i>
                            Observaciones
                        </div>
                        <div class="mobile-card-value">
                            ${observaciones}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;            
            
            // Agregar evento click para abrir modal de detalles
            card.addEventListener('click', () => {
                mostrarDetallesCambio(cambio);
            });
            
            mobileContainer.appendChild(card);
        }
    });
}

// Función para mostrar detalles del cambio en el modal
function mostrarDetallesCambio(cambio) {
    // Poblar información del técnico
    document.getElementById('detalle-tecnico').textContent = cambio.tecnico_nombre || 'Técnico no encontrado';
    document.getElementById('detalle-cedula').textContent = cambio.tecnico_cedula || cambio.id_codigo_consumidor || 'No disponible';
    
    // Poblar información del cambio
    document.getElementById('detalle-fecha-cambio').textContent = formatearFecha(cambio.fecha_cambio);
    document.getElementById('detalle-fecha-registro').textContent = formatearFechaHora(cambio.fecha_registro);
    
    // Poblar elementos de dotación
    const elementosContainer = document.getElementById('detalle-elementos');
    elementosContainer.innerHTML = '';
    
    if (cambio.elementos_modificados_detalle && Array.isArray(cambio.elementos_modificados_detalle)) {
        cambio.elementos_modificados_detalle.forEach(elemento => {
            const elementoDiv = document.createElement('div');
            elementoDiv.className = 'col-md-6 mb-3';
            
            const valoradoBadge = elemento.es_valorado ? 
                '<span class="badge bg-success ms-2"><i class="fas fa-dollar-sign me-1"></i>VALORADO</span>' : 
                '<span class="badge bg-secondary ms-2"><i class="fas fa-box me-1"></i>NO VALORADO</span>';
            
            const precioInfo = elemento.precio_unitario && elemento.es_valorado ? 
                `<div class="mt-2 text-muted">
                    <i class="fas fa-tag me-1"></i>
                    Precio unitario: <strong>$${elemento.precio_unitario.toLocaleString('es-CO')}</strong>
                    ${elemento.cantidad > 1 ? `<br><i class="fas fa-calculator me-1"></i>Total: <strong>$${(elemento.precio_unitario * elemento.cantidad).toLocaleString('es-CO')}</strong>` : ''}
                </div>` : '';
            
            elementoDiv.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <h6 class="card-title text-primary">
                            <i class="fas fa-tshirt me-2"></i>
                            ${elemento.descripcion || elemento.elemento}
                        </h6>
                        <div class="mb-2">
                            <span class="badge bg-primary">Cantidad: ${elemento.cantidad}</span>
                            ${elemento.talla ? `<span class="badge bg-info ms-1">Talla: ${elemento.talla}</span>` : ''}
                            ${valoradoBadge}
                        </div>
                        ${precioInfo}
                    </div>
                </div>
            `;
            
            elementosContainer.appendChild(elementoDiv);
        });
    } else if (cambio.elementos_modificados) {
        // Fallback para formato simple
        const elementoDiv = document.createElement('div');
        elementoDiv.className = 'col-12';
        elementoDiv.innerHTML = `
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title text-primary">
                        <i class="fas fa-tshirt me-2"></i>
                        Elementos Modificados
                    </h6>
                    <p class="card-text">${cambio.elementos_modificados}</p>
                </div>
            </div>
        `;
        elementosContainer.appendChild(elementoDiv);
    } else {
        elementosContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay elementos registrados para este cambio
                </div>
            </div>
        `;
    }
    
    // Poblar observaciones
    const observaciones = cambio.observaciones || 'Sin observaciones';
    document.getElementById('detalle-observaciones').textContent = observaciones;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalDetallesCambio'));
    modal.show();
}

// Función para mostrar error en el historial
function mostrarErrorHistorial(mensaje) {
    const tbody = document.querySelector('#tablaHistorialCambios tbody');
    
    // Determinar qué botones mostrar según el tipo de error
    let botonesHTML = '';
    if (mensaje.includes('Sesión expirada') || mensaje.includes('autenticación')) {
        botonesHTML = `
            <button class="btn btn-sm btn-primary mt-2 me-2" onclick="window.location.href='/login'">
                <i class="fas fa-sign-in-alt me-1"></i>
                Iniciar Sesión
            </button>
            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="window.location.reload()">
                <i class="fas fa-refresh me-1"></i>
                Recargar Página
            </button>
        `;
    } else {
        botonesHTML = `
            <button class="btn btn-sm btn-outline-primary mt-2" onclick="cargarHistorialCambios()">
                <i class="fas fa-refresh me-1"></i>
                Reintentar
            </button>
        `;
    }
    
    tbody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${mensaje}
                <br>
                ${botonesHTML}
            </td>
        </tr>
    `;
}

// Función para formatear fecha y hora
function formatearFechaHora(fechaString) {
    if (!fechaString || fechaString === null) return 'Fecha no disponible';
    
    try {
        const fecha = new Date(fechaString);
        
        // Verificar si la fecha es válida
        if (isNaN(fecha.getTime())) {
            return 'Fecha no disponible';
        }
        
        const dia = fecha.getDate().toString().padStart(2, '0');
        const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
        const año = fecha.getFullYear();
        const hora = fecha.getHours().toString().padStart(2, '0');
        const minutos = fecha.getMinutes().toString().padStart(2, '0');
        
        return `${dia}/${mes}/${año} ${hora}:${minutos}`;
    } catch (error) {
        console.error('Error al formatear fecha y hora:', error, fechaString);
        return 'Fecha no disponible';
    }
}

// Función para formatear solo fecha
function formatearFecha(fechaString) {
    if (!fechaString || fechaString === null) return 'Fecha no disponible';
    
    try {
        // Para fechas tipo DATE (YYYY-MM-DD), parseamos directamente sin crear objeto Date
        // para evitar problemas de zona horaria
        if (fechaString.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const partes = fechaString.split('-');
            const año = partes[0];
            const mes = partes[1];
            const dia = partes[2];
            return `${dia}/${mes}/${año}`;
        }
        
        // Para otros formatos, usamos el método original
        const fecha = new Date(fechaString);
        
        // Verificar si la fecha es válida
        if (isNaN(fecha.getTime())) {
            return 'Fecha no disponible';
        }
        
        const dia = fecha.getDate().toString().padStart(2, '0');
        const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
        const año = fecha.getFullYear();
        
        return `${dia}/${mes}/${año}`;
    } catch (error) {
        console.error('Error al formatear fecha:', error, fechaString);
        return 'Fecha no disponible';
    }
}

// Función para formatear elementos con estado de valoración
function formatearElementosConValoracion(elementos) {
    if (!elementos) return '<div class="text-muted"><i class="fas fa-info-circle me-1"></i>Sin elementos registrados</div>';
    
    // Si es un string simple, devolverlo tal como está
    if (typeof elementos === 'string') {
        return `<div class="elemento-item">${elementos}</div>`;
    }
    
    // Si es un array de objetos con información detallada
    if (Array.isArray(elementos)) {
        return elementos.map(elemento => {
            const valoradoBadge = elemento.es_valorado ? 
                '<span class="badge bg-success ms-2"><i class="fas fa-dollar-sign me-1"></i>VALORADO</span>' : 
                '<span class="badge bg-secondary ms-2"><i class="fas fa-box me-1"></i>NO VALORADO</span>';
            
            const precioInfo = elemento.precio_unitario && elemento.es_valorado ? 
                `<div class="precio-info mt-1">
                    <i class="fas fa-tag me-1"></i>
                    Precio unitario: $${elemento.precio_unitario.toLocaleString('es-CO')}
                    ${elemento.cantidad > 1 ? ` | Total: $${(elemento.precio_unitario * elemento.cantidad).toLocaleString('es-CO')}` : ''}
                </div>` : '';
            
            return `
                <div class="elemento-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <strong class="text-primary">${elemento.descripcion || elemento.elemento}</strong>
                            <span class="text-muted ms-2">Cantidad: <strong>${elemento.cantidad}</strong></span>
                            ${elemento.talla ? `<span class="text-muted ms-2">Talla: <strong>${elemento.talla}</strong></span>` : ''}
                        </div>
                        ${valoradoBadge}
                    </div>
                    ${precioInfo}
                </div>
            `;
        }).join('');
    }
    
    return `<div class="elemento-item">${elementos}</div>`;
}

// Función para manejar el cambio de estado de los checkboxes de valoración
function toggleEstadoValorado(elemento) {
    const checkbox = document.getElementById(`estado_${elemento}`);
    const label = document.getElementById(`label_estado_${elemento}`);
    
    if (checkbox.checked) {
        label.innerHTML = '<i class="fas fa-check-circle me-1"></i>VALORADO';
        label.className = 'form-check-label text-success fw-bold';
    } else {
        label.innerHTML = '<i class="fas fa-times-circle me-1"></i>NO VALORADO';
        label.className = 'form-check-label text-muted';
    }
}

// Inicializar los event listeners para los checkboxes de estado
document.addEventListener('DOMContentLoaded', function() {
    // Lista de elementos con checkboxes de estado
    const elementos = [
        'pantalon', 'camiseta_gris', 'guerrera', 'camiseta_polo',
        'guantes_nitrilo', 'guantes_carnaza', 'gafas', 'gorra', 'casco', 'botas'
    ];
    
    elementos.forEach(elemento => {
        const checkbox = document.getElementById(`estado_${elemento}`);
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                toggleEstadoValorado(elemento);
            });
        }
    });
    
    // Cargar técnicos y historial al inicializar la página
    cargarTecnicos();
    cargarHistorialCambios();
    
    // Cargar stock por estado de valoración y por tallas
    cargarStockPorEstado();
    cargarStockPorTallas();
    
    // Agregar validación al formulario
    const form = document.getElementById('formCambiosDotacion');
    if (form) {
        form.addEventListener('submit', function(e) {
            if (!validarFormularioCompleto()) {
                e.preventDefault();
            }
        });
    }
});

// Variables globales para stock
let stockPorEstado = {};
let stockPorTallas = {};

// Función para cargar stock por estado de valoración
function cargarStockPorEstado() {
    fetch('/api/stock_por_estado')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                stockPorEstado = data.stock_por_estado;
                actualizarIndicadoresStock();
            } else {
                console.error('Error al cargar stock:', data.error);
            }
        })
        .catch(error => {
            console.error('Error al cargar stock:', error);
        });
}

// Función para cargar stock por tallas
function cargarStockPorTallas() {
    fetch('/api/stock-dotaciones-tallas')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                stockPorTallas = data.stock_tallas;
                console.log('Stock por tallas cargado:', stockPorTallas);
            } else {
                console.error('Error al cargar stock por tallas:', data.error);
            }
        })
        .catch(error => {
            console.error('Error al cargar stock por tallas:', error);
        });
}

// Función para obtener stock disponible por talla específica
function obtenerStockPorTalla(tipoElemento, talla) {
    if (!stockPorTallas || !Array.isArray(stockPorTallas)) {
        return 0;
    }
    
    const item = stockPorTallas.find(stock => {
        if (stock.tipo_elemento === tipoElemento) {
            // Para pantalones y otros elementos, buscar por talla
            return stock.talla && stock.talla.toString() === talla.toString();
        }
        return false;
    });
    
    return item ? (item.stock_disponible || 0) : 0;
}

// Función para actualizar indicadores de stock
function actualizarIndicadoresStock() {
    const elementos = {
        'pantalon': 'Pantalón',
        'camisetagris': 'Camiseta Gris',
        'guerrera': 'Guerrera',
        'camisetapolo': 'Camiseta Polo',
        'guantes_nitrilo': 'Guantes Nitrilo',
        'guantes_carnaza': 'Guantes Carnaza',
        'gafas': 'Gafas',
        'gorra': 'Gorra',
        'casco': 'Casco'
    };
    
    Object.keys(elementos).forEach(elemento => {
        const stockElement = document.getElementById(`stock_${elemento}`);
        if (stockElement && stockPorEstado[elemento]) {
            const stock = stockPorEstado[elemento];
            const valorado = stock.VALORADO || 0;
            const noValorado = stock['NO VALORADO'] || 0;
            
            let stockHtml = `Stock: <span class="text-success">Valorado: ${valorado}</span> | <span class="text-secondary">No Valorado: ${noValorado}</span>`;
            
            // Agregar información de tallas para pantalones
            if (elemento === 'pantalon' && stockPorTallas && Array.isArray(stockPorTallas)) {
                const tallasPantalon = stockPorTallas.filter(item => item.tipo_elemento === 'pantalon');
                if (tallasPantalon.length > 0) {
                    const tallasInfo = tallasPantalon.map(item => {
                const talla = item.talla || 'S/T';
                return `${talla}(${item.stock_disponible})`;
            }).join(', ');
                    stockHtml += `<br><small class="text-info"><i class="fas fa-ruler me-1"></i>Tallas disponibles: ${tallasInfo}</small>`;
                }
            }
            
            stockElement.innerHTML = stockHtml;
        }
    });
}

// Función para validar stock disponible con lógica inteligente
function validarStockDisponible(elemento) {
    console.log('🔍 validarStockDisponible llamada para:', elemento);
    
    const cantidadInput = document.getElementById(elemento);
    const estadoCheckbox = document.getElementById(`estado_${elemento === 'camisetagris' ? 'camiseta_gris' : elemento === 'camisetapolo' ? 'camiseta_polo' : elemento}`);
    const stockElement = document.getElementById(`stock_${elemento}`);
    
    console.log('📋 Elementos encontrados:', {
        cantidadInput: !!cantidadInput,
        estadoCheckbox: !!estadoCheckbox,
        stockElement: !!stockElement
    });
    
    if (!cantidadInput || !estadoCheckbox || !stockElement) return;
    
    const cantidad = parseInt(cantidadInput.value) || 0;
    const esValorado = estadoCheckbox.checked;
    
    const elementos = {
        'pantalon': 'Pantalón',
        'camisetagris': 'Camiseta Gris',
        'guerrera': 'Guerrera',
        'camisetapolo': 'Camiseta Polo',
        'guantes_nitrilo': 'Guantes Nitrilo',
        'guantes_carnaza': 'Guantes Carnaza',
        'gafas': 'Gafas',
        'gorra': 'Gorra',
        'casco': 'Casco'
    };
    
    const nombreElemento = elementos[elemento];
    if (!stockPorEstado[elemento]) return;
    
    const stock = stockPorEstado[elemento];
    const stockValorado = stock.VALORADO || 0;
    const stockNoValorado = stock['NO VALORADO'] || 0;
    const stockTotal = stockValorado + stockNoValorado;
    
    const stockDisponible = esValorado ? stockValorado : stockNoValorado;
    const stockAlternativo = esValorado ? stockNoValorado : stockValorado;
    const estado = esValorado ? 'VALORADO' : 'NO VALORADO';
    const estadoAlternativo = esValorado ? 'NO VALORADO' : 'VALORADO';
    
    // Validación adicional para pantalones con talla específica
    if (elemento === 'pantalon') {
        const tallaInput = document.getElementById('pantalon_talla');
        if (tallaInput && tallaInput.value) {
            const stockPorTallaDisponible = obtenerStockPorTalla('pantalon', tallaInput.value);
            if (cantidad > stockPorTallaDisponible) {
                cantidadInput.classList.add('is-invalid');
                stockElement.innerHTML = `<span class="text-danger">⚠️ Stock insuficiente para talla ${tallaInput.value}: ${stockPorTallaDisponible} disponibles</span>`;
                return;
            }
        }
    }
    
    // Lógica inteligente de validación de stock
    if (cantidad > stockDisponible) {
        if (cantidad <= stockTotal && stockAlternativo > 0) {
            // Hay stock suficiente en el estado alternativo
            cantidadInput.classList.remove('is-invalid');
            const stockNecesarioAlternativo = cantidad - stockDisponible;
            let stockHtml = `Stock: <span class="text-success">Valorado: ${stockValorado}</span> | <span class="text-secondary">No Valorado: ${stockNoValorado}</span>`;
            // Comentado: mensaje de advertencia ya no necesario con validación inteligente
            // stockHtml += `<br><span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>`;
            // stockHtml += `Stock insuficiente en ${estado} (${stockDisponible}), pero hay stock ${estadoAlternativo} disponible (${stockAlternativo}). `;
            // stockHtml += `Se usarán ${Math.min(stockDisponible, cantidad)} de ${estado}`;
            // if (stockNecesarioAlternativo > 0) {
            //     stockHtml += ` y ${stockNecesarioAlternativo} de ${estadoAlternativo}`;
            // }
            // stockHtml += `. La operación será permitida.</span>`;
            
            // Agregar información de tallas para pantalones
            if (elemento === 'pantalon' && stockPorTallas && Array.isArray(stockPorTallas)) {
                const tallasPantalon = stockPorTallas.filter(item => item.tipo_elemento === 'pantalon');
                if (tallasPantalon.length > 0) {
                    const tallasInfo = tallasPantalon.map(item => {
                        const talla = item.talla || 'S/T';
                        return `${talla}(${item.stock_disponible})`;
                    }).join(', ');
                    stockHtml += `<br><small class="text-info"><i class="fas fa-ruler me-1"></i>Tallas disponibles: ${tallasInfo}</small>`;
                }
            }
            
            stockElement.innerHTML = stockHtml;
        } else {
            // No hay stock suficiente en ningún estado
            cantidadInput.classList.add('is-invalid');
            stockElement.innerHTML = `<span class="text-danger">⚠️ Stock insuficiente total. Solicitado: ${cantidad}, Disponible: ${stockTotal} (${estado}: ${stockDisponible}, ${estadoAlternativo}: ${stockAlternativo})</span>`;
        }
    } else {
        // Hay stock suficiente en el estado preferido
        cantidadInput.classList.remove('is-invalid');
        let stockHtml = `Stock: <span class="text-success">Valorado: ${stockValorado}</span> | <span class="text-secondary">No Valorado: ${stockNoValorado}</span>`;
        
        // Agregar información de tallas para pantalones
        if (elemento === 'pantalon' && stockPorTallas && Array.isArray(stockPorTallas)) {
            const tallasPantalon = stockPorTallas.filter(item => item.tipo_elemento === 'pantalon');
            if (tallasPantalon.length > 0) {
                const tallasInfo = tallasPantalon.map(item => {
                    const talla = item.talla || 'S/T';
                    return `${talla}(${item.stock_disponible})`;
                }).join(', ');
                stockHtml += `<br><small class="text-info"><i class="fas fa-ruler me-1"></i>Tallas disponibles: ${tallasInfo}</small>`;
            }
        }
        
        stockElement.innerHTML = stockHtml;
    }
}

// Función para validar todo el formulario
function validarFormularioCompleto() {
    const elementos = {
        'pantalon': 'Pantalón',
        'camisetagris': 'Camiseta Gris',
        'guerrera': 'Guerrera',
        'camisetapolo': 'Camiseta Polo',
        'guantes_nitrilo': 'Guantes Nitrilo',
        'guantes_carnaza': 'Guantes Carnaza',
        'gafas': 'Gafas',
        'gorra': 'Gorra',
        'casco': 'Casco'
    };
    
    let errores = [];
    
    Object.keys(elementos).forEach(elemento => {
        const cantidadInput = document.getElementById(elemento);
        const estadoCheckbox = document.getElementById(`estado_${elemento === 'camisetagris' ? 'camiseta_gris' : elemento === 'camisetapolo' ? 'camiseta_polo' : elemento}`);
        
        if (!cantidadInput || !estadoCheckbox) return;
        
        const cantidad = parseInt(cantidadInput.value) || 0;
        if (cantidad === 0) return;
        
        const esValorado = estadoCheckbox.checked;
        const nombreElemento = elementos[elemento];
        
        if (!stockPorEstado[elemento]) {
            errores.push(`No se pudo verificar el stock para ${nombreElemento}`);
            return;
        }
        
        const stock = stockPorEstado[elemento];
        const stockValorado = stock.VALORADO || 0;
        const stockNoValorado = stock['NO VALORADO'] || 0;
        const stockTotal = stockValorado + stockNoValorado;
        
        const stockDisponible = esValorado ? stockValorado : stockNoValorado;
        const estado = esValorado ? 'VALORADO' : 'NO VALORADO';
        
        // Lógica inteligente: solo error si no hay stock total suficiente
        if (cantidad > stockTotal) {
            errores.push(`${nombreElemento}: Stock insuficiente total (Solicitado: ${cantidad}, Disponible: ${stockTotal})`);
        } else if (cantidad > stockDisponible) {
            // Advertencia pero no error - se usará stock de ambos estados
            console.log(`${nombreElemento}: Se usará stock mixto - ${estado}: ${Math.min(stockDisponible, cantidad)}, ${esValorado ? 'NO VALORADO' : 'VALORADO'}: ${cantidad - Math.min(stockDisponible, cantidad)}`);
        }
    });
    
    if (errores.length > 0) {
        alert('Errores de validación de stock:\n\n' + errores.join('\n'));
        return false;
    }
    
    return true;
}

// ===== FUNCIONES DEL MODAL =====

// Variables globales para el modal
let tecnicosDataCambios = [];
let tecnicosFiltradosCambios = [];
let paginaActualCambios = 1;
const tecnicosPorPaginaCambios = 10;
let ordenActualCambios = { campo: 'nombre', direccion: 'asc' };
let filtroActualCambios = '';
let ciudadSeleccionadaCambios = '';

// Función para abrir el modal de cambios
function abrirModalCambios() {
    const modal = new bootstrap.Modal(document.getElementById('modalCambiosDotacion'));
    modal.show();
    inicializarModalCambios();
}

// Función para inicializar el modal
function inicializarModalCambios() {
    // Limpiar formulario
    limpiarFormularioCambios();
    
    // Cargar técnicos
    cargarTecnicosCambios();
    
    // Cargar stock por estado
    cargarStockPorEstadoCambios();
}

// Función para manejar el cambio de estado de los checkboxes de valoración en el modal
function toggleEstadoValoradoCambios(elemento) {
    const checkbox = document.getElementById(`modal_estado_${elemento}`);
    const label = document.getElementById(`modal_label_estado_${elemento}`);
    
    if (checkbox.checked) {
        label.innerHTML = '<i class="fas fa-check-circle me-1"></i>VALORADO';
        label.className = 'form-check-label text-success fw-bold';
    } else {
        label.innerHTML = '<i class="fas fa-times-circle me-1"></i>NO VALORADO';
        label.className = 'form-check-label text-muted';
    }
    
    // Validar stock después del cambio
    const cantidadInput = document.getElementById(`modal_${elemento}`);
    if (cantidadInput && cantidadInput.value) {
        validarStockDisponibleCambios(elemento);
    }
}

// Función para cargar técnicos en el modal
function cargarTecnicosCambios() {
    fetch('/api/tecnicos')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                tecnicosDataCambios = data.tecnicos;
                tecnicosFiltradosCambios = [...tecnicosDataCambios];
                llenarFiltrosCiudadesCambios();
                mostrarTecnicosCambios();
            } else {
                mostrarErrorTecnicosCambios('Error al cargar técnicos: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarErrorTecnicosCambios('Error de conexión al cargar técnicos');
        });
}

// Función para llenar el filtro de ciudades en el modal
function llenarFiltrosCiudadesCambios() {
    const ciudades = [...new Set(tecnicosDataCambios.map(t => t.ciudad))].sort();
    const selectCiudad = document.getElementById('modal_filtroCiudad');
    
    if (selectCiudad) {
        selectCiudad.innerHTML = '<option value="">Todas las ciudades</option>';
        ciudades.forEach(ciudad => {
            selectCiudad.innerHTML += `<option value="${ciudad}">${ciudad}</option>`;
        });
    }
}

// Función para filtrar técnicos en el modal
function filtrarTecnicosCambios() {
    const filtro = document.getElementById('modal_filtroTecnico').value.toLowerCase();
    filtroActualCambios = filtro;
    
    tecnicosFiltradosCambios = tecnicosDataCambios.filter(tecnico => {
        const coincideNombre = tecnico.nombre.toLowerCase().includes(filtro) || 
                              tecnico.cedula.includes(filtro);
        const coincideCiudad = !ciudadSeleccionadaCambios || tecnico.ciudad === ciudadSeleccionadaCambios;
        return coincideNombre && coincideCiudad;
    });
    
    aplicarOrdenamientoCambios();
    paginaActualCambios = 1;
    mostrarTecnicosCambios();
}

// Función para filtrar por ciudad en el modal
function filtrarPorCiudadCambios() {
    ciudadSeleccionadaCambios = document.getElementById('modal_filtroCiudad').value;
    filtrarTecnicosCambios();
}

// Función para aplicar ordenamiento en el modal
function aplicarOrdenamientoCambios() {
    tecnicosFiltradosCambios.sort((a, b) => {
        let valorA = a[ordenActualCambios.campo];
        let valorB = b[ordenActualCambios.campo];
        
        if (typeof valorA === 'string') {
            valorA = valorA.toLowerCase();
            valorB = valorB.toLowerCase();
        }
        
        if (ordenActualCambios.direccion === 'asc') {
            return valorA < valorB ? -1 : valorA > valorB ? 1 : 0;
        } else {
            return valorA > valorB ? -1 : valorA < valorB ? 1 : 0;
        }
    });
}

// Función para mostrar técnicos en el modal
function mostrarTecnicosCambios() {
    const contenedor = document.getElementById('modal_listaTecnicos');
    const inicio = (paginaActualCambios - 1) * tecnicosPorPaginaCambios;
    const fin = inicio + tecnicosPorPaginaCambios;
    const tecnicosPagina = tecnicosFiltradosCambios.slice(inicio, fin);
    
    if (tecnicosPagina.length === 0) {
        contenedor.innerHTML = '<div class="text-center text-muted py-3">No se encontraron técnicos</div>';
        document.getElementById('modal_paginacionTecnicos').innerHTML = '';
        return;
    }
    
    contenedor.innerHTML = tecnicosPagina.map(tecnico => `
        <div class="tecnico-item" onclick="seleccionarTecnicoCambios('${tecnico.cedula}', '${tecnico.nombre}')">
            <div class="tecnico-info">
                <div class="tecnico-nombre">${tecnico.nombre}</div>
                <div class="tecnico-detalles">
                    <span class="badge bg-primary">${tecnico.cedula}</span>
                    <span class="badge bg-secondary">${tecnico.ciudad}</span>
                    <span class="badge bg-info">${tecnico.cargo}</span>
                </div>
            </div>
        </div>
    `).join('');
    
    actualizarPaginacionCambios();
}

// Función para actualizar paginación en el modal
function actualizarPaginacionCambios() {
    const totalPaginas = Math.ceil(tecnicosFiltradosCambios.length / tecnicosPorPaginaCambios);
    const contenedor = document.getElementById('modal_paginacionTecnicos');
    
    if (totalPaginas <= 1) {
        contenedor.innerHTML = '';
        return;
    }
    
    let html = '<nav><ul class="pagination pagination-sm justify-content-center">';
    
    // Botón anterior
    html += `<li class="page-item ${paginaActualCambios === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="cambiarPaginaCambios(${paginaActualCambios - 1})">&laquo;</a>
    </li>`;
    
    // Páginas
    for (let i = 1; i <= totalPaginas; i++) {
        html += `<li class="page-item ${i === paginaActualCambios ? 'active' : ''}">
            <a class="page-link" href="#" onclick="cambiarPaginaCambios(${i})">${i}</a>
        </li>`;
    }
    
    // Botón siguiente
    html += `<li class="page-item ${paginaActualCambios === totalPaginas ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="cambiarPaginaCambios(${paginaActualCambios + 1})">&raquo;</a>
    </li>`;
    
    html += '</ul></nav>';
    contenedor.innerHTML = html;
}

// Función para cambiar página en el modal
function cambiarPaginaCambios(nuevaPagina) {
    const totalPaginas = Math.ceil(tecnicosFiltradosCambios.length / tecnicosPorPaginaCambios);
    if (nuevaPagina >= 1 && nuevaPagina <= totalPaginas) {
        paginaActualCambios = nuevaPagina;
        mostrarTecnicosCambios();
    }
}

// Función para seleccionar técnico en el modal
function seleccionarTecnicoCambios(cedula, nombre) {
    document.getElementById('modal_tecnico_seleccionado').value = cedula;
    document.getElementById('modal_tecnico_nombre').textContent = nombre;
    document.getElementById('modal_tecnico_display').style.display = 'block';
    
    // Cerrar dropdown
    toggleDropdownCambios();
}

// Función para toggle del dropdown en el modal
function toggleDropdownCambios() {
    const dropdown = document.getElementById('modal_dropdownTecnicos');
    dropdown.classList.toggle('show');
}

// Función para mostrar errores de técnicos en el modal
function mostrarErrorTecnicosCambios(mensaje) {
    const contenedor = document.getElementById('modal_listaTecnicos');
    contenedor.innerHTML = `<div class="alert alert-danger">${mensaje}</div>`;
}

// Función para cargar stock por estado en el modal
function cargarStockPorEstadoCambios() {
    fetch('/api/stock_por_estado')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                stockPorEstado = data.stock_por_estado;
                actualizarIndicadoresStockCambios();
            } else {
                console.error('Error al cargar stock:', data.error);
            }
        })
        .catch(error => {
            console.error('Error al cargar stock:', error);
        });
}

// Función para actualizar indicadores de stock en el modal
function actualizarIndicadoresStockCambios() {
    const elementos = {
        'pantalon': 'Pantalón',
        'camisetagris': 'Camiseta Gris',
        'guerrera': 'Guerrera',
        'camisetapolo': 'Camiseta Polo',
        'guantes_nitrilo': 'Guantes Nitrilo',
        'guantes_carnaza': 'Guantes Carnaza',
        'gafas': 'Gafas',
        'gorra': 'Gorra',
        'casco': 'Casco'
    };
    
    Object.keys(elementos).forEach(elemento => {
        const stockElement = document.getElementById(`modal_stock_${elemento}`);
        if (stockElement && stockPorEstado[elemento]) {
            const stock = stockPorEstado[elemento];
            const valorado = stock.VALORADO || 0;
            const noValorado = stock['NO VALORADO'] || 0;
            
            let stockHtml = `Stock: <span class="text-success">Valorado: ${valorado}</span> | <span class="text-secondary">No Valorado: ${noValorado}</span>`;
            
            // Agregar información de tallas para pantalones en el modal
            if (elemento === 'pantalon' && stockPorTallas && Array.isArray(stockPorTallas)) {
                const tallasPantalon = stockPorTallas.filter(item => item.tipo_elemento === 'pantalon');
                if (tallasPantalon.length > 0) {
                    const tallasInfo = tallasPantalon.map(item => {
                        const talla = item.talla || 'S/T';
                        return `${talla}(${item.stock_disponible})`;
                    }).join(', ');
                    stockHtml += `<br><small class="text-info"><i class="fas fa-ruler me-1"></i>Tallas disponibles: ${tallasInfo}</small>`;
                }
            }
            
            stockElement.innerHTML = stockHtml;
        }
    });
}

// Función para validar stock disponible en el modal con lógica inteligente
function validarStockDisponibleCambios(elemento) {
    const cantidadInput = document.getElementById(`modal_${elemento}`);
    const estadoCheckbox = document.getElementById(`modal_estado_${elemento === 'camisetagris' ? 'camiseta_gris' : elemento === 'camisetapolo' ? 'camiseta_polo' : elemento}`);
    const stockElement = document.getElementById(`modal_stock_${elemento}`);
    
    if (!cantidadInput || !estadoCheckbox || !stockElement) return;
    
    const cantidad = parseInt(cantidadInput.value) || 0;
    const esValorado = estadoCheckbox.checked;
    
    const elementos = {
        'pantalon': 'Pantalón',
        'camisetagris': 'Camiseta Gris',
        'guerrera': 'Guerrera',
        'camisetapolo': 'Camiseta Polo',
        'guantes_nitrilo': 'Guantes Nitrilo',
        'guantes_carnaza': 'Guantes Carnaza',
        'gafas': 'Gafas',
        'gorra': 'Gorra',
        'casco': 'Casco'
    };
    
    const nombreElemento = elementos[elemento];
    if (!stockPorEstado[elemento]) return;
    
    const stock = stockPorEstado[elemento];
    const stockValorado = stock.VALORADO || 0;
    const stockNoValorado = stock['NO VALORADO'] || 0;
    const stockTotal = stockValorado + stockNoValorado;
    
    const stockDisponible = esValorado ? stockValorado : stockNoValorado;
    const stockAlternativo = esValorado ? stockNoValorado : stockValorado;
    const estado = esValorado ? 'VALORADO' : 'NO VALORADO';
    const estadoAlternativo = esValorado ? 'NO VALORADO' : 'VALORADO';
    
    // Lógica inteligente de validación de stock
    if (cantidad > stockDisponible) {
        if (cantidad <= stockTotal && stockAlternativo > 0) {
            // Hay stock suficiente en el estado alternativo
            cantidadInput.classList.remove('is-invalid');
            const stockNecesarioAlternativo = cantidad - stockDisponible;
            let stockHtml = `Stock: <span class="text-success">Valorado: ${stockValorado}</span> | <span class="text-secondary">No Valorado: ${stockNoValorado}</span>`;
            // Comentado: mensaje de advertencia ya no necesario con validación inteligente
            // stockHtml += `<br><span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>`;
            // stockHtml += `Stock insuficiente en ${estado} (${stockDisponible}), pero hay stock ${estadoAlternativo} disponible (${stockAlternativo}). `;
            // stockHtml += `Se usarán ${Math.min(stockDisponible, cantidad)} de ${estado}`;
            // if (stockNecesarioAlternativo > 0) {
            //     stockHtml += ` y ${stockNecesarioAlternativo} de ${estadoAlternativo}`;
            // }
            // stockHtml += `. La operación será permitida.</span>`;
            stockElement.innerHTML = stockHtml;
        } else {
            // No hay stock suficiente en ningún estado
            cantidadInput.classList.add('is-invalid');
            stockElement.innerHTML = `<span class="text-danger">⚠️ Stock insuficiente total. Solicitado: ${cantidad}, Disponible: ${stockTotal} (${estado}: ${stockDisponible}, ${estadoAlternativo}: ${stockAlternativo})</span>`;
        }
    } else {
        // Hay stock suficiente en el estado preferido
        cantidadInput.classList.remove('is-invalid');
        stockElement.innerHTML = `Stock: <span class="text-success">Valorado: ${stockValorado}</span> | <span class="text-secondary">No Valorado: ${stockNoValorado}</span>`;
    }
}

// Función para validar todo el formulario del modal
function validarFormularioCompletoCambios() {
    const elementos = {
        'pantalon': 'Pantalón',
        'camisetagris': 'Camiseta Gris',
        'guerrera': 'Guerrera',
        'camisetapolo': 'Camiseta Polo',
        'guantes_nitrilo': 'Guantes Nitrilo',
        'guantes_carnaza': 'Guantes Carnaza',
        'gafas': 'Gafas',
        'gorra': 'Gorra',
        'casco': 'Casco'
    };
    
    let errores = [];
    
    Object.keys(elementos).forEach(elemento => {
        const cantidadInput = document.getElementById(`modal_${elemento}`);
        const estadoCheckbox = document.getElementById(`modal_estado_${elemento === 'camisetagris' ? 'camiseta_gris' : elemento === 'camisetapolo' ? 'camiseta_polo' : elemento}`);
        
        if (!cantidadInput || !estadoCheckbox) return;
        
        const cantidad = parseInt(cantidadInput.value) || 0;
        if (cantidad === 0) return;
        
        const esValorado = estadoCheckbox.checked;
        const nombreElemento = elementos[elemento];
        
        if (!stockPorEstado[elemento]) {
            errores.push(`No se pudo verificar el stock para ${nombreElemento}`);
            return;
        }
        
        const stock = stockPorEstado[elemento];
        const stockValorado = stock.VALORADO || 0;
        const stockNoValorado = stock['NO VALORADO'] || 0;
        const stockTotal = stockValorado + stockNoValorado;
        
        const stockDisponible = esValorado ? stockValorado : stockNoValorado;
        const estado = esValorado ? 'VALORADO' : 'NO VALORADO';
        
        // Lógica inteligente: solo error si no hay stock total suficiente
        if (cantidad > stockTotal) {
            errores.push(`${nombreElemento}: Stock insuficiente total (Solicitado: ${cantidad}, Disponible: ${stockTotal})`);
        } else if (cantidad > stockDisponible) {
            // Advertencia pero no error - se usará stock de ambos estados
            console.log(`${nombreElemento}: Se usará stock mixto - ${estado}: ${Math.min(stockDisponible, cantidad)}, ${esValorado ? 'NO VALORADO' : 'VALORADO'}: ${cantidad - Math.min(stockDisponible, cantidad)}`);
        }
    });
    
    if (errores.length > 0) {
        alert('Errores de validación de stock:\n\n' + errores.join('\n'));
        return false;
    }
    
    return true;
}

// Función para limpiar el formulario del modal
function limpiarFormularioCambios() {
    // Limpiar campos de técnico
    document.getElementById('modal_tecnico_seleccionado').value = '';
    document.getElementById('modal_tecnico_display').style.display = 'none';
    document.getElementById('modal_filtroTecnico').value = '';
    document.getElementById('modal_filtroCiudad').value = '';
    
    // Limpiar fecha (establecer fecha actual)
    const fechaInput = document.getElementById('modal_fecha');
    if (fechaInput) {
        const hoy = new Date();
        fechaInput.value = hoy.toISOString().split('T')[0];
    }
    
    // Limpiar todos los campos de elementos
    const elementos = [
        'pantalon', 'camisetagris', 'guerrera', 'camisetapolo',
        'guantes_nitrilo', 'guantes_carnaza', 'gafas', 'gorra', 'casco', 'botas'
    ];
    
    elementos.forEach(elemento => {
        // Limpiar cantidad
        const cantidadInput = document.getElementById(`modal_${elemento}`);
        if (cantidadInput) {
            cantidadInput.value = '';
            cantidadInput.classList.remove('is-invalid');
        }
        
        // Limpiar talla
        const tallaInput = document.getElementById(`modal_talla_${elemento}`);
        if (tallaInput) {
            tallaInput.value = '';
        }
        
        // Resetear estado de valoración
        const estadoCheckbox = document.getElementById(`modal_estado_${elemento === 'camisetagris' ? 'camiseta_gris' : elemento === 'camisetapolo' ? 'camiseta_polo' : elemento}`);
        const estadoLabel = document.getElementById(`modal_label_estado_${elemento === 'camisetagris' ? 'camiseta_gris' : elemento === 'camisetapolo' ? 'camiseta_polo' : elemento}`);
        
        if (estadoCheckbox && estadoLabel) {
            estadoCheckbox.checked = false;
            estadoLabel.innerHTML = '<i class="fas fa-times-circle me-1"></i>NO VALORADO';
            estadoLabel.className = 'form-check-label text-muted';
        }
        
        // Limpiar indicadores de stock
        const stockElement = document.getElementById(`modal_stock_${elemento}`);
        if (stockElement) {
            stockElement.innerHTML = '';
        }
    });
    
    // Limpiar observaciones
    const observacionesInput = document.getElementById('modal_observaciones');
    if (observacionesInput) {
        observacionesInput.value = '';
    }
    
    // Resetear variables de filtrado
    filtroActualCambios = '';
    ciudadSeleccionadaCambios = '';
    paginaActualCambios = 1;
    
    // Cerrar dropdown si está abierto
    const dropdown = document.getElementById('modal_dropdownTecnicos');
    if (dropdown) {
        dropdown.classList.remove('show');
    }
}

// Función para registrar cambio de dotación desde el modal
function registrarCambioDotacion() {
    // Validar que se haya seleccionado un técnico
    const tecnicoSeleccionado = document.getElementById('modal_tecnico_seleccionado').value;
    if (!tecnicoSeleccionado) {
        alert('Por favor seleccione un técnico');
        return;
    }
    
    // Validar stock antes de enviar
    if (!validarFormularioCompletoCambios()) {
        return;
    }
    
    // Recopilar datos del formulario
    const formData = new FormData();
    formData.append('tecnico_cedula', tecnicoSeleccionado);
    formData.append('fecha', document.getElementById('modal_fecha').value);
    
    // Mapeo de elementos
    const elementos = {
        'pantalon': 'Pantalón',
        'camisetagris': 'Camiseta Gris',
        'guerrera': 'Guerrera',
        'camisetapolo': 'Camiseta Polo',
        'guantes_nitrilo': 'Guantes Nitrilo',
        'guantes_carnaza': 'Guantes Carnaza',
        'gafas': 'Gafas',
        'gorra': 'Gorra',
        'casco': 'Casco',
        'botas': 'Botas'
    };
    
    // Agregar elementos con cantidad > 0
    let hayElementos = false;
    Object.keys(elementos).forEach(elemento => {
        const cantidadInput = document.getElementById(`modal_${elemento}`);
        const cantidad = parseInt(cantidadInput?.value) || 0;
        
        if (cantidad > 0) {
            hayElementos = true;
            const estadoCheckbox = document.getElementById(`modal_estado_${elemento === 'camisetagris' ? 'camiseta_gris' : elemento === 'camisetapolo' ? 'camiseta_polo' : elemento}`);
            const tallaInput = document.getElementById(`modal_talla_${elemento}`);
            
            formData.append('elementos[]', JSON.stringify({
                nombre: elementos[elemento],
                cantidad: cantidad,
                talla: tallaInput?.value || '',
                estado: estadoCheckbox?.checked ? 'VALORADO' : 'NO VALORADO'
            }));
        }
    });
    
    if (!hayElementos) {
        alert('Por favor agregue al menos un elemento con cantidad mayor a 0');
        return;
    }
    
    // Agregar observaciones
    const observaciones = document.getElementById('modal_observaciones').value;
    if (observaciones) {
        formData.append('observaciones', observaciones);
    }
    
    // Enviar datos
    fetch('/registrar_cambio_dotacion', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Cambio de dotación registrado exitosamente');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCambiosDotacion'));
            modal.hide();
            
            // Recargar historial
            cargarHistorialCambios();
            
            // Recargar stock
            cargarStockPorEstado();
            cargarStockPorEstadoCambios();
        } else {
            alert('Error al registrar cambio: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión al registrar cambio');
    });
}

// Event listeners para el modal
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para los checkboxes de estado del modal
    const elementosModal = [
        'pantalon', 'camiseta_gris', 'guerrera', 'camiseta_polo',
        'guantes_nitrilo', 'guantes_carnaza', 'gafas', 'gorra', 'casco', 'botas'
    ];
    
    elementosModal.forEach(elemento => {
        const checkbox = document.getElementById(`modal_estado_${elemento}`);
        if (checkbox) {
            checkbox.addEventListener('change', function() {
                toggleEstadoValoradoCambios(elemento);
            });
        }
    });
    
    // Event listeners para validación de stock en tiempo real del modal
    const elementosValidacion = [
        'pantalon', 'camisetagris', 'guerrera', 'camisetapolo',
        'guantes_nitrilo', 'guantes_carnaza', 'gafas', 'gorra', 'casco'
    ];
    
    elementosValidacion.forEach(elemento => {
        const cantidadInput = document.getElementById(`modal_${elemento}`);
        const estadoCheckbox = document.getElementById(`modal_estado_${elemento === 'camisetagris' ? 'camiseta_gris' : elemento === 'camisetapolo' ? 'camiseta_polo' : elemento}`);
        
        if (cantidadInput) {
            cantidadInput.addEventListener('input', function() {
                if (this.value) {
                    validarStockDisponibleCambios(elemento);
                }
            });
        }
        
        if (estadoCheckbox) {
            estadoCheckbox.addEventListener('change', function() {
                const cantidadInput = document.getElementById(`modal_${elemento}`);
                if (cantidadInput && cantidadInput.value) {
                    validarStockDisponibleCambios(elemento);
                }
            });
        }
    });
    
    // Event listener para cerrar dropdown al hacer clic fuera
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('modal_dropdownTecnicos');
        const button = document.querySelector('[onclick="toggleDropdownCambios()"]');
        
        if (dropdown && !dropdown.contains(event.target) && event.target !== button) {
            dropdown.classList.remove('show');
        }
    });
});

</script>
{% endblock %}