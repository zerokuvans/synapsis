{% extends "base.html" %}

{% block title %}Asignaciones{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        margin-bottom: 1.5rem;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0,0,0,.125);
    }
    .form-check {
        padding: 0.5rem;
        border-radius: 0.25rem;
        transition: background-color 0.2s;
    }
    .form-check:hover {
        background-color: #f8f9fa;
    }
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    .modal-lg {
        max-width: 900px;
    }
    .tool-category {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .tool-category h6 {
        color: #0d6efd;
        margin-bottom: 1rem;
        font-weight: 600;
    }
    .signature-pad-container {
        border: 1px solid #ccc;
        border-radius: 5px;
        margin-bottom: 10px;
        width: 100%;
        height: 200px;
        position: relative;
    }
    .signature-pad {
        width: 100%;
        height: 200px;
        background-color: #fff;
        border-radius: 4px;
    }
    .signature-clear-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        z-index: 100;
        background-color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 1px solid #ccc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-tools me-2"></i>Gestión de Asignaciones
        </h1>
        <div>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAsignacion">
                <i class="fas fa-plus me-2"></i>Nueva Asignación
            </button>
            <a href="{{ url_for('exportar_asignaciones_csv') }}" class="btn btn-success ms-2">
                <i class="fas fa-file-csv me-2"></i>Exportar a CSV
            </a>
        </div>
    </div>

    <!-- Tabla de Asignaciones -->
    <div class="card">
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Asignaciones Registradas
                </h5>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover" id="tablaAsignaciones">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Técnico</th>
                            <th>Cédula</th>
                            <th>Cargo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for asignacion in asignaciones %}
                        <tr>
                            <td>{{ asignacion.id_asignacion }}</td>
                            <td>{{ asignacion.asignacion_fecha }}</td>
                            <td>{{ asignacion.nombre }}</td>
                            <td>{{ asignacion.recurso_operativo_cedula }}</td>
                            <td>{{ asignacion.asignacion_cargo }}</td>
                            <td>
                                <span class="badge {% if asignacion.asignacion_estado == '1' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ 'Activo' if asignacion.asignacion_estado == '1' else 'Inactivo' }}
                                </span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-info ver-detalle" data-id="{{ asignacion.id_asignacion }}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Asignación -->
<div class="modal fade" id="modalAsignacion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2"></i>Nueva Asignación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formAsignacion">
                    <!-- Información Básica -->
                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-user me-2"></i>Información Básica
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_codigo_consumidor" class="form-label">
                                        <i class="fas fa-user-tie me-1"></i>Técnico *
                                    </label>
                                    <select class="form-select" id="id_codigo_consumidor" name="id_codigo_consumidor" required>
                                        <option value="">Seleccione...</option>
                                        {% for tecnico in tecnicos %}
                                        <option value="{{ tecnico.id_codigo_consumidor }}">{{ tecnico.nombre }} - {{ tecnico.recurso_operativo_cedula }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="fecha" class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Fecha *
                                    </label>
                                    <input type="datetime-local" class="form-control" id="fecha" name="fecha" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="cargo" class="form-label">
                                        <i class="fas fa-briefcase me-1"></i>Cargo *
                                    </label>
                                    <input type="text" class="form-control" id="cargo" name="cargo" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="imagen" class="form-label">
                                        <i class="fas fa-camera me-1"></i>Imagen de Herramientas
                                    </label>
                                    <input type="file" class="form-control" id="imagen" name="imagen" accept="image/*">
                                    <small class="text-muted">Formato: JPG, PNG. Tamaño máximo: 5MB</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Herramientas Básicas -->
                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-wrench me-2"></i>Herramientas Básicas
                            </h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="seleccionar_todas_herramientas_basicas">
                                <label class="form-check-label" for="seleccionar_todas_herramientas_basicas">
                                    <i class="fas fa-check-double me-1"></i>Seleccionar Todo
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="adaptador_mandril" name="adaptador_mandril" value="1">
                                        <label class="form-check-label" for="adaptador_mandril">
                                            <i class="fas fa-cog me-1"></i>Adaptador Mandril
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="alicate" name="alicate" value="1">
                                        <label class="form-check-label" for="alicate">
                                            <i class="fas fa-tools me-1"></i>Alicate
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="barra_45cm" name="barra_45cm" value="1">
                                        <label class="form-check-label" for="barra_45cm">
                                            <i class="fas fa-ruler me-1"></i>Barra 45cm
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bisturi_metalico" name="bisturi_metalico" value="1">
                                        <label class="form-check-label" for="bisturi_metalico">
                                            <i class="fas fa-cut me-1"></i>Bisturí Metálico
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="caja_de_herramientas" name="caja_de_herramientas" value="1">
                                        <label class="form-check-label" for="caja_de_herramientas">
                                            <i class="fas fa-toolbox me-1"></i>Caja de Herramientas
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="cortafrio" name="cortafrio" value="1">
                                        <label class="form-check-label" for="cortafrio">
                                            <i class="fas fa-hammer me-1"></i>Cortafrío
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="destor_de_estrella" name="destor_de_estrella" value="1">
                                        <label class="form-check-label" for="destor_de_estrella">
                                            <i class="fas fa-screwdriver me-1"></i>Destornillador Estrella
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="destor_de_pala" name="destor_de_pala" value="1">
                                        <label class="form-check-label" for="destor_de_pala">
                                            <i class="fas fa-screwdriver me-1"></i>Destornillador Pala
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="destor_tester" name="destor_tester" value="1">
                                        <label class="form-check-label" for="destor_tester">
                                            <i class="fas fa-screwdriver me-1"></i>Destornillador Tester
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="espatula" name="espatula" value="1">
                                        <label class="form-check-label" for="espatula">
                                            <i class="fas fa-paint-brush me-1"></i>Espátula
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="martillo_de_una" name="martillo_de_una" value="1">
                                        <label class="form-check-label" for="martillo_de_una">
                                            <i class="fas fa-hammer me-1"></i>Martillo de Uña
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="pinza_de_punta" name="pinza_de_punta" value="1">
                                        <label class="form-check-label" for="pinza_de_punta">
                                            <i class="fas fa-tools me-1"></i>Pinza de Punta
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Brocas -->
                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-drill me-2"></i>Brocas
                            </h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="seleccionar_todas_brocas">
                                <label class="form-check-label" for="seleccionar_todas_brocas">
                                    <i class="fas fa-check-double me-1"></i>Seleccionar Todo
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="asignacion_broca_38" name="broca_3_8" value="1">
                                        <label class="form-check-label" for="broca_3_8">
                                            <i class="fas fa-circle me-1"></i>Broca 3/8
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="asignacion_broca_386_ran" name="broca_386_ran" value="1">
                                        <label class="form-check-label" for="broca_386_ran">
                                            <i class="fas fa-circle me-1"></i>Broca 3/8 6 Ran
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="asignacion_broca_126_ran" name="broca_126_ran" value="1">
                                        <label class="form-check-label" for="broca_126_ran">
                                            <i class="fas fa-circle me-1"></i>Broca 1/2 6 Ran
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="asignacion_broca_metalmadera_14" name="broca_metalmadera_14" value="1">
                                        <label class="form-check-label" for="broca_metalmadera_14">
                                            <i class="fas fa-circle me-1"></i>Broca Metal/Madera 1/4
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="asignacion_broca_metalmadera_38" name="broca_metalmadera_38" value="1">
                                        <label class="form-check-label" for="broca_metalmadera_38">
                                            <i class="fas fa-circle me-1"></i>Broca Metal/Madera 3/8
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="asignacion_broca_metalmadera_516" name="broca_metalmadera_516" value="1">
                                        <label class="form-check-label" for="broca_metalmadera_516">
                                            <i class="fas fa-circle me-1"></i>Broca Metal/Madera 5/16
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Herramientas de Red -->
                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-network-wired me-2"></i>Herramientas de Red
                            </h6>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="seleccionar_todas_herramientas_red">
                                <label class="form-check-label" for="seleccionar_todas_herramientas_red">
                                    <i class="fas fa-check-double me-1"></i>Seleccionar Todo
                                </label>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="cajon_rojo" name="cajon_rojo" value="1">
                                        <label class="form-check-label" for="cajon_rojo">
                                            <i class="fas fa-box me-1"></i>Cajón Rojo
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="cinta_de_senal" name="cinta_de_senal" value="1">
                                        <label class="form-check-label" for="cinta_de_senal">
                                            <i class="fas fa-tape me-1"></i>Cinta de Señal
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="cono_retractil" name="cono_retractil" value="1">
                                        <label class="form-check-label" for="cono_retractil">
                                            <i class="fas fa-triangle-exclamation me-1"></i>Cono Retráctil
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="exten_de_corr_10_mts" name="exten_de_corr_10_mts" value="1">
                                        <label class="form-check-label" for="exten_de_corr_10_mts">
                                            <i class="fas fa-plug me-1"></i>Extensión de Corriente 10mts
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="llave_locking_male" name="llave_locking_male" value="1">
                                        <label class="form-check-label" for="llave_locking_male">
                                            <i class="fas fa-key me-1"></i>Llave Locking Male
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="llave_reliance" name="llave_reliance" value="1">
                                        <label class="form-check-label" for="llave_reliance">
                                            <i class="fas fa-key me-1"></i>Llave Reliance
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="llave_torque_rg_11" name="llave_torque_rg_11" value="1">
                                        <label class="form-check-label" for="llave_torque_rg_11">
                                            <i class="fas fa-key me-1"></i>Llave Torque RG11
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="llave_torque_rg_6" name="llave_torque_rg_6" value="1">
                                        <label class="form-check-label" for="llave_torque_rg_6">
                                            <i class="fas fa-key me-1"></i>Llave Torque RG6
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="llaves_mandril" name="llaves_mandril" value="1">
                                        <label class="form-check-label" for="llaves_mandril">
                                            <i class="fas fa-key me-1"></i>Llaves Mandril
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="mandril_para_taladro" name="mandril_para_taladro" value="1">
                                        <label class="form-check-label" for="mandril_para_taladro">
                                            <i class="fas fa-cog me-1"></i>Mandril para Taladro
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="pelacable_rg_6y_rg_11" name="pelacable_rg_6y_rg_11" value="1">
                                        <label class="form-check-label" for="pelacable_rg_6y_rg_11">
                                            <i class="fas fa-cut me-1"></i>Pelacable RG6/RG11
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="pistola_de_silicona" name="pistola_de_silicona" value="1">
                                        <label class="form-check-label" for="pistola_de_silicona">
                                            <i class="fas fa-gun me-1"></i>Pistola de Silicona
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="planillero" name="planillero" value="1">
                                        <label class="form-check-label" for="planillero">
                                            <i class="fas fa-clipboard me-1"></i>Planillero
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ponchadora_rg_6_y_rg_11" name="ponchadora_rg_6_y_rg_11" value="1">
                                        <label class="form-check-label" for="ponchadora_rg_6_y_rg_11">
                                            <i class="fas fa-network-wired me-1"></i>Ponchadora RG6/RG11
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="ponchadora_rj_45_y_rj11" name="ponchadora_rj_45_y_rj11" value="1">
                                        <label class="form-check-label" for="ponchadora_rj_45_y_rj11">
                                            <i class="fas fa-network-wired me-1"></i>Ponchadora RJ45/RJ11
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="probador_de_tonos" name="probador_de_tonos" value="1">
                                        <label class="form-check-label" for="probador_de_tonos">
                                            <i class="fas fa-wave-square me-1"></i>Probador de Tonos
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="probador_de_tonos_utp" name="probador_de_tonos_utp" value="1">
                                        <label class="form-check-label" for="probador_de_tonos_utp">
                                            <i class="fas fa-wave-square me-1"></i>Probador de Tonos UTP
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="puntas_para_multimetro" name="puntas_para_multimetro" value="1">
                                        <label class="form-check-label" for="puntas_para_multimetro">
                                            <i class="fas fa-bolt me-1"></i>Puntas para Multímetro
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="sonda_metalica" name="sonda_metalica" value="1">
                                        <label class="form-check-label" for="sonda_metalica">
                                            <i class="fas fa-probe me-1"></i>Sonda Metálica
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="tacos_de_madera" name="tacos_de_madera" value="1">
                                        <label class="form-check-label" for="tacos_de_madera">
                                            <i class="fas fa-cube me-1"></i>Tacos de Madera
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="telefono_de_pruebas" name="telefono_de_pruebas" value="1">
                                        <label class="form-check-label" for="telefono_de_pruebas">
                                            <i class="fas fa-phone me-1"></i>Teléfono de Pruebas
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="power_miter" name="power_miter" value="1">
                                        <label class="form-check-label" for="power_miter">
                                            <i class="fas fa-bolt me-1"></i>Power Meter
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="bfl_laser" name="bfl_laser" value="1">
                                        <label class="form-check-label" for="bfl_laser">
                                            <i class="fas fa-laser me-1"></i>BFL Laser
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="cortadora" name="cortadora" value="1">
                                        <label class="form-check-label" for="cortadora">
                                            <i class="fas fa-cut me-1"></i>Cortadora
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="stripper_fibra" name="stripper_fibra" value="1">
                                        <label class="form-check-label" for="stripper_fibra">
                                            <i class="fas fa-cut me-1"></i>Stripper Fibra
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="pelachaqueta" name="pelachaqueta" value="1">
                                        <label class="form-check-label" for="pelachaqueta">
                                            <i class="fas fa-cut me-1"></i>Pelachaqueta
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="guardarAsignacionSimple()">
                    <i class="fas fa-save me-2"></i>Guardar Solo Datos Básicos
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarAsignacion()">
                    <i class="fas fa-save me-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalle -->
<div class="modal fade" id="modalDetalle" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Detalle de Asignación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalleContenido"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Signature Pad -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.6/dist/signature_pad.umd.min.js"></script>

<script>
$(document).ready(function() {
    // Inicializar DataTable con configuración en español
    $('#tablaAsignaciones').DataTable({
        language: {
            "sProcessing":     "Procesando...",
            "sLengthMenu":     "Mostrar _MENU_ registros",
            "sZeroRecords":    "No se encontraron resultados",
            "sEmptyTable":     "Ningún dato disponible en esta tabla",
            "sInfo":           "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
            "sInfoEmpty":      "Mostrando registros del 0 al 0 de un total de 0 registros",
            "sInfoFiltered":   "(filtrado de un total de _MAX_ registros)",
            "sInfoPostFix":    "",
            "sSearch":         "Buscar:",
            "sUrl":            "",
            "sInfoThousands":  ",",
            "sLoadingRecords": "Cargando...",
            "oPaginate": {
                "sFirst":    "Primero",
                "sLast":     "Último",
                "sNext":     "Siguiente",
                "sPrevious": "Anterior"
            },
            "oAria": {
                "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
                "sSortDescending": ": Activar para ordenar la columna de manera descendente"
            }
        },
        order: [[1, 'desc']], // Ordenar por fecha descendente
        pageLength: 10
    });

    // Establecer fecha y hora actual por defecto
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('fecha').value = now.toISOString().slice(0,16);
    
    // Evento para obtener el cargo del técnico cuando se selecciona
    $('#id_codigo_consumidor').on('change', function() {
        const tecnicoId = $(this).val();
        if (tecnicoId) {
            // Obtener el cargo del técnico desde la lista de técnicos
            {% for tecnico in tecnicos %}
            if (tecnicoId === "{{ tecnico.id_codigo_consumidor }}") {
                // Establecer el cargo automáticamente
                $('#cargo').val("{{ tecnico.cargo }}");
                console.log("Cargo establecido automáticamente: {{ tecnico.cargo }}");
            }
            {% endfor %}
        } else {
            // Limpiar el campo cargo si no hay técnico seleccionado
            $('#cargo').val('');
        }
    });
    
    // Funcionalidad de seleccionar todas las herramientas básicas
    $('#seleccionar_todas_herramientas_basicas').on('change', function() {
        const isChecked = $(this).prop('checked');
        // Seleccionar o deseleccionar todos los checkboxes de herramientas básicas
        $('.card:contains("Herramientas Básicas") .form-check-input').not(this).prop('checked', isChecked);
        console.log('Herramientas Básicas - Seleccionar todo:', isChecked);
    });
    
    // Funcionalidad de seleccionar todas las brocas
    $('#seleccionar_todas_brocas').on('change', function() {
        const isChecked = $(this).prop('checked');
        // Seleccionar o deseleccionar todos los checkboxes de brocas
        $('.card:contains("Brocas") .form-check-input').not(this).prop('checked', isChecked);
        console.log('Brocas - Seleccionar todo:', isChecked);
    });
    
    // Funcionalidad de seleccionar todas las herramientas de red
    $('#seleccionar_todas_herramientas_red').on('change', function() {
        const isChecked = $(this).prop('checked');
        // Seleccionar o deseleccionar todos los checkboxes de herramientas de red
        $('.card:contains("Herramientas de Red") .form-check-input').not(this).prop('checked', isChecked);
        console.log('Herramientas de Red - Seleccionar todo:', isChecked);
    });
});

// Mapeo de nombres problemáticos a nombres seguros para SQL
const mapeoNombresHerramientas = {};  // Objeto vacío ya que no necesitamos mapeos especiales

// Función mejorada para guardar asignación con mejor manejo de errores
function guardarAsignacion() {
    // Obtener y validar el formulario
    const form = document.getElementById('formAsignacion');
    const camposRequeridos = ['id_codigo_consumidor', 'fecha', 'cargo'];
    
    for (const campo of camposRequeridos) {
        if (!form.elements[campo].value.trim()) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo requerido',
                text: `Por favor complete el campo ${campo.replace('_', ' ')}`
            });
            form.elements[campo].focus();
            return;
        }
    }
    
    // Validar tamaño de imagen si se seleccionó una
    const imagenInput = document.getElementById('imagen');
    if (imagenInput.files.length > 0) {
        const file = imagenInput.files[0];
        if (file.size > 5 * 1024 * 1024) { // 5MB
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'La imagen no debe superar los 5MB'
            });
            return;
        }
    }
    
    // Mostrar indicador de carga
    Swal.fire({
        title: 'Guardando...',
        text: 'Procesando la asignación, por favor espere',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // Crear FormData con datos básicos
    const formData = new FormData();
    formData.append('id_codigo_consumidor', form.elements['id_codigo_consumidor'].value);
    formData.append('fecha', form.elements['fecha'].value);
    formData.append('cargo', form.elements['cargo'].value);
    
    // Agregar imagen si se seleccionó una
    if (imagenInput.files.length > 0) {
        formData.append('imagen', imagenInput.files[0]);
    }
    
    // Agregar herramientas seleccionadas
    const checkboxes = form.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        formData.append(checkbox.name, checkbox.checked ? '1' : '0');
    });
    
    // Log para depuración
    console.log('Enviando datos de asignación:', {
        id_codigo_consumidor: form.elements['id_codigo_consumidor'].value,
        fecha: form.elements['fecha'].value,
        cargo: form.elements['cargo'].value,
        herramientas_seleccionadas: Array.from(checkboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.name)
    });
    
    // Enviar datos al servidor con mejor manejo de errores 500
    fetch('/logistica/guardar_asignacion', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // Intentar extraer más información de los errores
        if (!response.ok) {
            return response.text().then(errorText => {
                let errorInfo = errorText;
                try {
                    // Intentar parsear como JSON
                    const errorData = JSON.parse(errorText);
                    errorInfo = errorData.message || errorText;
                } catch (e) {
                    // Si no es JSON, usar el texto como está
                    console.warn('Respuesta no es JSON:', errorText);
                }
                
                // Lanzar error con información detallada
                throw new Error(`${response.status} - ${errorInfo}`);
            });
        }
        
        return response.json();
    })
    .then(data => {
        Swal.close();
        
        // Verificar si fue exitoso
        if (data.status === 'success') {
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: data.message || 'Asignación guardada correctamente',
                confirmButtonText: 'Aceptar'
            }).then(() => {
                // Cerrar modal y recargar página
                try {
                    bootstrap.Modal.getInstance(document.getElementById('modalAsignacion')).hide();
                } catch (e) {
                    $('#modalAsignacion').modal('hide');
                }
                
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            });
        } else {
            // Mostrar mensaje de error
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'Error al guardar la asignación'
            });
        }
    })
    .catch(error => {
        console.error('Error en la petición:', error);
        Swal.close();
        
        // Mensaje específico para diferentes tipos de errores
        const errorMsg = error.message || 'Error desconocido';
        
        if (errorMsg.includes('mysql') && errorMsg.includes('connection')) {
            Swal.fire({
                icon: 'error',
                title: 'Error de Base de Datos',
                html: `
                    <div class="text-left">
                        <p>Hay un problema con la conexión a la base de datos:</p>
                        <p>${errorMsg}</p>
                        <p>Posibles soluciones:</p>
                        <ul>
                            <li>Verifique que el servicio MySQL esté activo</li>
                            <li>Contacte al administrador del sistema</li>
                        </ul>
                    </div>
                `,
                footer: '<div class="text-muted">El sistema intentará usar un método alternativo de guardado</div>',
                confirmButtonText: 'Usar método alternativo',
                showCancelButton: true,
                cancelButtonText: 'Cancelar',
                cancelButtonColor: '#d33'
            }).then((result) => {
                if (result.isConfirmed) {
                    guardarAsignacionSimple();
                }
            });
        } else if (errorMsg.includes('500')) {
            // Ofrecemos opciones para el error 500
            Swal.fire({
                icon: 'error',
                title: 'Error en el Servidor',
                html: `
                    <div class="text-left">
                        <p>Ha ocurrido un error interno en el servidor:</p>
                        <p>${errorMsg}</p>
                        <p>Opciones para resolver el problema:</p>
                        <ul>
                            <li>Verifique la conexión a la base de datos</li>
                            <li>Compruebe que todos los campos tengan el formato correcto</li>
                            <li>Intente con menos herramientas seleccionadas</li>
                        </ul>
                    </div>
                `,
                confirmButtonText: 'Intentar nuevamente',
                showCancelButton: true,
                cancelButtonText: 'Usar método alternativo',
                cancelButtonColor: '#f0ad4e'
            }).then((result) => {
                if (result.dismiss === Swal.DismissReason.cancel) {
                    guardarAsignacionSimple();
                }
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ha ocurrido un error: ' + errorMsg
            });
        }
    });
}

// Función para guardar asignación con herramientas (versión mejorada)
function guardarAsignacionSimple() {
    // Obtener y validar el formulario
    const form = document.getElementById('formAsignacion');
    const camposRequeridos = ['id_codigo_consumidor', 'fecha', 'cargo'];
    
    for (const campo of camposRequeridos) {
        if (!form.elements[campo].value.trim()) {
            Swal.fire({
                icon: 'warning',
                title: 'Campo requerido',
                text: `Por favor complete el campo ${campo.replace('_', ' ')}`
            });
            form.elements[campo].focus();
            return;
        }
    }
    
    // Mostrar indicador de carga
    Swal.fire({
        title: 'Guardando asignación...',
        text: 'Procesando la asignación con herramientas',
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });

    // Crear FormData con datos básicos
    const formData = new FormData();
    formData.append('id_codigo_consumidor', form.elements['id_codigo_consumidor'].value);
    formData.append('fecha', form.elements['fecha'].value);
    formData.append('cargo', form.elements['cargo'].value);
    
    // Agregar herramientas seleccionadas
    const checkboxes = form.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        // Solo incluir los checkboxes de herramientas (no los de seleccionar todo)
        if (checkbox.id !== 'seleccionar_todas_herramientas_basicas' && 
            checkbox.id !== 'seleccionar_todas_brocas' && 
            checkbox.id !== 'seleccionar_todas_herramientas_red') {
            formData.append(checkbox.name, checkbox.checked ? '1' : '0');
        }
    });
    
    // Log para depuración
    console.log('Enviando datos de asignación simple:', {
        id_codigo_consumidor: form.elements['id_codigo_consumidor'].value,
        fecha: form.elements['fecha'].value,
        cargo: form.elements['cargo'].value,
        herramientas_seleccionadas: Array.from(checkboxes)
            .filter(cb => cb.checked && 
                    cb.id !== 'seleccionar_todas_herramientas_basicas' && 
                    cb.id !== 'seleccionar_todas_brocas' && 
                    cb.id !== 'seleccionar_todas_herramientas_red')
            .map(cb => cb.name)
    });
    
    // Endpoint para guardado simple
    fetch('/logistica/guardar_asignacion_simple', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 404) {
                // Si el endpoint simple no existe, usar el original
                return fetch('/logistica/guardar_asignacion', {
                    method: 'POST',
                    body: formData
                });
            }
            throw new Error(`Error en la solicitud: ${response.status}`);
        }
        return response.text();
    })
    .then(responseText => {
        Swal.close();
        
        let data;
        try {
            data = JSON.parse(responseText);
        } catch (e) {
            data = responseText;
        }
        
        if ((typeof data === 'object' && (data.status === 'success' || data.success === true)) || 
            (typeof data === 'string' && (data.includes('success') || data.includes('éxito')))) {
            
            Swal.fire({
                icon: 'success',
                title: 'Asignación guardada',
                text: 'Se guardó la asignación con las herramientas seleccionadas',
                confirmButtonText: 'Aceptar'
            }).then(() => {
                try {
                    bootstrap.Modal.getInstance(document.getElementById('modalAsignacion')).hide();
                } catch (e) {
                    $('#modalAsignacion').modal('hide');
                }
                
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            });
        } else {
            let mensaje = 'Error al guardar la asignación';
            if (typeof data === 'object' && data.message) {
                mensaje = data.message;
            } else if (typeof data === 'string' && data.length > 0) {
                mensaje = data;
            }
            
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: mensaje
            });
        }
    })
    .catch(error => {
        console.error('Error en la petición simple:', error);
        Swal.close();
        
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Ha ocurrido un error al guardar la asignación: ' + error.message
        });
    });
}

// Función simplificada para ver detalles
function verDetalle(id) {
    fetch(`/logistica/asignacion/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const detalles = data.data;
                
                let html = `
                    <div class="card mb-3">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="fas fa-user me-2"></i>Información del Técnico
                            </h6>
                            <div>
                                <button class="btn btn-sm btn-success me-2" onclick="firmarAsignacion(${id})">
                                    <i class="fas fa-signature me-1"></i>Firmar digitalmente
                                </button>
                                <a href="/logistica/asignacion/${id}/pdf?firmado=true" class="btn btn-sm btn-primary" target="_blank">
                                    <i class="fas fa-file-pdf me-1"></i>Descargar PDF
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong><i class="fas fa-user-tie me-2"></i>Técnico:</strong> ${detalles.info_basica.tecnico}</p>
                                    <p><strong><i class="fas fa-id-card me-2"></i>Cédula:</strong> ${detalles.info_basica.cedula}</p>
                                    <p><strong><i class="fas fa-briefcase me-2"></i>Cargo:</strong> ${detalles.info_basica.cargo}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong><i class="fas fa-calendar me-2"></i>Fecha:</strong> ${detalles.info_basica.fecha}</p>
                                    <p><strong><i class="fas fa-circle-check me-2"></i>Estado:</strong> ${detalles.info_basica.estado}</p>
                                    ${detalles.info_basica.imagen ? `
                                    <div class="mt-3">
                                        <p><strong><i class="fas fa-camera me-2"></i>Imagen de Herramientas:</strong></p>
                                        <img src="${detalles.info_basica.imagen}" class="img-fluid rounded" 
                                             alt="Imagen de herramientas" style="max-height: 200px;">
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Herramientas Básicas
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-wrench me-2"></i>Herramientas Básicas
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                `;
                for (const [herramienta, valor] of Object.entries(detalles.herramientas_basicas)) {
                    if (valor === '1') {
                        html += `
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" disabled checked>
                                    <label class="form-check-label">
                                        <i class="fas fa-tools me-1"></i>${herramienta.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                    </label>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `
                            </div>
                        </div>
                    </div>
                `;

                // Brocas
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-drill me-2"></i>Brocas
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                `;
                for (const [broca, valor] of Object.entries(detalles.brocas)) {
                    if (valor === '1') {
                        html += `
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" disabled checked>
                                    <label class="form-check-label">
                                        <i class="fas fa-circle me-1"></i>${broca.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                    </label>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `
                            </div>
                        </div>
                    </div>
                `;

                // Herramientas de Red
                html += `
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">
                                <i class="fas fa-network-wired me-2"></i>Herramientas de Red
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                `;
                for (const [herramienta, valor] of Object.entries(detalles.herramientas_red)) {
                    if (valor === '1') {
                        html += `
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" disabled checked>
                                    <label class="form-check-label">
                                        <i class="fas fa-network-wired me-1"></i>${herramienta.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                    </label>
                                </div>
                            </div>
                        `;
                    }
                }
                html += `
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('detalleContenido').innerHTML = html;
                $('#modalDetalle').modal('show');
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'No se pudieron cargar los detalles'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Ha ocurrido un error al cargar los detalles'
            });
        });
}

// Función para firmar digitalmente la asignación
function firmarAsignacion(id) {
    // Modal personalizado con canvas para firma
    Swal.fire({
        title: 'Firma Digital',
        html: `
            <div class="text-left mb-3">
                <p>Por favor dibuje su firma a continuación:</p>
                <div class="signature-pad-container">
                    <div class="signature-clear-btn" id="clear-signature">
                        <i class="fas fa-eraser"></i>
                    </div>
                    <canvas id="signature-pad" class="signature-pad"></canvas>
                </div>
                <div class="form-check mt-2">
                    <input class="form-check-input" type="checkbox" id="confirmar-firma">
                    <label class="form-check-label" for="confirmar-firma">
                        Confirmo que esta firma me representa legalmente
                    </label>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Firmar Documento',
        cancelButtonText: 'Cancelar',
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        didOpen: () => {
            // Inicializar signature pad
            const canvas = document.getElementById('signature-pad');
            const signaturePad = new SignaturePad(canvas, {
                backgroundColor: 'rgba(255, 255, 255, 0)',
                penColor: 'rgb(0, 0, 0)'
            });
            
            // Guardar referencia global temporal para usarla en preConfirm
            window.tempSignaturePad = signaturePad;
            
            // Ajustar tamaño del canvas
            function resizeCanvas() {
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                canvas.width = canvas.offsetWidth * ratio;
                canvas.height = canvas.offsetHeight * ratio;
                canvas.getContext("2d").scale(ratio, ratio);
                signaturePad.clear(); // Limpiar canvas
            }
            
            window.onresize = resizeCanvas;
            resizeCanvas();
            
            // Botón para limpiar firma
            document.getElementById('clear-signature').addEventListener('click', () => {
                signaturePad.clear();
            });
            
            // Deshabilitar botón de confirmación si no hay firma
            const confirmBtn = Swal.getConfirmButton();
            confirmBtn.disabled = true;
            
            // Habilitar botón cuando se dibuja y se marca la confirmación
            const checkConfirm = document.getElementById('confirmar-firma');
            
            checkConfirm.addEventListener('change', () => {
                confirmBtn.disabled = signaturePad.isEmpty() || !checkConfirm.checked;
            });
            
            signaturePad.addEventListener('endStroke', () => {
                confirmBtn.disabled = signaturePad.isEmpty() || !checkConfirm.checked;
            });
        },
        preConfirm: () => {
            // Usar la referencia global temporal
            const signaturePad = window.tempSignaturePad;
            
            if (signaturePad.isEmpty()) {
                Swal.showValidationMessage('Por favor dibuje su firma');
                return false;
            }
            
            if (!document.getElementById('confirmar-firma').checked) {
                Swal.showValidationMessage('Debe confirmar que la firma es suya');
                return false;
            }
            
            // Obtener la firma como imagen base64
            const signatureData = signaturePad.toDataURL('image/png');
            // Limpiar la referencia temporal
            window.tempSignaturePad = null;
            return signatureData;
        }
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            const signatureData = result.value;
            
            // Mostrar indicador de carga
            Swal.fire({
                title: 'Procesando firma...',
                text: 'Espere mientras se firma el documento',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Enviar la firma al servidor
            fetch(`/logistica/asignacion/${id}/firmar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    signature: signatureData
                })
            })
            .then(response => response.json())
            .then(data => {
                Swal.close();
                
                if (data.status === 'success') {
                    Swal.fire({
                        icon: 'success',
                        title: 'Documento firmado',
                        text: 'El documento ha sido firmado con éxito',
                        confirmButtonText: 'Descargar documento firmado'
                    }).then(() => {
                        // Abrir el PDF firmado en una nueva pestaña
                        window.open(data.url_pdf, '_blank');
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'No se pudo firmar el documento'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.close();
                
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ha ocurrido un error al procesar la firma digital'
                });
            });
        }
    });
}

// Agregar el siguiente código después de $(document).ready
$(document).on('click', '.ver-detalle', function() {
    const id = $(this).data('id');
    verDetalle(id);
});
</script>
{% endblock %}