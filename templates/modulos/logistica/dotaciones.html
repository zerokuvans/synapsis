{% extends "base.html" %}

{% block title %}Gestión de Dotaciones{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
<style>
    .card-header {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
        color: white;
    }
    .btn-primary {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
    }
    .stats-card {
        border-left: 4px solid #3583E8;
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }
    .modal-header {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
        color: white;
    }
    .form-control:focus {
        border-color: #3583E8;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    .badge-asignado {
        background-color: #28a745;
    }
    .badge-disponible {
        background-color: #17a2b8;
    }
    .badge-mantenimiento {
        background-color: #ffc107;
        color: #000;
    }
    .badge-baja {
        background-color: #dc3545;
    }
    .estado-normal {
        background-color: #28a745;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .estado-stock-bajo {
        background-color: #dc3545;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .estado-sin-stock {
        background-color: #6c757d;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    #tablaStock {
        margin-bottom: 0;
    }
    #tablaStock th {
        border-top: none;
        font-weight: 600;
        font-size: 0.9rem;
    }
    #tablaStock td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    /* Estilos para checkboxes de estado */
    .form-check-input[type="checkbox"] {
        width: 20px;
        height: 20px;
        border: 2px solid #6c757d;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .form-check-input[type="checkbox"]:checked {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .form-check-input[type="checkbox"]:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        outline: none;
    }
    
    .form-check-input[type="checkbox"]:hover {
        border-color: #007bff;
    }
    
    .form-check-label {
        cursor: pointer;
        user-select: none;
        margin-left: 8px;
        font-weight: 500;
    }
    
    .valorado-text {
            color: #28a745;
            font-weight: bold;
        }
        
        .no-valorado-text {
            color: #dc3545;
            font-weight: bold;
        }
        
        /* Estilos para vista visual */
        .vista-visual {
            display: none;
        }
        
        .tecnico-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .tecnico-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .tecnico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .tecnico-nombre {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }
        
        .tecnico-cliente {
            font-size: 0.9rem;
            color: #666;
            background: #f8f9fa;
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .elementos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .elemento-grupo {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
        }
        
        .elemento-titulo {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        /* Estilos para botones deshabilitados por firma */
        .btn.disabled {
            pointer-events: none;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }
        
        .btn-outline-secondary.disabled {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #6c757d;
        }
        
        .btn-outline-secondary.disabled:hover {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #6c757d;
        }
            text-transform: uppercase;
        }
        
        .elemento-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 3px 0;
        }
        
        .elemento-icono {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .elemento-info {
            flex: 1;
            font-size: 0.85rem;
        }
        
        .elemento-cantidad {
            font-weight: bold;
            color: #007bff;
        }
        
        .elemento-talla {
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .elemento-estado {
            margin-left: 5px;
        }
        
        .badge-valorado {
            background-color: #28a745;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .badge-no-valorado {
            background-color: #dc3545;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .sin-elementos {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
        
        .toggle-vista {
            margin-bottom: 15px;
        }
        
        .btn-vista {
            margin-right: 10px;
        }
        
        .btn-vista.active {
            background-color: #007bff;
            color: white;
        }
</style>
{% endblock %}

{% block content %}

    <div class="container-fluid mt-4">
        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Total Dotaciones</h6>
                                <h3 class="mb-0" id="totalDotaciones">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-boxes fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Asignadas</h6>
                                <h3 class="mb-0 text-success" id="dotacionesAsignadas">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-user-check fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Disponibles</h6>
                                <h3 class="mb-0 text-info" id="dotacionesDisponibles">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-warehouse fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">En Mantenimiento</h6>
                                <h3 class="mb-0 text-warning" id="dotacionesMantenimiento">0</h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-tools fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráficos -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Histórico de Movimientos
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtros para la gráfica -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="filtroRopaTrabajo" class="form-label">Ropa de Trabajo:</label>
                                <select id="filtroRopaTrabajo" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="pantalon">Pantalón</option>
                                    <option value="camisetagris">Camiseta Gris</option>
                                    <option value="guerrera">Guerrera</option>
                                    <option value="camisetapolo">Camiseta Polo</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filtroEPP" class="form-label">EPP:</label>
                                <select id="filtroEPP" class="form-select">
                                    <option value="">Todos</option>
                                    <option value="guantesnitrilo">Guantes Nitrilo</option>
                                    <option value="guantescarnaza">Guantes Carnaza</option>
                                    <option value="gafas">Gafas</option>
                                    <option value="gorra">Gorra</option>
                                    <option value="casco">Casco</option>
                                    <option value="botas">Botas</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filtroMes" class="form-label">Filtrar por Mes:</label>
                                <select id="filtroMes" class="form-select">
                                    <option value="">Todos los meses</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="filtroAño" class="form-label">Año:</label>
                                <select id="filtroAño" class="form-select">
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                        </div>
                        
                        <div class="chart-container">
                            <canvas id="movimientosChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Stock -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Estado de Stock
                </h5>
            </div>
            <div class="card-body">
                <!-- Filtro por tipo de dotación -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Filtrar por Tipo:</label>
                        <select class="form-select" id="filtroTipoStock" onchange="filtrarStock()">
                            <option value="">Todos los tipos</option>
                            <option value="pantalon">Pantalón</option>
                            <option value="camisetagris">Camiseta Gris</option>
                            <option value="guerrera">Guerrera</option>
                            <option value="camisetapolo">Camiseta Polo</option>
                            <option value="guantes">Guantes</option>
                            <option value="epp">EPP</option>
                            <option value="botas">Botas</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Estado:</label>
                        <select class="form-select" id="filtroEstadoStock" onchange="filtrarStock()">
                            <option value="">Todos los estados</option>
                            <option value="normal">Normal</option>
                            <option value="stock-bajo">Stock Bajo</option>
                            <option value="sin-stock">Sin Stock</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-secondary me-2" onclick="limpiarFiltrosStock()">
                                <i class="fas fa-times me-1"></i>
                                Limpiar Filtros
                            </button>
                            <button class="btn btn-primary" onclick="refreshStock()" id="btnRefreshStock">
                                <i class="fas fa-sync-alt me-1"></i>
                                Actualizar Stock
                            </button>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tablaStock">
                        <thead class="table-dark">
                            <tr>
                                <th>Material</th>
                                <th>Stock Actual</th>
                                <th>Stock Mínimo</th>
                                <th>Disponibilidad por Tallas</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tabla de Dotaciones -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>
                    Gestión de Dotaciones
                </h5>
                <div>
                    <!-- Botones de vista 
                    <div class="btn-group me-3" role="group">
                        <button type="button" class="btn btn-outline-primary view-toggle active" id="btnVistaTabla" onclick="cambiarVista('tabla')">
                            <i class="fas fa-table me-1"></i>
                            Tabla
                        </button>
                        <button type="button" class="btn btn-outline-primary view-toggle" id="btnVistaVisual" onclick="cambiarVista('visual')">
                            <i class="fas fa-th-large me-1"></i>
                            Visual
                        </button>
                    </div>
                    -->
                    <button class="btn btn-success me-2" onclick="abrirModalIngreso()">
                        <i class="fas fa-box me-1"></i>
                        Registrar Ingreso
                    </button>

                    <button class="btn btn-light" onclick="nuevaDotacion()">
                        <i class="fas fa-plus me-1"></i>
                        Nueva Dotación
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Filtrar por Cliente:</label>
                        <select class="form-select" id="filtroCliente" onchange="actualizarFiltrosPorCliente()">
                            <option value="">Todos los clientes</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Estado Técnico:</label>
                        <select class="form-select" id="filtroEstadoTecnico" onchange="actualizarFiltroTecnicos()">
                            <option value="Activo">Activos</option>
                            <option value="Inactivo">Inactivos</option>
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Filtrar por Técnico:</label>
                        <select class="form-select" id="filtroTecnico" onchange="filtrarDotaciones()">
                            <option value="">Todos los técnicos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Buscar:</label>
                        <input type="text" class="form-control" id="buscarDotacion" placeholder="Buscar dotación..." onkeyup="filtrarDotaciones()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button class="btn btn-outline-primary" onclick="exportarDatos()">
                                <i class="fas fa-download me-1"></i>
                                Exportar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Vista Visual -->
                <div id="vistaVisual" class="visual-view" style="display: none;">
                    <div id="contenedorTecnicos" class="technician-grid">
                        <!-- Los técnicos se cargarán dinámicamente aquí -->
                    </div>
                </div>

                <!-- Tabla -->
                <div id="vistaTabla" class="table-responsive">
                    <table id="tablaDotaciones" class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Técnico</th>
                                <th>Estado de Formularios</th>
                                <th>Fecha de Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se cargarán dinámicamente -->
                        </tbody>
                    </table>
                </div>

                <!-- Contenedor de Tarjetas Móviles -->
                <div class="mobile-cards-container" style="display: none;">
                    <!-- Las tarjetas se cargarán dinámicamente aquí -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva/Editar Dotación -->
    <div class="modal fade" id="modalDotacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitulo">
                        <i class="fas fa-plus me-2"></i>
                        Nueva Dotación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formDotacion">
                        <input type="hidden" id="idDotacion">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Cliente *</label>
                                    <select class="form-control" id="cliente" required>
                                        <option value="">Seleccionar cliente...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Técnico *</label>
                                    <select class="form-select" id="idCodigoConsumidor" required>
                                        <option value="">Seleccionar técnico...</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-3 text-primary">Ropa de Trabajo</h6>
                        
                        <!-- Pantalón -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Pantalón</label>
                                <input type="number" class="form-control" id="pantalon" min="0" oninput="validarStockDisponible('pantalon')">
                                <small class="text-muted" id="stockPantalon">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Talla Pantalón</label>
                                <select class="form-select" id="pantalonTalla">
                                    <option value="">Seleccionar...</option>
                                    <option value="28">28</option>
                                    <option value="30">30</option>
                                    <option value="32">32</option>
                                    <option value="34">34</option>
                                    <option value="36">36</option>
                                    <option value="38">38</option>
                                    <option value="40">40</option>
                                    <option value="42">42</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado Pantalón</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoPantalon" checked>
                                    <label class="form-check-label valorado-text" for="estadoPantalon">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Camiseta Gris -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Camiseta Gris</label>
                                <input type="number" class="form-control" id="camisetagris" min="0" oninput="validarStockDisponible('camisetagris')">
                                <small class="text-muted" id="stockCamisetagris">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Talla Camiseta Gris</label>
                                <select class="form-select" id="camisetaGrisTalla">
                                    <option value="">Seleccionar...</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado Camiseta Gris</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoCamisetaGris" checked>
                                    <label class="form-check-label valorado-text" for="estadoCamisetaGris">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Guerrera -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Guerrera</label>
                                <input type="number" class="form-control" id="guerrera" min="0" oninput="validarStockDisponible('guerrera')">
                                <small class="text-muted" id="stockGuerrera">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Talla Guerrera</label>
                                <select class="form-select" id="guerreraTalla">
                                    <option value="">Seleccionar...</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                    <option value="XXXXL">XXXXL</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado Guerrera</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoGuerrera" checked>
                                    <label class="form-check-label valorado-text" for="estadoGuerrera">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Chaqueta -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Chaqueta</label>
                                <input type="number" class="form-control" id="chaqueta" min="0" oninput="validarStockDisponible('chaqueta')">
                                <small class="text-muted" id="stockChaqueta">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Talla Chaqueta</label>
                                <select class="form-select" id="chaquetaTalla">
                                    <option value="">Seleccionar...</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                    <option value="XXXL">XXXL</option>
                                    <option value="XXXXL">XXXXL</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado Chaqueta</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoChaqueta" checked>
                                    <label class="form-check-label valorado-text" for="estadoChaqueta">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Camiseta Polo -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Camiseta Polo</label>
                                <input type="number" class="form-control" id="camisetapolo" min="0" oninput="validarStockDisponible('camisetapolo')">
                                <small class="text-muted" id="stockCamisetapolo">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Talla Camiseta Polo</label>
                                <select class="form-select" id="camisetaPoloTalla">
                                    <option value="">Seleccionar...</option>
                                    <option value="S">S</option>
                                    <option value="M">M</option>
                                    <option value="L">L</option>
                                    <option value="XL">XL</option>
                                    <option value="XXL">XXL</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Estado Camiseta Polo</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoCamisetaPolo" checked>
                                    <label class="form-check-label valorado-text" for="estadoCamisetaPolo">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <h6 class="mb-3 text-primary">Elementos de Protección Personal (EPP)</h6>
                        
                        <!-- Guantes Nitrilo -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Guantes Nitrilo</label>
                                <input type="number" class="form-control" id="guantesNitrilo" min="0" oninput="validarStockDisponible('guantes_nitrilo')">
                                <small class="text-muted" id="stockGuantesNitrilo">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estado Guantes Nitrilo</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoGuantesNitrilo" checked>
                                    <label class="form-check-label valorado-text" for="estadoGuantesNitrilo">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Guantes Carnaza -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Guantes Carnaza</label>
                                <input type="number" class="form-control" id="guantesCarnaza" min="0" oninput="validarStockDisponible('guantes_carnaza')">
                                <small class="text-muted" id="stockGuantesCarnaza">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estado Guantes Carnaza</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoGuantesCarnaza" checked>
                                    <label class="form-check-label valorado-text" for="estadoGuantesCarnaza">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Gafas -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Gafas</label>
                                <input type="number" class="form-control" id="gafas" min="0" oninput="validarStockDisponible('gafas')">
                                <small class="text-muted" id="stockGafas">Stock: Cargando...</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estado Gafas</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoGafas" checked>
                                    <label class="form-check-label valorado-text" for="estadoGafas">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Gorra -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Gorra</label>
                                <input type="number" class="form-control" id="gorra" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estado Gorra</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoGorra" checked>
                                    <label class="form-check-label valorado-text" for="estadoGorra">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Casco -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Casco</label>
                                <input type="number" class="form-control" id="casco" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estado Casco</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoCasco" checked>
                                    <label class="form-check-label valorado-text" for="estadoCasco">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Botas -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Botas</label>
                                <input type="number" class="form-control" id="botas" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Estado Botas</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" id="estadoBotas" checked>
                                    <label class="form-check-label valorado-text" for="estadoBotas">
                                        VALORADO
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Talla Botas - Campo separado -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Talla Botas</label>
                                <select class="form-select" id="botasTalla">
                                    <option value="">Seleccionar...</option>
                                    <option value="36">36</option>
                                    <option value="37">37</option>
                                    <option value="38">38</option>
                                    <option value="39">39</option>
                                    <option value="40">40</option>
                                    <option value="41">41</option>
                                    <option value="42">42</option>
                                    <option value="43">43</option>
                                    <option value="44">44</option>
                                    <option value="45">45</option>
                                    <option value="46">46</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarDotacion()">
                        <i class="fas fa-save me-1"></i>
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Registro de Ingresos -->
    <div class="modal fade" id="modalIngreso" tabindex="-1" aria-labelledby="modalIngresoLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalIngresoLabel">
                        <i class="fas fa-plus-circle me-2"></i>
                        Registrar Ingreso de Dotaciones
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="formIngreso">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tipoElemento" class="form-label">Tipo de Elemento *</label>
                                    <select class="form-select" id="tipoElemento" required onchange="manejarCamposTipoElemento()">
                                        <option value="">Seleccionar tipo...</option>
                                        <option value="pantalon">Pantalón</option>
                                        <option value="camisetagris">Camiseta Gris</option>
                                        <option value="chaqueta">Chaqueta</option>
                                        <option value="guerrera">Guerrera</option>
                                        <option value="camisetapolo">Camiseta Polo</option>
                                        <option value="guantes_nitrilo">Guantes Nitrilo</option>
                                        <option value="guantes_carnaza">Guantes Carnaza</option>
                                        <option value="gafas">Gafas</option>
                                        <option value="gorra">Gorra</option>
                                        <option value="casco">Casco</option>
                                        <option value="botas">Botas</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="cantidadIngreso" class="form-label">Cantidad *</label>
                                    <input type="number" class="form-control" id="cantidadIngreso" min="1" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3" id="campoTalla" style="display: none;">
                                    <label for="tallaIngreso" class="form-label">Talla</label>
                                    <select class="form-select" id="tallaIngreso">
                                        <option value="">Seleccionar talla...</option>
                                        <option value="XS">XS</option>
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="XXL">XXL</option>
                                        <option value="XXXL">XXXL</option>
                                        <option value="XXXXL">XXXXL</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3" id="campoNumeroCalzado" style="display: none;">
                                    <label for="numeroCalzadoIngreso" class="form-label">Número de Calzado</label>
                                    <select class="form-select" id="numeroCalzadoIngreso">
                                        <option value="">Seleccionar número...</option>
                                        <option value="35">35</option>
                                        <option value="36">36</option>
                                        <option value="37">37</option>
                                        <option value="38">38</option>
                                        <option value="39">39</option>
                                        <option value="40">40</option>
                                        <option value="41">41</option>
                                        <option value="42">42</option>
                                        <option value="43">43</option>
                                        <option value="44">44</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3" id="campoPantalon" style="display: none;">
                                    <label for="tallaPantalonIngreso" class="form-label">Talla Pantalón</label>
                                    <select class="form-select" id="tallaPantalonIngreso">
                                        <option value="">Seleccionar talla...</option>
                                        <option value="28">28</option>
                                        <option value="30">30</option>
                                        <option value="32">32</option>
                                        <option value="34">34</option>
                                        <option value="36">36</option>
                                        <option value="38">38</option>
                                        <option value="40">40</option>
                                        <option value="42">42</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3" id="campoGuantes" style="display: none;">
                                    <label for="tallaGuantesIngreso" class="form-label">Talla Guantes</label>
                                    <select class="form-select" id="tallaGuantesIngreso">
                                        <option value="">Seleccionar talla...</option>
                                        <option value="8">8</option>
                                        <option value="9">9</option>
                                        <option value="10">10</option>
                                        <option value="11">11</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3" id="campoTallaUnica" style="display: none;">
                                    <label for="tallaUnicaIngreso" class="form-label">Talla</label>
                                    <select class="form-select" id="tallaUnicaIngreso">
                                        <option value="TALLA UNICA">TALLA ÚNICA</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="proveedorIngreso" class="form-label">Proveedor *</label>
                                    <input type="text" class="form-control" id="proveedorIngreso" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="estadoIngreso" class="form-label">Estado *</label>
                                    <select class="form-select" id="estadoIngreso" required>
                                        <option value="">Seleccionar estado...</option>
                                        <option value="VALORADO">VALORADO</option>
                                        <option value="NO VALORADO">NO VALORADO</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fechaIngreso" class="form-label">Fecha de Ingreso *</label>
                                    <input type="date" class="form-control" id="fechaIngreso" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="observacionesIngreso" class="form-label">Observaciones</label>
                                    <textarea class="form-control" id="observacionesIngreso" rows="3" placeholder="Observaciones adicionales sobre el ingreso..."></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-success" onclick="guardarIngreso()">
                        <i class="fas fa-save me-1"></i>
                        Registrar Ingreso
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ver Detalles Dotación -->
    <div class="modal fade" id="modalDetallesDotacion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-eye me-2"></i>
                        Detalles de Asignación
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Información del Técnico -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                Información del Técnico
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>Nombre:</strong>
                                    <p id="detalleTecnicoNombre" class="mb-1">-</p>
                                </div>
                                <div class="col-md-4">
                                    <strong>Cédula:</strong>
                                    <p id="detalleTecnicoCedula" class="mb-1">-</p>
                                </div>
                                <div class="col-md-4">
                                    <strong>Cliente:</strong>
                                    <p id="detalleTecnicoCliente" class="mb-1">-</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Elementos Asignados -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-tshirt me-2"></i>
                                Elementos Asignados
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <!-- Ropa de Trabajo -->
                                <div class="col-12">
                                    <h6 class="text-primary mb-3">Ropa de Trabajo</h6>
                                </div>
                                
                                <!-- Pantalón -->
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-user-tie me-2 text-secondary"></i>
                                        <div>
                                            <strong>Pantalón:</strong>
                                            <span id="detallePantalon">-</span>
                                            <span id="detallePantalonTalla" class="text-muted">-</span>
                                            <span id="detallePantalonEstado" class="badge ms-2">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Camiseta Gris -->
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-tshirt me-2 text-secondary"></i>
                                        <div>
                                            <strong>Camiseta Gris:</strong>
                                            <span id="detalleCamisetaGris">-</span>
                                            <span id="detalleCamisetaGrisTalla" class="text-muted">-</span>
                                            <span id="detalleCamisetaGrisEstado" class="badge ms-2">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Guerrera -->
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-vest me-2 text-secondary"></i>
                                        <div>
                                            <strong>Guerrera:</strong>
                                            <span id="detalleGuerrera">-</span>
                                            <span id="detalleGuerreraTalla" class="text-muted">-</span>
                                            <span id="detalleGuerreraEstado" class="badge ms-2">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Camiseta Polo -->
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-tshirt me-2 text-secondary"></i>
                                        <div>
                                            <strong>Camiseta Polo:</strong>
                                            <span id="detalleCamisetaPolo">-</span>
                                            <span id="detalleCamisetaPoloTalla" class="text-muted">-</span>
                                            <span id="detalleCamisetaPoloEstado" class="badge ms-2">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- EPP -->
                                <div class="col-12 mt-3">
                                    <h6 class="text-primary mb-3">Elementos de Protección Personal</h6>
                                </div>

                                <!-- Guantes -->
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-hand-paper me-2 text-secondary"></i>
                                        <div>
                                            <strong>Guantes:</strong>
                                            <div class="ms-2">
                                                <span>Nitrilo: <span id="detalleGuantesNitrilo">-</span></span>
                                                <span id="detalleGuantesNitriloEstado" class="badge ms-1">-</span>
                                                <br>
                                                <span>Carnaza: <span id="detalleGuantesCarnaza">-</span></span>
                                                <span id="detalleGuantesCarnazaEstado" class="badge ms-1">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- EPP Adicional -->
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-hard-hat me-2 text-secondary"></i>
                                        <div>
                                            <strong>EPP Adicional:</strong>
                                            <div class="ms-2">
                                                <span>Gafas: <span id="detalleGafas">-</span></span>
                                                <span id="detalleGafasEstado" class="badge ms-1">-</span>
                                                <br>
                                                <span>Gorra: <span id="detalleGorra">-</span></span>
                                                <span id="detalleGorraEstado" class="badge ms-1">-</span>
                                                <br>
                                                <span>Casco: <span id="detalleCasco">-</span></span>
                                                <span id="detalleCascoEstado" class="badge ms-1">-</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Botas -->
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-shoe-prints me-2 text-secondary"></i>
                                        <div>
                                            <strong>Botas:</strong>
                                            <span id="detalleBotas">-</span>
                                            <span id="detalleBotasTalla" class="text-muted">-</span>
                                            <span id="detalleBotasEstado" class="badge ms-2">-</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Fecha de Registro -->
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-calendar me-2 text-secondary"></i>
                                        <div>
                                            <strong>Fecha de Registro:</strong>
                                            <span id="detalleFechaRegistro">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Firma del Técnico -->
                    <div class="card mt-3">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-signature me-2"></i>
                                Firma del Técnico
                            </h6>
                        </div>
                        <div class="card-body text-center">
                            <div id="firmaContainer" class="border rounded p-3" style="min-height: 120px; background-color: #f8f9fa;">
                                <div id="firmaImagen" style="display: none;">
                                    <img id="imagenFirma" src="" alt="Firma del técnico" class="img-fluid" style="max-height: 100px; border: 1px solid #dee2e6; border-radius: 4px;">
                                    <p class="text-muted mt-2 mb-0" id="fechaFirma">-</p>
                                </div>
                                <div id="sinFirma">
                                    <i class="fas fa-signature text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2 mb-0">Sin firma registrada</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Modal para Firma Digital -->
    <div class="modal fade" id="modalFirmaDigital" tabindex="-1" aria-labelledby="modalFirmaDigitalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalFirmaDigitalLabel">
                        <i class="fas fa-signature me-2"></i>
                        Firma Digital de Dotación
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="firmaIdDotacion">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Técnico:</label>
                            <p id="firmaTecnicoNombre" class="text-muted">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Cliente:</label>
                            <p id="firmaClienteNombre" class="text-muted">-</p>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instrucciones:</strong> Dibuje su firma en el área designada usando el mouse o touch. La firma será guardada digitalmente y asociada a esta dotación.
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">Área de Firma:</label>
                            <div class="border border-2 border-primary rounded p-2" style="background-color: #f8f9fa;">
                                <canvas id="canvasFirma" width="600" height="200" style="cursor: crosshair; display: block; margin: 0 auto; background-color: white; border-radius: 4px;"></canvas>
                            </div>
                            <small class="text-muted mt-1 d-block">Dibuje su firma en el área anterior usando el mouse o touch</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 text-center">
                            <button type="button" class="btn btn-outline-warning" onclick="limpiarFirma()">
                                <i class="fas fa-eraser me-1"></i>
                                Limpiar Firma
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="guardarFirma()">
                        <i class="fas fa-save me-1"></i>
                        Guardar Firma
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Ver Firma Existente -->
    <div class="modal fade" id="modalVerFirma" tabindex="-1" aria-labelledby="modalVerFirmaLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="modalVerFirmaLabel">
                        <i class="fas fa-eye me-2"></i>
                        Visualizar Firma Digital
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">ID Dotación:</label>
                            <p id="verFirmaIdDotacion" class="text-muted">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Técnico:</label>
                            <p id="verFirmaTecnicoNombre" class="text-muted">-</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Cliente:</label>
                            <p id="verFirmaCliente" class="text-muted">-</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha de Firma:</label>
                            <p id="verFirmaFecha" class="text-muted">-</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">Usuario que Firmó:</label>
                            <p id="verFirmaUsuario" class="text-muted">-</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label fw-bold">Firma Digital:</label>
                            <div class="border border-2 border-success rounded p-3 text-center" style="background-color: #f8f9fa;">
                                <img id="imagenFirma" src="" alt="Firma Digital" class="img-fluid" style="max-height: 200px; display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Scripts -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

    <script>
        // Variables globales
        let tablaDotaciones;

        let movimientosChart = null;
        
        // Variables de sesión del usuario
        const sessionUser = {
            cedula: '{{ session.get("user_cedula", "") }}',
            name: '{{ session.get("user_name", "") }}',
            role: '{{ session.get("user_role", "") }}'
        }

        // Función para obtener stock mínimo por tipo de elemento
        function getStockMinimo(tipoElemento) {
            const stocksMinimos = {
                'pantalon': 50,
                'camisetagris': 100,
                'guerrera': 30,
                'camisetapolo': 80,
                'guantes': 200,
                'epp': 50,
                'botas': 40
            };
            return stocksMinimos[tipoElemento] || 10;
        };

        // Función para inicializar checkboxes de estado
        function inicializarCheckboxesEstado() {
            console.log('Inicializando checkboxes de estado...');
            
            // Lista de IDs de checkboxes de estado
            const checkboxIds = [
                'estadoPantalon',
                'estadoCamisetaGris', 
                'estadoGuerrera',
                'estadoCamisetaPolo',
                'estadoGuantesNitrilo',
                'estadoGuantesCarnaza',
                'estadoGafas',
                'estadoGorra',
                'estadoCasco',
                'estadoBotas'
            ];
            
            checkboxIds.forEach(id => {
                const checkbox = document.getElementById(id);
                const label = checkbox ? document.querySelector(`label[for="${id}"]`) : null;
                
                if (checkbox && label) {
                    console.log(`Configurando checkbox: ${id}`);
                    
                    // Limpiar cualquier estilo inline problemático
                    checkbox.removeAttribute('style');
                    label.removeAttribute('style');
                    
                    // Asegurar que las clases CSS estén aplicadas
                    checkbox.classList.add('form-check-input');
                    label.classList.add('form-check-label');
                    
                    // Función para actualizar el texto del label
                    const actualizarLabel = () => {
                        if (checkbox.checked) {
                            label.textContent = 'VALORADO';
                            label.className = 'form-check-label valorado-text';
                        } else {
                            label.textContent = 'NO VALORADO';
                            label.className = 'form-check-label no-valorado-text';
                        }
                    };
                    
                    // Inicializar el estado del label
                    actualizarLabel();
                    
                    // Remover event listeners previos para evitar duplicados
                    checkbox.removeEventListener('change', actualizarLabel);
                    
                    // Agregar evento de cambio
                    checkbox.addEventListener('change', function() {
                        console.log(`Checkbox ${id} cambiado a:`, this.checked);
                        actualizarLabel();
                    });
                    
                    // Agregar evento de click al label para mayor usabilidad
                    label.addEventListener('click', function(e) {
                        e.preventDefault();
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change'));
                    });
                    
                } else {
                    console.warn(`Checkbox o label no encontrado: ${id}`);
                }
            });
        }

        // Comentado para evitar doble inicialización
        // $(document).ready(function() {
        //     inicializarTabla();
        //     cargarDatos();
        //     cargarTecnicos();
        //     inicializarGraficos();
        // });

        // Inicializar DataTable
        function inicializarTabla() {
            // Verificar que el elemento existe
            const tablaElement = document.getElementById('tablaDotaciones');
            if (!tablaElement) {
                console.error('Elemento tablaDotaciones no encontrado');
                return;
            }
            
            // Verificar si la tabla ya está inicializada
            if ($.fn.DataTable.isDataTable('#tablaDotaciones')) {
                // Destruir la instancia existente
                $('#tablaDotaciones').DataTable().destroy();
            }
            
            tablaDotaciones = $('#tablaDotaciones').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
                },
                responsive: true,
                pageLength: 25,
                order: [[0, 'desc']],
                columnDefs: [
                    { targets: -1, orderable: false } // Columna de acciones no ordenable
                ]
            });
        }

        // Cargar datos de dotaciones
        function cargarDatos() {
            // Cargar dotaciones
            fetch('/api/dotaciones')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        actualizarTabla(data.dotaciones);
                        actualizarEstadisticas(data.dotaciones);
                    } else {
                        mostrarError('Error al cargar dotaciones: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarError('Error de conexión al cargar dotaciones');
                });
            
            // Cargar clientes
            cargarClientes();
        }

        // Cargar lista de clientes
        function cargarClientes() {
            fetch('/api/clientes')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const filtroCliente = document.getElementById('filtroCliente');
                        
                        if (filtroCliente) {
                            filtroCliente.innerHTML = '<option value="">Todos los clientes</option>';
                            
                            data.data.forEach(cliente => {
                                const option = new Option(cliente, cliente);
                                filtroCliente.add(option);
                            });
                        }
                    } else {
                        console.error('Error al cargar clientes:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar clientes:', error);
                });
        }

        // Cargar clientes en el select del modal
        function cargarClientesModal() {
            fetch('/api/clientes')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const selectCliente = document.getElementById('cliente');
                        
                        if (selectCliente) {
                            selectCliente.innerHTML = '<option value="">Seleccionar cliente...</option>';
                            
                            data.data.forEach(cliente => {
                                const option = new Option(cliente, cliente);
                                selectCliente.add(option);
                            });
                        }
                    } else {
                        console.error('Error al cargar clientes en modal:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar clientes en modal:', error);
                });
        }

        // Cargar lista de técnicos
        function cargarTecnicos() {
            const estado = document.getElementById('filtroEstadoTecnico') ? document.getElementById('filtroEstadoTecnico').value : 'Activo';
            const cliente = document.getElementById('filtroCliente') ? document.getElementById('filtroCliente').value : '';
            
            let url = '/api/tecnicos';
            const params = new URLSearchParams();
            
            if (estado) {
                params.append('estado', estado);
            }
            if (cliente) {
                params.append('cliente', cliente);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const filtroTecnico = document.getElementById('filtroTecnico');
                    
                    if (filtroTecnico) {
                        filtroTecnico.innerHTML = '<option value="">Todos los técnicos</option>';
                    }
                    
                    console.log('Datos de técnicos recibidos:', data);
                    
                    // Los datos están en data.data según la respuesta del endpoint
                    if (data.success && Array.isArray(data.data)) {
                        data.data.forEach(tecnico => {
                            if (filtroTecnico) {
                                const option = new Option(`${tecnico.nombre} - ${tecnico.recurso_operativo_cedula}`, tecnico.id_codigo_consumidor);
                                filtroTecnico.add(option);
                            }
                        });
                        console.log(`Cargados ${data.data.length} técnicos`);
                    } else {
                        console.error('Error en la respuesta de técnicos:', data);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar técnicos:', error);
                });
        }
        
        // Actualizar filtro de técnicos cuando cambie el estado
        function actualizarFiltroTecnicos() {
            cargarTecnicos();
        }
        
        // Actualizar filtros cuando cambie el cliente
        function actualizarFiltrosPorCliente() {
            cargarTecnicos(); // Actualizar lista de técnicos según el cliente seleccionado
            filtrarDotaciones(); // Filtrar las dotaciones
        }

        // Actualizar tabla
        function actualizarTabla(dotaciones) {
            tablaDotaciones.clear();
            
            dotaciones.forEach(dotacion => {
                // Crear indicador visual de estado de firma
                let estadoFirma = '';
                if (dotacion.firmado) {
                    const fechaFirma = dotacion.fecha_firma ? new Date(dotacion.fecha_firma).toLocaleDateString() : 'N/A';
                    const usuarioFirma = dotacion.usuario_firma_nombre || 'Usuario desconocido';
                    estadoFirma = `
                        <span class="badge bg-success d-flex align-items-center" title="Firmado el ${fechaFirma} por ${usuarioFirma}">
                            <i class="fas fa-check-circle me-1"></i>
                            Firmado
                        </span>
                    `;
                } else {
                    estadoFirma = `
                        <span class="badge bg-warning d-flex align-items-center">
                            <i class="fas fa-clock me-1"></i>
                            Pendiente
                        </span>
                    `;
                }
                
                const fila = [
                    dotacion.tecnico_nombre || 'Sin asignar',
                    estadoFirma,
                    dotacion.fecha_registro ? new Date(dotacion.fecha_registro).toLocaleDateString() : 'N/A',
                    `
                        <button class="btn btn-sm btn-outline-info me-1" onclick="verDetallesDotacion(${dotacion.id_dotacion})" title="Ver Detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm ${dotacion.firmado ? 'btn-outline-secondary disabled' : 'btn-outline-primary'} me-1" 
                                onclick="${dotacion.firmado ? '' : 'editarDotacion(' + dotacion.id_dotacion + ')'}" 
                                title="${dotacion.firmado ? 'No se puede editar - Dotación firmada' : 'Editar'}" 
                                ${dotacion.firmado ? 'disabled style="cursor: not-allowed; opacity: 0.6;"' : ''}>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm ${dotacion.firmado ? 'btn-outline-secondary' : 'btn-outline-success'} me-1" onclick="${dotacion.firmado ? 'verFirma(' + dotacion.id_dotacion + ')' : 'firmarDotacion(' + dotacion.id_dotacion + ', \'' + (dotacion.tecnico_nombre || 'Sin asignar') + '\', \'' + (dotacion.cliente || 'N/A') + '\')'}" title="${dotacion.firmado ? 'Ver Firma' : 'Firmar Dotación'}" ${dotacion.firmado ? '' : ''}>
                            <i class="fas ${dotacion.firmado ? 'fa-eye' : 'fa-signature'}"></i>
                        </button>
                    `
                ];
                tablaDotaciones.row.add(fila);
            });
            
            tablaDotaciones.draw();
            
            // Generar tarjetas móviles para diseño responsive
            generarTarjetasMoviles(dotaciones);
        }

        // Actualizar estadísticas
        function actualizarEstadisticas(dotaciones) {
            const total = dotaciones.length;
            const asignadas = dotaciones.filter(d => d.id_codigo_consumidor).length;
            const disponibles = total - asignadas;
            
            document.getElementById('totalDotaciones').textContent = total;
            document.getElementById('dotacionesAsignadas').textContent = asignadas;
            document.getElementById('dotacionesDisponibles').textContent = disponibles;
            document.getElementById('dotacionesMantenimiento').textContent = 0; // Placeholder
        }

        // Inicializar gráficos
        function inicializarGraficos() {
            // Destruir gráficos existentes si existen
            if (movimientosChart) {
                movimientosChart.destroy();
                movimientosChart = null;
            }



            // Verificar que el elemento movimientosChart existe
            const movimientosElement = document.getElementById('movimientosChart');
            if (movimientosElement) {
                // Gráfico de movimientos (placeholder)
                const ctxMovimientos = movimientosElement.getContext('2d');
                movimientosChart = new Chart(ctxMovimientos, {
                    type: 'line',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Asignaciones',
                            data: [12, 19, 3, 5, 2, 3],
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                console.warn('Elemento movimientosChart no encontrado');
            }
        }



        // Nueva dotación
        function nuevaDotacion() {
            document.getElementById('formDotacion').reset();
            document.getElementById('idDotacion').value = '';
            document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-plus me-2"></i>Nueva Dotación';
            
            // Cargar clientes en el select del modal
            cargarClientesModal();
            
            // Esperar a que se carguen los clientes y luego auto-seleccionar
            setTimeout(() => {
                // Obtener el cliente seleccionado en el filtro principal
                const filtroClientePrincipal = document.getElementById('filtroCliente');
                const clienteSeleccionado = filtroClientePrincipal.value;
                
                // Si hay un cliente seleccionado en el filtro principal, establecerlo en el modal
                if (clienteSeleccionado && clienteSeleccionado !== '') {
                    document.getElementById('cliente').value = clienteSeleccionado;
                    // Cargar técnicos filtrados por ese cliente
                    cargarTecnicosFiltrados(clienteSeleccionado, 'Activo');
                } else {
                    // Si no hay cliente seleccionado, cargar todos los técnicos activos
                    cargarTecnicos();
                }
            }, 500);
            
            // Agregar evento para filtrar técnicos por cliente cuando se cambie manualmente
            document.getElementById('cliente').addEventListener('change', function() {
                const clienteSeleccionado = this.value;
                if (clienteSeleccionado) {
                    cargarTecnicosFiltrados(clienteSeleccionado, 'Activo');
                } else {
                    // Si no hay cliente, cargar todos los técnicos activos
                    cargarTecnicos();
                }
            });
            
            const modal = new bootstrap.Modal(document.getElementById('modalDotacion'));
            modal.show();
            
            // Inicializar checkboxes después de mostrar el modal
            setTimeout(() => {
                inicializarCheckboxesEstado();
            }, 100);
        }
        
        // Función para cargar técnicos filtrados por cliente y estado
        function cargarTecnicosFiltrados(cliente, estado) {
            let url = '/api/tecnicos';
            const params = new URLSearchParams();
            
            if (cliente) {
                params.append('cliente', cliente);
            }
            if (estado) {
                params.append('estado', estado);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const selectTecnico = document.getElementById('idCodigoConsumidor');
                    
                    if (selectTecnico) {
                        selectTecnico.innerHTML = '<option value="">Seleccionar técnico...</option>';
                        
                        console.log('Datos de técnicos filtrados recibidos:', data);
                        
                        if (data.success && Array.isArray(data.data)) {
                            data.data.forEach(tecnico => {
                                const option = new Option(`${tecnico.nombre} - ${tecnico.recurso_operativo_cedula}`, tecnico.id_codigo_consumidor);
                                selectTecnico.add(option);
                            });
                            console.log(`Cargados ${data.data.length} técnicos filtrados`);
                        } else {
                            console.error('Error en la respuesta de técnicos filtrados:', data);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al cargar técnicos filtrados:', error);
                });
        }

        // Editar dotación
        function editarDotacion(id) {
            fetch(`/api/dotaciones/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const dotacion = data.dotacion;
                        
                        // Cargar clientes en el select del modal
                        cargarClientesModal();
                        
                        // Esperar a que se carguen los clientes y luego establecer los valores
                        setTimeout(() => {
                            document.getElementById('idDotacion').value = dotacion.id_dotacion;
                            document.getElementById('cliente').value = dotacion.cliente || '';
                            
                            // Cargar técnicos filtrados por el cliente de la dotación
                            if (dotacion.cliente) {
                                cargarTecnicosFiltrados(dotacion.cliente, 'Activo');
                                
                                // Esperar a que se carguen los técnicos y luego establecer el valor
                                setTimeout(() => {
                                    document.getElementById('idCodigoConsumidor').value = dotacion.id_codigo_consumidor || '';
                                }, 300);
                            } else {
                                // Si no hay cliente, cargar todos los técnicos
                                cargarTecnicos();
                                setTimeout(() => {
                                    document.getElementById('idCodigoConsumidor').value = dotacion.id_codigo_consumidor || '';
                                }, 300);
                            }
                            
                            document.getElementById('pantalon').value = dotacion.pantalon || '';
                            document.getElementById('pantalonTalla').value = dotacion.pantalon_talla || '';
                            document.getElementById('camisetagris').value = dotacion.camisetagris || '';
                            document.getElementById('camisetaGrisTalla').value = dotacion.camiseta_gris_talla || '';
                            document.getElementById('guerrera').value = dotacion.guerrera || '';
                            document.getElementById('guerreraTalla').value = dotacion.guerrera_talla || '';
                            document.getElementById('chaqueta').value = dotacion.chaqueta || '';
                            document.getElementById('chaquetaTalla').value = dotacion.chaqueta_talla || '';
                            document.getElementById('camisetapolo').value = dotacion.camisetapolo || '';
                            document.getElementById('camisetaPoloTalla').value = dotacion.camiseta_polo_talla || '';
                            document.getElementById('guantesNitrilo').value = dotacion.guantes_nitrilo || '';
                            document.getElementById('guantesCarnaza').value = dotacion.guantes_carnaza || '';
                            document.getElementById('gafas').value = dotacion.gafas || '';
                            document.getElementById('gorra').value = dotacion.gorra || '';
                            document.getElementById('casco').value = dotacion.casco || '';
                            document.getElementById('botas').value = dotacion.botas || '';
                            document.getElementById('botasTalla').value = dotacion.botas_talla || '';
                        }, 500);
                        
                        document.getElementById('modalTitulo').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Dotación';
                        const modal = new bootstrap.Modal(document.getElementById('modalDotacion'));
                        modal.show();
                        
                        // Inicializar checkboxes después de mostrar el modal
                        setTimeout(() => {
                            inicializarCheckboxesEstado();
                        }, 100);
                    } else {
                        mostrarError('Error al cargar dotación: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    mostrarError('Error de conexión al cargar dotación');
                });
        }

        // Guardar dotación
        function guardarDotacion() {
            const formData = new FormData(document.getElementById('formDotacion'));
            const id = document.getElementById('idDotacion').value;
            
            const dotacion = {
                cliente: document.getElementById('cliente').value,
                id_codigo_consumidor: document.getElementById('idCodigoConsumidor').value || null,
                pantalon: parseInt(document.getElementById('pantalon').value) || null,
                pantalon_talla: parseInt(document.getElementById('pantalonTalla').value) || null,
                pantalon_valorado: document.getElementById('estadoPantalon').checked ? 1 : 0,
                camisetagris: parseInt(document.getElementById('camisetagris').value) || null,
                camiseta_gris_talla: document.getElementById('camisetaGrisTalla').value || null,
                camiseta_gris_valorado: document.getElementById('estadoCamisetaGris').checked ? 1 : 0,
                guerrera: parseInt(document.getElementById('guerrera').value) || null,
                guerrera_talla: document.getElementById('guerreraTalla').value || null,
                guerrera_valorado: document.getElementById('estadoGuerrera').checked ? 1 : 0,
                chaqueta: parseInt(document.getElementById('chaqueta').value) || null,
                chaqueta_talla: document.getElementById('chaquetaTalla').value || null,
                chaqueta_valorado: document.getElementById('estadoChaqueta').checked ? 1 : 0,
                camisetapolo: parseInt(document.getElementById('camisetapolo').value) || null,
                camiseta_polo_talla: document.getElementById('camisetaPoloTalla').value || null,
                camiseta_polo_valorado: document.getElementById('estadoCamisetaPolo').checked ? 1 : 0,
                guantes_nitrilo: parseInt(document.getElementById('guantesNitrilo').value) || null,
                guantes_nitrilo_valorado: document.getElementById('estadoGuantesNitrilo').checked ? 1 : 0,
                guantes_carnaza: parseInt(document.getElementById('guantesCarnaza').value) || null,
                guantes_carnaza_valorado: document.getElementById('estadoGuantesCarnaza').checked ? 1 : 0,
                gafas: parseInt(document.getElementById('gafas').value) || null,
                gafas_valorado: document.getElementById('estadoGafas').checked ? 1 : 0,
                gorra: parseInt(document.getElementById('gorra').value) || null,
                gorra_valorado: document.getElementById('estadoGorra').checked ? 1 : 0,
                casco: parseInt(document.getElementById('casco').value) || null,
                casco_valorado: document.getElementById('estadoCasco').checked ? 1 : 0,
                botas: parseInt(document.getElementById('botas').value) || null,
                botas_talla: document.getElementById('botasTalla').value || null,
                botas_valorado: document.getElementById('estadoBotas').checked ? 1 : 0
            };

            const url = id ? `/api/dotaciones/${id}` : '/api/dotaciones';
            const method = id ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(dotacion)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('modalDotacion')).hide();
                    cargarDatos();
                    mostrarExito(id ? 'Dotación actualizada correctamente' : 'Dotación creada correctamente');
                } else {
                    mostrarError('Error al guardar dotación: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarError('Error de conexión al guardar dotación');
            });
        }



        // Filtrar dotaciones
        function filtrarDotaciones() {
            const cliente = document.getElementById('filtroCliente').value;
            const tecnico = document.getElementById('filtroTecnico').value;
            const busqueda = document.getElementById('buscarDotacion').value;
            
            // Implementar filtrado en DataTable
            tablaDotaciones.search(busqueda).draw();
            
            // Si la vista visual está activa, actualizarla también
            const vistaVisual = document.getElementById('vistaVisual');
            if (vistaVisual && vistaVisual.style.display !== 'none') {
                generarVistaVisual();
            }
        }

        // Exportar datos
        function exportarDatos() {
            window.open('/api/dotaciones/export', '_blank');
        }

        // Funciones para el modal de ingresos
        function abrirModalIngreso() {
            // Limpiar formulario
            document.getElementById('formIngreso').reset();
            
            // Ocultar campos de talla y número de calzado
            document.getElementById('campoTalla').style.display = 'none';
            document.getElementById('campoNumeroCalzado').style.display = 'none';
            
            // Establecer fecha actual por defecto
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('fechaIngreso').value = hoy;
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('modalIngreso')).show();
        }
        
        // Función para mostrar/ocultar campos según tipo de elemento
        function manejarCamposTipoElemento() {
            const tipoElemento = document.getElementById('tipoElemento').value;
            const campoTalla = document.getElementById('campoTalla');
            const campoNumeroCalzado = document.getElementById('campoNumeroCalzado');
            const campoPantalon = document.getElementById('campoPantalon');
            const campoGuantes = document.getElementById('campoGuantes');
            const campoTallaUnica = document.getElementById('campoTallaUnica');
            
            // Ocultar todos los campos por defecto
            campoTalla.style.display = 'none';
            campoNumeroCalzado.style.display = 'none';
            campoPantalon.style.display = 'none';
            campoGuantes.style.display = 'none';
            campoTallaUnica.style.display = 'none';
            
            // Elementos que requieren talla de ropa (XS-XXXXL)
            const elementosConTallaRopa = ['camisetagris', 'guerrera', 'camisetapolo', 'chaqueta'];
            
            // Elementos que requieren número de calzado (35-44)
            const elementosConCalzado = ['botas'];
            
            // Elementos que requieren talla de pantalón (28, 30, 32, 34, 36, 38)
            const elementosConTallaPantalon = ['pantalon'];
            
            // Elementos que requieren talla de guantes (8, 9, 10, 11)
            const elementosConTallaGuantes = ['guantesnitrilo', 'guantescarnaza', 'guantes'];
            
            // Elementos que requieren talla única
            const elementosConTallaUnica = ['gafas', 'gorra', 'casco'];
            
            if (elementosConTallaRopa.includes(tipoElemento)) {
                campoTalla.style.display = 'block';
            } else if (elementosConCalzado.includes(tipoElemento)) {
                campoNumeroCalzado.style.display = 'block';
            } else if (elementosConTallaPantalon.includes(tipoElemento)) {
                campoPantalon.style.display = 'block';
            } else if (elementosConTallaGuantes.includes(tipoElemento)) {
                campoGuantes.style.display = 'block';
            } else if (elementosConTallaUnica.includes(tipoElemento)) {
                campoTallaUnica.style.display = 'block';
            }
        }

        // Función para validar duplicados
        function validarDuplicados(tipoElemento, talla, numeroCalzado, tallaPantalon, tallaGuantes, tallaUnica, fechaIngreso, proveedor) {
            return fetch(`/api/ingresos-dotaciones?tipo_elemento=${tipoElemento}&fecha_inicio=${fechaIngreso}&fecha_fin=${fechaIngreso}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.ingresos) {
                        // Buscar duplicados exactos
                        const duplicado = data.ingresos.find(ingreso => {
                            const mismaTalla = (talla && ingreso.talla === talla) || (!talla && !ingreso.talla);
                            const mismoCalzado = (numeroCalzado && ingreso.numero_calzado === numeroCalzado) || (!numeroCalzado && !ingreso.numero_calzado);
                            const mismaTallaPantalon = (tallaPantalon && ingreso.talla_pantalon === tallaPantalon) || (!tallaPantalon && !ingreso.talla_pantalon);
                            const mismaTallaGuantes = (tallaGuantes && ingreso.talla_guantes === tallaGuantes) || (!tallaGuantes && !ingreso.talla_guantes);
                            const mismaTallaUnica = (tallaUnica && ingreso.talla_unica === tallaUnica) || (!tallaUnica && !ingreso.talla_unica);
                            const mismoProveedor = ingreso.proveedor === proveedor;
                            const mismaFecha = ingreso.fecha_ingreso === fechaIngreso;
                            
                            return mismaTalla && mismoCalzado && mismaTallaPantalon && mismaTallaGuantes && mismaTallaUnica && mismoProveedor && mismaFecha;
                        });
                        
                        return duplicado ? true : false;
                    }
                    return false;
                })
                .catch(error => {
                    console.error('Error al validar duplicados:', error);
                    return false;
                });
        }

        function guardarIngreso() {
            const tipoElemento = document.getElementById('tipoElemento').value;
            const cantidad = document.getElementById('cantidadIngreso').value;
            const talla = document.getElementById('tallaIngreso').value;
            const numeroCalzado = document.getElementById('numeroCalzadoIngreso').value;
            const tallaPantalon = document.getElementById('tallaPantalonIngreso').value;
            const tallaGuantes = document.getElementById('tallaGuantesIngreso').value;
            const tallaUnica = document.getElementById('tallaUnicaIngreso').value;
            const proveedor = document.getElementById('proveedorIngreso').value;
            const estado = document.getElementById('estadoIngreso').value;
            const fechaIngreso = document.getElementById('fechaIngreso').value;
            const observaciones = document.getElementById('observacionesIngreso').value;

            // Validaciones básicas
            if (!tipoElemento || !cantidad || !proveedor || !estado || !fechaIngreso) {
                mostrarError('Por favor complete todos los campos obligatorios');
                return;
            }

            if (parseInt(cantidad) <= 0) {
                mostrarError('La cantidad debe ser mayor a 0');
                return;
            }

            // Validar campos específicos según tipo de elemento
            const elementosConTallaRopa = ['camisetagris', 'guerrera', 'camisetapolo', 'chaqueta'];
            const elementosConCalzado = ['botas'];
            const elementosConTallaPantalon = ['pantalon'];
            const elementosConTallaGuantes = ['guantesnitrilo', 'guantescarnaza', 'guantes'];
            const elementosConTallaUnica = ['gafas', 'gorra', 'casco'];
            
            if (elementosConTallaRopa.includes(tipoElemento) && !talla) {
                mostrarError('Por favor seleccione una talla para este tipo de elemento');
                return;
            }
            
            if (elementosConCalzado.includes(tipoElemento) && !numeroCalzado) {
                mostrarError('Por favor seleccione un número de calzado para este tipo de elemento');
                return;
            }
            
            if (elementosConTallaPantalon.includes(tipoElemento) && !tallaPantalon) {
                mostrarError('Por favor seleccione una talla de pantalón para este tipo de elemento');
                return;
            }
            
            if (elementosConTallaGuantes.includes(tipoElemento) && !tallaGuantes) {
                mostrarError('Por favor seleccione una talla de guantes para este tipo de elemento');
                return;
            }
            
            if (elementosConTallaUnica.includes(tipoElemento) && !tallaUnica) {
                mostrarError('Por favor seleccione talla única para este tipo de elemento');
                return;
            }

            // Validar duplicados antes de proceder
            validarDuplicados(tipoElemento, talla, numeroCalzado, tallaPantalon, tallaGuantes, tallaUnica, fechaIngreso, proveedor)
                .then(esDuplicado => {
                    if (esDuplicado) {
                        const detalles = [];
                        if (talla) detalles.push(`Talla: ${talla}`);
                        if (numeroCalzado) detalles.push(`Número: ${numeroCalzado}`);
                        if (tallaPantalon) detalles.push(`Talla Pantalón: ${tallaPantalon}`);
                        if (tallaGuantes) detalles.push(`Talla Guantes: ${tallaGuantes}`);
                        if (tallaUnica) detalles.push(`Talla: ${tallaUnica}`);
                        const detalleTexto = detalles.length > 0 ? ` (${detalles.join(', ')})` : '';
                        
                        mostrarError(`Ya existe un ingreso idéntico para ${tipoElemento}${detalleTexto} del proveedor ${proveedor} en la fecha ${fechaIngreso}. No se permiten duplicados.`);
                        return;
                    }

                    // Si no es duplicado, proceder con el registro
                    const ingresoData = {
                        tipo_elemento: tipoElemento,
                        cantidad: parseInt(cantidad),
                        talla: talla || null,
                        numero_calzado: numeroCalzado || null,
                        talla_pantalon: tallaPantalon || null,
                        talla_guantes: tallaGuantes || null,
                        talla_unica: tallaUnica || null,
                        proveedor: proveedor,
                        estado: estado,
                        fecha_ingreso: fechaIngreso,
                        observaciones: observaciones || null,
                        usuario_registro: sessionUser.cedula
                    };

                    fetch('/api/ingresos-dotaciones', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(ingresoData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            bootstrap.Modal.getInstance(document.getElementById('modalIngreso')).hide();
                            mostrarExito('Ingreso registrado correctamente');
                            // Recargar datos para actualizar estadísticas y gráficos
                            cargarDatos();
                            cargarDatosStock();
                        } else {
                            mostrarError('Error al registrar ingreso: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        mostrarError('Error de conexión al registrar ingreso');
                    });
                })
                .catch(error => {
                    console.error('Error en validación de duplicados:', error);
                    mostrarError('Error al validar duplicados. Intente nuevamente.');
                });
        }

        // Función para cargar datos de stock
        function cargarDatosStock() {
            // Cargar datos básicos de stock
            const stockPromise = fetch('/api/stock-dotaciones')
                .then(response => response.json());
            
            // Cargar datos de stock por tallas
            const tallasPromise = fetch('/api/stock-dotaciones-tallas')
                .then(response => response.json());
            
            Promise.all([stockPromise, tallasPromise])
                .then(([stockData, tallasData]) => {
                    if (stockData.success && tallasData.success) {
                        actualizarTablaStock(stockData.stock, tallasData.stock_tallas);
                    } else {
                        console.error('Error al cargar datos de stock:', stockData.message || tallasData.message);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar datos de stock:', error);
                });
        }

        // Función para generar tarjetas móviles
        function generarTarjetasMoviles(dotaciones) {
            const mobileContainer = document.querySelector('.mobile-cards-container');
            if (!mobileContainer) return;
            
            mobileContainer.innerHTML = '';
            
            if (!dotaciones || dotaciones.length === 0) {
                mobileContainer.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-info-circle"></i> No hay dotaciones para mostrar</div>';
                return;
            }
            
            dotaciones.forEach(dotacion => {
                // Crear indicador visual de estado de firma
                let estadoFirma = '';
                if (dotacion.firmado) {
                    const fechaFirma = dotacion.fecha_firma ? new Date(dotacion.fecha_firma).toLocaleDateString() : 'N/A';
                    const usuarioFirma = dotacion.usuario_firma_nombre || 'Usuario desconocido';
                    estadoFirma = `
                        <span class="badge bg-success d-flex align-items-center" title="Firmado el ${fechaFirma} por ${usuarioFirma}">
                            <i class="fas fa-check-circle me-1"></i>
                            Firmado
                        </span>
                    `;
                } else {
                    estadoFirma = `
                        <span class="badge bg-warning d-flex align-items-center">
                            <i class="fas fa-clock me-1"></i>
                            Pendiente
                        </span>
                    `;
                }
                
                const card = document.createElement('div');
                card.className = 'mobile-card';
                card.innerHTML = `
                    <div class="mobile-card-header">
                        <strong>${dotacion.tecnico_nombre || 'Sin asignar'}</strong>
                        <div class="mobile-card-date">
                            ${dotacion.fecha_registro ? new Date(dotacion.fecha_registro).toLocaleDateString() : 'N/A'}
                        </div>
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-section">
                            <div class="mobile-card-label">
                                <i class="fas fa-clipboard-check me-1"></i>
                                Estado de Formularios:
                            </div>
                            <div class="mobile-card-value">
                                ${estadoFirma}
                            </div>
                        </div>
                        <div class="mobile-card-section">
                            <div class="mobile-card-label">
                                <i class="fas fa-tools me-1"></i>
                                Acciones:
                            </div>
                            <div class="mobile-card-value">
                                <button class="btn btn-sm btn-outline-info me-1" onclick="verDetallesDotacion(${dotacion.id_dotacion})" title="Ver Detalles">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm ${dotacion.firmado ? 'btn-outline-secondary disabled' : 'btn-outline-primary'} me-1" 
                                        onclick="${dotacion.firmado ? '' : 'editarDotacion(' + dotacion.id_dotacion + ')'}"
                                        title="${dotacion.firmado ? 'No se puede editar - Dotación firmada' : 'Editar'}"
                                        ${dotacion.firmado ? 'disabled style="cursor: not-allowed; opacity: 0.6;"' : ''}>
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm ${dotacion.firmado ? 'btn-outline-secondary' : 'btn-outline-success'} me-1" 
                                        onclick="${dotacion.firmado ? 'verFirma(' + dotacion.id_dotacion + ')' : 'firmarDotacion(' + dotacion.id_dotacion + ', \'' + (dotacion.tecnico_nombre || 'Sin asignar') + '\', \'' + (dotacion.cliente || 'N/A') + '\')'}"
                                        title="${dotacion.firmado ? 'Ver Firma' : 'Firmar Dotación'}">
                                    <i class="fas ${dotacion.firmado ? 'fa-eye' : 'fa-signature'}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                mobileContainer.appendChild(card);
            });
        }

        // Variable global para almacenar datos de stock
        let stockDataGlobal = [];

        // Función para actualizar tabla de stock
        function actualizarTablaStock(stockData, tallasData = []) {
            if (!stockData || !Array.isArray(stockData)) {
                console.error('Datos de stock inválidos');
                return;
            }


            
            // Guardar datos globalmente para filtrado
            stockDataGlobal = stockData;

            const tablaBody = document.querySelector('#tablaStock tbody');
            if (!tablaBody) {
                console.error('Elemento tbody de tablaStock no encontrado');
                return;
            }

            // Limpiar tabla
            tablaBody.innerHTML = '';

            // Mapeo de nombres de elementos
            const nombresElementos = {
                'pantalon': 'Pantalón',
                'camisetagris': 'Camiseta Gris',
                'guerrera': 'Guerrera',
                'camisetapolo': 'Camiseta Polo',
                'guantes': 'Guantes',
                'epp': 'EPP',
                'botas': 'Botas',
                'casco': 'Casco',
                'gafas': 'Gafas',
                'gorra': 'Gorra',
                'guantes_carnaza': 'Guantes Carnaza',
                'guantes_nitrilo': 'Guantes Nitrilo'
            };

            // Crear un mapa de datos por tallas para acceso rápido
            const tallasPorTipo = {};
            if (tallasData && Array.isArray(tallasData)) {
                tallasData.forEach(item => {
                    if (!tallasPorTipo[item.tipo_elemento]) {
                        tallasPorTipo[item.tipo_elemento] = [];
                    }
                    // Para botas usar número de calzado, para pantalones usar talla
                    const tallaInfo = item.tipo_elemento === 'botas' && item.numero_calzado ? 
                                     `#${item.numero_calzado}: ${item.stock_disponible}` :
                                     item.tipo_elemento === 'pantalon' && item.talla ?
                                     `T${item.talla}: ${item.stock_disponible}` :
                                     item.talla ? `T${item.talla}: ${item.stock_disponible}` : 
                                     `${item.stock_disponible}`;
                    tallasPorTipo[item.tipo_elemento].push(tallaInfo);
                });
            }

            // Procesar cada elemento de stock
            stockData.forEach(item => {
                const saldo = parseInt(item.saldo_disponible) || 0;
                const stockMinimo = getStockMinimo(item.tipo_elemento);
                const nombreMaterial = nombresElementos[item.tipo_elemento] || item.tipo_elemento;
                
                // Obtener información de tallas
                const tallasInfo = tallasPorTipo[item.tipo_elemento] || [];
                const tallasTexto = tallasInfo.length > 0 ? 
                    `<small class="text-muted">${tallasInfo.join(', ')}</small>` : 
                    '<small class="text-muted">Sin desglose</small>';
                
                let estadoTexto, estadoClase, estadoValue;
                if (saldo === 0) {
                    estadoTexto = 'Sin Stock';
                    estadoClase = 'estado-sin-stock';
                    estadoValue = 'sin-stock';
                } else if (saldo <= stockMinimo) {
                    estadoTexto = 'Stock Bajo';
                    estadoClase = 'estado-stock-bajo';
                    estadoValue = 'stock-bajo';
                } else {
                    estadoTexto = 'Normal';
                    estadoClase = 'estado-normal';
                    estadoValue = 'normal';
                }

                const fila = document.createElement('tr');
                fila.setAttribute('data-tipo', item.tipo_elemento);
                fila.setAttribute('data-estado', estadoValue);
                fila.innerHTML = `
                    <td>${nombreMaterial}</td>
                    <td><strong>${saldo}</strong></td>
                    <td>${stockMinimo}</td>
                    <td>${tallasTexto}</td>
                    <td><span class="${estadoClase}">${estadoTexto}</span></td>
                `;
                
                tablaBody.appendChild(fila);
            });


        }

        // Función para filtrar la tabla de stock
        function filtrarStock() {
            const filtroTipo = document.getElementById('filtroTipoStock').value;
            const filtroEstado = document.getElementById('filtroEstadoStock').value;
            const filas = document.querySelectorAll('#tablaStock tbody tr');

            filas.forEach(fila => {
                const tipoElemento = fila.getAttribute('data-tipo');
                const estadoElemento = fila.getAttribute('data-estado');
                
                let mostrarFila = true;
                
                // Filtrar por tipo
                if (filtroTipo && tipoElemento !== filtroTipo) {
                    mostrarFila = false;
                }
                
                // Filtrar por estado
                if (filtroEstado && estadoElemento !== filtroEstado) {
                    mostrarFila = false;
                }
                
                fila.style.display = mostrarFila ? '' : 'none';
            });
        }

        // Función para limpiar filtros de stock
        function limpiarFiltrosStock() {
            document.getElementById('filtroTipoStock').value = '';
            document.getElementById('filtroEstadoStock').value = '';
            
            // Mostrar todas las filas
            const filas = document.querySelectorAll('#tablaStock tbody tr');
            filas.forEach(fila => {
                fila.style.display = '';
            });
        }

        // Función para cargar datos de la gráfica mensual de movimientos
        function cargarGraficaMovimientos() {
            const ropaTrabajo = document.getElementById('filtroRopaTrabajo').value;
            const epp = document.getElementById('filtroEPP').value;
            const mes = document.getElementById('filtroMes').value;
            const año = document.getElementById('filtroAño').value;
            
            const params = new URLSearchParams();
            if (ropaTrabajo) params.append('elemento', ropaTrabajo);
            if (epp) params.append('elemento', epp);
            if (mes) params.append('mes', mes);
            if (año) params.append('año', año);
            
            fetch(`/api/historial-movimientos-grafica?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && movimientosChart) {
                        movimientosChart.data.labels = data.labels;
                        movimientosChart.data.datasets = data.datasets;
                        movimientosChart.update();
                    } else {
                        console.error('Error en la respuesta de la API:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar gráfica de movimientos:', error);
                });
        }
        
        // Función para inicializar los filtros de la gráfica
        function inicializarFiltrosGrafica() {
            // Llenar selector de años (últimos 3 años)
            const selectAño = document.getElementById('filtroAño');
            const añoActual = new Date().getFullYear();
            
            for (let i = 0; i < 3; i++) {
                const año = añoActual - i;
                const option = document.createElement('option');
                option.value = año;
                option.textContent = año;
                if (i === 0) option.selected = true; // Seleccionar año actual
                selectAño.appendChild(option);
            }
            
            // Llenar selector de meses
            const selectMes = document.getElementById('filtroMes');
            const meses = [
                { value: '', text: 'Todos los meses' },
                { value: añoActual + '-01', text: 'Enero' },
                { value: añoActual + '-02', text: 'Febrero' },
                { value: añoActual + '-03', text: 'Marzo' },
                { value: añoActual + '-04', text: 'Abril' },
                { value: añoActual + '-05', text: 'Mayo' },
                { value: añoActual + '-06', text: 'Junio' },
                { value: añoActual + '-07', text: 'Julio' },
                { value: añoActual + '-08', text: 'Agosto' },
                { value: añoActual + '-09', text: 'Septiembre' },
                { value: añoActual + '-10', text: 'Octubre' },
                { value: añoActual + '-11', text: 'Noviembre' },
                { value: añoActual + '-12', text: 'Diciembre' }
            ];
            
            meses.forEach(mes => {
                const option = document.createElement('option');
                option.value = mes.value;
                option.textContent = mes.text;
                selectMes.appendChild(option);
            });
            
            // Agregar event listeners para los filtros
            document.getElementById('filtroRopaTrabajo').addEventListener('change', cargarGraficaMovimientos);
            document.getElementById('filtroEPP').addEventListener('change', cargarGraficaMovimientos);
            document.getElementById('filtroMes').addEventListener('change', cargarGraficaMovimientos);
            document.getElementById('filtroAño').addEventListener('change', function() {
                // Actualizar opciones de mes cuando cambie el año
                const añoSeleccionado = this.value;
                const selectMes = document.getElementById('filtroMes');
                
                // Limpiar opciones de mes excepto "Todos los meses"
                selectMes.innerHTML = '<option value="">Todos los meses</option>';
                
                // Agregar meses para el año seleccionado
                for (let i = 1; i <= 12; i++) {
                    const option = document.createElement('option');
                    option.value = `${añoSeleccionado}-${i.toString().padStart(2, '0')}`;
                    option.textContent = new Date(añoSeleccionado, i - 1).toLocaleDateString('es-ES', { month: 'long' });
                    selectMes.appendChild(option);
                }
                
                cargarGraficaMovimientos();
            });
        }
        
        // Función para cargar datos de reportes (mantener compatibilidad)
        function cargarReportes() {
            // Cargar la nueva gráfica de movimientos
            cargarGraficaMovimientos();
        }

        // Funciones para la vista visual
        function cambiarVista(tipoVista) {
            const vistaTabla = document.getElementById('vistaTabla');
            const vistaVisual = document.getElementById('vistaVisual');
            const btnTabla = document.getElementById('btnVistaTabla');
            const btnVisual = document.getElementById('btnVistaVisual');
            
            if (tipoVista === 'tabla') {
                vistaTabla.style.display = 'block';
                vistaVisual.style.display = 'none';
                btnTabla.classList.add('active');
                btnVisual.classList.remove('active');
            } else {
                vistaTabla.style.display = 'none';
                vistaVisual.style.display = 'block';
                btnTabla.classList.remove('active');
                btnVisual.classList.add('active');
                generarVistaVisual();
            }
        }
        
        function generarVistaVisual() {
            const contenedor = document.getElementById('contenedorTecnicos');
            contenedor.innerHTML = '';
            
            // Obtener datos filtrados de la tabla
            const filas = document.querySelectorAll('#tablaDotaciones tbody tr:not([style*="display: none"])');
            
            filas.forEach(fila => {
                const celdas = fila.querySelectorAll('td');
                if (celdas.length < 11) return;
                
                const tecnico = {
                    id: celdas[0].textContent.trim(),
                    cliente: celdas[1].textContent.trim(),
                    nombre: celdas[2].textContent.trim(),
                    pantalon: celdas[3].textContent.trim(),
                    camisetagris: celdas[4].textContent.trim(),
                    guerrera: celdas[5].textContent.trim(),
                    camisetapolo: celdas[6].textContent.trim(),
                    guantes: celdas[7].textContent.trim(),
                    epp: celdas[8].textContent.trim(),
                    botas: celdas[9].textContent.trim(),
                    fecha: celdas[10].textContent.trim()
                };
                
                const tarjetaTecnico = crearTarjetaTecnico(tecnico);
                contenedor.appendChild(tarjetaTecnico);
            });
        }
        
        function crearTarjetaTecnico(tecnico) {
            const tarjeta = document.createElement('div');
            tarjeta.className = 'technician-card';
            
            const items = [
                { nombre: 'Pantalón', valor: tecnico.pantalon, icono: 'fas fa-tshirt' },
                { nombre: 'Camiseta Gris', valor: tecnico.camisetagris, icono: 'fas fa-tshirt' },
                { nombre: 'Guerrera', valor: tecnico.guerrera, icono: 'fas fa-vest' },
                { nombre: 'Camiseta Polo', valor: tecnico.camisetapolo, icono: 'fas fa-tshirt' },
                { nombre: 'Guantes', valor: tecnico.guantes, icono: 'fas fa-mitten' },
                { nombre: 'EPP', valor: tecnico.epp, icono: 'fas fa-hard-hat' },
                { nombre: 'Botas', valor: tecnico.botas, icono: 'fas fa-shoe-prints' }
            ];
            
            let itemsHTML = '';
            items.forEach(item => {
                const tieneAsignacion = item.valor && item.valor !== '0 (T: N/A)' && item.valor !== 'N: 0, C: 0';
                const esValorado = item.valor && item.valor.includes('VALORADO');
                
                itemsHTML += `
                    <div class="item-badge ${tieneAsignacion ? 'assigned' : 'not-assigned'}">
                        <i class="${item.icono}"></i>
                        <span class="item-name">${item.nombre}</span>
                        ${tieneAsignacion ? `<span class="badge ${esValorado ? 'badge-valorado' : 'badge-no-valorado'}">${esValorado ? 'VALORADO' : 'NO VALORADO'}</span>` : ''}
                        <small class="item-details">${item.valor || 'Sin asignar'}</small>
                    </div>
                `;
            });
            
            tarjeta.innerHTML = `
                <div class="technician-header">
                    <h6 class="technician-name">${tecnico.nombre}</h6>
                    <small class="technician-client">${tecnico.cliente}</small>
                    <small class="technician-date">Registro: ${tecnico.fecha}</small>
                </div>
                <div class="items-grid">
                    ${itemsHTML}
                </div>
            `;
            
            return tarjeta;
        }

        // Función para ver detalles de dotación
        function verDetallesDotacion(idDotacion) {
            // Mostrar loading
            const modal = new bootstrap.Modal(document.getElementById('modalDetallesDotacion'));
            modal.show();
            
            // Limpiar datos anteriores
            limpiarModalDetalles();
            
            // Realizar petición AJAX para obtener detalles
            fetch(`/api/dotacion_detalle/${idDotacion}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener detalles de la dotación');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    llenarModalDetalles(data.dotacion);
                    // Cargar firma del técnico
                    cargarFirmaTecnico(idDotacion);
                } else {
                    throw new Error(data.message || 'Error al cargar los detalles');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cargar los detalles de la dotación: ' + error.message);
                modal.hide();
            });
        }

        // Función para cargar la firma del técnico
        function cargarFirmaTecnico(idDotacion) {
            console.log('Cargando firma para dotación:', idDotacion);
            
            // Limpiar estado anterior
            document.getElementById('firmaImagen').style.display = 'none';
            document.getElementById('sinFirma').style.display = 'block';
            
            // Realizar petición para obtener la firma
            fetch(`/api/obtener-firma/${idDotacion}`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Respuesta del servidor:', response.status, response.statusText);
                if (response.ok) {
                    return response.json();
                } else if (response.status === 404) {
                    // No hay firma registrada
                    return { success: false, message: 'Sin firma registrada' };
                } else {
                    throw new Error(`Error al obtener la firma: ${response.status}`);
                }
            })
            .then(data => {
                console.log('Datos de firma recibidos:', data);
                if (data.success && data.firma_url) {
                    console.log('Mostrando firma existente');
                    // Mostrar la firma
                    document.getElementById('imagenFirma').src = data.firma_url;
                    document.getElementById('fechaFirma').textContent = data.fecha_firma ? 
                        `Firmado el: ${data.fecha_firma}` : 
                        'Fecha no disponible';
                    document.getElementById('firmaImagen').style.display = 'block';
                    document.getElementById('sinFirma').style.display = 'none';
                } else {
                    console.log('Sin firma registrada o error:', data.message);
                    // Sin firma registrada
                    document.getElementById('firmaImagen').style.display = 'none';
                    document.getElementById('sinFirma').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error al cargar firma:', error);
                // Mostrar sin firma en caso de error
                document.getElementById('firmaImagen').style.display = 'none';
                document.getElementById('sinFirma').style.display = 'block';
            });
        }

        // Función para limpiar el modal de detalles
        function limpiarModalDetalles() {
            // Información del técnico
            document.getElementById('detalleTecnicoNombre').textContent = 'Cargando...';
            document.getElementById('detalleTecnicoCedula').textContent = 'Cargando...';
            document.getElementById('detalleTecnicoCliente').textContent = 'Cargando...';
            
            // Elementos de dotación
            const elementos = [
                'Pantalon', 'CamisetaGris', 'Guerrera', 'CamisetaPolo',
                'GuantesNitrilo', 'GuantesCarnaza', 'Gafas', 'Gorra', 'Casco', 'Botas'
            ];
            
            elementos.forEach(elemento => {
                const cantidadEl = document.getElementById(`detalle${elemento}`);
                const tallaEl = document.getElementById(`detalle${elemento}Talla`);
                const estadoEl = document.getElementById(`detalle${elemento}Estado`);
                
                if (cantidadEl) cantidadEl.textContent = '-';
                if (tallaEl) tallaEl.textContent = '-';
                if (estadoEl) {
                    estadoEl.textContent = '-';
                    estadoEl.className = 'badge ms-2';
                }
            });
            
            document.getElementById('detalleFechaRegistro').textContent = 'Cargando...';
            
            // Limpiar sección de firma
            document.getElementById('firmaImagen').style.display = 'none';
            document.getElementById('sinFirma').style.display = 'block';
            document.getElementById('imagenFirma').src = '';
            document.getElementById('fechaFirma').textContent = '-';
        }

        // Función para llenar el modal con los detalles
        function llenarModalDetalles(dotacion) {
            // Información del técnico
            document.getElementById('detalleTecnicoNombre').textContent = dotacion.tecnico_nombre || '-';
            document.getElementById('detalleTecnicoCedula').textContent = dotacion.tecnico_cedula || '-';
            document.getElementById('detalleTecnicoCliente').textContent = dotacion.cliente_nombre || '-';
            
            // Función auxiliar para mostrar elemento
            function mostrarElemento(nombre, cantidad, talla, valorado) {
                const cantidadEl = document.getElementById(`detalle${nombre}`);
                const tallaEl = document.getElementById(`detalle${nombre}Talla`);
                const estadoEl = document.getElementById(`detalle${nombre}Estado`);
                
                if (cantidadEl) {
                    cantidadEl.textContent = cantidad > 0 ? cantidad : 'No asignado';
                }
                
                if (tallaEl && talla) {
                    tallaEl.textContent = `(Talla: ${talla})`;
                } else if (tallaEl) {
                    tallaEl.textContent = '';
                }
                
                if (estadoEl) {
                    if (cantidad > 0) {
                        if (valorado === 1) {
                            estadoEl.textContent = 'VALORADO';
                            estadoEl.className = 'badge bg-success ms-2';
                        } else {
                            estadoEl.textContent = 'NO VALORADO';
                            estadoEl.className = 'badge bg-info ms-2';
                        }
                    } else {
                        estadoEl.textContent = 'NO ASIGNADO';
                        estadoEl.className = 'badge bg-secondary ms-2';
                    }
                }
            }
            
            // Mostrar elementos de ropa
            mostrarElemento('Pantalon', dotacion.pantalon_cantidad || 0, dotacion.pantalon_talla, dotacion.pantalon_valorado);
            mostrarElemento('CamisetaGris', dotacion.camiseta_gris_cantidad || 0, dotacion.camiseta_gris_talla, dotacion.camiseta_gris_valorado);
            mostrarElemento('Guerrera', dotacion.guerrera_cantidad || 0, dotacion.guerrera_talla, dotacion.guerrera_valorado);
            mostrarElemento('Chaqueta', dotacion.chaqueta_cantidad || 0, dotacion.chaqueta_talla, dotacion.chaqueta_valorado);
            mostrarElemento('CamisetaPolo', dotacion.camiseta_polo_cantidad || 0, dotacion.camiseta_polo_talla, dotacion.camiseta_polo_valorado);
            
            // Mostrar EPP
            mostrarElemento('GuantesNitrilo', dotacion.guantes_nitrilo_cantidad || 0, null, dotacion.guantes_nitrilo_valorado);
            mostrarElemento('GuantesCarnaza', dotacion.guantes_carnaza_cantidad || 0, null, dotacion.guantes_carnaza_valorado);
            mostrarElemento('Gafas', dotacion.gafas_cantidad || 0, null, dotacion.gafas_valorado);
            mostrarElemento('Gorra', dotacion.gorra_cantidad || 0, null, dotacion.gorra_valorado);
            mostrarElemento('Casco', dotacion.casco_cantidad || 0, null, dotacion.casco_valorado);
            mostrarElemento('Botas', dotacion.botas_cantidad || 0, dotacion.botas_talla, dotacion.botas_valorado);
            
            // Fecha de registro
            if (dotacion.fecha_registro) {
                const fecha = new Date(dotacion.fecha_registro);
                document.getElementById('detalleFechaRegistro').textContent = fecha.toLocaleDateString('es-ES');
            } else {
                document.getElementById('detalleFechaRegistro').textContent = '-';
            }
        }

        // Variables globales para stock por estado
        let stockPorEstado = {};

        // Función para cargar stock por estado de valoración
        function cargarStockPorEstado() {
            fetch('/api/stock_por_estado')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        stockPorEstado = data.stock;
                        actualizarIndicadoresStock();
                    } else {
                        console.error('Error al cargar stock por estado:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar stock por estado:', error);
                });
        }

        // Función para actualizar indicadores de stock en el formulario
        function actualizarIndicadoresStock() {
            const elementos = {
                'pantalon': 'stockPantalon',
                'camisetagris': 'stockCamisetagris', 
                'guerrera': 'stockGuerrera',
                'chaqueta': 'stockChaqueta',
                'camisetapolo': 'stockCamisetapolo',
                'guantes_nitrilo': 'stockGuantesNitrilo',
                'guantes_carnaza': 'stockGuantesCarnaza',
                'gafas': 'stockGafas'
            };

            Object.keys(elementos).forEach(elemento => {
                const stockElement = document.getElementById(elementos[elemento]);
                if (stockElement && stockPorEstado[elemento]) {
                    const valorado = stockPorEstado[elemento]['VALORADO'] || 0;
                    const noValorado = stockPorEstado[elemento]['NO VALORADO'] || 0;
                    stockElement.innerHTML = `Stock: <span class="text-success">Valorado: ${valorado}</span> | <span class="text-info">No Valorado: ${noValorado}</span>`;
                } else if (stockElement) {
                    stockElement.innerHTML = 'Stock: <span class="text-muted">No disponible</span>';
                }
            });
        }

        // Función para validar stock disponible al cambiar cantidad
        function validarStockDisponible(elemento) {
            const input = document.getElementById(elemento === 'guantes_nitrilo' ? 'guantesNitrilo' : 
                                                elemento === 'guantes_carnaza' ? 'guantesCarnaza' : elemento);
            
            // Mapear correctamente los IDs de los checkboxes
            let checkboxId;
            if (elemento === 'botas') {
                checkboxId = 'estadoBotas';
            } else if (elemento === 'guantes_nitrilo') {
                checkboxId = 'estadoGuantesNitrilo';
            } else if (elemento === 'guantes_carnaza') {
                checkboxId = 'estadoGuantesCarnaza';
            } else {
                checkboxId = 'estado' + elemento.charAt(0).toUpperCase() + elemento.slice(1);
            }
            
            const checkbox = document.getElementById(checkboxId);
            const cantidad = parseInt(input.value) || 0;
            
            if (cantidad > 0 && stockPorEstado[elemento]) {
                const esValorado = checkbox && checkbox.checked;
                const estadoSeleccionado = esValorado ? 'VALORADO' : 'NO VALORADO';
                const stockDisponible = stockPorEstado[elemento][estadoSeleccionado] || 0;
                
                if (cantidad > stockDisponible) {
                    input.classList.add('is-invalid');
                    mostrarError(`Stock insuficiente para ${elemento} ${estadoSeleccionado}. Disponible: ${stockDisponible}`);
                    input.value = stockDisponible;
                } else {
                    input.classList.remove('is-invalid');
                }
            } else {
                input.classList.remove('is-invalid');
            }
        }

        // Función para validar formulario antes de envío
        function validarFormularioCompleto() {
            const elementos = {
                'pantalon': 'pantalon',
                'camisetagris': 'camisetagris',
                'guerrera': 'guerrera',
                'chaqueta': 'chaqueta',
                'camisetapolo': 'camisetapolo',
                'guantes_nitrilo': 'guantesNitrilo',
                'guantes_carnaza': 'guantesCarnaza',
                'gafas': 'gafas',
                'gorra': 'gorra',
                'casco': 'casco',
                'botas': 'botas'
            };

            let errores = [];
            
            Object.keys(elementos).forEach(elemento => {
                const input = document.getElementById(elementos[elemento]);
                
                // Mapear correctamente los IDs de los checkboxes
                let checkboxId;
                if (elemento === 'botas') {
                    checkboxId = 'estadoBotas';
                } else if (elemento === 'guantes_nitrilo') {
                    checkboxId = 'estadoGuantesNitrilo';
                } else if (elemento === 'guantes_carnaza') {
                    checkboxId = 'estadoGuantesCarnaza';
                } else {
                    checkboxId = 'estado' + elemento.charAt(0).toUpperCase() + elemento.slice(1);
                }
                
                const checkbox = document.getElementById(checkboxId);
                const cantidad = parseInt(input.value) || 0;
                
                if (cantidad > 0 && stockPorEstado[elemento]) {
                    const esValorado = checkbox && checkbox.checked;
                    const estadoSeleccionado = esValorado ? 'VALORADO' : 'NO VALORADO';
                    const stockDisponible = stockPorEstado[elemento][estadoSeleccionado] || 0;
                    
                    if (cantidad > stockDisponible) {
                        errores.push(`${elemento}: Stock insuficiente para ${estadoSeleccionado}. Solicitado: ${cantidad}, Disponible: ${stockDisponible}`);
                    }
                }
            });
            
            if (errores.length > 0) {
                mostrarError('Errores de stock:\n' + errores.join('\n'));
                return false;
            }
            
            return true;
        }

        // Funciones de utilidad
        function mostrarExito(mensaje) {
            // Implementar notificación de éxito
            alert(mensaje);
        }

        function mostrarError(mensaje) {
            // Implementar notificación de error
            alert(mensaje);
        }

        // Función para refrescar el stock de dotaciones
        function refreshStock() {
            const btnRefresh = document.getElementById('btnRefreshStock');
            const originalText = btnRefresh.innerHTML;
            
            // Mostrar estado de carga
            btnRefresh.disabled = true;
            btnRefresh.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualizando...';
            
            // Llamar al endpoint de refresh
            fetch('/api/refresh-stock-dotaciones', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mostrar mensaje de éxito
                    mostrarExito(data.message);
                    
                    // Recargar los datos de stock
                    cargarDatosStock();
                    cargarStockPorEstado();
                    
                    // Actualizar estadísticas y gráficos
                    cargarDatos();
                    
                    // Log de información para debugging
                    console.log('Stock actualizado:', data.stock_actualizado);
                    
                } else {
                    mostrarError('Error al actualizar stock: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error al refrescar stock:', error);
                mostrarError('Error de conexión al actualizar el stock');
            })
            .finally(() => {
                // Restaurar el botón
                btnRefresh.disabled = false;
                btnRefresh.innerHTML = originalText;
            });
        }

        // Variables globales para la firma digital
        let canvas, ctx, isDrawing = false;
        let lastX = 0, lastY = 0;

        // Función para abrir el modal de firma
        function firmarDotacion(idDotacion, tecnicoNombre, cliente) {
            console.log('Iniciando firma para dotación:', idDotacion);
            
            // Establecer los datos en el modal
            document.getElementById('firmaIdDotacion').value = idDotacion;
            document.getElementById('firmaTecnicoNombre').textContent = tecnicoNombre;
            document.getElementById('firmaClienteNombre').textContent = cliente;
            
            // Mostrar el modal primero
            $('#modalFirmaDigital').modal('show');
            
            // Esperar a que el modal se muestre completamente antes de inicializar el canvas
            $('#modalFirmaDigital').on('shown.bs.modal', function() {
                console.log('Modal mostrado, inicializando canvas...');
                
                // Inicializar el canvas
                canvas = document.getElementById('canvasFirma');
                if (!canvas) {
                    console.error('Canvas no encontrado!');
                    return;
                }
                
                console.log('Canvas encontrado:', canvas);
                
                // Configurar dimensiones del canvas
                const container = canvas.parentElement;
                const containerWidth = container.clientWidth - 20; // Margen
                const containerHeight = 300; // Altura fija
                
                // Establecer dimensiones del canvas
                canvas.width = containerWidth;
                canvas.height = containerHeight;
                canvas.style.width = containerWidth + 'px';
                canvas.style.height = containerHeight + 'px';
                canvas.style.border = '1px solid #ccc';
                canvas.style.cursor = 'crosshair';
                
                console.log('Dimensiones del canvas configuradas:', canvas.width, 'x', canvas.height);
                
                ctx = canvas.getContext('2d');
                if (!ctx) {
                    console.error('No se pudo obtener el contexto 2D del canvas!');
                    return;
                }
                
                console.log('Contexto 2D obtenido correctamente');
                
                // Configurar el canvas
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                // Limpiar el canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Agregar fondo blanco
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Restaurar color de trazo
                ctx.strokeStyle = '#000';
                
                console.log('Canvas configurado y limpio');
                
                // Remover event listeners previos para evitar duplicados
                canvas.removeEventListener('mousedown', startDrawing);
                canvas.removeEventListener('mousemove', draw);
                canvas.removeEventListener('mouseup', stopDrawing);
                canvas.removeEventListener('mouseout', stopDrawing);
                canvas.removeEventListener('touchstart', handleTouch);
                canvas.removeEventListener('touchmove', handleTouch);
                canvas.removeEventListener('touchend', stopDrawing);
                
                // Agregar event listeners para dibujar
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                
                // Event listeners para dispositivos táctiles
                canvas.addEventListener('touchstart', handleTouch, { passive: false });
                canvas.addEventListener('touchmove', handleTouch, { passive: false });
                canvas.addEventListener('touchend', stopDrawing, { passive: false });
                
                console.log('Event listeners agregados al canvas');
                
                // Prueba de dibujo para verificar que funciona
                console.log('Realizando prueba de dibujo...');
                ctx.beginPath();
                ctx.moveTo(10, 10);
                ctx.lineTo(50, 50);
                ctx.stroke();
                console.log('Prueba de dibujo completada - debería verse una línea diagonal');
                
                // Remover este event listener para evitar múltiples ejecuciones
                $('#modalFirmaDigital').off('shown.bs.modal');
            });
        }

        // Funciones para manejar el dibujo en el canvas
        function startDrawing(e) {
            console.log('Iniciando dibujo...');
            isDrawing = true;
            [lastX, lastY] = getMousePos(e);
            console.log('Posición inicial:', lastX, lastY);
        }

        function draw(e) {
            if (!isDrawing) return;
            
            const [currentX, currentY] = getMousePos(e);
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            [lastX, lastY] = [currentX, currentY];
        }

        function stopDrawing() {
            console.log('Deteniendo dibujo...');
            isDrawing = false;
        }

        function getMousePos(e) {
            if (!canvas) {
                console.error('Canvas no disponible en getMousePos');
                return [0, 0];
            }
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return [
                (e.clientX - rect.left) * scaleX,
                (e.clientY - rect.top) * scaleY
            ];
        }

        function handleTouch(e) {
            e.preventDefault();
            console.log('Evento táctil:', e.type);
            if (e.touches && e.touches.length > 0) {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
        }

        // Función para limpiar la firma
        function limpiarFirma() {
            if (ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // Función para guardar la firma
        function guardarFirma() {
            const idDotacion = document.getElementById('firmaIdDotacion').value;
            
            // Verificar que hay algo dibujado en el canvas
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const hasDrawing = imageData.data.some((channel, index) => {
                return index % 4 === 3 && channel !== 0; // Verificar canal alpha
            });
            
            if (!hasDrawing) {
                mostrarError('Por favor, dibuje su firma antes de guardar.');
                return;
            }
            
            // Convertir canvas a base64
            const firmaBase64 = canvas.toDataURL('image/png');
            
            // Mostrar estado de carga
            const btnGuardar = document.querySelector('#modalFirmaDigital .btn-primary');
            const originalText = btnGuardar.innerHTML;
            btnGuardar.disabled = true;
            btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
            
            // Enviar la firma al servidor
            fetch('/api/firmar-dotacion', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_dotacion: idDotacion,
                    firma_base64: firmaBase64
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarExito('Firma guardada exitosamente');
                    $('#modalFirmaDigital').modal('hide');
                    
                    // Recargar la tabla para mostrar el estado actualizado
                    if (typeof table !== 'undefined' && table.ajax) {
                        table.ajax.reload();
                    } else {
                        location.reload();
                    }
                } else {
                    mostrarError('Error al guardar la firma: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error al guardar firma:', error);
                mostrarError('Error de conexión al guardar la firma');
            })
            .finally(() => {
                // Restaurar el botón
                btnGuardar.disabled = false;
                btnGuardar.innerHTML = originalText;
            });
        }

        // Función para ver firma existente
        function verFirma(idDotacion, tecnicoNombre, cliente) {
            // Mostrar estado de carga
            mostrarInfo('Cargando firma...');
            
            // Solicitar la firma al servidor
            fetch(`/api/obtener-firma/${idDotacion}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.firma_imagen) {
                    // Establecer los datos en el modal
                    document.getElementById('verFirmaIdDotacion').textContent = idDotacion;
                    document.getElementById('verFirmaTecnicoNombre').textContent = tecnicoNombre;
                    document.getElementById('verFirmaCliente').textContent = cliente;
                    document.getElementById('verFirmaFecha').textContent = data.fecha_firma || 'No disponible';
                    document.getElementById('verFirmaUsuario').textContent = data.usuario_firma || 'No disponible';
                    
                    // Mostrar la imagen de la firma
                    const imgFirma = document.getElementById('imagenFirma');
                    imgFirma.src = data.firma_imagen;
                    imgFirma.style.display = 'block';
                    
                    // Mostrar el modal
                    $('#modalVerFirma').modal('show');
                } else {
                    mostrarError('No se pudo cargar la firma: ' + (data.message || 'Firma no encontrada'));
                }
            })
            .catch(error => {
                console.error('Error al cargar firma:', error);
                mostrarError('Error de conexión al cargar la firma');
            });
        }

        // Inicializar cuando se carga la página
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar DataTable usando la función dedicada
            inicializarTabla();

            // Cargar datos iniciales
            cargarDatos();
            
            // Cargar técnicos
            cargarTecnicos();
            
            // Inicializar gráficos
            inicializarGraficos();
            
            // Inicializar filtros de la gráfica
            inicializarFiltrosGrafica();
            
            // Cargar datos de stock para los gráficos
            cargarDatosStock();
            
            // Cargar stock por estado de valoración
            cargarStockPorEstado();
            
            // Cargar reportes
            cargarReportes();
            
            // Agregar validación al formulario de dotación
             const formDotacion = document.getElementById('formDotacion');
             if (formDotacion) {
                 formDotacion.addEventListener('submit', function(e) {
                     if (!validarFormularioCompleto()) {
                         e.preventDefault();
                         return false;
                     }
                 });
             }
             
             // Nota: inicializarModalCambios() pertenece al módulo de cambios_dotacion.html
        });
        
        // ===== FUNCIONES PARA EL MODAL DE CAMBIOS DE DOTACIÓN =====
        
    </script>
{% endblock %}