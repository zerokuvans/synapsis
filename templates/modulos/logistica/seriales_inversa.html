{% extends "base.html" %}

{% block title %}Seriales Inversa{% endblock %}

{% block extra_css %}
<style>
  .upload-card { border: 1px solid #dee2e6; border-radius: 0.375rem; }
  .upload-area { border: 2px dashed #dee2e6; border-radius: 0.375rem; padding: 1.5rem; text-align: center; cursor: pointer; }
  .upload-area:hover { border-color: #0d6efd; background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-retweet me-2"></i>Seriales Inversa</h2>
        <nav aria-label="breadcrumb">
          
        </nav>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card upload-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i>Cargar base</h5>
          <button id="btnEnviarArchivo" class="btn btn-primary"><i class="fas fa-upload me-2"></i>Cargar</button>
        </div>
        <div class="card-body">
          <div class="upload-area" onclick="document.getElementById('archivoBase').click()">
            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
            <div>Seleccione archivo CSV o Excel</div>
            <input id="archivoBase" type="file" accept=".csv,.xlsx,.xls" style="display:none">
            <div id="archivoNombre" class="mt-2 text-muted"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="fas fa-table me-2"></i>Registros</div>
        <div class="card-body">
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <select id="filtroTecnico" class="form-select">
                <option value="">Todos los técnicos</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="filtroObservacion" class="form-select">
                <option value="">Todas las observaciones</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="filtroSuper" class="form-select">
                <option value="">Todos los supervisores</option>
              </select>
            </div>
            <div class="col-md-3">
              <input id="filtroDesde" type="date" class="form-control" placeholder="Desde">
            </div>
            <div class="col-md-3">
              <input id="filtroHasta" type="date" class="form-control" placeholder="Hasta">
            </div>
            <div class="col-md-2 d-grid d-md-block">
              <button id="btnBuscar" class="btn btn-primary me-2"><i class="fas fa-search me-1"></i>Buscar</button>
              <button id="btnLimpiar" class="btn btn-secondary"><i class="fas fa-eraser me-1"></i>Limpiar</button>
            </div>
          </div>
          <table id="tablaSerialesInversa" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr>
                <th>lapso</th>
                <th>recurso_operativo_cedula</th>
                <th>cuenta</th>
                <th>dia</th>
                <th>mes</th>
                <th>descripcion</th>
                <th>observacion_diana</th>
                <th>serial_rr</th>
                <th>tecnico</th>
                <th>super</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <hr class="my-4">
          <div class="mt-3">
            <h5 class="mb-3"><i class="fas fa-user-clock me-2"></i>Técnicos con pendientes</h5>
            <div class="table-responsive">
              <table class="table table-sm table-striped" id="tablaPendientesTecnicos">
                <thead>
                  <tr>
                    <th>técnico</th>
                    <th>supervisor</th>
                    <th>pendientes</th>
                    <th>desbloqueo hasta</th>
                    <th>extensiones mes</th>
                    <th>último por</th>
                    <th>acción</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  var dt;
  function initTabla() {
    $.fn.dataTable.ext.errMode = 'throw';
    dt = $('#tablaSerialesInversa').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '/logistica/seriales_inversa/list',
        dataSrc: 'data',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        data: function(d){
          d.tecnico = document.getElementById('filtroTecnico').value || '';
          d.observacion_diana = document.getElementById('filtroObservacion').value || '';
          d.supervisor = document.getElementById('filtroSuper').value || '';
          d.fecha_desde = document.getElementById('filtroDesde').value || '';
          d.fecha_hasta = document.getElementById('filtroHasta').value || '';
          return d;
        }
      },
      pageLength: 10,
      lengthMenu: [[10,25,50,100,200],[10,25,50,100,200]],
      columns: [
        { data: 'lapso' },
        { data: 'recurso_operativo_cedula' },
        { data: 'cuenta' },
        { data: 'dia' },
        { data: 'mes' },
        { data: 'descripcion' },
        { data: 'observacion_diana' },
        { data: 'serial_rr' },
        { data: 'tecnico' },
        { data: 'super' }
      ]
    });
  }
  document.addEventListener('DOMContentLoaded', function() {
    initTabla();
    fetch('/logistica/seriales_inversa/tecnicos', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.json())
      .then(j => { if (j && j.success && Array.isArray(j.tecnicos)){ var sel = document.getElementById('filtroTecnico'); j.tecnicos.forEach(function(n){ var opt = document.createElement('option'); opt.value=n; opt.textContent=n; sel.appendChild(opt); }); } });
    fetch('/logistica/seriales_inversa/observaciones', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.json())
      .then(j => { if (j && j.success && Array.isArray(j.observaciones)){ var so = document.getElementById('filtroObservacion'); j.observaciones.forEach(function(o){ var opt = document.createElement('option'); opt.value=o; opt.textContent=o; so.appendChild(opt); }); } });
    fetch('/logistica/seriales_inversa/supervisores', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.json())
      .then(j => { if (j && j.success && Array.isArray(j.supervisores)){ var ss = document.getElementById('filtroSuper'); j.supervisores.forEach(function(sv){ var opt = document.createElement('option'); opt.value=sv; opt.textContent=sv; ss.appendChild(opt); }); } });
    document.getElementById('btnBuscar').addEventListener('click', function(){ dt.ajax.reload(); });
    document.getElementById('btnLimpiar').addEventListener('click', function(){ document.getElementById('filtroTecnico').value=''; document.getElementById('filtroObservacion').value=''; document.getElementById('filtroSuper').value=''; document.getElementById('filtroDesde').value=''; document.getElementById('filtroHasta').value=''; dt.ajax.reload(); });
    document.getElementById('filtroTecnico').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroObservacion').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroSuper').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroDesde').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroHasta').addEventListener('change', function(){ dt.ajax.reload(); });
    var input = document.getElementById('archivoBase');
    var nombre = document.getElementById('archivoNombre');
    var btn = document.getElementById('btnEnviarArchivo');
    input.addEventListener('change', function(){
      nombre.textContent = input.files && input.files[0] ? input.files[0].name : '';
    });
    btn.addEventListener('click', function(){
      if (!input.files || !input.files[0]) { Swal.fire('Selecciona un archivo','','warning'); return; }
      var fd = new FormData();
      fd.append('archivo', input.files[0]);
      fetch('/logistica/seriales_inversa/upload', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(j => {
          if (j.success) { Swal.fire('Carga completada', j.message || '', 'success'); dt.ajax.reload(null, false); input.value=''; nombre.textContent=''; }
          else { Swal.fire('Error', j.message || 'Error al cargar', 'error'); }
        })
        .catch(() => Swal.fire('Error','Error de conexión','error'));
    });

    function cargarPendientesTecnicos(){
      fetch('/logistica/seriales_inversa/pending_summary?_=' + Date.now(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }, cache: 'no-store' })
        .then(r => r.json())
        .then(j => {
          var tbody = document.querySelector('#tablaPendientesTecnicos tbody');
          if (!tbody) return;
          tbody.innerHTML = '';
          var items = (j && j.items) ? j.items : [];
          items.forEach(function(row){
            var tr = document.createElement('tr');
            var tdTec = document.createElement('td'); tdTec.textContent = row.tecnico_nombre || '';
            var tdSup = document.createElement('td'); tdSup.textContent = row.supervisor || '';
            var tdCnt = document.createElement('td'); tdCnt.textContent = String(row.cantidad || 0);
            var tdExp = document.createElement('td'); tdExp.textContent = row.unlock_expires_at ? (row.unlock_expires_at + ' (Bogotá)') : '';
            var tdExt = document.createElement('td'); tdExt.textContent = String(row.extensiones_mes || 0);
            var tdUlt = document.createElement('td'); tdUlt.textContent = row.ultimo_por || '';
            var tdAcc = document.createElement('td');
            var btn = document.createElement('button');
            btn.className = 'btn btn-sm btn-warning';
            btn.textContent = 'Extender +24h';
            if ((row.extensiones_mes || 0) >= 2){ btn.disabled = true; btn.title = 'Límite mensual alcanzado'; }
            btn.addEventListener('click', function(){
              var fd = new FormData(); fd.append('cedula', row.cedula || '');
              fetch('/logistica/seriales_inversa/unlock?_=' + Date.now(), { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                .then(r => r.json())
                .then(x => { if (x && x.success){ Swal.fire('Listo','Se concedieron 24h adicionales','success'); cargarPendientesTecnicos(); if (dt) dt.ajax.reload(null, false); try { window.dispatchEvent(new CustomEvent('SI_UNLOCK_DONE')); } catch(e){} } else { Swal.fire('Error', (x && x.message) ? x.message : 'No se pudo desbloquear','error'); } })
                .catch(() => Swal.fire('Error','Error de conexión','error'));
            });
            tdAcc.appendChild(btn);
            tr.appendChild(tdTec); tr.appendChild(tdSup); tr.appendChild(tdCnt); tr.appendChild(tdExp); tr.appendChild(tdExt); tr.appendChild(tdUlt); tr.appendChild(tdAcc);
            tbody.appendChild(tr);
          });
        })
        .catch(function(){});
    }
    cargarPendientesTecnicos();
  });
</script>
{% endblock %}
