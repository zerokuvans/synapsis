{% extends "base.html" %}

{% block title %}Seriales Inversa{% endblock %}

{% block extra_css %}
<style>
  .upload-card { border: 1px solid #dee2e6; border-radius: 0.375rem; }
  .upload-area { border: 2px dashed #dee2e6; border-radius: 0.375rem; padding: 1.5rem; text-align: center; cursor: pointer; }
  .upload-area:hover { border-color: #0d6efd; background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-retweet me-2"></i>Seriales Inversa</h2>
        <nav aria-label="breadcrumb">
          
        </nav>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card upload-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i>Cargar base</h5>
          <button id="btnEnviarArchivo" class="btn btn-primary"><i class="fas fa-upload me-2"></i>Cargar</button>
        </div>
        <div class="card-body">
          <div class="upload-area" onclick="document.getElementById('archivoBase').click()">
            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
            <div>Seleccione archivo CSV o Excel</div>
            <input id="archivoBase" type="file" accept=".csv,.xlsx,.xls" style="display:none">
            <div id="archivoNombre" class="mt-2 text-muted"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="fas fa-table me-2"></i>Registros</div>
        <div class="card-body">
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <select id="filtroTecnico" class="form-select">
                <option value="">Todos los técnicos</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="filtroObservacion" class="form-select">
                <option value="">Todas las observaciones</option>
              </select>
            </div>
            <div class="col-md-3">
              <select id="filtroSuper" class="form-select">
                <option value="">Todos los supervisores</option>
              </select>
            </div>
            <div class="col-md-3">
              <input id="filtroDesde" type="date" class="form-control" placeholder="Desde">
            </div>
            <div class="col-md-3">
              <input id="filtroHasta" type="date" class="form-control" placeholder="Hasta">
            </div>
            <div class="col-md-2 d-grid d-md-block">
              <button id="btnBuscar" class="btn btn-primary me-2"><i class="fas fa-search me-1"></i>Buscar</button>
              <button id="btnLimpiar" class="btn btn-secondary"><i class="fas fa-eraser me-1"></i>Limpiar</button>
            </div>
          </div>
          <table id="tablaSerialesInversa" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr>
                <th>lapso</th>
                <th>recurso_operativo_cedula</th>
                <th>cuenta</th>
                <th>dia</th>
                <th>mes</th>
                <th>descripcion</th>
                <th>observacion_diana</th>
                <th>serial_rr</th>
                <th>tecnico</th>
                <th>super</th>
                <th>acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <hr class="my-4">
          <div class="mt-3">
            <h5 class="mb-3"><i class="fas fa-user-clock me-2"></i>Técnicos con pendientes</h5>
            <div class="table-responsive">
              <table class="table table-sm table-striped" id="tablaPendientesTecnicos">
                <thead>
                  <tr>
                    <th>técnico</th>
                    <th>supervisor</th>
                    <th>pendientes</th>
                    <th>desbloqueo hasta</th>
                    <th>extensiones mes</th>
                    <th>último por</th>
                    <th>acción</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            
          </div>
          <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-users me-2"></i>Cantidad x supervisor</h5>
            <div class="table-responsive">
              <table class="table table-sm table-striped" id="tablaResumenSupervisores">
                <thead>
                  <tr>
                    <th>supervisor</th>
                    <th>técnicos con pendientes</th>
                    <th>cantidad total</th>
                    <th>cantidad pendientes</th>
                    <th>cantidad entregado</th>
                    <th>cantidad descontar</th>
                    <th>otros estados</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  var dt;
  var pendientesItems = [];
  var dtPendientes;
  var observacionesLista = [];
  var editObsCurrent = { id: null, serial: null };
  var modalEditar = null;
  function initPendientes(){
    if ($.fn.DataTable.isDataTable('#tablaPendientesTecnicos')) return;
    dtPendientes = $('#tablaPendientesTecnicos').DataTable({
      paging: true,
      pageLength: 10,
      lengthMenu: [[10,25,50,100,200],[10,25,50,100,200]],
      order: [[2, 'desc']],
      data: pendientesItems,
      columns: [
        { data: 'tecnico_nombre', defaultContent: '' },
        { data: 'supervisor', defaultContent: '' },
        { data: 'cantidad', render: function(d,type){ return (type==='sort'||type==='type') ? Number(d||0) : String(d||0); } },
        { data: 'unlock_expires_at', render: function(d,type){ return (type==='sort'||type==='type') ? (d||'') : (d ? (d + ' (Bogotá)') : ''); } },
        { data: 'extensiones_mes', render: function(d,type){ return (type==='sort'||type==='type') ? Number(d||0) : String(d||0); } },
        { data: 'ultimo_por', defaultContent: '' },
        { data: null, orderable: false, render: function(_d,_t,row){ var dis = ((row.extensiones_mes||0) >= 2) ? 'disabled title="Límite mensual alcanzado"' : ''; var ced = row.cedula || ''; return '<button class="btn btn-sm btn-warning btn-unlock" data-cedula="'+ced+'" '+dis+'>Extender +24h</button>'; } }
      ]
    });
  }
  function initTabla() {
    $.fn.dataTable.ext.errMode = 'throw';
    dt = $('#tablaSerialesInversa').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '/logistica/seriales_inversa/list',
        dataSrc: 'data',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        data: function(d){
          d.tecnico = document.getElementById('filtroTecnico').value || '';
          d.observacion_diana = document.getElementById('filtroObservacion').value || '';
          d.supervisor = document.getElementById('filtroSuper').value || '';
          d.fecha_desde = document.getElementById('filtroDesde').value || '';
          d.fecha_hasta = document.getElementById('filtroHasta').value || '';
          return d;
        }
      },
      pageLength: 10,
      lengthMenu: [[10,25,50,100,200],[10,25,50,100,200]],
      columns: [
        { data: 'lapso' },
        { data: 'recurso_operativo_cedula' },
        { data: 'cuenta' },
        { data: 'dia' },
        { data: 'mes' },
        { data: 'descripcion' },
        { data: 'observacion_diana' },
        { data: 'serial_rr' },
        { data: 'tecnico' },
        { data: 'super' },
        { data: null, orderable: false, searchable: false, render: function(d,t,r){ var id = r.id || ''; var serial = r.serial_rr || ''; var obs = (r.observacion_diana || '').replace(/"/g,'&quot;'); return '<button class="btn btn-sm btn-primary si-edit-obs" data-id="'+id+'" data-serial="'+serial+'" data-obs="'+obs+'"><i class="fas fa-edit me-1"></i>Editar</button>'; } }
      ]
    });
  }
  document.addEventListener('DOMContentLoaded', function() {
    initTabla();
    fetch('/logistica/seriales_inversa/tecnicos', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.json())
      .then(j => { if (j && j.success && Array.isArray(j.tecnicos)){ var sel = document.getElementById('filtroTecnico'); j.tecnicos.forEach(function(n){ var opt = document.createElement('option'); opt.value=n; opt.textContent=n; sel.appendChild(opt); }); } });
    fetch('/logistica/seriales_inversa/observaciones', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.json())
      .then(j => { if (j && j.success && Array.isArray(j.observaciones)){ observacionesLista = j.observaciones; var so = document.getElementById('filtroObservacion'); observacionesLista.forEach(function(o){ var opt = document.createElement('option'); opt.value=o; opt.textContent=o; so.appendChild(opt); }); var sel = document.getElementById('selObservacion'); if (sel){ sel.innerHTML = '<option value="">Selecciona...</option>'; observacionesLista.forEach(function(o){ var opt = document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); }); } } });
    fetch('/logistica/seriales_inversa/supervisores', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.json())
      .then(j => { if (j && j.success && Array.isArray(j.supervisores)){ var ss = document.getElementById('filtroSuper'); j.supervisores.forEach(function(sv){ var opt = document.createElement('option'); opt.value=sv; opt.textContent=sv; ss.appendChild(opt); }); } });
    document.getElementById('btnBuscar').addEventListener('click', function(){ dt.ajax.reload(); });
    document.getElementById('btnLimpiar').addEventListener('click', function(){ document.getElementById('filtroTecnico').value=''; document.getElementById('filtroObservacion').value=''; document.getElementById('filtroSuper').value=''; document.getElementById('filtroDesde').value=''; document.getElementById('filtroHasta').value=''; dt.ajax.reload(); });
    document.getElementById('filtroTecnico').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroObservacion').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroSuper').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroDesde').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroHasta').addEventListener('change', function(){ dt.ajax.reload(); });
    var input = document.getElementById('archivoBase');
    var nombre = document.getElementById('archivoNombre');
    var btn = document.getElementById('btnEnviarArchivo');
    input.addEventListener('change', function(){
      nombre.textContent = input.files && input.files[0] ? input.files[0].name : '';
    });
    btn.addEventListener('click', function(){
      if (!input.files || !input.files[0]) { Swal.fire('Selecciona un archivo','','warning'); return; }
      var fd = new FormData();
      fd.append('archivo', input.files[0]);
      fetch('/logistica/seriales_inversa/upload', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(j => {
          if (j.success) { Swal.fire('Carga completada', j.message || '', 'success'); dt.ajax.reload(null, false); input.value=''; nombre.textContent=''; }
          else { Swal.fire('Error', j.message || 'Error al cargar', 'error'); }
        })
        .catch(() => Swal.fire('Error','Error de conexión','error'));
    });

    function cargarPendientesTecnicos(){
      fetch('/logistica/seriales_inversa/pending_summary?_=' + Date.now(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }, cache: 'no-store' })
        .then(r => r.json())
        .then(j => {
          pendientesItems = (j && j.items) ? j.items : [];
          if (dtPendientes) { dtPendientes.clear().rows.add(pendientesItems).draw(); }
          else { initPendientes(); }
        })
        .catch(function(){});
    }
    function cargarResumenSupervisores(){
      fetch('/logistica/seriales_inversa/supervisor_summary?_=' + Date.now(), { headers: { 'X-Requested-With': 'XMLHttpRequest' }, cache: 'no-store' })
        .then(r => r.json())
        .then(j => {
          var tbody = document.querySelector('#tablaResumenSupervisores tbody');
          if (!tbody) return;
          tbody.innerHTML = '';
          var rows = (j && j.items) ? j.items : [];
          rows.forEach(function(r){
            var tr = document.createElement('tr');
            var tdSup = document.createElement('td'); tdSup.textContent = r.supervisor || '';
            var tdTec = document.createElement('td'); tdTec.textContent = String(r.tecnicos_con_pendientes || 0);
            var tdTot = document.createElement('td'); tdTot.textContent = String(r.cantidad_total || 0);
            var tdPend = document.createElement('td'); tdPend.textContent = String(r.cantidad_pendientes || 0);
            var tdEnt = document.createElement('td'); tdEnt.textContent = String(r.cantidad_entregado || 0);
            var tdDesc = document.createElement('td'); tdDesc.textContent = String(r.cantidad_descontar || 0);
            var tdOtros = document.createElement('td'); tdOtros.textContent = String(r.otros_estados || 0);
            tr.appendChild(tdSup); tr.appendChild(tdTec); tr.appendChild(tdTot); tr.appendChild(tdPend); tr.appendChild(tdEnt); tr.appendChild(tdDesc); tr.appendChild(tdOtros);
            tbody.appendChild(tr);
          });
        })
        .catch(function(){});
    }
    cargarPendientesTecnicos();
    cargarResumenSupervisores();
    window.addEventListener('SI_UNLOCK_DONE', function(){ cargarPendientesTecnicos(); cargarResumenSupervisores(); });
    $('#tablaPendientesTecnicos').on('click', '.btn-unlock', function(){ var ced = this.getAttribute('data-cedula') || ''; if (!ced) return; var fd = new FormData(); fd.append('cedula', ced); fetch('/logistica/seriales_inversa/unlock?_=' + Date.now(), { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } }).then(function(r){ return r.json(); }).then(function(x){ if (x && x.success){ Swal.fire('Listo','Se concedieron 24h adicionales','success'); cargarPendientesTecnicos(); if (dt) dt.ajax.reload(null, false); cargarResumenSupervisores(); try { window.dispatchEvent(new CustomEvent('SI_UNLOCK_DONE')); } catch(e){} } else { Swal.fire('Error', (x && x.message) ? x.message : 'No se pudo desbloquear','error'); } }).catch(function(){ Swal.fire('Error','Error de conexión','error'); }); });

    $('#tablaSerialesInversa').on('click', '.si-edit-obs', function(){ var id = this.getAttribute('data-id'); var serial = this.getAttribute('data-serial'); var obs = this.getAttribute('data-obs'); editObsCurrent.id = id || null; editObsCurrent.serial = serial || null; var sel = document.getElementById('selObservacion'); var inp = document.getElementById('inputObservacionLibre'); if (sel){ if (!sel.options.length){ sel.innerHTML = '<option value="">Selecciona...</option>'; (observacionesLista||[]).forEach(function(o){ var opt = document.createElement('option'); opt.value=o; opt.textContent=o; sel.appendChild(opt); }); } sel.value = ''; } if (inp){ inp.value = ''; } if (obs){ if ((observacionesLista||[]).indexOf(obs) >= 0){ if (sel) sel.value = obs; if (inp) inp.value = ''; } else { if (sel) sel.value = ''; if (inp) inp.value = obs; } } modalEditar = new bootstrap.Modal(document.getElementById('modalEditarObs')); modalEditar.show(); });

    var btnGo = document.getElementById('btnGuardarObs');
    if (btnGo){ btnGo.addEventListener('click', function(){ var vsel = (document.getElementById('selObservacion')||{value:''}).value.trim(); var vtxt = (document.getElementById('inputObservacionLibre')||{value:''}).value.trim(); var nuevo = vtxt || vsel; if (!nuevo){ Swal.fire('Dato requerido','Ingresa la observación','warning'); return; } var fd = new FormData(); if (editObsCurrent.id) fd.append('id', editObsCurrent.id); if (editObsCurrent.serial) fd.append('serial_rr', editObsCurrent.serial); fd.append('observacion_diana', nuevo); fetch('/logistica/seriales_inversa/update_observacion', { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } }).then(function(r){ return r.json(); }).then(function(j){ if (j && j.success){ try { if (modalEditar) modalEditar.hide(); } catch(e){} Swal.fire('Actualizado','Observación actualizada','success'); dt.ajax.reload(null, false); } else { Swal.fire('Error', (j && j.message) ? j.message : 'No se pudo actualizar','error'); } }).catch(function(){ Swal.fire('Error','Error de conexión','error'); }); }); }
  });
</script>
<div class="modal fade" id="modalEditarObs" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar observación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Selecciona de la lista</label>
          <select id="selObservacion" class="form-select"></select>
        </div>
        <div class="mb-2">
          <label class="form-label">O escribe manualmente</label>
          <input id="inputObservacionLibre" type="text" class="form-control" placeholder="Observación" />
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnGuardarObs">Guardar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
