{% extends "base.html" %}

{% block title %}Seriales Inversa{% endblock %}

{% block extra_css %}
<style>
  .upload-card { border: 1px solid #dee2e6; border-radius: 0.375rem; }
  .upload-area { border: 2px dashed #dee2e6; border-radius: 0.375rem; padding: 1.5rem; text-align: center; cursor: pointer; }
  .upload-area:hover { border-color: #0d6efd; background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-retweet me-2"></i>Seriales Inversa</h2>
        <nav aria-label="breadcrumb">
          
        </nav>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card upload-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i>Cargar base</h5>
          <button id="btnEnviarArchivo" class="btn btn-primary"><i class="fas fa-upload me-2"></i>Cargar</button>
        </div>
        <div class="card-body">
          <div class="upload-area" onclick="document.getElementById('archivoBase').click()">
            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
            <div>Seleccione archivo CSV o Excel</div>
            <input id="archivoBase" type="file" accept=".csv,.xlsx,.xls" style="display:none">
            <div id="archivoNombre" class="mt-2 text-muted"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="fas fa-table me-2"></i>Registros</div>
        <div class="card-body">
          <table id="tablaSerialesInversa" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr>
                <th>lapso</th>
                <th>recurso_operativo_cedula</th>
                <th>cuenta</th>
                <th>dia</th>
                <th>mes</th>
                <th>descripcion</th>
                <th>observacion_diana</th>
                <th>serial_rr</th>
                <th>tecnico</th>
                <th>super</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  var dt;
  function initTabla() {
    $.fn.dataTable.ext.errMode = 'throw';
    dt = $('#tablaSerialesInversa').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '/logistica/seriales_inversa/list',
        dataSrc: 'data',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        data: function(d){ return d; }
      },
      pageLength: 10,
      lengthMenu: [[10,25,50,100,200],[10,25,50,100,200]],
      columns: [
        { data: 'lapso' },
        { data: 'recurso_operativo_cedula' },
        { data: 'cuenta' },
        { data: 'dia' },
        { data: 'mes' },
        { data: 'descripcion' },
        { data: 'observacion_diana' },
        { data: 'serial_rr' },
        { data: 'tecnico' },
        { data: 'super' }
      ]
    });
  }
  document.addEventListener('DOMContentLoaded', function() {
    initTabla();
    var input = document.getElementById('archivoBase');
    var nombre = document.getElementById('archivoNombre');
    var btn = document.getElementById('btnEnviarArchivo');
    input.addEventListener('change', function(){
      nombre.textContent = input.files && input.files[0] ? input.files[0].name : '';
    });
    btn.addEventListener('click', function(){
      if (!input.files || !input.files[0]) { Swal.fire('Selecciona un archivo','','warning'); return; }
      var fd = new FormData();
      fd.append('archivo', input.files[0]);
      fetch('/logistica/seriales_inversa/upload', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(j => {
          if (j.success) { Swal.fire('Carga completada', j.message || '', 'success'); dt.ajax.reload(null, false); input.value=''; nombre.textContent=''; }
          else { Swal.fire('Error', j.message || 'Error al cargar', 'error'); }
        })
        .catch(() => Swal.fire('Error','Error de conexi√≥n','error'));
    });
  });
</script>
{% endblock %}
