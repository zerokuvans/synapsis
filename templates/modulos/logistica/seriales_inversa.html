{% extends "base.html" %}

{% block title %}Seriales Inversa{% endblock %}

{% block extra_css %}
<style>
  .upload-card { border: 1px solid #dee2e6; border-radius: 0.375rem; }
  .upload-area { border: 2px dashed #dee2e6; border-radius: 0.375rem; padding: 1.5rem; text-align: center; cursor: pointer; }
  .upload-area:hover { border-color: #0d6efd; background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-retweet me-2"></i>Seriales Inversa</h2>
        <nav aria-label="breadcrumb">
          
        </nav>
      </div>
    </div>
  </div>

  <div class="row mb-4">
    <div class="col-12">
      <div class="card upload-card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-file-upload me-2"></i>Cargar base</h5>
          <button id="btnEnviarArchivo" class="btn btn-primary"><i class="fas fa-upload me-2"></i>Cargar</button>
        </div>
        <div class="card-body">
          <div class="upload-area" onclick="document.getElementById('archivoBase').click()">
            <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
            <div>Seleccione archivo CSV o Excel</div>
            <input id="archivoBase" type="file" accept=".csv,.xlsx,.xls" style="display:none">
            <div id="archivoNombre" class="mt-2 text-muted"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header"><i class="fas fa-table me-2"></i>Registros</div>
        <div class="card-body">
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <select id="filtroTecnico" class="form-select">
                <option value="">Todos los técnicos</option>
              </select>
            </div>
            <div class="col-md-3">
              <input id="filtroDesde" type="date" class="form-control" placeholder="Desde">
            </div>
            <div class="col-md-3">
              <input id="filtroHasta" type="date" class="form-control" placeholder="Hasta">
            </div>
            <div class="col-md-2 d-grid d-md-block">
              <button id="btnBuscar" class="btn btn-primary me-2"><i class="fas fa-search me-1"></i>Buscar</button>
              <button id="btnLimpiar" class="btn btn-secondary"><i class="fas fa-eraser me-1"></i>Limpiar</button>
            </div>
          </div>
          <table id="tablaSerialesInversa" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr>
                <th>lapso</th>
                <th>recurso_operativo_cedula</th>
                <th>cuenta</th>
                <th>dia</th>
                <th>mes</th>
                <th>descripcion</th>
                <th>observacion_diana</th>
                <th>serial_rr</th>
                <th>tecnico</th>
                <th>super</th>
                <th>acciones</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  var dt;
  function initTabla() {
    $.fn.dataTable.ext.errMode = 'throw';
    dt = $('#tablaSerialesInversa').DataTable({
      processing: true,
      serverSide: true,
      ajax: {
        url: '/logistica/seriales_inversa/list',
        dataSrc: 'data',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        data: function(d){
          d.tecnico = document.getElementById('filtroTecnico').value || '';
          d.fecha_desde = document.getElementById('filtroDesde').value || '';
          d.fecha_hasta = document.getElementById('filtroHasta').value || '';
          return d;
        }
      },
      pageLength: 10,
      lengthMenu: [[10,25,50,100,200],[10,25,50,100,200]],
      columns: [
        { data: 'lapso' },
        { data: 'recurso_operativo_cedula' },
        { data: 'cuenta' },
        { data: 'dia' },
        { data: 'mes' },
        { data: 'descripcion' },
        { data: 'observacion_diana' },
        { data: 'serial_rr' },
        { data: 'tecnico' },
        { data: 'super' },
        { data: 'id', orderable: false, searchable: false, render: function(data, type, row){
            var hasId = (data !== null && data !== undefined && data !== '' && !isNaN(Number(data)));
            return hasId ? '<button class="btn btn-sm btn-danger btn-del" data-id="'+data+'"><i class="fas fa-trash"></i></button>' : '';
          } }
      ]
    });
  }
  document.addEventListener('DOMContentLoaded', function() {
    initTabla();
    fetch('/logistica/seriales_inversa/tecnicos', { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
      .then(r => r.json())
      .then(j => { if (j && j.success && Array.isArray(j.tecnicos)){ var sel = document.getElementById('filtroTecnico'); j.tecnicos.forEach(function(n){ var opt = document.createElement('option'); opt.value=n; opt.textContent=n; sel.appendChild(opt); }); } });
    document.getElementById('btnBuscar').addEventListener('click', function(){ dt.ajax.reload(); });
    document.getElementById('btnLimpiar').addEventListener('click', function(){ document.getElementById('filtroTecnico').value=''; document.getElementById('filtroDesde').value=''; document.getElementById('filtroHasta').value=''; dt.ajax.reload(); });
    document.getElementById('filtroTecnico').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroDesde').addEventListener('change', function(){ dt.ajax.reload(); });
    document.getElementById('filtroHasta').addEventListener('change', function(){ dt.ajax.reload(); });
    $('#tablaSerialesInversa').on('click', '.btn-del', function(){
      var id = this.getAttribute('data-id');
      Swal.fire({
        icon:'warning',
        title:'Eliminar registro',
        text:'Esta acción no se puede deshacer. ¿Continuar?',
        showCancelButton:true,
        confirmButtonText:'Eliminar',
        cancelButtonText:'Cancelar'
      }).then(function(res){
        if (res.isConfirmed){
          fetch('/logistica/seriales_inversa/delete', { method:'POST', headers:{'Content-Type':'application/json','X-Requested-With':'XMLHttpRequest'}, body: JSON.stringify({id: id}) })
            .then(r => r.json())
            .then(j => { if (j && j.success){ dt.ajax.reload(null,false); Swal.fire('Eliminado','','success'); } else { Swal.fire('Error', (j && j.message) || 'No se pudo eliminar', 'error'); } })
            .catch(() => Swal.fire('Error','Error de conexión','error'));
        }
      });
    });
    var input = document.getElementById('archivoBase');
    var nombre = document.getElementById('archivoNombre');
    var btn = document.getElementById('btnEnviarArchivo');
    input.addEventListener('change', function(){
      nombre.textContent = input.files && input.files[0] ? input.files[0].name : '';
    });
    btn.addEventListener('click', function(){
      if (!input.files || !input.files[0]) { Swal.fire('Selecciona un archivo','','warning'); return; }
      var fd = new FormData();
      fd.append('archivo', input.files[0]);
      fetch('/logistica/seriales_inversa/upload', { method: 'POST', body: fd })
        .then(r => r.json())
        .then(j => {
          if (j.success) { Swal.fire('Carga completada', j.message || '', 'success'); dt.ajax.reload(null, false); input.value=''; nombre.textContent=''; }
          else { Swal.fire('Error', j.message || 'Error al cargar', 'error'); }
        })
        .catch(() => Swal.fire('Error','Error de conexión','error'));
    });
  });
</script>
{% endblock %}
