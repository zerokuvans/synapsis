{% extends "base.html" %}

{% block title %}Devoluciones de Dotación{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
        color: white;
    }
    .btn-primary {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #3583E8 0%, #3583E8 100%);
    }
    .form-control:focus {
        border-color: #3583E8;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .form-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #3583E8;
    }
    .section-title {
        color: #3583E8;
        font-weight: 600;
        margin-bottom: 15px;
        font-size: 1.1rem;
    }
    .required {
        color: #dc3545;
    }
    .form-row {
        margin-bottom: 15px;
    }
    .estado-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .estado-registrada {
        background-color: #e3f2fd;
        color: #1976d2;
    }
    .estado-en-revision {
        background-color: #fff3e0;
        color: #f57c00;
    }
    .estado-aprobada {
        background-color: #e1f5fe;
        color: #0277bd;
    }
    .estado-rechazada {
        background-color: #ffebee;
        color: #d32f2f;
    }
    .estado-completada {
        background-color: #e8f5e8;
        color: #388e3c;
    }
    
    /* Estilos para Modal de Resumen */
    .modal-resumen {
        max-width: 90%;
        width: 1200px;
    }
    
    .resumen-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #eee;
    }
    
    .resumen-info-item:last-child {
        border-bottom: none;
    }
    
    .resumen-info-label {
        font-weight: 600;
        color: #495057;
        min-width: 150px;
    }
    
    .resumen-info-value {
        color: #212529;
        text-align: right;
    }
    
    .resumen-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .resumen-card h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #007bff;
    }
    
    .resumen-estadisticas {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .resumen-stat-item {
        text-align: center;
        padding: 15px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }
    
    .resumen-stat-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
        display: block;
    }
    
    .resumen-stat-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .resumen-tabla {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .resumen-tabla table {
        font-size: 0.9rem;
    }
    
    .resumen-tabla th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .resumen-tabla td {
        vertical-align: middle;
    }
    
    .resumen-acciones {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }
    
    .btn-resumen {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-resumen:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    @media (max-width: 768px) {
        .modal-resumen {
            max-width: 95%;
            margin: 10px;
        }
        
        .resumen-estadisticas {
            grid-template-columns: 1fr;
        }
        
        .resumen-acciones {
            flex-direction: column;
        }
        
        .resumen-info-item {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .resumen-info-value {
            text-align: left;
            margin-top: 5px;
        }
    }
    
    /* Estilos para Gestión de Estados */
    .gestion-estados {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    
    .gestion-estados-header {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        color: #495057;
        font-weight: 600;
    }
    
    .gestion-estados-header i {
        color: #007bff;
        margin-right: 8px;
    }
    
    .botones-transicion {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
    }
    
    .btn-transicion {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-transicion:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .btn-transicion.registrada {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    
    .btn-transicion.procesando {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: #212529;
    }
    
    .btn-transicion.completada {
        background: linear-gradient(135deg, #007bff, #6610f2);
        color: white;
    }
    
    .btn-transicion.cancelada {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
        color: white;
    }
    
    .btn-historial {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-historial:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        color: white;
    }
    
    /* Timeline Styles */
    .timeline {
        position: relative;
        padding: 20px 0;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 30px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(to bottom, #007bff, #6610f2);
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 30px;
        padding-left: 70px;
    }
    
    .timeline-item:last-child {
        margin-bottom: 0;
    }
    
    .timeline-marker {
        position: absolute;
        left: 20px;
        top: 5px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 3px solid #fff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .timeline-marker.registrada {
        background: #28a745;
    }
    
    .timeline-marker.procesando {
        background: #ffc107;
    }
    
    .timeline-marker.completada {
        background: #007bff;
    }
    
    .timeline-marker.cancelada {
        background: #dc3545;
    }
    
    .timeline-content {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .timeline-estado {
        font-weight: 600;
        color: #495057;
    }
    
    .timeline-fecha {
        font-size: 0.85rem;
        color: #6c757d;
    }
    
    .timeline-usuario {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 5px;
    }
    
    .timeline-razon {
        font-size: 0.9rem;
        color: #495057;
        font-style: italic;
    }
    
    /* Notification Styles */
    .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
    }
    
    .notification {
        background: #fff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        border-left: 4px solid #007bff;
        animation: slideInRight 0.3s ease-out;
        position: relative;
    }
    
    .notification.success {
        border-left-color: #28a745;
    }
    
    .notification.error {
        border-left-color: #dc3545;
    }
    
    .notification.warning {
        border-left-color: #ffc107;
    }
    
    .notification.info {
        border-left-color: #17a2b8;
    }
    
    .notification-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .notification-title {
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .notification-close {
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .notification-close:hover {
        color: #495057;
    }
    
    .notification-message {
        color: #6c757d;
        font-size: 0.9rem;
        line-height: 1.4;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .notification.closing {
        animation: slideOutRight 0.3s ease-in;
    }
    
    /* Modal Styles */
    .modal-header {
        background: linear-gradient(135deg, #007bff, #6610f2);
        color: white;
        border-bottom: none;
    }
    
    .modal-header .btn-close {
        filter: invert(1);
    }
    
    .modal-body {
        padding: 25px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 8px;
    }
    
    .estado-actual, .estado-nuevo {
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 500;
        display: inline-block;
    }
    
    .estado-actual.registrada, .estado-nuevo.registrada {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    
    .estado-actual.procesando, .estado-nuevo.procesando {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    .estado-actual.completada, .estado-nuevo.completada {
        background: #cce7ff;
        color: #004085;
        border: 1px solid #b3d7ff;
    }
    
    .estado-actual.cancelada, .estado-nuevo.cancelada {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .gestion-estados {
            padding: 15px;
            margin: 15px 0;
        }
        
        .botones-transicion {
            flex-direction: column;
        }
        
        .btn-transicion, .btn-historial {
            width: 100%;
            justify-content: center;
        }
        
        .timeline {
            padding: 15px 0;
        }
        
        .timeline::before {
            left: 15px;
        }
        
        .timeline-item {
            padding-left: 50px;
        }
        
        .timeline-marker {
            left: 5px;
            width: 16px;
            height: 16px;
        }
        
        .notification-container {
            left: 10px;
            right: 10px;
            max-width: none;
        }
        
        .notification {
            margin-bottom: 8px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-undo me-2"></i>
                        Registro de Devoluciones de Dotación
                    </h4>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <form method="POST" action="{{ url_for('registrar_devolucion_dotacion') }}" id="formDevolucionesDotacion">
                        <!-- Información General -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-info-circle me-2"></i>
                                Información General
                            </h5>
                            <div class="row">
                                <div class="col-md-4">
                                    <label for="tecnico_id" class="form-label">
                                        Técnico <span class="required">*</span>
                                    </label>
                                    <select class="form-select" id="tecnico_id" name="tecnico_id" required>
                                        <option value="">Seleccione un técnico...</option>
                                        {% for tecnico in tecnicos %}
                                            <option value="{{ tecnico.id_codigo_consumidor }}">
                                                {{ tecnico.nombre }} - {{ tecnico.recurso_operativo_cedula }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="cliente_id" class="form-label">
                                        Cliente <span class="required">*</span>
                                    </label>
                                    <select class="form-select" id="cliente_id" name="cliente_id" required>
                                        <option value="">Seleccione un cliente...</option>
                                        {% for cliente in clientes %}
                                            <option value="{{ cliente.id }}">
                                                {{ cliente.nombre }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="fecha_devolucion" class="form-label">
                                        Fecha de Devolución
                                    </label>
                                    <input type="date" class="form-control" id="fecha_devolucion" name="fecha_devolucion">
                                </div>
                            </div>
                        </div>

                        <!-- Motivo y Detalles -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-clipboard-list me-2"></i>
                                Motivo y Detalles de la Devolución
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="motivo" class="form-label">
                                        Motivo de Devolución <span class="required">*</span>
                                    </label>
                                    <select class="form-select" id="motivo" name="motivo" required>
                                        <option value="">Seleccione un motivo...</option>
                                        <option value="DAÑO_PRODUCTO">Daño en el producto</option>
                                        <option value="TALLA_INCORRECTA">Talla incorrecta</option>
                                        <option value="PRODUCTO_DEFECTUOSO">Producto defectuoso</option>
                                        <option value="NO_CONFORME">No conforme con el producto</option>
                                        <option value="FINALIZACION_CONTRATO">Finalización de contrato</option>
                                        <option value="EXCESO_INVENTARIO">Exceso de inventario</option>
                                        <option value="OTRO">Otro motivo</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="estado" class="form-label">
                                        Estado de la Devolución
                                    </label>
                                    <select class="form-select" id="estado" name="estado">
                                        <option value="REGISTRADA" selected>Registrada</option>
                                        <option value="PROCESANDO">Procesando</option>
                                        <option value="COMPLETADA">Completada</option>
                                        <option value="CANCELADA">Cancelada</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Observaciones -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-comment me-2"></i>
                                Observaciones y Detalles Adicionales
                            </h5>
                            <div class="row">
                                <div class="col-12">
                                    <label for="observaciones" class="form-label">Observaciones</label>
                                    <textarea class="form-control" id="observaciones" name="observaciones" rows="4" placeholder="Describa los detalles específicos de la devolución, elementos devueltos, condición de los productos, etc."></textarea>
                                    <div class="form-text">
                                        Incluya información detallada sobre los elementos devueltos, su estado, cantidades, tallas, y cualquier observación relevante.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información de Estado -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="fas fa-info me-2"></i>
                                Información de Estados
                            </h5>
                            <div class="row">
                                <div class="col-12">
                                    <div class="d-flex flex-wrap gap-2">
                                        <span class="estado-badge estado-registrada">
                                            <i class="fas fa-file-alt me-1"></i>
                                            Registrada: Devolución recién creada
                                        </span>
                                        <span class="estado-badge estado-en-revision">
                                            <i class="fas fa-search me-1"></i>
                                            En Revisión: En proceso de validación
                                        </span>
                                        <span class="estado-badge estado-aprobada">
                                            <i class="fas fa-check me-1"></i>
                                            Aprobada: Devolución autorizada
                                        </span>
                                        <span class="estado-badge estado-rechazada">
                                            <i class="fas fa-times me-1"></i>
                                            Rechazada: Devolución no autorizada
                                        </span>
                                        <span class="estado-badge estado-completada">
                                            <i class="fas fa-check-circle me-1"></i>
                                            Completada: Devolución finalizada
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones -->
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between">
                                    <!-- <a href="{{ url_for('logistica_dashboard') }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Volver a Logística
                                    </a> -->
                                    <div>
                                        <button type="reset" class="btn btn-outline-secondary me-2">
                                            <i class="fas fa-undo me-2"></i>
                                            Limpiar
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>
                                            Registrar Devolución
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabla de Devoluciones Registradas -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Devoluciones Registradas
                    </h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tablaDevoluciones">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Técnico</th>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Motivo</th>
                                    <th>Estado</th>
                                    <th>Elementos</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoTablaDevoluciones">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-2 mb-0">Cargando devoluciones...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Editar Detalles de Devolución -->
<div class="modal fade" id="modalDetallesDevolucion" tabindex="-1" aria-labelledby="modalDetallesDevolucionLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalDetallesDevolucionLabel">
                    <i class="fas fa-edit me-2"></i>
                    Detalles de Devolución
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Información de la Devolución -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title">Información General</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>ID:</strong> <span id="detalleDevolucionId">-</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Técnico:</strong> <span id="detalleDevolucionTecnico">-</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Cliente:</strong> <span id="detalleDevolucionCliente">-</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Fecha:</strong> <span id="detalleDevolucionFecha">-</span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-4">
                                        <strong>Motivo:</strong> <span id="detalleDevolucionMotivo">-</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Estado:</strong> <span id="detalleDevolucionEstado">-</span>
                                    </div>
                                    <div class="col-md-12 mt-3">
                                        <div id="gestionEstados" class="d-none">
                                            <div class="card border-primary">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0">
                                                        <i class="fas fa-exchange-alt me-2"></i>
                                                        Gestión de Estados
                                                    </h6>
                                                </div>
                                                <div class="card-body">
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <div id="botonesTransicionEstatico" class="d-flex flex-wrap gap-2">
                                                                <!-- Botones dinámicos se cargarán aquí -->
                                                            </div>
                                                        </div>
                                                        <div class="col-md-4 text-end">
                                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="verHistorialEstados()">
                                                                <i class="fas fa-history me-1"></i>
                                                                Ver Historial
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Observaciones:</strong> <span id="detalleDevolucionObservaciones">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Formulario para Agregar Elementos -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-plus me-2"></i>
                                    Agregar Elemento Devuelto
                                </h6>
                            </div>
                            <div class="card-body">
                                <form id="formAgregarElemento">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label for="elemento" class="form-label">Elemento <span class="required">*</span></label>
                                            <select class="form-select" id="elemento" name="elemento" required>
                                                <option value="">Seleccione...</option>
                                                <option value="pantalon">Pantalón</option>
                                                <option value="camisetagris">Camiseta Gris</option>
                                                <option value="guerrera">Guerrera</option>
                                                <option value="camisetapolo">Camiseta Polo</option>
                                                <option value="guantes_nitrilo">Guantes Nitrilo</option>
                                                <option value="guantes_carnaza">Guantes Carnaza</option>
                                                <option value="gafas">Gafas</option>
                                                <option value="gorra">Gorra</option>
                                                <option value="casco">Casco</option>
                                                <option value="botas">Botas</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="talla" class="form-label">Talla</label>
                                            <select class="form-select" id="talla" name="talla">
                                                <option value="">N/A</option>
                                                <!-- Tallas de pantalón (números) -->
                                                <option value="28" data-elemento="pantalon">28</option>
                                                <option value="30" data-elemento="pantalon">30</option>
                                                <option value="32" data-elemento="pantalon">32</option>
                                                <option value="34" data-elemento="pantalon">34</option>
                                                <option value="36" data-elemento="pantalon">36</option>
                                                <option value="38" data-elemento="pantalon">38</option>
                                                <option value="40" data-elemento="pantalon">40</option>
                                                <option value="42" data-elemento="pantalon">42</option>
                                                <!-- Tallas de camisetas (letras) -->
                                                <option value="S" data-elemento="camiseta">S</option>
                                                <option value="M" data-elemento="camiseta">M</option>
                                                <option value="L" data-elemento="camiseta">L</option>
                                                <option value="XL" data-elemento="camiseta">XL</option>
                                                <option value="XXL" data-elemento="camiseta">XXL</option>
                                                <!-- Tallas de botas (números) -->
                                                <option value="36" data-elemento="botas">36</option>
                                                <option value="37" data-elemento="botas">37</option>
                                                <option value="38" data-elemento="botas">38</option>
                                                <option value="39" data-elemento="botas">39</option>
                                                <option value="40" data-elemento="botas">40</option>
                                                <option value="41" data-elemento="botas">41</option>
                                                <option value="42" data-elemento="botas">42</option>
                                                <option value="43" data-elemento="botas">43</option>
                                                <option value="44" data-elemento="botas">44</option>
                                                <option value="45" data-elemento="botas">45</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="cantidad" class="form-label">Cantidad</label>
                                            <input type="number" class="form-control" id="cantidad" name="cantidad" min="1" value="1">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="estado_elemento" class="form-label">Estado</label>
                                            <select class="form-select" id="estado_elemento" name="estado_elemento">
                                                <option value="USADO_BUENO">Usado - Buen Estado</option>
                                                <option value="USADO_REGULAR">Usado - Estado Regular</option>
                                                <option value="USADO_MALO">Usado - Mal Estado</option>
                                                <option value="DAÑADO">Dañado</option>
                                                <option value="NUEVO">Nuevo</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="submit" class="btn btn-success d-block w-100">
                                                <i class="fas fa-plus"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <label for="observaciones_elemento" class="form-label">Observaciones del Elemento</label>
                                            <textarea class="form-control" id="observaciones_elemento" name="observaciones" rows="2" placeholder="Observaciones específicas del elemento..."></textarea>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tabla de Elementos Devueltos -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Elementos Devueltos
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped" id="tablaElementosDevueltos">
                                        <thead class="table-secondary">
                                            <tr>
                                                <th>Elemento</th>
                                                <th>Talla</th>
                                                <th>Cantidad</th>
                                                <th>Estado</th>
                                                <th>Observaciones</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cuerpoTablaElementos">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    No hay elementos registrados
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Resumen de Devolución -->
<div class="modal fade" id="modalResumenDevolucion" tabindex="-1" aria-labelledby="modalResumenDevolucionLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalResumenDevolucionLabel">
                    <i class="fas fa-file-alt me-2"></i>
                    Resumen de Devolución
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Información Principal -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Información General
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="info-item">
                                            <label class="fw-bold text-muted">ID Devolución:</label>
                                            <div class="info-value" id="resumenDevolucionId">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-item">
                                            <label class="fw-bold text-muted">Técnico:</label>
                                            <div class="info-value" id="resumenDevolucionTecnico">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-item">
                                            <label class="fw-bold text-muted">Cliente:</label>
                                            <div class="info-value" id="resumenDevolucionCliente">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="info-item">
                                            <label class="fw-bold text-muted">Fecha:</label>
                                            <div class="info-value" id="resumenDevolucionFecha">-</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <div class="info-item">
                                            <label class="fw-bold text-muted">Motivo:</label>
                                            <div class="info-value" id="resumenDevolucionMotivo">-</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-item">
                                            <label class="fw-bold text-muted">Estado:</label>
                                            <div class="info-value">
                                                <span id="resumenDevolucionEstado" class="badge">-</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="info-item">
                                            <label class="fw-bold text-muted">Fecha Registro:</label>
                                            <div class="info-value" id="resumenDevolucionCreated">-</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-3" id="resumenObservacionesRow">
                                    <div class="col-12">
                                        <div class="info-item">
                                            <label class="fw-bold text-muted">Observaciones:</label>
                                            <div class="info-value" id="resumenDevolucionObservaciones">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estadísticas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center border-info">
                            <div class="card-body">
                                <i class="fas fa-boxes fa-2x text-info mb-2"></i>
                                <h4 class="card-title text-info" id="resumenTotalElementos">0</h4>
                                <p class="card-text">Total Elementos</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-success">
                            <div class="card-body">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <h4 class="card-title text-success" id="resumenElementosBuenos">0</h4>
                                <p class="card-text">Buen Estado</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-warning">
                            <div class="card-body">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                                <h4 class="card-title text-warning" id="resumenElementosRegulares">0</h4>
                                <p class="card-text">Estado Regular</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center border-danger">
                            <div class="card-body">
                                <i class="fas fa-times-circle fa-2x text-danger mb-2"></i>
                                <h4 class="card-title text-danger" id="resumenElementosDanados">0</h4>
                                <p class="card-text">Dañados/Malos</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista Detallada de Elementos -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-list-ul me-2"></i>
                                    Elementos Devueltos
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover" id="tablaResumenElementos">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>#</th>
                                                <th>Elemento</th>
                                                <th>Talla</th>
                                                <th>Cantidad</th>
                                                <th>Estado</th>
                                                <th>Observaciones</th>
                                                <th>Fecha Registro</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cuerpoTablaResumenElementos">
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                                    Cargando elementos...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="imprimirResumen()">
                    <i class="fas fa-print me-2"></i>
                    Imprimir
                </button>
                <button type="button" class="btn btn-info" onclick="exportarResumen()">
                    <i class="fas fa-download me-2"></i>
                    Exportar
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Historial de Estados -->
<div class="modal fade" id="modalHistorialEstados" tabindex="-1" aria-labelledby="modalHistorialEstadosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="modalHistorialEstadosLabel">
                    <i class="fas fa-history me-2"></i>
                    Historial de Estados - Devolución #<span id="historialDevolucionId">-</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="timeline-container">
                    <div id="timelineEstados">
                        <!-- Timeline se cargará dinámicamente -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmación de Cambio de Estado -->
<div class="modal fade" id="modalConfirmarCambio" tabindex="-1" aria-labelledby="modalConfirmarCambioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="modalConfirmarCambioLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Cambio de Estado
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Está seguro de cambiar el estado de la devolución?</p>
                <div class="row">
                    <div class="col-6">
                        <strong>Estado actual:</strong><br>
                        <span id="estadoActualConfirm" class="badge">-</span>
                    </div>
                    <div class="col-6">
                        <strong>Nuevo estado:</strong><br>
                        <span id="nuevoEstadoConfirm" class="badge">-</span>
                    </div>
                </div>
                <div class="mt-3">
                    <label for="motivoCambio" class="form-label">Motivo del cambio (opcional):</label>
                    <textarea class="form-control" id="motivoCambio" rows="3" placeholder="Ingrese el motivo del cambio de estado..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmarCambio">
                    <i class="fas fa-check me-2"></i>
                    Confirmar Cambio
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Establecer fecha actual por defecto
document.addEventListener('DOMContentLoaded', function() {
    const fechaInput = document.getElementById('fecha_devolucion');
    const today = new Date().toISOString().split('T')[0];
    fechaInput.value = today;
    
    // Validación del formulario
    const form = document.getElementById('formDevolucionesDotacion');
    form.addEventListener('submit', function(e) {
        const tecnico = document.getElementById('tecnico_id').value;
        const cliente = document.getElementById('cliente_id').value;
        const motivo = document.getElementById('motivo').value;
        
        if (!tecnico || !cliente || !motivo) {
            e.preventDefault();
            alert('Por favor complete los campos obligatorios: Técnico, Cliente y Motivo');
            return false;
        }
        
        // Validar que si el motivo es "OTRO", se requieren observaciones
        if (motivo === 'OTRO') {
            const observaciones = document.getElementById('observaciones').value.trim();
            if (!observaciones) {
                e.preventDefault();
                alert('Cuando selecciona "Otro motivo", debe especificar detalles en las observaciones');
                return false;
            }
        }
    });
    
    // Mostrar/ocultar campo de observaciones según el motivo
    const motivoSelect = document.getElementById('motivo');
    const observacionesDiv = document.querySelector('.form-section:last-of-type');
    
    motivoSelect.addEventListener('change', function() {
        if (this.value === 'OTRO') {
            document.getElementById('observaciones').setAttribute('required', 'required');
            document.querySelector('label[for="observaciones"]').innerHTML = 'Observaciones <span class="required">*</span>';
        } else {
            document.getElementById('observaciones').removeAttribute('required');
            document.querySelector('label[for="observaciones"]').innerHTML = 'Observaciones';
        }
    });
    
    // Variables globales para el modal
    let devolucionActual = null;
    let elementosDevueltos = [];

    // Cargar devoluciones al cargar la página
    cargarDevoluciones();

    // Función para cargar devoluciones
    async function cargarDevoluciones() {
        try {
            const response = await fetch('/api/devoluciones/listar');
            const data = await response.json();
            
            if (data.success) {
                mostrarDevoluciones(data.devoluciones);
            } else {
                console.error('Error al cargar devoluciones:', data.message);
                mostrarErrorTabla('Error al cargar las devoluciones');
            }
        } catch (error) {
            console.error('Error de conexión:', error);
            mostrarErrorTabla('Error de conexión al servidor');
        }
    }

    // Función para mostrar devoluciones en la tabla
    function mostrarDevoluciones(devoluciones) {
        const tbody = document.getElementById('cuerpoTablaDevoluciones');
        
        if (devoluciones.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-muted">
                        No hay devoluciones registradas
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = devoluciones.map(devolucion => `
            <tr>
                <td>${devolucion.id}</td>
                <td>${devolucion.tecnico_nombre}</td>
                <td>${devolucion.cliente_nombre}</td>
                <td>${formatearFecha(devolucion.fecha_devolucion)}</td>
                <td><span class="badge bg-info">${devolucion.motivo}</span></td>
                <td><span class="badge ${getEstadoBadgeClass(devolucion.estado)}">${devolucion.estado}</span></td>
                <td><span class="badge bg-secondary">${devolucion.total_elementos || 0}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary me-1" onclick="abrirModalDetalles(${devolucion.id})" title="Ver/Editar Detalles">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-info" onclick="verResumen(${devolucion.id})" title="Ver Resumen">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Función para mostrar error en la tabla
    function mostrarErrorTabla(mensaje) {
        const tbody = document.getElementById('cuerpoTablaDevoluciones');
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${mensaje}
                </td>
            </tr>
        `;
    }

    // Función para formatear fecha
    function formatearFecha(fecha) {
        if (!fecha) return '';
        try {
            return new Date(fecha).toLocaleDateString('es-ES');
        } catch (e) {
            return fecha;
        }
    }

    // Función para obtener clase de badge según estado
    function getEstadoBadgeClass(estado) {
        switch(estado) {
            case 'REGISTRADA': return 'bg-secondary';
            case 'EN_REVISION': return 'bg-warning';
            case 'APROBADA': return 'bg-info';
            case 'RECHAZADA': return 'bg-danger';
            case 'COMPLETADA': return 'bg-success';
            default: return 'bg-secondary';
        }
    }

    // Función para abrir modal de detalles
    async function abrirModalDetalles(devolucionId) {
        try {
            // Resetear todas las variables de protección para nueva devolución
            botonesYaCargados = false;
            ultimaDevolucionCargada = null;
            contadorLlamadas = 0;
            
            console.log(`🔄 Abriendo modal para devolución ${devolucionId} - Variables reseteadas`);
            
            // Cargar información de la devolución
            const response = await fetch(`/api/devoluciones/${devolucionId}/detalles`);
            const data = await response.json();
            
            if (data.success) {
                devolucionActual = data.devolucion;
                elementosDevueltos = data.elementos || [];
                
                // Llenar información general
                document.getElementById('detalleDevolucionId').textContent = devolucionActual.id;
                document.getElementById('detalleDevolucionTecnico').textContent = devolucionActual.tecnico_nombre;
                document.getElementById('detalleDevolucionCliente').textContent = devolucionActual.cliente_nombre;
                document.getElementById('detalleDevolucionFecha').textContent = formatearFecha(devolucionActual.fecha_devolucion);
                document.getElementById('detalleDevolucionMotivo').textContent = devolucionActual.motivo;
                document.getElementById('detalleDevolucionEstado').innerHTML = `<span class="badge ${getEstadoBadgeClass(devolucionActual.estado)}">${devolucionActual.estado}</span>`;
                document.getElementById('detalleDevolucionObservaciones').textContent = devolucionActual.observaciones || 'Sin observaciones';
                
                // Mostrar elementos devueltos
                mostrarElementosDevueltos();
                
                // Cargar gestión de estados
                cargarGestionEstados(devolucionId, devolucionActual.estado);
                
                // Abrir modal
                const modal = new bootstrap.Modal(document.getElementById('modalDetallesDevolucion'));
                modal.show();
            } else {
                alert('Error al cargar los detalles: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión al cargar los detalles');
        }
    }

    // Función para mostrar elementos devueltos
    function mostrarElementosDevueltos() {
        const tbody = document.getElementById('cuerpoTablaElementos');
        
        if (elementosDevueltos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        No hay elementos registrados
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = elementosDevueltos.map(elemento => `
            <tr>
                <td>${elemento.elemento}</td>
                <td>${elemento.talla || 'N/A'}</td>
                <td>${elemento.cantidad}</td>
                <td><span class="badge bg-secondary">${elemento.estado_elemento}</span></td>
                <td>${elemento.observaciones || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="eliminarElemento(${elemento.id})" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Manejar formulario de agregar elemento
    document.getElementById('formAgregarElemento').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!devolucionActual) {
            alert('Error: No hay devolución seleccionada');
            return;
        }

        const formData = new FormData(this);
        const elementoData = {
            devolucion_id: devolucionActual.id,
            elemento: formData.get('elemento'),
            talla: formData.get('talla') || null,
            cantidad: parseInt(formData.get('cantidad')) || 1,
            estado_elemento: formData.get('estado_elemento'),
            observaciones: formData.get('observaciones') || null
        };

        try {
            const response = await fetch(`/api/devoluciones/${devolucionActual.id}/detalles`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(elementoData)
            });

            const data = await response.json();
            
            if (data.success) {
                // Agregar elemento a la lista local
                elementosDevueltos.push(data.elemento);
                mostrarElementosDevueltos();
                
                // Limpiar formulario
                this.reset();
                document.getElementById('cantidad').value = '1';
                
                // Recargar tabla principal
                cargarDevoluciones();
            } else {
                alert('Error al agregar elemento: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión al agregar elemento');
        }
    });

    // Función para eliminar elemento
    async function eliminarElemento(elementoId) {
        if (!confirm('¿Está seguro de eliminar este elemento?')) {
            return;
        }

        try {
            const response = await fetch(`/api/devoluciones/detalles/${elementoId}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            
            if (data.success) {
                // Remover elemento de la lista local
                elementosDevueltos = elementosDevueltos.filter(el => el.id !== elementoId);
                mostrarElementosDevueltos();
                
                // Recargar tabla principal
                cargarDevoluciones();
            } else {
                alert('Error al eliminar elemento: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error de conexión al eliminar elemento');
        }
    }

    // Función para ver resumen (opcional)
    function verResumen(devolucionId) {
        // Función para mostrar resumen completo de la devolución
        console.log('Mostrando resumen para devolución ID:', devolucionId);
        
        // Mostrar el modal
        const modal = new bootstrap.Modal(document.getElementById('modalResumenDevolucion'));
        modal.show();
        
        // Cargar los datos de la devolución
        cargarDatosResumen(devolucionId);
    }

    function cargarDatosResumen(devolucionId) {
        // Mostrar indicador de carga
        mostrarCargandoResumen();
        
        // Realizar petición para obtener los detalles
        fetch(`/obtener_detalles_devolucion/${devolucionId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al obtener los detalles de la devolución');
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                
                if (data.success) {
                    // Llenar la información general
                    llenarInformacionGeneral(data.devolucion);
                    
                    // Llenar la tabla de elementos y calcular estadísticas
                    llenarTablaElementos(data.detalles);
                    
                    // Calcular y mostrar estadísticas
                    calcularEstadisticas(data.detalles);
                } else {
                    mostrarErrorResumen('Error al cargar los datos: ' + (data.message || 'Error desconocido'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarErrorResumen('Error de conexión al cargar los datos');
            });
    }

    function mostrarCargandoResumen() {
        // Limpiar contenido anterior
        document.getElementById('resumenDevolucionId').textContent = '-';
        document.getElementById('resumenDevolucionTecnico').textContent = '-';
        document.getElementById('resumenDevolucionCliente').textContent = '-';
        document.getElementById('resumenDevolucionFecha').textContent = '-';
        document.getElementById('resumenDevolucionMotivo').textContent = '-';
        document.getElementById('resumenDevolucionEstado').textContent = '-';
        document.getElementById('resumenDevolucionCreated').textContent = '-';
        document.getElementById('resumenDevolucionObservaciones').textContent = '-';
        
        // Limpiar estadísticas
        document.getElementById('resumenTotalElementos').textContent = '0';
        document.getElementById('resumenElementosBuenos').textContent = '0';
        document.getElementById('resumenElementosRegulares').textContent = '0';
        document.getElementById('resumenElementosDanados').textContent = '0';
        
        // Mostrar indicador de carga en la tabla
        document.getElementById('cuerpoTablaResumenElementos').innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Cargando elementos...
                </td>
            </tr>
        `;
    }

    function llenarInformacionGeneral(devolucion) {
        document.getElementById('resumenDevolucionId').textContent = devolucion.id || '-';
        document.getElementById('resumenDevolucionTecnico').textContent = devolucion.tecnico_nombre || '-';
        document.getElementById('resumenDevolucionCliente').textContent = devolucion.cliente_nombre || '-';
        document.getElementById('resumenDevolucionFecha').textContent = formatearFecha(devolucion.fecha_devolucion) || '-';
        document.getElementById('resumenDevolucionMotivo').textContent = devolucion.motivo || '-';
        
        // Estado con color
        const estadoElement = document.getElementById('resumenDevolucionEstado');
        estadoElement.textContent = devolucion.estado || '-';
        estadoElement.className = 'badge ' + obtenerClaseEstado(devolucion.estado);
        
        document.getElementById('resumenDevolucionCreated').textContent = formatearFechaHora(devolucion.created_at) || '-';
        
        // Observaciones (ocultar fila si está vacía)
        const observaciones = devolucion.observaciones;
        const observacionesRow = document.getElementById('resumenObservacionesRow');
        if (observaciones && observaciones.trim() !== '') {
            document.getElementById('resumenDevolucionObservaciones').textContent = observaciones;
            observacionesRow.style.display = 'block';
        } else {
            observacionesRow.style.display = 'none';
        }
    }

    function llenarTablaElementos(detalles) {
        const tbody = document.getElementById('cuerpoTablaResumenElementos');
        
        if (!detalles || detalles.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted">
                        <i class="fas fa-info-circle me-2"></i>
                        No hay elementos registrados en esta devolución
                    </td>
                </tr>
            `;
            return;
        }
        
        let html = '';
        detalles.forEach((detalle, index) => {
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${detalle.elemento || '-'}</td>
                    <td>${detalle.talla || '-'}</td>
                    <td>${detalle.cantidad || 0}</td>
                    <td>
                        <span class="badge ${obtenerClaseEstadoElemento(detalle.estado_elemento)}">
                            ${detalle.estado_elemento || '-'}
                        </span>
                    </td>
                    <td>${detalle.observaciones || '-'}</td>
                    <td>${formatearFechaHora(detalle.created_at) || '-'}</td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
    }

    function calcularEstadisticas(detalles) {
        if (!detalles || detalles.length === 0) {
            return;
        }
        
        let total = 0;
        let buenos = 0;
        let regulares = 0;
        let danados = 0;
        
        detalles.forEach(detalle => {
            const cantidad = parseInt(detalle.cantidad) || 0;
            total += cantidad;
            
            const estado = (detalle.estado_elemento || '').toLowerCase();
            if (estado.includes('bueno') || estado.includes('excelente')) {
                buenos += cantidad;
            } else if (estado.includes('regular') || estado.includes('usado')) {
                regulares += cantidad;
            } else if (estado.includes('malo') || estado.includes('dañado') || estado.includes('roto')) {
                danados += cantidad;
            }
        });
        
        document.getElementById('resumenTotalElementos').textContent = total;
        document.getElementById('resumenElementosBuenos').textContent = buenos;
        document.getElementById('resumenElementosRegulares').textContent = regulares;
        document.getElementById('resumenElementosDanados').textContent = danados;
    }

    function obtenerClaseEstado(estado) {
        if (!estado) return 'bg-secondary';
        
        const estadoLower = estado.toLowerCase();
        if (estadoLower.includes('completado') || estadoLower.includes('finalizado')) {
            return 'bg-success';
        } else if (estadoLower.includes('pendiente')) {
            return 'bg-warning';
        } else if (estadoLower.includes('cancelado')) {
            return 'bg-danger';
        } else {
            return 'bg-info';
        }
    }

    function obtenerClaseEstadoElemento(estado) {
        if (!estado) return 'bg-secondary';
        
        const estadoLower = estado.toLowerCase();
        if (estadoLower.includes('bueno') || estadoLower.includes('excelente')) {
            return 'bg-success';
        } else if (estadoLower.includes('regular') || estadoLower.includes('usado')) {
            return 'bg-warning';
        } else if (estadoLower.includes('malo') || estadoLower.includes('dañado') || estadoLower.includes('roto')) {
            return 'bg-danger';
        } else {
            return 'bg-info';
        }
    }

    function mostrarErrorResumen(mensaje) {
        const tbody = document.getElementById('cuerpoTablaResumenElementos');
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${mensaje}
                </td>
            </tr>
        `;
    }

    function formatearFechaHora(fecha) {
        if (!fecha) return '';
        try {
            const date = new Date(fecha);
            return date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
        } catch (e) {
            return fecha;
        }
    }

    function imprimirResumen() {
        const modalContent = document.querySelector('#modalResumen .modal-body').innerHTML;
        const printWindow = window.open('', '_blank');
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Resumen de Devolución</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .resumen-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; }
                    .resumen-card h6 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
                    .resumen-info-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
                    .resumen-info-label { font-weight: bold; }
                    .resumen-estadisticas { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
                    .resumen-stat-item { text-align: center; padding: 10px; border: 1px solid #ddd; }
                    .resumen-stat-number { font-size: 1.2rem; font-weight: bold; color: #007bff; }
                    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f8f9fa; }
                    .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; }
                    .bg-success { background-color: #d4edda; color: #155724; }
                    .bg-warning { background-color: #fff3cd; color: #856404; }
                    .bg-danger { background-color: #f8d7da; color: #721c24; }
                    .bg-info { background-color: #d1ecf1; color: #0c5460; }
                    .bg-secondary { background-color: #e2e3e5; color: #383d41; }
                    @media print { .no-print { display: none; } }
                </style>
            </head>
            <body>
                <h2>Resumen de Devolución de Dotación</h2>
                ${modalContent}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.focus();
        
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    }

    function exportarResumen() {
        const devolucionId = document.getElementById('resumenDevolucionId').textContent;
        
        // Crear datos para Excel
        const datosGenerales = [
            ['RESUMEN DE DEVOLUCIÓN DE DOTACIÓN', ''],
            ['', ''],
            ['ID Devolución', devolucionId],
            ['Técnico', document.getElementById('resumenDevolucionTecnico').textContent],
            ['Cliente', document.getElementById('resumenDevolucionCliente').textContent],
            ['Fecha Devolución', document.getElementById('resumenDevolucionFecha').textContent],
            ['Motivo', document.getElementById('resumenDevolucionMotivo').textContent],
            ['Estado', document.getElementById('resumenDevolucionEstado').textContent],
            ['Fecha Creación', document.getElementById('resumenDevolucionCreated').textContent],
            ['', ''],
            ['ESTADÍSTICAS', ''],
            ['Total Elementos', document.getElementById('resumenTotalElementos').textContent],
            ['Elementos Buenos', document.getElementById('resumenElementosBuenos').textContent],
            ['Elementos Regulares', document.getElementById('resumenElementosRegulares').textContent],
            ['Elementos Dañados', document.getElementById('resumenElementosDanados').textContent],
            ['', ''],
            ['ELEMENTOS DEVUELTOS', '']
        ];

        // Agregar observaciones si existen
        const observacionesRow = document.getElementById('resumenObservacionesRow');
        if (observacionesRow && observacionesRow.style.display !== 'none') {
            datosGenerales.splice(-3, 0, ['Observaciones', document.getElementById('resumenDevolucionObservaciones').textContent]);
        }

        // Agregar encabezados de tabla
        const encabezados = ['#', 'Elemento', 'Talla', 'Cantidad', 'Estado', 'Observaciones', 'Fecha Registro'];
        datosGenerales.push(encabezados);

        // Agregar filas de elementos
        const filas = document.querySelectorAll('#cuerpoTablaResumenElementos tr');
        filas.forEach(fila => {
            const celdas = fila.querySelectorAll('td');
            if (celdas.length > 1) { // Evitar filas de mensaje
                const filaData = [];
                celdas.forEach(celda => {
                    // Extraer solo el texto, sin HTML
                    let texto = celda.textContent.trim();
                    filaData.push(texto);
                });
                datosGenerales.push(filaData);
            }
        });

        // Crear archivo CSV
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM para UTF-8
        datosGenerales.forEach(fila => {
            const filaCSV = fila.map(campo => `"${campo.toString().replace(/"/g, '""')}"`).join(",");
            csvContent += filaCSV + "\r\n";
        });

        // Descargar archivo
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `resumen_devolucion_${devolucionId}_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Mostrar mensaje de éxito
        mostrarMensajeExito('Resumen exportado exitosamente como archivo CSV');
    }

    function mostrarMensajeExito(mensaje) {
        // Crear y mostrar un toast de éxito
        const toastContainer = document.createElement('div');
        toastContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            background: #d4edda;
            color: #155724;
            padding: 12px 20px;
            border-radius: 6px;
            border: 1px solid #c3e6cb;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            font-family: Arial, sans-serif;
            font-size: 14px;
        `;
        toastContainer.innerHTML = `
            <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
            ${mensaje}
        `;
        
        document.body.appendChild(toastContainer);
        
        // Auto-remover después de 3 segundos
        setTimeout(() => {
            if (toastContainer.parentNode) {
                toastContainer.remove();
            }
        }, 3000);
    }

    // ===== FUNCIONES DE GESTIÓN DE ESTADOS =====
    
    // Variables globales para gestión de estados
    let devolucionActualEstados = null;
    let botonesYaCargados = false; // Protección contra bucle infinito
    let ultimaDevolucionCargada = null; // Tracking de última devolución
    let contadorLlamadas = 0; // Contador de llamadas para debugging
    let estadosPermitidos = {
        'PENDIENTE': ['EN_REVISION', 'RECHAZADA'],
        'REGISTRADA': ['EN_REVISION', 'RECHAZADA'],
        'EN_REVISION': ['APROBADA', 'RECHAZADA'],
        'APROBADA': ['COMPLETADA', 'PROCESADA'],
        'PROCESADA': [],
        'RECHAZADA': [],
        'COMPLETADA': []
    };
    
    // Función para cargar botones dinámicos de transición
    async function cargarBotonesTransicion(devolucionId, estadoActual) {
        contadorLlamadas++;
        
        // Protección robusta contra bucle infinito
        if (botonesYaCargados && ultimaDevolucionCargada === devolucionId) {
            console.log(`⚠️ Llamada #${contadorLlamadas} - Botones ya cargados para devolución ${devolucionId}, evitando bucle infinito`);
            return;
        }
        
        // Protección adicional: máximo 3 llamadas por devolución
        if (contadorLlamadas > 3) {
            console.error(`🚫 Llamada #${contadorLlamadas} - Demasiadas llamadas, deteniendo ejecución`);
            return;
        }
        
        console.log(`🔄 Llamada #${contadorLlamadas} - cargarBotonesTransicion:`, { devolucionId, estadoActual });
        
        const container = document.getElementById('botonesTransicion');
        
        if (!container) {
            console.error('❌ No se encontró el contenedor botonesTransicion');
            return;
        }
        
        console.log('📦 Contenedor encontrado:', container);
        console.log('📦 Contenedor padre:', container.parentElement);
        console.log('📦 Contenedor clases:', container.className);
        
        const transicionesPosibles = estadosPermitidos[estadoActual] || [];
        
        if (transicionesPosibles.length === 0) {
            const mensaje = '<p class="text-muted">No hay transiciones disponibles para este estado.</p>';
            container.innerHTML = mensaje;
            botonesYaCargados = true;
            ultimaDevolucionCargada = devolucionId;
            return;
        }
        
        const botonesHTML = transicionesPosibles.map(estado => {
            const config = getEstadoConfig(estado);
            return `
                <button class="btn btn-${config.variant} me-2 mb-2" 
                        onclick="confirmarCambioEstado(${devolucionId}, '${estadoActual}', '${estado}')"
                        title="Cambiar a ${estado}">
                    <i class="fas ${config.icon} me-2"></i>
                    Cambiar a ${estado}
                </button>
            `;
        }).join('');
        
        container.innerHTML = botonesHTML;
        
        // Debugging adicional
        console.log('🔧 HTML insertado:', botonesHTML);
        console.log('🔧 Contenido actual del contenedor:', container.innerHTML);
        console.log('🔧 Contenedor visible?', container.offsetWidth > 0 && container.offsetHeight > 0);
        
        botonesYaCargados = true;
        ultimaDevolucionCargada = devolucionId;
        console.log(`✅ Llamada #${contadorLlamadas} - Botones cargados exitosamente para devolución ${devolucionId}, estado: ${estadoActual}`);
    }
    
    // Configuración de estados
    function getEstadoConfig(estado) {
        const configs = {
            'PENDIENTE': { variant: 'secondary', icon: 'fa-clock' },
            'REGISTRADA': { variant: 'secondary', icon: 'fa-file-alt' },
            'EN_REVISION': { variant: 'warning', icon: 'fa-search' },
            'APROBADA': { variant: 'info', icon: 'fa-check' },
            'PROCESADA': { variant: 'primary', icon: 'fa-cogs' },
            'RECHAZADA': { variant: 'danger', icon: 'fa-times' },
            'COMPLETADA': { variant: 'success', icon: 'fa-check-circle' }
        };
        return configs[estado] || { variant: 'secondary', icon: 'fa-question' };
    }
    
    // Función para confirmar cambio de estado
    function confirmarCambioEstado(devolucionId, estadoActual, nuevoEstado) {
        devolucionActualEstados = devolucionId;
        
        // Actualizar modal de confirmación
        document.getElementById('estadoActualConfirm').textContent = estadoActual;
        document.getElementById('estadoActualConfirm').className = `badge ${getEstadoBadgeClass(estadoActual)}`;
        
        document.getElementById('nuevoEstadoConfirm').textContent = nuevoEstado;
        document.getElementById('nuevoEstadoConfirm').className = `badge ${getEstadoBadgeClass(nuevoEstado)}`;
        
        document.getElementById('motivoCambio').value = '';
        
        // Configurar botón de confirmación
        const btnConfirmar = document.getElementById('btnConfirmarCambio');
        btnConfirmar.onclick = () => ejecutarCambioEstado(devolucionId, nuevoEstado);
        
        // Mostrar modal
        const modal = new bootstrap.Modal(document.getElementById('modalConfirmarCambio'));
        modal.show();
    }
    
    // Función para ejecutar cambio de estado
    async function ejecutarCambioEstado(devolucionId, nuevoEstado) {
        const motivo = document.getElementById('motivoCambio').value.trim();
        
        try {
            const response = await fetch(`/api/devoluciones/${devolucionId}/estado`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nuevo_estado: nuevoEstado,
                    motivo: motivo
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Cerrar modal de confirmación de forma segura
                const modalElement = document.getElementById('modalConfirmarCambio');
                const modalInstance = bootstrap.Modal.getInstance(modalElement);
                
                if (modalInstance) {
                    modalInstance.hide();
                }
                
                // Limpiar cualquier backdrop residual después de un breve delay
                setTimeout(() => {
                    limpiarElementosResidualesModal();
                }, 300);
                
                // Mostrar notificación de éxito
                mostrarNotificacion('success', `Estado cambiado exitosamente a ${nuevoEstado}`);
                
                // Recargar datos
                cargarDevoluciones();
                
                // Si el modal de detalles está abierto, actualizarlo
                if (devolucionActual && devolucionActual.id === devolucionId) {
                    abrirModalDetalles(devolucionId);
                }
            } else {
                mostrarNotificacion('error', data.message || 'Error al cambiar el estado');
            }
        } catch (error) {
            console.error('Error al cambiar estado:', error);
            mostrarNotificacion('error', 'Error de conexión al servidor');
        }
    }
    
    // Función para mostrar historial de estados
    async function mostrarHistorialEstados(devolucionId) {
        try {
            const response = await fetch(`/api/devoluciones/${devolucionId}/historial`);
            
            // Verificar si la respuesta es JSON válido
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                console.error('Respuesta no es JSON:', contentType);
                mostrarNotificacion('error', 'Error: Sesión expirada. Por favor, recargue la página e inicie sesión nuevamente.');
                return;
            }
            
            const data = await response.json();
            
            // Manejar errores de autenticación específicamente
            if (response.status === 401) {
                if (data.code === 'AUTH_REQUIRED') {
                    mostrarNotificacion('error', 'Sesión expirada. Por favor, recargue la página e inicie sesión nuevamente.');
                } else {
                    mostrarNotificacion('error', 'No tiene permisos para acceder a esta información.');
                }
                return;
            }
            
            if (data.success) {
                document.getElementById('historialDevolucionId').textContent = devolucionId;
                renderizarTimeline(data.historial);
                
                const modal = new bootstrap.Modal(document.getElementById('modalHistorialEstados'));
                modal.show();
            } else {
                mostrarNotificacion('error', data.error || data.message || 'Error al cargar historial');
            }
        } catch (error) {
            console.error('Error al cargar historial:', error);
            
            // Verificar si el error es por JSON inválido
            if (error.message && error.message.includes('Unexpected token')) {
                mostrarNotificacion('error', 'Error: Sesión expirada. Por favor, recargue la página e inicie sesión nuevamente.');
            } else {
                mostrarNotificacion('error', 'Error de conexión al servidor. Verifique su conexión e intente nuevamente.');
            }
        }
    }
    
    // Función para renderizar timeline de estados
    function renderizarTimeline(historial) {
        const container = document.getElementById('timelineEstados');
        
        if (!historial || historial.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No hay historial de cambios disponible.</p>';
            return;
        }
        
        container.innerHTML = historial.map((cambio, index) => {
            const config = getEstadoConfig(cambio.estado_nuevo);
            const isLast = index === historial.length - 1;
            
            return `
                <div class="timeline-item ${isLast ? 'timeline-item-last' : ''}">
                    <div class="timeline-marker bg-${config.variant}">
                        <i class="fas ${config.icon}"></i>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <h6 class="mb-1">${cambio.estado_anterior || 'INICIAL'} → ${cambio.estado_nuevo}</h6>
                            <small class="text-muted">${formatearFechaHora(cambio.fecha_cambio)}</small>
                        </div>
                        <div class="timeline-body">
                            <p class="mb-1"><strong>Usuario:</strong> ${cambio.usuario_nombre || 'Sistema'}</p>
                            ${cambio.motivo ? `<p class="mb-0"><strong>Motivo:</strong> ${cambio.motivo}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    // Sistema de notificaciones
    function mostrarNotificacion(tipo, mensaje, duracion = 4000) {
        const container = getOrCreateNotificationContainer();
        
        const notification = document.createElement('div');
        notification.className = `notification notification-${tipo} notification-enter`;
        
        const iconos = {
            'success': 'fa-check-circle',
            'error': 'fa-exclamation-circle',
            'warning': 'fa-exclamation-triangle',
            'info': 'fa-info-circle'
        };
        
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas ${iconos[tipo] || iconos.info} notification-icon"></i>
                <span class="notification-message">${mensaje}</span>
                <button class="notification-close" onclick="cerrarNotificacion(this)">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        container.appendChild(notification);
        
        // Animación de entrada
        setTimeout(() => {
            notification.classList.remove('notification-enter');
        }, 100);
        
        // Auto-remover
        setTimeout(() => {
            cerrarNotificacion(notification.querySelector('.notification-close'));
        }, duracion);
    }
    
    function getOrCreateNotificationContainer() {
        let container = document.getElementById('notificationContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notificationContainer';
            container.className = 'notification-container';
            document.body.appendChild(container);
        }
        return container;
    }
    
    function cerrarNotificacion(button) {
        const notification = button.closest('.notification');
        notification.classList.add('notification-exit');
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 300);
    }
    
    // Validaciones frontend
    function validarTransicionEstado(estadoActual, nuevoEstado) {
        const transicionesPosibles = estadosPermitidos[estadoActual] || [];
        return transicionesPosibles.includes(nuevoEstado);
    }
    
    // Función para verificar permisos de usuario (simulada)
    function tienePermisosCambioEstado(estado) {
        // En una implementación real, esto verificaría los permisos del usuario actual
        // Por ahora, asumimos que todos los usuarios tienen permisos
        return true;
    }
    
    // Función auxiliar para limpiar elementos residuales de modales
    function limpiarElementosResidualesModal() {
        // Remover cualquier backdrop que pueda haber quedado
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Asegurar que el body no tenga clases de modal
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Remover cualquier estilo inline que pueda interferir
        document.body.removeAttribute('style');
    }
    
    // Función para cargar gestión de estados
    function cargarGestionEstados(devolucionId, estadoActual) {
        // Verificar si ya existe el contenedor de gestión de estados
        let gestionContainer = document.getElementById('gestionEstadosContainer');
        
        if (!gestionContainer) {
            // Crear el contenedor si no existe
            const modalBody = document.querySelector('#modalDetallesDevolucion .modal-body');
            if (modalBody) {
                gestionContainer = document.createElement('div');
                gestionContainer.id = 'gestionEstadosContainer';
                gestionContainer.innerHTML = `
                    <div class="gestion-estados">
                        <div class="gestion-estados-header">
                            <i class="fas fa-cogs"></i>
                            <span>Gestión de Estados</span>
                        </div>
                        <div class="botones-transicion" id="botonesTransicion">
                            <!-- Los botones se cargarán dinámicamente -->
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn-historial" onclick="mostrarHistorialEstados(${devolucionId})">
                                <i class="fas fa-history"></i>
                                Ver Historial
                            </button>
                        </div>
                    </div>
                `;
                modalBody.appendChild(gestionContainer);
            }
        }
        
        // Cargar botones de transición
        cargarBotonesTransicion(devolucionId, estadoActual);
    }
    

    // Agregar event listeners para limpiar elementos residuales cuando los modales se cierren
    const modalConfirmarCambio = document.getElementById('modalConfirmarCambio');
    if (modalConfirmarCambio) {
        modalConfirmarCambio.addEventListener('hidden.bs.modal', function () {
            setTimeout(() => {
                limpiarElementosResidualesModal();
            }, 100);
        });
    }
    
    const modalDetallesDevolucion = document.getElementById('modalDetallesDevolucion');
    if (modalDetallesDevolucion) {
        modalDetallesDevolucion.addEventListener('hidden.bs.modal', function () {
            setTimeout(() => {
                limpiarElementosResidualesModal();
            }, 100);
        });
    }
    
    const modalHistorialEstados = document.getElementById('modalHistorialEstados');
    if (modalHistorialEstados) {
        modalHistorialEstados.addEventListener('hidden.bs.modal', function () {
            setTimeout(() => {
                limpiarElementosResidualesModal();
            }, 100);
        });
    }

    // Hacer funciones globales
    window.abrirModalDetalles = abrirModalDetalles;
    window.eliminarElemento = eliminarElemento;
    window.verResumen = verResumen;
    window.cargarGestionEstados = cargarGestionEstados;
    window.confirmarCambioEstado = confirmarCambioEstado;
    window.mostrarHistorialEstados = mostrarHistorialEstados;
    window.cerrarNotificacion = cerrarNotificacion;
    window.cargarBotonesTransicion = cargarBotonesTransicion;
    window.limpiarElementosResidualesModal = limpiarElementosResidualesModal;
});
</script>
{% endblock %}