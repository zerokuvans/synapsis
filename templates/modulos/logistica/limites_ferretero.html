{% extends "base.html" %}

{% block title %}Gestión de Límites Ferretero{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title">
                        <i class="fas fa-cogs"></i> Gestión de Límites Ferretero
                    </h3>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevoLimite">
                        <i class="fas fa-plus"></i> Nuevo Límite
                    </button>
                </div>
                <div class="card-body">
                    <!-- Filtros -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="filtroArea" class="form-label">Área de Trabajo</label>
                            <select class="form-select" id="filtroArea">
                                <option value="">Todas las áreas</option>
                                {% for area in areas_trabajo %}
                                <option value="{{ area.area_trabajo }}">{{ area.area_trabajo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filtroMaterial" class="form-label">Material</label>
                            <select class="form-select" id="filtroMaterial">
                                <option value="">Todos los materiales</option>
                                <option value="cinta_aislante">Cinta Aislante</option>
                                <option value="silicona">Silicona</option>
                                <option value="amarres_negros">Amarres Negros</option>
                                <option value="amarres_blancos">Amarres Blancos</option>
                                <option value="grapas_blancas">Grapas Blancas</option>
                                <option value="grapas_negras">Grapas Negras</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filtroEstado" class="form-label">Estado</label>
                            <select class="form-select" id="filtroEstado">
                                <option value="true">Activos</option>
                                <option value="false">Inactivos</option>
                                <option value="">Todos</option>
                            </select>
                        </div>
                    </div>

                    <!-- Tabla de límites -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tablaLimites">
                            <thead class="table-dark">
                                <tr>
                                    <th>Área de Trabajo</th>
                                    <th>Material</th>
                                    <th>Cantidad Límite</th>
                                    <th>Período (días)</th>
                                    <th>Unidad</th>
                                    <th>Estado</th>
                                    <th>Última Actualización</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for limite in limites %}
                                <tr data-id="{{ limite.id_limite }}" class="{% if not limite.activo %}table-secondary{% endif %}">
                                    <td>{{ limite.area_trabajo }}</td>
                                    <td>
                                        <span class="badge bg-info">{{ limite.material_tipo.replace('_', ' ').title() }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ limite.cantidad_limite }}</strong>
                                    </td>
                                    <td>{{ limite.periodo_dias }}</td>
                                    <td>{{ limite.unidad_medida }}</td>
                                    <td>
                                        {% if limite.activo %}
                                            <span class="badge bg-success">Activo</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if limite.fecha_actualizacion %}
                                            {{ limite.fecha_actualizacion.strftime('%d/%m/%Y %H:%M') }}
                                            <br><small class="text-muted">{{ limite.usuario_actualizacion }}</small>
                                        {% else %}
                                            <small class="text-muted">Sin actualizar</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="editarLimite({{ limite.id_limite }})" 
                                                    title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-info" 
                                                    onclick="verHistorial({{ limite.id_limite }})" 
                                                    title="Ver Historial">
                                                <i class="fas fa-history"></i>
                                            </button>
                                            {% if limite.activo %}
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="desactivarLimite({{ limite.id_limite }})" 
                                                    title="Desactivar">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                            {% else %}
                                            <button type="button" class="btn btn-sm btn-outline-success" 
                                                    onclick="activarLimite({{ limite.id_limite }})" 
                                                    title="Activar">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuevo/Editar Límite -->
<div class="modal fade" id="modalNuevoLimite" tabindex="-1" aria-labelledby="modalNuevoLimiteLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevoLimiteLabel">Nuevo Límite</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formLimite">
                <div class="modal-body">
                    <input type="hidden" id="idLimite" name="id_limite">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="areaTrabajoModal" class="form-label">Área de Trabajo *</label>
                                <select class="form-select" id="areaTrabajoModal" name="area_trabajo" required>
                                    <option value="">Seleccione un área</option>
                                    <option value="FTTH INSTALACIONES">FTTH INSTALACIONES</option>
                                    <option value="INSTALACIONES DOBLES">INSTALACIONES DOBLES</option>
                                    <option value="POSTVENTA">POSTVENTA</option>
                                    <option value="MANTENIMIENTO FTTH">MANTENIMIENTO FTTH</option>
                                    <option value="ARREGLOS HFC">ARREGLOS HFC</option>
                                    <option value="CONDUCTOR">CONDUCTOR</option>
                                    <option value="SUPERVISORES">SUPERVISORES</option>
                                    <option value="BROWNFIELD">BROWNFIELD</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="materialTipoModal" class="form-label">Material *</label>
                                <select class="form-select" id="materialTipoModal" name="material_tipo" required>
                                    <option value="">Seleccione un material</option>
                                    <option value="cinta_aislante">Cinta Aislante</option>
                                    <option value="silicona">Silicona</option>
                                    <option value="amarres_negros">Amarres Negros</option>
                                    <option value="amarres_blancos">Amarres Blancos</option>
                                    <option value="grapas_blancas">Grapas Blancas</option>
                                    <option value="grapas_negras">Grapas Negras</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="cantidadLimiteModal" class="form-label">Cantidad Límite *</label>
                                <input type="number" class="form-control" id="cantidadLimiteModal" 
                                       name="cantidad_limite" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="periodoDiasModal" class="form-label">Período (días) *</label>
                                <input type="number" class="form-control" id="periodoDiasModal" 
                                       name="periodo_dias" min="1" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="unidadMedidaModal" class="form-label">Unidad de Medida</label>
                                <select class="form-select" id="unidadMedidaModal" name="unidad_medida">
                                    <option value="unidades">Unidades</option>
                                    <option value="días">Días</option>
                                    <option value="metros">Metros</option>
                                    <option value="kilos">Kilos</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="descripcionModal" class="form-label">Descripción</label>
                        <textarea class="form-control" id="descripcionModal" name="descripcion" 
                                  rows="3" placeholder="Descripción opcional del límite"></textarea>
                    </div>
                    
                    <div class="mb-3" id="estadoContainer" style="display: none;">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="activoModal" name="activo" checked>
                            <label class="form-check-label" for="activoModal">
                                Límite activo
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnGuardarLimite">Guardar Límite</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Historial -->
<div class="modal fade" id="modalHistorial" tabindex="-1" aria-labelledby="modalHistorialLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalHistorialLabel">Historial de Cambios</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="contenidoHistorial">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Inicializar DataTable
    $('#tablaLimites').DataTable({
        language: {
            decimal: ',',
            thousands: '.',
            processing: 'Procesando...',
            search: 'Buscar:',
            lengthMenu: 'Mostrar _MENU_ registros',
            info: 'Mostrando _START_ a _END_ de _TOTAL_ registros',
            infoEmpty: 'Mostrando 0 a 0 de 0 registros',
            infoFiltered: '(filtrado de _MAX_ registros en total)',
            loadingRecords: 'Cargando...',
            zeroRecords: 'No se encontraron resultados',
            emptyTable: 'No hay datos disponibles en la tabla',
            paginate: {
                first: 'Primero',
                previous: 'Anterior',
                next: 'Siguiente',
                last: 'Último'
            },
            aria: {
                sortAscending: ': activar para ordenar la columna ascendente',
                sortDescending: ': activar para ordenar la columna descendente'
            }
        },
        order: [[0, 'asc'], [1, 'asc']],
        pageLength: 25,
        responsive: true
    });
    
    // Filtros
    $('#filtroArea, #filtroMaterial, #filtroEstado').on('change', function() {
        filtrarTabla();
    });
});

// Función para filtrar la tabla
function filtrarTabla() {
    const area = $('#filtroArea').val();
    const material = $('#filtroMaterial').val();
    const estado = $('#filtroEstado').val();
    
    const table = $('#tablaLimites').DataTable();
    
    // Aplicar filtros
    table.columns(0).search(area);
    table.columns(1).search(material);
    
    if (estado !== '') {
        const estadoTexto = estado === 'true' ? 'Activo' : 'Inactivo';
        table.columns(5).search(estadoTexto);
    } else {
        table.columns(5).search('');
    }
    
    table.draw();
}

// Función para editar límite
function editarLimite(idLimite) {
    $.get(`/api/limites_ferretero/${idLimite}`)
        .done(function(response) {
            if (response.status === 'success') {
                const limite = response.data;
                
                $('#modalNuevoLimiteLabel').text('Editar Límite');
                $('#idLimite').val(limite.id_limite);
                $('#areaTrabajoModal').val(limite.area_trabajo).prop('disabled', true);
                $('#materialTipoModal').val(limite.material_tipo).prop('disabled', true);
                $('#cantidadLimiteModal').val(limite.cantidad_limite);
                $('#periodoDiasModal').val(limite.periodo_dias);
                $('#unidadMedidaModal').val(limite.unidad_medida);
                $('#descripcionModal').val(limite.descripcion);
                $('#activoModal').prop('checked', limite.activo);
                $('#estadoContainer').show();
                
                $('#modalNuevoLimite').modal('show');
            }
        })
        .fail(function() {
            Swal.fire('Error', 'No se pudo cargar la información del límite', 'error');
        });
}

// Función para ver historial
function verHistorial(idLimite) {
    $('#modalHistorial').modal('show');
    $('#contenidoHistorial').html(`
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    `);
    
    $.get(`/api/limites_ferretero/historial/${idLimite}`)
        .done(function(response) {
            if (response.status === 'success') {
                let html = '';
                if (response.data.length === 0) {
                    html = '<p class="text-muted text-center">No hay historial de cambios para este límite.</p>';
                } else {
                    html = `
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Acción</th>
                                        <th>Usuario</th>
                                        <th>Cambios</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    response.data.forEach(function(item) {
                        let cambios = '';
                        if (item.cantidad_limite_anterior !== item.cantidad_limite_nueva) {
                            cambios += `Cantidad: ${item.cantidad_limite_anterior} → ${item.cantidad_limite_nueva}<br>`;
                        }
                        if (item.periodo_dias_anterior !== item.periodo_dias_nuevo) {
                            cambios += `Período: ${item.periodo_dias_anterior} → ${item.periodo_dias_nuevo} días<br>`;
                        }
                        
                        html += `
                            <tr>
                                <td>${new Date(item.fecha_cambio).toLocaleString()}</td>
                                <td><span class="badge bg-info">${item.accion}</span></td>
                                <td>${item.usuario}</td>
                                <td>${cambios || 'Sin cambios'}</td>
                                <td>${item.observaciones || ''}</td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table></div>';
                }
                $('#contenidoHistorial').html(html);
            }
        })
        .fail(function() {
            $('#contenidoHistorial').html('<p class="text-danger text-center">Error al cargar el historial</p>');
        });
}

// Función para desactivar límite
function desactivarLimite(idLimite) {
    Swal.fire({
        title: '¿Desactivar límite?',
        text: 'El límite será desactivado pero no eliminado',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, desactivar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: `/api/limites_ferretero/${idLimite}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.status === 'success') {
                        Swal.fire('Éxito', response.message, 'success');
                        location.reload();
                    }
                },
                error: function() {
                    Swal.fire('Error', 'No se pudo desactivar el límite', 'error');
                }
            });
        }
    });
}

// Función para activar límite
function activarLimite(idLimite) {
    $.ajax({
        url: `/api/limites_ferretero/${idLimite}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify({ activo: true }),
        success: function(response) {
            if (response.status === 'success') {
                Swal.fire('Éxito', 'Límite activado correctamente', 'success');
                location.reload();
            }
        },
        error: function() {
            Swal.fire('Error', 'No se pudo activar el límite', 'error');
        }
    });
}

// Manejar envío del formulario
$('#formLimite').on('submit', function(e) {
    e.preventDefault();
    
    const idLimite = $('#idLimite').val();
    const isEdit = idLimite !== '';
    
    const formData = {
        area_trabajo: $('#areaTrabajoModal').val(),
        material_tipo: $('#materialTipoModal').val(),
        cantidad_limite: parseInt($('#cantidadLimiteModal').val()),
        periodo_dias: parseInt($('#periodoDiasModal').val()),
        unidad_medida: $('#unidadMedidaModal').val(),
        descripcion: $('#descripcionModal').val()
    };
    
    if (isEdit) {
        formData.activo = $('#activoModal').is(':checked');
    }
    
    const url = isEdit ? `/api/limites_ferretero/${idLimite}` : '/api/limites_ferretero';
    const method = isEdit ? 'PUT' : 'POST';
    
    $.ajax({
        url: url,
        method: method,
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.status === 'success') {
                Swal.fire('Éxito', response.message, 'success');
                $('#modalNuevoLimite').modal('hide');
                location.reload();
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            Swal.fire('Error', response?.message || 'Error al guardar el límite', 'error');
        }
    });
});

// Limpiar formulario al cerrar modal
$('#modalNuevoLimite').on('hidden.bs.modal', function() {
    $('#formLimite')[0].reset();
    $('#idLimite').val('');
    $('#modalNuevoLimiteLabel').text('Nuevo Límite');
    $('#areaTrabajoModal, #materialTipoModal').prop('disabled', false);
    $('#estadoContainer').hide();
});
</script>
{% endblock %}
