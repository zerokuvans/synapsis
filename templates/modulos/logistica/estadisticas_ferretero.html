{% extends "base.html" %}

{% block title %}Estad√≠sticas Ferretero{% endblock %}

<style>
.material-destacado {
    background-color: #fff3cd !important;
    border: 2px solid #ffc107 !important;
    font-weight: bold !important;
    color: #856404 !important;
}
</style>

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Estad√≠sticas de Material Ferretero</h1>
    <ol class="breadcrumb mb-4">
       <!-- <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('ver_asignaciones_ferretero') }}">Material Ferretero</a></li>
        <li class="breadcrumb-item active">Estad√≠sticas</li>-->
    </ol>
    
    <!-- Filtros para estad√≠sticas -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-filter me-1"></i>
            Filtros de Estad√≠sticas
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="filtroMes" class="form-label">Mes</label>
                    <select class="form-select" id="filtroMes">
                        <option value="todos">Todos los meses</option>
                        <option value="1">Enero</option>
                        <option value="2">Febrero</option>
                        <option value="3">Marzo</option>
                        <option value="4">Abril</option>
                        <option value="5">Mayo</option>
                        <option value="6">Junio</option>
                        <option value="7">Julio</option>
                        <option value="8">Agosto</option>
                        <option value="9">Septiembre</option>
                        <option value="10">Octubre</option>
                        <option value="11">Noviembre</option>
                        <option value="12">Diciembre</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="filtroMaterial" class="form-label">Material</label>
                    <select class="form-select" id="filtroMaterial">
                        <option value="todos">Todos los materiales</option>
                        <option value="silicona">Silicona</option>
                        <option value="amarres">Amarres</option>
                        <option value="cinta">Cinta Aislante</option>
                        <option value="grapas">Grapas</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label for="filtroArea" class="form-label">√Årea</label>
                    <select class="form-select" id="filtroArea">
                        <option value="todos">Todas las √°reas</option>
                        <option value="FTTH Instalaciones">FTTH Instalaciones</option>
                        <option value="Instalaciones Dobles">Instalaciones Dobles</option>
                        <option value="Postventa">Postventa</option>
                        <option value="Mantenimiento FTTH">Mantenimiento FTTH</option>
                        <option value="Arreglos HFC">Arreglos HFC</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div class="col-12 text-end">
                    <button type="button" class="btn btn-primary" id="btnActualizarEstadisticas">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar Estad√≠sticas
                    </button>
                    <button type="button" class="btn btn-success" id="btnExportarExcel">
                        <i class="fas fa-file-excel me-1"></i> Exportar a Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stock General de Material Ferretero -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <i class="fas fa-warehouse me-1"></i>
            Stock General de Material Ferretero
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-12 text-end">
                    <button type="button" class="btn btn-primary" id="btnActualizarStock">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar Stock
                    </button>
                    <button type="button" class="btn btn-success" id="btnRegistrarEntrada" data-bs-toggle="modal" data-bs-target="#modalRegistrarEntrada">
                        <i class="fas fa-plus me-1"></i> Registrar Entrada
                    </button>
                    <button type="button" class="btn btn-warning" id="btnTransferirSuministro" data-bs-toggle="modal" data-bs-target="#modalTransferirSuministro">
                        <i class="fas fa-exchange-alt me-1"></i> Transferir desde Suministros
                    </button>
                    <button type="button" class="btn btn-info" id="btnVerMovimientos" data-bs-toggle="modal" data-bs-target="#modalMovimientos">
                        <i class="fas fa-history me-1"></i> Ver Movimientos
                    </button>
                </div>
            </div>
            <div class="row">
                <div class="col-md-8">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Material</th>
                                    <th>Stock Actual</th>
                                    <th>Stock M√≠nimo</th>
                                    <th>Estado</th>
                                    <th>√öltima Actualizaci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="tablaStockBody">
                                <tr>
                                    <td colspan="5" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-2">Cargando stock...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-chart-line me-1"></i>
                            Asignado Este Mes
                        </div>
                        <div class="card-body">
                            <div id="asignadoMesActual">
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                    <p class="mt-2">Cargando datos...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumen de Inventario -->
    <div class="card mb-4">
        <div class="card-header bg-warning text-dark">
            <i class="fas fa-calculator me-1"></i>
            Resumen de Inventario y C√°lculos
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Total Recibido</th>
                            <th>Total Asignado</th>
                            <th>Stock Actual</th>
                            <th>D√≠as de Alcance</th>
                            <th>Diferencia Real</th>
                            <th>Valor Entradas</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="tablaResumenInventario">
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mt-2">Cargando resumen de inventario...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Comparaci√≥n Mes a Mes de Asignaciones -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <i class="fas fa-chart-line me-1"></i>
            Asignaciones Mes a Mes de Materiales
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="filtroMaterialComparacion" class="form-label">Seleccionar Material</label>
                    <select class="form-select" id="filtroMaterialComparacion">
                        <option value="silicona">Silicona</option>
                        <option value="amarres_negros">Amarres Negros</option>
                        <option value="amarres_blancos">Amarres Blancos</option>
                        <option value="cinta_aislante">Cinta Aislante</option>
                        <option value="grapas_blancas">Grapas Blancas</option>
                        <option value="grapas_negras">Grapas Negras</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="anioComparacion" class="form-label">A√±o</label>
                    <select class="form-select" id="anioComparacion">
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="tipoGrafico" class="form-label">Tipo de Gr√°fico</label>
                    <select class="form-select" id="tipoGrafico">
                        <option value="line" selected>üìà L√≠neas</option>
                        <option value="bar">üìä Barras</option>
                        <option value="pie">ü•ß Pastel</option>
                    </select>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-primary" id="btnActualizarComparacion">
                        <i class="fas fa-sync-alt me-1"></i> Actualizar Gr√°fico
                    </button>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Gr√°fico de Asignaciones:</strong> Muestra las cantidades de material asignadas a t√©cnicos por mes.
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div style="height: 400px;">
                        <canvas id="graficoComparacionMensual"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumen de Estad√≠sticas -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <i class="fas fa-chart-bar me-1"></i>
                    Estad√≠sticas por T√©cnico
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Mostrar columnas:</label>
                        <div class="d-flex gap-3 flex-wrap">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mostrarSilicona" checked>
                                <label class="form-check-label" for="mostrarSilicona">
                                    <span class="badge" style="background-color: #6f42c1;">‚óè</span> Silicona
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mostrarAmarres" checked>
                                <label class="form-check-label" for="mostrarAmarres">
                                    <span class="badge" style="background-color: #fd7e14;">‚óè</span> Amarres
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mostrarCinta" checked>
                                <label class="form-check-label" for="mostrarCinta">
                                    <span class="badge" style="background-color: #20c997;">‚óè</span> Cinta
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="mostrarGrapas" checked>
                                <label class="form-check-label" for="mostrarGrapas">
                                    <span class="badge" style="background-color: #e83e8c;">‚óè</span> Grapas
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>T√©cnico</th>
                                    <th>√Årea</th>
                                    <th class="sortable" data-column="silicona" style="cursor: pointer;">
                                        Silicona <i class="fas fa-sort text-muted" id="sort-silicona"></i>
                                    </th>
                                    <th class="sortable" data-column="amarres" style="cursor: pointer;">
                                        Amarres <i class="fas fa-sort text-muted" id="sort-amarres"></i>
                                    </th>
                                    <th class="sortable" data-column="cinta" style="cursor: pointer;">
                                        Cinta <i class="fas fa-sort text-muted" id="sort-cinta"></i>
                                    </th>
                                    <th class="sortable" data-column="grapas" style="cursor: pointer;">
                                        Grapas <i class="fas fa-sort text-muted" id="sort-grapas"></i>
                                    </th>
                                    <th class="sortable" data-column="total" style="cursor: pointer;">
                                        Total <i class="fas fa-sort text-muted" id="sort-total"></i>
                                    </th>
                                    <!-- <th>Promedio Mensual</th> -->
                                </tr>
                            </thead>
                            <tbody id="tablaEstadisticasBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                        <p class="mt-2">Cargando estad√≠sticas...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <i class="fas fa-trophy me-1"></i>
                            Top 5 T√©cnicos con Mayor Asignaci√≥n
                        </div>
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>T√©cnico</th>
                                        <th>Total</th>
                                        <th>Porcentaje</th>
                                    </tr>
                                </thead>
                                <tbody id="topTecnicosBody">
                                    <!-- Contenido din√°mico -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <i class="fas fa-chart-pie me-1"></i>
                            Distribuci√≥n por √Årea
                        </div>
                        <div class="card-body">
                            <canvas id="graficoDistribucion"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Variables globales para los gr√°ficos
    let graficoDistribucion = null;
    let graficoComparacionMensual = null;
    let datosComparacionActuales = null; // Para almacenar los datos actuales del gr√°fico
    let datosEstadisticasActuales = null; // Para almacenar los datos actuales de la tabla
    
    // Variables globales para ordenamiento
    let ordenActual = { columna: null, direccion: 'asc' };
    
    // Funci√≥n para cargar las estad√≠sticas al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        cargarEstadisticasFerretero();
        cargarComparacionMensual(); // Cargar gr√°fico de comparaci√≥n mensual
        
        // Eventos para los filtros
        document.getElementById('btnActualizarEstadisticas').addEventListener('click', cargarEstadisticasFerretero);
        document.getElementById('btnExportarExcel').addEventListener('click', exportarEstadisticasExcel);
        
        // Eventos para comparaci√≥n mensual
        document.getElementById('btnActualizarComparacion').addEventListener('click', cargarComparacionMensual);
        document.getElementById('filtroMaterialComparacion').addEventListener('change', cargarComparacionMensual);
        document.getElementById('anioComparacion').addEventListener('change', cargarComparacionMensual);
        document.getElementById('tipoGrafico').addEventListener('change', cargarComparacionMensual);
        
        // Los checkboxes de filtro del gr√°fico fueron removidos ya que ahora solo muestra asignaciones
        
        // Eventos para los checkboxes de filtro de la tabla
        document.getElementById('mostrarSilicona').addEventListener('change', actualizarTablaConFiltros);
        document.getElementById('mostrarAmarres').addEventListener('change', actualizarTablaConFiltros);
        document.getElementById('mostrarCinta').addEventListener('change', actualizarTablaConFiltros);
        document.getElementById('mostrarGrapas').addEventListener('change', actualizarTablaConFiltros);
        
        // Eventos para ordenamiento de la tabla
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                ordenarTabla(column);
            });
        });
    });
    
    // Funci√≥n para cargar las estad√≠sticas de asignaci√≥n de ferretero
    function cargarEstadisticasFerretero() {
        const filtroMes = document.getElementById('filtroMes').value;
        const filtroMaterial = document.getElementById('filtroMaterial').value;
        const filtroArea = document.getElementById('filtroArea').value;
        
        // Mostrar indicador de carga
        document.getElementById('tablaEstadisticasBody').innerHTML = `
            <tr>
                <td colspan="8" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando estad√≠sticas...</p>
                </td>
            </tr>
        `;
        
        // Limpiar el top 5 y el gr√°fico mientras se carga
        document.getElementById('topTecnicosBody').innerHTML = '';
        if (graficoDistribucion) {
            graficoDistribucion.destroy();
        }
        
        // Realizar la petici√≥n al servidor
        fetch(`/logistica/estadisticas_ferretero?mes=${filtroMes}&material=${filtroMaterial}&area=${filtroArea}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                if (data.message && data.estadisticas.length === 0) {
                    // Mostrar mensaje cuando no hay datos
                    document.getElementById('tablaEstadisticasBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    ${data.message}
                                </div>
                            </td>
                        </tr>
                    `;
                    
                    // Limpiar el top 5 y el gr√°fico
                    document.getElementById('topTecnicosBody').innerHTML = `
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-users me-2"></i>
                            No hay datos disponibles para mostrar el top de t√©cnicos.
                        </div>
                    `;
                    
                    // Mostrar gr√°fico vac√≠o
                    generarGraficoDistribucion([], []);
                } else {
                    // Llenar la tabla de estad√≠sticas
                    llenarTablaEstadisticas(data.estadisticas);
                    
                    // Llenar el top 5 de t√©cnicos
                    llenarTopTecnicos(data.top_tecnicos);
                    
                    // Generar el gr√°fico de distribuci√≥n por √°rea
                    generarGraficoDistribucion(
                        data.distribucion_area.map(item => item.area),
                        data.distribucion_area.map(item => item.total)
                    );
                }
            } else {
                // Mostrar mensaje de error
                document.getElementById('tablaEstadisticasBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                ${data.message || 'Error al cargar los datos.'}
                            </div>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error al cargar estad√≠sticas:', error);
            document.getElementById('tablaEstadisticasBody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error al cargar los datos. Por favor, intenta de nuevo.
                    </td>
                </tr>
            `;
        });
    }
    
    // Funci√≥n para llenar la tabla de estad√≠sticas
    function llenarTablaEstadisticas(estadisticas) {
        // Almacenar los datos para uso posterior con filtros
        datosEstadisticasActuales = estadisticas;
        
        const tbody = document.getElementById('tablaEstadisticasBody');
        tbody.innerHTML = '';
        
        // Verificar qu√© columnas mostrar seg√∫n los checkboxes
        const mostrarSilicona = document.getElementById('mostrarSilicona').checked;
        const mostrarAmarres = document.getElementById('mostrarAmarres').checked;
        const mostrarCinta = document.getElementById('mostrarCinta').checked;
        const mostrarGrapas = document.getElementById('mostrarGrapas').checked;
        
        // Actualizar encabezados de la tabla
        actualizarEncabezadosTabla(mostrarSilicona, mostrarAmarres, mostrarCinta, mostrarGrapas);
        
        // Obtener el material filtrado para destacar la columna correspondiente
        const filtroMaterial = document.getElementById('filtroMaterial').value;
        
        // Limpiar clases de columnas destacadas anteriores
        document.querySelectorAll('.material-destacado').forEach(el => {
            el.classList.remove('material-destacado');
        });
        
        // Destacar la columna del material filtrado
        if (filtroMaterial && filtroMaterial !== 'todos') {
            let columnaIndex = -1;
            switch(filtroMaterial) {
                case 'silicona': columnaIndex = 2; break;
                case 'amarres': columnaIndex = 3; break;
                case 'cinta': columnaIndex = 4; break;
                case 'grapas': columnaIndex = 5; break;
            }
            
            if (columnaIndex >= 0) {
                // Destacar header de la columna
                const headers = document.querySelectorAll('#tablaEstadisticas thead th');
                if (headers[columnaIndex]) {
                    headers[columnaIndex].classList.add('material-destacado');
                }
            }
        }
        
        if (estadisticas.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        No se encontraron datos para los filtros seleccionados.
                    </td>
                </tr>
            `;
            return;
        }
        
        estadisticas.forEach(item => {
            const fila = document.createElement('tr');
            
            // Destacar los t√©cnicos con asignaciones por encima del promedio
            if (item.por_encima_promedio) {
                fila.classList.add('table-warning');
            }
            
            // Si est√° muy por encima del promedio (>50%), destacar m√°s
            if (item.muy_por_encima_promedio) {
                fila.classList.add('table-danger');
            }
            
            let filaHTML = `
                <td>${item.nombre}</td>
                <td>${item.area || 'No especificada'}</td>
            `;
            
            // Agregar columnas seg√∫n filtros
            if (mostrarSilicona) {
                filaHTML += `<td class="${filtroMaterial === 'silicona' ? 'material-destacado' : ''}">${item.silicona || 0}</td>`;
            }
            if (mostrarAmarres) {
                filaHTML += `<td class="${filtroMaterial === 'amarres' ? 'material-destacado' : ''}">${(item.amarres_negros || 0) + (item.amarres_blancos || 0)}</td>`;
            }
            if (mostrarCinta) {
                filaHTML += `<td class="${filtroMaterial === 'cinta' ? 'material-destacado' : ''}">${item.cinta_aislante || 0}</td>`;
            }
            if (mostrarGrapas) {
                filaHTML += `<td class="${filtroMaterial === 'grapas' ? 'material-destacado' : ''}">${(item.grapas_blancas || 0) + (item.grapas_negras || 0)}</td>`;
            }
            
            filaHTML += `<td><strong>${item.total_asignaciones || 0}</strong></td>`;
            
            fila.innerHTML = filaHTML;
            
            tbody.appendChild(fila);
        });
    }
    
    // Funci√≥n para llenar el top 5 de t√©cnicos
    function llenarTopTecnicos(topTecnicos) {
        const tbody = document.getElementById('topTecnicosBody');
        tbody.innerHTML = '';
        
        if (!topTecnicos || topTecnicos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center">
                        No hay datos disponibles para mostrar el top de t√©cnicos.
                    </td>
                </tr>
            `;
            return;
        }
        
        topTecnicos.forEach(tecnico => {
            const fila = document.createElement('tr');
            fila.innerHTML = `
                <td>${tecnico.nombre}</td>
                <td>${tecnico.total_asignaciones}</td>
                <td>
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" style="width: ${tecnico.porcentaje}%" 
                            aria-valuenow="${tecnico.porcentaje}" aria-valuemin="0" aria-valuemax="100">
                            ${tecnico.porcentaje}%
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(fila);
        });
    }
    
    // Funci√≥n para generar el gr√°fico de distribuci√≥n por √°rea
    function generarGraficoDistribucion(labels, data) {
        const ctx = document.getElementById('graficoDistribucion').getContext('2d');
        
        // Destruir el gr√°fico anterior si existe
        if (graficoDistribucion) {
            graficoDistribucion.destroy();
        }
        
        // Colores para el gr√°fico
        const backgroundColors = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#5a5c69', '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
        ];
        
        // Crear el nuevo gr√°fico
        graficoDistribucion = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels.length > 0 ? labels : ['Sin datos'],
                datasets: [{
                    data: data.length > 0 ? data : [1],
                    backgroundColor: backgroundColors,
                    hoverBackgroundColor: backgroundColors,
                    hoverBorderColor: "rgba(234, 236, 244, 1)",
                }],
            },
            options: {
                maintainAspectRatio: false,
                tooltips: {
                    backgroundColor: "rgb(255,255,255)",
                    bodyFontColor: "#858796",
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    caretPadding: 10,
                },
                legend: {
                    display: true,
                    position: 'bottom'
                },
                cutoutPercentage: 0,
            },
        });
    }
    
    // Funci√≥n para exportar estad√≠sticas a Excel
    function exportarEstadisticasExcel() {
        const filtroMes = document.getElementById('filtroMes').value;
        const filtroMaterial = document.getElementById('filtroMaterial').value;
        const filtroArea = document.getElementById('filtroArea').value;
        
        // Mostrar indicador de carga
        Swal.fire({
            title: 'Generando Excel',
            text: 'Por favor espere mientras se genera el archivo...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Realizar la petici√≥n al servidor
        fetch(`/logistica/exportar_estadisticas_ferretero?mes=${filtroMes}&material=${filtroMaterial}&area=${filtroArea}`, {
            method: 'GET',
            credentials: 'include'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.blob();
        })
        .then(blob => {
            // Crear un objeto URL para el blob
            const url = window.URL.createObjectURL(blob);
            
            // Crear un elemento <a> para descargar el archivo
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            
            // Obtener el nombre del archivo de las cabeceras de respuesta o usar uno predeterminado
            const contentDisposition = response.headers.get('content-disposition');
            let filename = 'Estadisticas_Ferretero.xlsx';
            
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="(.+)"/i);
                if (filenameMatch && filenameMatch[1]) {
                    filename = filenameMatch[1];
                }
            }
            
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            
            // Limpiar
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            Swal.fire({
                icon: 'success',
                title: 'Excel Generado',
                text: 'El archivo se ha descargado correctamente.',
                timer: 2000,
                showConfirmButton: false
            });
        })
        .catch(error => {
            console.error('Error al exportar a Excel:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'No se pudo generar el archivo Excel. Por favor, intente nuevamente.',
            });
        });
    }
    
    // ===== FUNCIONES PARA COMPARACI√ìN MENSUAL =====
    
    // Funci√≥n para cargar la comparaci√≥n mensual de materiales
    function cargarComparacionMensual() {
        const material = document.getElementById('filtroMaterialComparacion').value;
        const anio = document.getElementById('anioComparacion').value;
        
        // Realizar la petici√≥n al servidor
        fetch(`/api/comparacion_mensual_materiales?material=${material}&anio=${anio}`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // Almacenar los datos para uso posterior con filtros
                datosComparacionActuales = {
                    datos_mensuales: data.datos_mensuales,
                    material: material
                };
                generarGraficoComparacionMensual(data.datos_mensuales, material);
            } else {
                console.error('Error en la respuesta:', data.message);
                // Mostrar gr√°fico vac√≠o en caso de error
                datosComparacionActuales = { datos_mensuales: [], material: material };
                generarGraficoComparacionMensual([], material);
            }
        })
        .catch(error => {
            console.error('Error al cargar comparaci√≥n mensual:', error);
            // Mostrar gr√°fico vac√≠o en caso de error
            generarGraficoComparacionMensual([], material);
        });
    }
    
    // Funci√≥n para actualizar el gr√°fico con los filtros seleccionados
    function actualizarGraficoConFiltros() {
        if (datosComparacionActuales) {
            generarGraficoComparacionMensual(
                datosComparacionActuales.datos_mensuales, 
                datosComparacionActuales.material
            );
        }
    }
    
    // Funci√≥n para actualizar la tabla con los filtros seleccionados
    function actualizarTablaConFiltros() {
        if (datosEstadisticasActuales) {
            llenarTablaEstadisticas(datosEstadisticasActuales);
        }
    }
    
    // Funci√≥n para ordenar la tabla
    function ordenarTabla(columna) {
        if (!datosEstadisticasActuales || datosEstadisticasActuales.length === 0) {
            return;
        }
        
        // Determinar la direcci√≥n del ordenamiento
        if (ordenActual.columna === columna) {
            ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
        } else {
            ordenActual.columna = columna;
            ordenActual.direccion = 'asc';
        }
        
        // Actualizar iconos de ordenamiento
        actualizarIconosOrdenamiento(columna, ordenActual.direccion);
        
        // Crear una copia de los datos para ordenar
        const datosOrdenados = [...datosEstadisticasActuales];
        
        // Funci√≥n de comparaci√≥n
        datosOrdenados.sort((a, b) => {
            let valorA, valorB;
            
            switch (columna) {
                case 'silicona':
                    valorA = parseInt(a.silicona) || 0;
                    valorB = parseInt(b.silicona) || 0;
                    break;
                case 'amarres':
                    valorA = (parseInt(a.amarres_negros) || 0) + (parseInt(a.amarres_blancos) || 0);
                    valorB = (parseInt(b.amarres_negros) || 0) + (parseInt(b.amarres_blancos) || 0);
                    break;
                case 'cinta':
                    valorA = parseInt(a.cinta_aislante) || 0;
                    valorB = parseInt(b.cinta_aislante) || 0;
                    break;
                case 'grapas':
                    valorA = (parseInt(a.grapas_blancas) || 0) + (parseInt(a.grapas_negras) || 0);
                    valorB = (parseInt(b.grapas_blancas) || 0) + (parseInt(b.grapas_negras) || 0);
                    break;
                case 'total':
                    valorA = parseInt(a.total_asignaciones) || 0;
                    valorB = parseInt(b.total_asignaciones) || 0;
                    break;
                default:
                    return 0;
            }
            
            if (ordenActual.direccion === 'asc') {
                return valorA - valorB;
            } else {
                return valorB - valorA;
            }
        });
        
        // Actualizar la tabla con los datos ordenados
        llenarTablaEstadisticas(datosOrdenados);
    }
    
    // Funci√≥n para actualizar los iconos de ordenamiento
    function actualizarIconosOrdenamiento(columnaActiva, direccion) {
        // Resetear todos los iconos
        document.querySelectorAll('.sortable i').forEach(icon => {
            icon.className = 'fas fa-sort text-muted';
        });
        
        // Actualizar el icono de la columna activa
        const iconoActivo = document.getElementById(`sort-${columnaActiva}`);
        if (iconoActivo) {
            if (direccion === 'asc') {
                iconoActivo.className = 'fas fa-sort-up text-primary';
            } else {
                iconoActivo.className = 'fas fa-sort-down text-primary';
            }
        }
    }
    
    // Funci√≥n para actualizar los encabezados de la tabla seg√∫n los filtros
    function actualizarEncabezadosTabla(mostrarSilicona, mostrarAmarres, mostrarCinta, mostrarGrapas) {
        const thead = document.querySelector('#tablaEstadisticasBody').closest('table').querySelector('thead tr');
        
        // Limpiar encabezados existentes
        thead.innerHTML = `
            <th>T√©cnico</th>
            <th>√Årea</th>
        `;
        
        // Agregar encabezados seg√∫n filtros con iconos de ordenamiento
        if (mostrarSilicona) {
            thead.innerHTML += `
                <th class="sortable" data-column="silicona" style="cursor: pointer;">
                    Silicona <i class="fas fa-sort text-muted" id="sort-silicona"></i>
                </th>
            `;
        }
        if (mostrarAmarres) {
            thead.innerHTML += `
                <th class="sortable" data-column="amarres" style="cursor: pointer;">
                    Amarres <i class="fas fa-sort text-muted" id="sort-amarres"></i>
                </th>
            `;
        }
        if (mostrarCinta) {
            thead.innerHTML += `
                <th class="sortable" data-column="cinta" style="cursor: pointer;">
                    Cinta <i class="fas fa-sort text-muted" id="sort-cinta"></i>
                </th>
            `;
        }
        if (mostrarGrapas) {
            thead.innerHTML += `
                <th class="sortable" data-column="grapas" style="cursor: pointer;">
                    Grapas <i class="fas fa-sort text-muted" id="sort-grapas"></i>
                </th>
            `;
        }
        
        thead.innerHTML += `
            <th class="sortable" data-column="total" style="cursor: pointer;">
                Total <i class="fas fa-sort text-muted" id="sort-total"></i>
            </th>
        `;
        
        // Reagregar los event listeners para ordenamiento despu√©s de actualizar los encabezados
        document.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                ordenarTabla(column);
            });
        });
    }
    
    // Funci√≥n para generar el gr√°fico de comparaci√≥n mensual
    function generarGraficoComparacionMensual(datosMensuales, material) {
        const ctx = document.getElementById('graficoComparacionMensual').getContext('2d');
        
        // Destruir el gr√°fico anterior si existe
        if (graficoComparacionMensual) {
            graficoComparacionMensual.destroy();
        }
        
        // Obtener el tipo de gr√°fico seleccionado
        const tipoGrafico = document.getElementById('tipoGrafico').value;
        
        // Nombres de los meses
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        
        // Preparar datos para el gr√°fico
        let labels = [];
        let dataAsignaciones = [];
        
        if (datosMensuales && datosMensuales.length > 0) {
            // Crear un mapa para todos los meses
            const datosPorMes = {};
            datosMensuales.forEach(item => {
                datosPorMes[item.mes] = parseInt(item.cantidad_asignada) || 0;
            });
            
            // Llenar datos para todos los meses (1-12)
            for (let mes = 1; mes <= 12; mes++) {
                labels.push(meses[mes - 1]);
                dataAsignaciones.push(datosPorMes[mes] || 0);
            }
        } else {
            // Datos vac√≠os para todos los meses
            labels = meses;
            dataAsignaciones = new Array(12).fill(0);
        }
        
        // Obtener nombre del material para el t√≠tulo
        const materialNames = {
            'silicona': 'Silicona',
            'amarres_negros': 'Amarres Negros',
            'amarres_blancos': 'Amarres Blancos',
            'cinta_aislante': 'Cinta Aislante',
            'grapas_blancas': 'Grapas Blancas',
            'grapas_negras': 'Grapas Negras'
        };
        
        const nombreMaterial = materialNames[material] || material;
        
        // Configurar colores y estilos seg√∫n el tipo de gr√°fico
        let datasets = [];
        let chartOptions = {};
        
        if (tipoGrafico === 'pie') {
            // Para gr√°fico de pastel, usar solo meses con datos > 0
            const mesesConDatos = [];
            const datosConDatos = [];
            const coloresPastel = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
                '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
            ];
            
            dataAsignaciones.forEach((cantidad, index) => {
                if (cantidad > 0) {
                    mesesConDatos.push(labels[index]);
                    datosConDatos.push(cantidad);
                }
            });
            
            labels = mesesConDatos.length > 0 ? mesesConDatos : ['Sin datos'];
            
            datasets = [{
                label: 'Cantidad Asignada',
                data: datosConDatos.length > 0 ? datosConDatos : [0],
                backgroundColor: coloresPastel.slice(0, labels.length),
                borderColor: '#ffffff',
                borderWidth: 2
            }];
            
            chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Distribuci√≥n de Asignaciones - ${nombreMaterial}`,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'right'
                    }
                }
            };
        } else {
            // Para gr√°ficos de l√≠neas y barras
            const esLinea = tipoGrafico === 'line';
            
            datasets = [{
                label: 'Cantidad Asignada',
                data: dataAsignaciones,
                borderColor: '#6f42c1',
                backgroundColor: esLinea ? 'rgba(111, 66, 193, 0.1)' : 'rgba(111, 66, 193, 0.8)',
                borderWidth: esLinea ? 3 : 1,
                fill: esLinea,
                tension: esLinea ? 0.4 : 0,
                pointBackgroundColor: esLinea ? '#6f42c1' : undefined,
                pointBorderColor: esLinea ? '#ffffff' : undefined,
                pointBorderWidth: esLinea ? 2 : undefined,
                pointRadius: esLinea ? 6 : undefined,
                pointHoverRadius: esLinea ? 8 : undefined
            }];
            
            chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: `Asignaciones Mensuales - ${nombreMaterial}`,
                        font: {
                            size: 16,
                            weight: 'bold'
                        }
                    },
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Mes'
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            };
        }
        
        // Crear el nuevo gr√°fico
        graficoComparacionMensual = new Chart(ctx, {
            type: tipoGrafico,
            data: {
                labels: labels,
                datasets: datasets
            },
            options: chartOptions
        });
    }
    
    // ===== FUNCIONES PARA GESTI√ìN DE STOCK =====
    
    // Cargar stock al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        cargarStockFerretero();
        cargarResumenInventario();
        
        // Eventos para stock
        document.getElementById('btnActualizarStock').addEventListener('click', cargarStockFerretero);
        document.getElementById('btnGuardarEntrada').addEventListener('click', registrarEntradaFerretero);
        document.getElementById('btnTransferirSuministro').addEventListener('click', function() {
            cargarSuministrosDisponibles();
        });
        document.getElementById('btnCargarMovimientos').addEventListener('click', cargarMovimientosFerretero);
    });
    
    // Funci√≥n para cargar el stock de material ferretero
    function cargarStockFerretero() {
        fetch('/api/stock/materiales', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.disponibilidad) {
                llenarTablaStock(data.disponibilidad);
                // mostrarAsignadoMesActual(data.asignado_mes_actual);
                // mostrarResumenInventario(data.resumen_inventario);
            } else {
                document.getElementById('tablaStockBody').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Error al cargar el stock.
                            </div>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error al cargar stock:', error);
            document.getElementById('tablaStockBody').innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error al cargar el stock. Por favor, intente nuevamente.
                        </div>
                    </td>
                </tr>
            `;
        });
    }
    
    // Funci√≥n para llenar la tabla de stock
    function llenarTablaStock(disponibilidad) {
        const tbody = document.getElementById('tablaStockBody');
        tbody.innerHTML = '';
        
        if (!disponibilidad || Object.keys(disponibilidad).length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        No hay datos de stock disponibles.
                    </td>
                </tr>
            `;
            return;
        }
        
        const materialNames = {
            'silicona': 'Silicona',
            'amarres_negros': 'Amarres Negros',
            'amarres_blancos': 'Amarres Blancos',
            'cinta_aislante': 'Cinta Aislante',
            'grapas_blancas': 'Grapas Blancas',
            'grapas_negras': 'Grapas Negras'
        };
        
        Object.keys(disponibilidad).forEach(materialTipo => {
            const item = disponibilidad[materialTipo];
            const fila = document.createElement('tr');
            
            // Determinar estado del stock
            let estadoClass = 'success';
            let estadoTexto = 'Normal';
            let estadoIcon = 'check-circle';
            
            if (item.cantidad <= item.cantidad_minima) {
                estadoClass = 'danger';
                estadoTexto = 'Stock Bajo';
                estadoIcon = 'exclamation-triangle';
            } else if (item.cantidad <= item.cantidad_minima * 1.5) {
                estadoClass = 'warning';
                estadoTexto = 'Stock Medio';
                estadoIcon = 'exclamation-circle';
            }
            
            const fechaActualizacion = 'Invalid Date';
            
            fila.innerHTML = `
                <td>${materialNames[materialTipo] || materialTipo}</td>
                <td><strong>${item.cantidad}</strong></td>
                <td>${item.cantidad_minima}</td>
                <td>
                    <span class="badge bg-${estadoClass}">
                        <i class="fas fa-${estadoIcon} me-1"></i>
                        ${estadoTexto}
                    </span>
                </td>
                <td>${fechaActualizacion}</td>
            `;
            
            tbody.appendChild(fila);
        });
    }
    
    // Funci√≥n para cargar resumen de inventario
    function cargarResumenInventario() {
        fetch('/logistica/stock_ferretero', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success' && data.resumen_inventario) {
                mostrarResumenInventario(data.resumen_inventario);
                if (data.asignado_mes_actual) {
                    mostrarAsignadoMesActual(data.asignado_mes_actual);
                }
            } else {
                document.getElementById('tablaResumenInventario').innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                Error al cargar el resumen de inventario.
                            </div>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error al cargar resumen de inventario:', error);
            document.getElementById('tablaResumenInventario').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error al cargar el resumen de inventario. Por favor, intente nuevamente.
                        </div>
                    </td>
                </tr>
            `;
        });
    }

    // Funci√≥n para mostrar material asignado en el mes actual
    function mostrarAsignadoMesActual(asignado) {
        const container = document.getElementById('asignadoMesActual');
        
        if (!asignado) {
            container.innerHTML = `
                <div class="alert alert-warning text-center">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay asignaciones este mes.
                </div>
            `;
            return;
        }
        
        const materialNames = {
            'total_silicona': 'Silicona',
            'total_amarres_negros': 'Amarres Negros',
            'total_amarres_blancos': 'Amarres Blancos',
            'total_cinta_aislante': 'Cinta Aislante',
            'total_grapas_blancas': 'Grapas Blancas',
            'total_grapas_negras': 'Grapas Negras'
        };
        
        let html = '<div class="row">';
        
        Object.keys(materialNames).forEach(key => {
            const cantidad = asignado[key] || 0;
            html += `
                <div class="col-12 mb-2">
                    <div class="d-flex justify-content-between">
                        <span>${materialNames[key]}:</span>
                        <strong>${cantidad}</strong>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    // Funci√≥n para registrar entrada de material
    function registrarEntradaFerretero() {
        const formData = {
            material_tipo: document.getElementById('materialTipo').value,
            cantidad: document.getElementById('cantidadEntrada').value,
            precio_unitario: document.getElementById('precioUnitario').value,
            proveedor: document.getElementById('proveedor').value,
            numero_factura: document.getElementById('numeroFactura').value,
            observaciones: document.getElementById('observacionesEntrada').value
        };
        
        // Validar campos requeridos
        if (!formData.material_tipo || !formData.cantidad || !formData.precio_unitario) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor complete todos los campos requeridos.'
            });
            return;
        }
        
        fetch('/logistica/entradas_ferretero', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                // Cerrar modal inmediatamente
                const modalElement = document.getElementById('modalRegistrarEntrada');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                
                // Limpiar formulario
                document.getElementById('formRegistrarEntrada').reset();
                
                // Eliminar cualquier backdrop residual
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(backdrop => backdrop.remove());
                    
                    // Restaurar el scroll del body
                    document.body.classList.remove('modal-open');
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }, 100);
                
                // Recargar todas las estad√≠sticas del dashboard
                recargarDashboardCompleto();
                
                // Mostrar mensaje de √©xito sin timer
                Swal.fire({
                    icon: 'success',
                    title: '√âxito',
                    text: data.message,
                    showConfirmButton: true,
                    confirmButtonText: 'OK'
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Error al registrar la entrada.'
                });
            }
        })
        .catch(error => {
            console.error('Error al registrar entrada:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al registrar la entrada. Por favor, intente nuevamente.'
            });
        });
    }
    
    // Funci√≥n para recargar todo el dashboard despu√©s de una entrada exitosa
    function recargarDashboardCompleto() {
        console.log('Recargando dashboard completo despu√©s de entrada de material');
        
        // Recargar stock del ferretero
        cargarStockFerretero();
        
        // Recargar estad√≠sticas generales
        if (typeof cargarEstadisticasGenerales === 'function') {
            cargarEstadisticasGenerales();
        }
        
        // Recargar resumen de inventario
        if (typeof cargarResumenInventario === 'function') {
            cargarResumenInventario();
        }
        
        // Recargar asignado del mes actual
        if (typeof mostrarAsignadoMesActual === 'function') {
            mostrarAsignadoMesActual();
        }
        
        // Recargar movimientos si est√°n visibles
        const tablaMovimientos = document.getElementById('tablaMovimientosBody');
        if (tablaMovimientos && tablaMovimientos.children.length > 0) {
            cargarMovimientosFerretero();
        }
        
        console.log('Dashboard recargado completamente');
    }
    
    // Funci√≥n para cargar movimientos de stock
    function cargarMovimientosFerretero() {
        const material = document.getElementById('filtroMaterialMovimientos').value;
        const fechaInicio = document.getElementById('fechaInicioMovimientos').value;
        const fechaFin = document.getElementById('fechaFinMovimientos').value;
        
        let url = '/logistica/movimientos_ferretero?';
        const params = new URLSearchParams();
        
        if (material) params.append('material', material);
        if (fechaInicio) params.append('fecha_inicio', fechaInicio);
        if (fechaFin) params.append('fecha_fin', fechaFin);
        
        url += params.toString();
        
        fetch(url, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                llenarTablaMovimientos(data.movimientos);
            } else {
                document.getElementById('tablaMovimientosBody').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                ${data.message || 'Error al cargar los movimientos.'}
                            </div>
                        </td>
                    </tr>
                `;
            }
        })
        .catch(error => {
            console.error('Error al cargar movimientos:', error);
            document.getElementById('tablaMovimientosBody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Error al cargar los movimientos. Por favor, intente nuevamente.
                        </div>
                    </td>
                </tr>
            `;
        });
    }
    
    // Funci√≥n para llenar la tabla de movimientos
    function llenarTablaMovimientos(movimientos) {
        const tbody = document.getElementById('tablaMovimientosBody');
        tbody.innerHTML = '';
        
        if (movimientos.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        No se encontraron movimientos para los filtros seleccionados.
                    </td>
                </tr>
            `;
            return;
        }
        
        const materialNames = {
            'silicona': 'Silicona',
            'amarres_negros': 'Amarres Negros',
            'amarres_blancos': 'Amarres Blancos',
            'cinta_aislante': 'Cinta Aislante',
            'grapas_blancas': 'Grapas Blancas',
            'grapas_negras': 'Grapas Negras'
        };
        
        movimientos.forEach(movimiento => {
            const fila = document.createElement('tr');
            
            // Determinar color seg√∫n tipo de movimiento
            let tipoClass = movimiento.tipo_movimiento === 'entrada' ? 'success' : 'danger';
            let tipoIcon = movimiento.tipo_movimiento === 'entrada' ? 'arrow-up' : 'arrow-down';
            
            const fechaMovimiento = new Date(movimiento.fecha_movimiento).toLocaleString('es-CO');
            
            fila.innerHTML = `
                <td>${materialNames[movimiento.material_tipo] || movimiento.material_tipo}</td>
                <td>
                    <span class="badge bg-${tipoClass}">
                        <i class="fas fa-${tipoIcon} me-1"></i>
                        ${movimiento.tipo_movimiento.charAt(0).toUpperCase() + movimiento.tipo_movimiento.slice(1)}
                    </span>
                </td>
                <td>${movimiento.cantidad}</td>
                <td>${fechaMovimiento}</td>
                <td>${movimiento.referencia_id || '-'}</td>
                <td>${movimiento.observaciones || '-'}</td>
            `;
            
            tbody.appendChild(fila);
        });
    }
    
    // ===== FUNCIONES PARA TRANSFERENCIA DESDE SUMINISTROS =====
    
    // Funci√≥n para cargar suministros disponibles
    function cargarSuministrosDisponibles() {
        fetch('/logistica/suministros_ferretero', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                llenarSuministrosDisponibles(data.suministros);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Error al cargar suministros disponibles.'
                });
            }
        })
        .catch(error => {
            console.error('Error al cargar suministros:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al cargar suministros disponibles. Por favor, intente nuevamente.'
            });
        });
    }
    
    // Funci√≥n para llenar la tabla de suministros disponibles
    function llenarSuministrosDisponibles(suministros) {
        const tbody = document.getElementById('tablaSuministrosBody');
        tbody.innerHTML = '';
        
        if (suministros.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        No hay suministros disponibles para transferir.
                    </td>
                </tr>
            `;
            return;
        }
        
        suministros.forEach(suministro => {
             const fila = document.createElement('tr');
             
             fila.innerHTML = `
                 <td>
                     <input type="radio" name="suministroSeleccionado" value="${suministro.id_suministros}" 
                            data-nombre="${suministro.suministros_descripcion}" data-stock="${suministro.suministros_cantidad}">
                 </td>
                 <td>${suministro.suministros_descripcion}</td>
                 <td>${suministro.suministros_codigo || '-'}</td>
                 <td><strong>${suministro.suministros_cantidad}</strong></td>
                 <td>Unidad</td>
             `;
             
             tbody.appendChild(fila);
         });
        
        // Agregar evento para actualizar cantidad m√°xima
        document.querySelectorAll('input[name="suministroSeleccionado"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const stockDisponible = this.getAttribute('data-stock');
                const cantidadInput = document.getElementById('cantidadTransferir');
                cantidadInput.max = stockDisponible;
                cantidadInput.value = '';
                cantidadInput.placeholder = `M√°ximo: ${stockDisponible}`;
            });
        });
    }
    
    // Funci√≥n para procesar la transferencia
    function procesarTransferencia() {
        const suministroSeleccionado = document.querySelector('input[name="suministroSeleccionado"]:checked');
        const cantidad = document.getElementById('cantidadTransferir').value;
        const materialDestino = document.getElementById('materialDestinoFerretero').value;
        const observaciones = document.getElementById('observacionesTransferencia').value;
        
        // Validaciones
        if (!suministroSeleccionado) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor seleccione un suministro.'
            });
            return;
        }
        
        if (!cantidad || cantidad <= 0) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor ingrese una cantidad v√°lida.'
            });
            return;
        }
        
        if (!materialDestino) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Por favor seleccione el material de destino.'
            });
            return;
        }
        
        const stockDisponible = parseInt(suministroSeleccionado.getAttribute('data-stock'));
        if (parseInt(cantidad) > stockDisponible) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: `La cantidad no puede ser mayor al stock disponible (${stockDisponible}).`
            });
            return;
        }
        
        const formData = {
             id_suministro: suministroSeleccionado.value,
             cantidad: parseInt(cantidad),
             material_tipo: materialDestino,
             observaciones: observaciones
         };
        
        fetch('/logistica/transferir_suministro_ferretero', {
            method: 'POST',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '√âxito',
                    text: data.message,
                    timer: 2000,
                    showConfirmButton: false
                });
                
                // Cerrar modal y limpiar formulario
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalTransferirSuministro'));
                modal.hide();
                document.getElementById('formTransferirSuministro').reset();
                
                // Recargar stock
                cargarStockFerretero();
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.message || 'Error al procesar la transferencia.'
                });
            }
        })
        .catch(error => {
            console.error('Error al procesar transferencia:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al procesar la transferencia. Por favor, intente nuevamente.'
            });
        });
    }

    // Funci√≥n para mostrar el resumen de inventario
    function mostrarResumenInventario(resumenInventario) {
        const tbody = document.getElementById('tablaResumenInventario');
        tbody.innerHTML = '';
        
        if (!resumenInventario || resumenInventario.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            No hay datos de inventario disponibles.
                        </div>
                    </td>
                </tr>
            `;
            return;
        }
        
        const materialNames = {
            'silicona': 'Silicona',
            'amarres_negros': 'Amarres Negros',
            'amarres_blancos': 'Amarres Blancos',
            'cinta_aislante': 'Cinta Aislante',
            'grapas_blancas': 'Grapas Blancas',
            'grapas_negras': 'Grapas Negras'
        };
        
        resumenInventario.forEach(item => {
            const fila = document.createElement('tr');
            
            // Determinar clase de estado
            let estadoClass = 'success';
            let estadoTexto = item.estado_stock;
            
            if (item.estado_stock === 'Cr√≠tico') {
                estadoClass = 'danger';
            } else if (item.diferencia_real !== 0) {
                estadoClass = 'warning';
                estadoTexto = 'Diferencia';
            }
            
            // Formatear valores monetarios
            const valorEntradas = new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP'
            }).format(item.valor_entradas || 0);
            
            // Formatear fecha de √∫ltima entrada
            const ultimaEntrada = item.ultima_entrada ? 
                new Date(item.ultima_entrada).toLocaleDateString('es-CO') : 'N/A';
            
            fila.innerHTML = `
                <td>
                    <strong>${materialNames[item.material_tipo] || item.material_tipo}</strong>
                    <br><small class="text-muted">√öltima entrada: ${ultimaEntrada}</small>
                </td>
                <td>
                    <span class="badge bg-primary">${item.total_recibido}</span>
                    <br><small class="text-muted">${item.numero_entradas} entradas</small>
                </td>
                <td>
                    <span class="badge bg-secondary">${item.total_asignado}</span>
                </td>
                <td>
                    <span class="badge bg-info">${item.stock_actual}</span>
                    <br><small class="text-muted">M√≠n: ${item.stock_minimo}</small>
                </td>
                <td>
                    <span class="badge ${item.dias_alcance > 30 ? 'bg-success' : item.dias_alcance > 7 ? 'bg-warning' : 'bg-danger'}">
                        ${item.dias_alcance !== null ? Math.round(item.dias_alcance) + ' d√≠as' : 'N/A'}
                    </span>
                </td>
                <td>
                    <span class="badge ${item.diferencia_real === 0 ? 'bg-success' : 'bg-warning'}">
                        ${item.diferencia_real >= 0 ? '+' : ''}${item.diferencia_real}
                    </span>
                </td>
                <td>
                    <strong>${valorEntradas}</strong>
                </td>
                <td>
                    <span class="badge bg-${estadoClass}">
                        <i class="fas fa-${item.estado_stock === 'Cr√≠tico' ? 'exclamation-triangle' : 'check-circle'} me-1"></i>
                        ${estadoTexto}
                    </span>
                </td>
            `;
            
            tbody.appendChild(fila);
        });
    }
</script>

<!-- Modal para Registrar Entrada -->
<div class="modal fade" id="modalRegistrarEntrada" tabindex="-1" aria-labelledby="modalRegistrarEntradaLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalRegistrarEntradaLabel">
                    <i class="fas fa-plus me-2"></i>Registrar Entrada de Material
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formRegistrarEntrada">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="materialTipo" class="form-label">Material *</label>
                            <select class="form-select" id="materialTipo" required>
                                <option value="">Seleccione un material</option>
                                <option value="silicona">Silicona</option>
                                <option value="amarres_negros">Amarres Negros</option>
                                <option value="amarres_blancos">Amarres Blancos</option>
                                <option value="cinta_aislante">Cinta Aislante</option>
                                <option value="grapas_blancas">Grapas Blancas</option>
                                <option value="grapas_negras">Grapas Negras</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cantidadEntrada" class="form-label">Cantidad *</label>
                            <input type="number" class="form-control" id="cantidadEntrada" min="1" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="precioUnitario" class="form-label">Precio Unitario *</label>
                            <input type="number" class="form-control" id="precioUnitario" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="proveedor" class="form-label">Proveedor</label>
                            <input type="text" class="form-control" id="proveedor">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="numeroFactura" class="form-label">N√∫mero de Factura</label>
                            <input type="text" class="form-control" id="numeroFactura">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="observacionesEntrada" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observacionesEntrada" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btnGuardarEntrada">
                    <i class="fas fa-save me-1"></i>Guardar Entrada
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Transferir desde Suministros -->
<div class="modal fade" id="modalTransferirSuministro" tabindex="-1" aria-labelledby="modalTransferirSuministroLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTransferirSuministroLabel">
                    <i class="fas fa-exchange-alt me-2"></i>Transferir desde Suministros
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formTransferirSuministro">
                    <div class="row mb-3">
                        <div class="col-12">
                            <h6 class="text-primary">Seleccionar Suministro</h6>
                            <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th width="50">Seleccionar</th>
                                            <th>Nombre</th>
                                            <th>Descripci√≥n</th>
                                            <th>Stock</th>
                                            <th>Unidad</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tablaSuministrosBody">
                                        <tr>
                                            <td colspan="5" class="text-center">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Cargando...</span>
                                                </div>
                                                <p class="mt-2">Cargando suministros...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="cantidadTransferir" class="form-label">Cantidad a Transferir *</label>
                            <input type="number" class="form-control" id="cantidadTransferir" min="1" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="materialDestinoFerretero" class="form-label">Material Destino *</label>
                            <select class="form-select" id="materialDestinoFerretero" required>
                                <option value="">Seleccione destino</option>
                                <option value="silicona">Silicona</option>
                                <option value="amarres_negros">Amarres Negros</option>
                                <option value="amarres_blancos">Amarres Blancos</option>
                                <option value="cinta_aislante">Cinta Aislante</option>
                                <option value="grapas_blancas">Grapas Blancas</option>
                                <option value="grapas_negras">Grapas Negras</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="observacionesTransferencia" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observacionesTransferencia" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="procesarTransferencia()">
                    <i class="fas fa-exchange-alt me-1"></i>Procesar Transferencia
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Ver Movimientos -->
<div class="modal fade" id="modalMovimientos" tabindex="-1" aria-labelledby="modalMovimientosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalMovimientosLabel">
                    <i class="fas fa-history me-2"></i>Movimientos de Stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filtros para movimientos -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="filtroMaterialMovimientos" class="form-label">Material</label>
                        <select class="form-select" id="filtroMaterialMovimientos">
                            <option value="todos">Todos los materiales</option>
                            <option value="silicona">Silicona</option>
                            <option value="amarres_negros">Amarres Negros</option>
                            <option value="amarres_blancos">Amarres Blancos</option>
                            <option value="cinta_aislante">Cinta Aislante</option>
                            <option value="grapas_blancas">Grapas Blancas</option>
                            <option value="grapas_negras">Grapas Negras</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="fechaInicioMovimientos" class="form-label">Fecha Inicio</label>
                        <input type="date" class="form-control" id="fechaInicioMovimientos">
                    </div>
                    <div class="col-md-3">
                        <label for="fechaFinMovimientos" class="form-label">Fecha Fin</label>
                        <input type="date" class="form-control" id="fechaFinMovimientos">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="button" class="btn btn-primary" id="btnCargarMovimientos">
                            <i class="fas fa-search me-1"></i>Buscar
                        </button>
                    </div>
                </div>
                
                <!-- Tabla de movimientos -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th>Tipo</th>
                                <th>Cantidad</th>
                                <th>Fecha</th>
                                <th>Referencia</th>
                                <th>Observaciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaMovimientosBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="text-muted">
                                        <i class="fas fa-search me-2"></i>
                                        Haga clic en "Buscar" para cargar los movimientos.
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}