<!-- Popup de Alerta de Stock Bajo -->
{% if materiales_problematicos %}
<div id="stockAlertModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 transform transition-all">
        <!-- Header del Modal -->
        <div class="bg-red-500 text-white px-6 py-4 rounded-t-lg flex items-center justify-between">
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                </svg>
                <h3 class="text-lg font-semibold">⚠️ Alerta de Stock Bajo</h3>
            </div>
            <button id="closeStockAlert" class="text-white hover:text-gray-200 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        
        <!-- Contenido del Modal -->
        <div class="p-6">
            <p class="text-gray-700 mb-4 font-medium">Los siguientes materiales requieren atención inmediata:</p>
            
            <div class="space-y-3 max-h-60 overflow-y-auto">
                {% for material in materiales_problematicos %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border-l-4 {% if material.stock_actual == 0 %}border-red-500{% else %}border-yellow-500{% endif %}">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-800">{{ material.nombre_display }}</h4>
                        <p class="text-sm {% if material.stock_actual == 0 %}text-red-600{% else %}text-yellow-600{% endif %}">
                            {% if material.stock_actual == 0 %}
                                <span class="font-bold">AGOTADO</span> - Stock: 0 unidades
                            {% else %}
                                <span class="font-bold">STOCK BAJO</span> - Quedan: {{ material.stock_actual }} unidades
                            {% endif %}
                        </p>
                    </div>
                    <div class="ml-3">
                        {% if material.stock_actual == 0 %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Crítico
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Bajo
                            </span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <div class="flex items-start">
                    <svg class="w-5 h-5 text-blue-500 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h5 class="text-sm font-medium text-blue-800">Recomendación:</h5>
                        <p class="text-sm text-blue-700 mt-1">
                            Contacte al área de compras para reabastecer estos materiales antes de realizar nuevas asignaciones.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer del Modal -->
        <div class="bg-gray-50 px-6 py-4 rounded-b-lg flex justify-between items-center">
            <label class="flex items-center text-sm text-gray-600">
                <input type="checkbox" id="dontShowAgain" class="mr-2 rounded">
                No mostrar nuevamente en esta sesión
            </label>
            <button id="confirmStockAlert" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors font-medium">
                Entendido
            </button>
        </div>
    </div>
</div>

<script>
// Script para manejar el popup de stock bajo
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('stockAlertModal');
    const closeBtn = document.getElementById('closeStockAlert');
    const confirmBtn = document.getElementById('confirmStockAlert');
    const dontShowCheckbox = document.getElementById('dontShowAgain');
    
    // Verificar si ya se mostró en esta sesión
    const stockAlertShown = sessionStorage.getItem('stockAlertShown');
    
    // Mostrar el modal solo si hay materiales problemáticos y no se ha mostrado en esta sesión
    if (!stockAlertShown && {{ materiales_problematicos|length }} > 0) {
        modal.style.display = 'flex';
        // Agregar animación de entrada
        setTimeout(() => {
            modal.querySelector('.bg-white').classList.add('scale-100');
        }, 10);
    }
    
    // Función para cerrar el modal
    function closeModal() {
        modal.style.display = 'none';
        
        // Si el checkbox está marcado, guardar en sessionStorage
        if (dontShowCheckbox.checked) {
            sessionStorage.setItem('stockAlertShown', 'true');
        }
    }
    
    // Event listeners
    closeBtn.addEventListener('click', closeModal);
    confirmBtn.addEventListener('click', closeModal);
    
    // Cerrar al hacer click fuera del modal
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeModal();
        }
    });
    
    // Cerrar con la tecla Escape
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal.style.display === 'flex') {
            closeModal();
        }
    });
});
</script>
{% endif %}