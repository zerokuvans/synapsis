{% extends "base.html" %}

{% block title %}Sistema de Gestión de Vehículos{% endblock %}

{% block content %}
<style>
.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.is-invalid:focus {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}
</style>
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0"><i class="fas fa-car"></i> Sistema de Gestión de Vehículos</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-primary" onclick="mostrarModulo('dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="mostrarModulo('vehiculos')">
                        <i class="fas fa-car"></i> Vehículos
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="mostrarModulo('importar')">
                        <i class="fas fa-file-import"></i> Importar
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="mostrarModulo('vencimientos')">
                        <i class="fas fa-exclamation-triangle"></i> Vencimientos
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="mostrarModulo('reportes')">
                        <i class="fas fa-chart-bar"></i> Reportes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Module -->
    <div id="moduloDashboard" class="modulo-content">
        <div class="row mb-4">
            <!-- Statistics Cards -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total Vehículos</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="totalVehiculos">{{ vehiculos|length }}</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-car fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Vehículos Activos</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="vehiculosActivos">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Próximos a Vencer</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="proximosVencer">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-danger shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Documentos Vencidos</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="documentosVencidos">0</div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row">
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Distribución por Tipo de Vehículo</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="chartTipoVehiculo"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Estado de Documentos</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="chartEstadoDocumentos"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Alerts -->
        <div class="row">
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Alertas Recientes</h6>
                    </div>
                    <div class="card-body">
                        <div id="alertasRecientes">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin"></i> Cargando alertas...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Management Module -->
    <div id="moduloVehiculos" class="modulo-content" style="display: none;">
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-car"></i> Gestión de Vehículos</h4>
                    <div>
                        <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalRegistroVehiculo">
                            <i class="fas fa-plus"></i> Registrar Vehículo
                        </button>
                        <a href="{{ url_for('exportar_vehiculos_csv') }}" class="btn btn-success">
                            <i class="fas fa-file-excel"></i> Exportar CSV
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body">
                        <table id="tablaVehiculos" class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Placa</th>
                                    <th>Tipo</th>
                                    <th>Marca</th>
                                    <th>Modelo</th>
                                    <th>Color</th>
                                    <th>Técnico Asignado</th>
                                    <th>Fecha Asignación</th>
                                    <th>Estado</th>
                                    <th>Venc. SOAT</th>
                                    <th>Venc. Tecnomecánica</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vehiculo in vehiculos %}
                                <tr>
                                    <td>{{ vehiculo.placa }}</td>
                                    <td>{{ vehiculo.tipo_vehiculo }}</td>
                                    <td>{{ vehiculo.marca }}</td>
                                    <td>{{ vehiculo.modelo }}</td>
                                    <td>{{ vehiculo.color }}</td>
                                    <td>
                                        {% if vehiculo.tecnico_nombre %}
                                            {{ vehiculo.tecnico_nombre }}
                                        {% else %}
                                            <span class="text-muted">Sin asignar</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if vehiculo.fecha_asignacion %}
                                            {{ vehiculo.fecha_asignacion.strftime('%d/%m/%Y') }}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if vehiculo.estado == 'Activo' %}
                                            <span class="badge bg-success">{{ vehiculo.estado }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ vehiculo.estado }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if vehiculo.soat_vencimiento %}
                                            {% set dias_soat = (vehiculo.soat_vencimiento - fecha_actual).days %}
                                            {% if dias_soat < 0 %}
                                                <span class="badge bg-danger">{{ vehiculo.soat_vencimiento.strftime('%d/%m/%Y') }}</span>
                                            {% elif dias_soat <= 30 %}
                                                <span class="badge bg-warning">{{ vehiculo.soat_vencimiento.strftime('%d/%m/%Y') }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ vehiculo.soat_vencimiento.strftime('%d/%m/%Y') }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if vehiculo.tecnomecanica_vencimiento %}
                                            {% set dias_tecno = (vehiculo.tecnomecanica_vencimiento - fecha_actual).days %}
                                            {% if dias_tecno < 0 %}
                                                <span class="badge bg-danger">{{ vehiculo.tecnomecanica_vencimiento.strftime('%d/%m/%Y') }}</span>
                                            {% elif dias_tecno <= 30 %}
                                                <span class="badge bg-warning">{{ vehiculo.tecnomecanica_vencimiento.strftime('%d/%m/%Y') }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ vehiculo.tecnomecanica_vencimiento.strftime('%d/%m/%Y') }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-primary" onclick="editarVehiculo({{ vehiculo.id_parque_automotor }})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mass Import Module -->
    <div id="moduloImportar" class="modulo-content" style="display: none;">
        <div class="row mb-3">
            <div class="col-12">
                <h4><i class="fas fa-file-import"></i> Importación Masiva de Vehículos</h4>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Cargar Archivo Excel</h6>
                    </div>
                    <div class="card-body">
                        <form id="formImportarVehiculos" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="archivoExcel" class="form-label">Seleccionar archivo Excel (.xlsx)</label>
                                <input type="file" class="form-control" id="archivoExcel" name="archivo" accept=".xlsx,.xls" required>
                                <div class="form-text">El archivo debe contener las columnas: placa, tipo_vehiculo, marca, modelo, color, soat_vencimiento, tecnomecanica_vencimiento</div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="actualizarExistentes" name="actualizar_existentes">
                                    <label class="form-check-label" for="actualizarExistentes">
                                        Actualizar vehículos existentes (basado en placa)
                                    </label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" onclick="importarVehiculos()">
                                <i class="fas fa-upload"></i> Importar Vehículos
                            </button>
                        </form>
                        
                        <div id="resultadoImportacion" class="mt-4" style="display: none;">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> Resultado de la Importación</h6>
                                <div id="detalleImportacion"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Plantilla de Importación</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Descarga la plantilla Excel para importar vehículos correctamente.</p>
                        <a href="/api/vehiculos/plantilla" class="btn btn-success btn-block">
                            <i class="fas fa-download"></i> Descargar Plantilla
                        </a>
                        
                        <hr>
                        
                        <h6 class="text-primary">Instrucciones:</h6>
                        <ul class="text-sm text-muted">
                            <li>Completa todas las columnas obligatorias</li>
                            <li>Las fechas deben estar en formato DD/MM/YYYY</li>
                            <li>Los tipos de vehículo válidos son: Moto, Carro, Camioneta, Camión</li>
                            <li>Las placas deben ser únicas</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expiration Management Module -->
    <div id="moduloVencimientos" class="modulo-content" style="display: none;">
        <div class="row mb-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-exclamation-triangle"></i> Gestión de Vencimientos</h4>
                    <button type="button" class="btn btn-primary" onclick="cargarVencimientos()">
                        <i class="fas fa-sync"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>

        <!-- Filter Row -->
        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-select" id="filtroTipoDocumento" onchange="filtrarVencimientos()">
                    <option value="">Todos los documentos</option>
                    <option value="SOAT">SOAT</option>
                    <option value="Tecnomecánica">Tecnomecánica</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="filtroEstado" onchange="filtrarVencimientos()">
                    <option value="">Todos los estados</option>
                    <option value="vencido">Vencidos</option>
                    <option value="por_vencer">Por vencer (30 días)</option>
                    <option value="vigente">Vigentes</option>
                </select>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="buscarVencimiento" placeholder="Buscar por placa..." onkeyup="filtrarVencimientos()">
                    <button class="btn btn-outline-secondary" type="button" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-body">
                        <table id="tablaVencimientos" class="table table-striped table-hover" data-manual-init="true">
                            <thead class="table-dark">
                                <tr>
                                    <th>Placa</th>
                                    <th>Tipo Vehículo</th>
                                    <th>Documento</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Días Restantes</th>
                                    <th>Estado</th>
                                    <th>Última Renovación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoTablaVencimientos">
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-spinner fa-spin"></i> Cargando vencimientos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Module -->
    <div id="moduloReportes" class="modulo-content" style="display: none;">
        <div class="row mb-3">
            <div class="col-12">
                <h4><i class="fas fa-chart-bar"></i> Reportes y Estadísticas</h4>
            </div>
        </div>

        <!-- Report Filters -->
        <div class="row mb-4">
            <div class="col-md-3">
                <label for="fechaInicio" class="form-label">Fecha Inicio</label>
                <input type="date" class="form-control" id="fechaInicio">
            </div>
            <div class="col-md-3">
                <label for="fechaFin" class="form-label">Fecha Fin</label>
                <input type="date" class="form-control" id="fechaFin">
            </div>
            <div class="col-md-3">
                <label for="tipoReporte" class="form-label">Tipo de Reporte</label>
                <select class="form-select" id="tipoReporte">
                    <option value="general">Reporte General</option>
                    <option value="vencimientos">Vencimientos</option>
                    <option value="mantenimientos">Mantenimientos</option>
                    <option value="asignaciones">Asignaciones</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div>
                    <button type="button" class="btn btn-primary" onclick="generarReporte()">
                        <i class="fas fa-chart-line"></i> Generar
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportarReporte()">
                        <i class="fas fa-file-excel"></i> Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Report Results -->
        <div class="row">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Gráfico de Resultados</h6>
                    </div>
                    <div class="card-body">
                        <canvas id="chartReporte" style="height: 400px;"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow">
                    <div class="card-header">
                        <h6 class="m-0 font-weight-bold text-primary">Resumen Estadístico</h6>
                    </div>
                    <div class="card-body">
                        <div id="resumenEstadistico">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-chart-pie fa-3x mb-3"></i>
                                <p>Selecciona un tipo de reporte y genera los datos para ver las estadísticas.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Modal de Registro de Vehículo -->
<div class="modal fade" id="modalRegistroVehiculo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Registrar Nuevo Vehículo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formVehiculo">
                    <input type="hidden" id="id_parque_automotor" name="id_parque_automotor">
                    
                    <!-- Información Básica del Vehículo -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Información Básica del Vehículo</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="placa_vehiculo" class="form-label">Placa *</label>
                                    <input type="text" class="form-control" id="placa_vehiculo" name="placa_vehiculo" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="tipo_vehiculo" class="form-label">Tipo de Vehículo *</label>
                                    <select class="form-select" id="tipo_vehiculo" name="tipo_vehiculo" required>
                                        <option value="">Seleccione...</option>
                                        <option value="Moto">Moto</option>
                                        <option value="Carro">Carro</option>
                                        <option value="Camioneta">Camioneta</option>
                                        <option value="Camión">Camión</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="vehiculo_asistio_operacion" class="form-label">¿Vehículo asistió a operación?</label>
                                    <select class="form-select" id="vehiculo_asistio_operacion" name="vehiculo_asistio_operacion">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="marca_vehiculo" class="form-label">Marca *</label>
                                    <input type="text" class="form-control" id="marca_vehiculo" name="marca_vehiculo" required>
                                </div>
                                <div class="col-md-4">
                                    <label for="modelo_vehiculo" class="form-label">Modelo *</label>
                                    <input type="text" class="form-control" id="modelo_vehiculo" name="modelo_vehiculo" required maxlength="4">
                                </div>
                                <div class="col-md-4">
                                    <label for="color" class="form-label">Color *</label>
                                    <input type="text" class="form-control" id="color" name="color" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información del Conductor -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Información del Conductor</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="id_codigo_consumidor" class="form-label">Técnico Asignado</label>
                                    <select class="form-select" id="id_codigo_consumidor" name="id_codigo_consumidor">
                                        <option value="">Seleccione...</option>
                                        {% for tecnico in tecnicos %}
                                        <option value="{{ tecnico.id_codigo_consumidor }}">{{ tecnico.nombre }} - {{ tecnico.recurso_operativo_cedula }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="fecha_asignacion" class="form-label">Fecha de Asignación *</label>
                                    <input type="date" class="form-control" id="fecha_asignacion" name="fecha_asignacion" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="licencia_conduccion" class="form-label">Licencia de Conducción</label>
                                    <input type="text" class="form-control" id="licencia_conduccion" name="licencia_conduccion">
                                </div>
                                <div class="col-md-6">
                                    <label for="fecha_vencimiento_licencia" class="form-label">Vencimiento Licencia</label>
                                    <input type="date" class="form-control" id="fecha_vencimiento_licencia" name="fecha_vencimiento_licencia">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Documentación del Vehículo -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Documentación del Vehículo</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="estado" class="form-label">Estado</label>
                                    <select class="form-select" id="estado" name="estado">
                                        <option value="Activo">Activo</option>
                                        <option value="Inactivo">Inactivo</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="fecha_vencimiento_soat" class="form-label">Vencimiento SOAT</label>
                                    <input type="date" class="form-control" id="fecha_vencimiento_soat" name="fecha_vencimiento_soat">
                                </div>
                                <div class="col-md-4">
                                    <label for="fecha_vencimiento_tecnomecanica" class="form-label">Vencimiento Tecnomecánica</label>
                                    <input type="date" class="form-control" id="fecha_vencimiento_tecnomecanica" name="fecha_vencimiento_tecnomecanica">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inspección Física del Vehículo -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Inspección Física del Vehículo</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="estado_carroceria" class="form-label">Estado Carrocería</label>
                                    <select class="form-select" id="estado_carroceria" name="estado_carroceria">
                                        <option value="">Seleccione...</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_llantas" class="form-label">Estado Llantas</label>
                                    <select class="form-select" id="estado_llantas" name="estado_llantas">
                                        <option value="">Seleccione...</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_frenos" class="form-label">Estado Frenos</label>
                                    <select class="form-select" id="estado_frenos" name="estado_frenos">
                                        <option value="">Seleccione...</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_motor" class="form-label">Estado Motor</label>
                                    <select class="form-select" id="estado_motor" name="estado_motor">
                                        <option value="">Seleccione...</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="estado_luces" class="form-label">Estado Luces</label>
                                    <select class="form-select" id="estado_luces" name="estado_luces">
                                        <option value="">Seleccione...</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_espejos" class="form-label">Estado Espejos</label>
                                    <select class="form-select" id="estado_espejos" name="estado_espejos">
                                        <option value="">Seleccione...</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_vidrios" class="form-label">Estado Vidrios</label>
                                    <select class="form-select" id="estado_vidrios" name="estado_vidrios">
                                        <option value="">Seleccione...</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="estado_asientos" class="form-label">Estado Asientos</label>
                                    <select class="form-select" id="estado_asientos" name="estado_asientos">
                                        <option value="">Seleccione...</option>
                                        <option value="Bueno">Bueno</option>
                                        <option value="Regular">Regular</option>
                                        <option value="Malo">Malo</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Elementos de Seguridad -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Elementos de Seguridad</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="cinturon_seguridad" class="form-label">Cinturón de Seguridad</label>
                                    <select class="form-select" id="cinturon_seguridad" name="cinturon_seguridad">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="extintor" class="form-label">Extintor</label>
                                    <select class="form-select" id="extintor" name="extintor">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="botiquin" class="form-label">Botiquín</label>
                                    <select class="form-select" id="botiquin" name="botiquin">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="triangulos_seguridad" class="form-label">Triángulos de Seguridad</label>
                                    <select class="form-select" id="triangulos_seguridad" name="triangulos_seguridad">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="llanta_repuesto" class="form-label">Llanta de Repuesto</label>
                                    <select class="form-select" id="llanta_repuesto" name="llanta_repuesto">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="herramientas" class="form-label">Herramientas</label>
                                    <select class="form-select" id="herramientas" name="herramientas">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="gato" class="form-label">Gato</label>
                                    <select class="form-select" id="gato" name="gato">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="cruceta" class="form-label">Cruceta</label>
                                    <select class="form-select" id="cruceta" name="cruceta">
                                        <option value="">Seleccione...</option>
                                        <option value="Sí">Sí</option>
                                        <option value="No">No</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Información Operativa -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="m-0 font-weight-bold text-primary">Información Operativa</h6>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="centro_de_trabajo" class="form-label">Centro de Trabajo</label>
                                    <input type="text" class="form-control" id="centro_de_trabajo" name="centro_de_trabajo">
                                </div>
                                <div class="col-md-4">
                                    <label for="ciudad" class="form-label">Ciudad</label>
                                    <input type="text" class="form-control" id="ciudad" name="ciudad">
                                </div>
                                <div class="col-md-4">
                                    <label for="supervisor" class="form-label">Supervisor</label>
                                    <select class="form-select" id="supervisor" name="supervisor">
                                        <option value="">Seleccione un supervisor</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="fecha" class="form-label">Fecha de Registro</label>
                                    <input type="datetime-local" class="form-control" id="fecha" name="fecha">
                                </div>
                                <div class="col-md-6">
                                    <label for="kilometraje" class="form-label">Kilometraje</label>
                                    <input type="number" class="form-control" id="kilometraje" name="kilometraje">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="observaciones" class="form-label">Observaciones</label>
                                <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarVehiculo()">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
const vehiculos = JSON.parse('{{ vehiculos|tojson|safe }}');
let modo = 'crear';
let tablaVehiculos, tablaVencimientos;
let chartReporte;

$(document).ready(function() {
    // Initialize DataTables
    initializeDataTables();
    
    // Load dashboard data
    cargarDashboard();
    
    // Load supervisors list
    cargarSupervisores();
    
    // Set default dates for reports
    const today = new Date();
    const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
    if (document.getElementById('fechaInicio')) {
        document.getElementById('fechaInicio').value = firstDay.toISOString().split('T')[0];
    }
    if (document.getElementById('fechaFin')) {
        document.getElementById('fechaFin').value = today.toISOString().split('T')[0];
    }
    
    // Establecer fecha actual por defecto
    document.getElementById('fecha_asignacion').value = new Date().toISOString().split('T')[0];
});

// Debug function to test navigation
function debugNavigation() {
    console.log('Testing navigation...');
    console.log('jQuery loaded:', typeof $ !== 'undefined');
    console.log('Modules found:', $('.modulo-content').length);
    console.log('Nav buttons found:', $('.btn-group button').length);
    
    // Test showing vehiculos module
    $('.modulo-content').hide();
    $('#moduloVehiculos').show();
    console.log('Vehiculos module visible:', $('#moduloVehiculos').is(':visible'));
}

// Module Navigation
function mostrarModulo(modulo) {
    console.log('mostrarModulo called with:', modulo);
    
    // Hide all modules
    $('.modulo-content').hide();
    console.log('All modules hidden');
    
    // Remove active class from all nav buttons
    $('.btn-group button').removeClass('btn-primary').addClass('btn-outline-primary');
    console.log('Button classes updated');
    
    // Show selected module
    const moduleId = '#modulo' + modulo.charAt(0).toUpperCase() + modulo.slice(1);
    console.log('Showing module:', moduleId);
    $(moduleId).show();
    
    // Add active class to clicked button - Fixed selector
    const buttonSelector = `button[onclick*="mostrarModulo('${modulo}')"]`;
    console.log('Button selector:', buttonSelector);
    $(buttonSelector).removeClass('btn-outline-primary').addClass('btn-primary');
    
    // Load module-specific data
    switch(modulo) {
        case 'dashboard':
            cargarDashboard();
            break;
        case 'vehiculos':
            cargarVehiculos();
            break;
        case 'vencimientos':
            cargarVencimientos();
            break;
        case 'reportes':
            // Reports are loaded on demand
            break;
    }
    
    console.log('Module switch completed for:', modulo);
}

// Initialize DataTables
function initializeDataTables() {
    console.log('Initializing DataTables...');
    
    try {
        if ($.fn.DataTable.isDataTable('#tablaVehiculos')) {
            $('#tablaVehiculos').DataTable().destroy();
        }
        
        // Check if table exists before initializing
        if ($('#tablaVehiculos').length > 0) {
            tablaVehiculos = $('#tablaVehiculos').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json'
                },
                responsive: true,
                pageLength: 10,
                order: [[0, "asc"]],
                columnDefs: [
                    { targets: [10], orderable: false } // Disable ordering for Actions column
                ]
            });
            console.log('tablaVehiculos initialized successfully');
        }
    } catch (error) {
        console.error('Error initializing tablaVehiculos:', error);
    }
    
    // Initialize tablaVencimientos to prevent DataTables warning
    try {
        // Destroy any existing DataTable instance
        if ($.fn.DataTable.isDataTable('#tablaVencimientos')) {
            $('#tablaVencimientos').DataTable().clear().destroy();
            console.log('Destroyed existing tablaVencimientos DataTable');
        }
        
        // Reset table variable
        tablaVencimientos = null;
        
        // Wait for DOM cleanup
        setTimeout(() => {
            // Check if table exists and has the correct structure before initializing
            const table = $('#tablaVencimientos');
            if (table.length > 0) {
                // Verify table has correct number of columns
                const headerCols = table.find('thead tr th').length;
                const bodyRows = table.find('tbody tr').length;
                console.log('Table header columns count:', headerCols, 'Body rows:', bodyRows);
                
                // Clear any existing tbody content to prevent structure conflicts
                table.find('tbody').empty();
                
                if (headerCols === 8) {
                    try {
                        tablaVencimientos = table.DataTable({
                            language: {
                                url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/es-ES.json',
                                emptyTable: '<i class="fas fa-info-circle"></i> No hay vencimientos registrados',
                                zeroRecords: '<i class="fas fa-search"></i> No se encontraron registros que coincidan con los filtros'
                            },
                            responsive: true,
                            pageLength: 10,
                            order: [[3, "asc"]], // Order by fecha vencimiento
                            columnDefs: [
                                { targets: [7], orderable: false } // Disable ordering for Actions column
                            ],
                            searching: false, // Disable search since we have custom filters
                            paging: false, // Disable paging to show all records
                            autoWidth: false,
                            destroy: true,
                            retrieve: false,
                            data: [], // Start with empty data
                            columns: [
                                { title: "Placa", data: null, defaultContent: '' },
                                { title: "Tipo Vehículo", data: null, defaultContent: '' },
                                { title: "Documento", data: null, defaultContent: '' },
                                { title: "Fecha Vencimiento", data: null, defaultContent: '' },
                                { title: "Días Restantes", data: null, defaultContent: '' },
                                { title: "Estado", data: null, defaultContent: '' },
                                { title: "Última Renovación", data: null, defaultContent: '' },
                                { title: "Acciones", data: null, defaultContent: '', orderable: false }
                            ],
                            createdRow: function(row, data, dataIndex) {
                                // Ensure proper cell structure
                                $(row).find('td').each(function(index) {
                                    if (!$(this).attr('data-dt-column')) {
                                        $(this).attr('data-dt-column', index);
                                    }
                                });
                            }
                        });
                        console.log('tablaVencimientos initialized successfully with', headerCols, 'columns');
                    } catch (dtError) {
                        console.error('DataTable initialization error:', dtError);
                        // Fallback: clear table content and show error message
                        table.find('tbody').html('<tr><td colspan="8" class="text-center text-muted py-4">Error al inicializar la tabla</td></tr>');
                    }
                } else {
                    console.error('Table structure mismatch. Expected 8 columns, found:', headerCols);
                    table.find('tbody').html('<tr><td colspan="8" class="text-center text-danger py-4">Error de estructura de tabla</td></tr>');
                }
            } else {
                console.warn('Table #tablaVencimientos not found in DOM');
            }
        }, 100);
    } catch (error) {
        console.error('Error initializing tablaVencimientos:', error);
    }
    
    console.log('DataTables initialization completed');
}

// Navigation is working correctly - debug code removed

// Dashboard Functions
function cargarDashboard() {
    console.log('cargarDashboard() called');
    fetch('/api/vehiculos/dashboard')
        .then(response => {
            console.log('Dashboard API response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Dashboard data received:', data);
            document.getElementById('totalVehiculos').textContent = data.total_vehiculos || vehiculos.length;
            document.getElementById('vehiculosActivos').textContent = data.vehiculos_activos || 0;
            document.getElementById('proximosVencer').textContent = data.vencimientos_proximos || 0;
            document.getElementById('documentosVencidos').textContent = data.documentos_vencidos || 0;
            
            // Update recent alerts
            actualizarAlertasRecientes(data.alertas_recientes || []);
            
            // Cargar gráficos del dashboard
            cargarDatosGraficos();
            
            console.log('Dashboard updated successfully');
        })
        .catch(error => {
            console.error('Error loading dashboard data:', error);
            // Use fallback data
            document.getElementById('totalVehiculos').textContent = vehiculos.length;
            // Cargar gráficos con datos por defecto
            cargarDatosGraficos();
        });
}

function actualizarAlertasRecientes(alertas) {
    const container = document.getElementById('alertasRecientes');
    container.innerHTML = '';
    
    if (alertas.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3"><i class="fas fa-check-circle"></i><br>No hay alertas recientes</div>';
        return;
    }
    
    alertas.forEach(function(alerta) {
        const badgeClass = alerta.tipo_alerta === 'vencido' ? 'bg-danger' : 'bg-warning';
        const alertaHtml = `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <strong>${alerta.placa}</strong><br>
                    <small class="text-muted">${alerta.tipo_documento}</small>
                </div>
                <span class="badge ${badgeClass}">${alerta.tipo_alerta}</span>
            </div>
        `;
        container.innerHTML += alertaHtml;
    });
}

// Vehicle Management Functions
function cargarVehiculos() {
    // Since we're using server-side rendered data, we'll reload the page
    // or implement a proper AJAX data source if needed
    if (tablaVehiculos) {
        tablaVehiculos.draw();
    }
}

// Load supervisors for dropdown
function cargarSupervisores() {
    return fetch('/api/logistica/supervisores')
        .then(response => response.json())
        .then(data => {
            const supervisorSelect = document.getElementById('supervisor');
            if (supervisorSelect && data.status === 'success') {
                // Clear existing options except the first one
                supervisorSelect.innerHTML = '<option value="">Seleccione un supervisor</option>';
                
                // Add supervisors to dropdown
                data.supervisores.forEach(supervisor => {
                    const option = document.createElement('option');
                    option.value = supervisor.id_codigo_consumidor;
                    option.textContent = `${supervisor.nombre} - ${supervisor.cargo}`;
                    supervisorSelect.appendChild(option);
                });
            }
            return data;
        })
        .catch(error => {
            console.error('Error loading supervisors:', error);
            throw error;
        });
}

function editarVehiculo(id) {
    modo = 'editar';
    const vehiculo = vehiculos.find(v => v.id_parque_automotor === id);
    if (vehiculo) {
        // Función auxiliar para asignar valores de forma segura
        const setElementValue = (elementId, value) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.value = value;
            } else {
                console.warn(`Element with ID '${elementId}' not found`);
            }
        };
        
        const setElementChecked = (elementId, checked) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.checked = checked;
            } else {
                console.warn(`Element with ID '${elementId}' not found`);
            }
        };
        
        // Función para cargar todos los datos después de cargar supervisores
        const cargarDatosVehiculo = () => {
            // Información Básica del Vehículo
            setElementValue('id_parque_automotor', vehiculo.id_parque_automotor);
            setElementValue('placa', vehiculo.placa || '');
            setElementValue('tipo_vehiculo', vehiculo.tipo_vehiculo || '');
            setElementValue('marca', vehiculo.marca || '');
            setElementValue('modelo', vehiculo.modelo || '');
            setElementValue('color', vehiculo.color || '');
            setElementValue('id_codigo_consumidor', vehiculo.id_codigo_consumidor || '');
            setElementValue('fecha_asignacion', vehiculo.fecha_asignacion && vehiculo.fecha_asignacion !== 'None' ? new Date(vehiculo.fecha_asignacion).toISOString().split('T')[0] : '');
            setElementValue('estado', vehiculo.estado || 'Activo');
            setElementValue('supervisor', vehiculo.supervisor || '');
            setElementValue('observaciones', vehiculo.observaciones || '');
        
            // Información del Conductor
            setElementValue('nombre_conductor', vehiculo.nombre_conductor || '');
            setElementValue('cedula_conductor', vehiculo.cedula_conductor || '');
            setElementValue('telefono_conductor', vehiculo.telefono_conductor || '');
            setElementValue('licencia_conduccion', vehiculo.licencia_conduccion || '');
            setElementValue('vencimiento_licencia', vehiculo.vencimiento_licencia && vehiculo.vencimiento_licencia !== 'None' ? new Date(vehiculo.vencimiento_licencia).toISOString().split('T')[0] : '');
            
            // Documentación del Vehículo
            setElementValue('soat_vencimiento', vehiculo.soat_vencimiento && vehiculo.soat_vencimiento !== 'None' ? new Date(vehiculo.soat_vencimiento).toISOString().split('T')[0] : '');
            setElementValue('tecnomecanica_vencimiento', vehiculo.tecnomecanica_vencimiento && vehiculo.tecnomecanica_vencimiento !== 'None' ? new Date(vehiculo.tecnomecanica_vencimiento).toISOString().split('T')[0] : '');
            setElementValue('tarjeta_propiedad', vehiculo.tarjeta_propiedad || '');
            setElementValue('poliza_seguro', vehiculo.poliza_seguro || '');
            setElementValue('vencimiento_poliza', vehiculo.vencimiento_poliza && vehiculo.vencimiento_poliza !== 'None' ? new Date(vehiculo.vencimiento_poliza).toISOString().split('T')[0] : '');
            
            // Información Operativa
            setElementValue('fecha', vehiculo.fecha && vehiculo.fecha !== 'None' ? new Date(vehiculo.fecha).toISOString().split('T')[0] : '');
            setElementValue('kilometraje', vehiculo.kilometraje || '');
            
            // Inspección Física del Vehículo
            setElementValue('estado_carroceria', vehiculo.estado_carroceria || 'Bueno');
            setElementValue('estado_llantas', vehiculo.estado_llantas || 'Bueno');
            setElementValue('estado_frenos', vehiculo.estado_frenos || 'Bueno');
            setElementValue('estado_motor', vehiculo.estado_motor || 'Bueno');
            setElementValue('estado_luces', vehiculo.estado_luces || 'Bueno');
            setElementValue('estado_espejos', vehiculo.estado_espejos || 'Bueno');
            setElementValue('estado_vidrios', vehiculo.estado_vidrios || 'Bueno');
            setElementValue('estado_asientos', vehiculo.estado_asientos || 'Bueno');
            
            // Elementos de Seguridad
            setElementChecked('cinturon_seguridad', vehiculo.cinturon_seguridad === 'Sí' || vehiculo.cinturon_seguridad === true);
            setElementChecked('extintor', vehiculo.extintor === 'Sí' || vehiculo.extintor === true);
            setElementChecked('botiquin', vehiculo.botiquin === 'Sí' || vehiculo.botiquin === true);
            setElementChecked('triangulos_seguridad', vehiculo.triangulos_seguridad === 'Sí' || vehiculo.triangulos_seguridad === true);
            setElementChecked('llanta_repuesto', vehiculo.llanta_repuesto === 'Sí' || vehiculo.llanta_repuesto === true);
            setElementChecked('herramientas', vehiculo.herramientas === 'Sí' || vehiculo.herramientas === true);
            setElementChecked('gato', vehiculo.gato === 'Sí' || vehiculo.gato === true);
            setElementChecked('cruceta', vehiculo.cruceta === 'Sí' || vehiculo.cruceta === true);
            
            const modalTitle = document.getElementById('modalTitle');
            if (modalTitle) {
                modalTitle.textContent = 'Editar Vehículo';
            }
            $('#modalRegistroVehiculo').modal('show');
        };
        
        // Primero cargar supervisores, luego asignar datos
        cargarSupervisores().then(() => {
            cargarDatosVehiculo();
        }).catch(error => {
            console.error('Error cargando supervisores:', error);
            // Si falla la carga de supervisores, aún así cargar los datos
            cargarDatosVehiculo();
        });
    }
}

function guardarVehiculo() {
    // Validar campos requeridos antes del envío
    const camposRequeridos = [
        { id: 'placa', nombre: 'Placa' },
        { id: 'tipo_vehiculo', nombre: 'Tipo de Vehículo' },
        { id: 'marca', nombre: 'Marca' },
        { id: 'modelo', nombre: 'Modelo' },
        { id: 'color', nombre: 'Color' },
        { id: 'fecha_asignacion', nombre: 'Fecha de Asignación' }
    ];
    
    const camposVacios = [];
    
    camposRequeridos.forEach(campo => {
        const elemento = document.getElementById(campo.id);
        if (!elemento || !elemento.value.trim()) {
            camposVacios.push(campo.nombre);
            // Agregar clase de error visual
            if (elemento) {
                elemento.classList.add('is-invalid');
            }
        } else {
            // Remover clase de error si el campo está lleno
            if (elemento) {
                elemento.classList.remove('is-invalid');
            }
        }
    });
    
    if (camposVacios.length > 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Campos requeridos',
            text: `Los siguientes campos son obligatorios: ${camposVacios.join(', ')}`,
            confirmButtonText: 'Entendido'
        });
        return;
    }
    
    const formData = new FormData(document.getElementById('formVehiculo'));
    const id = document.getElementById('id_parque_automotor').value;
    
    const url = modo === 'crear' 
        ? '/logistica/registrar_vehiculo'
        : `/logistica/actualizar_vehiculo/${id}`;
    
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: data.message,
                showConfirmButton: false,
                timer: 1500
            }).then(() => {
                window.location.reload();
            });
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Ha ocurrido un error al procesar la solicitud'
        });
    });
}

// Mass Import Functions
function importarVehiculos() {
    const archivo = document.getElementById('archivoExcel').files[0];
    
    if (!archivo) {
        Swal.fire({
            icon: 'warning',
            title: 'Advertencia',
            text: 'Por favor selecciona un archivo Excel'
        });
        return;
    }
    
    // Show loading state
    const btn = document.querySelector('[onclick="importarVehiculos()"]');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importando...';
    btn.disabled = true;
    
    const formData = new FormData();
    formData.append('archivo', archivo);
    
    fetch('/api/vehiculos/importar', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(response => {
        if (response.success) {
            const vehiculosInsertados = response.data.vehiculos_insertados || 0;
            const vehiculosError = response.data.vehiculos_error || [];
            const totalProcesados = vehiculosInsertados + vehiculosError.length;
            
            let detallesErrores = '';
            if (vehiculosError.length > 0) {
                detallesErrores = '<p><strong>Detalles de errores:</strong><br>';
                vehiculosError.forEach(error => {
                    detallesErrores += `Fila ${error.fila} - Placa ${error.placa}: ${error.error}<br>`;
                });
                detallesErrores += '</p>';
            }
            
            document.getElementById('detalleImportacion').innerHTML = `
                <p><strong>Importación completada:</strong></p>
                <ul>
                    <li>Vehículos procesados: ${totalProcesados}</li>
                    <li>Vehículos insertados: ${vehiculosInsertados}</li>
                    <li>Errores: ${vehiculosError.length}</li>
                </ul>
                ${detallesErrores}
            `;
            document.getElementById('resultadoImportacion').style.display = 'block';
            
            // Show success message
            Swal.fire({
                icon: 'success',
                title: 'Éxito',
                text: response.message
            });
            
            // Refresh data
            cargarVehiculos();
            cargarDashboard();
        } else {
            // Handle API error response
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: response.message || 'Error en la importación'
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error de conexión durante la importación'
        });
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Expiration Management Functions
function cargarVencimientos() {
    fetch('/api/vehiculos/vencimientos')
        .then(response => response.json())
        .then(response => {
            if (response.success) {
                actualizarTablaVencimientos(response.data || []);
            } else {
                console.error('Error en la respuesta:', response.message);
                actualizarTablaVencimientos([]);
            }
        })
        .catch(error => {
            console.error('Error loading expiration data:', error);
            actualizarTablaVencimientos([]);
        });
}

function actualizarTablaVencimientos(vencimientos) {
    // Check if DataTable is initialized
    if ($.fn.DataTable.isDataTable('#tablaVencimientos') && tablaVencimientos) {
        // Clear existing data
        tablaVencimientos.clear();
        
        if (vencimientos.length === 0) {
            // Don't add any rows when empty - just clear and draw
            tablaVencimientos.draw();
            return;
        }
        
        // Add new data
        const dataArray = [];
        vencimientos.forEach(function(item) {
            const estadoBadge = getEstadoBadge(item.estado_documento, item.dias_restantes);
            const renovarBtn = `<button class="btn btn-sm btn-primary" onclick="renovarDocumento(${item.id_historial}, '${item.tipo_documento}')"><i class="fas fa-sync"></i> Renovar</button>`;
            
            dataArray.push([
                item.placa || '',
                item.tipo_vehiculo || '',
                item.tipo_documento || '',
                formatDate(item.fecha_vencimiento_nueva) || '',
                item.dias_restantes || '',
                estadoBadge || '',
                item.fecha_renovacion ? formatDate(item.fecha_renovacion) : 'N/A',
                renovarBtn || ''
            ]);
        });
        
        // Add all rows at once for better performance
        if (dataArray.length > 0) {
            tablaVencimientos.rows.add(dataArray);
        }
        
        // Redraw the table
        tablaVencimientos.draw();
    } else {
        // Fallback to original method if DataTable is not initialized
        const tbody = document.getElementById('cuerpoTablaVencimientos');
        if (!tbody) {
            console.error('Table tbody element not found');
            return;
        }
        
        tbody.innerHTML = '';
        
        if (vencimientos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4"><i class="fas fa-info-circle"></i> No hay vencimientos registrados</td></tr>';
            return;
        }
        
        vencimientos.forEach(function(item) {
            const estadoBadge = getEstadoBadge(item.estado_documento, item.dias_restantes);
            const row = `
                <tr>
                    <td>${item.placa}</td>
                    <td>${item.tipo_vehiculo}</td>
                    <td>${item.tipo_documento}</td>
                    <td>${formatDate(item.fecha_vencimiento_nueva)}</td>
                    <td>${item.dias_restantes}</td>
                    <td>${estadoBadge}</td>
                    <td>${item.fecha_renovacion ? formatDate(item.fecha_renovacion) : 'N/A'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="renovarDocumento(${item.id_historial}, '${item.tipo_documento}')">
                            <i class="fas fa-sync"></i> Renovar
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }
}

function getEstadoBadge(estado, diasRestantes) {
    if (diasRestantes < 0) {
        return '<span class="badge bg-danger">Vencido</span>';
    } else if (diasRestantes <= 30) {
        return '<span class="badge bg-warning">Por vencer</span>';
    } else {
        return '<span class="badge bg-success">Vigente</span>';
    }
}

function filtrarVencimientos() {
    const tipoDoc = document.getElementById('filtroTipoDocumento').value;
    const estado = document.getElementById('filtroEstado').value;
    const busqueda = document.getElementById('buscarVencimiento').value.toLowerCase();
    
    // Construir URL con parámetros de filtro
    let url = '/api/vehiculos/vencimientos?';
    const params = new URLSearchParams();
    
    // Agregar filtros como parámetros
    if (tipoDoc) {
        if (tipoDoc === 'SOAT') {
            params.append('tipo', 'soat');
        } else if (tipoDoc === 'Tecnomecánica') {
            params.append('tipo', 'tecnomecanica');
        }
    }
    
    // Determinar días de anticipación basado en el estado
    if (estado === 'vencido') {
        params.append('dias', '0'); // Solo vencidos
    } else if (estado === 'por_vencer') {
        params.append('dias', '30'); // Por vencer en 30 días
    } else if (estado === 'vigente') {
        params.append('dias', '365'); // Vigentes hasta 1 año
    } else {
        params.append('dias', '60'); // Por defecto 60 días
    }
    
    url += params.toString();
    
    // Cargar datos con filtros
    fetch(url)
        .then(response => response.json())
        .then(response => {
            if (response.success) {
                let data = response.data || [];
                
                // Aplicar filtro de búsqueda por placa en el frontend
                if (busqueda) {
                    data = data.filter(item => 
                        item.placa.toLowerCase().includes(busqueda)
                    );
                }
                
                // Aplicar filtro de estado en el frontend si es necesario
                if (estado) {
                    data = data.filter(item => {
                        if (estado === 'vencido') {
                            return item.dias_restantes < 0;
                        } else if (estado === 'por_vencer') {
                            return item.dias_restantes >= 0 && item.dias_restantes <= 30;
                        } else if (estado === 'vigente') {
                            return item.dias_restantes > 30;
                        }
                        return true;
                    });
                }
                
                actualizarTablaVencimientos(data);
            } else {
                console.error('Error en la respuesta:', response.message);
                actualizarTablaVencimientos([]);
            }
        })
        .catch(error => {
            console.error('Error loading filtered expiration data:', error);
            actualizarTablaVencimientos([]);
        });
}

function limpiarFiltros() {
    document.getElementById('filtroTipoDocumento').value = '';
    document.getElementById('filtroEstado').value = '';
    document.getElementById('buscarVencimiento').value = '';
    cargarVencimientos();
}

function renovarDocumento(idHistorial, tipoDocumento) {
    const nuevaFecha = prompt(`Ingresa la nueva fecha de vencimiento para ${tipoDocumento} (YYYY-MM-DD):`);
    
    if (!nuevaFecha) return;
    
    fetch('/api/vehiculos/renovar-documento', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id_historial: idHistorial,
            nueva_fecha: nuevaFecha
        })
    })
    .then(response => response.json())
    .then(data => {
        Swal.fire({
            icon: 'success',
            title: 'Éxito',
            text: 'Documento renovado exitosamente'
        });
        cargarVencimientos();
        cargarDashboard();
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Error al renovar documento'
        });
    });
}

// Reports Functions
function generarReporte() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    const tipoReporte = document.getElementById('tipoReporte').value;
    
    if (!fechaInicio || !fechaFin) {
        Swal.fire({
            icon: 'warning',
            title: 'Advertencia',
            text: 'Por favor selecciona las fechas de inicio y fin'
        });
        return;
    }
    
    fetch(`/api/vehiculos/reportes?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}&tipo=${tipoReporte}`)
        .then(response => response.json())
        .then(data => {
            actualizarGraficoReporte(data);
            actualizarResumenEstadistico(data);
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al generar el reporte'
            });
        });
}

function actualizarGraficoReporte(data) {
    const ctx = document.getElementById('chartReporte').getContext('2d');
    
    if (chartReporte) {
        chartReporte.destroy();
    }
    
    chartReporte = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.labels || ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
            datasets: [{
                label: 'Registros',
                data: data.values || [0, 0, 0, 0, 0, 0],
                borderColor: '#4e73df',
                backgroundColor: 'rgba(78, 115, 223, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            maintainAspectRatio: false,
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(234, 236, 244, 1)',
                        zeroLineColor: 'rgba(234, 236, 244, 1)',
                        drawBorder: false,
                        borderDash: [2],
                        zeroLineBorderDash: [2]
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(234, 236, 244, 1)',
                        zeroLineColor: 'rgba(234, 236, 244, 1)',
                        drawBorder: false,
                        borderDash: [2],
                        zeroLineBorderDash: [2]
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    backgroundColor: 'rgb(255,255,255)',
                    bodyColor: '#858796',
                    titleMarginBottom: 10,
                    titleColor: '#6e707e',
                    titleFont: {
                        size: 14
                    },
                    borderColor: '#dddfeb',
                    borderWidth: 1,
                    xPadding: 15,
                    yPadding: 15,
                    displayColors: false,
                    intersect: false,
                    mode: 'index',
                    caretPadding: 10
                }
            }
        }
    });
}

function actualizarResumenEstadistico(data) {
    const resumen = document.getElementById('resumenEstadistico');
    resumen.innerHTML = `
        <div class="mb-3">
            <h6 class="text-primary">Total de Registros</h6>
            <h4>${data.total || 0}</h4>
        </div>
        <div class="mb-3">
            <h6 class="text-primary">Promedio Mensual</h6>
            <h4>${data.promedio || 0}</h4>
        </div>
        <div class="mb-3">
            <h6 class="text-primary">Tendencia</h6>
            <h4 class="${data.tendencia === 'up' ? 'text-success' : 'text-danger'}">
                <i class="fas fa-arrow-${data.tendencia === 'up' ? 'up' : 'down'}"></i>
                ${data.porcentaje_cambio || 0}%
            </h4>
        </div>
    `;
}

function exportarReporte() {
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    const tipoReporte = document.getElementById('tipoReporte').value;
    
    if (!fechaInicio || !fechaFin) {
        Swal.fire({
            icon: 'warning',
            title: 'Advertencia',
            text: 'Por favor selecciona las fechas de inicio y fin'
        });
        return;
    }
    
    const url = `/api/vehiculos/reportes/exportar?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}&tipo=${tipoReporte}`;
    window.open(url, '_blank');
}

// Utility Functions
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-ES');
}

// Limpiar formulario al abrir el modal de registro
$('#modalRegistroVehiculo').on('show.bs.modal', function (e) {
    if (!e.relatedTarget) return;
    modo = 'crear';
    document.getElementById('formVehiculo').reset();
    document.getElementById('id_parque_automotor').value = '';
    document.getElementById('modalTitle').textContent = 'Registrar Nuevo Vehículo';
    document.getElementById('fecha_asignacion').value = new Date().toISOString().split('T')[0];
    document.getElementById('estado').value = 'Activo';
});
</script>

<!-- Incluir popup de stock bajo -->

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Variables globales para los gráficos
let chartTipoVehiculo = null;
let chartEstadoDocumentos = null;
// chartReporte ya está declarado arriba

// Función para crear gráfico de tipo de vehículos
function crearGraficoTipoVehiculo(data) {
    const ctx = document.getElementById('chartTipoVehiculo').getContext('2d');
    
    if (chartTipoVehiculo) {
        chartTipoVehiculo.destroy();
    }
    
    chartTipoVehiculo = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.labels || ['Automóvil', 'Motocicleta', 'Camión', 'Camioneta'],
            datasets: [{
                data: data.values || [0, 0, 0, 0],
                backgroundColor: [
                    '#4e73df',
                    '#1cc88a',
                    '#36b9cc',
                    '#f6c23e'
                ],
                hoverBackgroundColor: [
                    '#2e59d9',
                    '#17a673',
                    '#2c9faf',
                    '#dda20a'
                ],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            maintainAspectRatio: false,
            tooltips: {
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: false,
                caretPadding: 10,
            },
            legend: {
                display: true,
                position: 'bottom'
            },
            cutoutPercentage: 80,
        },
    });
}

// Función para crear gráfico de estado de documentos
function crearGraficoEstadoDocumentos(data) {
    const ctx = document.getElementById('chartEstadoDocumentos').getContext('2d');
    
    if (chartEstadoDocumentos) {
        chartEstadoDocumentos.destroy();
    }
    
    chartEstadoDocumentos = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.labels || ['Vigentes', 'Por Vencer', 'Vencidos'],
            datasets: [{
                data: data.values || [0, 0, 0],
                backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
                hoverBackgroundColor: ['#17a673', '#dda20a', '#c0392b'],
                hoverBorderColor: "rgba(234, 236, 244, 1)",
            }],
        },
        options: {
            maintainAspectRatio: false,
            tooltips: {
                backgroundColor: "rgb(255,255,255)",
                bodyFontColor: "#858796",
                borderColor: '#dddfeb',
                borderWidth: 1,
                xPadding: 15,
                yPadding: 15,
                displayColors: false,
                caretPadding: 10,
            },
            legend: {
                display: true,
                position: 'bottom'
            },
        },
    });
}

// Función para cargar datos de gráficos
function cargarDatosGraficos() {
    fetch('/api/vehiculos/graficos')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                crearGraficoTipoVehiculo(data.tipo_vehiculo);
                crearGraficoEstadoDocumentos(data.estado_documentos);
            } else {
                console.error('Error al cargar datos de gráficos:', data.message);
                // Crear gráficos con datos por defecto
                crearGraficoTipoVehiculo({});
                crearGraficoEstadoDocumentos({});
            }
        })
        .catch(error => {
            console.error('Error loading chart data:', error);
            // Crear gráficos con datos por defecto
            crearGraficoTipoVehiculo({});
            crearGraficoEstadoDocumentos({});
        });
}
</script>

{% endblock %}