{% extends "header.html" %}
{% block content %}
<style>
    .btn.disabled{opacity:.6;cursor:not-allowed;pointer-events:none}
    .btn.disabled:hover{opacity:.6}
    .cc-container{max-width:1500px;margin:0 auto}
</style>
<div class="container-fluid mt-5 cc-container">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h3 class="mb-0"><i class="fas fa-sync-alt me-2"></i>Cierre de Ciclo</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-sm-6 col-md-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" id="fechaFiltro" class="form-control" />
                        </div>
                        <div class="col-sm-6 col-md-4">
                            <label class="form-label">Tipificación</label>
                            <input type="text" id="tipificacionFiltro" class="form-control" value="CLIENTE INCONFORME" readonly />
                        </div>
                        <div class="col-sm-12 col-md-5 d-flex align-items-end">
                            {% if tiene_asistencia %}
                            <button id="btnBuscar" class="btn btn-secondary me-2">
                                <i class="fas fa-search me-2"></i>Buscar
                            </button>
                            {% else %}
                            <button id="btnBuscar" class="btn btn-secondary disabled" disabled title="Debe registrar asistencia primero">
                                <i class="fas fa-search me-2"></i>Buscar
                            </button>
                            {% endif %}
                            <span class="ms-auto text-muted">Total: <span id="totalRegistros">0</span> • Pend. mes: <span id="pendMesBadge" class="badge bg-warning text-dark">0</span></span>
                        </div>
                    </div>
                    <div class="row g-3" id="cardsContainer">
                        <div class="col-12 text-center text-muted">Sin datos</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
const apiUrl = '/api/operativo/cierre-ciclo';
function fmtFecha(v){
    if(!v)return '';
    const s=String(v).trim();
    const m1=s.match(/^(\d{4}-\d{2}-\d{2})/);
    if(m1)return m1[1];
    const m2=s.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
    if(m2)return `${m2[3]}-${m2[2]}-${m2[1]}`;
    try{
        const d=new Date(s);
        if(!isNaN(d)){
            const y=d.getFullYear();
            const m=String(d.getMonth()+1).padStart(2,'0');
            const dd=String(d.getDate()).padStart(2,'0');
            return `${y}-${m}-${dd}`;
        }
    }catch(e){}
    return s;
}
async function buscar(){
    const fecha=document.getElementById('fechaFiltro').value;
    const tip=document.getElementById('tipificacionFiltro').value;
    const params=new URLSearchParams();
    if(fecha)params.set('fecha',fecha);
    if(tip)params.set('tipificacion',tip);
    const res=await fetch(apiUrl+'?'+params.toString(),{credentials:'include'});
    const data=await res.json();
    const cardsContainer=document.getElementById('cardsContainer');
    if(!data.success){
        cardsContainer.innerHTML='<div class="col-12 text-center text-danger">Error</div>';
        document.getElementById('totalRegistros').textContent='0';
        return;
    }
    const rows=data.data||[];
    document.getElementById('totalRegistros').textContent=rows.length;
    if(rows.length===0){
        cardsContainer.innerHTML='<div class="col-12 text-center text-muted">Sin datos</div>';
        return;
    }
    cardsContainer.innerHTML=rows.map(r=>{
        const ot=r.orden_de_trabajo??'';
        const cuenta=r.numero_de_cuenta??'';
        const alerta=(r.alerta_cierre_ciclo||'').trim().toUpperCase();
        const headerClass=(alerta==='ALTO')?'bg-danger':(alerta==='MEDIO')?'bg-warning text-dark':(alerta==='BAJO')?'bg-success':'bg-secondary';
        const cardBorder=(alerta==='ALTO')?'border-danger':(alerta==='MEDIO')?'border-warning':(alerta==='BAJO')?'border-success':'border-secondary';
        const estadoSuper = (r.estado_super||'') === 'Completado'
            ? '<span class="badge bg-success">Completado</span>'
            : '<span class="badge bg-warning text-dark">Pendiente</span>';
        const gestionCompletada = (r.estado_super||'') === 'Completado';
        let bloqueada48 = false;
        let cutoffStr = '';
        try{
            const faStr = fmtFecha(r.fecha_franja_cierre_ciclo);
            const franjaTxt = String(r.franja_cierre_ciclo||'').trim();
            if(faStr){
                const ymd = faStr.split('-');
                if(ymd.length===3){
                    const y = Number(ymd[0]);
                    const m0 = Number(ymd[1]) - 1;
                    const d = Number(ymd[2]);
                    let endDate = null;
                    try{
                        const norm = franjaTxt.replace(/–|—/g,'-').replace(/\s+/g,' ').toLowerCase();
                        const times = [];
                        const re = /(\d{1,2}:\d{2}(?::\d{2})?)\s*(a\.?\s*m\.?|p\.?\s*m\.?|am|pm)?/gi;
                        let mm;
                        while((mm = re.exec(norm))){
                            times.push([mm[1], mm[2]||'']);
                        }
                        if(times.length>0){
                            const last = times[times.length-1];
                            const tparts = last[0].split(':');
                            let hh = Number(tparts[0]);
                            let min = Number(tparts[1]);
                            let ss = tparts[2] ? Number(tparts[2]) : 0;
                            const mer = String(last[1]||'').replace(/\./g,'').replace(/\s+/g,'').toUpperCase();
                            if(mer==='PM' && hh<12) hh += 12;
                            if(mer==='AM' && hh===12) hh = 0;
                            endDate = new Date(y, m0, d, hh, min, ss);
                        }else{
                            endDate = new Date(y, m0, d, 0, 0, 0);
                        }
                    }catch(e2){ endDate = new Date(y, m0, d, 0, 0, 0); }
                    const cutoff = new Date(endDate.getTime() + 48 * 60 * 60 * 1000);
                    bloqueada48 = (new Date()) >= cutoff;
                    const pad=(n)=>String(n).padStart(2,'0');
                    cutoffStr = `${cutoff.getFullYear()}-${pad(cutoff.getMonth()+1)}-${pad(cutoff.getDate())} ${pad(cutoff.getHours())}:${pad(cutoff.getMinutes())}`;
                }
            }
        }catch(e){}
        const disabledAttr = (gestionCompletada || bloqueada48) ? 'disabled' : '';
        const disabledClass = (gestionCompletada || bloqueada48) ? 'disabled' : '';
        let btnTitle = '';
        if(gestionCompletada){ btnTitle = 'Cierre completado'; }
        else if(bloqueada48){ btnTitle = cutoffStr ? ('Bloqueado por 48h (corte: '+cutoffStr+')') : 'Bloqueado por 48h'; }
        return `
        <div class="col-md-6 col-lg-4">
            <div class="card h-100 ${cardBorder}">
                <div class="card-header ${headerClass} text-white">
                    <h5 class="card-title mb-0">OT: ${ot}</h5>
                </div>
                <div class="card-body">
                    <p class="card-text"><strong>Cuenta:</strong> ${cuenta}</p>
                    <p class="card-text"><strong>Técnico:</strong> ${r.tecnico??''}</p>
                    <p class="card-text"><strong>Analista:</strong> ${r.analista??''}</p>
                    <p class="card-text"><strong>Supervisor:</strong> ${r.supervisor??''}</p>
                    <p class="card-text"><strong>Fecha:</strong> ${fmtFecha(r.fecha)}</p>
                    <p class="card-text"><strong>Fecha Agenda cierre ciclo:</strong> ${fmtFecha(r.fecha_franja_cierre_ciclo)}</p>
                    <p class="card-text"><strong>Franja cierre ciclo:</strong> ${r.franja_cierre_ciclo??''}</p>
                    <p class="card-text"><strong>Nivel de Alerta:</strong> ${r.alerta_cierre_ciclo??''}</p>
                    <p class="card-text"><strong>Estado:</strong> ${r.estado??''}</p>
                    <p class="card-text"><strong>Estado Super:</strong> ${estadoSuper}</p>
                </div>
                <div class="card-footer">
                    <button class="btn btn-outline-secondary btn-sm ${disabledClass}" ${disabledAttr} title="${btnTitle}" onclick="abrirGestion('${ot}','${cuenta}')">
                        <i class="fas fa-tools me-1"></i>Gestionar
                    </button>
                </div>
            </div>
        </div>`
    }).join('');
    await actualizarPendientesMes();
}
document.addEventListener('DOMContentLoaded',()=>{
    const f=document.getElementById('fechaFiltro');
    const today=new Date();
    const y=today.getFullYear();
    const m=String(today.getMonth()+1).padStart(2,'0');
    const d=String(today.getDate()).padStart(2,'0');
    f.value=`${y}-${m}-${d}`;
    const tieneAsistencia = {{ 'true' if tiene_asistencia else 'false' }};
    if(tieneAsistencia){
        buscar();
    }
    const btn=document.getElementById('btnBuscar');
    if(btn){
        btn.addEventListener('click',buscar);
    }
    actualizarPendientesMes();
});
async function actualizarPendientesMes(){
    try{
        const tip=document.getElementById('tipificacionFiltro').value;
        const r=await fetch('/api/operativo/cierre-ciclo/pending-month?'+new URLSearchParams({tip:tip}),{credentials:'include'});
        const d=await r.json();
        const v=(d&&d.success)?Number(d.pending||0):0;
        const el=document.getElementById('pendMesBadge');
        if(el)el.textContent=String(v);
    }catch(e){}
}
async function abrirGestion(ot, cuenta){
    const modalEl=document.getElementById('modalGestionSuper');
    const m=new bootstrap.Modal(modalEl);
    document.getElementById('gs_ot').value=ot||'';
    document.getElementById('gs_cuenta').value=cuenta||'';
    document.getElementById('gs_tecnico').value='';
    document.getElementById('gs_analista').value='';
    document.getElementById('gs_supervisor').value='';
    document.getElementById('gs_fecha').value='';
    document.getElementById('gs_estado').value='';
    document.getElementById('gs_tip_ok').value='';
    document.getElementById('gs_tip_nov').value='';
    document.getElementById('gs_observ').value='';
    try{ document.getElementById('gs_fecha_agenda_cierre').value=''; }catch(e){}
    try{ document.getElementById('gs_franja_cierre').value=''; }catch(e){}
    try{ document.getElementById('gs_alerta_cierre').value=''; }catch(e){}
    try{ document.getElementById('gs_obs_super').value=''; }catch(e){}
    try{ document.getElementById('gs_recomendacion_tecnico').value=''; }catch(e){}
    try{ const f=document.getElementById('gs_imagen_falla'); if(f) f.value=''; }catch(e){}
    try{ const s=document.getElementById('gs_imagen_solucion'); if(s) s.value=''; }catch(e){}
    await cargarTipificaciones1();
    try{
        const params=new URLSearchParams({ot:ot, cuenta:cuenta});
        const res=await fetch('/api/operativo/cierre-ciclo/detalle?'+params.toString(),{credentials:'include'});
        const data=await res.json();
        if(data && data.success && data.data){
            const r=data.data;
            document.getElementById('gs_tecnico').value=r.tecnico||'';
            document.getElementById('gs_analista').value=r.analista||'';
            document.getElementById('gs_supervisor').value=r.supervisor||'';
            document.getElementById('gs_fecha').value=fmtFecha(r.fecha)||'';
            document.getElementById('gs_estado').value=r.estado||'';
            document.getElementById('gs_tip_ok').value=r.tipificacion_ok||'';
            document.getElementById('gs_tip_nov').value=r.tipificacion_novedad||'';
            document.getElementById('gs_observ').value=r.observacion_cierre||'';
            try{ document.getElementById('gs_fecha_agenda_cierre').value=fmtFecha(r.fecha_franja_cierre_ciclo)||''; }catch(e){}
            try{ document.getElementById('gs_franja_cierre').value=r.franja_cierre_ciclo||''; }catch(e){}
            try{ document.getElementById('gs_alerta_cierre').value=r.alerta_cierre_ciclo||''; }catch(e){}
        }
    }catch(e){}
    m.show();
}
async function cargarTipificaciones1(){
    const sel=document.getElementById('gs_tip1');
    sel.innerHTML='<option value="">Seleccione</option>';
    try{
        const res=await fetch('/api/operativo/cierre-ciclo/tipificaciones1',{credentials:'include'});
        const data=await res.json();
        if(data && data.success){
            (data.data||[]).forEach(x=>{
                const opt=document.createElement('option');
                opt.value=x.codigo;
                opt.textContent=x.nombre||x.codigo;
                sel.appendChild(opt);
            });
        }
    }catch(e){}
    document.getElementById('gs_tip2').innerHTML='<option value="">Seleccione</option>';
}
async function cargarTipificaciones2(){
    const p=document.getElementById('gs_tip1').value;
    const sel=document.getElementById('gs_tip2');
    sel.innerHTML='<option value="">Seleccione</option>';
    if(!p)return;
    try{
        const res=await fetch('/api/operativo/cierre-ciclo/tipificaciones2?parent='+encodeURIComponent(p),{credentials:'include'});
        const data=await res.json();
        if(data && data.success){
            (data.data||[]).forEach(x=>{
                const opt=document.createElement('option');
                opt.value=x.codigo;
                opt.textContent=x.nombre||x.codigo;
                sel.appendChild(opt);
            });
        }
    }catch(e){}
}
async function guardarGestionSuper(){
    const obs=(document.getElementById('gs_obs_super')?.value||'').trim();
    const rec=(document.getElementById('gs_recomendacion_tecnico')?.value||'').trim();
    const f=document.getElementById('gs_imagen_falla');
    const s=document.getElementById('gs_imagen_solucion');
    const fOk=!!(f && f.files && f.files[0]);
    const sOk=!!(s && s.files && s.files[0]);
    if(!obs || !rec || !fOk || !sOk){
        const msg='Observación del super, recomendación al técnico e imágenes de falla y solución son obligatorias';
        if(window.Swal){ window.Swal.fire({icon:'error',title:'Datos requeridos',text:msg}); } else { alert(msg); }
        return;
    }
    const fd=new FormData();
    fd.append('ot', document.getElementById('gs_ot').value);
    fd.append('cuenta', document.getElementById('gs_cuenta').value);
    fd.append('tip_super_1', document.getElementById('gs_tip1').value);
    fd.append('tip_super_2', document.getElementById('gs_tip2').value);
    fd.append('observacion_super', obs);
    try{ const fechaAgendaEl=document.getElementById('gs_fecha_agenda_cierre'); const fechaAgenda=(fechaAgendaEl?.value||'').trim(); if(fechaAgenda){ fd.append('fecha_franja_cierre_ciclo', fechaAgenda); } }catch(e){}
    try{ const franjaEl=document.getElementById('gs_franja_cierre'); const franja=(franjaEl?.value||'').trim(); if(franja){ fd.append('franja_cierre_ciclo', franja); } }catch(e){}
    fd.append('recomendacion_tecnico', rec);
    fd.append('imagen_falla', f.files[0]);
    fd.append('imagen_solucion', s.files[0]);
    try{
        const res=await fetch('/api/operativo/cierre-ciclo/gestionar',{ method:'POST', credentials:'include', body: fd });
        const data=await res.json();
        if(data && data.success){
            const modalEl=document.getElementById('modalGestionSuper');
            bootstrap.Modal.getInstance(modalEl).hide();
            buscar();
        } else {
            const m=(data && data.message)?data.message:'No se pudo guardar la gestión';
            if(window.Swal){ window.Swal.fire({icon:'error',title:'Error',text:m}); } else { alert(m); }
        }
    }catch(e){}
}
</script>
<div class="modal fade" id="modalGestionSuper" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-tools me-2"></i>Gestión Super</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">OT</label>
                        <input id="gs_ot" class="form-control" readonly />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Cuenta</label>
                        <input id="gs_cuenta" class="form-control" readonly />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Técnico</label>
                        <input id="gs_tecnico" class="form-control" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Analista</label>
                        <input id="gs_analista" class="form-control" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Supervisor</label>
                        <input id="gs_supervisor" class="form-control" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Fecha</label>
                        <input id="gs_fecha" class="form-control" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Estado</label>
                        <input id="gs_estado" class="form-control" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tipificación OK</label>
                        <input id="gs_tip_ok" class="form-control" readonly />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Tipificación Novedad</label>
                        <input id="gs_tip_nov" class="form-control" readonly />
                    </div>
                    <div class="col-12">
                        <label class="form-label">Observación Analista</label>
                        <textarea id="gs_observ" class="form-control" rows="2" readonly></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Fecha Agenda cierre ciclo</label>
                        <input id="gs_fecha_agenda_cierre" type="date" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Franja de cierre de ciclo</label>
                        <select id="gs_franja_cierre" class="form-select">
                            <option value="">Seleccione...</option>
                            <option>7:00:00 a. m. — 9:00:00 a. m.</option>
                            <option>9:00:00 a. m. — 11:00:00 a. m.</option>
                            <option>11:00:00 a. m. — 1:00:00 p. m.</option>
                            <option>1:00:00 p. m. — 3:00:00 p. m.</option>
                            <option>3:00:00 p. m. — 5:00:00 p. m.</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nivel de Alerta</label>
                        <input id="gs_alerta_cierre" class="form-control" readonly />
                    </div>
                    <hr />
                    <div class="col-md-6">
                        <label class="form-label">Tipificación de cierre de ciclo 1</label>
                        <select id="gs_tip1" class="form-select" onchange="cargarTipificaciones2()"></select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Tipificación de cierre de ciclo 2</label>
                        <select id="gs_tip2" class="form-select"></select>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Observación Super</label>
                        <textarea id="gs_obs_super" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Recomendación al Técnico</label>
                        <textarea id="gs_recomendacion_tecnico" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Imagen de Falla</label>
                        <input id="gs_imagen_falla" type="file" class="form-control" accept="image/*" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Imagen de Solución</label>
                        <input id="gs_imagen_solucion" type="file" class="form-control" accept="image/*" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarGestionSuper()">Guardar Gestión</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
