{% extends 'header.html' %}
{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="mb-0"><i class="fas fa-play me-2 text-warning"></i>Inicio de Operaci√≥n</h2>
        <a href="/operativo/indicadores/operaciones" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver a Operaciones
        </a>
    </div>

    <div class="alert alert-info" role="alert">
        Consulta la asistencia del d√≠a para tu equipo. Usa el filtro de fecha para ver otro d√≠a.
    </div>

    <!-- Filtros -->
    <div class="card mb-3">
        <div class="card-body">
            <form id="formFiltroAsistencia" class="row g-3 align-items-end">
                <div class="col-sm-6 col-md-4">
                    <label for="fechaFiltro" class="form-label"><i class="fas fa-calendar me-1"></i>Fecha</label>
                    <input type="date" class="form-control" id="fechaFiltro" name="fecha">
                </div>
                <div class="col-sm-6 col-md-4">
                    <label class="form-label d-block">&nbsp;</label>
                    <button type="button" id="btnBuscar" class="btn btn-warning">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tarjetas de estad√≠sticas -->
    <div class="row mb-3">
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Total T√©cnicos</h6>
                            <h3 id="totalTecnicosVal" class="mb-0">0</h3>
                        </div>
                        <div class="icon-container bg-warning bg-opacity-10 p-3 rounded">
                            <i class="fas fa-users text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Con Asistencia</h6>
                            <h3 id="conAsistenciaVal" class="mb-0">0</h3>
                        </div>
                        <div class="icon-container bg-success bg-opacity-10 p-3 rounded">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="w-100">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="text-muted mb-1">Sin Asistencia</h6>
                                    <h3 id="sinAsistenciaVal" class="mb-0">0</h3>
                                </div>
                                <div class="icon-container bg-danger bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-times-circle text-danger"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">Detalle por tipificaci√≥n:</small>
                                <ul id="detalleSinList" class="list-unstyled mb-0" style="max-height: 160px; overflow:auto"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas adicionales -->
    <div class="row mb-3">
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Ok's D√≠a</h6>
                            <h3 id="oksDiaVal" class="mb-0">0</h3>
                        </div>
                        <div class="icon-container bg-info bg-opacity-10 p-3 rounded">
                            <i class="fas fa-check text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Presupuesto D√≠a</h6>
                            <h3 id="presupuestoDiaVal" class="mb-0">$0</h3>
                        </div>
                        <div class="icon-container bg-primary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-wallet text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Presupuesto Mes</h6>
                            <h3 id="presupuestoMesVal" class="mb-0">$0</h3>
                        </div>
                        <div class="icon-container bg-secondary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-calendar-alt text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de cumplimiento -->
    <div class="row mb-3">
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Cumple</h6>
                            <h3 id="cumpleVal" class="mb-0">0</h3>
                        </div>
                        <div class="icon-container bg-success bg-opacity-10 p-3 rounded">
                            <i class="fas fa-thumbs-up text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">No Cumple</h6>
                            <h3 id="noCumpleVal" class="mb-0">0</h3>
                        </div>
                        <div class="icon-container bg-danger bg-opacity-10 p-3 rounded">
                            <i class="fas fa-thumbs-down text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Cumplimiento</h6>
                            <h3 id="cumplimientoVal" class="mb-0">0%</h3>
                            <small id="cumplimientoFraccion" class="text-muted">0/0</small>
                        </div>
                        <div id="cumplimientoIcon" class="icon-container bg-info bg-opacity-10 p-3 rounded">
                            <i class="fas fa-chart-pie text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Cumplimiento Mes</h6>
                            <h3 id="cumplimientoMesVal" class="mb-0">0%</h3>
                            <small id="cumplimientoMesFraccion" class="text-muted">0/0</small>
                        </div>
                        <div id="cumplimientoMesIcon" class="icon-container bg-primary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-calendar-alt text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de asistencia -->
    <div class="card">
        <div class="card-header bg-warning bg-opacity-10">
            <h5 class="mb-0"><i class="fas fa-clipboard-check me-2 text-warning"></i>Asistencia del D√≠a</h5>
        </div>
        <div class="card-body px-0 pt-0">
            <div id="mensajeSinRegistros" class="alert alert-secondary mx-3 my-3" style="display:none;">
                <i class="fas fa-info-circle me-2"></i>No hay registros de asistencia para la fecha seleccionada.
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="tablaAsistencia">
                    <thead class="table-dark">
                        <tr>
                            <th style="min-width:110px">C√©dula</th>
                            <th style="min-width:160px">T√©cnico</th>
                            <th style="min-width:140px">Carpeta</th>
                            <th style="min-width:140px">Super</th>
                            <th style="min-width:120px">Carpeta_D√≠a</th>
                            <th style="min-width:160px">Ok's</th>
                            <th style="min-width:100px">Valor</th>
                            <th style="min-width:120px">Estado</th>
                            <th style="min-width:180px">Novedad</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas se renderizan con JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const inputFecha = document.getElementById('fechaFiltro');
    const btnBuscar = document.getElementById('btnBuscar');
    const tbody = document.querySelector('#tablaAsistencia tbody');
    const mensajeSinRegistros = document.getElementById('mensajeSinRegistros');

    // Variables para debugging y control de ejecuci√≥n
    let ejecutandoCargarAsistencia = false;
    let contadorEjecuciones = 0;
    let eventListenersRegistrados = false;

    // Inicializa fecha con hoy (Bogot√°)
    const hoy = new Date();
    const tzOffset = hoy.getTimezoneOffset() * 60000;
    const localISODate = new Date(hoy - tzOffset).toISOString().slice(0,10);
    inputFecha.value = localISODate;

    async function cargarAsistencia() {
        // Prevenir ejecuciones m√∫ltiples simult√°neas
        if (ejecutandoCargarAsistencia) {
            console.warn('‚ö†Ô∏è DEBUG: cargarAsistencia ya est√° ejecut√°ndose, saltando');
            return;
        }

        ejecutandoCargarAsistencia = true;
        contadorEjecuciones++;
        console.log(`üöÄ DEBUG: cargarAsistencia iniciada (ejecuci√≥n #${contadorEjecuciones})`);

        const fecha = inputFecha.value;
        // Agregar timestamp para evitar cache
        const timestamp = new Date().getTime();
        const url = `/api/operativo/inicio-operacion/asistencia?fecha=${encodeURIComponent(fecha)}&_t=${timestamp}`;
        console.log(`üåê DEBUG: Llamando API: ${url}`);
        
        try {
            const resp = await fetch(url, { credentials: 'include' });
            console.log('üì° DEBUG: Respuesta recibida:', {
                status: resp.status,
                ok: resp.ok,
                headers: Object.fromEntries(resp.headers.entries())
            });
            
            const data = await resp.json();
            console.log('üì¶ DEBUG: Datos parseados:', {
                success: data.success,
                registros_count: data.registros ? data.registros.length : 0,
                stats: data.stats
            });
            
            renderTarjetas(data?.stats);
            renderTabla(data);
        } catch (err) {
            console.error('‚ùå DEBUG: Error  asistencia:', err);
        } finally {
            ejecutandoCargarAsistencia = false;
            console.log(`‚úÖ DEBUG: cargarAsistencia finalizada (ejecuci√≥n #${contadorEjecuciones})`);
        }
    }

    function renderTarjetas(stats) {
        const totalEl = document.getElementById('totalTecnicosVal');
        const conEl = document.getElementById('conAsistenciaVal');
        const sinEl = document.getElementById('sinAsistenciaVal');
        const detalleList = document.getElementById('detalleSinList');
        // Nuevas tarjetas
        const oksDiaEl = document.getElementById('oksDiaVal');
        const presupuestoDiaEl = document.getElementById('presupuestoDiaVal');
        const presupuestoMesEl = document.getElementById('presupuestoMesVal');
        // Tarjetas de cumplimiento
        const cumpleEl = document.getElementById('cumpleVal');
        const noCumpleEl = document.getElementById('noCumpleVal');
        const cumplimientoEl = document.getElementById('cumplimientoVal');
        const cumplimientoFraccionEl = document.getElementById('cumplimientoFraccion');
        const cumplimientoIconEl = document.getElementById('cumplimientoIcon');
        const cumplimientoMesEl = document.getElementById('cumplimientoMesVal');
        const cumplimientoMesFraccionEl = document.getElementById('cumplimientoMesFraccion');
        const cumplimientoMesIconEl = document.getElementById('cumplimientoMesIcon');

        if (!stats) {
            totalEl.textContent = '0';
            conEl.textContent = '0';
            sinEl.textContent = '0';
            detalleList.innerHTML = '';
            if (oksDiaEl) oksDiaEl.textContent = '0';
            if (presupuestoDiaEl) presupuestoDiaEl.textContent = '$0';
            if (presupuestoMesEl) presupuestoMesEl.textContent = '$0';
            if (cumpleEl) cumpleEl.textContent = '0';
            if (noCumpleEl) noCumpleEl.textContent = '0';
            if (cumplimientoEl) cumplimientoEl.textContent = '0%';
            if (cumplimientoFraccionEl) cumplimientoFraccionEl.textContent = '0/0';
            if (cumplimientoMesEl) cumplimientoMesEl.textContent = '0%';
            if (cumplimientoMesFraccionEl) cumplimientoMesFraccionEl.textContent = '0/0';
            return;
        }
        totalEl.textContent = Number(stats.total_tecnicos || 0).toLocaleString('es-CO');
        conEl.textContent = Number(stats.con_asistencia || 0).toLocaleString('es-CO');
        sinEl.textContent = Number((stats.sin_asistencia && stats.sin_asistencia.total) || stats.sin_asistencia || 0).toLocaleString('es-CO');

        // Render detalle sin asistencia
        detalleList.innerHTML = '';
        const detalle = stats.sin_asistencia_detalle || (stats.sin_asistencia && stats.sin_asistencia.detalle) || [];
        detalle.forEach(item => {
            const li = document.createElement('li');
            li.className = 'd-flex justify-content-between';
            li.innerHTML = `<span class="text-muted">${safe(item.nombre)}</span><span>${Number(item.cantidad || 0).toLocaleString('es-CO')}</span>`;
            detalleList.appendChild(li);
        });

        // Render nuevas tarjetas
        const oksDia = Number(stats.oks_dia || 0);
        const presupuestoDia = Number(stats.presupuesto_dia || 0);
        const presupuestoMes = Number(stats.presupuesto_mes || (presupuestoDia * 26));
        if (oksDiaEl) oksDiaEl.textContent = oksDia.toLocaleString('es-CO');
        if (presupuestoDiaEl) presupuestoDiaEl.textContent = `$${presupuestoDia.toLocaleString('es-CO')}`;
        if (presupuestoMesEl) presupuestoMesEl.textContent = `$${presupuestoMes.toLocaleString('es-CO')}`;

        // Render tarjetas de cumplimiento
        const cumple = Number(stats.cumple || 0);
        const noCumple = Number(stats.no_cumple || 0);
        if (cumpleEl) cumpleEl.textContent = cumple.toLocaleString('es-CO');
        if (noCumpleEl) noCumpleEl.textContent = noCumple.toLocaleString('es-CO');

        // Render tarjeta de cumplimiento (porcentaje)
        const cumplimientoPorcentaje = Number(stats.cumplimiento_porcentaje || 0);
        const cumplimientoFraccion = stats.cumplimiento_fraccion || '0/0';
        
        if (cumplimientoEl) cumplimientoEl.textContent = `${cumplimientoPorcentaje}%`;
        if (cumplimientoFraccionEl) cumplimientoFraccionEl.textContent = cumplimientoFraccion;
        
        // Cambiar colores seg√∫n el nivel de cumplimiento
        if (cumplimientoIconEl) {
            const iconContainer = cumplimientoIconEl;
            const icon = iconContainer.querySelector('i');
            
            // Remover clases anteriores
            iconContainer.className = 'icon-container p-3 rounded';
            icon.className = 'fas fa-chart-pie';
            
            if (cumplimientoPorcentaje >= 80) {
                // Verde para buen cumplimiento (80% o m√°s)
                iconContainer.classList.add('bg-success', 'bg-opacity-10');
                icon.classList.add('text-success');
            } else if (cumplimientoPorcentaje >= 60) {
                // Amarillo para cumplimiento medio (60-79%)
                iconContainer.classList.add('bg-warning', 'bg-opacity-10');
                icon.classList.add('text-warning');
            } else {
                // Rojo para cumplimiento bajo (menos de 60%)
                iconContainer.classList.add('bg-danger', 'bg-opacity-10');
                icon.classList.add('text-danger');
            }
        }

        // Render tarjeta de cumplimiento mensual
        const cumplimientoMesPorcentaje = Number(stats.cumplimiento_mes_porcentaje || 0);
        const cumplimientoMesFraccion = stats.cumplimiento_mes_fraccion || '0/0';
        
        if (cumplimientoMesEl) cumplimientoMesEl.textContent = `${cumplimientoMesPorcentaje}%`;
        if (cumplimientoMesFraccionEl) cumplimientoMesFraccionEl.textContent = cumplimientoMesFraccion;
        
        // Cambiar colores seg√∫n el nivel de cumplimiento mensual
        if (cumplimientoMesIconEl) {
            const iconContainer = cumplimientoMesIconEl;
            const icon = iconContainer.querySelector('i');
            
            // Remover clases anteriores
            iconContainer.className = 'icon-container p-3 rounded';
            icon.className = 'fas fa-calendar-alt';
            
            if (cumplimientoMesPorcentaje >= 80) {
                // Verde para buen cumplimiento (80% o m√°s)
                iconContainer.classList.add('bg-success', 'bg-opacity-10');
                icon.classList.add('text-success');
            } else if (cumplimientoMesPorcentaje >= 60) {
                // Amarillo para cumplimiento medio (60-79%)
                iconContainer.classList.add('bg-warning', 'bg-opacity-10');
                icon.classList.add('text-warning');
            } else {
                // Rojo para cumplimiento bajo (menos de 60%)
                iconContainer.classList.add('bg-danger', 'bg-opacity-10');
                icon.classList.add('text-danger');
            }
        }
    }

    function renderTabla(data) {
        console.log('üîç DEBUG: renderTabla llamada', {
            data: data,
            registros_length: (data && data.registros) ? data.registros.length : 0,
            tbody_children_before: tbody.children.length
        });
        
        // Limpiar tabla de forma m√°s agresiva
        console.log('üßπ DEBUG: Limpiando tabla - antes:', tbody.children.length);
        
        // M√©todo 1: innerHTML
        tbody.innerHTML = '';
        
        // M√©todo 2: removeChild para asegurar limpieza completa
        while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
        }
        
        // M√©todo 3: Forzar re-render
        tbody.style.display = 'none';
        tbody.offsetHeight; // Trigger reflow
        tbody.style.display = '';
        
        console.log('üßπ DEBUG: Tabla limpiada - despu√©s:', tbody.children.length);
        
        let registros = (data && data.success) ? (data.registros || []) : [];
        console.log('üìä DEBUG: Registros recibidos:', registros.length);
        
        // DEDUPLICACI√ìN: Eliminar duplicados por c√©dula como medida de seguridad
        const registrosUnicos = [];
        const cedulasVistas = new Set();
        
        registros.forEach(registro => {
            if (!cedulasVistas.has(registro.cedula)) {
                cedulasVistas.add(registro.cedula);
                registrosUnicos.push(registro);
            } else {
                console.warn('‚ö†Ô∏è DEBUG: Duplicado eliminado:', registro.cedula, registro.tecnico);
            }
        });
        
        registros = registrosUnicos;
        console.log('üìä DEBUG: Registros despu√©s de deduplicaci√≥n:', registros.length);
        
        if (!registros.length) {
            mensajeSinRegistros.style.display = 'block';
            console.log('‚ö†Ô∏è DEBUG: No hay registros, mostrando mensaje');
            return;
        }
        mensajeSinRegistros.style.display = 'none';

        // Verificar duplicados en los datos recibidos
        const cedulas = registros.map(r => r.cedula);
        const cedulasUnicas = [...new Set(cedulas)];
        if (cedulas.length !== cedulasUnicas.length) {
            console.error('üî¥ DEBUG: DUPLICADOS DETECTADOS EN DATOS DEL BACKEND!', {
                total_registros: cedulas.length,
                cedulas_unicas: cedulasUnicas.length,
                duplicados: cedulas.filter((cedula, index) => cedulas.indexOf(cedula) !== index)
            });
        } else {
            console.log('‚úÖ DEBUG: No hay duplicados en los datos del backend');
        }

        registros.forEach((r, index) => {
            console.log(`üìù DEBUG: Procesando registro ${index + 1}:`, {
                cedula: r.cedula,
                tecnico: r.tecnico
            });
            
            const tr = document.createElement('tr');
            // Agregar ID √∫nico para tracking
            tr.setAttribute('data-cedula', r.cedula);
            tr.setAttribute('data-index', index);
            tr.innerHTML = `
                <td>${safe(r.cedula)}</td>
                <td>${safe(r.tecnico)}</td>
                <td>${safe(r.carpeta)}</td>
                <td>${safe(r.super)}</td>
                <td>${safe(r.carpeta_dia_nombre || r.carpeta_dia)}</td>
                <td>${safe(r.eventos)}</td>
                <td>${formatNumber(r.valor)}</td>
                <td>${safe(r.estado)}</td>
                <td>${safe(r.novedad)}</td>
            `;
            tbody.appendChild(tr);
        });
        
        // Verificaci√≥n final despu√©s de poblar la tabla
        console.log('üîç DEBUG: Verificaci√≥n final de la tabla:', {
            registros_procesados: registros.length,
            filas_en_tabla: tbody.children.length,
            cedulas_en_tabla: Array.from(tbody.children).map(row => row.getAttribute('data-cedula'))
        });
        
        // Verificar duplicados en la tabla final
        const cedulasEnTabla = Array.from(tbody.children).map(row => row.getAttribute('data-cedula'));
        const cedulasUnicasEnTabla = [...new Set(cedulasEnTabla)];
        if (cedulasEnTabla.length !== cedulasUnicasEnTabla.length) {
            console.error('üî¥ DEBUG: DUPLICADOS DETECTADOS EN LA TABLA FINAL!', {
                total_filas: cedulasEnTabla.length,
                cedulas_unicas: cedulasUnicasEnTabla.length,
                duplicados: cedulasEnTabla.filter((cedula, index) => cedulasEnTabla.indexOf(cedula) !== index)
            });
        } else {
            console.log('‚úÖ DEBUG: No hay duplicados en la tabla final');
        }
        
        console.log('‚úÖ DEBUG: Tabla renderizada, tbody.children.length:', tbody.children.length);
    }

    function safe(val) {
        if (val === null || val === undefined) return '';
        return String(val);
    }

    function formatNumber(n) {
        if (n === null || n === undefined || isNaN(n)) return '';
        try { return Number(n).toLocaleString('es-CO'); } catch { return String(n); }
    }

    // Funci√≥n para registrar event listeners una sola vez
    function registrarEventListeners() {
        if (eventListenersRegistrados) {
            console.warn('‚ö†Ô∏è Event listeners ya est√°n registrados, evitando duplicados');
            return;
        }

        console.log('üéØ Registrando event listeners');
        btnBuscar.addEventListener('click', cargarAsistencia);
        inputFecha.addEventListener('change', cargarAsistencia);
        eventListenersRegistrados = true;
        console.log('‚úÖ Event listeners registrados correctamente');
    }

    // Funci√≥n de inicializaci√≥n
    function inicializar() {
        console.log('üöÄ Inicializando p√°gina de asistencia');
        registrarEventListeners();
        cargarAsistencia();
    }

    // Cargar inicial - verificar si DOM ya est√° listo
    if (document.readyState === 'loading') {
        console.log('‚è≥ DOM a√∫n cargando, esperando DOMContentLoaded');
        document.addEventListener('DOMContentLoaded', inicializar);
    } else {
        console.log('‚úÖ DOM ya est√° listo, inicializando inmediatamente');
        inicializar();
    }
})();
</script>
{% endblock %}