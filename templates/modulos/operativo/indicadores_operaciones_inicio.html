{% extends 'header.html' %}
{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="mb-0"><i class="fas fa-play me-2 text-warning"></i>Inicio de Operación</h2>
        <a href="/operativo/indicadores/operaciones" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Volver a Operaciones
        </a>
    </div>

    <div class="alert alert-info" role="alert">
        Consulta la asistencia del día para tu equipo. Usa el filtro de fecha para ver otro día.
    </div>

    <!-- Filtros -->
    <div class="card mb-3">
        <div class="card-body">
            <form id="formFiltroAsistencia" class="row g-3 align-items-end">
                <div class="col-sm-6 col-md-4">
                    <label for="fechaFiltro" class="form-label"><i class="fas fa-calendar me-1"></i>Fecha</label>
                    <input type="date" class="form-control" id="fechaFiltro" name="fecha">
                </div>
                <div class="col-sm-6 col-md-4">
                    <label class="form-label d-block">&nbsp;</label>
                    <button type="button" id="btnBuscar" class="btn btn-warning">
                        <i class="fas fa-search me-1"></i>Buscar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tarjetas de estadísticas -->
    <div class="row mb-3">
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Total Técnicos</h6>
                            <h3 id="totalTecnicosVal" class="mb-0">0</h3>
                        </div>
                        <div class="icon-container bg-warning bg-opacity-10 p-3 rounded">
                            <i class="fas fa-users text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Con Asistencia</h6>
                            <h3 id="conAsistenciaVal" class="mb-0">0</h3>
                        </div>
                        <div class="icon-container bg-success bg-opacity-10 p-3 rounded">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="w-100">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="text-muted mb-1">Sin Asistencia</h6>
                                    <h3 id="sinAsistenciaVal" class="mb-0">0</h3>
                                </div>
                                <div class="icon-container bg-danger bg-opacity-10 p-3 rounded">
                                    <i class="fas fa-times-circle text-danger"></i>
                                </div>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">Detalle por tipificación:</small>
                                <ul id="detalleSinList" class="list-unstyled mb-0" style="max-height: 160px; overflow:auto"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas adicionales -->
    <div class="row mb-3">
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Ok's Día</h6>
                            <h3 id="oksDiaVal" class="mb-0">0</h3>
                        </div>
                        <div class="icon-container bg-info bg-opacity-10 p-3 rounded">
                            <i class="fas fa-check text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Presupuesto Día</h6>
                            <h3 id="presupuestoDiaVal" class="mb-0">$0</h3>
                        </div>
                        <div class="icon-container bg-primary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-wallet text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="text-muted mb-1">Presupuesto Mes</h6>
                            <h3 id="presupuestoMesVal" class="mb-0">$0</h3>
                        </div>
                        <div class="icon-container bg-secondary bg-opacity-10 p-3 rounded">
                            <i class="fas fa-calendar-alt text-secondary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabla de asistencia -->
    <div class="card">
        <div class="card-header bg-warning bg-opacity-10">
            <h5 class="mb-0"><i class="fas fa-clipboard-check me-2 text-warning"></i>Asistencia del Día</h5>
        </div>
        <div class="card-body px-0 pt-0">
            <div id="mensajeSinRegistros" class="alert alert-secondary mx-3 my-3" style="display:none;">
                <i class="fas fa-info-circle me-2"></i>No hay registros de asistencia para la fecha seleccionada.
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0" id="tablaAsistencia">
                    <thead class="table-dark">
                        <tr>
                            <th style="min-width:110px">Cédula</th>
                            <th style="min-width:160px">Técnico</th>
                            <th style="min-width:140px">Carpeta</th>
                            <th style="min-width:140px">Super</th>
                            <th style="min-width:120px">Carpeta_Día</th>
                            <th style="min-width:160px">Ok's</th>
                            <th style="min-width:100px">Valor</th>
                            <th style="min-width:120px">Estado</th>
                            <th style="min-width:180px">Novedad</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas se renderizan con JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const inputFecha = document.getElementById('fechaFiltro');
    const btnBuscar = document.getElementById('btnBuscar');
    const tbody = document.querySelector('#tablaAsistencia tbody');
    const mensajeSinRegistros = document.getElementById('mensajeSinRegistros');

    // Inicializa fecha con hoy (Bogotá)
    const hoy = new Date();
    const tzOffset = hoy.getTimezoneOffset() * 60000;
    const localISODate = new Date(hoy - tzOffset).toISOString().slice(0,10);
    inputFecha.value = localISODate;

    async function cargarAsistencia() {
        const fecha = inputFecha.value;
        const url = `/api/operativo/inicio-operacion/asistencia?fecha=${encodeURIComponent(fecha)}`;
        try {
            const resp = await fetch(url, { credentials: 'include' });
            const data = await resp.json();
            renderTarjetas(data?.stats);
            renderTabla(data);
        } catch (err) {
            console.error('Error cargando asistencia:', err);
        }
    }

    function renderTarjetas(stats) {
        const totalEl = document.getElementById('totalTecnicosVal');
        const conEl = document.getElementById('conAsistenciaVal');
        const sinEl = document.getElementById('sinAsistenciaVal');
        const detalleList = document.getElementById('detalleSinList');
        // Nuevas tarjetas
        const oksDiaEl = document.getElementById('oksDiaVal');
        const presupuestoDiaEl = document.getElementById('presupuestoDiaVal');
        const presupuestoMesEl = document.getElementById('presupuestoMesVal');

        if (!stats) {
            totalEl.textContent = '0';
            conEl.textContent = '0';
            sinEl.textContent = '0';
            detalleList.innerHTML = '';
            if (oksDiaEl) oksDiaEl.textContent = '0';
            if (presupuestoDiaEl) presupuestoDiaEl.textContent = '$0';
            if (presupuestoMesEl) presupuestoMesEl.textContent = '$0';
            return;
        }
        totalEl.textContent = Number(stats.total_tecnicos || 0).toLocaleString('es-CO');
        conEl.textContent = Number(stats.con_asistencia || 0).toLocaleString('es-CO');
        sinEl.textContent = Number((stats.sin_asistencia && stats.sin_asistencia.total) || stats.sin_asistencia || 0).toLocaleString('es-CO');

        // Render detalle sin asistencia
        detalleList.innerHTML = '';
        const detalle = stats.sin_asistencia_detalle || (stats.sin_asistencia && stats.sin_asistencia.detalle) || [];
        detalle.forEach(item => {
            const li = document.createElement('li');
            li.className = 'd-flex justify-content-between';
            li.innerHTML = `<span class="text-muted">${safe(item.nombre)}</span><span>${Number(item.cantidad || 0).toLocaleString('es-CO')}</span>`;
            detalleList.appendChild(li);
        });

        // Render nuevas tarjetas
        const oksDia = Number(stats.oks_dia || 0);
        const presupuestoDia = Number(stats.presupuesto_dia || 0);
        const presupuestoMes = Number(stats.presupuesto_mes || (presupuestoDia * 26));
        if (oksDiaEl) oksDiaEl.textContent = oksDia.toLocaleString('es-CO');
        if (presupuestoDiaEl) presupuestoDiaEl.textContent = `$${presupuestoDia.toLocaleString('es-CO')}`;
        if (presupuestoMesEl) presupuestoMesEl.textContent = `$${presupuestoMes.toLocaleString('es-CO')}`;
    }

    function renderTabla(data) {
        tbody.innerHTML = '';
        const registros = (data && data.success) ? (data.registros || []) : [];
        if (!registros.length) {
            mensajeSinRegistros.style.display = 'block';
            return;
        }
        mensajeSinRegistros.style.display = 'none';

        registros.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${safe(r.cedula)}</td>
                <td>${safe(r.tecnico)}</td>
                <td>${safe(r.carpeta)}</td>
                <td>${safe(r.super)}</td>
                <td>${safe(r.carpeta_dia_nombre || r.carpeta_dia)}</td>
                <td>${safe(r.eventos)}</td>
                <td>${formatNumber(r.valor)}</td>
                <td>${safe(r.estado)}</td>
                <td>${safe(r.novedad)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function safe(val) {
        if (val === null || val === undefined) return '';
        return String(val);
    }

    function formatNumber(n) {
        if (n === null || n === undefined || isNaN(n)) return '';
        try { return Number(n).toLocaleString('es-CO'); } catch { return String(n); }
    }

    // Eventos
    btnBuscar.addEventListener('click', cargarAsistencia);
    inputFecha.addEventListener('change', cargarAsistencia);

    // Cargar inicial
    document.addEventListener('DOMContentLoaded', cargarAsistencia);
})();
</script>
{% endblock %}