{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;">
                    <h3 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Gestión de SOAT - MPA
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Gestiona todos los seguros obligatorios de accidentes de tránsito (SOAT) de los vehículos de la flota. Aquí puedes ver, crear, actualizar y eliminar registros de SOAT.
                    </div>
                    
                    <!-- Botón para crear nuevo SOAT -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Lista de SOAT</h4>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#soatModal" onclick="openCreateModal()">
                            <i class="fas fa-plus me-2"></i>Crear SOAT
                        </button>
                    </div>
                    
                    <!-- Tabla de SOAT -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="soatTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Placa</th>
                                    <th>Número de Póliza</th>
                                    <th>Fecha Inicial</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Días Restantes</th>
                                    <th>Estado</th>
                                    <th>Técnico</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="soatTableBody">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mensaje cuando no hay SOAT -->
                    <div id="noSoatMessage" class="text-center py-5" style="display: none;">
                        <i class="fas fa-shield-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay SOAT registrados</h5>
                        <p class="text-muted">Haz clic en "Crear SOAT" para agregar el primer registro.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar SOAT -->
<div class="modal fade" id="soatModal" tabindex="-1" aria-labelledby="soatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="soatModalLabel">Crear SOAT</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="soatForm">
                    <input type="hidden" id="soatId" name="soatId">
                    
                    <div class="row">
                        <!-- Información del Vehículo -->
                        <div class="col-md-6 mb-3">
                            <label for="placa" class="form-label">Placa del Vehículo <span class="text-danger">*</span></label>
                            <select class="form-select" id="placa" name="placa" required onchange="onPlacaChange()">
                                <option value="">Seleccionar placa</option>
                                <!-- Las placas se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tecnicoAsignado" class="form-label">Técnico Asignado</label>
                            <input type="text" class="form-control" id="tecnicoAsignado" name="tecnicoAsignado" readonly>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipoVehiculo" class="form-label">Tipo de Vehículo</label>
                            <input type="text" class="form-control" id="tipoVehiculo" name="tipoVehiculo" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="numeroPoliza" class="form-label">Número de Póliza <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="numeroPoliza" name="numeroPoliza" required placeholder="Ej: 123456789">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="aseguradora" class="form-label">Aseguradora <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="aseguradora" name="aseguradora" required placeholder="Ej: SURA, Bolivar, etc.">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="valorPrima" class="form-label">Valor Prima <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="valorPrima" name="valorPrima" required step="0.01" min="0" placeholder="Ej: 150000">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaInicial" class="form-label">Fecha Inicial <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fechaInicial" name="fechaInicial" required onchange="calculateDaysRemaining()">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fechaVencimiento" name="fechaVencimiento" required onchange="calculateDaysRemaining()">
                        </div>
                    </div>
                    
                    <!-- Información de días restantes -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div id="diasRestantesInfo" class="alert" style="display: none;">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <span id="diasRestantesText"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información automática -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Nota:</strong> El técnico se asignará automáticamente según el vehículo seleccionado. La fecha de registro se guardará automáticamente.
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveSoat()">
                    <i class="fas fa-save me-2"></i>Guardar SOAT
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del SOAT -->
<div class="modal fade" id="viewSoatModal" tabindex="-1" aria-labelledby="viewSoatModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewSoatModalLabel">Detalles del SOAT</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewSoatContent">
                <!-- El contenido se cargará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentSoatId = null;
let vehiclePlates = [];

// Cargar datos al inicializar la página
document.addEventListener('DOMContentLoaded', function() {
    loadSoats();
    loadVehiclePlates();
    
    // Limpiar estado cuando se cierra el modal de SOAT
    const soatModal = document.getElementById('soatModal');
    if (soatModal) {
        soatModal.addEventListener('hidden.bs.modal', function() {
            currentSoatId = null;
            
            // Validar elementos antes de manipularlos
            const form = document.getElementById('soatForm');
            const soatId = document.getElementById('soatId');
            const diasRestantesInfo = document.getElementById('diasRestantesInfo');
            
            if (form) form.reset();
            if (soatId) soatId.value = '';
            if (diasRestantesInfo) diasRestantesInfo.style.display = 'none';
        });
    }
});

// Cargar lista de SOAT
function loadSoats() {
    fetch('/api/mpa/soat')
        .then(response => {
            if (response.status === 401) {
                showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }
            if (response.status === 403) {
                showAlert('No tienes permisos para acceder a esta información.', 'danger');
                return;
            }
            if (response.status === 302 || response.redirected) {
                showAlert('Sesión expirada. Redirigiendo al login...', 'warning');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return;
            }
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                displaySoats(data.data);
            } else if (data) {
                showAlert('Error al cargar SOAT: ' + (data.message || data.error || 'Error desconocido'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                showAlert('Error de conexión. Verifica tu conexión a internet.', 'danger');
            } else {
                showAlert('Error al cargar datos del SOAT: ' + error.message, 'danger');
            }
        });
}

// Mostrar SOAT en la tabla
function displaySoats(soats) {
    const tbody = document.getElementById('soatTableBody');
    const noSoatMessage = document.getElementById('noSoatMessage');
    const table = document.getElementById('soatTable');
    
    if (soats.length === 0) {
        table.style.display = 'none';
        noSoatMessage.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    noSoatMessage.style.display = 'none';
    
    tbody.innerHTML = soats.map(soat => {
        const estadoBadge = getEstadoBadge(soat.estado, soat.dias_vencimiento);
        const diasText = getDiasRestantesText(soat.dias_vencimiento);
        
        return `
        <tr class="${getRowClass(soat.estado, soat.dias_vencimiento)}">
            <td><strong>${soat.placa}</strong></td>
            <td>${soat.numero_poliza}</td>
            <td>${formatDate(soat.fecha_inicio)}</td>
            <td>${formatDate(soat.fecha_vencimiento)}</td>
            <td>${diasText}</td>
            <td>${estadoBadge}</td>
            <td>${soat.tecnico_nombre || 'Sin asignar'}</td>
            <td>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-info" onclick="viewSoat(${soat.id_mpa_soat})" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="editSoat(${soat.id_mpa_soat})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteSoat(${soat.id_mpa_soat}, '${soat.placa}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
}

// Obtener badge de estado
function getEstadoBadge(estado, diasRestantes) {
    // Si diasRestantes es undefined, null o no es un número, usar el estado original si existe
    if (diasRestantes === undefined || diasRestantes === null || isNaN(diasRestantes)) {
        switch(estado) {
            case 'vencido':
                return '<span class="badge bg-danger">Vencido</span>';
            case 'proximo_vencer':
                return '<span class="badge bg-warning text-dark">Próximo a vencer</span>';
            case 'vigente':
                return '<span class="badge bg-success">Vigente</span>';
            default:
                return '<span class="badge bg-secondary">Calculando...</span>';
        }
    }
    
    // Calcular estado basado en días restantes
    if (diasRestantes < 0) {
        return '<span class="badge bg-danger">Vencido</span>';
    } else if (diasRestantes <= 30) {
        return '<span class="badge bg-warning text-dark">Próximo a vencer</span>';
    } else {
        return '<span class="badge bg-success">Vigente</span>';
    }
}

// Obtener clase de fila según estado
function getRowClass(estado, diasRestantes) {
    // Si diasRestantes es válido, usar esa lógica
    if (diasRestantes !== undefined && diasRestantes !== null && !isNaN(diasRestantes)) {
        if (diasRestantes < 0) {
            return 'table-danger';
        } else if (diasRestantes <= 30) {
            return 'table-warning';
        } else {
            return '';
        }
    }
    
    // Fallback al estado original
    switch(estado) {
        case 'vencido':
            return 'table-danger';
        case 'proximo_vencer':
            return 'table-warning';
        default:
            return '';
    }
}

// Obtener texto de días restantes
function getDiasRestantesText(diasRestantes) {
    // Verificar si el valor es undefined, null o no es un número
    if (diasRestantes === undefined || diasRestantes === null || isNaN(diasRestantes)) {
        return '<span class="text-muted">Calculando...</span>';
    }
    
    if (diasRestantes < 0) {
        return `<span class="text-danger fw-bold">${Math.abs(diasRestantes)} días vencido</span>`;
    } else if (diasRestantes === 0) {
        return '<span class="text-warning fw-bold">Vence hoy</span>';
    } else {
        return `<span class="text-success">${diasRestantes} días</span>`;
    }
}

// Cargar lista de placas de vehículos
function loadVehiclePlates() {
    fetch('/api/mpa/vehiculos/placas')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                vehiclePlates = data.data;
                const select = document.getElementById('placa');
                select.innerHTML = '<option value="">Seleccionar placa</option>' +
                    vehiclePlates.map(vehicle => `<option value="${vehicle.placa}" data-tecnico="${vehicle.tecnico_nombre || 'Sin asignar'}" data-tipo="${vehicle.tipo_vehiculo}">${vehicle.placa}</option>`).join('');
            } else {
                showAlert('Error al cargar placas: ' + (data.message || 'Error desconocido'), 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar placas: ' + error.message, 'warning');
        });
}

// Evento cuando cambia la placa seleccionada
function onPlacaChange() {
    const placaSelect = document.getElementById('placa');
    const selectedOption = placaSelect.options[placaSelect.selectedIndex];
    
    if (selectedOption.value) {
        const tecnico = selectedOption.getAttribute('data-tecnico');
        const tipoVehiculo = selectedOption.getAttribute('data-tipo');
        
        document.getElementById('tecnicoAsignado').value = tecnico;
        document.getElementById('tipoVehiculo').value = tipoVehiculo;
    } else {
        document.getElementById('tecnicoAsignado').value = '';
        document.getElementById('tipoVehiculo').value = '';
    }
}

// Calcular días restantes
function calculateDaysRemaining() {
    const fechaInicialElement = document.getElementById('fechaInicial');
    const fechaVencimientoElement = document.getElementById('fechaVencimiento');
    const infoDiv = document.getElementById('diasRestantesInfo');
    const textSpan = document.getElementById('diasRestantesText');
    
    // Validar que todos los elementos existan
    if (!fechaInicialElement || !fechaVencimientoElement || !infoDiv || !textSpan) {
        console.warn('Elementos requeridos para calculateDaysRemaining no encontrados');
        return;
    }
    
    const fechaInicial = fechaInicialElement.value;
    const fechaVencimiento = fechaVencimientoElement.value;
    
    if (fechaInicial && fechaVencimiento) {
        const inicial = new Date(fechaInicial);
        const vencimiento = new Date(fechaVencimiento);
        const hoy = new Date();
        
        // Validar que la fecha de vencimiento sea posterior a la inicial
        if (vencimiento <= inicial) {
            infoDiv.className = 'alert alert-danger';
            textSpan.textContent = 'La fecha de vencimiento debe ser posterior a la fecha inicial';
            infoDiv.style.display = 'block';
            return;
        }
        
        // Calcular días restantes
        const diffTime = vencimiento.getTime() - hoy.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 0) {
            infoDiv.className = 'alert alert-danger';
            textSpan.textContent = `SOAT vencido hace ${Math.abs(diffDays)} días`;
        } else if (diffDays <= 30) {
            infoDiv.className = 'alert alert-warning';
            textSpan.textContent = `SOAT próximo a vencer en ${diffDays} días`;
        } else {
            infoDiv.className = 'alert alert-success';
            textSpan.textContent = `SOAT vigente por ${diffDays} días más`;
        }
        
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

// Abrir modal para crear SOAT
function openCreateModal() {
    currentSoatId = null;
    
    // Validar elementos antes de manipularlos
    const modalLabel = document.getElementById('soatModalLabel');
    const form = document.getElementById('soatForm');
    const soatId = document.getElementById('soatId');
    const tecnicoAsignado = document.getElementById('tecnicoAsignado');
    const tipoVehiculo = document.getElementById('tipoVehiculo');
    const diasRestantesInfo = document.getElementById('diasRestantesInfo');
    
    if (modalLabel) modalLabel.textContent = 'Crear SOAT';
    if (form) form.reset();
    if (soatId) soatId.value = '';
    
    // Limpiar campos auto-poblados
    if (tecnicoAsignado) tecnicoAsignado.value = '';
    if (tipoVehiculo) tipoVehiculo.value = '';
    if (diasRestantesInfo) diasRestantesInfo.style.display = 'none';
}

// Ver detalles del SOAT
function viewSoat(soatId) {
    fetch(`/api/mpa/soat/${soatId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const soat = data.data;
                const estadoBadge = getEstadoBadge(soat.estado, soat.dias_vencimiento);
                const diasText = getDiasRestantesText(soat.dias_vencimiento);
                
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Información del Vehículo</h6>
                            <p><strong>Placa:</strong> ${soat.placa}</p>
                            <p><strong>Tipo de Vehículo:</strong> ${soat.tipo_vehiculo || 'No especificado'}</p>
                            <p><strong>Técnico Asignado:</strong> ${soat.tecnico_nombre || 'Sin asignar'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Información del SOAT</h6>
                            <p><strong>Número de Póliza:</strong> ${soat.numero_poliza}</p>
                            <p><strong>Aseguradora:</strong> ${soat.aseguradora || 'No especificada'}</p>
                            <p><strong>Fecha Inicial:</strong> ${formatDate(soat.fecha_inicio)}</p>
                            <p><strong>Fecha de Vencimiento:</strong> ${formatDate(soat.fecha_vencimiento)}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-primary">Estado del SOAT</h6>
                            <p><strong>Estado:</strong> ${estadoBadge}</p>
                            <p><strong>Días restantes:</strong> ${diasText}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Información Adicional</h6>
                            <p><strong>Valor Prima:</strong> ${soat.valor_prima ? '$' + parseFloat(soat.valor_prima).toLocaleString('es-CO') : 'No especificado'}</p>
                            <p><strong>Observaciones:</strong> ${soat.observaciones || 'Sin observaciones'}</p>
                        </div>
                    </div>
                `;
                document.getElementById('viewSoatContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('viewSoatModal')).show();
            } else {
                showAlert('Error al cargar detalles del SOAT: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar detalles del SOAT', 'danger');
        });
}

// Editar SOAT
function editSoat(soatId) {
    fetch(`/api/mpa/soat/${soatId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const soat = data.data;
                currentSoatId = soatId;
                
                // Validar elementos antes de manipularlos
                const modalLabel = document.getElementById('soatModalLabel');
                const soatIdField = document.getElementById('soatId');
                const placa = document.getElementById('placa');
                const tecnicoAsignado = document.getElementById('tecnicoAsignado');
                const tipoVehiculo = document.getElementById('tipoVehiculo');
                const numeroPoliza = document.getElementById('numeroPoliza');
                const aseguradora = document.getElementById('aseguradora');
                const valorPrima = document.getElementById('valorPrima');
                const fechaInicial = document.getElementById('fechaInicial');
                const fechaVencimiento = document.getElementById('fechaVencimiento');
                const soatModal = document.getElementById('soatModal');
                
                if (modalLabel) modalLabel.textContent = 'Editar SOAT';
                if (soatIdField) soatIdField.value = soatId;
                if (placa) placa.value = soat.placa;
                if (tecnicoAsignado) tecnicoAsignado.value = soat.tecnico_asignado || 'Sin asignar';
                if (tipoVehiculo) tipoVehiculo.value = soat.tipo_vehiculo || '';
                if (numeroPoliza) numeroPoliza.value = soat.numero_poliza;
                if (aseguradora) aseguradora.value = soat.aseguradora || '';
                if (valorPrima) valorPrima.value = soat.valor_prima || '';
                if (fechaInicial) fechaInicial.value = soat.fecha_inicio;
                if (fechaVencimiento) fechaVencimiento.value = soat.fecha_vencimiento;
                
                // Calcular días restantes
                calculateDaysRemaining();
                
                if (soatModal) {
                    new bootstrap.Modal(soatModal).show();
                }
            } else {
                showAlert('Error al cargar datos del SOAT: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar datos del SOAT', 'danger');
        });
}

// Guardar SOAT (crear o actualizar)
async function saveSoat() {
    const form = document.getElementById('soatForm');
    
    // Validar campos requeridos
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    // Validar fechas
    const fechaInicial = new Date(document.getElementById('fechaInicial').value);
    const fechaVencimiento = new Date(document.getElementById('fechaVencimiento').value);
    
    if (fechaVencimiento <= fechaInicial) {
        showAlert('La fecha de vencimiento debe ser posterior a la fecha inicial', 'danger');
        return;
    }
    
    try {
        // Preparar datos del SOAT
        const soatData = {
            placa: document.getElementById('placa').value,
            numero_poliza: document.getElementById('numeroPoliza').value,
            aseguradora: document.getElementById('aseguradora').value,
            fecha_inicio: document.getElementById('fechaInicial').value,
            fecha_vencimiento: document.getElementById('fechaVencimiento').value,
            valor_prima: parseFloat(document.getElementById('valorPrima').value),
            tecnico_asignado: document.getElementById('tecnicoAsignado').value
        };
        
        const url = currentSoatId ? `/api/mpa/soat/${currentSoatId}` : '/api/mpa/soat';
        const method = currentSoatId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(soatData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(currentSoatId ? 'SOAT actualizado exitosamente' : 'SOAT creado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('soatModal')).hide();
            loadSoats();
        } else {
            showAlert('Error: ' + (data.message || 'Error desconocido'), 'danger');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error al guardar el SOAT', 'danger');
    }
}

// Eliminar SOAT
function deleteSoat(soatId, placa) {
    if (confirm(`¿Está seguro de que desea eliminar el SOAT del vehículo ${placa}?`)) {
        fetch(`/api/mpa/soat/${soatId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('SOAT eliminado exitosamente', 'success');
                loadSoats();
            } else {
                showAlert('Error al eliminar SOAT: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al eliminar SOAT', 'danger');
        });
    }
}

// Formatear fecha
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('es-CO', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
    });
}

// Mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}