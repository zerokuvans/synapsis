{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #343a40 0%, #212529 100%) !important;">
          <h3 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Inspecciones Vehiculares - MPA</h3>
        </div>
        <div class="card-body">
          <div class="mb-3 d-flex flex-wrap gap-2 align-items-end">
            <div class="me-2" style="min-width:220px;">
              <label for="filtroPlaca" class="form-label">Placa</label>
              <input id="filtroPlaca" type="text" class="form-control" placeholder="Ej. ABC123">
            </div>
            <div class="me-2" style="min-width:260px;">
              <label for="filtroTecn  ico" class="form-label">Técnico</label>
              <select id="filtroTecnico" class="form-select">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="ms-auto d-flex gap-2">
              <button id="btnBuscar" class="btn btn-outline-dark"><i class="fas fa-search me-1"></i>Aplicar filtros</button>
              <button id="btnNuevaInspeccion" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#modalInspeccion"><i class="fas fa-plus me-1"></i>Nueva inspección</button>
            </div>
          </div>

          <div class="row">
            <div class="col-12 mb-3">
              <div class="card sticky-top" style="top: 8px; z-index: 10;">
                <div class="card-header d-flex align-items-center justify-content-between">
                  <div><i class="fas fa-user-clock me-1"></i>Pendientes este mes</div>
                  <div class="d-flex align-items-center gap-2">
                    <span id="pendientesCountBadge" class="badge bg-dark">0 pendientes</span>
                    <button id="btnRefreshPendientes" type="button" class="btn btn-outline-dark btn-sm"><i class="fas fa-sync me-1"></i>Actualizar</button>
                  </div>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm" id="tablaPendientes">
                      <thead>
                        <tr>
                          <th>Placa</th>
                          <th>Técnico</th>
                          <th class="text-end">Acción</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>
                  <div id="pendientesEmpty" class="text-muted small" style="display:none;">Sin pendientes</div>
                </div>
              </div>
            </div>
            <div class="col-12">
              <div class="table-responsive">
                <table class="table table-hover align-middle" id="tablaInspecciones">
                  <thead class="table-dark">
                    <tr>
                      <th>Fecha</th>
                      <th>Técnico</th>
                      <th>Placa</th>
                      <th>Hallazgos</th>
                      <th>Plazo Subsanación</th>
                      <th>Observaciones</th>
                      <th>Firmas</th>
                      <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
              <div id="emptyState" class="text-center text-muted py-4" style="display:none;">Sin inspecciones registradas</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalInspeccion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Nueva inspección</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="formInspeccion">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">Técnico</label>
              <select id="insTecnico" class="form-select" required></select>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Placa</label>
              <input id="insPlaca" type="text" class="form-control" placeholder="Ej. ABC123">
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Observaciones</label>
              <input id="insObservaciones" type="text" class="form-control">
            </div>
          </div>

          <div class="row">
            <div class="col-12 mb-3">
              <div class="card">
                <div class="card-header"><i class="fas fa-car-side me-1"></i>Detalles del vehículo</div>
                <div class="card-body">
                  <div class="row" id="vehiculoDetalles">
                    <div class="col-sm-6 col-lg-3 mb-2"><div class="small text-muted">Marca</div><div class="fw-semibold" id="detMarca">-</div></div>
                    <div class="col-sm-6 col-lg-3 mb-2"><div class="small text-muted">Línea</div><div class="fw-semibold" id="detLinea">-</div></div>
                    <div class="col-sm-6 col-lg-2 mb-2"><div class="small text-muted">Modelo</div><div class="fw-semibold" id="detModelo">-</div></div>
                    <div class="col-sm-6 col-lg-2 mb-2"><div class="small text-muted">Color</div><div class="fw-semibold" id="detColor">-</div></div>
                    <div class="col-sm-6 col-lg-2 mb-2"><div class="small text-muted">Cilindraje</div><div class="fw-semibold" id="detCilindraje">-</div></div>
                  </div>
                  <div class="row" id="vencimientosDetalles">
                    <div class="col-sm-6 col-lg-4 mb-2"><div class="small text-muted">Venc. Licencia</div><div class="fw-semibold" id="detVLicencia">-</div></div>
                    <div class="col-sm-6 col-lg-4 mb-2"><div class="small text-muted">Venc. SOAT</div><div class="fw-semibold" id="detVSoat">-</div></div>
                    <div class="col-sm-6 col-lg-4 mb-2"><div class="small text-muted">Venc. Tecnicomecánica</div><div class="fw-semibold" id="detVTm">-</div></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header"><i class="fas fa-tools me-1"></i>Revisión</div>
                <div class="card-body">
                  <div class="row" id="bmFieldsContainer"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header"><i class="fas fa-camera me-1"></i>Evidencias (3 fotos)</div>
                <div class="card-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Foto 1</label>
                      <input id="insFoto1" type="file" accept="image/*" class="form-control">
                      <img id="insPrev1" alt="Preview 1" style="width:100%; max-height:180px; margin-top:8px; display:none; border:1px solid #eee; border-radius:6px;" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Foto 2</label>
                      <input id="insFoto2" type="file" accept="image/*" class="form-control">
                      <img id="insPrev2" alt="Preview 2" style="width:100%; max-height:180px; margin-top:8px; display:none; border:1px solid #eee; border-radius:6px;" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Foto 3</label>
                      <input id="insFoto3" type="file" accept="image/*" class="form-control">
                      <img id="insPrev3" alt="Preview 3" style="width:100%; max-height:180px; margin-top:8px; display:none; border:1px solid #eee; border-radius:6px;" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button id="btnGuardarInspeccion" type="button" class="btn btn-dark"><i class="fas fa-save me-1"></i>Guardar</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalVerInspeccion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Detalle de inspección</h5>
        <div class="ms-auto d-flex align-items-center gap-2">
          <button id="btnExportPdf" type="button" class="btn btn-outline-dark btn-sm"><i class="fas fa-file-pdf me-1"></i>Exportar PDF</button>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row mb-3">
          <div class="col-md-4"><div class="small text-muted">Fecha</div><div class="fw-semibold" id="verDetFecha">-</div></div>
          <div class="col-md-4"><div class="small text-muted">Técnico</div><div class="fw-semibold" id="verDetTecnico">-</div></div>
          <div class="col-md-4"><div class="small text-muted">Placa</div><div class="fw-semibold" id="verDetPlaca">-</div></div>
        </div>
        <div class="row mb-3">
          <div class="col-12"><div class="small text-muted">Observaciones</div><div class="fw-semibold" id="verDetObservaciones">-</div></div>
        </div>
        <div class="row mb-3">
          <div class="col-md-4"><div class="small text-muted">Venc. Licencia</div><div class="fw-semibold" id="verDetVLicencia">-</div></div>
          <div class="col-md-4"><div class="small text-muted">Venc. SOAT</div><div class="fw-semibold" id="verDetVSoat">-</div></div>
          <div class="col-md-4"><div class="small text-muted">Venc. Tecnicomecánica</div><div class="fw-semibold" id="verDetVTm">-</div></div>
        </div>
        <div class="row">
          <div class="col-12">
            <div class="fw-semibold mb-2">Revisión detallada</div>
            <div id="verBMContainer"></div>
          </div>
        </div>
        <div class="row mb-3 mt-3">
          <div class="col-12"><div class="small text-muted">Evidencias</div></div>
          <div class="col-md-4">
            <img id="verFoto1" alt="Foto 1" style="width:100%; max-height:220px; display:none; border:1px solid #eee; border-radius:6px; cursor: zoom-in;" />
          </div>
          <div class="col-md-4">
            <img id="verFoto2" alt="Foto 2" style="width:100%; max-height:220px; display:none; border:1px solid #eee; border-radius:6px; cursor: zoom-in;" />
          </div>
          <div class="col-md-4">
            <img id="verFoto3" alt="Foto 3" style="width:100%; max-height:220px; display:none; border:1px solid #eee; border-radius:6px; cursor: zoom-in;" />
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-md-6">
            <div class="small text-muted mb-2">Firma trabajador</div>
            <img id="verImgFirmaTrabajador" alt="Firma trabajador" style="max-width:100%; max-height:200px; display:none; border:1px solid #eee; border-radius:6px;" />
          </div>
          <div class="col-md-6">
            <div class="small text-muted mb-2">Firma inspector</div>
            <img id="verImgFirmaInspector" alt="Firma inspector" style="max-width:100%; max-height:200px; display:none; border:1px solid #eee; border-radius:6px;" />
          </div>
        </div>
      </div>
    </div>
  </div>
 </div>

<div class="modal fade" id="modalFirma" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-pen-nib me-2"></i>Firma</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <canvas id="firmaCanvas" width="800" height="300" style="border:1px solid #ddd; border-radius:6px; cursor:crosshair; width:100%; height:300px"></canvas>
      </div>
      <div class="modal-footer">
        <button id="btnLimpiarFirma" type="button" class="btn btn-outline-secondary">Limpiar</button>
        <button id="btnGuardarFirma" type="button" class="btn btn-dark">Guardar firma</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalZoomImagen" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-search-plus me-2"></i>Zoom evidencia</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="zoomContainer" style="overflow:auto; max-height:70vh; display:flex; align-items:center; justify-content:center;">
        <img id="zoomImg" alt="Evidencia" style="max-width:100%; max-height:70vh; width:auto; height:auto; object-fit:contain; transform-origin: center center; transform: scale(1); display:block;" />
      </div>
      <div class="modal-footer">
        <div class="btn-group me-auto" role="group">
          <button id="zoomMenos" type="button" class="btn btn-outline-secondary"><i class="fas fa-minus"></i></button>
          <button id="zoomReset" type="button" class="btn btn-outline-secondary"><i class="fas fa-sync"></i></button>
          <button id="zoomMas" type="button" class="btn btn-outline-secondary"><i class="fas fa-plus"></i></button>
        </div>
        <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
 </div>

<script>
let tecnicos = []
let inspecciones = []
let firmaTarget = { id: null, tipo: null }
let fotosBase64 = { foto1: null, foto2: null, foto3: null }
let pendientes = []
let pendientesEndpointAvailable = null
const pendLSKey = 'mpaPendEndpoint'

function readPendFlag(){
  try{
    const raw = localStorage.getItem(pendLSKey)
    if (!raw) return null
    const obj = JSON.parse(raw)
    if (!obj || typeof obj !== 'object') return null
    const ttlMs = 24*60*60*1000
    if (!obj.ts || (Date.now() - obj.ts) > ttlMs) return null
    return !!obj.ok
  }catch(e){ return null }
}

function writePendFlag(ok){
  try{
    localStorage.setItem(pendLSKey, JSON.stringify({ ok: !!ok, ts: Date.now() }))
  }catch(e){}
}

const bmGroups = {
  'Estado físico': [
    ['estado_fisico_espejos_laterales','Espejos laterales'],
    ['estado_fisico_pito','Pito'],
    ['estado_fisico_freno_servicio','Freno servicio'],
    ['estado_fisico_manillares','Manillares'],
    ['estado_fisico_guayas','Guayas'],
    ['estado_fisico_tanque_combustible','Tanque de combustible'],
    ['estado_fisico_encendido','Encendido'],
    ['estado_fisico_pedales','Pedales'],
    ['estado_fisico_guardabarros','Guardabarros'],
    ['estado_fisico_sillin_tapiceria','Sillín/Tapicería'],
    ['estado_fisico_tablero','Tablero'],
    ['estado_fisico_mofle_silenciador','Mofle/Silenciador'],
    ['estado_fisico_kit_arrastre','Kit de arrastre'],
    ['estado_fisico_reposa_pies','Reposa pies'],
    ['estado_fisico_pata_lateral_central','Pata lateral/central'],
    ['estado_fisico_tijera_amortiguador','Tijera/Amortiguador'],
    ['estado_fisico_bateria','Batería']
  ],
  'Luces': [
    ['luces_altas_bajas','Luces altas/bajas'],
    ['luces_direccionales_delanteros','Direccionales delanteros'],
    ['luces_direccionales_traseros','Direccionales traseros'],
    ['luces_luz_placa','Luz placa'],
    ['luces_stop','Stop']
  ],
  'Prevención': [
    ['prevension_casco','Casco'],
    ['prevension_guantes','Guantes'],
    ['prevension_rodilleras','Rodilleras'],
    ['prevension_coderas','Coderas']
  ],
  'Llantas': [
    ['llantas_labrado_llantas','Labrado de llantas'],
    ['llantas_rines','Rines'],
    ['llantas_presion_aire','Presión de aire']
  ],
  'Otros': [
    ['otros_aceite','Aceite'],
    ['otros_suspension_direccion','Suspensión/Dirección'],
    ['otros_caja_cambios','Caja de cambios'],
    ['otros_conexiones_electricas','Conexiones eléctricas']
  ]
}
const bmFieldNames = Object.values(bmGroups).flat().map(([n]) => n)

const bmSynonyms = {
  'prevension_casco': ['prevencion_casco'],
  'prevension_guantes': ['prevencion_guantes'],
  'prevension_rodilleras': ['prevencion_rodilleras'],
  'prevension_coderas': ['prevencion_coderas']
}

function normalizeBM(v){
  const s = String(v || '').trim().toUpperCase()
  if (s === 'BUENO') return 'B'
  if (s === 'MALO') return 'M'
  return s
}

function getBMValue(r, name){
  let v = r[name]
  if (v === undefined){
    const syns = bmSynonyms[name] || []
    for (const alt of syns){
      if (alt in r){ v = r[alt]; break }
    }
  }
  return normalizeBM(v)
}

function optionBM(name, labelText){
  const wrap = document.createElement('div')
  wrap.className = 'col-12 col-md-6 col-lg-4 mb-3'
  const label = document.createElement('div')
  label.className = 'form-label'
  label.textContent = labelText
  const group = document.createElement('div')
  group.className = 'd-flex gap-3 align-items-center'
  group.innerHTML = `
    <div class="form-check form-check-inline">
      <input class="form-check-input bm-input" type="radio" name="bm_${name}" id="bm_${name}_B" value="B">
      <label class="form-check-label" for="bm_${name}_B">B</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input bm-input" type="radio" name="bm_${name}" id="bm_${name}_M" value="M">
      <label class="form-check-label" for="bm_${name}_M">M</label>
    </div>
  `
  wrap.appendChild(label)
  wrap.appendChild(group)
  return wrap
}

function renderBMFields(){
  const cont = document.getElementById('bmFieldsContainer')
  cont.innerHTML = ''
  Object.keys(bmGroups).forEach(groupName => {
    const card = document.createElement('div')
    card.className = 'mb-3'
    const header = document.createElement('div')
    header.className = 'fw-semibold mb-2 border-bottom pb-1'
    header.textContent = groupName
    const row = document.createElement('div')
    row.className = 'row'
    bmGroups[groupName].forEach(([name, label]) => row.appendChild(optionBM(name, label)))
    card.appendChild(header)
    card.appendChild(row)
    cont.appendChild(card)
  })
}

async function cargarTecnicos(){
  const res = await fetch('/api/mpa/tecnicos', { credentials: 'include' })
  const data = await res.json()
  tecnicos = (data && data.success) ? (data.tecnicos || data.data || []) : []
  const fill = (selectEl) => {
    selectEl.innerHTML = '<option value="">Todos</option>'
    tecnicos.forEach(t => {
      const opt = document.createElement('option')
      opt.value = t.id_codigo_consumidor || t.id
      opt.textContent = t.nombre || `${t.id_codigo_consumidor}`
      selectEl.appendChild(opt)
    })
  }
  fill(document.getElementById('filtroTecnico'))
  const insSel = document.getElementById('insTecnico')
  insSel.innerHTML = ''
  tecnicos.forEach(t => {
    const opt = document.createElement('option')
    opt.value = t.id_codigo_consumidor || t.id
    opt.textContent = t.nombre || `${t.id_codigo_consumidor}`
    insSel.appendChild(opt)
  })
}

function contarMalos(r){
  let c = 0
  bmFieldNames.forEach(k => { if (getBMValue(r, k) === 'M') c++ })
  return c
}

function renderTabla(){
  const tbody = document.querySelector('#tablaInspecciones tbody')
  if (!inspecciones.length){
    document.getElementById('emptyState').style.display = 'block'
    tbody.innerHTML = ''
    return
  }
  document.getElementById('emptyState').style.display = 'none'
  const latestGoodByPlaca = {}
  for (let i = 0; i < inspecciones.length; i++){
    const r = inspecciones[i]
    const placa = r.placa
    const malos = contarMalos(r)
    const fiRaw = r.fecha_inspeccion
    if (!placa || malos !== 0 || !fiRaw) continue
    let fi
    try{ fi = new Date(String(fiRaw).replace(' ', 'T')) }catch(e){ fi = null }
    if (!fi || isNaN(fi.getTime())) continue
    const ts = fi.getTime()
    if (!(placa in latestGoodByPlaca) || ts > latestGoodByPlaca[placa]){
      latestGoodByPlaca[placa] = ts
    }
  }
  let html = ''
  for (let i = 0; i < inspecciones.length; i++){
    const r = inspecciones[i]
    const fecha = r.fecha_inspeccion || ''
    const firmaT = r.firma_trabajador ? '<span class="badge bg-dark">Trabajador</span>' : ''
    const firmaI = r.firma_inspector ? '<span class="badge bg-secondary">Inspector</span>' : ''
    const btnTrabDisabled = r.firma_trabajador ? 'disabled' : ''
    const btnInspDisabled = r.firma_inspector ? 'disabled' : ''
    const malos = contarMalos(r)
    const plazoHtml = (() => {
      if (!fecha || malos <= 0) return '-'
      let fi
      try{ fi = new Date(String(fecha).replace(' ', 'T')) }catch(e){ fi = null }
      if (!fi || isNaN(fi.getTime())) return '-'
      const goodTs = latestGoodByPlaca[r.placa]
      if (goodTs && goodTs > fi.getTime()){
        const gd = new Date(goodTs)
        const y = gd.getFullYear()
        const m = String(gd.getMonth()+1).padStart(2,'0')
        const d = String(gd.getDate()).padStart(2,'0')
        const ds = `${y}-${m}-${d}`
        return `<span class="badge bg-success">Subsanada</span><div class="small text-muted">${ds}</div>`
      }
      const due = new Date(fi.getTime() + 5*24*60*60*1000)
      const now = new Date()
      const msDay = 24*60*60*1000
      const diff = Math.ceil((due - now)/msDay)
      const y = due.getFullYear()
      const m = String(due.getMonth()+1).padStart(2,'0')
      const d = String(due.getDate()).padStart(2,'0')
      const ds = `${y}-${m}-${d}`
      if (diff > 0) return `<span class="badge bg-warning">${diff} días</span><div class="small text-muted">${ds}</div>`
      if (diff === 0) return `<span class="badge bg-warning">Hoy</span><div class="small text-muted">${ds}</div>`
      return `<span class="badge bg-danger">Vencido ${Math.abs(diff)} días</span><div class="small text-muted">${ds}</div>`
    })()
    html += `
      <tr>
        <td>${fecha}</td>
        <td>${r.tecnico_nombre || r.nombre || ''}</td>
        <td>${r.placa || ''}</td>
        <td>${malos}</td>
        <td>${plazoHtml}</td>
        <td>${r.observaciones || ''}</td>
        <td class="text-nowrap">${firmaT} ${firmaI}</td>
        <td class="text-end">
          <div class="btn-group">
            <button class="btn btn-dark btn-sm" data-action="ver" data-id="${r.id_mpa_inspeccion_vehiculo}"><i class="fas fa-eye me-1"></i>Ver</button>
            <button class="btn btn-outline-dark btn-sm" ${btnTrabDisabled} title="${r.firma_trabajador ? 'Ya firmada por el trabajador' : ''}" data-action="firma-trabajador" data-id="${r.id_mpa_inspeccion_vehiculo}"><i class="fas fa-pen me-1"></i>Firma trabajador</button>
            <button class="btn btn-outline-secondary btn-sm" ${btnInspDisabled} title="${r.firma_inspector ? 'Ya firmada por el inspector' : ''}" data-action="firma-inspector" data-id="${r.id_mpa_inspeccion_vehiculo}"><i class="fas fa-pen-fancy me-1"></i>Firma inspector</button>
          </div>
        </td>
      </tr>
    `
  }
  tbody.innerHTML = html
}

async function cargarInspecciones(){
  const placa = (document.getElementById('filtroPlaca').value || '').trim().toUpperCase()
  const tecnico_id = document.getElementById('filtroTecnico').value || ''
  let url = '/api/mpa/inspecciones'
  const qs = []
  if (placa) qs.push('placa='+encodeURIComponent(placa))
  if (tecnico_id) qs.push('tecnico_id='+encodeURIComponent(tecnico_id))
  qs.push('limit=200')
  if (qs.length) url += ('?'+qs.join('&'))
  const res = await fetch(url, { credentials: 'include' })
  const data = await res.json()
  inspecciones = (data && data.success) ? (data.data || []) : []
  renderTabla()
}

function renderPendientes(){
  const tbody = document.querySelector('#tablaPendientes tbody')
  const empty = document.getElementById('pendientesEmpty')
  if (!pendientes.length){
    empty.style.display = 'block'
    const bc = document.getElementById('pendientesCountBadge')
    if (bc) bc.textContent = '0 pendientes'
    tbody.innerHTML = ''
    return
  }
  empty.style.display = 'none'
  const bc = document.getElementById('pendientesCountBadge')
  if (bc) bc.textContent = `${pendientes.length} pendientes`
  let html = ''
  for (let i=0;i<pendientes.length;i++){
    const p = pendientes[i]
    html += `
      <tr>
        <td>${p.placa || ''}</td>
        <td>${p.tecnico_nombre || p.tecnico_id || ''}</td>
        <td class="text-end">
          <button class="btn btn-dark btn-sm" data-action="registrar" data-tid="${p.tecnico_id}" data-placa="${p.placa}"><i class="fas fa-plus me-1"></i>Registrar</button>
        </td>
      </tr>
    `
  }
  tbody.innerHTML = html
}

async function cargarPendientesMes(){
  if (pendientesEndpointAvailable === null){
    pendientesEndpointAvailable = readPendFlag()
  }
  if (pendientesEndpointAvailable === true){
    try{
      const res = await fetch('/api/mpa/inspecciones/pendientes-mes?limit=5', { credentials: 'include' })
      if (res.ok){
        const d = await res.json()
        pendientes = (d && d.success) ? (d.data || []) : []
        pendientesEndpointAvailable = true
        writePendFlag(true)
        renderPendientes()
        return
      }
      pendientesEndpointAvailable = false
      writePendFlag(false)
    }catch(e){
      pendientesEndpointAvailable = false
      writePendFlag(false)
    }
  }
  try{
    const [rv, ri] = await Promise.all([
      fetch('/api/mpa/vehiculos', { credentials: 'include' }),
      fetch('/api/mpa/inspecciones', { credentials: 'include' })
    ])
    const dv = await rv.json()
    const di = await ri.json()
    const vehs = (dv && dv.success) ? (dv.data || []) : []
    const ins = (di && di.success) ? (di.data || []) : []
    const now = new Date()
    const from = new Date(now.getFullYear(), now.getMonth(), 1)
    const to = new Date(now.getFullYear(), now.getMonth()+1, 1)
    const placasInsMes = new Set()
    ins.forEach(r => {
      const f = r.fecha_inspeccion ? new Date(r.fecha_inspeccion.replace(' ', 'T')) : null
      if (!f) return
      if (f >= from && f < to){
        const placa = r.placa
        if (placa){ placasInsMes.add(String(placa)) }
      }
    })
    const list = []
    vehs.forEach(v => {
      const tid = v.tecnico_asignado
      const placa = v.placa
      if (!tid || !placa) return
      if (!placasInsMes.has(String(placa))){
        list.push({ placa, tecnico_id: tid, tecnico_nombre: v.tecnico_nombre })
      }
    })
    list.sort((a,b)=>{
      const ta = String(a.tecnico_nombre||'')+String(a.placa||'')
      const tb = String(b.tecnico_nombre||'')+String(b.placa||'')
      return ta.localeCompare(tb)
    })
    pendientes = list.slice(0,5)
    renderPendientes()
  }catch(e){
    pendientes = []
    renderPendientes()
  }
}

async function guardarInspeccion(){
  const tecnico_id = document.getElementById('insTecnico').value
  const placa = (document.getElementById('insPlaca').value || '').trim().toUpperCase()
  const observaciones = document.getElementById('insObservaciones').value || ''
  const payload = { tecnico_id, placa, observaciones, foto1: fotosBase64.foto1, foto2: fotosBase64.foto2, foto3: fotosBase64.foto3 }
  bmFieldNames.forEach(fname => {
    const checked = document.querySelector(`input[name="bm_${fname}"]:checked`)
    payload[fname] = checked ? checked.value : ''
  })
  const res = await fetch('/api/mpa/inspecciones', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload), credentials: 'include' })
  const data = await res.json()
  if (data && data.success){
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalInspeccion'))
    modal && modal.hide()
    fotosBase64 = { foto1: null, foto2: null, foto3: null }
    ;['insFoto1','insFoto2','insFoto3'].forEach((id, idx) => {
      const img = document.getElementById(['insPrev1','insPrev2','insPrev3'][idx])
      if (img){ img.style.display = 'none'; img.src = '' }
      const inp = document.getElementById(id)
      if (inp) inp.value = ''
    })
    await Promise.all([cargarInspecciones(), cargarPendientesMes()])
  } else {
    alert((data && data.error) || 'Error al crear la inspección')
  }
}

function initFirmaCanvas(){
  const canvas = document.getElementById('firmaCanvas')
  const ctx = canvas.getContext('2d')

  function resizeCanvas(){
    const rect = canvas.getBoundingClientRect()
    const dpr = window.devicePixelRatio || 1
    canvas.width = Math.max(1, Math.floor(rect.width * dpr))
    canvas.height = Math.max(1, Math.floor(rect.height * dpr))
    ctx.setTransform(1,0,0,1,0,0)
    ctx.scale(dpr, dpr)
    ctx.strokeStyle = '#000'
    ctx.lineWidth = 2
  }

  resizeCanvas()

  let drawing = false
  let last = null
  const pos = (e) => {
    const rect = canvas.getBoundingClientRect()
    const x = (e.clientX || (e.touches && e.touches[0].clientX)) - rect.left
    const y = (e.clientY || (e.touches && e.touches[0].clientY)) - rect.top
    return { x, y }
  }
  const start = (e) => { drawing = true; last = pos(e) }
  const move = (e) => { if (!drawing) return; const p = pos(e); ctx.beginPath(); ctx.moveTo(last.x, last.y); ctx.lineTo(p.x, p.y); ctx.stroke(); last = p }
  const end = () => { drawing = false; last = null }
  canvas.addEventListener('mousedown', start)
  canvas.addEventListener('mousemove', move)
  canvas.addEventListener('mouseup', end)
  canvas.addEventListener('mouseleave', end)
  canvas.addEventListener('touchstart', (e) => { e.preventDefault(); start(e) }, { passive: false })
  canvas.addEventListener('touchmove', (e) => { e.preventDefault(); move(e) }, { passive: false })
  canvas.addEventListener('touchend', (e) => { e.preventDefault(); end() }, { passive: false })
  document.getElementById('btnLimpiarFirma').addEventListener('click', () => { ctx.clearRect(0,0,canvas.width,canvas.height) })

  // Redimensionar al mostrar el modal y en cambios de tamaño/orientación
  const modalEl = document.getElementById('modalFirma')
  modalEl.addEventListener('shown.bs.modal', () => { resizeCanvas(); ctx.clearRect(0,0,canvas.width,canvas.height) })
  window.addEventListener('resize', resizeCanvas)
  window.addEventListener('orientationchange', resizeCanvas)
}

async function guardarFirma(){
  if (!firmaTarget.id || !firmaTarget.tipo) return
  const canvas = document.getElementById('firmaCanvas')
  const rect = canvas.getBoundingClientRect();
  const off = document.createElement('canvas');
  off.width = Math.max(600, Math.floor(rect.width));
  off.height = Math.max(200, Math.floor(rect.height));
  const octx = off.getContext('2d');
  octx.fillStyle = '#fff';
  octx.fillRect(0, 0, off.width, off.height);
  octx.drawImage(canvas, 0, 0, off.width, off.height);
  const dataUrl = off.toDataURL('image/jpeg', 0.7)
  let endpoint = 'firma-trabajador'
  if (firmaTarget.tipo !== 'trabajador') endpoint = 'firma-inspector'
  const urlFirma = `/api/mpa/inspecciones/${firmaTarget.id}/${endpoint}`
  const res = await fetch(urlFirma, { method:'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ firma: dataUrl }), credentials: 'include' })
  const d = await res.json()
  if (d && d.success){
    const modal = bootstrap.Modal.getInstance(document.getElementById('modalFirma'))
    modal && modal.hide()
    await cargarInspecciones()
  } else {
    alert((d && d.error) || 'Error al guardar la firma')
  }
}

function abrirModalFirma(tipo, id){
  firmaTarget = { tipo, id }
  const modal = new bootstrap.Modal(document.getElementById('modalFirma'))
  const canvas = document.getElementById('firmaCanvas')
  const ctx = canvas.getContext('2d')
  ctx.clearRect(0,0,canvas.width,canvas.height)
  modal.show()
}

async function verInspeccion(id){
  try{
    const res = await fetch(`/api/mpa/inspecciones/${id}`, { credentials: 'include' })
    const d = await res.json()
    if (d && d.success){
      const r = d.data || {}
      document.getElementById('verDetFecha').textContent = r.fecha_inspeccion || '-'
      document.getElementById('verDetTecnico').textContent = r.tecnico_nombre || r.nombre || '-'
      document.getElementById('verDetPlaca').textContent = r.placa || '-'
      document.getElementById('verDetObservaciones').textContent = r.observaciones || '-'
      document.getElementById('verDetVLicencia').textContent = r.vencimiento_licencia || '-'
      document.getElementById('verDetVSoat').textContent = r.vencimiento_soat || '-'
      document.getElementById('verDetVTm').textContent = r.vencimiento_tecnicomecanica || '-'
      const imgT = document.getElementById('verImgFirmaTrabajador')
      const imgI = document.getElementById('verImgFirmaInspector')
      if (r.firma_trabajador){ imgT.src = r.firma_trabajador; imgT.style.display = 'block' } else { imgT.style.display = 'none' }
      if (r.firma_inspector){ imgI.src = r.firma_inspector; imgI.style.display = 'block' } else { imgI.style.display = 'none' }
      const vf1 = document.getElementById('verFoto1')
      const vf2 = document.getElementById('verFoto2')
      const vf3 = document.getElementById('verFoto3')
      if (vf1){ if (r.foto1){ vf1.src = r.foto1; vf1.style.display='block' } else { vf1.style.display='none' } }
      if (vf2){ if (r.foto2){ vf2.src = r.foto2; vf2.style.display='block' } else { vf2.style.display='none' } }
      if (vf3){ if (r.foto3){ vf3.src = r.foto3; vf3.style.display='block' } else { vf3.style.display='none' } }
      [vf1, vf2, vf3].forEach((el) => {
        if (!el) return
        el.onclick = () => { if (el.src) abrirZoomImagen(el.src) }
      })
      renderVerBM(r)
      const modal = new bootstrap.Modal(document.getElementById('modalVerInspeccion'))
      const btnPdf = document.getElementById('btnExportPdf')
      if (btnPdf){ btnPdf.onclick = () => { window.open(`/api/mpa/inspecciones/${id}/pdf`, '_blank') } }
      modal.show()
    } else {
      alert((d && d.error) || 'Error al obtener la inspección')
    }
  } catch(e){
    alert('Error de conexión al cargar la inspección')
  }
}

function abrirZoomImagen(src){
  const img = document.getElementById('zoomImg')
  const cont = document.getElementById('zoomContainer')
  img.style.transform = 'scale(1)'
  img.src = src
  cont.scrollTop = 0
  cont.scrollLeft = 0
  new bootstrap.Modal(document.getElementById('modalZoomImagen')).show()
}

(() => {
  let scale = 1
  const img = document.getElementById('zoomImg')
  const btnMas = document.getElementById('zoomMas')
  const btnMenos = document.getElementById('zoomMenos')
  const btnReset = document.getElementById('zoomReset')
  const cont = document.getElementById('zoomContainer')
  const setScale = (s) => { scale = Math.max(1, Math.min(4, s)); img.style.transform = `scale(${scale})` }
  btnMas && btnMas.addEventListener('click', () => setScale(scale + 0.2))
  btnMenos && btnMenos.addEventListener('click', () => setScale(scale - 0.2))
  btnReset && btnReset.addEventListener('click', () => setScale(1))
  cont && cont.addEventListener('wheel', (e) => { if (scale !== 1) e.preventDefault(); setScale(scale + (e.deltaY < 0 ? 0.1 : -0.1)) })
})()

function renderVerBM(r){
  const cont = document.getElementById('verBMContainer')
  cont.innerHTML = ''
  const labelMap = {}
  Object.values(bmGroups).flat().forEach(([n,l]) => { labelMap[n] = l })
  // Resumen general
  let totalB = 0, totalM = 0
  Object.keys(bmGroups).forEach(gn => {
    let b = 0, m = 0
    bmGroups[gn].forEach(([n]) => {
      const v = getBMValue(r, n)
      if (v === 'B') b++
      else if (v === 'M') m++
    })
    totalB += b; totalM += m
    const card = document.createElement('div')
    card.className = 'mb-3'
    const header = document.createElement('div')
    header.className = 'fw-semibold mb-2 border-bottom pb-1'
    header.textContent = `${gn} (B: ${b}, M: ${m})`
    const row = document.createElement('div')
    row.className = 'row'
    bmGroups[gn].forEach(([n]) => {
      const wrap = document.createElement('div')
      wrap.className = 'col-12 col-md-6 col-lg-4 mb-2'
      const item = document.createElement('div')
      item.className = 'd-flex justify-content-between align-items-center'
      const lab = document.createElement('div')
      lab.className = 'small text-muted'
      lab.textContent = labelMap[n]
      const val = document.createElement('span')
      const v = getBMValue(r, n)
      if (v === 'B'){ val.className = 'badge bg-success'; val.textContent = 'Bueno' }
      else if (v === 'M'){ val.className = 'badge bg-danger'; val.textContent = 'Malo' }
      else { val.className = 'badge bg-secondary'; val.textContent = '-' }
      item.appendChild(lab)
      item.appendChild(val)
      wrap.appendChild(item)
      row.appendChild(wrap)
    })
    card.appendChild(header)
    card.appendChild(row)
    cont.appendChild(card)
  })
  const resumen = document.createElement('div')
  resumen.className = 'mb-3'
  resumen.innerHTML = `<span class="badge bg-success me-2">Total Bueno: ${totalB}</span><span class="badge bg-danger">Total Malo: ${totalM}</span>`
  cont.prepend(resumen)
}

  document.addEventListener('DOMContentLoaded', async () => {
  renderBMFields()
  await Promise.all([cargarTecnicos(), cargarInspecciones(), cargarPendientesMes()])
  document.getElementById('btnBuscar').addEventListener('click', cargarInspecciones)
  document.getElementById('btnGuardarInspeccion').addEventListener('click', guardarInspeccion)
  initFirmaCanvas()
  document.getElementById('btnGuardarFirma').addEventListener('click', guardarFirma)
  const selTec = document.getElementById('insTecnico')
  selTec.addEventListener('change', async () => {
    const tecnico_id = selTec.value
    if (!tecnico_id) return
    try{
      const rVehs = await fetch('/api/mpa/vehiculos?tecnico='+encodeURIComponent(tecnico_id), { credentials: 'include' })
      const dVehs = await rVehs.json()
      if (dVehs && dVehs.success){
        const arr = dVehs.data || dVehs.vehiculos || []
        const v = arr[0]
        if (v && v.placa){
          const inpPlaca = document.getElementById('insPlaca')
          inpPlaca.value = v.placa
          inpPlaca.dispatchEvent(new Event('blur'))
        }
      }
    }catch(e){}
  })
  const modalIns = document.getElementById('modalInspeccion')
  modalIns.addEventListener('shown.bs.modal', async () => {
    const tecnico_id = selTec.value
    const inpPlaca = document.getElementById('insPlaca')
    if (!tecnico_id || (inpPlaca.value && inpPlaca.value.trim())) return
    try{
      const rVehs = await fetch('/api/mpa/vehiculos?tecnico='+encodeURIComponent(tecnico_id), { credentials: 'include' })
      const dVehs = await rVehs.json()
      if (dVehs && dVehs.success){
        const arr = dVehs.data || dVehs.vehiculos || []
        const v = arr[0]
        if (v && v.placa){
          inpPlaca.value = v.placa
          inpPlaca.dispatchEvent(new Event('blur'))
        }
      }
    }catch(e){}
  })
  document.getElementById('insPlaca').addEventListener('blur', async () => {
    const placa = (document.getElementById('insPlaca').value || '').trim().toUpperCase()
    if (!placa) return
    try{
      const [rVeh, rSoat, rTm] = await Promise.all([
        fetch('/api/mpa/vehiculos?placa='+encodeURIComponent(placa), { credentials: 'include' }),
        fetch('/api/mpa/soat?placa='+encodeURIComponent(placa), { credentials: 'include' }),
        fetch('/api/mpa/tecnico_mecanica?placa='+encodeURIComponent(placa), { credentials: 'include' })
      ])
      const dVeh = await rVeh.json();
      let v = {}
      if (dVeh && dVeh.success){
        const arr = dVeh.data || dVeh.vehiculos || []
        v = arr[0] || {}
      }
      document.getElementById('detMarca').textContent = v.marca || '-'
      document.getElementById('detLinea').textContent = v.linea || '-'
      document.getElementById('detModelo').textContent = v.modelo || '-'
      document.getElementById('detColor').textContent = v.color || '-'
      document.getElementById('detCilindraje').textContent = v.cilindraje || v.cilindraje_cc || '-'
      const dSoat = await rSoat.json();
      let s = {}
      if (dSoat && dSoat.success){
        const arrS = dSoat.data || []
        s = arrS[0] || {}
      }
      document.getElementById('detVSoat').textContent = s.fecha_vencimiento || '-'
      const dTm = await rTm.json();
      let t = {}
      if (dTm && dTm.success){
        const arrT = dTm.data || []
        t = arrT[0] || {}
      }
      document.getElementById('detVTm').textContent = t.fecha_vencimiento || '-'
    }catch(e){ }
    try{
      const tecnico_id = document.getElementById('insTecnico').value
      if (tecnico_id){
        const rLic = await fetch('/api/mpa/licencias-conducir?tecnico_id='+encodeURIComponent(tecnico_id), { credentials: 'include' })
        const dLic = await rLic.json()
        let l = {}
        if (dLic && dLic.success){
          const arrL = dLic.data || []
          arrL.sort((a,b)=> {
            const tb = new Date(b.fecha_vencimiento||'1900-01-01')
            const ta = new Date(a.fecha_vencimiento||'1900-01-01')
            return tb - ta
          })
          l = arrL[0] || {}
        }
        document.getElementById('detVLicencia').textContent = l.fecha_vencimiento || '-'
      }
    }catch(e){ }
  })
    document.querySelector('#tablaInspecciones tbody').addEventListener('click', (e) => {
      const btn = e.target.closest('button')
      if (!btn) return
      const id = btn.dataset.id
      const action = btn.dataset.action
      if (action === 'firma-trabajador') abrirModalFirma('trabajador', id)
      if (action === 'firma-inspector') abrirModalFirma('inspector', id)
      if (action === 'ver') verInspeccion(id)
    })
    document.querySelector('#tablaPendientes tbody').addEventListener('click', (e) => {
      const btn = e.target.closest('button')
      if (!btn) return
      if (btn.dataset.action !== 'registrar') return
      const tid = btn.dataset.tid
      const placa = btn.dataset.placa
      const selTec = document.getElementById('insTecnico')
      const inpPlaca = document.getElementById('insPlaca')
      if (selTec){ selTec.value = tid || '' }
      if (inpPlaca){ inpPlaca.value = placa || '' }
      const modal = new bootstrap.Modal(document.getElementById('modalInspeccion'))
      modal.show()
    })
    const btnRef = document.getElementById('btnRefreshPendientes')
    if (btnRef){
      btnRef.addEventListener('click', async () => {
        btnRef.disabled = true
        try{ await cargarPendientesMes() } finally { btnRef.disabled = false }
      })
    }
  })

  function compressImage(file, maxDim, quality){
    return new Promise((resolve, reject) => {
      const reader = new FileReader()
      reader.onload = (e) => {
        const img = new Image()
        img.onload = () => {
          const canvas = document.createElement('canvas')
          const ratio = Math.min(maxDim / img.width, maxDim / img.height, 1)
          const w = Math.round(img.width * ratio)
          const h = Math.round(img.height * ratio)
          canvas.width = w
          canvas.height = h
          const ctx = canvas.getContext('2d')
          ctx.drawImage(img, 0, 0, w, h)
          try{
            const dataUrl = canvas.toDataURL('image/jpeg', quality)
            resolve(dataUrl)
          }catch(err){ reject(err) }
        }
        img.onerror = reject
        img.src = e.target.result
      }
      reader.onerror = reject
      reader.readAsDataURL(file)
    })
  }

  function bindFotoInput(inpId, prevId, key){
    const inp = document.getElementById(inpId)
    const prev = document.getElementById(prevId)
    if (!inp) return
    inp.addEventListener('change', async () => {
      const f = inp.files && inp.files[0]
      if (!f){ fotosBase64[key] = null; if (prev){ prev.style.display='none' } return }
      try{
        const dataUrl = await compressImage(f, 1280, 0.7)
        fotosBase64[key] = dataUrl
        if (prev){ prev.src = dataUrl; prev.style.display = 'block' }
      }catch(e){
        const reader = new FileReader()
        reader.onload = (ev) => {
          fotosBase64[key] = ev.target.result
          if (prev){ prev.src = fotosBase64[key]; prev.style.display = 'block' }
        }
        reader.readAsDataURL(f)
      }
    })
  }
  bindFotoInput('insFoto1','insPrev1','foto1')
  bindFotoInput('insFoto2','insPrev2','foto2')
  bindFotoInput('insFoto3','insPrev3','foto3')
</script>
{% endblock %}
