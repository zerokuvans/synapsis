{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%) !important;">
                    <h3 class="mb-0">
                        <i class="fas fa-tools me-2"></i>Gesti칩n de Mantenimientos - MPA
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Gestiona todos los mantenimientos realizados a los veh칤culos de la flota. Aqu칤 puedes ver, crear, actualizar y eliminar registros de mantenimiento.
                    </div>
                    
                    <!-- Bot칩n para crear nuevo mantenimiento -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Lista de Mantenimientos</h4>
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#maintenanceModal" onclick="openCreateModal()">
                            <i class="fas fa-plus me-2"></i>Crear Mantenimiento
                        </button>
                    </div>
                    
                    <!-- Tabla de mantenimientos -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="maintenanceTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Placa</th>
                                    <th>T칠cnico</th>
                                    <th>Fecha Mantenimiento</th>
                                    <th>Tipo</th>
                                    <th>Tipo General</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody">
                                <!-- Los datos se cargar치n din치micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mensaje cuando no hay mantenimientos -->
                    <div id="noMaintenanceMessage" class="text-center py-5" style="display: none;">
                        <i class="fas fa-tools fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay mantenimientos registrados</h5>
                        <p class="text-muted">Haz clic en "Crear Mantenimiento" para agregar el primer registro.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar mantenimiento -->
<div class="modal fade" id="maintenanceModal" tabindex="-1" aria-labelledby="maintenanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="maintenanceModalLabel">Crear Mantenimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="maintenanceForm">
                    <input type="hidden" id="maintenanceId" name="maintenanceId">
                    
                    <div class="row">
                        <!-- Informaci칩n del Veh칤culo -->
                        <div class="col-md-6 mb-3">
                            <label for="placa" class="form-label">Placa del Veh칤culo <span class="text-danger">*</span></label>
                            <select class="form-select" id="placa" name="placa" required onchange="onPlacaChange()">
                                <option value="">Seleccionar placa</option>
                                <!-- Las placas se cargar치n din치micamente -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tecnicoAsignado" class="form-label">T칠cnico Asignado</label>
                            <input type="text" class="form-control" id="tecnicoAsignado" name="tecnicoAsignado" readonly>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipoVehiculo" class="form-label">Tipo de Veh칤culo</label>
                            <input type="text" class="form-control" id="tipoVehiculo" name="tipoVehiculo" readonly>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="kilometraje" class="form-label">Kilometraje Actual <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="kilometraje" name="kilometraje" required min="0">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="categoriaMantenimiento" class="form-label">Tipo de Mantenimiento <span class="text-danger">*</span></label>
                            <select class="form-select" id="categoriaMantenimiento" name="categoriaMantenimiento" required>
                                <option value="">Seleccionar tipo de mantenimiento</option>
                                <!-- Las categor칤as se cargar치n din치micamente seg칰n el tipo de veh칤culo -->
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="tipoGeneralMantenimiento" class="form-label">Tipo general de mantenimiento <span class="text-danger">*</span></label>
                            <select class="form-select" id="tipoGeneralMantenimiento" name="tipoGeneralMantenimiento" required>
                                <option value="Cambio de Aceite">Cambio de Aceite</option>
                                <option value="Preventivo Completo">Preventivo Completo</option>
                                <option value="Mantenimiento Mayor">Mantenimiento Mayor</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div id="tipoGeneralSubcats" class="border rounded p-2"></div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="observaciones" class="form-label">Observaciones del Mantenimiento <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="4" required placeholder="Describe detalladamente el mantenimiento realizado..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Campo de Estado del Mantenimiento -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="estadoMantenimiento" class="form-label">Estado del Mantenimiento <span class="text-danger">*</span></label>
                            <select class="form-select" id="estadoMantenimiento" name="estadoMantenimiento" required>
                                <option value="Abierto" selected>游 Abierto</option>
                                <option value="Finalizado">游릭 Finalizado</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <strong>Abierto:</strong> Mantenimiento en proceso o pendiente. 
                                <strong>Finalizado:</strong> Mantenimiento completado.
                            </small>
                        </div>
                    </div>
                    
                    <!-- Secci칩n de im치genes -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fotoTaller" class="form-label">Foto del Taller (Georeferenciada)</label>
                            <input type="file" class="form-control" id="fotoTaller" name="fotoTaller" accept="image/*" onchange="previewImage(this, 'previewTaller')">
                            <div class="mt-2">
                                <img id="previewTaller" src="" alt="Vista previa" style="max-width: 100%; max-height: 200px; display: none;" class="img-thumbnail">
                            </div>
                            <small class="form-text text-muted">Sube una foto del taller donde se realiz칩 el mantenimiento</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fotoFactura" class="form-label">Foto de la Factura</label>
                            <input type="file" class="form-control" id="fotoFactura" name="fotoFactura" accept="image/*" onchange="previewImage(this, 'previewFactura')">
                            <div class="mt-2">
                                <img id="previewFactura" src="" alt="Vista previa" style="max-width: 100%; max-height: 200px; display: none;" class="img-thumbnail">
                            </div>
                            <small class="form-text text-muted">Sube una foto de la factura del mantenimiento</small>
                        </div>
                    </div>
                    
                    <!-- Informaci칩n autom치tica -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Nota:</strong> La fecha y hora del mantenimiento se registrar치 autom치ticamente al momento de guardar (Zona horaria: Bogot치, Colombia).
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveMaintenance()">
                    <i class="fas fa-save me-2"></i>Guardar Mantenimiento
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del mantenimiento -->
<div class="modal fade" id="viewMaintenanceModal" tabindex="-1" aria-labelledby="viewMaintenanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewMaintenanceModalLabel">Detalles del Mantenimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewMaintenanceContent">
                <!-- El contenido se cargar치 din치micamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img id="imagePreview" src="" alt="Imagen" style="width: 100%; height: auto; display: block;">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMaintenanceId = null;
let vehiclePlates = [];
let maintenanceCategories = [];

// Cargar datos al inicializar la p치gina
document.addEventListener('DOMContentLoaded', function() {
    const qid = new URLSearchParams(location.search).get('id');
    if (qid) {
        loadMaintenanceById(qid);
    } else {
        loadMaintenances();
    }
    loadVehiclePlates();
    try {
        const tgSel = document.getElementById('tipoGeneralMantenimiento');
        renderGeneralSubcatsUI(tgSel.value || 'Cambio de Aceite', []);
        tgSel.addEventListener('change', function(){ renderGeneralSubcatsUI(this.value, []); });
    } catch (e) {}
    try {
        const imgModal = document.getElementById('imagePreviewModal');
        if (imgModal) {
            imgModal.addEventListener('hidden.bs.modal', function(){
                const img = document.getElementById('imagePreview');
                if (img) img.src = '';
            });
        }
    } catch (e) {}
});

// Cargar lista de mantenimientos
function loadMaintenances() {
    fetch('/api/mpa/mantenimientos')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayMaintenances(data.data);
            } else {
                showAlert('Error al cargar mantenimientos: ' + (data.message || 'Error desconocido'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar mantenimientos: ' + error.message, 'danger');
        });
}

function loadMaintenanceById(id) {
    fetch(`/api/mpa/mantenimientos/${encodeURIComponent(id)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.data) {
                displayMaintenances([data.data]);
                setTimeout(() => { try { viewMaintenance(data.data.id_mpa_mantenimientos); } catch (e) {} }, 0);
            } else {
                displayMaintenances([]);
                showAlert('No se encontr칩 el mantenimiento', 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar mantenimiento', 'danger');
        });
}

// Mostrar mantenimientos en la tabla
function displayMaintenances(maintenances) {
    const tbody = document.getElementById('maintenanceTableBody');
    const noMaintenanceMessage = document.getElementById('noMaintenanceMessage');
    const table = document.getElementById('maintenanceTable');
    
    if (maintenances.length === 0) {
        table.style.display = 'none';
        noMaintenanceMessage.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    noMaintenanceMessage.style.display = 'none';
    
    tbody.innerHTML = maintenances.map(maintenance => {
        const estadoBadge = maintenance.estado === 'Finalizado' 
            ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Finalizado</span>'
            : '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Abierto</span>';
        
        return `
        <tr>
            <td><strong>${maintenance.placa}</strong></td>
            <td>${maintenance.tecnico_nombre || 'Sin asignar'}</td>
            <td>${formatDateTime(maintenance.fecha_mantenimiento)}</td>
            <td>
                <span class="badge bg-primary">${maintenance.tipo_mantenimiento || 'Sin especificar'}</span><br>
                <small class="text-muted">Mantenimiento</small>
            </td>
            <td>
                <span class="badge bg-info">${maintenance.tipo_general_mantenimiento || 'N/A'}</span><br>
                <small class="text-muted">General</small>
            </td>
            <td>${estadoBadge}</td>
            <td>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-info" onclick="viewMaintenance(${maintenance.id_mpa_mantenimientos})" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="editMaintenance(${maintenance.id_mpa_mantenimientos})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteMaintenance(${maintenance.id_mpa_mantenimientos}, '${maintenance.placa}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    }).join('');
}

// Cargar lista de placas de veh칤culos
function loadVehiclePlates() {
    fetch('/api/mpa/vehiculos/placas')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                vehiclePlates = data.data;
                const select = document.getElementById('placa');
                select.innerHTML = '<option value="">Seleccionar placa</option>' +
                    vehiclePlates.map(vehicle => `
                        <option 
                            value="${vehicle.placa}"
                            data-tecnico="${vehicle.tecnico_nombre || ''}"
                            data-tipo="${vehicle.tipo_vehiculo}"
                            data-km="${vehicle.ultimo_km_preoperacional ?? ''}"
                        >${vehicle.placa}</option>
                    `).join('');
            } else {
                showAlert('Error al cargar placas: ' + (data.message || 'Error desconocido'), 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar placas: ' + error.message, 'warning');
        });
}

// Cargar categor칤as de mantenimiento por tipo de veh칤culo
function loadMaintenanceCategories(tipoVehiculo) {
    if (!tipoVehiculo) {
        document.getElementById('categoriaMantenimiento').innerHTML = '<option value="">Seleccionar tipo de mantenimiento</option>';
        return;
    }
    
    fetch(`/api/mpa/categorias-mantenimiento/${tipoVehiculo}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                maintenanceCategories = data.data;
                const select = document.getElementById('categoriaMantenimiento');
                select.innerHTML = '<option value="">Seleccionar tipo de mantenimiento</option>' +
                    maintenanceCategories.map(cat => `<option value="${cat.id_categoria_mantenimiento}">${cat.categoria} - ${cat.tipo_mantenimiento}</option>`).join('');
            } else {
                showAlert('Error al cargar categor칤as: ' + (data.message || 'Error desconocido'), 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar categor칤as: ' + error.message, 'warning');
        });
}

// Evento cuando cambia la placa seleccionada
function onPlacaChange() {
    const placaSelect = document.getElementById('placa');
    const selectedOption = placaSelect.options[placaSelect.selectedIndex];
    
    if (selectedOption.value) {
        const tecnico = selectedOption.getAttribute('data-tecnico');
        const tipoVehiculo = selectedOption.getAttribute('data-tipo');
        
        document.getElementById('tecnicoAsignado').value = tecnico;
        document.getElementById('tipoVehiculo').value = tipoVehiculo;
        const km = selectedOption.getAttribute('data-km');
        if (km && km !== 'null' && km !== 'undefined') {
            document.getElementById('kilometraje').value = km;
        }
        
        // Cargar categor칤as de mantenimiento para este tipo de veh칤culo
        loadMaintenanceCategories(tipoVehiculo);
    } else {
        document.getElementById('tecnicoAsignado').value = '';
        document.getElementById('tipoVehiculo').value = '';
        document.getElementById('categoriaMantenimiento').innerHTML = '<option value="">Seleccionar tipo de mantenimiento</option>';
    }
}

// Abrir modal para crear mantenimiento
function openCreateModal() {
    currentMaintenanceId = null;
    document.getElementById('maintenanceModalLabel').textContent = 'Crear Mantenimiento';
    document.getElementById('maintenanceForm').reset();
    document.getElementById('maintenanceId').value = '';
    
    // Limpiar previsualizaciones de im치genes
    document.getElementById('previewTaller').style.display = 'none';
    document.getElementById('previewFactura').style.display = 'none';
    
    // Limpiar campos auto-poblados
    document.getElementById('tecnicoAsignado').value = '';
    document.getElementById('tipoVehiculo').value = '';
    document.getElementById('categoriaMantenimiento').innerHTML = '<option value="">Seleccionar tipo de mantenimiento</option>';
}

// Previsualizar imagen
function previewImage(input, previewId) {
    const preview = document.getElementById(previewId);
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
        };
        
        reader.readAsDataURL(input.files[0]);
    } else {
        preview.style.display = 'none';
    }
}

// Ver detalles del mantenimiento
function viewMaintenance(maintenanceId) {
    fetch(`/api/mpa/mantenimientos/${maintenanceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const maintenance = data.data;
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">Informaci칩n del Veh칤culo</h6>
                            <p><strong>Placa:</strong> ${maintenance.placa}</p>
                            <p><strong>Tipo de Veh칤culo:</strong> ${maintenance.tipo_vehiculo}</p>
                            <p><strong>T칠cnico Asignado:</strong> ${maintenance.tecnico_nombre || 'Sin asignar'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">Informaci칩n del Mantenimiento</h6>
                            <p><strong>Fecha:</strong> ${formatDateTime(maintenance.fecha_mantenimiento)}</p>
                            <p><strong>Kilometraje:</strong> ${maintenance.kilometraje} km</p>
                            <p><strong>Tipo General:</strong> <span class="badge bg-info">${maintenance.tipo_general_mantenimiento || 'N/A'}</span></p>
                            <p><strong>Subcategor칤as:</strong> ${renderSubcats(maintenance.tipo_general_subcategorias)}</p>
                            <p><strong>Tipo de Mantenimiento:</strong> <span class="badge bg-primary">${maintenance.tipo_mantenimiento || 'Sin especificar'}</span></p>
                            <p><strong>Estado:</strong> ${maintenance.estado === 'Finalizado' 
                                ? '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Finalizado</span>'
                                : '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Abierto</span>'}</p>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-12" id="complianceContainer"></div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h6 class="text-success">Observaciones</h6>
                            <p class="border p-3 bg-light">${maintenance.observacion || 'Sin observaciones'}</p>
                        </div>
                    </div>
                    ${maintenance.foto_taller || maintenance.foto_factura ? `
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h6 class="text-success">Im치genes</h6>
                            <div class="row">
                                ${maintenance.foto_taller ? `
                                <div class="col-md-6">
                                    <p><strong>Foto del Taller:</strong></p>
                                    <img src="/static/${maintenance.foto_taller}" alt="Foto del taller" class="img-fluid img-thumbnail" style="max-height: 300px; cursor: zoom-in;" onclick="openImagePreview('/static/${maintenance.foto_taller}')">
                                </div>
                                ` : ''}
                                ${maintenance.foto_factura ? `
                                <div class="col-md-6">
                                    <p><strong>Foto de la Factura:</strong></p>
                                    <img src="/static/${maintenance.foto_factura}" alt="Foto de la factura" class="img-fluid img-thumbnail" style="max-height: 300px; cursor: zoom-in;" onclick="openImagePreview('/static/${maintenance.foto_factura}')">
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                `;
                document.getElementById('viewMaintenanceContent').innerHTML = content;
                try {
                    const html = renderCompliance(maintenance.tipo_general_subcategorias || [], maintenance.tipo_general_mantenimiento || '');
                    const cont = document.getElementById('complianceContainer');
                    if (cont) cont.innerHTML = html;
                } catch (e) {}
                new bootstrap.Modal(document.getElementById('viewMaintenanceModal')).show();
            } else {
                showAlert('Error al cargar detalles del mantenimiento: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar detalles del mantenimiento', 'danger');
        });
}

function openImagePreview(src) {
    const img = document.getElementById('imagePreview');
    if (img) img.src = src;
    new bootstrap.Modal(document.getElementById('imagePreviewModal')).show();
}

// Editar mantenimiento
function editMaintenance(maintenanceId) {
    fetch(`/api/mpa/mantenimientos/${maintenanceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const maintenance = data.data;
                currentMaintenanceId = maintenanceId;
                
                document.getElementById('maintenanceModalLabel').textContent = 'Editar Mantenimiento';
                document.getElementById('maintenanceId').value = maintenanceId;
                document.getElementById('placa').value = maintenance.placa;
                // Autocompletar siempre el t칠cnico desde la placa seleccionada
                onPlacaChange();
                document.getElementById('tipoVehiculo').value = maintenance.tipo_vehiculo;
                document.getElementById('kilometraje').value = maintenance.kilometraje;
                document.getElementById('observaciones').value = maintenance.observacion || '';
                document.getElementById('estadoMantenimiento').value = maintenance.estado || 'Abierto';
                const tgSel = document.getElementById('tipoGeneralMantenimiento');
                if (tgSel) tgSel.value = maintenance.tipo_general_mantenimiento || 'Cambio de Aceite';
                let pre = maintenance.tipo_general_subcategorias;
                if (typeof pre === 'string') {
                    try { pre = JSON.parse(pre); } catch (e) { pre = (pre || '').split(',').map(s=>s.trim()).filter(Boolean); }
                }
                renderGeneralSubcatsUI(tgSel.value || 'Cambio de Aceite', Array.isArray(pre)?pre:[]);

                // Cargar categor칤as y seleccionar la actual
                loadMaintenanceCategories(maintenance.tipo_vehiculo);
                setTimeout(() => {
                    document.getElementById('categoriaMantenimiento').value = maintenance.id_categoria_mantenimiento;
                }, 500);
                
                // Mostrar im치genes existentes si las hay
                if (maintenance.foto_taller) {
                    const previewTaller = document.getElementById('previewTaller');
                    previewTaller.src = `/static/${maintenance.foto_taller}`;
                    previewTaller.style.display = 'block';
                }
                
                if (maintenance.foto_factura) {
                    const previewFactura = document.getElementById('previewFactura');
                    previewFactura.src = `/static/${maintenance.foto_factura}`;
                    previewFactura.style.display = 'block';
                }
                
                new bootstrap.Modal(document.getElementById('maintenanceModal')).show();
            } else {
                showAlert('Error al cargar datos del mantenimiento: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar datos del mantenimiento', 'danger');
        });
}

// Guardar mantenimiento (crear o actualizar)
async function saveMaintenance() {
    const form = document.getElementById('maintenanceForm');
    
    // Validar campos requeridos
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    try {
        // Asegurar que el t칠cnico provenga SIEMPRE de la placa seleccionada
        const placaSelect = document.getElementById('placa');
        const selectedOption = placaSelect.options[placaSelect.selectedIndex];
        const tecnicoFromPlate = selectedOption ? (selectedOption.getAttribute('data-tecnico') || '') : '';

        // Subir im치genes primero si existen
        let fotoTallerPath = '';
        let fotoFacturaPath = '';
        
        const fotoTallerFile = document.getElementById('fotoTaller').files[0];
        const fotoFacturaFile = document.getElementById('fotoFactura').files[0];
        
        if (fotoTallerFile) {
            fotoTallerPath = await uploadImage(fotoTallerFile, 'taller');
        }
        
        if (fotoFacturaFile) {
            fotoFacturaPath = await uploadImage(fotoFacturaFile, 'factura');
        }
        
        // Obtener el texto seleccionado de la categor칤a de mantenimiento
        const categoriaSelect = document.getElementById('categoriaMantenimiento');
        const tipoMantenimiento = categoriaSelect.options[categoriaSelect.selectedIndex].text;
        const selectedSubcats = Array.from(document.querySelectorAll('#tipoGeneralSubcats input[type="checkbox"]:checked')).map(i => i.value);
        
        // Preparar datos del mantenimiento
        const maintenanceData = {
            placa: document.getElementById('placa').value,
            kilometraje: document.getElementById('kilometraje').value,
            tipo_mantenimiento: tipoMantenimiento,
            tipo_general: document.getElementById('tipoGeneralMantenimiento').value,
            tipo_general_subcategorias: selectedSubcats,
            observacion: document.getElementById('observaciones').value,
            foto_taller: fotoTallerPath,
            foto_factura: fotoFacturaPath,
            // Forzar env칤o del t칠cnico asignado desde la placa (no editable)
            tecnico: tecnicoFromPlate,
            estado: document.getElementById('estadoMantenimiento').value
        };
        
        const url = currentMaintenanceId ? `/api/mpa/mantenimientos/${currentMaintenanceId}` : '/api/mpa/mantenimientos';
        const method = currentMaintenanceId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(maintenanceData)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(currentMaintenanceId ? 'Mantenimiento actualizado exitosamente' : 'Mantenimiento creado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('maintenanceModal')).hide();
            loadMaintenances();
        } else {
            showAlert('Error: ' + (data.message || 'Error desconocido'), 'danger');
        }
        
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error al guardar el mantenimiento', 'danger');
    }
}

// Subir imagen
async function uploadImage(file, type) {
    const formData = new FormData();
    formData.append('image', file);
    formData.append('type', type);
    
    const response = await fetch('/api/mpa/mantenimientos/upload-image', {
        method: 'POST',
        body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
        return data.file_path;
    } else {
        throw new Error('Error al subir imagen: ' + data.error);
    }
}

// Eliminar mantenimiento
function deleteMaintenance(maintenanceId, placa) {
    if (confirm(`쮼st치 seguro de que desea eliminar el mantenimiento del veh칤culo ${placa}?`)) {
        fetch(`/api/mpa/mantenimientos/${maintenanceId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Mantenimiento eliminado exitosamente', 'success');
                loadMaintenances();
            } else {
                showAlert('Error al eliminar mantenimiento: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al eliminar mantenimiento', 'danger');
        });
    }
}

// Formatear fecha y hora
function formatDateTime(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    
    const date = new Date(dateTimeString);
    return date.toLocaleString('es-CO', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        timeZone: 'America/Bogota'
    });
}

// Mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

const GENERAL_SUBCATS = {
    'Cambio de Aceite': ['Aceite', 'Filtro de Aceite', 'Cadena', 'Frenos'],
    'Preventivo Completo': ['Filtro de Aire', 'Combustible', 'Frenos', 'Suspensi칩n', 'Torniller칤a'],
    'Mantenimiento Mayor': ['V치lvulas', 'Buj칤as', 'Filtro de Aire', 'L칤quido de Frenos']
};

function renderGeneralSubcatsUI(tipo, preselected) {
    const cont = document.getElementById('tipoGeneralSubcats');
    if (!cont) return;
    const items = GENERAL_SUBCATS[tipo] || [];
    const set = new Set((preselected || []).map(String));
    cont.innerHTML = items.length ? (
        '<div class="small text-muted mb-1">Selecciona las subcategor칤as realizadas</div>' +
        items.map(it => {
            const checked = set.has(it) ? 'checked' : '';
            const id = 'subcat_' + it.replace(/\s+/g,'_');
            return `
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="${id}" value="${it}" ${checked}>
                <label class="form-check-label" for="${id}">${it}</label>
              </div>
            `;
        }).join('')
    ) : '<div class="text-muted">No hay subcategor칤as para este tipo</div>';
}

function renderSubcats(subcats) {
    let arr = subcats;
    if (typeof arr === 'string') {
        try { arr = JSON.parse(arr); } catch (e) { arr = (arr || '').split(',').map(s=>s.trim()).filter(Boolean); }
    }
    if (!Array.isArray(arr) || arr.length === 0) return '<span class="text-muted">N/A</span>';
    return arr.map(s => `<span class="badge bg-secondary me-1">${s}</span>`).join('');
}

function renderCompliance(subcats, tipoGeneral) {
    const t = String(tipoGeneral || '').toLowerCase();
    const standards = {
        'cambio de aceite': ['Aceite', 'Filtro de Aceite', 'Cadena', 'Frenos'],
        'preventivo completo': ['Filtro de Aire', 'Combustible', 'Frenos', 'Suspensi칩n', 'Torniller칤a'],
        'mantenimiento mayor': ['V치lvulas', 'Buj칤as', 'Filtro de Aire', 'L칤quido de Frenos']
    };
    if (!t || !standards[t]) {
        return '<div class="alert alert-secondary">Tipo general no especificado para validar est치ndar</div>';
    }
    let arr = subcats;
    if (typeof arr === 'string') {
        try { arr = JSON.parse(arr); } catch (e) { arr = (arr || '').split(',').map(s=>s.trim()).filter(Boolean); }
    }
    const set = new Set((Array.isArray(arr) ? arr : []).map(s => String(s).trim().toLowerCase()));
    const req = standards[t].map(s => String(s));
    const matched = req.filter(k => set.has(k.toLowerCase()));
    const missing = req.filter(k => !set.has(k.toLowerCase()));
    const ratio = `${matched.length}/${req.length}`;
    const badge = matched.length === req.length ? 'success' : (matched.length ? 'warning' : 'danger');
    const items = missing.length ? `<ul class="mt-1">${missing.map(m => `<li>${m}</li>`).join('')}</ul>` : '';
    return `
      <div class="border rounded p-2">
        <div><strong>Cumplimiento est치ndar (${ratio}):</strong> <span class="badge bg-${badge}">${matched.length === req.length ? 'Completo' : (matched.length ? 'Parcial' : 'No cumple')}</span></div>
        ${missing.length ? '<div class="small text-muted">Faltantes:</div>' : ''}
        ${items}
      </div>
    `;
}
</script>
{% endblock %}
