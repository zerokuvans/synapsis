{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #dc3545 0%, #b02a37 100%) !important;">
                    <h3 class="mb-0">
                        <i class="fas fa-calendar-times me-2"></i>Control de Vencimientos - MPA
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Monitorea todos los vencimientos de documentos vehiculares: SOAT, Técnico Mecánica y Licencias de Conducir. Mantén al día la documentación de tu flota.
                    </div>
                    
                    <!-- Filtros -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="filtroTipo" class="form-label">Tipo de Documento</label>
                            <select class="form-select" id="filtroTipo" onchange="aplicarFiltros()">
                                <option value="">Todos los tipos</option>
                                <option value="SOAT">SOAT</option>
                                <option value="Técnico Mecánica">Técnico Mecánica</option>
                                <option value="Licencia de Conducir">Licencia de Conducir</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filtroEstado" class="form-label">Estado</label>
                            <select class="form-select" id="filtroEstado" onchange="aplicarFiltros()">
                                <option value="">Todos los estados</option>
                                <option value="Vencido">Vencido</option>
                                <option value="Próximo a vencer">Próximo a vencer</option>
                                <option value="Vigente">Vigente</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filtroTecnico" class="form-label">Técnico</label>
                            <select class="form-select" id="filtroTecnico" onchange="aplicarFiltros()">
                                <option value="">Todos los técnicos</option>
                                <!-- Se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="filtroPlaca" class="form-label">Placa</label>
                            <input type="text" class="form-control" id="filtroPlaca" placeholder="Ej. FQQ61G" oninput="aplicarFiltros()">
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="limpiarFiltros()">
                                <i class="fas fa-eraser me-2"></i>Limpiar Filtros
                            </button>
                        </div>
                    </div>
                    
                    <!-- Estadísticas rápidas -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body text-center">
                                    <h4 id="countVencidos" class="mb-1">0</h4>
                                    <small>Vencidos</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h4 id="countProximosVencer" class="mb-1">0</h4>
                                    <small>Próximos a vencer</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 id="countVigentes" class="mb-1">0</h4>
                                    <small>Vigentes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 id="countTotal" class="mb-1">0</h4>
                                    <small>Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tabla de Vencimientos -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="vencimientosTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Tipo</th>
                                    <th>Placa</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Días Restantes</th>
                                    <th>Estado</th>
                                    <th>Técnico</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="vencimientosTableBody">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mensaje cuando no hay vencimientos -->
                    <div id="noVencimientosMessage" class="text-center py-5" style="display: none;">
                        <i class="fas fa-calendar-check fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay vencimientos registrados</h5>
                        <p class="text-muted">Los vencimientos aparecerán aquí cuando se registren documentos en los módulos correspondientes.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del vencimiento -->
<div class="modal fade" id="viewVencimientoModal" tabindex="-1" aria-labelledby="viewVencimientoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewVencimientoModalLabel">Detalles del Vencimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewVencimientoContent">
                <!-- El contenido se cargará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
let vencimientosData = [];
let vencimientosFiltrados = [];

// Cargar datos al inicializar la página y cada 5 minutos
document.addEventListener('DOMContentLoaded', function() {
    loadVencimientos();
    
    // Recargar datos cada 5 minutos
    setInterval(loadVencimientos, 5 * 60 * 1000);
});

// Cargar lista de vencimientos
function loadVencimientos() {
    // Mostrar indicador de carga
    const loadingIndicator = document.createElement('div');
    loadingIndicator.id = 'loadingIndicator';
    loadingIndicator.className = 'position-fixed top-50 start-50 translate-middle bg-white p-3 rounded shadow-lg';
    loadingIndicator.innerHTML = `
        <div class="d-flex align-items-center">
            <div class="spinner-border text-primary me-2" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <span>Actualizando vencimientos...</span>
        </div>
    `;
    document.body.appendChild(loadingIndicator);

    fetch('/api/mpa/vencimientos')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                vencimientosData = data.data || [];
                vencimientosFiltrados = [...vencimientosData];
                renderVencimientos();
                actualizarEstadisticas();
                cargarTecnicosEnFiltro();
                
                // Mostrar mensaje de éxito
                showAlert('Datos de vencimientos actualizados correctamente', 'success');
            } else {
                showAlert('Error al cargar datos de vencimientos: ' + (data.error || 'Error desconocido'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar datos de vencimientos: ' + error.message, 'danger');
        })
        .finally(() => {
            // Remover indicador de carga
            const loadingIndicator = document.getElementById('loadingIndicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        });
}

// Renderizar tabla de vencimientos
function renderVencimientos() {
    const tbody = document.getElementById('vencimientosTableBody');
    const noDataMessage = document.getElementById('noVencimientosMessage');
    
    if (!tbody) return;
    
    if (vencimientosFiltrados.length === 0) {
        tbody.innerHTML = '';
        if (noDataMessage) noDataMessage.style.display = 'block';
        return;
    }
    
    if (noDataMessage) noDataMessage.style.display = 'none';
    
    tbody.innerHTML = vencimientosFiltrados.map(vencimiento => {
        const estadoBadge = getEstadoBadge(vencimiento.estado);
        const tipoBadge = getTipoBadge(vencimiento.tipo);
        const placaDisplay = vencimiento.placa || '<span class="text-muted">N/A</span>';
        
        return `
            <tr>
                <td>${tipoBadge}</td>
                <td>${placaDisplay}</td>
                <td>${formatDate(vencimiento.fecha_vencimiento)}</td>
                <td>
                    <span class="badge ${getDiasRestantesBadge(vencimiento.dias_restantes)}">
                        ${vencimiento.dias_restantes} días
                    </span>
                </td>
                <td>${estadoBadge}</td>
                <td>${vencimiento.tecnico_nombre}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary" 
                            onclick="viewVencimientoDetails('${vencimiento.tipo}', ${vencimiento.id})"
                            title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Obtener badge de estado
function getEstadoBadge(estado) {
    const badges = {
        'Vencido': 'bg-danger',
        'Próximo a vencer': 'bg-warning text-dark',
        'Vigente': 'bg-success',
        'Sin fecha': 'bg-secondary',
        'Fecha inválida': 'bg-danger'
    };
    
    const icons = {
        'Vencido': 'fas fa-exclamation-circle',
        'Próximo a vencer': 'fas fa-exclamation-triangle',
        'Vigente': 'fas fa-check-circle',
        'Sin fecha': 'fas fa-calendar-times',
        'Fecha inválida': 'fas fa-times-circle'
    };
    
    const badgeClass = badges[estado] || 'bg-secondary';
    const icon = icons[estado] ? `<i class="${icons[estado]} me-1"></i>` : '';
    return `<span class="badge ${badgeClass}">${icon}${estado}</span>`;
}

// Obtener badge de tipo
function getTipoBadge(tipo) {
    const badges = {
        'SOAT': 'bg-primary',
        'Técnico Mecánica': 'bg-info text-dark',
        'Licencia de Conducir': 'bg-warning text-dark'
    };
    
    const badgeClass = badges[tipo] || 'bg-secondary';
    return `<span class="badge ${badgeClass}">${tipo}</span>`;
}

// Obtener badge de días restantes
function getDiasRestantesBadge(dias) {
    if (dias < 0) return 'bg-danger';
    if (dias <= 30) return 'bg-warning text-dark';
    return 'bg-success';
}

// Formatear fecha
function formatDate(dateString) {
    if (!dateString || dateString === '0000-00-00') return 'Sin fecha';
    
    try {
        // Validar formato de fecha YYYY-MM-DD
        if (!/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
            console.error('Formato de fecha inválido:', dateString);
            return 'Fecha inválida';
        }
        
        // Crear fecha en zona horaria local
        const [year, month, day] = dateString.split('-').map(Number);
        const date = new Date(year, month - 1, day);
        
        // Validar que la fecha sea válida
        if (isNaN(date.getTime()) || 
            date.getFullYear() !== year || 
            date.getMonth() !== month - 1 || 
            date.getDate() !== day) {
            console.error('Fecha inválida:', dateString);
            return 'Fecha inválida';
        }
        
        // Formatear fecha
        const formattedDate = date.toLocaleDateString('es-CO', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
        
        // Calcular días restantes para el tooltip
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const diffTime = date.getTime() - today.getTime();
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        let statusText = '';
        if (diffDays < 0) {
            statusText = `Vencido hace ${Math.abs(diffDays)} días`;
        } else if (diffDays === 0) {
            statusText = 'Vence hoy';
        } else if (diffDays === 1) {
            statusText = 'Vence mañana';
        } else {
            statusText = `Vence en ${diffDays} días`;
        }
        
        return `<span title="${statusText}" class="text-nowrap">${formattedDate}</span>`;
    } catch (error) {
        console.error('Error al formatear fecha:', error, error.stack);
        return 'Error en fecha';
    }
}

// Aplicar filtros
function aplicarFiltros() {
    const filtroTipo = document.getElementById('filtroTipo')?.value || '';
    const filtroEstado = document.getElementById('filtroEstado')?.value || '';
    const filtroTecnico = document.getElementById('filtroTecnico')?.value || '';
    const filtroPlaca = document.getElementById('filtroPlaca')?.value || '';
    
    vencimientosFiltrados = vencimientosData.filter(vencimiento => {
        const cumpleTipo = !filtroTipo || vencimiento.tipo === filtroTipo;
        const cumpleEstado = !filtroEstado || vencimiento.estado === filtroEstado;
        const cumpleTecnico = !filtroTecnico || (vencimiento.tecnico_nombre || '').toLowerCase().includes(filtroTecnico.toLowerCase());
        const cumplePlaca = !filtroPlaca || (vencimiento.placa || '').toLowerCase().includes(filtroPlaca.toLowerCase());
        
        return cumpleTipo && cumpleEstado && cumpleTecnico && cumplePlaca;
    });
    
    renderVencimientos();
    actualizarEstadisticas();
}

// Limpiar filtros
function limpiarFiltros() {
    document.getElementById('filtroTipo').value = '';
    document.getElementById('filtroEstado').value = '';
    document.getElementById('filtroTecnico').value = '';
    const placaInput = document.getElementById('filtroPlaca');
    if (placaInput) placaInput.value = '';
    
    vencimientosFiltrados = [...vencimientosData];
    renderVencimientos();
    actualizarEstadisticas();
}

// Actualizar estadísticas
function actualizarEstadisticas() {
    const stats = vencimientosFiltrados.reduce((acc, vencimiento) => {
        acc.total++;
        switch (vencimiento.estado) {
            case 'Vencido':
                acc.vencidos++;
                break;
            case 'Próximo a vencer':
                acc.proximosVencer++;
                break;
            case 'Vigente':
                acc.vigentes++;
                break;
            case 'Sin fecha':
            case 'Fecha inválida':
                acc.sin_fecha++;
                break;
        }
        return acc;
    }, { total: 0, vencidos: 0, proximosVencer: 0, vigentes: 0, sin_fecha: 0 });
    
    // Actualizar contadores con animación
    animateCounter('countTotal', stats.total);
    animateCounter('countVencidos', stats.vencidos);
    animateCounter('countProximosVencer', stats.proximosVencer);
    animateCounter('countVigentes', stats.vigentes);
}

// Función para animar contadores
function animateCounter(elementId, targetValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const startValue = parseInt(element.textContent) || 0;
    const duration = 500; // duración en milisegundos
    const steps = 20; // número de pasos
    const stepValue = (targetValue - startValue) / steps;
    let currentStep = 0;
    
    const interval = setInterval(() => {
        currentStep++;
        const currentValue = Math.round(startValue + (stepValue * currentStep));
        element.textContent = currentValue;
        
        if (currentStep >= steps) {
            clearInterval(interval);
            element.textContent = targetValue; // asegurar el valor final exacto
        }
    }, duration / steps);
}

// Cargar técnicos en filtro
function cargarTecnicosEnFiltro() {
    const tecnicos = [...new Set(vencimientosData.map(v => v.tecnico_nombre))].sort();
    const filtroTecnico = document.getElementById('filtroTecnico');
    
    if (filtroTecnico) {
        // Mantener la opción "Todos los técnicos"
        const opcionTodos = filtroTecnico.querySelector('option[value=""]');
        filtroTecnico.innerHTML = '';
        filtroTecnico.appendChild(opcionTodos);
        
        tecnicos.forEach(tecnico => {
            if (tecnico && tecnico !== 'Sin asignar') {
                const option = document.createElement('option');
                option.value = tecnico;
                option.textContent = tecnico;
                filtroTecnico.appendChild(option);
            }
        });
    }
}

// Ver detalles del vencimiento
function viewVencimientoDetails(tipo, id) {
    const tipoMap = {
        'SOAT': 'soat',
        'Técnico Mecánica': 'tecnico_mecanica',
        'Tecnico Mecanica': 'tecnico_mecanica',
        'Licencia de Conducir': 'licencia_conducir'
    };
    const tipoParam = tipoMap[tipo] || tipo
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .toLowerCase().replace(/\s+/g, '_');
    
    fetch(`/api/mpa/vencimiento/${tipoParam}/${id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarDetallesVencimiento(data.data, data.tipo);
            } else {
                showAlert('Error al cargar detalles: ' + (data.error || 'Error desconocido'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar detalles: ' + error.message, 'danger');
        });
}

// Mostrar detalles en modal
function mostrarDetallesVencimiento(data, tipo) {
    const modalTitle = document.getElementById('viewVencimientoModalLabel');
    const modalContent = document.getElementById('viewVencimientoContent');
    
    if (modalTitle) {
        modalTitle.textContent = `Detalles de ${tipo}`;
    }
    
    if (modalContent) {
        modalContent.innerHTML = generarContenidoDetalle(data, tipo);
    }
    
    // Mostrar modal
    const modal = new bootstrap.Modal(document.getElementById('viewVencimientoModal'));
    modal.show();
}

// Generar contenido del detalle
function generarContenidoDetalle(data, tipo) {
    let contenido = `
        <div class="row">
            <div class="col-md-6">
                <strong>Tipo de Documento:</strong><br>
                <span class="badge ${getTipoBadge(tipo).match(/bg-\w+/)[0]} mb-2">${tipo}</span>
            </div>
            <div class="col-md-6">
                <strong>Estado:</strong><br>
                ${getEstadoBadge(data.estado_calculado)}
            </div>
        </div>
        <hr>
    `;
    
    // Campos específicos según el tipo
    if (tipo === 'SOAT') {
        contenido += `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <strong>Placa:</strong><br>
                    ${data.placa || 'N/A'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Número de Póliza:</strong><br>
                    ${data.numero_poliza || 'N/A'}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <strong>Aseguradora:</strong><br>
                    ${data.aseguradora || 'N/A'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Valor Prima:</strong><br>
                    ${data.valor_prima ? '$' + Number(data.valor_prima).toLocaleString('es-CO') : 'N/A'}
                </div>
            </div>
        `;
    } else if (tipo === 'Técnico Mecánica') {
        contenido += `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <strong>Placa:</strong><br>
                    ${data.placa || 'N/A'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Número de Certificado:</strong><br>
                    ${data.numero_certificado || 'N/A'}
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <strong>Centro de Diagnóstico:</strong><br>
                    ${data.centro_diagnostico || 'N/A'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Costo:</strong><br>
                    ${data.costo ? '$' + Number(data.costo).toLocaleString('es-CO') : 'N/A'}
                </div>
            </div>
        `;
    } else if (tipo === 'Licencia de Conducir') {
        contenido += `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <strong>Técnico:</strong><br>
                    ${data.tecnico_nombre || 'N/A'}
                </div>
                <div class="col-md-6 mb-3">
                    <strong>Cédula:</strong><br>
                    ${data.tecnico_cedula || 'N/A'}
                </div>
            </div>
        `;
    }
    
    // Fechas comunes
    contenido += `
        <div class="row">
            <div class="col-md-6 mb-3">
                <strong>Fecha de Inicio:</strong><br>
                ${formatDate(data.fecha_inicio || data.fecha_inicial) || 'N/A'}
            </div>
            <div class="col-md-6 mb-3">
                <strong>Fecha de Vencimiento:</strong><br>
                ${formatDate(data.fecha_vencimiento) || 'N/A'}
            </div>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <strong>Días Restantes:</strong><br>
                <span class="badge ${getDiasRestantesBadge(data.dias_restantes)}">${data.dias_restantes || 0} días</span>
            </div>
            <div class="col-md-6 mb-3">
                <strong>Técnico Asignado:</strong><br>
                ${data.tecnico_nombre || 'Sin asignar'}
            </div>
        </div>
    `;
    
    // Observaciones si existen
    if (data.observaciones || data.observacion) {
        contenido += `
            <div class="row">
                <div class="col-12 mb-3">
                    <strong>Observaciones:</strong><br>
                    <div class="border p-2 bg-light rounded">
                        ${data.observaciones || data.observacion || 'Sin observaciones'}
                    </div>
                </div>
            </div>
        `;
    }
    
    return contenido;
}

// Función para mostrar alertas
function showAlert(message, type = 'info') {
    // Crear elemento de alerta
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Agregar al body
    document.body.appendChild(alertDiv);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

{% endblock %}