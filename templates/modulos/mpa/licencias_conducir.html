{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;">
                    <h3 class="mb-0">
                        <i class="fas fa-id-card me-2"></i>Gestión de Licencias de Conducir - MPA
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Gestiona todas las licencias de conducir de los técnicos operativos. Aquí puedes ver, crear, actualizar y eliminar registros de licencias de conducir.
                    </div>
                    
                    <!-- Botón para crear nueva licencia -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Lista de Licencias de Conducir</h4>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#licenciaModal" onclick="openCreateModal()">
                            <i class="fas fa-plus me-2"></i>Crear Licencia
                        </button>
                    </div>
                    
                    <!-- Tabla de Licencias -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="licenciasTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Técnico</th>
                                    <th>Fecha Inicial</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Días Restantes</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="licenciasTableBody">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mensaje cuando no hay licencias -->
                    <div id="noLicenciasMessage" class="text-center py-5" style="display: none;">
                        <i class="fas fa-id-card fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay licencias registradas</h5>
                        <p class="text-muted">Haz clic en "Crear Licencia" para agregar el primer registro.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar Licencia -->
<div class="modal fade" id="licenciaModal" tabindex="-1" aria-labelledby="licenciaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="licenciaModalLabel">Crear Licencia de Conducir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="licenciaForm">
                    <input type="hidden" id="licenciaId" name="licenciaId">
                    
                    <div class="row">
                        <!-- Información del Técnico -->
                        <div class="col-md-12 mb-3">
                            <label for="tecnicoId" class="form-label">Técnico <span class="text-danger">*</span></label>
                            <select class="form-select" id="tecnicoId" name="tecnicoId" required>
                                <option value="">Seleccionar técnico</option>
                                <!-- Los técnicos se cargarán dinámicamente -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaInicial" class="form-label">Fecha Inicial <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fechaInicial" name="fechaInicial" required onchange="calculateDaysRemaining()">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fechaVencimiento" name="fechaVencimiento" required onchange="calculateDaysRemaining()">
                        </div>
                    </div>
                    
                    <!-- Información de días restantes -->
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div id="diasRestantesInfo" class="alert" style="display: none;">
                                <i class="fas fa-calendar-alt me-2"></i>
                                <span id="diasRestantesText"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3" placeholder="Observaciones adicionales sobre la licencia..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Información automática -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Nota:</strong> La fecha de registro se guardará automáticamente. Asegúrate de que las fechas sean correctas.
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveLicencia()">
                    <i class="fas fa-save me-2"></i>Guardar Licencia
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles de la Licencia -->
<div class="modal fade" id="viewLicenciaModal" tabindex="-1" aria-labelledby="viewLicenciaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewLicenciaModalLabel">Detalles de la Licencia de Conducir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewLicenciaContent">
                <!-- El contenido se cargará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentLicenciaId = null;
let tecnicos = [];

// Cargar datos al inicializar la página
document.addEventListener('DOMContentLoaded', function() {
    loadLicencias();
    loadTecnicos();
    
    // Limpiar estado cuando se cierra el modal de licencia
    const licenciaModal = document.getElementById('licenciaModal');
    if (licenciaModal) {
        licenciaModal.addEventListener('hidden.bs.modal', function() {
            currentLicenciaId = null;
            
            // Validar elementos antes de manipularlos
            const form = document.getElementById('licenciaForm');
            const licenciaId = document.getElementById('licenciaId');
            const diasRestantesInfo = document.getElementById('diasRestantesInfo');
            
            if (form) form.reset();
            if (licenciaId) licenciaId.value = '';
            if (diasRestantesInfo) diasRestantesInfo.style.display = 'none';
        });
    }
});

// Cargar lista de Licencias
function loadLicencias() {
    fetch('/api/mpa/licencias-conducir')
        .then(response => {
            if (response.status === 401) {
                showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
                return null;
            }
            if (!response.ok) {
                throw new Error('Error al cargar datos de las licencias');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                displayLicencias(data.data);
            } else if (data) {
                showAlert('Error al cargar datos de las licencias: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error al cargar datos de las licencias:', error);
            showAlert('Error al cargar datos de las licencias', 'danger');
        });
}

// Mostrar licencias en la tabla
function displayLicencias(licencias) {
    const tableBody = document.getElementById('licenciasTableBody');
    const noLicenciasMessage = document.getElementById('noLicenciasMessage');
    
    if (!tableBody) return;
    
    if (licencias.length === 0) {
        tableBody.innerHTML = '';
        if (noLicenciasMessage) noLicenciasMessage.style.display = 'block';
        return;
    }
    
    if (noLicenciasMessage) noLicenciasMessage.style.display = 'none';
    
    tableBody.innerHTML = licencias.map(licencia => {
        const diasRestantes = licencia.fecha_vencimiento ? calculateDaysRemainingFromDates(licencia.fecha_vencimiento) : 0;
        const estado = getEstadoFromDays(diasRestantes);
        const estadoBadge = getEstadoBadge(estado);
        
        return `
            <tr>
                <td>${licencia.tecnico_nombre || 'Sin asignar'}</td>
                <td>${formatDate(licencia.fecha_inicial)}</td>
                <td>${formatDate(licencia.fecha_vencimiento)}</td>
                <td class="text-center">
                    <span class="badge ${diasRestantes <= 0 ? 'bg-danger' : diasRestantes <= 30 ? 'bg-warning' : 'bg-success'}">
                        ${diasRestantes} días
                    </span>
                </td>
                <td>${estadoBadge}</td>
                <td>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="viewLicencia(${licencia.id})" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="editLicencia(${licencia.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteLicencia(${licencia.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

// Cargar lista de técnicos
function loadTecnicos() {
    fetch('/api/mpa/tecnicos')
        .then(response => {
            if (response.status === 401) {
                showAlert('Sesión expirada. Por favor, inicia sesión nuevamente.', 'warning');
                return null;
            }
            if (!response.ok) {
                throw new Error('Error al cargar técnicos');
            }
            return response.json();
        })
        .then(data => {
            if (data && data.success) {
                tecnicos = data.data;
                populateTecnicosSelect();
            } else if (data) {
                showAlert('Error al cargar técnicos: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error al cargar técnicos:', error);
            showAlert('Error al cargar técnicos', 'danger');
        });
}

// Poblar select de técnicos
function populateTecnicosSelect() {
    const tecnicoSelect = document.getElementById('tecnicoId');
    if (!tecnicoSelect) return;
    
    // Limpiar opciones existentes excepto la primera
    tecnicoSelect.innerHTML = '<option value="">Seleccionar técnico</option>';
    
    tecnicos.forEach(tecnico => {
        const option = document.createElement('option');
        option.value = tecnico.id_codigo_consumidor;
        option.textContent = tecnico.nombre;
        tecnicoSelect.appendChild(option);
    });
}

// Abrir modal para crear nueva licencia
function openCreateModal() {
    currentLicenciaId = null;
    const modalTitle = document.getElementById('licenciaModalLabel');
    const form = document.getElementById('licenciaForm');
    const diasRestantesInfo = document.getElementById('diasRestantesInfo');
    
    if (modalTitle) modalTitle.textContent = 'Crear Licencia de Conducir';
    if (form) form.reset();
    if (diasRestantesInfo) diasRestantesInfo.style.display = 'none';
    
    // Habilitar el select de técnico
    const tecnicoSelect = document.getElementById('tecnicoId');
    if (tecnicoSelect) tecnicoSelect.disabled = false;
}

// Ver detalles de una licencia
function viewLicencia(id) {
    fetch(`/api/mpa/licencias-conducir/${id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener detalles de la licencia');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.data) {
                displayLicenciaDetails(data.data);
            } else {
                showAlert('Error al obtener detalles: ' + (data.error || data.message || 'Error desconocido'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al obtener detalles de la licencia', 'danger');
        });
}

// Mostrar detalles de la licencia en el modal
function displayLicenciaDetails(licencia) {
    const content = document.getElementById('viewLicenciaContent');
    if (!content || !licencia) return;
    
    const diasRestantes = licencia && licencia.fecha_vencimiento ? calculateDaysRemainingFromDates(licencia.fecha_vencimiento) : 0;
    const estado = getEstadoFromDays(diasRestantes);
    const estadoBadge = getEstadoBadge(estado);
    
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-user me-2"></i>Información del Técnico</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Técnico:</strong> ${licencia.tecnico_nombre || 'Sin asignar'}</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>Información de Fechas</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Fecha Inicial:</strong> ${licencia.fecha_inicial ? formatDate(licencia.fecha_inicial) : 'No especificada'}</p>
                        <p><strong>Fecha Vencimiento:</strong> ${licencia.fecha_vencimiento ? formatDate(licencia.fecha_vencimiento) : 'No especificada'}</p>
                        <p><strong>Días Restantes:</strong> 
                            <span class="badge ${diasRestantes <= 0 ? 'bg-danger' : diasRestantes <= 30 ? 'bg-warning' : 'bg-success'}">
                                ${diasRestantes} días
                            </span>
                        </p>
                        <p><strong>Estado:</strong> ${estadoBadge}</p>
                    </div>
                </div>
            </div>
        </div>
        ${licencia.observaciones ? `
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-comment me-2"></i>Observaciones</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0">${licencia.observaciones}</p>
                    </div>
                </div>
            </div>
        </div>
        ` : ''}
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información del Sistema</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Fecha de Registro:</strong> ${formatDateTime(licencia.created_at)}</p>
                        ${licencia.updated_at ? `<p><strong>Última Actualización:</strong> ${formatDateTime(licencia.updated_at)}</p>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('viewLicenciaModal'));
    modal.show();
}

// Editar licencia
function editLicencia(id) {
    fetch(`/api/mpa/licencias-conducir/${id}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Error al obtener datos de la licencia');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.data) {
                populateEditForm(data.data);
            } else {
                showAlert('Error al obtener datos: ' + (data.error || data.message || 'Error desconocido'), 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al obtener datos de la licencia', 'danger');
        });
}

// Poblar formulario para edición
function populateEditForm(licencia) {
    if (!licencia) {
        showAlert('Error: No se recibieron datos de la licencia', 'danger');
        return;
    }
    
    currentLicenciaId = licencia.id;
    
    const modalTitle = document.getElementById('licenciaModalLabel');
    const licenciaIdInput = document.getElementById('licenciaId');
    const tecnicoSelect = document.getElementById('tecnicoId');
    const fechaInicial = document.getElementById('fechaInicial');
    const fechaVencimiento = document.getElementById('fechaVencimiento');
    const observaciones = document.getElementById('observaciones');
    
    if (modalTitle) modalTitle.textContent = 'Editar Licencia de Conducir';
    if (licenciaIdInput) licenciaIdInput.value = licencia.id || '';
    if (tecnicoSelect) {
        tecnicoSelect.value = licencia.tecnico_id || '';
        tecnicoSelect.disabled = true; // No permitir cambiar el técnico en edición
    }
    if (fechaInicial) fechaInicial.value = licencia.fecha_inicial || '';
    if (fechaVencimiento) fechaVencimiento.value = licencia.fecha_vencimiento || '';
    if (observaciones) observaciones.value = licencia.observaciones || '';
    
    // Calcular días restantes
    calculateDaysRemaining();
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('licenciaModal'));
    modal.show();
}

// Guardar licencia (crear o actualizar)
function saveLicencia() {
    const form = document.getElementById('licenciaForm');
    if (!form) return;
    
    const formData = new FormData(form);
    const licenciaData = {
        tecnico_id: formData.get('tecnicoId'),
        fecha_inicial: formData.get('fechaInicial'),
        fecha_vencimiento: formData.get('fechaVencimiento'),
        observaciones: formData.get('observaciones')
    };
    
    // Validaciones
    if (!licenciaData.tecnico_id) {
        showAlert('Por favor selecciona un técnico', 'warning');
        return;
    }
    
    if (!licenciaData.fecha_inicial || !licenciaData.fecha_vencimiento) {
        showAlert('Por favor completa todas las fechas requeridas', 'warning');
        return;
    }
    
    if (new Date(licenciaData.fecha_inicial) >= new Date(licenciaData.fecha_vencimiento)) {
        showAlert('La fecha de vencimiento debe ser posterior a la fecha inicial', 'warning');
        return;
    }
    
    const isEdit = currentLicenciaId !== null;
    const url = isEdit ? `/api/mpa/licencias-conducir/${currentLicenciaId}` : '/api/mpa/licencias-conducir';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(licenciaData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al guardar la licencia');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert(isEdit ? 'Licencia actualizada exitosamente' : 'Licencia creada exitosamente', 'success');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('licenciaModal'));
            if (modal) modal.hide();
            
            // Recargar tabla
            loadLicencias();
        } else {
            showAlert('Error al guardar: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error al guardar la licencia', 'danger');
    });
}

// Eliminar licencia
function deleteLicencia(id) {
    if (!confirm('¿Estás seguro de que deseas eliminar esta licencia de conducir?')) {
        return;
    }
    
    fetch(`/api/mpa/licencias-conducir/${id}`, {
        method: 'DELETE'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error al eliminar la licencia');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('Licencia eliminada exitosamente', 'success');
            loadLicencias();
        } else {
            showAlert('Error al eliminar: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error al eliminar la licencia', 'danger');
    });
}

// Calcular días restantes
function calculateDaysRemaining() {
    const fechaVencimiento = document.getElementById('fechaVencimiento');
    const diasRestantesInfo = document.getElementById('diasRestantesInfo');
    const diasRestantesText = document.getElementById('diasRestantesText');
    
    if (!fechaVencimiento || !fechaVencimiento.value || !diasRestantesInfo || !diasRestantesText) {
        return;
    }
    
    const diasRestantes = calculateDaysRemainingFromDates(fechaVencimiento.value);
    const estado = getEstadoFromDays(diasRestantes);
    
    let alertClass = 'alert-success';
    let icon = 'fas fa-check-circle';
    
    if (diasRestantes <= 0) {
        alertClass = 'alert-danger';
        icon = 'fas fa-exclamation-triangle';
    } else if (diasRestantes <= 30) {
        alertClass = 'alert-warning';
        icon = 'fas fa-exclamation-circle';
    }
    
    diasRestantesInfo.className = `alert ${alertClass}`;
    diasRestantesText.innerHTML = `<i class="${icon} me-2"></i>Días restantes: <strong>${diasRestantes}</strong> - Estado: <strong>${estado}</strong>`;
    diasRestantesInfo.style.display = 'block';
}

// Calcular días restantes desde fechas
function calculateDaysRemainingFromDates(fechaVencimiento) {
    if (!fechaVencimiento) {
        return 0;
    }
    
    const today = new Date();
    const vencimiento = new Date(fechaVencimiento);
    
    // Verificar si la fecha es válida
    if (isNaN(vencimiento.getTime())) {
        return 0;
    }
    
    const diffTime = vencimiento - today;
    return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

// Obtener estado desde días
function getEstadoFromDays(diasRestantes) {
    if (diasRestantes <= 0) {
        return 'Vencido';
    } else if (diasRestantes <= 30) {
        return 'Próximo a vencer';
    } else {
        return 'Vigente';
    }
}

// Obtener badge de estado
function getEstadoBadge(estado) {
    switch (estado) {
        case 'Vigente':
            return '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Vigente</span>';
        case 'Próximo a vencer':
            return '<span class="badge bg-warning"><i class="fas fa-exclamation-circle me-1"></i>Próximo a vencer</span>';
        case 'Vencido':
            return '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Vencido</span>';
        default:
            return '<span class="badge bg-secondary">Desconocido</span>';
    }
}

// Formatear fecha
function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('es-CO');
}

// Formatear fecha y hora
function formatDateTime(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    const date = new Date(dateTimeString);
    return date.toLocaleString('es-CO');
}

// Mostrar alerta
function showAlert(message, type = 'info') {
    // Crear elemento de alerta
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Agregar al body
    document.body.appendChild(alertDiv);
    
    // Auto-remover después de 5 segundos
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>

{% endblock %}