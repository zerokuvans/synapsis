{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;">
                    <h3 class="mb-0">
                        <i class="fas fa-car me-2"></i>Gestión de Vehículos - MPA
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Gestiona el inventario completo de vehículos de la flota. Aquí puedes ver, crear, actualizar y eliminar vehículos.
                    </div>
                    
                    <!-- Botón para crear nuevo vehículo y cargar Excel -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="mb-0">Lista de Vehículos</h4>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#vehicleModal" onclick="openCreateModal()">
                                <i class="fas fa-plus me-2"></i>Crear Vehículo
                            </button>
                            <input type="file" id="excelFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                            <button type="button" class="btn btn-success" onclick="document.getElementById('excelFileInput').click()">
                                <i class="fas fa-file-upload me-2"></i>Cargar Excel
                            </button>
                            <select id="filterTechnician" class="form-select" style="max-width:220px"></select>
                            <input type="text" id="exportPlaca" class="form-control" placeholder="Filtrar por placa" style="max-width:180px">
                            <button type="button" class="btn btn-outline-secondary" onclick="exportVehiclesCSV()">
                                <i class="fas fa-file-csv me-2"></i>Exportar CSV
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tabla de vehículos -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="vehiclesTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Placa</th>
                                    <th>Técnico Asignado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="vehiclesTableBody">
                                <!-- Los datos se cargarán dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Mensaje cuando no hay vehículos -->
                    <div id="noVehiclesMessage" class="text-center py-5" style="display: none;">
                        <i class="fas fa-car fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay vehículos registrados</h5>
                        <p class="text-muted">Haz clic en "Crear Vehículo" para agregar el primer vehículo.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar vehículo -->
<div class="modal fade" id="vehicleModal" tabindex="-1" aria-labelledby="vehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vehicleModalLabel">Crear Vehículo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="vehicleForm">
                    <input type="hidden" id="vehicleId" name="vehicleId">
                    
                    <div class="row">
                        <!-- Información del Propietario -->
                        <div class="col-md-6 mb-3">
                            <label for="cedulaPropietario" class="form-label">Cédula del Propietario <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="cedulaPropietario" name="cedulaPropietario" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="nombrePropietario" class="form-label">Nombre del Propietario <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="nombrePropietario" name="nombrePropietario" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Información del Vehículo -->
                        <div class="col-md-6 mb-3">
                            <label for="placa" class="form-label">Placa <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="placa" name="placa" required style="text-transform: uppercase;">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tipoVehiculo" class="form-label">Tipo de Vehículo <span class="text-danger">*</span></label>
                            <select class="form-select" id="tipoVehiculo" name="tipoVehiculo" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="Moto">Moto</option>
                                <option value="Camioneta">Camioneta</option>
                                
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="vin" class="form-label">VIN <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="vin" name="vin" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="numeroMotor" class="form-label">Número de Motor <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="numeroMotor" name="numeroMotor" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaMatricula" class="form-label">Fecha de Matrícula <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="fechaMatricula" name="fechaMatricula" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="estado" class="form-label">Estado <span class="text-danger">*</span></label>
                            <select class="form-select" id="estado" name="estado" required>
                                <option value="">Seleccionar estado</option>
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="marca" class="form-label">Marca <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="marca" name="marca" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="linea" class="form-label">Línea <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="linea" name="linea" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="modelo" class="form-label">Modelo <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="modelo" name="modelo" required min="1900" max="2030">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="color" class="form-label">Color <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="color" name="color" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="kilometrajeActual" class="form-label">Kilometraje Actual <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="kilometrajeActual" name="kilometrajeActual" required min="0">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tecnicoAsignado" class="form-label">Técnico Asignado <span class="text-danger">*</span></label>
                            <select class="form-select" id="tecnicoAsignado" name="tecnicoAsignado" required>
                                <option value="">Seleccionar técnico</option>
                                <!-- Los técnicos se cargarán dinámicamente -->
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" name="observaciones" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveVehicle()">
                    <i class="fas fa-save me-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver detalles del vehículo -->
<div class="modal fade" id="viewVehicleModal" tabindex="-1" aria-labelledby="viewVehicleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewVehicleModalLabel">Detalles del Vehículo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewVehicleContent">
                <!-- El contenido se cargará dinámicamente -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentVehicleId = null;
let technicians = [];
let currentCronogramaData = null;
let currentCronogramaPlaca = null;

// Cargar datos al inicializar la página
document.addEventListener('DOMContentLoaded', function() {
    loadVehicles();
    loadTechnicians();
});

document.addEventListener('DOMContentLoaded', function() {
    const ep = document.getElementById('exportPlaca');
    const ft = document.getElementById('filterTechnician');
    if (ep) {
        ep.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') { loadVehicles(); }
        });
    }
    if (ft) {
        ft.addEventListener('change', function() { loadVehicles(); });
    }
});

function exportVehiclesCSV() {
    const placa = (document.getElementById('exportPlaca')?.value || '').trim().toUpperCase();
    const tecnico = (document.getElementById('filterTechnician')?.value || '').trim();
    let url = '/api/mpa/vehiculos/export';
    const params = [];
    if (placa) params.push(`placa=${encodeURIComponent(placa)}`);
    if (tecnico) params.push(`tecnico=${encodeURIComponent(tecnico)}`);
    if (params.length) url += `?${params.join('&')}`;
    window.location.href = url;
}

// Listener para cargar Excel
document.addEventListener('DOMContentLoaded', function() {
    const excelInput = document.getElementById('excelFileInput');
    if (excelInput) {
        excelInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                uploadVehiclesExcel(this.files[0]);
                // Reset input para permitir volver a seleccionar el mismo archivo
                this.value = '';
            }
        });
    }
});

// Subir y procesar Excel de vehículos
function uploadVehiclesExcel(file) {
    const formData = new FormData();
    formData.append('file', file);

    showAlert('Subiendo archivo, por favor espere...', 'info');

    fetch('/api/mpa/vehiculos/import-excel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const inserted = data.inserted || 0;
            const updated = data.updated || 0;
            const skipped = data.skipped || 0;
            showAlert(`Importación completada: ${inserted} nuevos, ${updated} actualizados, ${skipped} omitidos`, 'success');
            loadVehicles();
        } else {
            showAlert('Error en importación: ' + (data.error || data.message || 'Error desconocido'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error subiendo el archivo', 'danger');
    });
}

// Cargar lista de vehículos
function loadVehicles() {
    const placa = (document.getElementById('exportPlaca')?.value || '').trim().toUpperCase();
    const tecnico = (document.getElementById('filterTechnician')?.value || '').trim();
    let url = '/api/mpa/vehiculos';
    const params = [];
    if (placa) params.push(`placa=${encodeURIComponent(placa)}`);
    if (tecnico) params.push(`tecnico=${encodeURIComponent(tecnico)}`);
    if (params.length) url += `?${params.join('&')}`;
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayVehicles(data.data);
            } else {
                showAlert('Error al cargar vehículos: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar vehículos', 'danger');
        });
}

// Mostrar vehículos en la tabla
function displayVehicles(vehicles) {
    const tbody = document.getElementById('vehiclesTableBody');
    const noVehiclesMessage = document.getElementById('noVehiclesMessage');
    const table = document.getElementById('vehiclesTable');
    
    if (vehicles.length === 0) {
        table.style.display = 'none';
        noVehiclesMessage.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    noVehiclesMessage.style.display = 'none';
    
    tbody.innerHTML = vehicles.map(vehicle => `
        <tr>
            <td><strong>${vehicle.placa}</strong></td>
            <td>${vehicle.tecnico_nombre || 'Sin asignar'}</td>
            <td>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-info" onclick="viewVehicle(${vehicle.id_mpa_vehiculos})" title="Ver detalles">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="editVehicle(${vehicle.id_mpa_vehiculos})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="openCronograma('${vehicle.placa}')" title="Cronograma">
                        <i class="fas fa-calendar"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="deleteVehicle(${vehicle.id_mpa_vehiculos}, '${vehicle.placa}')" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

// Cargar lista de técnicos
function loadTechnicians() {
    fetch('/api/mpa/tecnicos')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                technicians = data.data;
                const select = document.getElementById('tecnicoAsignado');
                select.innerHTML = '<option value="">Seleccionar técnico</option>' +
                    technicians.map(tech => `<option value="${tech.id_codigo_consumidor}">${tech.nombre}</option>`).join('');
                const filter = document.getElementById('filterTechnician');
                if (filter) {
                    const opts = [{ value: '', text: 'Todos los técnicos' }].concat(
                        technicians.map(tech => ({ value: String(tech.id_codigo_consumidor), text: tech.nombre }))
                    );
                    filter.innerHTML = opts.map(o => `<option value="${o.value}">${o.text}</option>`).join('');
                }
            } else {
                showAlert('Error al cargar técnicos: ' + data.message, 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar técnicos', 'warning');
        });
}

// Abrir modal para crear vehículo
function openCreateModal() {
    currentVehicleId = null;
    document.getElementById('vehicleModalLabel').textContent = 'Crear Vehículo';
    document.getElementById('vehicleForm').reset();
    document.getElementById('vehicleId').value = '';
}

// Ver detalles del vehículo
function viewVehicle(vehicleId) {
    fetch(`/api/mpa/vehiculos/${vehicleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const vehicle = data.data;
                const content = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">Información del Propietario</h6>
                            <p><strong>Cédula:</strong> ${vehicle.cedula_propietario}</p>
                            <p><strong>Nombre:</strong> ${vehicle.nombre_propietario}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Información del Vehículo</h6>
                            <p><strong>Placa:</strong> ${vehicle.placa}</p>
                            <p><strong>Tipo:</strong> ${vehicle.tipo_vehiculo}</p>
                            <p><strong>Estado:</strong> <span class="badge ${vehicle.estado === 'Activo' ? 'bg-success' : 'bg-secondary'}">${vehicle.estado}</span></p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-primary">Especificaciones</h6>
                            <p><strong>VIN:</strong> ${vehicle.vin}</p>
                            <p><strong>Número de Motor:</strong> ${vehicle.numero_de_motor}</p>
                            <p><strong>Marca:</strong> ${vehicle.marca}</p>
                            <p><strong>Línea:</strong> ${vehicle.linea}</p>
                            <p><strong>Modelo:</strong> ${vehicle.modelo}</p>
                            <p><strong>Color:</strong> ${vehicle.color}</p>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">Información Adicional</h6>
                            <p><strong>Fecha de Matrícula:</strong> ${vehicle.fecha_de_matricula}</p>
                            <p><strong>Kilometraje Actual:</strong> ${vehicle.kilometraje_actual} km</p>
                            <p><strong>Técnico Asignado:</strong> ${vehicle.tecnico_nombre || 'Sin asignar'}</p>
                            <p><strong>Fecha de Creación:</strong> ${new Date(vehicle.fecha_creacion).toLocaleString()}</p>
                            ${vehicle.observaciones ? `<p><strong>Observaciones:</strong> ${vehicle.observaciones}</p>` : ''}
                        </div>
                    </div>
                `;
                document.getElementById('viewVehicleContent').innerHTML = content;
                new bootstrap.Modal(document.getElementById('viewVehicleModal')).show();
            } else {
                showAlert('Error al cargar detalles del vehículo: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar detalles del vehículo', 'danger');
        });
}

// Editar vehículo
function editVehicle(vehicleId) {
    fetch(`/api/mpa/vehiculos/${vehicleId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const vehicle = data.data;
                currentVehicleId = vehicleId;
                
                document.getElementById('vehicleModalLabel').textContent = 'Editar Vehículo';
                document.getElementById('vehicleId').value = vehicleId;
                document.getElementById('cedulaPropietario').value = vehicle.cedula_propietario;
                document.getElementById('nombrePropietario').value = vehicle.nombre_propietario;
                document.getElementById('placa').value = vehicle.placa;
                document.getElementById('tipoVehiculo').value = vehicle.tipo_vehiculo;
                document.getElementById('vin').value = vehicle.vin;
                document.getElementById('numeroMotor').value = vehicle.numero_de_motor;
                document.getElementById('fechaMatricula').value = vehicle.fecha_de_matricula;
                document.getElementById('estado').value = vehicle.estado;
                document.getElementById('marca').value = vehicle.marca;
                document.getElementById('linea').value = vehicle.linea;
                document.getElementById('modelo').value = vehicle.modelo;
                document.getElementById('color').value = vehicle.color;
                document.getElementById('kilometrajeActual').value = vehicle.kilometraje_actual;
                document.getElementById('tecnicoAsignado').value = vehicle.tecnico_asignado;
                document.getElementById('observaciones').value = vehicle.observaciones || '';
                
                new bootstrap.Modal(document.getElementById('vehicleModal')).show();
            } else {
                showAlert('Error al cargar datos del vehículo: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al cargar datos del vehículo', 'danger');
        });
}

// Guardar vehículo (crear o actualizar)
function saveVehicle() {
    const form = document.getElementById('vehicleForm');
    const formData = new FormData(form);
    
    // Validar campos requeridos
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const vehicleData = {
        cedula_propietario: formData.get('cedulaPropietario'),
        nombre_propietario: formData.get('nombrePropietario'),
        placa: formData.get('placa').toUpperCase(),
        tipo_vehiculo: formData.get('tipoVehiculo'),
        vin: formData.get('vin'),
        numero_de_motor: formData.get('numeroMotor'),
        fecha_de_matricula: formData.get('fechaMatricula'),
        estado: formData.get('estado'),
        marca: formData.get('marca'),
        linea: formData.get('linea'),
        modelo: formData.get('modelo'),
        color: formData.get('color'),
        kilometraje_actual: formData.get('kilometrajeActual'),
        tecnico_asignado: formData.get('tecnicoAsignado'),
        observaciones: formData.get('observaciones')
    };
    
    const url = currentVehicleId ? `/api/mpa/vehiculos/${currentVehicleId}` : '/api/mpa/vehiculos';
    const method = currentVehicleId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(vehicleData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(currentVehicleId ? 'Vehículo actualizado exitosamente' : 'Vehículo creado exitosamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('vehicleModal')).hide();
            loadVehicles();
        } else {
            showAlert('Error: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error al guardar el vehículo', 'danger');
    });
}

// Eliminar vehículo
function deleteVehicle(vehicleId, placa) {
    if (confirm(`¿Está seguro de que desea eliminar el vehículo con placa ${placa}?`)) {
        fetch(`/api/mpa/vehiculos/${vehicleId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Vehículo eliminado exitosamente', 'success');
                loadVehicles();
            } else {
                showAlert('Error al eliminar vehículo: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error al eliminar vehículo', 'danger');
        });
    }
}

// Mostrar alertas
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    const container = document.querySelector('.container');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Convertir placa a mayúsculas mientras se escribe
document.getElementById('placa').addEventListener('input', function() {
    this.value = this.value.toUpperCase();
});

function openCronograma(placa) {
    currentCronogramaPlaca = placa;
    const placaInput = document.getElementById('cronogramaPlaca');
    if (placaInput) placaInput.value = placa;
    currentCronogramaData = null;
    fetch(`/api/mpa/cronograma/${placa}`)
        .then(r => r.json())
        .then(data => {
            const freqInput = document.getElementById('cronogramaFrecuencia');
            const avgInput = document.getElementById('cronogramaPromedioDiario');
            if (data.success) {
                currentCronogramaData = data.cronograma;
                const freq = parseInt(currentCronogramaData.kilometraje_frecuencia || 2500, 10);
                if (freqInput) freqInput.value = isNaN(freq) ? 2500 : freq;
                const avg = parseInt(currentCronogramaData.kilometraje_promedio_diario || 80, 10);
                if (avgInput) avgInput.value = isNaN(avg) ? 80 : avg;
            } else {
                if (freqInput) freqInput.value = 2500;
                if (avgInput) avgInput.value = 80;
            }
            if (freqInput) freqInput.addEventListener('input', updateCronogramaPreview);
            if (avgInput) avgInput.addEventListener('input', updateCronogramaPreview);
            updateCronogramaPreview();
            const modalEl = document.getElementById('cronogramaModal');
            if (modalEl) new bootstrap.Modal(modalEl).show();
        })
        .catch(() => {
            const freqInput = document.getElementById('cronogramaFrecuencia');
            const avgInput = document.getElementById('cronogramaPromedioDiario');
            if (freqInput) freqInput.value = 2500;
            if (avgInput) avgInput.value = 80;
            const modalEl = document.getElementById('cronogramaModal');
            if (modalEl) new bootstrap.Modal(modalEl).show();
        });
}

function saveCronograma() {
    const form = document.getElementById('cronogramaForm');
    if (form && !form.checkValidity()) { form.reportValidity(); return; }
    const frecuencia = parseInt(document.getElementById('cronogramaFrecuencia')?.value || '0', 10);
    const payload = {
        placa: currentCronogramaPlaca,
        kilometraje_frecuencia: frecuencia,
        kilometraje_promedio_diario: parseInt(document.getElementById('cronogramaPromedioDiario')?.value || '80', 10)
    };
    if (currentCronogramaData) {
        payload.kilometraje_actual = currentCronogramaData.kilometraje_actual || 0;
        payload.kilometraje_promedio_diario = currentCronogramaData.kilometraje_promedio_diario || 80;
        payload.fecha_mantenimiento = currentCronogramaData.fecha_mantenimiento || null;
        payload.estado = currentCronogramaData.estado || 'Activo';
        payload.observaciones = currentCronogramaData.observaciones || null;
    } else {
        payload.kilometraje_promedio_diario = 80;
        payload.estado = 'Activo';
    }
    fetch('/api/mpa/cronograma', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showAlert('Frecuencia actualizada', 'success');
            const modalEl = document.getElementById('cronogramaModal');
            if (modalEl) bootstrap.Modal.getInstance(modalEl).hide();
        } else {
            showAlert('Error: ' + (data.message || 'No se pudo guardar'), 'danger');
        }
    })
    .catch(() => {
        showAlert('Error al guardar', 'danger');
    });
}

function updateCronogramaPreview() {
    const freq = parseInt(document.getElementById('cronogramaFrecuencia')?.value || '0', 10);
    const avg = parseInt(document.getElementById('cronogramaPromedioDiario')?.value || '0', 10);
    const kmAct = parseInt(String((currentCronogramaData && currentCronogramaData.kilometraje_actual) || 0), 10);
    const nextKm = (isNaN(kmAct) ? 0 : kmAct) + (isNaN(freq) ? 0 : freq);
    const kmEl = document.getElementById('cronogramaPreviewKm');
    const fechaEl = document.getElementById('cronogramaPreviewFecha');
    const diasEl = document.getElementById('cronogramaPreviewDias');
    if (kmEl) kmEl.textContent = `Próximo km: ${nextKm}`;
    let base = null;
    try {
        const s = (currentCronogramaData && currentCronogramaData.fecha_mantenimiento) || '';
        base = s ? new Date(s) : new Date();
    } catch (e) {
        base = new Date();
    }
    const days = Math.max(0, Math.floor((isNaN(freq) ? 0 : freq) / Math.max(1, (isNaN(avg) ? 0 : avg))));
    const d2 = new Date(base.getTime());
    d2.setDate(d2.getDate() + days);
    const yyyy = d2.getFullYear();
    const mm = String(d2.getMonth() + 1).padStart(2, '0');
    const dd = String(d2.getDate()).padStart(2, '0');
    const fstr = `${yyyy}-${mm}-${dd}`;
    if (fechaEl) fechaEl.textContent = `Fecha estimada: ${fstr}`;
    if (diasEl) diasEl.textContent = `≈ ${days} días`;
}
</script>
<div class="modal fade" id="cronogramaModal" tabindex="-1" aria-labelledby="cronogramaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cronogramaModalLabel">Frecuencia cambio de aceite</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cronogramaForm">
                    <div class="mb-3">
                        <label class="form-label">Placa</label>
                        <input type="text" class="form-control" id="cronogramaPlaca" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Frecuencia (km)</label>
                        <input type="number" class="form-control" id="cronogramaFrecuencia" min="500" step="100" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Promedio diario (km)</label>
                        <input type="number" class="form-control" id="cronogramaPromedioDiario" min="1" step="1" required>
                    </div>
                </form>
                <div id="cronogramaPreview" class="border rounded p-2">
                    <div id="cronogramaPreviewKm"></div>
                    <div id="cronogramaPreviewFecha"></div>
                    <div id="cronogramaPreviewDias"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="saveCronograma()">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
