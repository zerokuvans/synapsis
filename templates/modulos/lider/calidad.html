{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-info text-white">
          <h3 class="mb-0"><i class="fas fa-star me-2"></i>Operaciones de Calidad</h3>
        </div>
        <div class="card-body">
          <p class="text-muted mb-3">Cargar base de calidad con columnas: Cuenta, OT, Garantia, Causa, Lider, Agenda, Fecha, Cedula.</p>
          <button class="btn btn-info text-white" data-bs-toggle="modal" data-bs-target="#modalCargarCalidad">
            <i class="fas fa-upload me-2"></i>Cargar calidad
          </button>
          <div class="row mt-3">
            <div class="col-md-4">
              <label class="form-label">Periodo</label>
              <input type="month" class="form-control" id="filtroPeriodoCalidad" />
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-outline-info w-100" id="btnFiltrarCalidad"><i class="fas fa-filter me-2"></i>Filtrar</button>
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-outline-secondary w-100" id="btnRefrescarCalidad"><i class="fas fa-sync me-2"></i>Refrescar</button>
            </div>
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-striped table-hover" id="tablaCalidad">
              <thead>
                <tr>
                  <th>Cédula</th>
                  <th>Carpeta</th>
                  <th>Técnico</th>
                  <th>OKs</th>
                  <th>Calidad</th>
                  <th>% Calidad</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div class="mt-2" id="mensajeCalidad"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalCargarCalidad" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-file-excel me-2"></i>Subir archivo de calidad</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formCargarCalidad">
            <div class="mb-3">
              <label class="form-label">Archivo</label>
              <input type="file" class="form-control" id="archivoCalidad" accept=".xlsx,.xls,.csv" required />
            </div>
            <div class="mb-3">
              <label class="form-label">Periodo (mes)</label>
              <input type="month" class="form-control" id="periodoCargaCalidad" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-info text-white" id="btnSubirCalidad">Subir</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const __btnSubirCalidad = document.getElementById('btnSubirCalidad');
if(__btnSubirCalidad){
__btnSubirCalidad.addEventListener('click', async function(){
  const input = document.getElementById('archivoCalidad');
  if (!input.files || !input.files[0]) {
    Swal.fire({icon:'warning', title:'Seleccione un archivo'});
    return;
  }
  const formData = new FormData();
  formData.append('file', input.files[0]);
  try {
    let periodo = document.getElementById('periodoCargaCalidad')?.value || '';
    if(!periodo){
      const pf = document.getElementById('filtroPeriodoCalidad')?.value || '';
      periodo = pf;
    }
    if(periodo){ formData.append('periodo', periodo); }
  } catch(_){ }
  try {
    const endpoint = "{{ api_endpoint or '/api/lider/cargar-calidad' }}";
    const res = await fetch(endpoint, { method:'POST', body: formData });
    const data = await res.json();
    if (res.ok && data.success) {
      const msg = data.message || `Insertadas: ${data.rows_inserted || 0}`;
      Swal.fire({icon:'success', title:'Cargado', text: msg});
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalCargarCalidad'));
      modal && modal.hide();
      document.getElementById('formCargarCalidad').reset();
      cargarListaCalidad();
    } else {
      Swal.fire({icon:'error', title:'Error', text:data.message || 'Error al cargar'});
    }
  } catch (e) {
    Swal.fire({icon:'error', title:'Error de red'});
  }
});
}

async function cargarListaCalidad(){
  const periodo = document.getElementById('filtroPeriodoCalidad')?.value || '';
  let url = '/api/lider/calidad/list';
  const p = [];
  if(periodo) p.push(`periodo=${encodeURIComponent(periodo)}`);
  if(p.length) url += `?${p.join('&')}`;
  try{
    const res = await fetch(url);
    const data = await res.json();
    const items = Array.isArray(data.items) ? data.items : [];
    renderTablaCalidad(items);
  }catch(_){ }
}

function renderTablaCalidad(items){
  const tbody = document.querySelector('#tablaCalidad tbody');
  const mensaje = document.getElementById('mensajeCalidad');
  if(!tbody) return;
  tbody.innerHTML = '';
  if(Array.isArray(items) && items.length === 0){
    if(mensaje){
      mensaje.innerHTML = '<div class="alert alert-warning mb-0">Sin datos para el periodo seleccionado.</div>';
    }
    return;
  } else {
    if(mensaje){ mensaje.innerHTML = ''; }
  }
  items.forEach(it => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${it.cedula ?? ''}</td>
      <td>${it.carpeta ?? ''}</td>
      <td>${it.tecnico_nombre ?? ''}</td>
      <td>${fmtInt(it.oks)}</td>
      <td>${fmtInt(it.calidad)}</td>
      <td>${fmtPorc(it.porcentaje_calidad)}</td>
    `;
    tbody.appendChild(tr);
  });
}

function fmtInt(v){
  const n = Number(v);
  return Number.isFinite(n) ? String(Math.round(n)) : '';
}
function fmtPorc(v){
  const n = Number(v);
  return Number.isFinite(n) ? `${n.toFixed(2)}%` : '';
}

document.addEventListener('DOMContentLoaded', () => {
  const inputPeriodo = document.getElementById('filtroPeriodoCalidad');
  const periodoCarga = document.getElementById('periodoCargaCalidad');
  try{
    if(inputPeriodo && !inputPeriodo.value){
      const nowStr = new Date().toLocaleString('en-US', { timeZone: 'America/Bogota' });
      const now = new Date(nowStr);
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      inputPeriodo.value = `${yyyy}-${mm}`;
    }
    if(periodoCarga && !periodoCarga.value){
      const nowStr = new Date().toLocaleString('en-US', { timeZone: 'America/Bogota' });
      const now = new Date(nowStr);
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      periodoCarga.value = `${yyyy}-${mm}`;
    }
  }catch(_){ }
  cargarListaCalidad();
});
document.getElementById('btnFiltrarCalidad')?.addEventListener('click', cargarListaCalidad);
document.getElementById('btnRefrescarCalidad')?.addEventListener('click', cargarListaCalidad);
</script>
{% endblock %}
