{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Actividades Diarias</h3>
        </div>
        <div class="card-body">
          {% if not mostrar_cargue %}
          <div class="accordion" id="accordionAnalistas">
            <div class="accordion-item">
              <h2 class="accordion-header" id="accCierreHeader">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#accCierre" aria-expanded="true" aria-controls="accCierre">
                  Cierre de Ciclo
                </button>
              </h2>
              <div id="accCierre" class="accordion-collapse collapse show" aria-labelledby="accCierreHeader" data-bs-parent="#accordionAnalistas">
                <div class="accordion-body">
                  <div id="analistasMetricCards" class="row g-3 mt-2">
                    <div class="col-md-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Meta mensual</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardMetaValor">260</span>
                            <span class="badge bg-dark" id="cardMetaLabel">Cierre de ciclo</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Gestionado</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardGestionadaValor">0</span>
                            <span class="badge bg-primary" id="cardGestionadaPct">0%</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Calidad cierre de ciclo</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardCalidadPct">0%</span>
                            <span class="badge bg-secondary" id="cardCalidadBase">sobre 0 cierres</span>
                          </div>
                          <div class="mt-2">
                            <span class="badge bg-info" id="cardCalidadesAplicadas" style="cursor:pointer">calidades aplicadas: 0</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-3">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Reconocimiento</h6>
                          <div class="d-flex align-items-center justify-content-start">
                            <img id="cardMonedaImg" src="" alt="Reconocimiento" style="height:96px; display:none;" />
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="accEfectHeader">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accEfect" aria-expanded="false" aria-controls="accEfect">
                  Efectividad
                </button>
              </h2>
              <div id="accEfect" class="accordion-collapse collapse" aria-labelledby="accEfectHeader" data-bs-parent="#accordionAnalistas">
                <div class="accordion-body">
                  <div id="efectividadCards" class="row g-3 mt-2">
                    <div class="col-md-2">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Agenda</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardEfectAgendaVal">0%</span>
                          </div>
                          <div class="mt-1">
                            <span class="badge bg-dark" id="cardEfectAgendaLbl">Efectividad agenda</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">OKs</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardEfectOKsVal">0%</span>
                          </div>
                          <div class="mt-1">
                            <span class="badge bg-primary" id="cardEfectOKsLbl">OKs efectivos</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Razón</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardEfectRazonVal">0%</span>
                          </div>
                          <div class="mt-1">
                            <span class="badge bg-secondary" id="cardEfectRazonLbl">Razón efectiva</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">KPI</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardEfectKPIVAl">0%</span>
                          </div>
                          <div class="mt-1">
                            <span class="badge bg-info" id="cardEfectKPILbl">KPI efectivo</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Reconocimiento</h6>
                          <div class="d-flex align-items-center justify-content-start">
                            <img id="cardEfectReconImg" src="" alt="Reconocimiento" style="height:96px; display:none;" />
                          </div>
                          <div class="mt-2" id="efectReconLista"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="accordion-item">
              <h2 class="accordion-header" id="accPresHeader">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accPres" aria-expanded="false" aria-controls="accPres">
                  Presupuesto
                </button>
              </h2>
              <div id="accPres" class="accordion-collapse collapse" aria-labelledby="accPresHeader" data-bs-parent="#accordionAnalistas">
                <div class="accordion-body">
                  <div id="presupuestoCards" class="row g-3 mt-2">
                    <div class="col-md-2">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Objetivo mes</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardPresObjVal">0</span>
                          </div>
                          <div class="mt-1">
                            <span class="badge bg-dark" id="cardPresObjLbl">Meta mensual</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Debería ir</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardPresDebVal">0</span>
                          </div>
                          <div class="mt-1">
                            <span class="badge bg-dark" id="cardPresDebLbl">Base</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Acumulado</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardPresAcumVal">0</span>
                          </div>
                          <div class="mt-1">
                            <span class="badge bg-primary" id="cardPresAcumLbl">Puntos actuales</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-2">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Cumplimiento</h6>
                          <div class="d-flex align-items-baseline gap-2">
                            <span class="fs-3 fw-bold" id="cardPresCumplVal">0%</span>
                          </div>
                          <div class="mt-1">
                            <span class="badge bg-secondary" id="cardPresCumplLbl">% sobre meta</span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="card h-100">
                        <div class="card-body">
                          <h6 class="text-muted mb-1">Reconocimiento</h6>
                          <div class="d-flex align-items-center justify-content-start">
                            <img id="cardPresReconImg" src="" alt="Reconocimiento" style="height:96px; display:none;" />
                          </div>
                          <div class="mt-2" id="presReconLista"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          {% if mostrar_cargue %}
          <p class="text-muted mb-3">Cargar actividades desde Excel para registrar en la base de datos.</p>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCargarActividades">
            <i class="fas fa-upload me-2"></i>Cargue de actividades
          </button>
          {% endif %}
          <div class="row mt-3">
            <div class="col-md-4">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-control" id="filtroFecha" />
            </div>
            {% if session.get('user_role') in ['administrativo','lider'] or session.get('id_codigo_consumidor')|int == 26 %}
            <div class="col-md-4">
              <label class="form-label">Analista</label>
              <select class="form-select" id="filtroAnalista">
                <option value="">Todos</option>
              </select>
            </div>
            {% endif %}
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-outline-primary w-100" id="btnFiltrarFecha"><i class="fas fa-filter me-2"></i>Filtrar</button>
            </div>
            {% if session.get('user_role') == 'administrativo' %}
            <div class="col-auto d-flex align-items-end">
              <div class="btn-group">
                <button class="btn btn-success" id="btnExportCsv" onclick="exportarActividades('csv')"><i class="fas fa-file-csv me-2"></i>Export CSV</button>
                <button class="btn btn-secondary" id="btnExportXlsx" onclick="exportarActividades('xlsx')"><i class="fas fa-file-excel me-2"></i>Export Excel</button>
              </div>
            </div>
            {% endif %}
            <div class="col-auto d-flex align-items-end">
              <button class="btn btn-primary" id="btnIngresarGestionTop"><i class="fas fa-clipboard-check me-2"></i>Ingresar Gestión</button>
            </div>
            <div class="col d-flex align-items-end justify-content-end">
              <div id="resumenTop" class="d-flex gap-2"></div>
            </div>
          </div>
          <div class="table-responsive mt-3" id="resumenEstado"></div>
          <div class="table-responsive mt-4">
            <table class="table table-striped table-hover" id="tablaActividades">
              <thead>
                <tr>
                  <th>Cuenta</th>
                  <th>OT</th>
                  <th>Técnico</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2" id="paginadorActividades">
            <div class="small text-muted" id="paginadorInfo"></div>
            <ul class="pagination pagination-sm mb-0" id="paginadorControles"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if mostrar_cargue %}
  <div class="modal fade" id="modalCargarActividades" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-file-excel me-2"></i>Subir archivo de actividades</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formCargarActividades">
            <div class="mb-3">
              <label class="form-label">Archivo</label>
              <input type="file" class="form-control" id="archivoActividades" accept=".xlsx,.xls,.csv" required />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnSubirActividades">Subir</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  <div class="modal fade" id="modalCalidadesDetalle" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width:95vw">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-list-check me-2"></i>Calidades aplicadas</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="tablaCalidades">
              <thead>
                <tr>
                  <th>Cédula</th>
                  <th>Carpeta</th>
                  <th>Técnico</th>
                  <th>OT</th>
                  <th>Cuenta</th>
                  <th>Agenda</th>
                  <th>Fecha</th>
                  <th>Causa</th>
                </tr>
              </thead>
              <tbody id="tablaCalidadesBody"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
  </div>
</div>
</div>
</div>

<div class="modal fade" id="modalIngresarGestion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Ingresar Gestión</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">OT</label>
            <input type="text" class="form-control" id="igOT">
          </div>
          <div class="col-md-6">
            <label class="form-label">Cuenta</label>
            <input type="text" class="form-control" id="igCuenta">
          </div>
          <div class="col-12">
            <label class="form-label">Estado</label>
            <div class="d-flex gap-3">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="igEstado" id="igEstadoComp" value="completado" checked>
                <label class="form-check-label" for="igEstadoComp">Completado</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="igEstado" id="igEstadoNoComp" value="no completado">
                <label class="form-check-label" for="igEstadoNoComp">No completado</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="radio" name="igEstado" id="igEstadoCancel" value="cancelado">
                <label class="form-check-label" for="igEstadoCancel">Cancelado</label>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-primary" id="btnIngresarGestionContinuar">Continuar</button>
      </div>
    </div>
  </div>
</div>

<script>
const __btnSubir = document.getElementById('btnSubirActividades');
if(__btnSubir){
__btnSubir.addEventListener('click', async function(){
  const input = document.getElementById('archivoActividades');
  if (!input.files || !input.files[0]) {
    Swal.fire({icon:'warning', title:'Seleccione un archivo'});
    return;
  }
  const formData = new FormData();
  formData.append('file', input.files[0]);
  try {
    const endpoint = "{{ api_endpoint or '/api/lider/cargar-actividades' }}";
    const res = await fetch(endpoint, { method:'POST', body: formData });
    const data = await res.json();
    if (res.ok && data.success) {
      const msg = data.message || `Insertadas: ${data.rows_inserted || 0} • Actualizadas: ${data.rows_updated || 0}`;
      Swal.fire({icon:'success', title:'Cargado', text: msg});
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalCargarActividades'));
      modal && modal.hide();
      document.getElementById('formCargarActividades').reset();
      await cargarLista();
    } else {
      Swal.fire({icon:'error', title:'Error', text:data.message || 'Error al cargar'});
    }
  } catch (e) {
    Swal.fire({icon:'error', title:'Error de red'});
  }
});
} 

function coinRank(m){
  try{ return parseInt(String(m||'').replace(/\D/g,''),10) || 0; }catch(_){ return 0; }
}
function persistMaxCoin(page, periodo, analista, seccion, coin){
  try{
    const key = `recon_max:${page}:${periodo||''}:${analista||''}:${seccion||''}`;
    const prev = localStorage.getItem(key) || '';
    const best = (coinRank(prev) >= coinRank(coin)) ? (prev || coin) : coin;
    localStorage.setItem(key, best);
    return best;
  }catch(_){ return coin; }
}

async function cargarLista(){
  const listEndpoint = "{{ list_endpoint or '/api/analistas/actividades-diarias' }}";
  try{
    const fecha = document.getElementById('filtroFecha').value;
    let url = fecha ? `${listEndpoint}?fecha=${encodeURIComponent(fecha)}` : listEndpoint;
    const analistaInput = document.getElementById('filtroAnalista');
    const analista = analistaInput ? analistaInput.value.trim() : '';
    if(analista){
      url += (url.includes('?') ? '&' : '?') + `analista=${encodeURIComponent(analista)}`;
    }
    const res = await fetch(url);
    const data = await res.json();
    const rawItems = Array.isArray(data.items) ? data.items : [];
    __items = rawItems.filter(it => {
      const e = (it.estado || '').toString().toLowerCase().trim();
      const finV = String(it.estado_final ?? '').trim().toLowerCase();
      const esFin = finV === '1' || finV === 'true';
      return e === 'completado' || e === 'no completado' || e === 'cancelado' || esFin;
    });
    const orderEstado = { 'completado': 0, 'no completado': 1, 'cancelado': 2 };
    __items.sort((a, b) => {
      const ea = (a.estado || '').toString().toLowerCase().trim();
      const eb = (b.estado || '').toString().toLowerCase().trim();
      const oa = orderEstado[ea] ?? 99;
      const ob = orderEstado[eb] ?? 99;
      return oa - ob;
    });
    __page = 1;
    renderTabla();
    renderPaginador();
    renderResumen();
  }catch(e){
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const inputFecha = document.getElementById('filtroFecha');
  try{
    if(inputFecha && !inputFecha.value){
      const nowStr = new Date().toLocaleString('en-US', { timeZone: 'America/Bogota' });
      const now = new Date(nowStr);
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      inputFecha.value = `${yyyy}-${mm}-${dd}`;
    }
  }catch(_){}
  cargarLista();
  renderEfectividad();
  renderPresupuesto();
});
const __btnFiltro = document.getElementById('btnFiltrarFecha');
if(__btnFiltro){ __btnFiltro.addEventListener('click', () => { cargarLista(); renderEfectividad(); renderPresupuesto(); }); }

const __btnIngresarGestionTop = document.getElementById('btnIngresarGestionTop');
if(__btnIngresarGestionTop){
  __btnIngresarGestionTop.addEventListener('click', () => {
    const el = document.getElementById('modalIngresarGestion');
    if(!el){ return; }
    const m = bootstrap.Modal.getOrCreateInstance(el);
    m && m.show();
  });
}

const __btnIngresarGestionContinuar = document.getElementById('btnIngresarGestionContinuar');
if(__btnIngresarGestionContinuar){
  __btnIngresarGestionContinuar.addEventListener('click', () => {
    const ot = (document.getElementById('igOT')?.value || '').trim();
    const cuenta = (document.getElementById('igCuenta')?.value || '').trim();
    const estado = (document.querySelector('input[name="igEstado"]:checked') || {}).value || '';
    if(!ot || !cuenta){
      try{ if(window.Swal){ Swal.fire({icon:'warning', title:'Datos requeridos', text:'OT y Cuenta son obligatorios'}); } }catch(_){ }
      return;
    }
    try{ guardarEstadoInicial(ot, cuenta, estado, ''); }catch(_){}
    abrirGestionActividad(ot, cuenta, '', '', estado, '');
    const mm = bootstrap.Modal.getInstance(document.getElementById('modalIngresarGestion'));
    mm && mm.hide();
    try{ cargarLista(); renderEfectividad(); renderPresupuesto(); }catch(_){}
  });
}

function exportarActividades(formato){
  try{
    const f = (formato || 'csv').toLowerCase();
    let url = `/api/analistas/actividades-diarias/export?formato=${encodeURIComponent(f)}&mensual=1&gestionadas=1`;
    window.open(url, '_blank');
  }catch(_){ }
}

let __items = [];
let __page = 1;
const __pageSize = 10;
let __baseResumen = {};

function renderTabla(){
  const tbody = document.querySelector('#tablaActividades tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const start = (__page - 1) * __pageSize;
  const end = start + __pageSize;
  const pageItems = __items.slice(start, end);
  pageItems.forEach(item => {
    const tr = document.createElement('tr');
    const cuenta = formatCuenta(item.numero_de_cuenta);
    const ot = formatOT(item.orden_de_trabajo);
    const tecnico = item.tecnico ?? '';
    const fin = String(item.estado_final ?? '').trim();
    const isFin = fin === '1' || fin.toLowerCase() === 'true';
    const estado = (item.estado || '').toLowerCase();
    const fechaRaw = item.fecha;
    const bloqueado = debeBloquearGestion(fechaRaw);
    const estadoBadge = estado === 'completado' ? '<span class="badge bg-success">Completado</span>' : (estado === 'no completado' ? '<span class="badge bg-warning text-dark">No completado</span>' : (estado === 'cancelado' ? '<span class="badge bg-danger">Cancelado</span>' : (isFin ? '<span class="badge bg-info">Gestionado</span>' : '<span class="badge bg-secondary">N/A</span>')));
    tr.innerHTML = `
      <td>${cuenta}</td>
      <td>${ot}</td>
      <td>${tecnico}</td>
      <td>${estadoBadge}</td>
      <td>
        <button class="btn btn-sm btn-primary" ${isFin ? 'disabled' : ''} title="${bloqueado ? 'Bloqueado por corte de medio día' : ''}" onclick="abrirGestionActividad('${ot}','${cuenta}','${tecnico}','${item.external_id ?? ''}','${estado}','${item.actividad_id ?? ''}')">
          <i class="fas fa-tools me-1"></i>Ingresar Gestión
        </button>
        ${__canGestionado ? (() => { const v = item.cierre_ciclo; const s = String(v ?? '').trim().toLowerCase(); const esCierre = (v === 1) || (s === '1') || (s === 'true'); const tk = String(item.tipificacion_ok ?? '').toUpperCase(); const esInconforme = esCierre && tk.includes('CLIENTE INCONFORME'); const cls = esInconforme ? 'btn-danger' : (esCierre ? 'btn-warning' : 'btn-secondary'); return `<button class="btn btn-sm ${cls} ms-2" onclick="abrirGestionado('${ot}','${cuenta}')"><i class=\"fas fa-eye me-1\"></i>Gestionado</button>`; })() : ''}
        ${isFin ? '<span class="badge bg-success ms-2">Finalizado</span>' : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

async function abrirGestionado(ot, cuenta){
  try{
    const m = document.getElementById('modalGestionado');
    const modal = new bootstrap.Modal(m);
    const url = '/api/operativo/cierre-ciclo/detalle?' + new URLSearchParams({ ot, cuenta }).toString();
    const res = await fetch(url, { credentials: 'include' });
    const j = await res.json();
    const d = (j && j.data) ? j.data : {};
    document.getElementById('gdOT').textContent = ot || '';
    document.getElementById('gdCuenta').textContent = cuenta || '';
    document.getElementById('gdEstado').textContent = d.estado || '';
    document.getElementById('gdTecnico').textContent = d.tecnico || '';
    document.getElementById('gdAnalista').textContent = d.analista || '';
    document.getElementById('gdSupervisor').textContent = d.supervisor || '';
    document.getElementById('gaTipOk').value = d.tipificacion_ok || '';
    document.getElementById('gaObs').value = d.observacion_cierre || '';
    document.getElementById('gaCierre').value = (String(d.cierre_ciclo || '').trim() ? 'Sí' : 'No');
    document.getElementById('gaFecha').value = d.fecha_franja_cierre_ciclo || '';
    document.getElementById('gaFranja').value = d.franja_cierre_ciclo || '';
    document.getElementById('gaAlerta').value = d.alerta_cierre_ciclo || '';
    const cierreSuperVal = d.cierre_super;
    const cierreSuperTxt = (cierreSuperVal === 1 || String(cierreSuperVal).toLowerCase() === 'true' || String(cierreSuperVal).toLowerCase() === 'completado') ? 'Sí' : (String(cierreSuperVal).trim() ? String(cierreSuperVal) : 'No');
    document.getElementById('gsCierreSuper').value = cierreSuperTxt || '';
    document.getElementById('gsTip1').value = d.tip_super_1 || '';
    document.getElementById('gsTip2').value = d.tip_super_2 || '';
    document.getElementById('gsFechaSuper').value = d.fecha_gestion_super || '';
    const obsSupEl = document.getElementById('gsObservacionSuper');
    if (obsSupEl) obsSupEl.value = d.observacion_super || '';
    const recEl = document.getElementById('gsRecomendacion');
    if (recEl) recEl.value = d.recomendacion_tecnico || '';
    const imgF = document.getElementById('gsImgFalla');
    const wrapF = document.getElementById('gsImgFallaWrap');
    if (wrapF) wrapF.style.display = (d.imagen_falla && String(d.imagen_falla).trim()) ? 'block' : 'none';
    if (imgF) { imgF.src = d.imagen_falla || ''; imgF.style.cursor = 'zoom-in'; imgF.onclick = () => abrirOverlayImagen(d.imagen_falla || '', 'Imagen Falla'); }
    const imgS = document.getElementById('gsImgSol');
    const wrapS = document.getElementById('gsImgSolWrap');
    if (wrapS) wrapS.style.display = (d.imagen_solucion && String(d.imagen_solucion).trim()) ? 'block' : 'none';
    if (imgS) { imgS.src = d.imagen_solucion || ''; imgS.style.cursor = 'zoom-in'; imgS.onclick = () => abrirOverlayImagen(d.imagen_solucion || '', 'Imagen Solución'); }
    modal.show();
  }catch(_){
    try{ if(window.Swal){ Swal.fire({icon:'warning', title:'Sin datos', text:'No fue posible cargar el detalle gestionado'}); } }catch(__){}
  }
}

function renderPaginador(){
  const info = document.getElementById('paginadorInfo');
  const ctrls = document.getElementById('paginadorControles');
  if(!info || !ctrls) return;
  const total = __items.length;
  const totalPages = Math.max(1, Math.ceil(total / __pageSize));
  const start = total === 0 ? 0 : (__page - 1) * __pageSize + 1;
  const end = Math.min(total, __page * __pageSize);
  info.textContent = `Mostrando ${start}–${end} de ${total}`;
  let html = '';
  const prevDisabled = __page <= 1 ? ' disabled' : '';
  html += `<li class="page-item${prevDisabled}"><a class="page-link" href="#" data-page="prev">Anterior</a></li>`;
  const windowSize = 5;
  let startPage = Math.max(1, __page - Math.floor(windowSize/2));
  let endPage = Math.min(totalPages, startPage + windowSize - 1);
  startPage = Math.max(1, endPage - windowSize + 1);
  for(let p = startPage; p <= endPage; p++){
    const active = p === __page ? ' active' : '';
    html += `<li class="page-item${active}"><a class="page-link" href="#" data-page="${p}">${p}</a></li>`;
  }
  const nextDisabled = __page >= totalPages ? ' disabled' : '';
  html += `<li class="page-item${nextDisabled}"><a class="page-link" href="#" data-page="next">Siguiente</a></li>`;
  ctrls.innerHTML = html;
}

async function renderResumen(){
  const cont = document.getElementById('resumenEstado');
  if(!cont) return;
  const fecha = document.getElementById('filtroFecha')?.value || '';
  const analista = (document.getElementById('filtroAnalista')?.value || '').trim();
  let url = '/api/analistas/actividades-diarias/resumen';
  const params = [];
  if(fecha) params.push(`fecha=${encodeURIComponent(fecha)}`);
  if(analista) params.push(`analista=${encodeURIComponent(analista)}`);
  if(params.length){ url += `?${params.join('&')}`; }
  try{
    const res = await fetch(url);
    if(res.ok){
      const data = await res.json();
      if(data && data.success){
        const r = data.resumen || {};
        const c = r.completado || { cantidad: 0, gestionada: 0 };
        const n = r.no_completado || { cantidad: 0, gestionada: 0 };
        const k = r.cancelado || { cantidad: 0, gestionada: 0 };
        const pComp = c.cantidad ? (c.gestionada * 100) / c.cantidad : 0;
        const pNComp = n.cantidad ? (n.gestionada * 100) / n.cantidad : 0;
        const pCancel = k.cantidad ? (k.gestionada * 100) / k.cantidad : 0;
        const fmt = (v) => `${v.toFixed(1)}%`;
        const m = data.mensual || { cantidad: 0, gestionada: 0 };
        const mk = (m.cancelado || { cantidad: 0, gestionada: 0 });
        const totalCant = m.cantidad || 0;
        const totalGest = m.gestionada || 0;
        const totalPct = m.cantidad ? (m.gestionada * 100) / m.cantidad : 0;
        const cc = data.cierre_ciclo || { meta_mensual: 260, gestionada: 0, porcentaje_meta: 0 };
        const ccMeta = typeof cc.meta_mensual === 'number' ? cc.meta_mensual : (Number(cc.meta_mensual) || 260);
        const ccGest = typeof cc.gestionada === 'number' ? cc.gestionada : (Number(cc.gestionada) || 0);
        const ccPct = typeof cc.porcentaje_meta === 'number' ? cc.porcentaje_meta : (Number(cc.porcentaje_meta) || 0);
        const top = document.getElementById('resumenTop');
        if(top){
          top.classList.add('flex-column');
          top.innerHTML = `
            <div class="d-flex gap-2 justify-content-end">
              <div class="badge bg-warning p-2">Cierre Ciclo (mes): <span class="fw-bold">${ccGest}</span></div>
              <div class="badge bg-dark p-2">Meta Cierre: <span class="fw-bold">${ccMeta}</span></div>
              <div class="badge bg-primary p-2">Cierre %: <span class="fw-bold">${fmt(ccPct)}</span></div>
            </div>
          `;
        }
        const cards = document.getElementById('analistasMetricCards');
        if(cards){
          const cal = data.cierre_ciclo_calidad || { ots_mes: 0, con_calidad_mes: 0, porcentaje_mensual: 0 };
          const metaEl = document.getElementById('cardMetaValor');
          const gestEl = document.getElementById('cardGestionadaValor');
          const gestPctEl = document.getElementById('cardGestionadaPct');
          const calPctEl = document.getElementById('cardCalidadPct');
          const calBaseEl = document.getElementById('cardCalidadBase');
          const calAplEl = document.getElementById('cardCalidadesAplicadas');
          if(metaEl) metaEl.textContent = ccMeta;
          if(gestEl) gestEl.textContent = ccGest;
          if(gestPctEl) gestPctEl.textContent = fmt(ccPct);
          if(calPctEl) calPctEl.textContent = fmt(typeof cal.porcentaje_mensual === 'number' ? cal.porcentaje_mensual : (Number(cal.porcentaje_mensual) || 0));
          if(calBaseEl) calBaseEl.textContent = `sobre ${cal.ots_mes || 0} cierres`;
          if(calAplEl) calAplEl.textContent = `calidades aplicadas: ${cal.calidades_aplicadas || cal.con_calidad_mes || 0}`;
          if(calAplEl){
            calAplEl.onclick = async function(){
              try{
                const fecha = document.getElementById('filtroFecha')?.value || '';
                const analista = (document.getElementById('filtroAnalista')?.value || '').trim();
                let url = '/api/analistas/actividades-diarias/calidad-detalle';
                const params = [];
                if(fecha) params.push(`fecha=${encodeURIComponent(fecha)}`);
                if(analista) params.push(`analista=${encodeURIComponent(analista)}`);
                if(params.length) url += `?${params.join('&')}`;
                const res = await fetch(url);
                if(res.ok){
                  const data = await res.json();
                  const items = Array.isArray(data.items) ? data.items : [];
                  const tbody = document.getElementById('tablaCalidadesBody');
                  if(tbody){
                    tbody.innerHTML = items.map(it => {
                      const f = formatYMD(it.fecha);
                      const a = formatYMD(it.agenda);
                      return `<tr>
                        <td>${it.cedula ?? ''}</td>
                        <td>${it.carpeta ?? ''}</td>
                        <td>${it.tecnico ?? ''}</td>
                        <td>${it.ot ?? ''}</td>
                        <td>${it.cuenta ?? ''}</td>
                        <td>${a}</td>
                        <td>${f}</td>
                        <td>${(it.causa ?? '').toString().slice(0,200)}</td>
                      </tr>`;
                    }).join('');
                  }
                  const modal = new bootstrap.Modal(document.getElementById('modalCalidadesDetalle'));
                  modal.show();
                }
              }catch(_){ }
            };
          }

          const monedaImg = document.getElementById('cardMonedaImg');
          if(monedaImg){
            const p = Number(cal.porcentaje_mensual || 0);
            let coin = '0pesos';
            if(p >= 96){ coin = '400pesos'; }
            else if(p >= 94){ coin = '300pesos'; }
            else if(p >= 92){ coin = '200pesos'; }
            else if(p >= 90){ coin = '100pesos'; }
            const periodoSel = (document.getElementById('filtroFecha')?.value || '').slice(0,7);
            const analistaSel = (document.getElementById('filtroAnalista')?.value || '').trim();
            const final = persistMaxCoin('analistas', periodoSel, analistaSel, 'cierre', coin);
            monedaImg.style.display = 'inline-block';
            monedaImg.src = `/static/moneda/${final}.png`;
          }
        }
        cont.innerHTML = `
          <table class="table table-sm table-bordered mb-0">
            <thead class="table-primary">
              <tr>
                <th>Estado</th>
                <th>Cantidad</th>
                <th>Cantidad gestionada</th>
                <th>Finalizado %</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="badge bg-success">Completado</span></td>
                <td>${c.cantidad}</td>
                <td>${c.gestionada}</td>
                <td>${fmt(pComp)}</td>
              </tr>
              <tr>
                <td><span class="badge bg-warning text-dark">No completado</span></td>
                <td>${n.cantidad}</td>
                <td>${n.gestionada}</td>
                <td>${fmt(pNComp)}</td>
              </tr>
              <tr>
                 <td><span class="badge bg-danger">Cancelado</span></td>
                 <td>${k.cantidad}</td>
                 <td>${k.gestionada}</td>
                 <td>${fmt(pCancel)}</td>
               </tr>
            </tbody>
          </table>
        `;
        return;
      }
    }
  }catch(_){ }
  let comp = 0, compGest = 0, ncomp = 0, ncompGest = 0, canc = 0, cancGest = 0;
  for(const it of __items){
    const e = String(it.estado || '').toLowerCase().trim();
    const fin = (()=>{const v=String(it.estado_final ?? '').trim().toLowerCase();return v==='1'||v==='true';})();
    if(e==='completado'){ comp++; if(fin) compGest++; }
    else if(e==='no completado'){ ncomp++; if(fin) ncompGest++; }
    else if(e==='cancelado'){ canc++; if(fin) cancGest++; }
  }
  const fmt = (v) => `${v.toFixed(1)}%`;
  const top = document.getElementById('resumenTop');
  if(top){
    let ccGestDia = 0;
    for(const it of __items){
      const v = it.cierre_ciclo;
      const s = String(v ?? '').trim().toLowerCase();
      const esCierre = (v === 1) || (s === '1') || (s === 'true');
      if(esCierre) ccGestDia++;
    }
    top.innerHTML = `
      <div class="badge bg-warning p-2">Cierre Ciclo (día): <span class="fw-bold">${ccGestDia}</span></div>
    `;
  }
  cont.innerHTML = `
    <table class="table table-sm table-bordered mb-0">
      <thead class="table-primary">
        <tr>
          <th>Estado</th>
          <th>Cantidad</th>
          <th>Cantidad gestionada</th>
          <th>Finalizado %</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="badge bg-success">Completado</span></td>
          <td>${comp}</td>
          <td>${compGest}</td>
          <td>${fmt(pComp)}</td>
        </tr>
        <tr>
          <td><span class="badge bg-warning text-dark">No completado</span></td>
          <td>${ncomp}</td>
          <td>${ncompGest}</td>
          <td>${fmt(pNComp)}</td>
        </tr>
        <tr>
          <td><span class="badge bg-danger">Cancelado</span></td>
          <td>${canc}</td>
          <td>${cancGest}</td>
          <td>${fmt(pCanc)}</td>
        </tr>
      </tbody>
    </table>
  `;
}

async function renderEfectividad(){
  const cont = document.getElementById('efectividadCards');
  if(!cont) return;
  const fecha = document.getElementById('filtroFecha')?.value || '';
  const analista = (document.getElementById('filtroAnalista')?.value || '').trim();
  const periodo = fecha ? (String(fecha).slice(0,7)) : '';
  let url = '/api/lider/efectividad/list';
  const params = [];
  if(periodo) params.push(`periodo=${encodeURIComponent(periodo)}`);
  if(analista) params.push(`analista=${encodeURIComponent(analista)}`);
  if(params.length) url += `?${params.join('&')}`;
  try{
    const res = await fetch(url);
    if(res.ok){
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      let count = items.length;
      let sAgenda = 0, sOK = 0, sRazon = 0, sKPI = 0;
      const num = (v)=>{const n = Number(v); return isNaN(n) ? 0 : n;};
      for(const it of items){
        sAgenda += num(it.agenda);
        sOK += num(it.ok);
        sRazon += num(it.razon);
        sKPI += num(it.kpi);
      }
      const avgKPI = count ? (sKPI / count) : 0;
      const clampPct = (v)=> Math.max(0, Math.min(100, v));
      const fmtPct = (v)=> `${clampPct(v).toFixed(1)}%`;
      const fmtNum = (v)=>{ try{ return Number(v).toLocaleString('es-CO', { maximumFractionDigits: 0 }); }catch(_){ return String(v); } };
      const setTxt = (id, val)=>{ const el = document.getElementById(id); if(el) el.textContent = val; };
      setTxt('cardEfectAgendaVal', fmtNum(sAgenda));
      setTxt('cardEfectOKsVal', fmtNum(sOK));
      setTxt('cardEfectRazonVal', fmtNum(sRazon));
      setTxt('cardEfectKPIVAl', fmtPct(avgKPI));
  const nameText = (analista || 'Todos');
  const img = document.getElementById('cardEfectReconImg');
  if(img){
    const eff = avgKPI;
    await setReconByTabla(img, analista, periodo, 'efectividad', eff);
  }
      const list = document.getElementById('efectReconLista');
      if(list){ list.innerHTML = ''; list.style.display = 'none'; }
    }
  }catch(_){ }
}

async function renderPresupuesto(){
  const cont = document.getElementById('presupuestoCards');
  if(!cont) return;
  const fecha = document.getElementById('filtroFecha')?.value || '';
  const analista = (document.getElementById('filtroAnalista')?.value || '').trim();
  const periodo = fecha ? (String(fecha).slice(0,7)) : '';
  let url = '/api/lider/facturacion/resumen';
  const params = [];
  if(periodo) params.push(`periodo=${encodeURIComponent(periodo)}`);
  if(analista) params.push(`analista=${encodeURIComponent(analista)}`);
  if(params.length) url += `?${params.join('&')}`;
  try{
    const res = await fetch(url);
    if(res.ok){
      const data = await res.json();
      const r = (data && data.resumen) ? data.resumen : {};
      const n = (v)=>{ const x = Number(v); return isNaN(x) ? 0 : x; };
      const deberDia = n(r.deberiair);
      const puntos = n(r.puntos);
      const diasCol = n(r.dias || r.dias_mes || r.diasmes || r.dias_periodo);
      let diasMes = 30;
      try{
        if(periodo && /^\d{4}-\d{2}$/.test(periodo)){
          const parts = periodo.split('-');
          const y = parseInt(parts[0],10);
          const m = parseInt(parts[1],10);
          diasMes = new Date(y, m, 0).getDate();
        }else{
          const nowStr = new Date().toLocaleString('en-US', { timeZone: 'America/Bogota' });
          const now = new Date(nowStr);
          const y = now.getFullYear();
          const m = now.getMonth()+1;
          diasMes = new Date(y, m, 0).getDate();
        }
      }catch(_){ diasMes = 30; }
      let diasUsados = diasCol > 0 ? diasCol : 0;
      if(diasUsados <= 0){
        try{
          let urlListDias = '/api/lider/facturacion/list';
          const pl2 = [];
          if(periodo) pl2.push(`periodo=${encodeURIComponent(periodo)}`);
          if(analista) pl2.push(`analista=${encodeURIComponent(analista)}`);
          if(pl2.length) urlListDias += `?${pl2.join('&')}`;
          const resList2 = await fetch(urlListDias);
          if(resList2.ok){
            const dataList2 = await resList2.json();
            const items2 = Array.isArray(dataList2.items) ? dataList2.items : [];
            let maxDias = 0;
            items2.forEach(it => {
              const d = Number(it.dias || it.dias_mes || it.diasmes || it.dias_periodo) || 0;
              if(d > maxDias) maxDias = d;
            });
            diasUsados = maxDias > 0 ? maxDias : 0;
          }
        }catch(_){ }
      }
      if(diasUsados <= 0) diasUsados = diasMes;
      const objetivo = diasUsados > 0 ? (deberDia / diasUsados) * 26 : (deberDia * 26);
      const cumpl = deberDia > 0 ? (puntos * 100) / deberDia : 0;
      const fmtNum = (v)=>{ try{ return Number(v).toLocaleString('es-CO', { maximumFractionDigits: 0 }); }catch(_){ return String(v); } };
      const fmtPct = (v)=> `${Number(v).toFixed(1)}%`;
      const setTxt = (id, val)=>{ const el = document.getElementById(id); if(el) el.textContent = val; };
      setTxt('cardPresDebVal', fmtNum(deberDia));
      setTxt('cardPresObjVal', fmtNum(objetivo));
      setTxt('cardPresAcumVal', fmtNum(puntos));
      setTxt('cardPresCumplVal', fmtPct(cumpl));
  const nameText = (analista || 'Todos');
  const img = document.getElementById('cardPresReconImg');
  if(img){
    await setReconByTabla(img, analista, periodo, 'presupuesto', cumpl);
  }
      const list = document.getElementById('presReconLista');
      if(list){ list.innerHTML = ''; list.style.display = 'none'; }
    }
  }catch(_){ }
}

document.getElementById('paginadorActividades').addEventListener('click', (e) => {
  const a = e.target.closest('[data-page]');
  if(!a) return;
  e.preventDefault();
  const totalPages = Math.max(1, Math.ceil(__items.length / __pageSize));
  const dp = a.getAttribute('data-page');
  if(dp === 'prev'){ if(__page > 1) __page--; }
  else if(dp === 'next'){ if(__page < totalPages) __page++; }
  else { const np = parseInt(dp, 10); if(!isNaN(np)) __page = Math.min(Math.max(1, np), totalPages); }
  renderTabla();
  renderPaginador();
});

async function initAnalistas(){
  const select = document.getElementById('filtroAnalista');
  if(!select) return;
  try{
    const res = await fetch('/api/lider/inicio-operacion/analistas');
    if(res.ok){
      const data = await res.json();
      const arr = data && data.analistas ? data.analistas : [];
      const current = select.value;
      select.innerHTML = '<option value="">Todos</option>';
      arr.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      if(current) select.value = current;
    }
  }catch(_){}
}
document.addEventListener('DOMContentLoaded', initAnalistas);

function formatCuenta(v){
  try{
    const s = String(v ?? '').trim();
    if(!s) return '';
    const i = parseInt(s.split('.')[0], 10);
    return isNaN(i) ? s : i.toString();
  }catch(_){ return v ?? ''; }
}
function formatFecha(v){
  try{
    if(!v) return '';
    const s = String(v).trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:\s|T|$)/);
    if(m){
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    const d = new Date(s);
    if(!isNaN(d.getTime())){
      const parts = new Intl.DateTimeFormat('es-CO', { timeZone: 'America/Bogota', year: 'numeric', month: '2-digit', day: '2-digit' }).formatToParts(d);
      const day = parts.find(p=>p.type==='day').value;
      const month = parts.find(p=>p.type==='month').value;
      const year = parts.find(p=>p.type==='year').value;
      return `${day}/${month}/${year}`;
    }
    return s;
  }catch(_){ return v; }
}
function formatYMD(v){
  try{
    if(!v) return '';
    const s = String(v).trim();
    let m = s.match(/^(\d{4})[\/-](\d{2})[\/-](\d{2})/);
    if(m){
      return `${m[1]}-${m[2]}-${m[3]}`;
    }
    m = s.match(/^(\d{2})[\/-](\d{2})[\/-](\d{4})/);
    if(m){
      return `${m[3]}-${m[2]}-${m[1]}`;
    }
    const d = new Date(s);
    if(!isNaN(d.getTime())){
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    return s;
  }catch(_){ return v ?? ''; }
}
function formatOT(v){
  try{
    const s = String(v ?? '').trim();
    if(!s) return '';
    const m = s.match(/^(\d+)/);
    const base = m ? m[1] : s.split('.')[0];
    const i = parseInt(base, 10);
    return isNaN(i) ? s : i.toString();
  }catch(_){ return v ?? ''; }
}

async function getReconMoneda(analista, periodo, seccion, valor){
  try{
    const path = (window.location && window.location.pathname) ? window.location.pathname : '';
    const isAnalistasView = path.includes('/analistas/');
    const v = Number(valor||0);
    if(isAnalistasView){
      if(v >= 96) return '400pesos';
      if(v >= 94) return '300pesos';
      if(v >= 92) return '200pesos';
      if(v >= 90) return '100pesos';
      return '0pesos';
    }
    let url = '/api/administrativo/porcentajes-analistas';
    const qs = [];
    if(periodo) qs.push(`periodo=${encodeURIComponent(periodo)}`);
    if(analista) qs.push(`analista=${encodeURIComponent(analista)}`);
    if(seccion) qs.push(`seccion=${encodeURIComponent(seccion)}`);
    if(qs.length) url += `?${qs.join('&')}`;
    const res = await fetch(url, { credentials:'include' });
    if(res.ok){
      const data = await res.json();
      const items = Array.isArray(data.items) ? data.items : [];
      items.sort((a,b)=> Number(a.porcentaje||0) - Number(b.porcentaje||0));
      let pick = '';
      for(const it of items){
        const pct = Number(it.porcentaje||0);
        if(Number(valor||0) >= pct){ pick = String(it.moneda||'').trim(); }
      }
      return pick;
    }
    if(v >= 96) return '400pesos';
    if(v >= 94) return '300pesos';
    if(v >= 92) return '200pesos';
    if(v >= 90) return '100pesos';
    return '0pesos';
  }catch(_){
    const v = Number(valor||0);
    if(v >= 96) return '400pesos';
    if(v >= 94) return '300pesos';
    if(v >= 92) return '200pesos';
    if(v >= 90) return '100pesos';
    return '0pesos';
  }
}

async function setReconByTabla(imgEl, analista, periodo, seccion, valor){
  if(!imgEl) return;
  const m = await getReconMoneda(analista, periodo, seccion, valor);
  const moneda = m || '0pesos';
  const final = persistMaxCoin('analistas', periodo, analista, seccion, moneda);
  const src = `/static/moneda/${final}.png`;
  imgEl.style.display = 'inline-block';
  imgEl.src = src;
}

function debeBloquearGestion(fechaRaw){
  try{
    const nowStr = new Date().toLocaleString('en-US', { timeZone: 'America/Bogota' });
    const now = new Date(nowStr);
    const bloqueoInicio = new Date('2025-12-10T12:00:00-05:00');
    if (now.getTime() < bloqueoInicio.getTime()) { return false; }
    const s = String(fechaRaw ?? '').trim();
    let y = null, m = null, d = null;
    const rx = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(rx){ y = parseInt(rx[1],10); m = parseInt(rx[2],10); d = parseInt(rx[3],10); }
    else{
      const f = (document.getElementById('filtroFecha')?.value || '').trim();
      const r2 = f.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!r2) return false;
      y = parseInt(r2[1],10); m = parseInt(r2[2],10); d = parseInt(r2[3],10);
    }
    const deadline = new Date(y, m-1, d+1, 12, 0, 0);
    return now.getTime() >= deadline.getTime();
  }catch(_){ return false; }
}

// Modal de gestión de actividad
</script>

<!-- Modal Gestión de Actividad -->
<div class="modal fade" id="modalGestionActividad" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Gestión de Actividad</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <!-- Datos Actividad -->
          <div class="card mb-3">
            <div class="card-header fw-bold">Datos Actividad</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Cuenta</label>
                  <input type="text" class="form-control" id="gaCuenta" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label">OT</label>
                  <input type="text" class="form-control" id="gaOT" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Estado</label>
                  <input type="text" class="form-control" id="gaEstado" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Técnico</label>
                  <select class="form-select" id="gaTecnico" required></select>
                </div>
              </div>
            </div>
          </div>

          <!-- Datos Gestión -->
          <div class="card mb-3">
            <div class="card-header fw-bold">Datos Gestión</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nombre</label>
                  <input type="text" class="form-control" id="gaNombre">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tipo de Actividad</label>
                  <input type="text" class="form-control" id="gaTipoActividad">
                </div>
                <div class="col-12">
                  <label class="form-label">Dirección</label>
                  <input type="text" class="form-control" id="gaDireccion">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tiempo Gestión (Inicio–Fin)</label>
                  <input type="text" class="form-control" id="gaTiempoGestion">
                </div>
                <div class="col-md-6">
                  <label class="form-label">Duración</label>
                  <input type="text" class="form-control" id="gaDuracion">
                </div>
              </div>
            </div>
          </div>

          <!-- Gestión -->
          <div class="card">
            <div class="card-header fw-bold">Gestión</div>
            <div class="card-body">
              <!-- Sección OK -->
              <div id="seccionOk" style="display:none;">
                <div class="alert alert-success mb-3"><i class="fas fa-check-circle me-2"></i>Estado: Completado</div>
                <div class="row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Facturación</label><br>
                    <button class="btn btn-outline-success" id="btnFacturar">
                      <i class="fas fa-file-invoice-dollar me-2"></i>Facturar
                    </button>
                    <div id="facturarInfo" class="d-none"></div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Cierre de ciclo</label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaCierreCiclo" id="gaCierreNo" value="no" checked>
                        <label class="form-check-label" for="gaCierreNo">No</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaCierreCiclo" id="gaCierreSi" value="si">
                        <label class="form-check-label" for="gaCierreSi">Sí</label>
                      </div>
                     </div>
                  </div>
                </div>
                <div class="row g-3 mt-3">
                  <div class="col-md-6">
                    <label class="form-label">Confirmación de evento</label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaConfirmEventoOk" id="gaConfirmEventoOkNo" value="no" checked>
                        <label class="form-check-label" for="gaConfirmEventoOkNo">No</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaConfirmEventoOk" id="gaConfirmEventoOkSi" value="si">
                        <label class="form-check-label" for="gaConfirmEventoOkSi">Sí</label>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="subseccionCierre" class="mt-3" style="display:none;">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Tipificación OK</label>
                      <select class="form-select" id="gaTipificacionOk">
                        <option value="">Seleccione...</option>
                      </select>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Observación <span id="reqObs" class="text-danger" style="display:none">*</span></label>
                      <input type="text" class="form-control" id="gaObservacionNovedad" placeholder="Observaciones...">
                    </div>
                    <div class="col-12" id="gaAgendaCierreBlock" style="display:none;">
                      <div class="row g-3">
                        <div class="col-md-6">
                          <label class="form-label">Fecha Agenda cierre ciclo <span id="reqFecha" class="text-danger" style="display:none">*</span></label>
                          <input type="date" class="form-control" id="gaFechaAgendaCierre">
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Franja de cierre de ciclo <span id="reqFranja" class="text-danger" style="display:none">*</span></label>
                          <select class="form-select" id="gaFranjaCierre">
                            <option value="">Seleccione...</option>
                            <option>7:00:00 a. m. — 9:00:00 a. m.</option>
                            <option>9:00:00 a. m. — 11:00:00 a. m.</option>
                            <option>11:00:00 a. m. — 1:00:00 p. m.</option>
                            <option>1:00:00 p. m. — 3:00:00 p. m.</option>
                            <option>3:00:00 p. m. — 5:00:00 p. m.</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Nivel de Alerta <span id="reqAlerta" class="text-danger" style="display:none">*</span></label>
                          <select class="form-select" id="gaAlertaCierre">
                            <option value="">Seleccione...</option>
                            <option value="BAJO">BAJO</option>
                            <option value="MEDIO">MEDIO</option>
                            <option value="ALTO">ALTO</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-3 d-flex justify-content-end">
                  <button type="button" class="btn btn-warning" id="btnFinalizarOk">
                    <i class="fas fa-save me-2"></i>Finalizar
                  </button>
                </div>
              </div>

              <!-- Sección Razón -->
              <div id="seccionRazon" style="display:none;">
                <div class="alert alert-warning mb-3"><i class="fas fa-exclamation-circle me-2"></i>Estado: No Completado</div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Tipo Razón (de la actividad)</label>
                    <input type="text" class="form-control" id="gaTipoRazon" readonly>
                    <div class="form-text">Seleccione si aplica o no</div>
                    <div class="d-flex gap-3 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaTipoRazonAplica" id="gaTRNo" value="no" checked>
                        <label class="form-check-label" for="gaTRNo">No</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaTipoRazonAplica" id="gaTRSi" value="si">
                        <label class="form-check-label" for="gaTRSi">Sí</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Razón Real</label>
                    <select class="form-select" id="gaRazonReal">
                      <option value="">Seleccione...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Confirmación de evento</label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaConfirmEvento" id="gaConfirmEventoNo" value="no" checked>
                        <label class="form-check-label" for="gaConfirmEventoNo">No</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaConfirmEvento" id="gaConfirmEventoSi" value="si">
                        <label class="form-check-label" for="gaConfirmEventoSi">Sí</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Observaciones</label>
                    <input type="text" class="form-control" id="gaObservacionesRazon" placeholder="Observaciones...">
                  </div>
                  <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-warning" id="btnFinalizarRazon">
                      <i class="fas fa-save me-2"></i>Finalizar
                    </button>
                  </div>
                </div>
              </div>

              <div id="seccionCancelado" style="display:none;">
                <div class="alert alert-danger mb-3"><i class="fas fa-ban me-2"></i>Estado: Cancelado</div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Tipificación Cancelado</label>
                    <select class="form-select" id="gaCanceladoTipificacion">
                      <option value="">Seleccione...</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Observación</label>
                    <input type="text" class="form-control" id="gaCanceladoObservacion" placeholder="Observaciones...">
                  </div>
                  <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-warning" id="btnFinalizarCancelado">
                      <i class="fas fa-save me-2"></i>Finalizar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Facturar (iframe del formulario de OT) -->
<div class="modal fade" id="modalFacturarOT" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-file-invoice-dollar me-2"></i>Nueva Orden de Trabajo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="height: 80vh;">
        <iframe id="facturarFrame" src="" style="width:100%; height:100%; border:0;"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalle Gestionado (Solo líder, informativo) -->
<div class="modal fade" id="modalGestionado" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title"><i class="fas fa-eye me-2"></i>Detalle de Gestión</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <div class="card mb-3">
            <div class="card-header fw-bold">Datos Actividad</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-2"><label class="form-label">OT</label><div class="form-control" id="gdOT"></div></div>
                <div class="col-md-3"><label class="form-label">Cuenta</label><div class="form-control" id="gdCuenta"></div></div>
                <div class="col-md-3"><label class="form-label">Estado</label><div class="form-control" id="gdEstado"></div></div>
                <div class="col-md-4"><label class="form-label">Técnico</label><div class="form-control" id="gdTecnico"></div></div>
                <div class="col-md-6"><label class="form-label">Analista</label><div class="form-control" id="gdAnalista"></div></div>
                <div class="col-md-6"><label class="form-label">Supervisor</label><div class="form-control" id="gdSupervisor"></div></div>
              </div>
            </div>
          </div>
          <div class="card mb-3">
            <div class="card-header fw-bold">Gestión Analista</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6"><label class="form-label">Tipificación OK</label><input type="text" class="form-control" id="gaTipOk" readonly></div>
                <div class="col-md-6"><label class="form-label">Observación</label><input type="text" class="form-control" id="gaObs" readonly></div>
                <div class="col-md-4"><label class="form-label">Cierre de ciclo</label><input type="text" class="form-control" id="gaCierre" readonly></div>
                <div class="col-md-4"><label class="form-label">Fecha Agenda</label><input type="text" class="form-control" id="gaFecha" readonly></div>
                <div class="col-md-4"><label class="form-label">Franja</label><input type="text" class="form-control" id="gaFranja" readonly></div>
                <div class="col-md-4"><label class="form-label">Nivel de Alerta</label><input type="text" class="form-control" id="gaAlerta" readonly></div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header fw-bold">Gestión Supervisor</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-4"><label class="form-label">Cierre Supervisor</label><input type="text" class="form-control" id="gsCierreSuper" readonly></div>
                <div class="col-md-4"><label class="form-label">Tipificación 1</label><input type="text" class="form-control" id="gsTip1" readonly></div>
                <div class="col-md-4"><label class="form-label">Tipificación 2</label><input type="text" class="form-control" id="gsTip2" readonly></div>
                <div class="col-md-6"><label class="form-label">Fecha Gestión Supervisor</label><input type="text" class="form-control" id="gsFechaSuper" readonly></div>
                <div class="col-md-12"><label class="form-label">Observación Supervisor</label><input type="text" class="form-control" id="gsObservacionSuper" readonly></div>
                <div class="col-md-12"><label class="form-label">Recomendación al Técnico</label><input type="text" class="form-control" id="gsRecomendacion" readonly></div>
                <div class="col-md-6"><label class="form-label">Imagen Falla</label><div id="gsImgFallaWrap" style="display:none;"><img id="gsImgFalla" class="img-fluid rounded border" /></div></div>
                <div class="col-md-6"><label class="form-label">Imagen Solución</label><div id="gsImgSolWrap" style="display:none;"><img id="gsImgSol" class="img-fluid rounded border" /></div></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
let __gaContext = { ot: '', cuenta: '', tecnico: '', tecnicoId: '', estado: '', actividadId: '' };
const __canGestionado = {{ 'true' if session.get('user_role') in ['lider','administrativo'] else 'false' }};

let __tecnicosIndex = new Map();
let __tecnicosLoaded = false;
const __currentUserName = "{{ session.get('user_name', '') }}";
const __currentUserRole = "{{ session.get('user_role', '') }}";

async function cargarTecnicosDatalist(){
    if(__tecnicosLoaded) return;
    const el = document.getElementById('gaTecnico');
    if(!el) { __tecnicosLoaded = true; return; }
  if(el.tagName === 'SELECT'){
      el.innerHTML = '';
      const def = document.createElement('option');
      def.value = '';
      def.textContent = 'Seleccione técnico';
      def.disabled = true;
      def.selected = true;
      el.appendChild(def);
  }
    try{
        let arr = [];
        const role = (__currentUserRole || '').toLowerCase();
        if(role === 'analista'){
            const r = await fetch('/api/analistas/tecnicos-asignados', { credentials: 'include' });
            const d = await r.json();
            arr = Array.isArray(d?.tecnicos) ? d.tecnicos : [];
        } else {
            const sup = (__currentUserName || '').trim();
            if(sup){
                const r1 = await fetch('/api/tecnicos_por_supervisor?'+new URLSearchParams({ supervisor: sup }).toString(), { credentials: 'include' });
                const d1 = await r1.json();
                arr = Array.isArray(d1?.tecnicos) ? d1.tecnicos : [];
            }
            if(!arr || arr.length === 0){
                const r2 = await fetch('/api/tecnicos?estado=Activo', { credentials: 'include' });
                const d2 = await r2.json();
                arr = Array.isArray(d2?.data) ? d2.data : (d2?.tecnicos || d2?.items || []);
            }
        }
        arr.forEach(t => {
            const nombre = String(t.tecnico || t.nombre || '').trim();
            if(!nombre) return;
            if(el.tagName === 'SELECT'){
                const opt = document.createElement('option');
                opt.value = nombre;
                opt.textContent = nombre;
                opt.dataset.ced = String(t.cedula || t.recurso_operativo_cedula || '').trim();
                opt.dataset.idc = String(t.id_codigo_consumidor || '').trim();
                el.appendChild(opt);
            }
            const ced = String(t.cedula || t.recurso_operativo_cedula || '').trim();
            const idc = String(t.id_codigo_consumidor || '').trim();
            __tecnicosIndex.set(nombre.toLowerCase(), { cedula: ced, id_codigo_consumidor: idc });
        });
        if(el.tagName === 'SELECT'){
            if(__gaContext && __gaContext.tecnico){
                el.value = __gaContext.tecnico;
            }
        }
        __tecnicosLoaded = true;
    }catch(_){ __tecnicosLoaded = true; }
}

function bindTecnicoInputListener(){
  const el = document.getElementById('gaTecnico');
  if(!el || el.dataset.bound === '1') return;
  const handler = () => {
    let nombre = '';
    let ced = '';
    let idc = '';
    if(el.tagName === 'SELECT'){
      const opt = el.options[el.selectedIndex];
      nombre = (opt && opt.textContent) ? opt.textContent.trim() : '';
      ced = opt && opt.dataset ? (opt.dataset.ced || '') : '';
      idc = opt && opt.dataset ? (opt.dataset.idc || '') : '';
    } else {
      const v = (el.value || '').trim();
      const info = __tecnicosIndex.get(v.toLowerCase()) || {};
      nombre = v;
      ced = info.cedula || '';
      idc = info.id_codigo_consumidor || '';
    }
    __gaContext.tecnico = nombre;
    __gaContext.tecnicoId = idc;
    __gaContext.externalId = ced;
    setInvalid('gaTecnico', !nombre);
    if(nombre){ guardarGestionBasica(); }
  };
  el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', handler);
  el.dataset.bound = '1';
}

function resetGestionActividadForm(){
  const setV = (id, v) => { try{ const el=document.getElementById(id); if(el) el.value=v; }catch(_){} };
  setV('gaOT','');
  setV('gaCuenta','');
  setV('gaTecnico','');
  setV('gaEstado','');
  setV('gaNombre','');
  setV('gaTipoActividad','');
  setV('gaDireccion','');
  setV('gaTiempoGestion','');
  setV('gaDuracion','');
  setV('gaTipoRazon','');
  setV('gaTipificacionOk','');
  setV('gaObservacionNovedad','');
  try{ const b=document.getElementById('gaAgendaCierreBlock'); if(b) b.style.display='none'; }catch(_){}
  setV('gaFechaAgendaCierre','');
  setV('gaFranjaCierre','');
  setV('gaAlertaCierre','');
  try{ const el=document.getElementById('gaCierreNo'); if(el){ el.checked=true; } }catch(_){}
  try{ const el=document.getElementById('subseccionCierre'); if(el){ el.style.display='none'; } }catch(_){}
  try{ const r=document.getElementById('gaConfirmEventoOkNo'); if(r){ r.checked=true; } }catch(_){}
  setV('gaRazonReal','');
  setV('gaObservacionesRazon','');
  try{ const r=document.getElementById('gaConfirmEventoNo'); if(r){ r.checked=true; } }catch(_){}
  setV('gaCanceladoTipificacion','');
  setV('gaCanceladoObservacion','');
}

async function abrirGestionActividad(ot, cuenta, tecnico, tecnicoId, estado, actividadId){
  resetGestionActividadForm();
  __gaContext = { ot, cuenta, tecnico, tecnicoId, estado, actividadId };
  document.getElementById('gaOT').value = ot || '';
  document.getElementById('gaCuenta').value = cuenta || '';
  document.getElementById('gaTecnico').value = tecnico || '';
  await cargarTecnicosDatalist();
  bindTecnicoInputListener();
  try{
    const fecha = (document.getElementById('filtroFecha')?.value || '').trim();
    const qs = new URLSearchParams({ ot, cuenta });
    if(fecha) qs.append('fecha', fecha);
    if (tecnicoId) qs.append('tecnico_id', String(tecnicoId));
    if (estado) qs.append('estado', String(estado));
    if (actividadId) qs.append('actividad_id', String(actividadId));
    const res = await fetch(`/api/analistas/actividad-detalle?${qs.toString()}`);
    const data = await res.json();
    const d = data && data.data ? data.data : {};
    const estFetched = String(d.estado || '').toLowerCase();
    const estParam = String(__gaContext.estado || '').toLowerCase();
    const estFinal = estFetched || estParam;
    document.getElementById('gaEstado').value = estFinal || '';
    document.getElementById('gaNombre').value = d.nombre_completo || '';
    document.getElementById('gaTipoActividad').value = d.tipo_de_actividad || '';
    document.getElementById('gaDireccion').value = d.direccion_campo_1 || d.direccion || '';
    document.getElementById('gaTiempoGestion').value = d.inicio_fin || '';
    document.getElementById('gaDuracion').value = d.duracion || d.duración || '';
    document.getElementById('gaTipoRazon').value = d.razon || d.razón || '';
    try{
      const confVal = (d.confirmacion_evento === 1 || String(d.confirmacion_evento).toLowerCase() === 'true') ? 'si' : 'no';
      const okSi = document.getElementById('gaConfirmEventoOkSi');
      const okNo = document.getElementById('gaConfirmEventoOkNo');
      if(confVal === 'si'){ if(okSi) okSi.checked = true; } else { if(okNo) okNo.checked = true; }
      const rzSi = document.getElementById('gaConfirmEventoSi');
      const rzNo = document.getElementById('gaConfirmEventoNo');
      if(confVal === 'si'){ if(rzSi) rzSi.checked = true; } else { if(rzNo) rzNo.checked = true; }
    }catch(_){}
    mostrarSeccionesPorEstado(estFinal);
    await actualizarEstadoFacturar(ot, cuenta);
    inicializarTipificaciones();
  }catch(e){
    mostrarSeccionesPorEstado('');
  }
  const m = new bootstrap.Modal(document.getElementById('modalGestionActividad'));
  m.show();
}

async function guardarGestionBasica(){
  try{
    const tecSel = (document.getElementById('gaTecnico')?.value || '').trim();
    setInvalid('gaTecnico', !tecSel);
    if(!tecSel){
      if(window.Swal){ Swal.fire({icon:'warning', title:'Falta técnico', text:'Seleccione técnico'}); } else { alert('Seleccione técnico'); }
      return;
    }
    const payload = {
      ot: __gaContext.ot,
      cuenta: __gaContext.cuenta,
      actividad_id: __gaContext.actividadId,
      tecnico: tecSel,
      external_id: (__gaContext.externalId || '').trim(),
      estado: (__gaContext.estado || '').trim(),
      nombre_completo: (document.getElementById('gaNombre')?.value || '').trim(),
      tipo_de_actividad: (document.getElementById('gaTipoActividad')?.value || '').trim(),
      direccion: (document.getElementById('gaDireccion')?.value || '').trim(),
      inicio_fin: (document.getElementById('gaTiempoGestion')?.value || '').trim(),
      duracion: (document.getElementById('gaDuracion')?.value || '').trim()
    };
    await fetch('/api/analistas/actividad-gestion-update', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
  }catch(_){ }
}

async function guardarEstadoInicial(ot, cuenta, estado, actividadId){
  try{
    const payload = { ot, cuenta, actividad_id: actividadId, estado };
    await fetch('/api/analistas/actividad-gestion-update', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
  }catch(_){}
}

function abrirOverlayImagen(src, titulo){
  try{
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.right = '0';
    overlay.style.bottom = '0';
    overlay.style.background = 'rgba(0,0,0,0.8)';
    overlay.style.zIndex = '1060';
    overlay.style.display = 'flex';
    overlay.style.alignItems = 'center';
    overlay.style.justifyContent = 'center';
    overlay.style.cursor = 'zoom-out';
    overlay.onclick = () => { try{ document.body.removeChild(overlay); }catch(_){} };
    const img = document.createElement('img');
    img.src = src || '';
    img.alt = titulo || '';
    img.style.maxWidth = '90vw';
    img.style.maxHeight = '90vh';
    img.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
    img.style.borderRadius = '6px';
    img.style.objectFit = 'contain';
    overlay.appendChild(img);
    document.body.appendChild(overlay);
  }catch(_){ }
}

function mostrarSeccionesPorEstado(estado){
  const ok = document.getElementById('seccionOk');
  const rz = document.getElementById('seccionRazon');
  const ca = document.getElementById('seccionCancelado');
  ok.style.display = estado === 'completado' ? 'block' : 'none';
  rz.style.display = estado === 'no completado' ? 'block' : 'none';
  ca.style.display = estado === 'cancelado' ? 'block' : 'none';
}

document.getElementById('gaCierreSi').addEventListener('change', () => {
  document.getElementById('subseccionCierre').style.display = 'block';
  updateRequiredUI();
});
document.getElementById('gaCierreNo').addEventListener('change', () => {
  document.getElementById('subseccionCierre').style.display = 'none';
  updateRequiredUI();
});

document.getElementById('btnFacturar').addEventListener('click', () => abrirFacturar());

try{
  const bindIds=['gaObservacionNovedad','gaFechaAgendaCierre','gaFranjaCierre','gaAlertaCierre'];
  bindIds.forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('input', updateRequiredUI); el.addEventListener('change', updateRequiredUI); } });
}catch(_){}

try{
  const modalEl = document.getElementById('modalGestionActividad');
  modalEl && modalEl.addEventListener('hidden.bs.modal', () => { resetGestionActividadForm(); });
}catch(_){ }

function abrirFacturar(){
  const bf = document.getElementById('btnFacturar');
  if (bf && bf.disabled) return;
  const frame = document.getElementById('facturarFrame');
  frame.src = '/analistas/ordenes_trabajo_preview';
  const modal = new bootstrap.Modal(document.getElementById('modalFacturarOT'));
  modal.show();
  frame.addEventListener('load', () => {
    try{
      const w = frame.contentWindow;
      const d = w.document;
      const btn = d.getElementById('btnNuevaOT');
      btn && btn.click();
          setTimeout(async () => {
            try{
              d.getElementById('inputOT').value = __gaContext.ot || '';
              d.getElementById('inputCuenta').value = __gaContext.cuenta || '';
              if (w && w.validarFormularioOT) { try { w.validarFormularioOT(); } catch(_){} }
              const tipo = (document.getElementById('gaTipoActividad')?.value || '').trim();
          if (tipo) {
            const resSug = await fetch(`/api/analistas/sugerir-tecnologia-categoria?tipo=${encodeURIComponent(tipo)}`);
            const sugJson = await resSug.json();
            const sug = sugJson && sugJson.sugerencia ? sugJson.sugerencia : {};
            const tec = sug.tecnologia || '';
            const cat = sug.categoria || '';
            const normalize = (s) => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
            const waitFor = async (fn, tries=20, delay=200) => {
              for(let i=0;i<tries;i++){ const v = fn(); if(v) return v; await new Promise(r=>setTimeout(r,delay)); }
              return null;
            };
            const selTec = await waitFor(() => d.getElementById('selectTecnologia'));
            if(selTec){
              await waitFor(() => selTec.options && selTec.options.length > 1);
              if (tec){
                let matched = false;
                for(const opt of selTec.options){
                  if(opt.value === tec || normalize(opt.textContent) === normalize(tec)) { selTec.value = opt.value; matched = true; break; }
                }
                if(!matched){
                  for(const opt of selTec.options){
                    if(normalize(opt.textContent).includes(normalize(tec))) { selTec.value = opt.value; matched = true; break; }
                  }
                }
                if(matched){
                  selTec.dispatchEvent(new Event('change'));
                  if (w.cargarCategorias) {
                    try { await w.cargarCategorias(selTec.value, 'selectCategoria'); } catch(_){ }
                  }
                  const infoId = 'sugerenciaInfo';
                  let infoEl = d.getElementById(infoId);
                  if(!infoEl){
                    infoEl = d.createElement('div');
                    infoEl.id = infoId;
                    infoEl.className = 'text-success small mt-1';
                    selTec.closest('.col-md-6')?.appendChild(infoEl);
                  }
                  infoEl.textContent = `Tecnología sugerida: ${selTec.value}`;
                  // categoría
                  if(cat){
                    const selCat = await waitFor(() => d.getElementById('selectCategoria'));
                    if(selCat){
                      await waitFor(() => !selCat.disabled && selCat.options && selCat.options.length > 1);
                      let cm = false;
                      for(const opt of selCat.options){
                        if(opt.value === cat || normalize(opt.textContent) === normalize(cat)) { selCat.value = opt.value; cm = true; break; }
                      }
                      if(!cm){
                        for(const opt of selCat.options){
                          if(normalize(opt.textContent).includes(normalize(cat))) { selCat.value = opt.value; cm = true; break; }
                        }
                      }
                      if(cm){ selCat.dispatchEvent(new Event('change')); }
                      const infoCatId = 'sugerenciaInfoCat';
                      let infoCatEl = d.getElementById(infoCatId);
                      if(!infoCatEl){
                        infoCatEl = d.createElement('div');
                        infoCatEl.id = infoCatId;
                        infoCatEl.className = cm ? 'text-success small mt-1' : 'text-warning small mt-1';
                        selCat.closest('.col-md-6')?.appendChild(infoCatEl);
                      }
                      infoCatEl.textContent = cm ? `Categoría sugerida: ${selCat.value}` : 'No se detectó categoría; seleccione manualmente.';
                    }
                  }
                } else {
                  const warnId = 'sugerenciaWarn';
                  let wEl = d.getElementById(warnId);
                  if(!wEl){
                    wEl = d.createElement('div');
                    wEl.id = warnId;
                    wEl.className = 'text-warning small mt-1';
                    selTec.closest('.col-md-6')?.appendChild(wEl);
                  }
                  wEl.textContent = 'No se detectó tecnología; seleccione manualmente.';
                }
              }
            }
          }
        }catch(_){}
      }, 400);
    }catch(_){}
  }, { once: true });

  // Al cerrar modal, verificar facturación
  document.getElementById('modalFacturarOT').addEventListener('hidden.bs.modal', () => {
    verificarFacturacion(__gaContext.ot, __gaContext.cuenta);
    actualizarEstadoFacturar(__gaContext.ot, __gaContext.cuenta);
  }, { once: true });
}

async function verificarFacturacion(ot, cuenta){
  try{
    const qs = new URLSearchParams({ ot, cuenta });
    const res = await fetch(`/api/analistas/ot-existe?${qs.toString()}`);
    const data = await res.json();
  if(data && data.exists){
      await fetch('/api/analistas/actividad-marcar-facturada', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ot, cuenta, actividad_id: __gaContext.actividadId })
      });
    }
  }catch(_){}
}

async function actualizarEstadoFacturar(ot, cuenta){
  const btn = document.getElementById('btnFacturar');
  const info = document.getElementById('facturarInfo');
  if(!btn) return;
  try{
    const qs = new URLSearchParams({ ot, cuenta });
    const res = await fetch(`/api/analistas/ot-existe?${qs.toString()}`);
    const data = await res.json();
    const exists = !!(data && data.exists);
    btn.disabled = exists;
    if(info){
      if(exists){
        info.className = 'text-warning small mt-2';
        info.textContent = 'OT ya registrada para esta actividad';
      }else{
        info.className = 'd-none';
        info.textContent = '';
      }
    }
  }catch(_){
    btn.disabled = false;
    if(info){ info.className = 'd-none'; info.textContent = ''; }
  }
}

function inicializarTipificaciones(){
  const okOpts = [
    'CLIENTE INCONFORME',
    'CLIENTE CONFIRMA SERVICIOS OK'
  ];
  const razonRealOpts = [
    'CLIENTE AUN NO DESEA EL TRABAJO',
    'PROBLEMAS EN LA RED EXTERNA',
    'REQUIERE MOVIL ELITE',
    'DUCTOS INFRAESTRUCTURA PREDIO NO APTA',
    'PROBLEMAS EN SISTEMAS DE INFORMACION/APLICATIVOS CLARO',
    'SUSCRIPTOR YA NO DESEA EL SERVICIO',
    'NO CONTACTO CON EL CLIENTE',
    'REQUIERE AMPLIACION DE PUERTOS',
    'REPLANTEAMIENTO VT',
    'MAL AGENDADO/MAL PROGRAMADO',
    'FUERA ZONA/ SIN COBERTURA RED',
    'PERMISOS DE ADMINISTRACION',
    'VENTA DEVUELTA AL ASESOR',
    'EQUIPOS CLIENTE NO APTOS/NO DISPONIBLES',
    'CLIENTE SOLICITA REPROGRAMAR',
    'NO INGRESO/CLIENTE CONFIRMA SERVICIO OK',
    'DIRECCION Y/O DATOS ERRADOS',
    'INCUMPLIMIENTO ALIADO',
    'PROBLEMA ORDEN PUBLICO/ZONA ROJA',
    'SUSCRIPTOR NO ESTA EN CONDICION DE ATENDER',
    'MAL CLIMA POR LLUVIAS'
  ];
  const selOk = document.getElementById('gaTipificacionOk');
  
  const selRz = document.getElementById('gaRazonReal');
  if(selOk){
    const current = selOk.value;
    selOk.innerHTML = '<option value="">Seleccione...</option>';
    okOpts.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; selOk.appendChild(o); });
    if(current && okOpts.includes(current)) selOk.value = current;
    const agendaBlock = document.getElementById('gaAgendaCierreBlock');
    const toggleAgenda = () => {
      const val = (selOk.value || '').trim().toUpperCase();
      if(agendaBlock){ agendaBlock.style.display = val === 'CLIENTE INCONFORME' ? '' : 'none'; }
      updateRequiredUI();
    };
    selOk.addEventListener('change', toggleAgenda);
    toggleAgenda();
  }
  if(selRz){
    const currentR = selRz.value;
    selRz.innerHTML = '<option value="">Seleccione...</option>';
    razonRealOpts.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; selRz.appendChild(o); });
    if(currentR && razonRealOpts.includes(currentR)) selRz.value = currentR;
  }
  const selCancel = document.getElementById('gaCanceladoTipificacion');
  if(selCancel){
    const cur = selCancel.value;
    selCancel.innerHTML = '<option value="">Seleccione...</option>';
    [
      'TECNICO SOLICITO CANCELAR LA VISITA',
      'CLIENTE REAGENDA LA VISITA',
      'OTRA'
    ].forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; selCancel.appendChild(o); });
    if(cur) selCancel.value = cur;
  }
  const obsCancel = document.getElementById('gaCanceladoObservacion');
  const updateCancelObs = () => {
    const v = (selCancel && selCancel.value ? selCancel.value : '').trim().toUpperCase();
    if(obsCancel){ obsCancel.disabled = false; }
  };
  if(selCancel){ selCancel.addEventListener('change', updateCancelObs); updateCancelObs(); }
  const btnFin = document.getElementById('btnFinalizarCierre');
  if(btnFin){
    btnFin.onclick = finalizarCierre;
  }
  const btnFinalizarOk = document.getElementById('btnFinalizarOk');
  if(btnFinalizarOk){
    btnFinalizarOk.onclick = () => {
      const cierreSi = !!document.getElementById('gaCierreSi')?.checked;
      if(cierreSi) finalizarCierre(); else finalizarSinCierre();
    };
  }
  const btnFinR = document.getElementById('btnFinalizarRazon');
  if(btnFinR){
    btnFinR.onclick = finalizarRazon;
  }
  const btnFinC = document.getElementById('btnFinalizarCancelado');
  if(btnFinC){
    btnFinC.onclick = finalizarCancelado;
  }
}

function setInvalid(id, invalid){ const el=document.getElementById(id); if(!el) return; if(invalid){ el.classList.add('is-invalid'); } else { el.classList.remove('is-invalid'); } }
function updateRequiredUI(){
  const cierreSi = !!document.getElementById('gaCierreSi')?.checked;
  const okVal = (document.getElementById('gaTipificacionOk')?.value || '').trim().toUpperCase();
  const active = cierreSi && okVal === 'CLIENTE INCONFORME';
  const show = (id)=>{ const el=document.getElementById(id); if(el) el.style.display = active ? '' : 'none'; };
  show('reqObs'); show('reqFecha'); show('reqFranja'); show('reqAlerta');
  const obs = (document.getElementById('gaObservacionNovedad')?.value || '').trim();
  const fecha = (document.getElementById('gaFechaAgendaCierre')?.value || '').trim();
  const franja = (document.getElementById('gaFranjaCierre')?.value || '').trim();
  const alerta = (document.getElementById('gaAlertaCierre')?.value || '').trim();
  setInvalid('gaObservacionNovedad', active && !obs);
  setInvalid('gaFechaAgendaCierre', active && !fecha);
  setInvalid('gaFranjaCierre', active && !franja);
  setInvalid('gaAlertaCierre', active && !alerta);
  const tecnVal = (document.getElementById('gaTecnico')?.value || '').trim();
  setInvalid('gaTecnico', !tecnVal);
}

async function finalizarCierre(){
  try{
    {
      const tecVal = (document.getElementById('gaTecnico')?.value || '').trim();
      setInvalid('gaTecnico', !tecVal);
      if(!tecVal){
        if(window.Swal){ Swal.fire({icon:'warning', title:'Falta técnico', text:'Seleccione técnico'}); } else { alert('Seleccione técnico'); }
        return;
      }
    }
    try{ await guardarGestionBasica(); }catch(_){ }
    const ok = document.getElementById('gaTipificacionOk').value;
    const obs = document.getElementById('gaObservacionNovedad').value.trim();
    const confValOk = (document.querySelector('input[name="gaConfirmEventoOk"]:checked') || {}).value || 'no';
    const confirmacion_evento = confValOk.toLowerCase() === 'si' ? 1 : 0;
    const tipUpper = (ok||'').trim().toUpperCase();
    let fechaAgenda = '';
    let franja = '';
    let alerta = '';
  if(tipUpper === 'CLIENTE INCONFORME'){
      fechaAgenda = (document.getElementById('gaFechaAgendaCierre')?.value || '').trim();
      franja = (document.getElementById('gaFranjaCierre')?.value || '').trim();
      alerta = (document.getElementById('gaAlertaCierre')?.value || '').trim();
      const faltantes = [];
      if(!obs) faltantes.push('Observación');
      if(!fechaAgenda) faltantes.push('Fecha Agenda cierre ciclo');
      if(!franja) faltantes.push('Franja de cierre de ciclo');
      if(!alerta) faltantes.push('Nivel de Alerta');
      if(faltantes.length > 0){
        setInvalid('gaObservacionNovedad', !obs);
        setInvalid('gaFechaAgendaCierre', !fechaAgenda);
        setInvalid('gaFranjaCierre', !franja);
        setInvalid('gaAlertaCierre', !alerta);
        const msg = 'Campos requeridos: ' + faltantes.join(', ');
        if(window.Swal){ Swal.fire({icon:'warning', title:'Datos incompletos', text: msg}); } else { alert(msg); }
        return;
      }
    }
    const payload = { ot: __gaContext.ot, cuenta: __gaContext.cuenta, actividad_id: __gaContext.actividadId, tipificacion_ok: ok || null, tipificacion_novedad: null, observacion: obs || null, confirmacion_evento, cierre_ciclo: 1 };
    if(__gaContext.externalId){ payload.external_id = __gaContext.externalId; }
    if(tipUpper === 'CLIENTE INCONFORME'){
      if(fechaAgenda) payload.fecha_franja_cierre_ciclo = fechaAgenda;
      if(franja) payload.franja_cierre_ciclo = franja;
      if(alerta) payload.alerta_cierre_ciclo = alerta;
    }
    const res = await fetch('/api/analistas/actividad-cierre', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data && data.success){
      if(window.Swal){ Swal.fire({icon:'success', title:'Guardado', text:'Cierre de ciclo actualizado'}); }
      const mm = bootstrap.Modal.getInstance(document.getElementById('modalGestionActividad'));
      mm && mm.hide();
      try{ await cargarLista(); }catch(_){}
    }else{
      const msg = (data && data.code === 'BLOCKED_BY_CUTOFF') ? 'Fuera de ventana: cierre bloqueado después del corte' : (data && data.error ? String(data.error) : 'Error al guardar');
      if(window.Swal){ Swal.fire({icon:'warning', title:'No guardado', text: msg}); }
    }
  }catch(e){
    if(window.Swal){ Swal.fire({icon:'error', title:'Error', text:'Error al guardar cierre de ciclo'}); }
  }
}

async function finalizarSinCierre(){
  try{
    {
      const tecVal = (document.getElementById('gaTecnico')?.value || '').trim();
      setInvalid('gaTecnico', !tecVal);
      if(!tecVal){
        if(window.Swal){ Swal.fire({icon:'warning', title:'Falta técnico', text:'Seleccione técnico'}); } else { alert('Seleccione técnico'); }
        return;
      }
    }
    try{ await guardarGestionBasica(); }catch(_){}
    const confValOk = (document.querySelector('input[name="gaConfirmEventoOk"]:checked') || {}).value || 'no';
    const confirmacion_evento = confValOk.toLowerCase() === 'si' ? 1 : 0;
    const payload = { ot: __gaContext.ot, cuenta: __gaContext.cuenta, actividad_id: __gaContext.actividadId, confirmacion_evento, cierre_ciclo: 0 };
    if(__gaContext.externalId){ payload.external_id = __gaContext.externalId; }
    const res = await fetch('/api/analistas/actividad-cierre', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data && data.success){
      if(window.Swal){ Swal.fire({icon:'success', title:'Finalizado', text:'Actividad marcada como finalizada'}); }
      const mm = bootstrap.Modal.getInstance(document.getElementById('modalGestionActividad'));
      mm && mm.hide();
      try{ await cargarLista(); }catch(_){}
    }else{
      const msg = (data && data.code === 'BLOCKED_BY_CUTOFF') ? 'Fuera de ventana: cierre bloqueado después del corte' : (data && data.error ? String(data.error) : 'Error al finalizar');
      if(window.Swal){ Swal.fire({icon:'warning', title:'No guardado', text: msg}); }
    }
  }catch(e){
    if(window.Swal){ Swal.fire({icon:'error', title:'Error', text:'Error al finalizar actividad'}); }
  }
}

async function finalizarRazon(){
  try{
    {
      const tecVal = (document.getElementById('gaTecnico')?.value || '').trim();
      setInvalid('gaTecnico', !tecVal);
      if(!tecVal){
        if(window.Swal){ Swal.fire({icon:'warning', title:'Falta técnico', text:'Seleccione técnico'}); } else { alert('Seleccione técnico'); }
        return;
      }
    }
    try{ await guardarGestionBasica(); }catch(_){}
    const razonReal = document.getElementById('gaRazonReal').value;
    const aplicaVal = (document.querySelector('input[name="gaTipoRazonAplica"]:checked') || {}).value || 'no';
    const aplica = aplicaVal.toLowerCase() === 'si' ? 1 : 0;
    const obs = document.getElementById('gaObservacionesRazon').value.trim();
    const confVal = (document.querySelector('input[name="gaConfirmEvento"]:checked') || {}).value || 'no';
    const confirmacion_evento = confVal.toLowerCase() === 'si' ? 1 : 0;
    const payload = { ot: __gaContext.ot, cuenta: __gaContext.cuenta, actividad_id: __gaContext.actividadId, tipificacion_razon: razonReal || null, tipo_razon_aplica: aplica, observacion_razon: obs || null, confirmacion_evento };
    if(__gaContext.externalId){ payload.external_id = __gaContext.externalId; }
    const res = await fetch('/api/analistas/actividad-razon', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data && data.success){
      if(window.Swal){ Swal.fire({icon:'success', title:'Guardado', text:'Razón guardada y actividad finalizada'}); }
      const mm = bootstrap.Modal.getInstance(document.getElementById('modalGestionActividad'));
      mm && mm.hide();
      try{ await cargarLista(); }catch(_){}
    }else{
      const msg = (data && data.code === 'BLOCKED_BY_CUTOFF') ? 'Fuera de ventana: cierre bloqueado después del corte' : (data && data.error ? String(data.error) : 'Error al guardar');
      if(window.Swal){ Swal.fire({icon:'warning', title:'No guardado', text: msg}); }
    }
  }catch(e){
    if(window.Swal){ Swal.fire({icon:'error', title:'Error', text:'Error al guardar razón'}); }
  }
}

async function finalizarCancelado(){
  try{
    {
      const tecVal = (document.getElementById('gaTecnico')?.value || '').trim();
      setInvalid('gaTecnico', !tecVal);
      if(!tecVal){
        if(window.Swal){ Swal.fire({icon:'warning', title:'Falta técnico', text:'Seleccione técnico'}); } else { alert('Seleccione técnico'); }
        return;
      }
    }
    try{ await guardarGestionBasica(); }catch(_){}
    const tip = document.getElementById('gaCanceladoTipificacion').value;
    const obsRaw = document.getElementById('gaCanceladoObservacion').value.trim();
    const tipUpper = (tip || '').trim().toUpperCase();
    const opcionTexto = tipUpper === 'OTRA' ? (obsRaw || null) : null;
    const payload = { ot: __gaContext.ot, cuenta: __gaContext.cuenta, actividad_id: __gaContext.actividadId, cancelado_tipificacion: tip || null, cancelado_observacion: (obsRaw || null), cancelado_opcion_texto: opcionTexto };
    if(__gaContext.externalId){ payload.external_id = __gaContext.externalId; }
    const res = await fetch('/api/analistas/actividad-cancelado', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data && data.success){
      if(window.Swal){ Swal.fire({icon:'success', title:'Guardado', text:'Cancelado guardado y actividad finalizada'}); }
      const mm = bootstrap.Modal.getInstance(document.getElementById('modalGestionActividad'));
      mm && mm.hide();
      try{ await cargarLista(); }catch(_){}
    }else{
      const msg = (data && data.code === 'BLOCKED_BY_CUTOFF') ? 'Fuera de ventana: cierre bloqueado después del corte' : (data && data.error ? String(data.error) : 'Error al guardar');
      if(window.Swal){ Swal.fire({icon:'warning', title:'No guardado', text: msg}); }
    }
  }catch(e){
    if(window.Swal){ Swal.fire({icon:'error', title:'Error', text:'Error al guardar cancelado'}); }
  }
}
</script>
{% endblock %}

<div class="modal fade" id="modalImagenGestionado" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="gdImgTitulo"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img id="gdImgAmpliada" class="img-fluid" style="max-height:80vh;" />
      </div>
    </div>
  </div>
</div>

<script>
function abrirModalImagen(src, titulo){
  const im = document.getElementById('gdImgAmpliada');
  const tt = document.getElementById('gdImgTitulo');
  if (tt) tt.textContent = titulo || '';
  if (im) im.src = src || '';
  const m = new bootstrap.Modal(document.getElementById('modalImagenGestionado'));
  m.show();
}
