{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Actividades Diarias</h3>
        </div>
        <div class="card-body">
          {% if mostrar_cargue %}
          <p class="text-muted mb-3">Cargar actividades desde Excel para registrar en la base de datos.</p>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCargarActividades">
            <i class="fas fa-upload me-2"></i>Cargue de actividades
          </button>
          {% endif %}
          <div class="row mt-3">
            <div class="col-md-4">
              <label class="form-label">Fecha</label>
              <input type="date" class="form-control" id="filtroFecha" />
            </div>
            {% if session.get('user_role') in ['administrativo','lider'] or session.get('id_codigo_consumidor')|int == 26 %}
            <div class="col-md-4">
              <label class="form-label">Analista</label>
              <input type="text" class="form-control" id="filtroAnalista" list="listaAnalistas" placeholder="Escriba nombre del analista" />
              <datalist id="listaAnalistas"></datalist>
            </div>
            {% endif %}
            <div class="col-md-2 d-flex align-items-end">
              <button class="btn btn-outline-primary w-100" id="btnFiltrarFecha"><i class="fas fa-filter me-2"></i>Filtrar</button>
            </div>
            {% if session.get('user_role') == 'administrativo' %}
            <div class="col-auto d-flex align-items-end">
              <div class="btn-group">
                <button class="btn btn-success" id="btnExportCsv" onclick="exportarActividades('csv')"><i class="fas fa-file-csv me-2"></i>Export CSV</button>
                <button class="btn btn-secondary" id="btnExportXlsx" onclick="exportarActividades('xlsx')"><i class="fas fa-file-excel me-2"></i>Export Excel</button>
              </div>
            </div>
            {% endif %}
            <div class="col d-flex align-items-end justify-content-end">
              <div id="resumenTop" class="d-flex gap-2"></div>
            </div>
          </div>
          <div class="table-responsive mt-3" id="resumenEstado"></div>
          <div class="table-responsive mt-4">
            <table class="table table-striped table-hover" id="tablaActividades">
              <thead>
                <tr>
                  <th>Cuenta</th>
                  <th>OT</th>
                  <th>Técnico</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-2" id="paginadorActividades">
            <div class="small text-muted" id="paginadorInfo"></div>
            <ul class="pagination pagination-sm mb-0" id="paginadorControles"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if mostrar_cargue %}
  <div class="modal fade" id="modalCargarActividades" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-file-excel me-2"></i>Subir archivo de actividades</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formCargarActividades">
            <div class="mb-3">
              <label class="form-label">Archivo</label>
              <input type="file" class="form-control" id="archivoActividades" accept=".xlsx,.xls,.csv" required />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="button" class="btn btn-primary" id="btnSubirActividades">Subir</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
const __btnSubir = document.getElementById('btnSubirActividades');
if(__btnSubir){
__btnSubir.addEventListener('click', async function(){
  const input = document.getElementById('archivoActividades');
  if (!input.files || !input.files[0]) {
    Swal.fire({icon:'warning', title:'Seleccione un archivo'});
    return;
  }
  const formData = new FormData();
  formData.append('file', input.files[0]);
  try {
    const endpoint = "{{ api_endpoint or '/api/lider/cargar-actividades' }}";
    const res = await fetch(endpoint, { method:'POST', body: formData });
    const data = await res.json();
    if (res.ok && data.success) {
      const msg = data.message || `Insertadas: ${data.rows_inserted || 0} • Actualizadas: ${data.rows_updated || 0}`;
      Swal.fire({icon:'success', title:'Cargado', text: msg});
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalCargarActividades'));
      modal && modal.hide();
      document.getElementById('formCargarActividades').reset();
      await cargarLista();
    } else {
      Swal.fire({icon:'error', title:'Error', text:data.message || 'Error al cargar'});
    }
  } catch (e) {
    Swal.fire({icon:'error', title:'Error de red'});
  }
});
}

async function cargarLista(){
  const listEndpoint = "{{ list_endpoint or '/api/analistas/actividades-diarias' }}";
  try{
    const fecha = document.getElementById('filtroFecha').value;
    let url = fecha ? `${listEndpoint}?fecha=${encodeURIComponent(fecha)}` : listEndpoint;
    const analistaInput = document.getElementById('filtroAnalista');
    const analista = analistaInput ? analistaInput.value.trim() : '';
    if(analista){
      url += (url.includes('?') ? '&' : '?') + `analista=${encodeURIComponent(analista)}`;
    }
    const res = await fetch(url);
    const data = await res.json();
    const rawItems = Array.isArray(data.items) ? data.items : [];
    __items = rawItems.filter(it => {
      const e = (it.estado || '').toString().toLowerCase().trim();
      return e === 'completado' || e === 'no completado' || e === 'cancelado';
    });
    const orderEstado = { 'completado': 0, 'no completado': 1, 'cancelado': 2 };
    __items.sort((a, b) => {
      const ea = (a.estado || '').toString().toLowerCase().trim();
      const eb = (b.estado || '').toString().toLowerCase().trim();
      const oa = orderEstado[ea] ?? 99;
      const ob = orderEstado[eb] ?? 99;
      return oa - ob;
    });
    __page = 1;
    renderTabla();
    renderPaginador();
    renderResumen();
  }catch(e){
  }
}

document.addEventListener('DOMContentLoaded', () => {
  const inputFecha = document.getElementById('filtroFecha');
  try{
    if(inputFecha && !inputFecha.value){
      const nowStr = new Date().toLocaleString('en-US', { timeZone: 'America/Bogota' });
      const now = new Date(nowStr);
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      inputFecha.value = `${yyyy}-${mm}-${dd}`;
    }
  }catch(_){}
  cargarLista();
});
const __btnFiltro = document.getElementById('btnFiltrarFecha');
if(__btnFiltro){ __btnFiltro.addEventListener('click', cargarLista); }

function exportarActividades(formato){
  try{
    const f = (formato || 'csv').toLowerCase();
    let url = `/api/analistas/actividades-diarias/export?formato=${encodeURIComponent(f)}&mensual=1&gestionadas=1`;
    window.open(url, '_blank');
  }catch(_){ }
}

let __items = [];
let __page = 1;
const __pageSize = 10;
let __baseResumen = {};

function renderTabla(){
  const tbody = document.querySelector('#tablaActividades tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  const start = (__page - 1) * __pageSize;
  const end = start + __pageSize;
  const pageItems = __items.slice(start, end);
  pageItems.forEach(item => {
    const tr = document.createElement('tr');
    const cuenta = formatCuenta(item.numero_de_cuenta);
    const ot = formatOT(item.orden_de_trabajo);
    const tecnico = item.tecnico ?? '';
    const fin = String(item.estado_final ?? '').trim();
    const isFin = fin === '1' || fin.toLowerCase() === 'true';
    const estado = (item.estado || '').toLowerCase();
    const fechaRaw = item.fecha;
    const bloqueado = debeBloquearGestion(fechaRaw);
    const estadoBadge = estado === 'completado' ? '<span class="badge bg-success">Completado</span>' : (estado === 'no completado' ? '<span class="badge bg-warning text-dark">No completado</span>' : (estado === 'cancelado' ? '<span class="badge bg-danger">Cancelado</span>' : '<span class="badge bg-secondary">N/A</span>'));
    tr.innerHTML = `
      <td>${cuenta}</td>
      <td>${ot}</td>
      <td>${tecnico}</td>
      <td>${estadoBadge}</td>
      <td>
        <button class="btn btn-sm btn-primary" ${isFin || bloqueado ? 'disabled' : ''} title="${bloqueado ? 'Bloqueado por corte de medio día' : ''}" onclick="abrirGestionActividad('${ot}','${cuenta}','${tecnico}')">
          <i class="fas fa-tools me-1"></i>Gestionar
        </button>
        ${isFin ? '<span class="badge bg-success ms-2">Finalizado</span>' : ''}
      </td>`;
    tbody.appendChild(tr);
  });
}

function renderPaginador(){
  const info = document.getElementById('paginadorInfo');
  const ctrls = document.getElementById('paginadorControles');
  if(!info || !ctrls) return;
  const total = __items.length;
  const totalPages = Math.max(1, Math.ceil(total / __pageSize));
  const start = total === 0 ? 0 : (__page - 1) * __pageSize + 1;
  const end = Math.min(total, __page * __pageSize);
  info.textContent = `Mostrando ${start}–${end} de ${total}`;
  let html = '';
  const prevDisabled = __page <= 1 ? ' disabled' : '';
  html += `<li class="page-item${prevDisabled}"><a class="page-link" href="#" data-page="prev">Anterior</a></li>`;
  const windowSize = 5;
  let startPage = Math.max(1, __page - Math.floor(windowSize/2));
  let endPage = Math.min(totalPages, startPage + windowSize - 1);
  startPage = Math.max(1, endPage - windowSize + 1);
  for(let p = startPage; p <= endPage; p++){
    const active = p === __page ? ' active' : '';
    html += `<li class="page-item${active}"><a class="page-link" href="#" data-page="${p}">${p}</a></li>`;
  }
  const nextDisabled = __page >= totalPages ? ' disabled' : '';
  html += `<li class="page-item${nextDisabled}"><a class="page-link" href="#" data-page="next">Siguiente</a></li>`;
  ctrls.innerHTML = html;
}

async function renderResumen(){
  const cont = document.getElementById('resumenEstado');
  if(!cont) return;
  const fecha = document.getElementById('filtroFecha')?.value || '';
  const analista = (document.getElementById('filtroAnalista')?.value || '').trim();
  let url = '/api/analistas/actividades-diarias/resumen';
  const params = [];
  if(fecha) params.push(`fecha=${encodeURIComponent(fecha)}`);
  if(analista) params.push(`analista=${encodeURIComponent(analista)}`);
  if(params.length){ url += `?${params.join('&')}`; }
  try{
    const res = await fetch(url);
    if(res.ok){
      const data = await res.json();
      if(data && data.success){
        const r = data.resumen || {};
        const c = r.completado || { cantidad: 0, gestionada: 0 };
        const n = r.no_completado || { cantidad: 0, gestionada: 0 };
        const k = r.cancelado || { cantidad: 0, gestionada: 0 };
        const pComp = c.cantidad ? (c.gestionada * 100) / c.cantidad : 0;
        const pNComp = n.cantidad ? (n.gestionada * 100) / n.cantidad : 0;
        const pCancel = k.cantidad ? (k.gestionada * 100) / k.cantidad : 0;
        const fmt = (v) => `${v.toFixed(1)}%`;
        const m = data.mensual || { cantidad: 0, gestionada: 0 };
        const mk = (m.cancelado || { cantidad: 0, gestionada: 0 });
        const totalCant = m.cantidad || 0;
        const totalGest = m.gestionada || 0;
        const totalPct = m.cantidad ? (m.gestionada * 100) / m.cantidad : 0;
        const cc = data.cierre_ciclo || { meta_mensual: 260, gestionada: 0, porcentaje_meta: 0 };
        const ccMeta = typeof cc.meta_mensual === 'number' ? cc.meta_mensual : (Number(cc.meta_mensual) || 260);
        const ccGest = typeof cc.gestionada === 'number' ? cc.gestionada : (Number(cc.gestionada) || 0);
        const ccPct = typeof cc.porcentaje_meta === 'number' ? cc.porcentaje_meta : (Number(cc.porcentaje_meta) || 0);
        const top = document.getElementById('resumenTop');
        if(top){
          top.classList.add('flex-column');
          top.innerHTML = `
            <div class="d-flex gap-2 justify-content-end mb-1">
              <div class="badge bg-secondary p-2">Cantidad (mes): <span class="fw-bold">${totalCant}</span></div>
              <div class="badge bg-info p-2">Gestionada (mes): <span class="fw-bold">${totalGest}</span></div>
              <div class="badge bg-success p-2">Finalizado (mes): <span class="fw-bold">${fmt(totalPct)}</span></div>
            </div>
            <div class="d-flex gap-2 justify-content-end mb-1">
              <div class="badge bg-danger p-2">Cancelado (mes): <span class="fw-bold">${mk.cantidad}</span></div>
              <div class="badge bg-danger p-2">Cancelado gestionado (mes): <span class="fw-bold">${mk.gestionada}</span></div>
            </div>
            <div class="d-flex gap-2 justify-content-end">
              <div class="badge bg-warning p-2">Cierre Ciclo (mes): <span class="fw-bold">${ccGest}</span></div>
              <div class="badge bg-dark p-2">Meta Cierre: <span class="fw-bold">${ccMeta}</span></div>
              <div class="badge bg-primary p-2">Cierre %: <span class="fw-bold">${fmt(ccPct)}</span></div>
            </div>
          `;
        }
        cont.innerHTML = `
          <table class="table table-sm table-bordered mb-0">
            <thead class="table-primary">
              <tr>
                <th>Estado</th>
                <th>Cantidad</th>
                <th>Cantidad gestionada</th>
                <th>Finalizado %</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="badge bg-success">Completado</span></td>
                <td>${c.cantidad}</td>
                <td>${c.gestionada}</td>
                <td>${fmt(pComp)}</td>
              </tr>
              <tr>
                <td><span class="badge bg-warning text-dark">No completado</span></td>
                <td>${n.cantidad}</td>
                <td>${n.gestionada}</td>
                <td>${fmt(pNComp)}</td>
              </tr>
              <tr>
                 <td><span class="badge bg-danger">Cancelado</span></td>
                 <td>${k.cantidad}</td>
                 <td>${k.gestionada}</td>
                 <td>${fmt(pCancel)}</td>
               </tr>
            </tbody>
          </table>
        `;
        return;
      }
    }
  }catch(_){ }
  let comp = 0, compGest = 0, ncomp = 0, ncompGest = 0, canc = 0, cancGest = 0;
  for(const it of __items){
    const e = String(it.estado || '').toLowerCase().trim();
    const fin = (()=>{const v=String(it.estado_final ?? '').trim().toLowerCase();return v==='1'||v==='true';})();
    if(e==='completado'){ comp++; if(fin) compGest++; }
    else if(e==='no completado'){ ncomp++; if(fin) ncompGest++; }
    else if(e==='cancelado'){ canc++; if(fin) cancGest++; }
  }
  const fmt = (v) => `${v.toFixed(1)}%`;
  const pComp = comp ? (compGest * 100) / comp : 0;
  const pNComp = ncomp ? (ncompGest * 100) / ncomp : 0;
  const pCanc = canc ? (cancGest * 100) / canc : 0;
  const totalCant = comp + ncomp + canc;
  const totalGest = compGest + ncompGest + cancGest;
  const totalPct = totalCant ? (totalGest * 100) / totalCant : 0;
  const top = document.getElementById('resumenTop');
  if(top){
    top.innerHTML = `
      <div class="badge bg-secondary p-2">Cantidad (día): <span class="fw-bold">${totalCant}</span></div>
      <div class="badge bg-info p-2">Gestionada (día): <span class="fw-bold">${totalGest}</span></div>
      <div class="badge bg-success p-2">Finalizado (día): <span class="fw-bold">${fmt(totalPct)}</span></div>
    `;
  }
  cont.innerHTML = `
    <table class="table table-sm table-bordered mb-0">
      <thead class="table-primary">
        <tr>
          <th>Estado</th>
          <th>Cantidad</th>
          <th>Cantidad gestionada</th>
          <th>Finalizado %</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><span class="badge bg-success">Completado</span></td>
          <td>${comp}</td>
          <td>${compGest}</td>
          <td>${fmt(pComp)}</td>
        </tr>
        <tr>
          <td><span class="badge bg-warning text-dark">No completado</span></td>
          <td>${ncomp}</td>
          <td>${ncompGest}</td>
          <td>${fmt(pNComp)}</td>
        </tr>
        <tr>
          <td><span class="badge bg-danger">Cancelado</span></td>
          <td>${canc}</td>
          <td>${cancGest}</td>
          <td>${fmt(pCanc)}</td>
        </tr>
      </tbody>
    </table>
  `;
}

document.getElementById('paginadorActividades').addEventListener('click', (e) => {
  const a = e.target.closest('[data-page]');
  if(!a) return;
  e.preventDefault();
  const totalPages = Math.max(1, Math.ceil(__items.length / __pageSize));
  const dp = a.getAttribute('data-page');
  if(dp === 'prev'){ if(__page > 1) __page--; }
  else if(dp === 'next'){ if(__page < totalPages) __page++; }
  else { const np = parseInt(dp, 10); if(!isNaN(np)) __page = Math.min(Math.max(1, np), totalPages); }
  renderTabla();
  renderPaginador();
});

async function initAnalistas(){
  const dl = document.getElementById('listaAnalistas');
  const input = document.getElementById('filtroAnalista');
  if(!dl || !input) return;
  try{
    const res = await fetch('/api/lider/inicio-operacion/analistas');
    if(res.ok){
      const data = await res.json();
      const arr = data && data.analistas ? data.analistas : [];
      dl.innerHTML = '';
      arr.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        dl.appendChild(opt);
      });
    }
  }catch(_){}
}
document.addEventListener('DOMContentLoaded', initAnalistas);

function formatCuenta(v){
  try{
    const s = String(v ?? '').trim();
    if(!s) return '';
    const i = parseInt(s.split('.')[0], 10);
    return isNaN(i) ? s : i.toString();
  }catch(_){ return v ?? ''; }
}
function formatFecha(v){
  try{
    if(!v) return '';
    const s = String(v).trim();
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:\s|T|$)/);
    if(m){
      return `${m[3]}/${m[2]}/${m[1]}`;
    }
    const d = new Date(s);
    if(!isNaN(d.getTime())){
      const parts = new Intl.DateTimeFormat('es-CO', { timeZone: 'America/Bogota', year: 'numeric', month: '2-digit', day: '2-digit' }).formatToParts(d);
      const day = parts.find(p=>p.type==='day').value;
      const month = parts.find(p=>p.type==='month').value;
      const year = parts.find(p=>p.type==='year').value;
      return `${day}/${month}/${year}`;
    }
    return s;
  }catch(_){ return v; }
}
function formatOT(v){
  try{
    const s = String(v ?? '').trim();
    if(!s) return '';
    const m = s.match(/^(\d+)/);
    const base = m ? m[1] : s.split('.')[0];
    const i = parseInt(base, 10);
    return isNaN(i) ? s : i.toString();
  }catch(_){ return v ?? ''; }
}

function debeBloquearGestion(fechaRaw){
  try{
    const nowStr = new Date().toLocaleString('en-US', { timeZone: 'America/Bogota' });
    const now = new Date(nowStr);
    const bloqueoInicio = new Date('2025-12-10T12:00:00-05:00');
    if (now.getTime() < bloqueoInicio.getTime()) { return false; }
    const s = String(fechaRaw ?? '').trim();
    let y = null, m = null, d = null;
    const rx = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(rx){ y = parseInt(rx[1],10); m = parseInt(rx[2],10); d = parseInt(rx[3],10); }
    else{
      const f = (document.getElementById('filtroFecha')?.value || '').trim();
      const r2 = f.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!r2) return false;
      y = parseInt(r2[1],10); m = parseInt(r2[2],10); d = parseInt(r2[3],10);
    }
    const deadline = new Date(y, m-1, d+1, 12, 0, 0);
    return now.getTime() >= deadline.getTime();
  }catch(_){ return false; }
}

// Modal de gestión de actividad
</script>

<!-- Modal Gestión de Actividad -->
<div class="modal fade" id="modalGestionActividad" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-clipboard-check me-2"></i>Gestión de Actividad</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          <!-- Datos Actividad -->
          <div class="card mb-3">
            <div class="card-header fw-bold">Datos Actividad</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label">Cuenta</label>
                  <input type="text" class="form-control" id="gaCuenta" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label">OT</label>
                  <input type="text" class="form-control" id="gaOT" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Estado</label>
                  <input type="text" class="form-control" id="gaEstado" readonly>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Técnico</label>
                  <input type="text" class="form-control" id="gaTecnico" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- Datos Gestión -->
          <div class="card mb-3">
            <div class="card-header fw-bold">Datos Gestión</div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Nombre</label>
                  <input type="text" class="form-control" id="gaNombre" readonly>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tipo de Actividad</label>
                  <input type="text" class="form-control" id="gaTipoActividad" readonly>
                </div>
                <div class="col-12">
                  <label class="form-label">Dirección</label>
                  <input type="text" class="form-control" id="gaDireccion" readonly>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Tiempo Gestión (Inicio–Fin)</label>
                  <input type="text" class="form-control" id="gaTiempoGestion" readonly>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Duración</label>
                  <input type="text" class="form-control" id="gaDuracion" readonly>
                </div>
              </div>
            </div>
          </div>

          <!-- Gestión -->
          <div class="card">
            <div class="card-header fw-bold">Gestión</div>
            <div class="card-body">
              <!-- Sección OK -->
              <div id="seccionOk" style="display:none;">
                <div class="alert alert-success mb-3"><i class="fas fa-check-circle me-2"></i>Estado: Completado</div>
                <div class="row g-3 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label">Facturación</label><br>
                    <button class="btn btn-outline-success" id="btnFacturar">
                      <i class="fas fa-file-invoice-dollar me-2"></i>Facturar
                    </button>
                    <div id="facturarInfo" class="d-none"></div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Cierre de ciclo</label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaCierreCiclo" id="gaCierreNo" value="no" checked>
                        <label class="form-check-label" for="gaCierreNo">No</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaCierreCiclo" id="gaCierreSi" value="si">
                        <label class="form-check-label" for="gaCierreSi">Sí</label>
                      </div>
                     </div>
                  </div>
                </div>
                <div class="row g-3 mt-3">
                  <div class="col-md-6">
                    <label class="form-label">Confirmación de evento</label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaConfirmEventoOk" id="gaConfirmEventoOkNo" value="no" checked>
                        <label class="form-check-label" for="gaConfirmEventoOkNo">No</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaConfirmEventoOk" id="gaConfirmEventoOkSi" value="si">
                        <label class="form-check-label" for="gaConfirmEventoOkSi">Sí</label>
                      </div>
                    </div>
                  </div>
                </div>
                <div id="subseccionCierre" class="mt-3" style="display:none;">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Tipificación OK</label>
                      <select class="form-select" id="gaTipificacionOk">
                        <option value="">Seleccione...</option>
                      </select>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Observación</label>
                      <input type="text" class="form-control" id="gaObservacionNovedad" placeholder="Observaciones...">
                    </div>
                  </div>
                </div>
                <div class="mt-3 d-flex justify-content-end">
                  <button type="button" class="btn btn-warning" id="btnFinalizarOk">
                    <i class="fas fa-save me-2"></i>Finalizar
                  </button>
                </div>
              </div>

              <!-- Sección Razón -->
              <div id="seccionRazon" style="display:none;">
                <div class="alert alert-warning mb-3"><i class="fas fa-exclamation-circle me-2"></i>Estado: No Completado</div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Tipo Razón (de la actividad)</label>
                    <input type="text" class="form-control" id="gaTipoRazon" readonly>
                    <div class="form-text">Seleccione si aplica o no</div>
                    <div class="d-flex gap-3 mt-2">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaTipoRazonAplica" id="gaTRNo" value="no" checked>
                        <label class="form-check-label" for="gaTRNo">No</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaTipoRazonAplica" id="gaTRSi" value="si">
                        <label class="form-check-label" for="gaTRSi">Sí</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Razón Real</label>
                    <select class="form-select" id="gaRazonReal">
                      <option value="">Seleccione...</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Confirmación de evento</label>
                    <div class="d-flex gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaConfirmEvento" id="gaConfirmEventoNo" value="no" checked>
                        <label class="form-check-label" for="gaConfirmEventoNo">No</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="gaConfirmEvento" id="gaConfirmEventoSi" value="si">
                        <label class="form-check-label" for="gaConfirmEventoSi">Sí</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Observaciones</label>
                    <input type="text" class="form-control" id="gaObservacionesRazon" placeholder="Observaciones...">
                  </div>
                  <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-warning" id="btnFinalizarRazon">
                      <i class="fas fa-save me-2"></i>Finalizar
                    </button>
                  </div>
                </div>
              </div>

              <div id="seccionCancelado" style="display:none;">
                <div class="alert alert-danger mb-3"><i class="fas fa-ban me-2"></i>Estado: Cancelado</div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Tipificación Cancelado</label>
                    <select class="form-select" id="gaCanceladoTipificacion">
                      <option value="">Seleccione...</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Observación</label>
                    <input type="text" class="form-control" id="gaCanceladoObservacion" placeholder="Observaciones...">
                  </div>
                  <div class="col-12 d-flex justify-content-end">
                    <button type="button" class="btn btn-warning" id="btnFinalizarCancelado">
                      <i class="fas fa-save me-2"></i>Finalizar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Facturar (iframe del formulario de OT) -->
<div class="modal fade" id="modalFacturarOT" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-file-invoice-dollar me-2"></i>Nueva Orden de Trabajo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="height: 80vh;">
        <iframe id="facturarFrame" src="" style="width:100%; height:100%; border:0;"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<script>
let __gaContext = { ot: '', cuenta: '', tecnico: '' };

async function abrirGestionActividad(ot, cuenta, tecnico){
  __gaContext = { ot, cuenta, tecnico };
  document.getElementById('gaOT').value = ot || '';
  document.getElementById('gaCuenta').value = cuenta || '';
  document.getElementById('gaTecnico').value = tecnico || '';
  try{
    const fecha = (document.getElementById('filtroFecha')?.value || '').trim();
    const qs = new URLSearchParams({ ot, cuenta });
    if(fecha) qs.append('fecha', fecha);
    const res = await fetch(`/api/analistas/actividad-detalle?${qs.toString()}`);
    const data = await res.json();
    const d = data && data.data ? data.data : {};
    document.getElementById('gaEstado').value = d.estado || '';
    document.getElementById('gaNombre').value = d.nombre_completo || '';
    document.getElementById('gaTipoActividad').value = d.tipo_de_actividad || '';
    document.getElementById('gaDireccion').value = d.direccion_campo_1 || d.direccion || '';
    document.getElementById('gaTiempoGestion').value = d.inicio_fin || '';
    document.getElementById('gaDuracion').value = d.duracion || d.duración || '';
    document.getElementById('gaTipoRazon').value = d.razon || d.razón || '';
    try{
      const confVal = (d.confirmacion_evento === 1 || String(d.confirmacion_evento).toLowerCase() === 'true') ? 'si' : 'no';
      const okSi = document.getElementById('gaConfirmEventoOkSi');
      const okNo = document.getElementById('gaConfirmEventoOkNo');
      if(confVal === 'si'){ if(okSi) okSi.checked = true; } else { if(okNo) okNo.checked = true; }
      const rzSi = document.getElementById('gaConfirmEventoSi');
      const rzNo = document.getElementById('gaConfirmEventoNo');
      if(confVal === 'si'){ if(rzSi) rzSi.checked = true; } else { if(rzNo) rzNo.checked = true; }
    }catch(_){}
    mostrarSeccionesPorEstado((d.estado || '').toLowerCase());
    await actualizarEstadoFacturar(ot, cuenta);
    inicializarTipificaciones();
  }catch(e){
    mostrarSeccionesPorEstado('');
  }
  const m = new bootstrap.Modal(document.getElementById('modalGestionActividad'));
  m.show();
}

function mostrarSeccionesPorEstado(estado){
  const ok = document.getElementById('seccionOk');
  const rz = document.getElementById('seccionRazon');
  const ca = document.getElementById('seccionCancelado');
  ok.style.display = estado === 'completado' ? 'block' : 'none';
  rz.style.display = estado === 'no completado' ? 'block' : 'none';
  ca.style.display = estado === 'cancelado' ? 'block' : 'none';
}

document.getElementById('gaCierreSi').addEventListener('change', () => {
  document.getElementById('subseccionCierre').style.display = 'block';
});
document.getElementById('gaCierreNo').addEventListener('change', () => {
  document.getElementById('subseccionCierre').style.display = 'none';
});

document.getElementById('btnFacturar').addEventListener('click', () => abrirFacturar());

function abrirFacturar(){
  const bf = document.getElementById('btnFacturar');
  if (bf && bf.disabled) return;
  const frame = document.getElementById('facturarFrame');
  frame.src = '/analistas/ordenes_trabajo_preview';
  const modal = new bootstrap.Modal(document.getElementById('modalFacturarOT'));
  modal.show();
  frame.addEventListener('load', () => {
    try{
      const w = frame.contentWindow;
      const d = w.document;
      const btn = d.getElementById('btnNuevaOT');
      btn && btn.click();
          setTimeout(async () => {
            try{
              d.getElementById('inputOT').value = __gaContext.ot || '';
              d.getElementById('inputCuenta').value = __gaContext.cuenta || '';
              if (w && w.validarFormularioOT) { try { w.validarFormularioOT(); } catch(_){} }
              const tipo = (document.getElementById('gaTipoActividad')?.value || '').trim();
          if (tipo) {
            const resSug = await fetch(`/api/analistas/sugerir-tecnologia-categoria?tipo=${encodeURIComponent(tipo)}`);
            const sugJson = await resSug.json();
            const sug = sugJson && sugJson.sugerencia ? sugJson.sugerencia : {};
            const tec = sug.tecnologia || '';
            const cat = sug.categoria || '';
            const normalize = (s) => (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
            const waitFor = async (fn, tries=20, delay=200) => {
              for(let i=0;i<tries;i++){ const v = fn(); if(v) return v; await new Promise(r=>setTimeout(r,delay)); }
              return null;
            };
            const selTec = await waitFor(() => d.getElementById('selectTecnologia'));
            if(selTec){
              await waitFor(() => selTec.options && selTec.options.length > 1);
              if (tec){
                let matched = false;
                for(const opt of selTec.options){
                  if(opt.value === tec || normalize(opt.textContent) === normalize(tec)) { selTec.value = opt.value; matched = true; break; }
                }
                if(!matched){
                  for(const opt of selTec.options){
                    if(normalize(opt.textContent).includes(normalize(tec))) { selTec.value = opt.value; matched = true; break; }
                  }
                }
                if(matched){
                  selTec.dispatchEvent(new Event('change'));
                  if (w.cargarCategorias) {
                    try { await w.cargarCategorias(selTec.value, 'selectCategoria'); } catch(_){ }
                  }
                  const infoId = 'sugerenciaInfo';
                  let infoEl = d.getElementById(infoId);
                  if(!infoEl){
                    infoEl = d.createElement('div');
                    infoEl.id = infoId;
                    infoEl.className = 'text-success small mt-1';
                    selTec.closest('.col-md-6')?.appendChild(infoEl);
                  }
                  infoEl.textContent = `Tecnología sugerida: ${selTec.value}`;
                  // categoría
                  if(cat){
                    const selCat = await waitFor(() => d.getElementById('selectCategoria'));
                    if(selCat){
                      await waitFor(() => !selCat.disabled && selCat.options && selCat.options.length > 1);
                      let cm = false;
                      for(const opt of selCat.options){
                        if(opt.value === cat || normalize(opt.textContent) === normalize(cat)) { selCat.value = opt.value; cm = true; break; }
                      }
                      if(!cm){
                        for(const opt of selCat.options){
                          if(normalize(opt.textContent).includes(normalize(cat))) { selCat.value = opt.value; cm = true; break; }
                        }
                      }
                      if(cm){ selCat.dispatchEvent(new Event('change')); }
                      const infoCatId = 'sugerenciaInfoCat';
                      let infoCatEl = d.getElementById(infoCatId);
                      if(!infoCatEl){
                        infoCatEl = d.createElement('div');
                        infoCatEl.id = infoCatId;
                        infoCatEl.className = cm ? 'text-success small mt-1' : 'text-warning small mt-1';
                        selCat.closest('.col-md-6')?.appendChild(infoCatEl);
                      }
                      infoCatEl.textContent = cm ? `Categoría sugerida: ${selCat.value}` : 'No se detectó categoría; seleccione manualmente.';
                    }
                  }
                } else {
                  const warnId = 'sugerenciaWarn';
                  let wEl = d.getElementById(warnId);
                  if(!wEl){
                    wEl = d.createElement('div');
                    wEl.id = warnId;
                    wEl.className = 'text-warning small mt-1';
                    selTec.closest('.col-md-6')?.appendChild(wEl);
                  }
                  wEl.textContent = 'No se detectó tecnología; seleccione manualmente.';
                }
              }
            }
          }
        }catch(_){}
      }, 400);
    }catch(_){}
  }, { once: true });

  // Al cerrar modal, verificar facturación
  document.getElementById('modalFacturarOT').addEventListener('hidden.bs.modal', () => {
    verificarFacturacion(__gaContext.ot, __gaContext.cuenta);
    actualizarEstadoFacturar(__gaContext.ot, __gaContext.cuenta);
  }, { once: true });
}

async function verificarFacturacion(ot, cuenta){
  try{
    const qs = new URLSearchParams({ ot, cuenta });
    const res = await fetch(`/api/analistas/ot-existe?${qs.toString()}`);
    const data = await res.json();
    if(data && data.exists){
      await fetch('/api/analistas/actividad-marcar-facturada', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ot, cuenta })
      });
    }
  }catch(_){}
}

async function actualizarEstadoFacturar(ot, cuenta){
  const btn = document.getElementById('btnFacturar');
  const info = document.getElementById('facturarInfo');
  if(!btn) return;
  try{
    const qs = new URLSearchParams({ ot, cuenta });
    const res = await fetch(`/api/analistas/ot-existe?${qs.toString()}`);
    const data = await res.json();
    const exists = !!(data && data.exists);
    btn.disabled = exists;
    if(info){
      if(exists){
        info.className = 'text-warning small mt-2';
        info.textContent = 'OT ya registrada para esta actividad';
      }else{
        info.className = 'd-none';
        info.textContent = '';
      }
    }
  }catch(_){
    btn.disabled = false;
    if(info){ info.className = 'd-none'; info.textContent = ''; }
  }
}

function inicializarTipificaciones(){
  const okOpts = [
    'CLIENTE INCONFORME',
    'CLIENTE CONFIRMA SERVICIOS OK'
  ];
  const razonRealOpts = [
    'CLIENTE AUN NO DESEA EL TRABAJO',
    'PROBLEMAS EN LA RED EXTERNA',
    'REQUIERE MOVIL ELITE',
    'DUCTOS INFRAESTRUCTURA PREDIO NO APTA',
    'PROBLEMAS EN SISTEMAS DE INFORMACION/APLICATIVOS CLARO',
    'SUSCRIPTOR YA NO DESEA EL SERVICIO',
    'NO CONTACTO CON EL CLIENTE',
    'REQUIERE AMPLIACION DE PUERTOS',
    'REPLANTEAMIENTO VT',
    'MAL AGENDADO/MAL PROGRAMADO',
    'FUERA ZONA/ SIN COBERTURA RED',
    'PERMISOS DE ADMINISTRACION',
    'VENTA DEVUELTA AL ASESOR',
    'EQUIPOS CLIENTE NO APTOS/NO DISPONIBLES',
    'CLIENTE SOLICITA REPROGRAMAR',
    'NO INGRESO/CLIENTE CONFIRMA SERVICIO OK',
    'DIRECCION Y/O DATOS ERRADOS',
    'INCUMPLIMIENTO ALIADO',
    'PROBLEMA ORDEN PUBLICO/ZONA ROJA',
    'SUSCRIPTOR NO ESTA EN CONDICION DE ATENDER',
    'MAL CLIMA POR LLUVIAS'
  ];
  const selOk = document.getElementById('gaTipificacionOk');
  
  const selRz = document.getElementById('gaRazonReal');
  if(selOk){
    const current = selOk.value;
    selOk.innerHTML = '<option value="">Seleccione...</option>';
    okOpts.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; selOk.appendChild(o); });
    if(current && okOpts.includes(current)) selOk.value = current;
  }
  if(selRz){
    const currentR = selRz.value;
    selRz.innerHTML = '<option value="">Seleccione...</option>';
    razonRealOpts.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; selRz.appendChild(o); });
    if(currentR && razonRealOpts.includes(currentR)) selRz.value = currentR;
  }
  const selCancel = document.getElementById('gaCanceladoTipificacion');
  if(selCancel){
    const cur = selCancel.value;
    selCancel.innerHTML = '<option value="">Seleccione...</option>';
    [
      'TECNICO SOLICITO CANCELAR LA VISITA',
      'CLIENTE REAGENDA LA VISITA',
      'OTRA'
    ].forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; selCancel.appendChild(o); });
    if(cur) selCancel.value = cur;
  }
  const obsCancel = document.getElementById('gaCanceladoObservacion');
  const updateCancelObs = () => {
    const v = (selCancel && selCancel.value ? selCancel.value : '').trim().toUpperCase();
    if(obsCancel){ obsCancel.disabled = false; }
  };
  if(selCancel){ selCancel.addEventListener('change', updateCancelObs); updateCancelObs(); }
  const btnFin = document.getElementById('btnFinalizarCierre');
  if(btnFin){
    btnFin.onclick = finalizarCierre;
  }
  const btnFinalizarOk = document.getElementById('btnFinalizarOk');
  if(btnFinalizarOk){
    btnFinalizarOk.onclick = () => {
      const cierreSi = !!document.getElementById('gaCierreSi')?.checked;
      if(cierreSi) finalizarCierre(); else finalizarSinCierre();
    };
  }
  const btnFinR = document.getElementById('btnFinalizarRazon');
  if(btnFinR){
    btnFinR.onclick = finalizarRazon;
  }
  const btnFinC = document.getElementById('btnFinalizarCancelado');
  if(btnFinC){
    btnFinC.onclick = finalizarCancelado;
  }
}

async function finalizarCierre(){
  try{
    const ok = document.getElementById('gaTipificacionOk').value;
    const obs = document.getElementById('gaObservacionNovedad').value.trim();
    const confValOk = (document.querySelector('input[name="gaConfirmEventoOk"]:checked') || {}).value || 'no';
    const confirmacion_evento = confValOk.toLowerCase() === 'si' ? 1 : 0;
    const payload = { ot: __gaContext.ot, cuenta: __gaContext.cuenta, tipificacion_ok: ok || null, tipificacion_novedad: null, observacion: obs || null, confirmacion_evento, cierre_ciclo: 1 };
    const res = await fetch('/api/analistas/actividad-cierre', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data && data.success){
      if(window.Swal){ Swal.fire({icon:'success', title:'Guardado', text:'Cierre de ciclo actualizado'}); }
      const mm = bootstrap.Modal.getInstance(document.getElementById('modalGestionActividad'));
      mm && mm.hide();
      try{ await cargarLista(); }catch(_){}
    }else{
      if(window.Swal){ Swal.fire({icon:'warning', title:'No guardado', text: data && data.error ? String(data.error) : 'Error al guardar'}); }
    }
  }catch(e){
    if(window.Swal){ Swal.fire({icon:'error', title:'Error', text:'Error al guardar cierre de ciclo'}); }
  }
}

async function finalizarSinCierre(){
  try{
    const confValOk = (document.querySelector('input[name="gaConfirmEventoOk"]:checked') || {}).value || 'no';
    const confirmacion_evento = confValOk.toLowerCase() === 'si' ? 1 : 0;
    const payload = { ot: __gaContext.ot, cuenta: __gaContext.cuenta, confirmacion_evento, cierre_ciclo: 0 };
    const res = await fetch('/api/analistas/actividad-cierre', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data && data.success){
      if(window.Swal){ Swal.fire({icon:'success', title:'Finalizado', text:'Actividad marcada como finalizada'}); }
      const mm = bootstrap.Modal.getInstance(document.getElementById('modalGestionActividad'));
      mm && mm.hide();
      try{ await cargarLista(); }catch(_){}
    }else{
      if(window.Swal){ Swal.fire({icon:'warning', title:'No guardado', text: data && data.error ? String(data.error) : 'Error al finalizar'}); }
    }
  }catch(e){
    if(window.Swal){ Swal.fire({icon:'error', title:'Error', text:'Error al finalizar actividad'}); }
  }
}

async function finalizarRazon(){
  try{
    const razonReal = document.getElementById('gaRazonReal').value;
    const aplicaVal = (document.querySelector('input[name="gaTipoRazonAplica"]:checked') || {}).value || 'no';
    const aplica = aplicaVal.toLowerCase() === 'si' ? 1 : 0;
    const obs = document.getElementById('gaObservacionesRazon').value.trim();
    const confVal = (document.querySelector('input[name="gaConfirmEvento"]:checked') || {}).value || 'no';
    const confirmacion_evento = confVal.toLowerCase() === 'si' ? 1 : 0;
    const payload = { ot: __gaContext.ot, cuenta: __gaContext.cuenta, tipificacion_razon: razonReal || null, tipo_razon_aplica: aplica, observacion_razon: obs || null, confirmacion_evento };
    const res = await fetch('/api/analistas/actividad-razon', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data && data.success){
      if(window.Swal){ Swal.fire({icon:'success', title:'Guardado', text:'Razón guardada y actividad finalizada'}); }
      const mm = bootstrap.Modal.getInstance(document.getElementById('modalGestionActividad'));
      mm && mm.hide();
      try{ await cargarLista(); }catch(_){}
    }else{
      if(window.Swal){ Swal.fire({icon:'warning', title:'No guardado', text: data && data.error ? String(data.error) : 'Error al guardar'}); }
    }
  }catch(e){
    if(window.Swal){ Swal.fire({icon:'error', title:'Error', text:'Error al guardar razón'}); }
  }
}

async function finalizarCancelado(){
  try{
    const tip = document.getElementById('gaCanceladoTipificacion').value;
    const obsRaw = document.getElementById('gaCanceladoObservacion').value.trim();
    const tipUpper = (tip || '').trim().toUpperCase();
    const opcionTexto = tipUpper === 'OTRA' ? (obsRaw || null) : null;
    const payload = { ot: __gaContext.ot, cuenta: __gaContext.cuenta, cancelado_tipificacion: tip || null, cancelado_observacion: (obsRaw || null), cancelado_opcion_texto: opcionTexto };
    const res = await fetch('/api/analistas/actividad-cancelado', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if(res.ok && data && data.success){
      if(window.Swal){ Swal.fire({icon:'success', title:'Guardado', text:'Cancelado guardado y actividad finalizada'}); }
      const mm = bootstrap.Modal.getInstance(document.getElementById('modalGestionActividad'));
      mm && mm.hide();
      try{ await cargarLista(); }catch(_){}
    }else{
      if(window.Swal){ Swal.fire({icon:'warning', title:'No guardado', text: data && data.error ? String(data.error) : 'Error al guardar'}); }
    }
  }catch(e){
    if(window.Swal){ Swal.fire({icon:'error', title:'Error', text:'Error al guardar cancelado'}); }
  }
}
</script>
{% endblock %}
