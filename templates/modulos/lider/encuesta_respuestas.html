{% extends "header.html" %}
{% block content %}
<style>
  .resp-card { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
  .table thead th { background:#f4f6fb; }
</style>

<div class="container py-4">
  <div class="d-flex align-items-center mb-3">
    <i class="fas fa-list-alt text-primary me-2" style="font-size:1.5rem"></i>
    <h1 class="mb-0">Respuestas de Encuesta</h1>
  </div>

  <div class="mb-3">
    <a class="btn btn-outline-secondary" href="/lider/encuestas"><i class="fas fa-arrow-left me-1"></i>Volver</a>
    <a id="btn-preview" class="btn btn-outline-primary"><i class="fas fa-eye me-1"></i>Previsualizar</a>
    <a id="btn-exportar" class="btn btn-success"><i class="fas fa-file-excel me-1"></i>Exportar Excel</a>
  </div>

  <div class="resp-card p-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div>
        <h6 id="enc-title" class="mb-0">Encuesta</h6>
        <div id="enc-desc" class="text-muted small"></div>
      </div>
      <div id="enc-badges"></div>
    </div>

    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>ID</th>
          <th>Fecha</th>
          <th>Usuario</th>
          <th>Resumen</th>
        </tr>
      </thead>
      <tbody id="respuestas-body"></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  const encuestaId = {{ encuesta_id }};
  const tbody = document.getElementById('respuestas-body');
  const encTitle = document.getElementById('enc-title');
  const encDesc = document.getElementById('enc-desc');
  const encBadges = document.getElementById('enc-badges');
  const btnPreview = document.getElementById('btn-preview');
  const btnExportar = document.getElementById('btn-exportar');

  btnPreview.href = `/lider/encuestas/${encuestaId}/preview`;

  function showToast(title, text, icon='success'){
    if (window.Swal) Swal.fire({ title, text, icon, timer: 1500, showConfirmButton:false });
    else alert(title + ' - ' + text);
  }

  async function cargarEncabezado(){
    const res = await fetch(`/api/encuestas/${encuestaId}`);
    const data = await res.json();
    if (!data.success) return;
    const enc = data.encuesta;
    encTitle.textContent = enc.titulo;
    encDesc.textContent = enc.descripcion || '';
    encBadges.innerHTML = `<span class="badge bg-info me-1">${enc.estado}</span>` +
                          `<span class="badge bg-dark me-1">${enc.visibilidad || 'privada'}</span>`;
    // Cargar estadísticas para mostrar total de respuestas y preparar exportación
    try {
      const sRes = await fetch(`/api/encuestas/${encuestaId}/estadisticas`);
      const sData = await sRes.json();
      if (sData && sData.success) {
        encBadges.innerHTML += ` <span class="badge bg-success">Respuestas: ${sData.total_respuestas}</span>`;
        btnExportar.href = `/api/encuestas/${encuestaId}/respuestas/export?formato=excel`;
      }
    } catch (e) { console.warn('[respuestas] No se pudieron cargar estadísticas', e); }
  }

  function resumenRespuesta(detalles) {
    const parts = [];
    (detalles || []).forEach(d => {
      const label = d.texto_pregunta || ('Pregunta ' + d.pregunta_id);
      if (d.archivo_url) {
        const isImg = /\.(png|jpe?g|gif|bmp|webp|svg)(\?.*)?$/i.test(d.archivo_url);
        const content = isImg
          ? `<a href="#" class="link-imagen" data-img="${d.archivo_url}">Imagen</a>`
          : `<a href="${d.archivo_url}" target="_blank">Archivo</a>`;
        parts.push(`${label}: ${content}`);
        return;
      }
      let valor = d.valor_texto;
      if (d.valor_numero != null) valor = d.valor_numero;
      if (d.texto_opcion) valor = d.texto_opcion;
      parts.push(`${label}: ${valor ?? ''}`);
    });
    return parts.join(' | ');
  }

  async function cargarRespuestas(){
    const res = await fetch(`/api/encuestas/${encuestaId}/respuestas`);
    const data = await res.json();
    if (!data.success) { showToast('Error', data.message || 'No se pudieron cargar respuestas', 'error'); return; }
    tbody.innerHTML = '';
    (data.respuestas || []).forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id_respuesta}</td>
        <td>${r.fecha_respuesta}</td>
        <td>${r.usuario_id ?? ''}</td>
        <td>${resumenRespuesta(r.detalles)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  cargarEncabezado();
  cargarRespuestas();

  // Ver imagen en popup
  tbody.addEventListener('click', (ev) => {
    const a = ev.target.closest('.link-imagen');
    if (!a) return;
    ev.preventDefault();
    const url = a.dataset.img;
    if (window.Swal) {
      Swal.fire({
        imageUrl: url,
        imageAlt: 'Imagen de respuesta',
        showConfirmButton: false,
        showCloseButton: true,
        width: 'auto',
        background: '#111',
      });
    } else {
      const w = window.open('', '_blank');
      w.document.write(`<img src="${url}" style="max-width:100%;height:auto;display:block;margin:auto">`);
    }
  });
})();
</script>
{% endblock %}