{% extends "header.html" %}
{% block content %}
<style>
  .resp-card { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
  .table thead th { background:#f4f6fb; }
</style>

<div class="container py-4">
  <div class="d-flex align-items-center mb-3">
    <i class="fas fa-list-alt text-primary me-2" style="font-size:1.5rem"></i>
    <h1 class="mb-0">Respuestas de Encuesta</h1>
  </div>

  <div class="mb-3">
    <a class="btn btn-outline-secondary" href="/lider/encuestas"><i class="fas fa-arrow-left me-1"></i>Volver</a>
    <a id="btn-preview" class="btn btn-outline-primary"><i class="fas fa-eye me-1"></i>Previsualizar</a>
    <a id="btn-exportar" class="btn btn-success"><i class="fas fa-file-excel me-1"></i>Exportar Excel</a>
  </div>

  <div class="resp-card p-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div>
        <h6 id="enc-title" class="mb-0">Encuesta</h6>
        <div id="enc-desc" class="text-muted small"></div>
      </div>
      <div id="enc-badges"></div>
    </div>

    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>Técnico</th>
          <th>Supervisor</th>
          <th>Carpeta</th>
          <th>Fecha</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="respuestas-body"></tbody>
    </table>
  </div>
</div>

<script>
(() => {
  const encuestaId = {{ encuesta_id }};
  const tbody = document.getElementById('respuestas-body');
  const encTitle = document.getElementById('enc-title');
  const encDesc = document.getElementById('enc-desc');
  const encBadges = document.getElementById('enc-badges');
  const btnPreview = document.getElementById('btn-preview');
  const btnExportar = document.getElementById('btn-exportar');

  btnPreview.href = `/lider/encuestas/${encuestaId}/preview`;

  function showToast(title, text, icon='success'){
    if (window.Swal) Swal.fire({ title, text, icon, timer: 1500, showConfirmButton:false });
    else alert(title + ' - ' + text);
  }

  async function cargarEncabezado(){
    const res = await fetch(`/api/encuestas/${encuestaId}`);
    const data = await res.json();
    if (!data.success) return;
    const enc = data.encuesta;
    encTitle.textContent = enc.titulo;
    encDesc.textContent = enc.descripcion || '';
    encBadges.innerHTML = `<span class="badge bg-info me-1">${enc.estado}</span>` +
                          `<span class="badge bg-dark me-1">${enc.visibilidad || 'privada'}</span>`;
    // Cargar estadísticas para mostrar total de respuestas y preparar exportación
    try {
      const sRes = await fetch(`/api/encuestas/${encuestaId}/estadisticas`);
      const sData = await sRes.json();
      if (sData && sData.success) {
        encBadges.innerHTML += ` <span class="badge bg-success">Respuestas: ${sData.total_respuestas}</span>`;
        btnExportar.href = `/api/encuestas/${encuestaId}/respuestas/export?formato=excel`;
      }
    } catch (e) { console.warn('[respuestas] No se pudieron cargar estadísticas', e); }
  }

  async function cargarRespuestas(){
    const res = await fetch(`/api/encuestas/${encuestaId}/audiencia-estado`);
    const data = await res.json();
    if (!data.success) { showToast('Error', data.message || 'No se pudieron cargar técnicos habilitados', 'error'); return; }
    tbody.innerHTML = '';
    (data.tecnicos || []).forEach(t => {
      const tr = document.createElement('tr');
      const fecha = t.fecha ? t.fecha : '';
      const estadoBadge = t.estado === 'ok' ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-warning text-dark">Pendiente</span>';
      tr.innerHTML = `
        <td>${t.nombre ?? t.id}</td>
        <td>${t.supervisor ?? ''}</td>
        <td>${t.carpeta ?? ''}</td>
        <td>${fecha}</td>
        <td>${estadoBadge}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  cargarEncabezado();
  cargarRespuestas();

  // Sin manejo de imágenes en esta vista (listado de estado por técnico)
})();
</script>
{% endblock %}