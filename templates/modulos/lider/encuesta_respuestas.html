{% extends "header.html" %}
{% block content %}
<style>
  .resp-card { background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.08); }
  .table thead th { background:#f4f6fb; }
</style>

<div class="container py-4">
  <div class="d-flex align-items-center mb-3">
    <i class="fas fa-list-alt text-primary me-2" style="font-size:1.5rem"></i>
    <h1 class="mb-0">Respuestas de Encuesta</h1>
  </div>

  <div class="mb-3">
    <a class="btn btn-outline-secondary" href="/lider/encuestas"><i class="fas fa-arrow-left me-1"></i>Volver</a>
    <a id="btn-preview" class="btn btn-outline-primary"><i class="fas fa-eye me-1"></i>Previsualizar</a>
    <a id="btn-exportar" class="btn btn-success"><i class="fas fa-file-excel me-1"></i>Exportar Excel</a>
    <a id="btn-exportar-zip" class="btn btn-info"><i class="fas fa-file-archive me-1"></i>Exportar ZIP</a>
  </div>

  <div class="resp-card p-3">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div>
        <h6 id="enc-title" class="mb-0">Encuesta</h6>
        <div id="enc-desc" class="text-muted small"></div>
      </div>
      <div id="enc-badges"></div>
    </div>

    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>Técnico</th>
          <th>Supervisor</th>
          <th>Carpeta</th>
          <th>Fecha</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="respuestas-body"></tbody>
    </table>
  </div>

  <!-- Sección de Puntajes -->
  <div id="seccion-puntajes" class="resp-card p-3 mt-4" style="display: none;">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0"><i class="fas fa-star text-warning me-2"></i>Puntajes de la Encuesta</h5>
      <div class="d-flex align-items-center gap-2">
        <div class="input-group input-group-sm" style="width: 220px;">
          <label class="input-group-text" for="timer-select">Timer</label>
          <select id="timer-select" class="form-select">
            <option value="30">30s</option>
            <option value="60">60s</option>
            <option value="90">90s</option>
            <option value="120">120s</option>
            <option value="240" selected>240s</option>
          </select>
        </div>
        <button id="btn-iniciar-timer" class="btn btn-sm btn-outline-danger">
          <i class="fas fa-hourglass-start me-1"></i>Iniciar
        </button>
        <span id="timer-remaining" class="badge bg-secondary">—</span>
        <button id="btn-refrescar-puntajes" class="btn btn-sm btn-outline-primary">
          <i class="fas fa-sync-alt me-1"></i>Actualizar
        </button>
      </div>
    </div>
    
    <div class="table-responsive">
      <table class="table table-sm table-striped">
        <thead class="table-primary">
          <tr>
            <th>Posición</th>
            <th>Técnico</th>
            <th>Supervisor</th>
            <th>Carpeta</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Tiempo (s)</th>
            <th>Puntaje</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="puntajes-body">
          <tr>
            <td colspan="9" class="text-center text-muted py-4">
              <i class="fas fa-spinner fa-spin me-2"></i>Cargando puntajes...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(() => {
  const encuestaId = {{ encuesta_id }};
  const tbody = document.getElementById('respuestas-body');
  const encTitle = document.getElementById('enc-title');
  const encDesc = document.getElementById('enc-desc');
  const encBadges = document.getElementById('enc-badges');
  const btnPreview = document.getElementById('btn-preview');
  const btnExportar = document.getElementById('btn-exportar');
  const btnExportarZip = document.getElementById('btn-exportar-zip');
  const timerSelect = document.getElementById('timer-select');
  const btnIniciarTimer = document.getElementById('btn-iniciar-timer');
  const timerRemainingEl = document.getElementById('timer-remaining');
  let timerInterval = null;
  let timerEndMs = null;

  btnPreview.href = `/lider/encuestas/${encuestaId}/preview`;

  function showToast(title, text, icon='success'){
    if (window.Swal) Swal.fire({ title, text, icon, timer: 1500, showConfirmButton:false });
    else alert(title + ' - ' + text);
  }

  async function cargarEncabezado(){
    const res = await fetch(`/api/encuestas/${encuestaId}`);
    const data = await res.json();
    if (!data.success) return;
    const enc = data.encuesta;
    encTitle.textContent = enc.titulo;
    encDesc.textContent = enc.descripcion || '';
    encBadges.innerHTML = `<span class="badge bg-info me-1">${enc.estado}</span>` +
                          `<span class="badge bg-dark me-1">${enc.visibilidad || 'privada'}</span>`;
    // Cargar estadísticas para mostrar total de respuestas y preparar exportación
    try {
      const sRes = await fetch(`/api/encuestas/${encuestaId}/estadisticas`);
      const sData = await sRes.json();
      if (sData && sData.success) {
        encBadges.innerHTML += ` <span class="badge bg-success">Respuestas: ${sData.total_respuestas}</span>`;
        btnExportar.href = `/api/encuestas/${encuestaId}/respuestas/export?formato=excel`;
        btnExportarZip.href = `/api/encuestas/${encuestaId}/respuestas/export?formato=zip`;
      }
    } catch (e) { console.warn('[respuestas] No se pudieron cargar estadísticas', e); }

    try {
      if (enc.timer_duracion_segundos && timerSelect) {
        timerSelect.value = String(enc.timer_duracion_segundos);
      }
      if (enc.timer_fin) {
        const df = new Date(enc.timer_fin.replace(' ', 'T'));
        if (!isNaN(df.getTime())) {
          iniciarCuentaRegresiva(df.getTime());
        }
      }
    } catch (_) {}
  }

  async function cargarRespuestas(){
    const res = await fetch(`/api/encuestas/${encuestaId}/audiencia-estado`);
    const data = await res.json();
    if (!data.success) { showToast('Error', data.message || 'No se pudieron cargar técnicos habilitados', 'error'); return; }
    tbody.innerHTML = '';
    (data.tecnicos || []).forEach(t => {
      const tr = document.createElement('tr');
      const fecha = t.fecha ? t.fecha : '';
      const estadoBadge = t.estado === 'ok' ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-warning text-dark">Pendiente</span>';
      tr.innerHTML = `
        <td>${t.nombre ?? t.id}</td>
        <td>${t.supervisor ?? ''}</td>
        <td>${t.carpeta ?? ''}</td>
        <td>${fecha}</td>
        <td>${estadoBadge}</td>
        <td>
          <button class="btn btn-sm btn-outline-info btn-ver-respuestas" data-usuario-id="${t.id}" data-tecnico="${t.nombre ?? t.id}">
            <i class="fas fa-eye me-1"></i>Ver
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Función para cargar puntajes
  async function cargarPuntajes(){
    const puntajesBody = document.getElementById('puntajes-body');
    puntajesBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin me-2"></i>Cargando puntajes...</td></tr>';
    
    try {
      const res = await fetch(`/api/encuestas/${encuestaId}/puntajes`);
      const data = await res.json();
      
      if (!data.success) {
        if (data.message === 'Esta encuesta no tiene puntaje habilitado') {
          puntajesBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>Esta encuesta no tiene puntaje habilitado</td></tr>';
          return;
        }
        showToast('Error', data.message || 'No se pudieron cargar los puntajes', 'error');
        puntajesBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar puntajes</td></tr>';
        return;
      }
      
      if (data.puntajes && data.puntajes.length > 0) {
        renderPuntajes(data.puntajes);
      } else {
        puntajesBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="fas fa-info-circle me-2"></i>No hay puntajes disponibles</td></tr>';
      }
    } catch (error) {
      console.error('Error cargando puntajes:', error);
      puntajesBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted py-4"><i class="fas fa-exclamation-triangle me-2"></i>Error al cargar puntajes</td></tr>';
    }
  }

  function renderPuntajes(lista){
    const puntajesBody = document.getElementById('puntajes-body');
    puntajesBody.innerHTML = '';
    lista.forEach((p, index) => {
      const tr = document.createElement('tr');
      const fecha = p.fecha_respuesta ? p.fecha_respuesta : '';
      const estadoBadge = p.estado === 'enviada' ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-warning text-dark">Pendiente</span>';
      const puntajeClass = p.puntaje_total >= 80 ? 'text-success fw-bold' : p.puntaje_total >= 60 ? 'text-primary' : 'text-danger';
      const tiempo = (p.duracion_segundos !== undefined && p.duracion_segundos !== null) ? p.duracion_segundos : '';
      tr.innerHTML = `
        <td><span class="badge bg-dark">${index + 1}</span></td>
        <td>${p.tecnico ?? p.usuario_id}</td>
        <td>${p.supervisor ?? ''}</td>
        <td>${p.carpeta ?? ''}</td>
        <td>${fecha}</td>
        <td>${estadoBadge}</td>
        <td>${tiempo}</td>
        <td class="${puntajeClass}">${p.puntaje_total ?? 0}</td>
        <td>
          <button class="btn btn-sm btn-outline-info btn-ver-respuestas" data-usuario-id="${p.usuario_id}" data-tecnico="${p.tecnico}">
            <i class="fas fa-eye me-1"></i>Ver
          </button>
        </td>
      `;
      puntajesBody.appendChild(tr);
    });
    document.getElementById('seccion-puntajes').style.display = 'block';
  }

  function suscribirPuntajes(){
    if (window.EventSource) {
      try {
        const es = new EventSource(`/api/encuestas/${encuestaId}/puntajes/stream`);
        es.onmessage = (e) => {
          try {
            const d = JSON.parse(e.data);
            if (d && d.success && Array.isArray(d.puntajes)) {
              renderPuntajes(d.puntajes);
            }
            if (d && d.timer_remaining !== undefined && d.timer_remaining !== null) {
              actualizarTimerDesdeServidor(d.timer_remaining);
            }
          } catch (_) {}
        };
        es.onerror = () => {
          try { es.close(); } catch (_) {}
          iniciarPolling();
        };
      } catch (_) {
        iniciarPolling();
      }
    } else {
      iniciarPolling();
    }
  }

  function iniciarPolling(){
    try {
      setInterval(cargarPuntajes, 3000);
    } catch (_) {}
  }

  // Event listener para el botón de refrescar puntajes
  document.getElementById('btn-refrescar-puntajes').addEventListener('click', cargarPuntajes);
  btnIniciarTimer.addEventListener('click', iniciarTemporizador);

  // Event listener para botones de ver respuestas individuales (delegación de eventos)
  document.getElementById('puntajes-body').addEventListener('click', function(e) {
    if (e.target.closest('.btn-ver-respuestas')) {
      const btn = e.target.closest('.btn-ver-respuestas');
      const usuarioId = btn.getAttribute('data-usuario-id');
      const tecnico = btn.getAttribute('data-tecnico');
      verRespuestasIndividuales(usuarioId, tecnico);
    }
  });

  // Event listener para botones de ver respuestas en la tabla general
  document.getElementById('respuestas-body').addEventListener('click', function(e) {
    if (e.target.closest('.btn-ver-respuestas')) {
      const btn = e.target.closest('.btn-ver-respuestas');
      const usuarioId = btn.getAttribute('data-usuario-id');
      const tecnico = btn.getAttribute('data-tecnico');
      verRespuestasIndividuales(usuarioId, tecnico);
    }
  });

  // Función para ver respuestas individuales
  async function verRespuestasIndividuales(usuarioId, tecnico) {
    try {
      const res = await fetch(`/api/encuestas/${encuestaId}/respuestas/${usuarioId}`);
      const data = await res.json();
      
      if (!data.success) {
        showToast('Error', data.message || 'No se pudieron cargar las respuestas', 'error');
        return;
      }
      
      // Mostrar modal con las respuestas
      mostrarModalRespuestas(data.respuestas, tecnico);
      
    } catch (error) {
      console.error('Error cargando respuestas individuales:', error);
      showToast('Error', 'Error al cargar las respuestas', 'error');
    }
  }

  // Función para mostrar modal con respuestas
  function mostrarModalRespuestas(respuestas, tecnico) {
    let html = `<h5 class="mb-3">Respuestas de ${tecnico}</h5>`;
    
    if (respuestas && respuestas.length > 0) {
      html += '<div class="list-group">';
      respuestas.forEach(resp => {
        html += `
          <div class="list-group-item">
            <div class="fw-semibold">${resp.texto_pregunta || 'Pregunta'}</div>
            <div class="text-muted small mb-2">Tipo: ${resp.tipo_pregunta || '—'}</div>
            <div class="fw-light">`;
            
        if (resp.tipo_pregunta === 'opcion_multiple' || resp.tipo_pregunta === 'seleccion_unica' || resp.tipo_pregunta === 'seleccion_multiple') {
          const respuestaTexto = resp.respuesta || 'Opción seleccionada';
          html += `<span class="badge bg-primary">${respuestaTexto}</span>`;
          // Mostrar puntaje si existe y es mayor que 0
          if (resp.puntaje !== null && resp.puntaje !== undefined && Number(resp.puntaje) > 0) {
            html += ` <span class="badge bg-success ms-2"><i class="fas fa-star me-1"></i>${resp.puntaje} pts</span>`;
          }
        } else if (resp.tipo_pregunta === 'imagen' && resp.respuesta) {
          html += `<div class="mt-1"><div class="text-muted small">Foto tomada</div><img src="${resp.respuesta}" style="max-width: 200px; max-height: 200px;" class="img-thumbnail"></div>`;
        } else {
          html += `${resp.respuesta || 'Sin respuesta'}`;
        }
        
        html += `</div></div>`;
      });
      html += '</div>';
    } else {
      html += '<p class="text-muted">No hay respuestas registradas para este usuario.</p>';
    }
    
    // Usar SweetAlert2 para mostrar el modal
    if (window.Swal) {
      Swal.fire({
        title: `Respuestas Individuales`,
        html: html,
        width: '800px',
        showCloseButton: true,
        showConfirmButton: false,
        customClass: {
          popup: 'respuestas-modal'
        }
      });
    } else {
      // Fallback si no hay SweetAlert
      alert(`Respuestas de ${tecnico}:\n${JSON.stringify(respuestas, null, 2)}`);
    }
  }

  cargarEncabezado();
  cargarRespuestas();
  cargarPuntajes(); // Cargar puntajes automáticamente
  suscribirPuntajes();

  function iniciarTemporizador(){
    const dur = parseInt(timerSelect.value, 10) || 60;
    fetch(`/api/encuestas/${encuestaId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ timer_duracion_segundos: dur, timer_iniciar: true })
    }).then(r => r.json()).then(d => {
      if (d && d.success) {
        fetch(`/api/encuestas/${encuestaId}`).then(r2 => r2.json()).then(d2 => {
          const enc = d2.encuesta;
          if (enc && enc.timer_fin) {
            const df = new Date(enc.timer_fin.replace(' ', 'T'));
            if (!isNaN(df.getTime())) {
              iniciarCuentaRegresiva(df.getTime());
              showToast('Temporizador', 'Iniciado correctamente');
            }
          }
        });
      } else {
        showToast('Error', (d && d.message) || 'No se pudo iniciar el temporizador', 'error');
      }
    }).catch(() => {
      showToast('Error', 'No se pudo iniciar el temporizador', 'error');
    });
  }

  function iniciarCuentaRegresiva(endMs){
    timerEndMs = endMs;
    if (timerInterval) { clearInterval(timerInterval); }
    actualizarTimerLabel();
    timerInterval = setInterval(() => {
      actualizarTimerLabel();
    }, 1000);
  }

  function actualizarTimerDesdeServidor(remaining){
    if (typeof remaining === 'number') {
      const now = Date.now();
      timerEndMs = now + (remaining * 1000);
      if (!timerInterval) {
        timerInterval = setInterval(() => {
          actualizarTimerLabel();
        }, 1000);
      }
      actualizarTimerLabel();
    }
  }

  function actualizarTimerLabel(){
    if (!timerEndMs) { timerRemainingEl.textContent = '—'; return; }
    const now = Date.now();
    const diff = Math.max(0, Math.floor((timerEndMs - now) / 1000));
    timerRemainingEl.textContent = `${diff}s`;
    if (diff <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      desactivarEncuestaPorTiempo();
    }
  }

  function desactivarEncuestaPorTiempo(){
    fetch(`/api/encuestas/${encuestaId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ estado: 'borrador', timer_detener: true })
    }).then(r => r.json()).then(d => {
      if (d && d.success) {
        showToast('Encuesta', 'Desactivada por tiempo');
        cargarEncabezado();
      }
    }).catch(() => {});
  }

  // Sin manejo de imágenes en esta vista (listado de estado por técnico)
})();
</script>
{% endblock %}
