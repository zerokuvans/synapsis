{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;">
          <h3 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Visualización Preoperacional</h3>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            Consulta respuestas del preoperacional por técnico y fecha.
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="mesExport" class="form-label">Mes</label>
              <input type="month" id="mesExport" class="form-control" />
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-success w-100" id="btnExportarMes"><i class="fas fa-file-csv me-2"></i>Exportar CSV del Mes</button>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="buscarTecnico" class="form-label">Buscar técnico</label>
              <div class="input-group">
                <input type="text" id="buscarTecnico" class="form-control" placeholder="Nombre o cédula" />
                <button class="btn btn-outline-secondary" id="btnBuscarTecnico"><i class="fas fa-search"></i></button>
              </div>
              <small class="text-muted">Escribe para filtrar y selecciona un técnico.</small>
              <select id="tecnicoSelect" class="form-select mt-2"></select>
            </div>
            <div class="col-md-3">
              <label for="fechaInput" class="form-label">Fecha</label>
              <input type="date" id="fechaInput" class="form-control" />
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div class="w-100 d-grid gap-2">
                <button class="btn btn-success" id="btnConsultar"><i class="fas fa-eye me-2"></i>Consultar</button>
                <button class="btn btn-outline-primary" id="btnConsultarUltimo"><i class="fas fa-clock me-2"></i>Ver Último</button>
              </div>
            </div>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="soloConPreop" checked>
            <label class="form-check-label" for="soloConPreop">Listar sólo técnicos con preoperacional en la fecha</label>
          </div>
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="usarUltimos">
            <label class="form-check-label" for="usarUltimos">Usar últimos registros (sin fecha)</label>
          </div>
          <div class="card mb-3">
            <div class="card-body">
              <h6 class="mb-2">Técnicos con registro en la fecha</h6>
              <div class="table-responsive">
                <table class="table table-sm" id="tablaTecnicos">
                  <thead>
                    <tr>
                      <th>Nombre</th>
                      <th>Cédula</th>
                      <th>Hora</th>
                      <th>Obs.</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>
          <div id="resultado" class="mt-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
const tecnicoSelect = document.getElementById('tecnicoSelect');
const buscarTecnico = document.getElementById('buscarTecnico');
const btnBuscarTecnico = document.getElementById('btnBuscarTecnico');
const fechaInput = document.getElementById('fechaInput');
const btnConsultar = document.getElementById('btnConsultar');
const resultado = document.getElementById('resultado');
const soloConPreop = document.getElementById('soloConPreop');
const usarUltimos = document.getElementById('usarUltimos');
const tablaTecnicosBody = document.querySelector('#tablaTecnicos tbody');

function formatoFecha(d) {
  const pad = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}

function renderOpcionesTecnicos(items) {
  tecnicoSelect.innerHTML = '';
  items.forEach(it => {
    const opt = document.createElement('option');
    opt.value = it.id_codigo_consumidor;
    opt.textContent = `${it.nombre} (${it.cedula})`;
    tecnicoSelect.appendChild(opt);
  });
}

function cargarTecnicos(q = '') {
  const fecha = fechaInput.value;
  if (soloConPreop.checked) {
    const base = usarUltimos.checked
      ? `/api/sstt/tecnicos-con-preoperacional?ultima=1`
      : `/api/sstt/tecnicos-con-preoperacional?fecha=${encodeURIComponent(fecha)}`;
    const url = `${base}&q=${encodeURIComponent(q)}&limit=500`;
    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          renderOpcionesTecnicos(data.data);
          renderTablaTecnicos(data.data);
        }
      })
      .catch(() => {});
  } else {
    const url = `/api/sstt/tecnicos?q=${encodeURIComponent(q)}&limit=500`;
    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          renderOpcionesTecnicos(data.data);
          renderTablaTecnicos([]);
        }
      })
      .catch(() => {});
  }
}

function renderTablaTecnicos(items) {
  tablaTecnicosBody.innerHTML = '';
  items.forEach(it => {
    const tr = document.createElement('tr');
    const obs = String(it.observaciones || '').trim();
    const norm = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().replace(/[^a-z0-9\s]/g,'').replace(/\s+/g,' ').trim();
    const allowed = new Set(['ok','todo ok','todo bien','sin novedad','bueno']);
    const n = norm(obs);
    const wordCount = n ? n.split(' ').filter(Boolean).length : 0;
    const isAllowed = n && allowed.has(n);
    const needsValidation = (!!obs && (!isAllowed || wordCount > 2));
    const badge = needsValidation ? '<span class="badge bg-danger">Validar</span>' : '';
    tr.innerHTML = `<td>${it.nombre}</td><td>${it.cedula}</td><td>${it.fecha || ''}</td><td>${badge}</td>`;
    tr.style.cursor = 'pointer';
    tr.addEventListener('click', () => {
      tecnicoSelect.value = it.id_codigo_consumidor;
      consultar();
    });
    tablaTecnicosBody.appendChild(tr);
  });
}

function renderPreoperacional(reg) {
  const norm = v => {
    if (v === null || v === undefined) return '';
    if (typeof v === 'number') return String(v);
    const s = String(v).trim();
    if (s === '1') return 'Sí';
    if (s === '0') return 'No';
    return s;
  };
  const isNo = v => String(v).trim().toLowerCase() === 'no';
  const km = reg.kilometraje_actual ?? reg.kilometraje ?? '';
  const resumen = [
    {t:'Centro de trabajo', v:norm(reg.centro_de_trabajo ?? reg.centro_trabajo)},
    {t:'Ciudad', v:norm(reg.ciudad)},
    {t:'Supervisor', v:norm(reg.supervisor)},
    {t:'Vehículo asistió operación', v:norm(reg.vehiculo_asistio_operacion)},
    {t:'Tipo de vehículo', v:norm(reg.tipo_vehiculo)},
    {t:'Placa', v:norm(reg.placa_vehiculo)},
    {t:'Kilometraje', v:norm(km)},
    {t:'Nivel de combustible', v:norm(reg.nivel_combustible)},
    {t:'Observaciones', v:norm(reg.observaciones)}
  ];
  const vehiculoDocs = [
    {t:'Modelo', v:norm(reg.modelo_vehiculo)},
    {t:'Marca', v:norm(reg.marca_vehiculo)},
    {t:'Licencia de conducción', v:norm(reg.licencia_conduccion)},
    {t:'Vencimiento licencia', v:norm(reg.fecha_vencimiento_licencia)},
    {t:'Vencimiento SOAT', v:norm(reg.fecha_vencimiento_soat)},
    {t:'Vencimiento tecnomecánica', v:norm(reg.fecha_vencimiento_tecnomecanica)}
  ];
  const estadoVehiculo = [
    {t:'Espejos', v:norm(reg.estado_espejos)},
    {t:'Bocina/Pito', v:norm(reg.bocina_pito)},
    {t:'Frenos', v:norm(reg.frenos)},
    {t:'Encendido', v:norm(reg.encendido)},
    {t:'Batería', v:norm(reg.estado_bateria)},
    {t:'Amortiguadores', v:norm(reg.estado_amortiguadores)},
    {t:'Llantas', v:norm(reg.estado_llantas)},
    {t:'Luces altas/bajas', v:norm(reg.luces_altas_bajas)},
    {t:'Direccionales', v:norm(reg.direccionales_delanteras_traseras)}
  ];
  const elementosSeguridad = [
    {t:'Casco', v:norm(reg.elementos_prevencion_seguridad_vial_casco)},
    {t:'Casco certificado', v:norm(reg.casco_certificado)},
    {t:'Casco identificado', v:norm(reg.casco_identificado)},
    {t:'Guantes', v:norm((reg.elementos_prevencion_seguridad_vial_guantes ?? reg.estado_guantes))},
    {t:'Rodilleras', v:norm((reg.elementos_prevencion_seguridad_vial_rodilleras ?? reg.estado_rodilleras))},
    {t:'Coderas', v:norm(reg.elementos_prevencion_seguridad_vial_coderas)},
    {t:'Impermeable', v:norm((reg.elementos_prevencion_seguridad_vial_impermeable ?? reg.impermeable))},
    {t:'Casco identificado placa', v:norm(reg.casco_identificado_placa)}
  ];
  const verificacionesDetalladas = [
    {t:'Espejos OK', v:norm(reg.estado_fisico_vehiculo_espejos)},
    {t:'Bocina/Pito OK', v:norm(reg.estado_fisico_vehiculo_bocina_pito)},
    {t:'Frenos OK', v:norm(reg.estado_fisico_vehiculo_frenos)},
    {t:'Encendido OK', v:norm(reg.estado_fisico_vehiculo_encendido)},
    {t:'Batería OK', v:norm(reg.estado_fisico_vehiculo_bateria)},
    {t:'Amortiguadores OK', v:norm(reg.estado_fisico_vehiculo_amortiguadores)},
    {t:'Llantas OK', v:norm(reg.estado_fisico_vehiculo_llantas)},
    {t:'Luces altas OK', v:norm(reg.estado_fisico_vehiculo_luces_altas)},
    {t:'Luces bajas OK', v:norm(reg.estado_fisico_vehiculo_luces_bajas)},
    {t:'Direccionales delanteras OK', v:norm(reg.estado_fisico_vehiculo_direccionales_delanteras)},
    {t:'Direccionales traseras OK', v:norm(reg.estado_fisico_vehiculo_direccionales_traseras)},
    {t:'Guantes presentes', v:norm((reg.elementos_prevencion_seguridad_vial_guantes ?? reg.estado_guantes))},
    {t:'Rodilleras presentes', v:norm((reg.elementos_prevencion_seguridad_vial_rodilleras ?? reg.estado_rodilleras))},
    {t:'Coderas presentes', v:norm(reg.elementos_prevencion_seguridad_vial_coderas)},
    {t:'Impermeable presente', v:norm((reg.elementos_prevencion_seguridad_vial_impermeable ?? reg.impermeable))}
  ];
  const fecha = norm(reg.fecha);
  let html = '';
  html += `<div class="card"><div class="card-body">`;
  html += `<div class="d-flex justify-content-between"><div><h5 class="card-title mb-1">Registro del ${fecha}</h5><p class="text-muted mb-3">ID técnico: ${norm(reg.id_codigo_consumidor)}</p></div></div>`;
  html += `<div class="row">`;
  resumen.forEach(c => { html += `<div class="col-md-4 mb-3"><div class="border rounded p-2"><div class="text-muted">${c.t}</div><div class="fw-semibold${isNo(c.v) ? ' text-danger' : ''}">${c.v}</div></div></div>`; });
  html += `</div>`;
  html += `<div class="mt-3"><h6 class="mb-2">Vehículo y documentos</h6><div class="row">`;
  vehiculoDocs.forEach(c => { html += `<div class="col-md-4 mb-3"><div class="border rounded p-2"><div class="text-muted">${c.t}</div><div class="fw-semibold${isNo(c.v) ? ' text-danger' : ''}">${c.v}</div></div></div>`; });
  html += `</div></div>`;
  html += `<div class="mt-3"><h6 class="mb-2">Estado físico del vehículo</h6><div class="row">`;
  estadoVehiculo.forEach(c => { html += `<div class="col-md-4 mb-3"><div class="border rounded p-2"><div class="text-muted">${c.t}</div><div class="fw-semibold${isNo(c.v) ? ' text-danger' : ''}">${c.v}</div></div></div>`; });
  html += `</div></div>`;
  html += `<div class="mt-3"><h6 class="mb-2">Verificaciones detalladas</h6><div class="row">`;
  verificacionesDetalladas.forEach(c => { html += `<div class="col-md-4 mb-3"><div class="border rounded p-2"><div class="text-muted">${c.t}</div><div class="fw-semibold${isNo(c.v) ? ' text-danger' : ''}">${c.v}</div></div></div>`; });
  html += `</div></div>`;
  html += `<div class="mt-3"><h6 class="mb-2">Elementos de prevención</h6><div class="row">`;
  elementosSeguridad.forEach(c => { html += `<div class="col-md-4 mb-3"><div class="border rounded p-2"><div class="text-muted">${c.t}</div><div class="fw-semibold${isNo(c.v) ? ' text-danger' : ''}">${c.v}</div></div></div>`; });
  html += `</div></div>`;
  html += `<div class="mt-3">`;
  html += `<button class="btn btn-outline-secondary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#jsonCollapse">Ver JSON</button>`;
  html += `<div id="jsonCollapse" class="collapse mt-2">`;
  html += `<pre class="bg-light p-3 border rounded" style="max-height: 320px; overflow:auto">${JSON.stringify(reg, null, 2)}</pre>`;
  html += `</div></div>`;
  html += `</div></div>`;
  resultado.innerHTML = html;
}

function consultar() {
  const tecnicoId = tecnicoSelect.value;
  const fecha = fechaInput.value;
  if (!tecnicoId || !fecha) return;
  const url = `/api/sstt/preoperacional?tecnico_id=${encodeURIComponent(tecnicoId)}&fecha=${encodeURIComponent(fecha)}`;
  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (data.success && data.data) {
        renderPreoperacional(data.data);
      } else {
        resultado.innerHTML = `<div class="alert alert-warning">No se encontraron registros para la fecha seleccionada.</div>`;
      }
    })
    .catch(() => {
      resultado.innerHTML = `<div class="alert alert-danger">Error consultando el registro.</div>`;
    });
}

function consultarUltimo() {
  const tecnicoId = tecnicoSelect.value;
  if (!tecnicoId) return;
  const url = `/api/sstt/preoperacional?tecnico_id=${encodeURIComponent(tecnicoId)}&ultimo=1`;
  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (data.success && data.data) {
        renderPreoperacional(data.data);
      } else {
        resultado.innerHTML = `<div class="alert alert-warning">No se encontraron registros para el técnico seleccionado.</div>`;
      }
    })
    .catch(() => {
      resultado.innerHTML = `<div class="alert alert-danger">Error consultando el último registro.</div>`;
    });
}

document.addEventListener('DOMContentLoaded', () => {
  fechaInput.value = formatoFecha(new Date());
  cargarTecnicos('');
});

soloConPreop.addEventListener('change', () => cargarTecnicos(buscarTecnico.value.trim()));
usarUltimos.addEventListener('change', () => cargarTecnicos(buscarTecnico.value.trim()));

btnBuscarTecnico.addEventListener('click', () => cargarTecnicos(buscarTecnico.value.trim()));
btnConsultar.addEventListener('click', consultar);
btnConsultarUltimo.addEventListener('click', consultarUltimo);
document.getElementById('btnExportarMes').addEventListener('click', () => {
  const mes = document.getElementById('mesExport').value;
  if(!mes){
    Swal.fire('Selecciona un mes','Debes seleccionar un mes para exportar','warning');
    return;
  }
  const url = `/api/sstt/preoperacional/export?mes=${encodeURIComponent(mes)}`;
  window.location.href = url;
});
</script>
{% endblock %}
