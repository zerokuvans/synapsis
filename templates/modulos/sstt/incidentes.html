{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;">
                    <h3 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Gestión de Incidentes
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Botón para nuevo incidente -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalNuevoIncidente">
                                <i class="fas fa-plus me-2"></i>Reportar Incidente
                            </button>
                        </div>
                        <div>
                            <input type="text" class="form-control" id="buscarIncidente" placeholder="Buscar incidente...">
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <select class="form-select" id="filtroTipo">
                                <option value="">Todos los tipos</option>
                                <option value="accidente_trabajo">Accidente de Trabajo</option>
                                <option value="enfermedad_laboral">Enfermedad Laboral</option>
                                <option value="incidente_peligroso">Incidente Peligroso</option>
                                <option value="acto_inseguro">Acto Inseguro</option>
                                <option value="condicion_insegura">Condición Insegura</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filtroSeveridad">
                                <option value="">Todas las severidades</option>
                                <option value="leve">Leve</option>
                                <option value="moderado">Moderado</option>
                                <option value="grave">Grave</option>
                                <option value="muy_grave">Muy Grave</option>
                                <option value="mortal">Mortal</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filtroFechaDesde" placeholder="Fecha desde">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filtroFechaHasta" placeholder="Fecha hasta">
                        </div>
                    </div>

                    <!-- Tabla de incidentes -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Tipo</th>
                                    <th>Fecha/Hora</th>
                                    <th>Ubicación</th>
                                    <th>Severidad</th>
                                    <th>Reportado por</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaIncidentes">
                                <!-- Datos cargados dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nuevo Incidente -->
<div class="modal fade" id="modalNuevoIncidente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reportar Nuevo Incidente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formNuevoIncidente">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipoIncidente" class="form-label">Tipo de Incidente</label>
                            <select class="form-select" id="tipoIncidente" required>
                                <option value="">Seleccionar tipo</option>
                                <option value="accidente_trabajo">Accidente de Trabajo</option>
                                <option value="enfermedad_laboral">Enfermedad Laboral</option>
                                <option value="incidente_peligroso">Incidente Peligroso</option>
                                <option value="acto_inseguro">Acto Inseguro</option>
                                <option value="condicion_insegura">Condición Insegura</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="severidad" class="form-label">Severidad</label>
                            <select class="form-select" id="severidad" required>
                                <option value="">Seleccionar severidad</option>
                                <option value="leve">Leve</option>
                                <option value="moderado">Moderado</option>
                                <option value="grave">Grave</option>
                                <option value="muy_grave">Muy Grave</option>
                                <option value="mortal">Mortal</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaIncidente" class="form-label">Fecha y Hora del Incidente</label>
                            <input type="datetime-local" class="form-control" id="fechaIncidente" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="ubicacionIncidente" class="form-label">Ubicación</label>
                            <input type="text" class="form-control" id="ubicacionIncidente" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="personaAfectada" class="form-label">Persona Afectada</label>
                            <input type="text" class="form-control" id="personaAfectada">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="testigos" class="form-label">Testigos</label>
                            <input type="text" class="form-control" id="testigos">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="descripcionIncidente" class="form-label">Descripción del Incidente</label>
                        <textarea class="form-control" id="descripcionIncidente" rows="4" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="causasInmediatas" class="form-label">Causas Inmediatas</label>
                        <textarea class="form-control" id="causasInmediatas" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="accionesInmediatas" class="form-label">Acciones Inmediatas Tomadas</label>
                        <textarea class="form-control" id="accionesInmediatas" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="requiereAtencionMedica">
                                <label class="form-check-label" for="requiereAtencionMedica">
                                    Requiere Atención Médica
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notificarAutoridades">
                                <label class="form-check-label" for="notificarAutoridades">
                                    Notificar a Autoridades
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" onclick="guardarIncidente()">Reportar Incidente</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Incidente -->
<div class="modal fade" id="modalVerIncidente" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalles del Incidente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="detalleIncidente">
                    <!-- Contenido cargado dinámicamente -->
                </div>
                
                <!-- Sección de seguimiento -->
                <div class="mt-4">
                    <h6>Seguimiento y Acciones Correctivas</h6>
                    <div id="seguimientoIncidente">
                        <!-- Seguimiento del incidente -->
                    </div>
                    
                    <!-- Formulario para agregar seguimiento -->
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-8">
                                <textarea class="form-control" id="nuevoSeguimiento" placeholder="Agregar seguimiento o acción correctiva..." rows="2"></textarea>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary" onclick="agregarSeguimiento()">
                                    <i class="fas fa-plus me-2"></i>Agregar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-warning" onclick="editarIncidente()">Editar</button>
                <button type="button" class="btn btn-success" onclick="cerrarIncidente()">Cerrar Incidente</button>
            </div>
        </div>
    </div>
</div>

<script>
let incidentes = [];
let incidenteActual = null;

// Cargar datos iniciales
document.addEventListener('DOMContentLoaded', function() {
    cargarIncidentes();
    
    // Event listeners para filtros
    document.getElementById('buscarIncidente').addEventListener('input', filtrarIncidentes);
    document.getElementById('filtroTipo').addEventListener('change', filtrarIncidentes);
    document.getElementById('filtroSeveridad').addEventListener('change', filtrarIncidentes);
    document.getElementById('filtroFechaDesde').addEventListener('change', filtrarIncidentes);
    document.getElementById('filtroFechaHasta').addEventListener('change', filtrarIncidentes);
});

function cargarIncidentes() {
    fetch('/api/sstt/incidentes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                incidentes = data.data;
                mostrarIncidentes(incidentes);
            }
        })
        .catch(error => console.error('Error al cargar incidentes:', error));
}

function mostrarIncidentes(datos) {
    const tbody = document.getElementById('tablaIncidentes');
    tbody.innerHTML = '';
    
    datos.forEach(incidente => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${incidente.id}</td>
            <td><span class="badge bg-secondary">${incidente.tipo.replace('_', ' ')}</span></td>
            <td>${new Date(incidente.fecha_hora).toLocaleString()}</td>
            <td>${incidente.ubicacion}</td>
            <td><span class="badge bg-${getSeveridadColor(incidente.severidad)}">${incidente.severidad}</span></td>
            <td>${incidente.reportado_por_nombre || 'Sistema'}</td>
            <td><span class="badge bg-${getEstadoColor(incidente.estado)}">${incidente.estado}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="verIncidente(${incidente.id})">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="editarIncidente(${incidente.id})">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function getSeveridadColor(severidad) {
    const colores = {
        'leve': 'success',
        'moderado': 'warning',
        'grave': 'danger',
        'muy_grave': 'danger',
        'mortal': 'dark'
    };
    return colores[severidad] || 'secondary';
}

function getEstadoColor(estado) {
    const colores = {
        'abierto': 'warning',
        'en_investigacion': 'info',
        'cerrado': 'success',
        'cancelado': 'secondary'
    };
    return colores[estado] || 'secondary';
}

function filtrarIncidentes() {
    const busqueda = document.getElementById('buscarIncidente').value.toLowerCase();
    const tipo = document.getElementById('filtroTipo').value;
    const severidad = document.getElementById('filtroSeveridad').value;
    const fechaDesde = document.getElementById('filtroFechaDesde').value;
    const fechaHasta = document.getElementById('filtroFechaHasta').value;
    
    let incidentesFiltrados = incidentes.filter(incidente => {
        const cumpleBusqueda = !busqueda || 
            incidente.ubicacion.toLowerCase().includes(busqueda) ||
            incidente.descripcion.toLowerCase().includes(busqueda) ||
            (incidente.persona_afectada && incidente.persona_afectada.toLowerCase().includes(busqueda));
        
        const cumpleTipo = !tipo || incidente.tipo === tipo;
        const cumpleSeveridad = !severidad || incidente.severidad === severidad;
        
        const fechaIncidente = new Date(incidente.fecha_hora);
        const cumpleFechaDesde = !fechaDesde || fechaIncidente >= new Date(fechaDesde);
        const cumpleFechaHasta = !fechaHasta || fechaIncidente <= new Date(fechaHasta);
        
        return cumpleBusqueda && cumpleTipo && cumpleSeveridad && cumpleFechaDesde && cumpleFechaHasta;
    });
    
    mostrarIncidentes(incidentesFiltrados);
}

function guardarIncidente() {
    const formData = {
        tipo: document.getElementById('tipoIncidente').value,
        severidad: document.getElementById('severidad').value,
        fecha_hora: document.getElementById('fechaIncidente').value,
        ubicacion: document.getElementById('ubicacionIncidente').value,
        persona_afectada: document.getElementById('personaAfectada').value,
        testigos: document.getElementById('testigos').value,
        descripcion: document.getElementById('descripcionIncidente').value,
        causas_inmediatas: document.getElementById('causasInmediatas').value,
        acciones_inmediatas: document.getElementById('accionesInmediatas').value,
        requiere_atencion_medica: document.getElementById('requiereAtencionMedica').checked,
        notificar_autoridades: document.getElementById('notificarAutoridades').checked
    };
    
    fetch('/api/sstt/incidentes', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire('Éxito', 'Incidente reportado correctamente', 'success');
            document.getElementById('modalNuevoIncidente').querySelector('.btn-close').click();
            document.getElementById('formNuevoIncidente').reset();
            cargarIncidentes();
        } else {
            Swal.fire('Error', data.message || 'Error al reportar el incidente', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire('Error', 'Error al reportar el incidente', 'error');
    });
}

function verIncidente(id) {
    fetch(`/api/sstt/incidentes/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                incidenteActual = data.data;
                mostrarDetalleIncidente(data.data);
                document.getElementById('modalVerIncidente').querySelector('.modal-title').textContent = 
                    `Incidente #${data.data.id}`;
                new bootstrap.Modal(document.getElementById('modalVerIncidente')).show();
            }
        })
        .catch(error => console.error('Error al cargar incidente:', error));
}

function mostrarDetalleIncidente(incidente) {
    const detalle = document.getElementById('detalleIncidente');
    detalle.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <p><strong>Tipo:</strong> ${incidente.tipo.replace('_', ' ')}</p>
                <p><strong>Severidad:</strong> <span class="badge bg-${getSeveridadColor(incidente.severidad)}">${incidente.severidad}</span></p>
                <p><strong>Fecha/Hora:</strong> ${new Date(incidente.fecha_hora).toLocaleString()}</p>
                <p><strong>Ubicación:</strong> ${incidente.ubicacion}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Persona Afectada:</strong> ${incidente.persona_afectada || 'No especificada'}</p>
                <p><strong>Testigos:</strong> ${incidente.testigos || 'No especificados'}</p>
                <p><strong>Reportado por:</strong> ${incidente.reportado_por_nombre || 'Sistema'}</p>
                <p><strong>Estado:</strong> <span class="badge bg-${getEstadoColor(incidente.estado)}">${incidente.estado}</span></p>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <p><strong>Descripción:</strong></p>
                <p>${incidente.descripcion}</p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Causas Inmediatas:</strong></p>
                <p>${incidente.causas_inmediatas || 'No especificadas'}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Acciones Inmediatas:</strong></p>
                <p>${incidente.acciones_inmediatas || 'No especificadas'}</p>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <p><strong>Requiere Atención Médica:</strong> ${incidente.requiere_atencion_medica ? 'Sí' : 'No'}</p>
            </div>
            <div class="col-md-6">
                <p><strong>Notificar Autoridades:</strong> ${incidente.notificar_autoridades ? 'Sí' : 'No'}</p>
            </div>
        </div>
    `;
}

function editarIncidente(id) {
    // Implementar edición de incidente
    console.log('Editar incidente:', id);
}

function cerrarIncidente() {
    if (!incidenteActual) return;
    
    Swal.fire({
        title: '¿Cerrar incidente?',
        text: 'Esta acción marcará el incidente como cerrado',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sí, cerrar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            // Implementar cierre de incidente
            console.log('Cerrar incidente:', incidenteActual.id);
        }
    });
}

function agregarSeguimiento() {
    const seguimiento = document.getElementById('nuevoSeguimiento').value.trim();
    if (!seguimiento || !incidenteActual) return;
    
    // Implementar agregar seguimiento
    console.log('Agregar seguimiento:', seguimiento);
    document.getElementById('nuevoSeguimiento').value = '';
}
</script>
{% endblock %}