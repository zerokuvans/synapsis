{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #0d6efd 0%, #17a2b8 100%) !important;">
                    <h3 class="mb-0">
                        <i class="fas fa-book-open me-2"></i>Vencimientos de Cursos
                    </h3>
                </div>

                

                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalRegistrarCurso">
                                <i class="fas fa-plus me-2"></i>Registrar Curso
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="btnRefrescar">
                                <i class="fas fa-sync me-2"></i>Refrescar
                            </button>
                        </div>
                        <div>
                            <input type="text" class="form-control" id="buscarVencimiento" placeholder="Buscar...">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="filtroCedula" placeholder="Cédula">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="filtroTipo">
                                <option value="">Todos los tipos</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filtroFechaDesde" placeholder="Fecha desde">
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filtroFechaHasta" placeholder="Fecha hasta">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cédula</th>
                                    <th>Nombre Técnico</th>
                                    <th>Tipo de Curso</th>
                                    <th>Fecha</th>
                                    <th>Fecha Vencimiento</th>
                                    <th>Días por vencer</th>
                                    <th>Estado</th>
                                    <th>Observación</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaVencimientosCursos"></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div id="infoPaginacion" class="small text-muted"></div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="paginacionCursos"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRegistrarCurso" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formRegistrarCurso">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Buscar usuario</label>
                            <input type="text" class="form-control" id="buscarUsuarioInput" placeholder="Nombre o cédula">
                        </div>
                        <div class="col-12 mb-3">
                            <select class="form-select" id="usuarioSelect" size="6"></select>
                            <div class="small text-muted mt-1" id="usuarioSeleccionadoInfo"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cedulaInput" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="cedulaInput" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tipoCursoSelect" class="form-label">Tipo de Curso</label>
                            <select class="form-select" id="tipoCursoSelect" required>
                                <option value="">Seleccionar tipo</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaCursoInput" class="form-label">Fecha del Curso</label>
                            <input type="date" class="form-control" id="fechaCursoInput" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fechaVencimientoInput" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="fechaVencimientoInput" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="observacionInput" class="form-label">Observación</label>
                        <textarea class="form-control" id="observacionInput" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnRegistrarCurso">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarCurso" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarCurso">
                    <input type="hidden" id="editIdInput">
                    <input type="hidden" id="editOriginalCedula">
                    <input type="hidden" id="editOriginalTipo">
                    <input type="hidden" id="editOriginalFecha">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCedulaInput" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="editCedulaInput" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tipoCursoEditSelect" class="form-label">Tipo de Curso</label>
                            <select class="form-select" id="tipoCursoEditSelect" required>
                                <option value="">Seleccionar tipo</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editFechaCursoInput" class="form-label">Fecha del Curso</label>
                            <input type="date" class="form-control" id="editFechaCursoInput" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editFechaVencimientoInput" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="editFechaVencimientoInput" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editObservacionInput" class="form-label">Observación</label>
                        <textarea class="form-control" id="editObservacionInput" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarEdicionCurso">Guardar cambios</button>
            </div>
        </div>
    </div>
    </div>

<script>
let vencimientos = [];
let tiposCurso = [];
let currentPage = 1;
const pageSize = 20;
const TIPOS_CURSO_PREDEF = [
  'EXAMEN MEDICO INGRESO',
  'EXAMEN MEDICO PERIODICO',
  'CURSO ALTURAS',
  'CURSO MANEJO DEFENSIVO',
  'CURSO INDUCCION SST',
  'CURSO REINDUCCION SST'
];

document.addEventListener('DOMContentLoaded', function() {
  cargarTiposCurso();
  cargarVencimientos();
  document.getElementById('buscarUsuarioInput').addEventListener('input', function(e){ cargarUsuarios(e.target.value.trim()); });
  document.getElementById('usuarioSelect').addEventListener('change', function(){
    const opt = this.options[this.selectedIndex];
    if (!opt) return;
    const ced = opt.value;
    const nom = opt.getAttribute('data-nombre') || '';
    document.getElementById('cedulaInput').value = ced;
    document.getElementById('usuarioSeleccionadoInfo').textContent = nom ? (`Seleccionado: ${nom} (${ced})`) : '';
  });
  document.getElementById('modalRegistrarCurso').addEventListener('shown.bs.modal', function(){ cargarUsuarios(''); });
  document.getElementById('buscarVencimiento').addEventListener('input', aplicarBusquedaLocal);
  document.getElementById('filtroCedula').addEventListener('input', () => { currentPage = 1; cargarVencimientos(); });
  document.getElementById('filtroTipo').addEventListener('change', () => { currentPage = 1; cargarVencimientos(); });
  document.getElementById('filtroFechaDesde').addEventListener('change', () => { currentPage = 1; cargarVencimientos(); });
  document.getElementById('filtroFechaHasta').addEventListener('change', () => { currentPage = 1; cargarVencimientos(); });
  document.getElementById('btnRegistrarCurso').addEventListener('click', registrarCurso);
  document.getElementById('btnRefrescar').addEventListener('click', () => { currentPage = 1; cargarVencimientos(); });
  document.getElementById('btnGuardarEdicionCurso').addEventListener('click', guardarEdicionCurso);
});

function cargarTiposCurso() {
  fetch('/api/sstt/vencimientos-cursos/tipos')
    .then(r => r.json())
    .then(d => {
      tiposCurso = (d && d.success && Array.isArray(d.data) && d.data.length ? d.data : TIPOS_CURSO_PREDEF);
      const filtro = document.getElementById('filtroTipo');
      const select = document.getElementById('tipoCursoSelect');
      const selectEdit = document.getElementById('tipoCursoEditSelect');
      filtro.innerHTML = '<option value="">Todos los tipos</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
      select.innerHTML = '<option value="">Seleccionar tipo</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
      if (selectEdit) selectEdit.innerHTML = '<option value="">Seleccionar tipo</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
    })
    .catch(() => {
      tiposCurso = TIPOS_CURSO_PREDEF;
      const filtro = document.getElementById('filtroTipo');
      const select = document.getElementById('tipoCursoSelect');
      const selectEdit = document.getElementById('tipoCursoEditSelect');
      filtro.innerHTML = '<option value="">Todos los tipos</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
      select.innerHTML = '<option value="">Seleccionar tipo</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
      if (selectEdit) selectEdit.innerHTML = '<option value="">Seleccionar tipo</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
    });
}

function cargarVencimientos() {
  const cedula = document.getElementById('filtroCedula').value.trim();
  const tipo = document.getElementById('filtroTipo').value;
  const fechaDesde = document.getElementById('filtroFechaDesde').value;
  const fechaHasta = document.getElementById('filtroFechaHasta').value;
  const params = new URLSearchParams();
  if (cedula) params.append('cedula', cedula);
  if (tipo) params.append('tipo', tipo);
  if (fechaDesde) params.append('fecha_desde', fechaDesde);
  if (fechaHasta) params.append('fecha_hasta', fechaHasta);
  fetch('/api/sstt/vencimientos-cursos' + (params.toString() ? ('?' + params.toString()) : ''))
    .then(r => r.json())
    .then(d => {
      if (!d.success) { Swal.fire('Error', d.message || 'No se pudo cargar la lista', 'error'); return; }
      vencimientos = d.data || [];
      currentPage = 1;
      mostrarVencimientos(vencimientos);
      if ((d.total||0) === 0) {
        const tbody = document.getElementById('tablaVencimientosCursos');
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Sin registros</td></tr>';
      }
    })
    .catch(() => {});
}

function mostrarVencimientos(datos) {
  const tbody = document.getElementById('tablaVencimientosCursos');
  tbody.innerHTML = '';
  const total = datos.length;
  const start = (currentPage - 1) * pageSize;
  const pageItems = datos.slice(start, start + pageSize);
  pageItems.forEach(item => {
    const tr = document.createElement('tr');
    const dias = item.dias_por_vencer;
    const estado = (dias == null) ? '' : (dias <= 0 ? 'VENCIDO' : (dias <= 30 ? 'PRÓXIMO A VENCER' : 'VIGENTE'));
    const diasClass = (dias == null) ? '' : (dias <= 0 ? 'text-danger fw-bold' : (dias <= 30 ? 'text-warning fw-bold' : 'text-success fw-bold'));
    const badgeClass = (dias == null) ? 'bg-secondary' : (dias <= 0 ? 'bg-danger' : (dias <= 30 ? 'bg-warning text-dark' : 'bg-success'));
    tr.innerHTML = `
      <td>${item.recurso_operativo_cedula || ''}</td>
      <td>${item.nombre || ''}</td>
      <td>${item.tipo_curso || ''}</td>
      <td>${item.fecha || ''}</td>
      <td>${item.fecha_vencimiento || ''}</td>
      <td class="${diasClass}">${dias != null ? dias : ''}</td>
      <td>${estado ? `<span class="badge ${badgeClass}">${estado}</span>` : ''}</td>
      <td>${item.observacion || ''}</td>
      <td><button class="btn btn-sm btn-primary btnEditar" data-id="${item.id || ''}"><i class="fas fa-edit me-1"></i>Editar</button></td>
    `;
    tbody.appendChild(tr);
    const btn = tr.querySelector('.btnEditar');
    if (btn) {
      btn.addEventListener('click', () => {
        const merged = Object.assign({}, item, { id: item.id || btn.getAttribute('data-id') });
        abrirModalEditar(merged);
      });
    }
  });
  renderPagination(total);
}

function aplicarBusquedaLocal() {
  const q = document.getElementById('buscarVencimiento').value.toLowerCase().trim();
  if (!q) { mostrarVencimientos(vencimientos); return; }
  const filtrados = vencimientos.filter(v => {
    return String(v.recurso_operativo_cedula||'').toLowerCase().includes(q)
        || String(v.nombre||'').toLowerCase().includes(q)
        || String(v.tipo_curso||'').toLowerCase().includes(q)
        || String(v.observacion||'').toLowerCase().includes(q);
  });
  currentPage = 1;
  mostrarVencimientos(filtrados);
}

function registrarCurso() {
  const cedula = document.getElementById('cedulaInput').value.trim();
  const tipo = document.getElementById('tipoCursoSelect').value;
  const fecha = document.getElementById('fechaCursoInput').value;
  const fechaVen = document.getElementById('fechaVencimientoInput').value;
  const observ = document.getElementById('observacionInput').value.trim();
  if (!cedula || !tipo || !fecha || !fechaVen) {
    Swal.fire('Error', 'Completa los campos requeridos', 'error');
    return;
  }
  const payload = {
    recurso_operativo_cedula: cedula,
    sstt_vencimientos_cursos_tipo_curso: tipo,
    sstt_vencimientos_cursos_fecha: fecha,
    sstt_vencimientos_cursos_fecha_ven: fechaVen,
    sstt_vencimientos_cursos_observacion: observ
  };
  fetch('/api/sstt/vencimientos-cursos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      Swal.fire('Éxito', 'Curso registrado correctamente', 'success');
      document.getElementById('formRegistrarCurso').reset();
      const modalEl = document.getElementById('modalRegistrarCurso');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();
      cargarVencimientos();
    } else {
      Swal.fire('Error', d.message || 'No se pudo registrar', 'error');
    }
  })
  .catch(() => {
    Swal.fire('Error', 'No se pudo registrar', 'error');
  });
}

function abrirModalEditar(item){
  document.getElementById('editIdInput').value = item.id || '';
  document.getElementById('editOriginalCedula').value = item.recurso_operativo_cedula || '';
  document.getElementById('editOriginalTipo').value = item.tipo_curso || '';
  document.getElementById('editOriginalFecha').value = normalizeDateString(item.fecha);
  document.getElementById('editCedulaInput').value = item.recurso_operativo_cedula || '';
  const sel = document.getElementById('tipoCursoEditSelect');
  if (sel) sel.value = item.tipo_curso || '';
  document.getElementById('editFechaCursoInput').value = normalizeDateString(item.fecha);
  document.getElementById('editFechaVencimientoInput').value = normalizeDateString(item.fecha_vencimiento);
  document.getElementById('editObservacionInput').value = item.observacion || '';
  const modalEl = document.getElementById('modalEditarCurso');
  const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
  modal.show();
}

function guardarEdicionCurso(){
  const id = document.getElementById('editIdInput').value;
  const cedula = document.getElementById('editCedulaInput').value.trim();
  const tipo = document.getElementById('tipoCursoEditSelect').value;
  const fecha = document.getElementById('editFechaCursoInput').value;
  const fechaVen = document.getElementById('editFechaVencimientoInput').value;
  const observ = document.getElementById('editObservacionInput').value.trim();
  if (!cedula || !tipo || !fecha || !fechaVen) { Swal.fire('Error','Completa los campos requeridos','error'); return; }
  const payload = {
    recurso_operativo_cedula: cedula,
    sstt_vencimientos_cursos_tipo_curso: tipo,
    sstt_vencimientos_cursos_fecha: fecha,
    sstt_vencimientos_cursos_fecha_ven: fechaVen,
    sstt_vencimientos_cursos_observacion: observ
  };
  const doSuccess = (d) => {
    if (d && d.success && (d.updated === undefined || d.updated > 0)) {
      Swal.fire('Éxito','Curso actualizado','success');
      const modalEl = document.getElementById('modalEditarCurso');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();
      cargarVencimientos();
    } else {
      Swal.fire('Error', (d && d.message) || 'No se pudo actualizar','error');
    }
  };
  if (id) {
    fetch(`/api/sstt/vencimientos-cursos/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(doSuccess)
    .catch(() => Swal.fire('Error','Error de conexión','error'));
  } else {
    const original = {
      original_cedula: document.getElementById('editOriginalCedula').value,
      original_tipo: document.getElementById('editOriginalTipo').value,
      original_fecha: document.getElementById('editOriginalFecha').value
    };
    const body = Object.assign({}, payload, original);
    fetch('/api/sstt/vencimientos-cursos/update-by', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    })
    .then(r => r.json())
    .then(doSuccess)
    .catch(() => Swal.fire('Error','Error de conexión','error'));
  }
}

function normalizeDateString(s){
  if (!s) return '';
  s = String(s).trim();
  if (s.includes(' ')) s = s.split(' ')[0];
  const parts = s.split('-');
  if (parts.length !== 3) return '';
  const y = parts[0];
  let m = parts[1];
  let d = parts[2];
  m = m.padStart(2, '0');
  d = d.padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function renderPagination(total){
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const ul = document.getElementById('paginacionCursos');
  const info = document.getElementById('infoPaginacion');
  if (!ul || !info) return;
  info.textContent = `Página ${currentPage} de ${totalPages} — ${total} registros`;
  ul.innerHTML = '';
  const prevLi = document.createElement('li');
  prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
  prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
  prevLi.addEventListener('click', (e) => { e.preventDefault(); if (currentPage > 1) { currentPage--; mostrarVencimientos(vencimientos); } });
  ul.appendChild(prevLi);
  const nextLi = document.createElement('li');
  nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
  nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
  nextLi.addEventListener('click', (e) => { e.preventDefault(); if (currentPage < totalPages) { currentPage++; mostrarVencimientos(vencimientos); } });
  ul.appendChild(nextLi);
}

function cargarUsuarios(q){
  const params = new URLSearchParams();
  if (q) params.append('q', q);
  params.append('limit', '50');
  params.append('solo_activos', '1');
  fetch('/api/sstt/usuarios' + (params.toString() ? ('?' + params.toString()) : ''))
    .then(r => r.json())
    .then(d => {
      if (!d.success) return;
      const sel = document.getElementById('usuarioSelect');
      sel.innerHTML = '';
  (d.data || []).forEach(u => {
    const opt = document.createElement('option');
    opt.value = String(u.cedula || '');
    opt.textContent = `${u.nombre || ''} — ${u.cedula || ''}`;
    opt.setAttribute('data-nombre', String(u.nombre || ''));
    opt.setAttribute('data-id', String(u.id_codigo_consumidor || ''));
    sel.appendChild(opt);
  });
})
.catch(() => {});
}
</script>
{% endblock %}
