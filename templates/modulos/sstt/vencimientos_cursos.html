{% extends "header.html" %}
{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient text-white fw-bold" style="background: linear-gradient(135deg, #0d6efd 0%, #17a2b8 100%) !important;">
                    <h3 class="mb-0">
                        <i class="fas fa-book-open me-2"></i>Vencimientos de Cursos
                    </h3>
                </div>

                

                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalRegistrarCurso">
                                <i class="fas fa-plus me-2"></i>Registrar Curso
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="btnRefrescar">
                                <i class="fas fa-sync me-2"></i>Refrescar
                            </button>
                        </div>
                        <div>
                            <input type="text" class="form-control" id="buscarVencimiento" placeholder="Buscar...">
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="filtroCedula" placeholder="Cédula">
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Cédula</th>
                                    <th>Nombre</th>
                                    <th>Total Cursos</th>
                                    <th>Vencidos</th>
                                    <th>Por vencer</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaVencimientosCursos"></tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div id="infoPaginacion" class="small text-muted"></div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0" id="paginacionCursos"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalRegistrarCurso" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formRegistrarCurso">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="form-label">Buscar usuario</label>
                            <input type="text" class="form-control" id="buscarUsuarioInput" placeholder="Nombre o cédula">
                        </div>
                        <div class="col-12 mb-3">
                            <select class="form-select" id="usuarioSelect" size="6"></select>
                            <div class="small text-muted mt-1" id="usuarioSeleccionadoInfo"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="cedulaInput" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="cedulaInput" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tipoCursoSelect" class="form-label">Tipo de Curso</label>
                            <select class="form-select" id="tipoCursoSelect" required>
                                <option value="">Seleccionar tipo</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fechaCursoInput" class="form-label">Fecha del Curso</label>
                            <input type="date" class="form-control" id="fechaCursoInput" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fechaVencimientoInput" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="fechaVencimientoInput" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="observacionInput" class="form-label">Observación</label>
                        <textarea class="form-control" id="observacionInput" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnRegistrarCurso">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarCurso" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Curso</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formEditarCurso">
                    <input type="hidden" id="editIdInput">
                    <input type="hidden" id="editOriginalCedula">
                    <input type="hidden" id="editOriginalTipo">
                    <input type="hidden" id="editOriginalFecha">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editCedulaInput" class="form-label">Cédula</label>
                            <input type="text" class="form-control" id="editCedulaInput" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tipoCursoEditSelect" class="form-label">Tipo de Curso</label>
                            <select class="form-select" id="tipoCursoEditSelect" required>
                                <option value="">Seleccionar tipo</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editFechaCursoInput" class="form-label">Fecha del Curso</label>
                            <input type="date" class="form-control" id="editFechaCursoInput" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editFechaVencimientoInput" class="form-label">Fecha de Vencimiento</label>
                            <input type="date" class="form-control" id="editFechaVencimientoInput" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editObservacionInput" class="form-label">Observación</label>
                        <textarea class="form-control" id="editObservacionInput" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnGuardarEdicionCurso">Guardar cambios</button>
            </div>
        </div>
    </div>
    </div>

<div class="modal fade" id="modalAccionesUsuario" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Acciones de Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="d-flex flex-wrap gap-3 align-items-center">
                        <div class="fw-bold" id="accionesNombre"></div>
                        <div class="text-muted" id="accionesCedula"></div>
                        <div class="ms-auto d-flex gap-3">
                            <span class="badge bg-secondary" id="accionesTotal">Total: 0</span>
                            <span class="badge bg-danger" id="accionesVencidos">Vencidos: 0</span>
                            <span class="badge bg-warning text-dark" id="accionesPorVencer">Por vencer: 0</span>
                        </div>
                    </div>
                </div>
                <div class="accordion" id="accordionAcciones">
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#accIngreso">Examen Médico Ingreso</button></h2>
                        <div id="accIngreso" class="accordion-collapse collapse show" data-bs-parent="#accordionAcciones">
                            <div class="accordion-body">
                                <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-primary" id="btnAgregarIngreso">Agregar</button></div>
                                <div class="table-responsive"><table class="table table-sm"><thead><tr><th>Fecha</th><th>Vence</th><th>Días</th><th>Estado</th><th>Año</th><th>Obs</th><th></th></tr></thead><tbody id="tbIngreso"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accPeriodico">Examen Médico Periódico</button></h2>
                        <div id="accPeriodico" class="accordion-collapse collapse" data-bs-parent="#accordionAcciones">
                            <div class="accordion-body">
                                <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-primary" id="btnAgregarPeriodico">Agregar</button></div>
                                <div class="table-responsive"><table class="table table-sm"><thead><tr><th>Fecha</th><th>Vence</th><th>Días</th><th>Estado</th><th>Año</th><th>Obs</th><th></th></tr></thead><tbody id="tbPeriodico"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accAlturas">Curso de Alturas</button></h2>
                        <div id="accAlturas" class="accordion-collapse collapse" data-bs-parent="#accordionAcciones">
                            <div class="accordion-body">
                                <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-primary" id="btnAgregarAlturas">Agregar</button></div>
                                <div class="table-responsive"><table class="table table-sm"><thead><tr><th>Fecha</th><th>Vence</th><th>Días</th><th>Estado</th><th>Año</th><th>Obs</th><th></th></tr></thead><tbody id="tbAlturas"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accManejo">Curso de Manejo Defensivo</button></h2>
                        <div id="accManejo" class="accordion-collapse collapse" data-bs-parent="#accordionAcciones">
                            <div class="accordion-body">
                                <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-primary" id="btnAgregarManejo">Agregar</button></div>
                                <div class="table-responsive"><table class="table table-sm"><thead><tr><th>Fecha</th><th>Vence</th><th>Días</th><th>Estado</th><th>Año</th><th>Obs</th><th></th></tr></thead><tbody id="tbManejo"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accInduccion">Curso de Inducción SST</button></h2>
                        <div id="accInduccion" class="accordion-collapse collapse" data-bs-parent="#accordionAcciones">
                            <div class="accordion-body">
                                <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-primary" id="btnAgregarInduccion">Agregar</button></div>
                                <div class="table-responsive"><table class="table table-sm"><thead><tr><th>Fecha</th><th>Vence</th><th>Días</th><th>Estado</th><th>Año</th><th>Obs</th><th></th></tr></thead><tbody id="tbInduccion"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#accReinduccion">Curso de Reinducción SST</button></h2>
                        <div id="accReinduccion" class="accordion-collapse collapse" data-bs-parent="#accordionAcciones">
                            <div class="accordion-body">
                                <div class="d-flex justify-content-end mb-2"><button class="btn btn-sm btn-primary" id="btnAgregarReinduccion">Agregar</button></div>
                                <div class="table-responsive"><table class="table table-sm"><thead><tr><th>Fecha</th><th>Vence</th><th>Días</th><th>Estado</th><th>Año</th><th>Obs</th><th></th></tr></thead><tbody id="tbReinduccion"></tbody></table></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<script>
let vencimientos = [];
let tiposCurso = [];
let currentPage = 1;
const pageSize = 20;
let accionesCedulaActual = '';
let accionesNombreActual = '';
const TIPOS_CURSO_PREDEF = [
  'EXAMEN MEDICO INGRESO',
  'EXAMEN MEDICO PERIODICO',
  'CURSO ALTURAS',
  'CURSO MANEJO DEFENSIVO',
  'CURSO INDUCCION SST',
  'CURSO REINDUCCION SST'
];

  document.addEventListener('DOMContentLoaded', function() {
    cargarTiposCurso();
    cargarVencimientos();
    document.getElementById('buscarUsuarioInput').addEventListener('input', function(e){ cargarUsuarios(e.target.value.trim()); });
    document.getElementById('usuarioSelect').addEventListener('change', function(){
      const opt = this.options[this.selectedIndex];
      if (!opt) return;
      const ced = opt.value;
      const nom = opt.getAttribute('data-nombre') || '';
      document.getElementById('cedulaInput').value = ced;
      document.getElementById('usuarioSeleccionadoInfo').textContent = nom ? (`Seleccionado: ${nom} (${ced})`) : '';
    });
    document.getElementById('modalRegistrarCurso').addEventListener('shown.bs.modal', function(){ cargarUsuarios(''); });
    document.getElementById('buscarVencimiento').addEventListener('input', aplicarBusquedaLocal);
    document.getElementById('filtroCedula').addEventListener('input', () => { currentPage = 1; cargarVencimientos(); });
    document.getElementById('btnRegistrarCurso').addEventListener('click', registrarCurso);
    document.getElementById('btnRefrescar').addEventListener('click', () => { currentPage = 1; cargarVencimientos(); });
    document.getElementById('btnGuardarEdicionCurso').addEventListener('click', guardarEdicionCurso);
    ['btnAgregarIngreso','btnAgregarPeriodico','btnAgregarAlturas','btnAgregarManejo','btnAgregarInduccion','btnAgregarReinduccion'].forEach(id=>{
      const b = document.getElementById(id); if (b) b.addEventListener('click', ()=>{
        if (!accionesCedulaActual) return;
        const map = {
          'btnAgregarIngreso':'EXAMEN MEDICO INGRESO',
          'btnAgregarPeriodico':'EXAMEN MEDICO PERIODICO',
          'btnAgregarAlturas':'CURSO ALTURAS',
          'btnAgregarManejo':'CURSO MANEJO DEFENSIVO',
          'btnAgregarInduccion':'CURSO INDUCCION SST',
          'btnAgregarReinduccion':'CURSO REINDUCCION SST'
        };
        abrirAgregarCurso(map[id], accionesCedulaActual, accionesNombreActual);
      });
    });
  });

function cargarTiposCurso() {
  fetch('/api/sstt/vencimientos-cursos/tipos')
    .then(r => r.json())
    .then(d => {
      tiposCurso = (d && d.success && Array.isArray(d.data) && d.data.length ? d.data : TIPOS_CURSO_PREDEF);
      const select = document.getElementById('tipoCursoSelect');
      const selectEdit = document.getElementById('tipoCursoEditSelect');
      select.innerHTML = '<option value="">Seleccionar tipo</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
      if (selectEdit) selectEdit.innerHTML = '<option value="">Seleccionar tipo</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
    })
    .catch(() => {
      tiposCurso = TIPOS_CURSO_PREDEF;
      const select = document.getElementById('tipoCursoSelect');
      const selectEdit = document.getElementById('tipoCursoEditSelect');
      select.innerHTML = '<option value="">Seleccionar tipo</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
      if (selectEdit) selectEdit.innerHTML = '<option value="">Seleccionar tipo</option>' + tiposCurso.map(t => `<option value="${t}">${t}</option>`).join('');
    });
}

function cargarVencimientos() {
  const cedula = document.getElementById('filtroCedula').value.trim();
  const params = new URLSearchParams();
  if (cedula) params.append('cedula', cedula);
  params.append('solo_activos', '1');
  fetch('/api/sstt/vencimientos-cursos/resumen' + (params.toString() ? ('?' + params.toString()) : ''))
    .then(r => r.json())
    .then(d => {
      if (!d.success) { Swal.fire('Error', d.message || 'No se pudo cargar la lista', 'error'); return; }
      vencimientos = d.data || [];
      currentPage = 1;
      mostrarVencimientos(vencimientos);
      if ((d.total||0) === 0) {
        const tbody = document.getElementById('tablaVencimientosCursos');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Sin registros</td></tr>';
      }
    })
    .catch(() => {});
}

function mostrarVencimientos(datos) {
  const tbody = document.getElementById('tablaVencimientosCursos');
  tbody.innerHTML = '';
  const total = datos.length;
  const start = (currentPage - 1) * pageSize;
  const pageItems = datos.slice(start, start + pageSize);
  pageItems.forEach(item => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.cedula || ''}</td>
      <td>${item.nombre || ''}</td>
      <td>${item.total_cursos != null ? item.total_cursos : 0}</td>
      <td class="${(item.vencidos||0) > 0 ? 'text-danger fw-bold' : ''}">${item.vencidos != null ? item.vencidos : 0}</td>
      <td class="${(item.por_vencer||0) > 0 ? 'text-warning fw-bold' : ''}">${item.por_vencer != null ? item.por_vencer : 0}</td>
      <td><button class="btn btn-sm btn-outline-primary btnAcciones" data-cedula="${item.cedula || ''}" data-nombre="${item.nombre || ''}" data-total="${item.total_cursos||0}" data-vencidos="${item.vencidos||0}" data-porvencer="${item.por_vencer||0}"><i class="fas fa-ellipsis-h me-1"></i>Acciones</button></td>
    `;
    tbody.appendChild(tr);
    const btn = tr.querySelector('.btnAcciones');
    if (btn) {
      btn.addEventListener('click', () => {
        const ced = btn.getAttribute('data-cedula')||'';
        const nom = btn.getAttribute('data-nombre')||'';
        const total = parseInt(btn.getAttribute('data-total')||'0');
        const venc = parseInt(btn.getAttribute('data-vencidos')||'0');
        const pv = parseInt(btn.getAttribute('data-porvencer')||'0');
        abrirAccionesUsuario({cedula: ced, nombre: nom, total: total, vencidos: venc, por_vencer: pv});
      });
    }
  });
  renderPagination(total);
}

function aplicarBusquedaLocal() {
  const q = document.getElementById('buscarVencimiento').value.toLowerCase().trim();
  if (!q) { mostrarVencimientos(vencimientos); return; }
  const filtrados = vencimientos.filter(v => {
    return String(v.cedula||'').toLowerCase().includes(q)
        || String(v.nombre||'').toLowerCase().includes(q);
  });
  currentPage = 1;
  mostrarVencimientos(filtrados);
}

function registrarCurso() {
  const cedula = document.getElementById('cedulaInput').value.trim();
  const tipo = document.getElementById('tipoCursoSelect').value;
  const fecha = document.getElementById('fechaCursoInput').value;
  const fechaVen = document.getElementById('fechaVencimientoInput').value;
  const observ = document.getElementById('observacionInput').value.trim();
  if (!cedula || !tipo || !fecha || !fechaVen) {
    Swal.fire('Error', 'Completa los campos requeridos', 'error');
    return;
  }
  const payload = {
    recurso_operativo_cedula: cedula,
    sstt_vencimientos_cursos_tipo_curso: tipo,
    sstt_vencimientos_cursos_fecha: fecha,
    sstt_vencimientos_cursos_fecha_ven: fechaVen,
    sstt_vencimientos_cursos_observacion: observ
  };
  fetch('/api/sstt/vencimientos-cursos', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(d => {
    if (d.success) {
      Swal.fire('Éxito', 'Curso registrado correctamente', 'success');
      document.getElementById('formRegistrarCurso').reset();
      const modalEl = document.getElementById('modalRegistrarCurso');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();
      cargarVencimientos();
      if (accionesCedulaActual) cargarCursosUsuario(accionesCedulaActual);
    } else {
      Swal.fire('Error', d.message || 'No se pudo registrar', 'error');
    }
  })
  .catch(() => {
    Swal.fire('Error', 'No se pudo registrar', 'error');
  });
}

function abrirModalEditar(item){
  document.getElementById('editIdInput').value = item.id || '';
  document.getElementById('editOriginalCedula').value = item.recurso_operativo_cedula || '';
  document.getElementById('editOriginalTipo').value = item.tipo_curso || '';
  document.getElementById('editOriginalFecha').value = normalizeDateString(item.fecha);
  document.getElementById('editCedulaInput').value = item.recurso_operativo_cedula || '';
  const sel = document.getElementById('tipoCursoEditSelect');
  if (sel) sel.value = item.tipo_curso || '';
  document.getElementById('editFechaCursoInput').value = normalizeDateString(item.fecha);
  document.getElementById('editFechaVencimientoInput').value = normalizeDateString(item.fecha_vencimiento);
  document.getElementById('editObservacionInput').value = item.observacion || '';
  const modalEl = document.getElementById('modalEditarCurso');
  const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
  modal.show();
}

function guardarEdicionCurso(){
  const id = document.getElementById('editIdInput').value;
  const cedula = document.getElementById('editCedulaInput').value.trim();
  const tipo = document.getElementById('tipoCursoEditSelect').value;
  const fecha = document.getElementById('editFechaCursoInput').value;
  const fechaVen = document.getElementById('editFechaVencimientoInput').value;
  const observ = document.getElementById('editObservacionInput').value.trim();
  if (!cedula || !tipo || !fecha || !fechaVen) { Swal.fire('Error','Completa los campos requeridos','error'); return; }
  const payload = {
    recurso_operativo_cedula: cedula,
    sstt_vencimientos_cursos_tipo_curso: tipo,
    sstt_vencimientos_cursos_fecha: fecha,
    sstt_vencimientos_cursos_fecha_ven: fechaVen,
    sstt_vencimientos_cursos_observacion: observ
  };
  const doSuccess = (d) => {
    if (d && d.success && (d.updated === undefined || d.updated > 0)) {
      Swal.fire('Éxito','Curso actualizado','success');
      const modalEl = document.getElementById('modalEditarCurso');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();
      cargarVencimientos();
      if (accionesCedulaActual) cargarCursosUsuario(accionesCedulaActual);
    } else {
      Swal.fire('Error', (d && d.message) || 'No se pudo actualizar','error');
    }
  };
  if (id) {
    fetch(`/api/sstt/vencimientos-cursos/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(doSuccess)
    .catch(() => Swal.fire('Error','Error de conexión','error'));
  } else {
    const original = {
      original_cedula: document.getElementById('editOriginalCedula').value,
      original_tipo: document.getElementById('editOriginalTipo').value,
      original_fecha: document.getElementById('editOriginalFecha').value
    };
    const body = Object.assign({}, payload, original);
    fetch('/api/sstt/vencimientos-cursos/update-by', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    })
    .then(r => r.json())
    .then(doSuccess)
    .catch(() => Swal.fire('Error','Error de conexión','error'));
  }
}

function normalizeDateString(s){
  if (!s) return '';
  s = String(s).trim();
  if (s.includes(' ')) s = s.split(' ')[0];
  const parts = s.split('-');
  if (parts.length !== 3) return '';
  const y = parts[0];
  let m = parts[1];
  let d = parts[2];
  m = m.padStart(2, '0');
  d = d.padStart(2, '0');
  return `${y}-${m}-${d}`;
}

function renderPagination(total){
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  if (currentPage > totalPages) currentPage = totalPages;
  const ul = document.getElementById('paginacionCursos');
  const info = document.getElementById('infoPaginacion');
  if (!ul || !info) return;
  info.textContent = `Página ${currentPage} de ${totalPages} — ${total} registros`;
  ul.innerHTML = '';
  const prevLi = document.createElement('li');
  prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
  prevLi.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
  prevLi.addEventListener('click', (e) => { e.preventDefault(); if (currentPage > 1) { currentPage--; mostrarVencimientos(vencimientos); } });
  ul.appendChild(prevLi);
  const nextLi = document.createElement('li');
  nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
  nextLi.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
  nextLi.addEventListener('click', (e) => { e.preventDefault(); if (currentPage < totalPages) { currentPage++; mostrarVencimientos(vencimientos); } });
  ul.appendChild(nextLi);
}

function cargarUsuarios(q){
  const params = new URLSearchParams();
  if (q) params.append('q', q);
  params.append('limit', '50');
  params.append('solo_activos', '1');
  fetch('/api/sstt/usuarios' + (params.toString() ? ('?' + params.toString()) : ''))
    .then(r => r.json())
    .then(d => {
      if (!d.success) return;
      const sel = document.getElementById('usuarioSelect');
      sel.innerHTML = '';
  (d.data || []).forEach(u => {
    const opt = document.createElement('option');
    opt.value = String(u.cedula || '');
    opt.textContent = `${u.nombre || ''} — ${u.cedula || ''}`;
    opt.setAttribute('data-nombre', String(u.nombre || ''));
    opt.setAttribute('data-id', String(u.id_codigo_consumidor || ''));
    sel.appendChild(opt);
  });
})
.catch(() => {});
}
function abrirAccionesUsuario(info){
  accionesCedulaActual = info.cedula||'';
  accionesNombreActual = info.nombre||'';
  document.getElementById('accionesNombre').textContent = info.nombre||'';
  document.getElementById('accionesCedula').textContent = info.cedula ? `(${info.cedula})` : '';
  document.getElementById('accionesTotal').textContent = `Total: ${info.total||0}`;
  document.getElementById('accionesVencidos').textContent = `Vencidos: ${info.vencidos||0}`;
  document.getElementById('accionesPorVencer').textContent = `Por vencer: ${info.por_vencer||0}`;
  const modalEl = document.getElementById('modalAccionesUsuario');
  const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
  modal.show();
  cargarCursosUsuario(accionesCedulaActual);
}

function cargarCursosUsuario(cedula){
  if (!cedula) return;
  const params = new URLSearchParams();
  params.append('cedula', cedula);
  params.append('solo_activos','1');
  fetch('/api/sstt/vencimientos-cursos?' + params.toString())
    .then(r=>r.json())
    .then(d=>{
      if (!d.success) return;
      const items = d.data||[];
      renderSeccionesUsuario(items);
    })
    .catch(()=>{});
}

function renderSeccionesUsuario(items){
  const mapTipos = {
    'EXAMEN MEDICO INGRESO': 'tbIngreso',
    'EXAMEN MEDICO PERIODICO': 'tbPeriodico',
    'CURSO ALTURAS': 'tbAlturas',
    'CURSO MANEJO DEFENSIVO': 'tbManejo',
    'CURSO INDUCCION SST': 'tbInduccion',
    'CURSO REINDUCCION SST': 'tbReinduccion'
  };
  Object.values(mapTipos).forEach(id=>{ const el = document.getElementById(id); if (el) el.innerHTML=''; });
  items.forEach(it=>{
    const tbodyId = mapTipos[it.tipo_curso] || null;
    if (!tbodyId) return;
    const tbody = document.getElementById(tbodyId);
    if (!tbody) return;
    const dias = it.dias_por_vencer;
    const estado = (dias == null) ? '' : (dias <= 0 ? 'VENCIDO' : (dias <= 30 ? 'PRÓXIMO A VENCER' : 'VIGENTE'));
    const badgeClass = (dias == null) ? 'bg-secondary' : (dias <= 0 ? 'bg-danger' : (dias <= 30 ? 'bg-warning text-dark' : 'bg-success'));
    const esVencido = (dias != null && dias <= 0);
    const tr = document.createElement('tr');
    const esEncuesta = String(it.observacion||'').indexOf('Encuesta 10') !== -1;
    tr.innerHTML = `
      <td>${it.fecha||''}</td>
      <td>${esEncuesta ? `<input type="date" class="form-control form-control-sm inpFven" value="${normalizeDateString(it.fecha_vencimiento)}">` : (it.fecha_vencimiento||'')}</td>
      <td class="${(dias!=null && dias<=0)?'text-danger fw-bold':(dias!=null && dias<=30)?'text-warning fw-bold':'text-success fw-bold'}">${dias!=null?dias:''}</td>
      <td>${estado?`<span class="badge ${badgeClass}">${estado}</span>`:''}</td>
      <td>${(it.anio!=null)?it.anio:''}</td>
      <td>${it.observacion||''}</td>
      <td>
        <div class="d-flex align-items-center gap-2">
          ${esEncuesta ? `<button class="btn btn-sm btn-success btnGuardarEncuesta">Guardar Vto</button>` : ''}
          ${esVencido ? `<div class="form-check form-switch"><input class="form-check-input chkValidado" type="checkbox" ${String(it.validado||0) === '1' ? 'checked' : ''}></div>` : ''}
          <button class="btn btn-sm btn-outline-primary" data-id="${it.id||''}">Editar</button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
    const btn = tr.querySelector('button');
    if (btn) btn.addEventListener('click', ()=> abrirModalEditar(it));
    const chk = tr.querySelector('.chkValidado');
    if (chk) {
      chk.addEventListener('change', () => {
        toggleValidado(it, !!chk.checked);
      });
    }
    const btnGuardar = tr.querySelector('.btnGuardarEncuesta');
    if (btnGuardar) {
      btnGuardar.addEventListener('click', () => {
        const inp = tr.querySelector('.inpFven');
        const valor = inp ? inp.value : '';
        guardarVencimientoEncuesta(it, valor);
      });
    }
  });
}

function abrirAgregarCurso(tipo, cedula, nombre){
  const modalEl = document.getElementById('modalRegistrarCurso');
  const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
  document.getElementById('cedulaInput').value = cedula||'';
  document.getElementById('usuarioSeleccionadoInfo').textContent = nombre ? (`Seleccionado: ${nombre} (${cedula||''})`) : '';
  const sel = document.getElementById('tipoCursoSelect');
  if (sel) sel.value = tipo||'';
  modal.show();
}

function toggleValidado(item, valor){
  const body = {};
  body['sstt_vencimientos_cursos_validado'] = valor ? 1 : 0;
  const doRefresh = () => {
    cargarVencimientos();
    if (accionesCedulaActual) cargarCursosUsuario(accionesCedulaActual);
  };
  if (item.id) {
    fetch(`/api/sstt/vencimientos-cursos/${item.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    })
    .then(r => r.json())
    .then(d => { if (d && d.success) doRefresh(); })
    .catch(() => {});
  } else {
    const body2 = Object.assign({}, body, {
      original_cedula: item.recurso_operativo_cedula || '',
      original_tipo: item.tipo_curso || '',
      original_fecha: normalizeDateString(item.fecha),
      recurso_operativo_cedula: item.recurso_operativo_cedula || '',
      sstt_vencimientos_cursos_tipo_curso: item.tipo_curso || '',
      sstt_vencimientos_cursos_fecha: normalizeDateString(item.fecha),
      sstt_vencimientos_cursos_fecha_ven: normalizeDateString(item.fecha_vencimiento),
      sstt_vencimientos_cursos_observacion: item.observacion || ''
    });
    fetch('/api/sstt/vencimientos-cursos/update-by', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body2)
    })
    .then(r => r.json())
    .then(d => { if (d && d.success) doRefresh(); })
    .catch(() => {});
  }
}

function guardarVencimientoEncuesta(item, valor){
  if (!valor) return;
  const body = {
    cedula: item.recurso_operativo_cedula || accionesCedulaActual || '',
    encuesta_id: 10,
    anio: item.anio || '',
    fecha: normalizeDateString(item.fecha),
    fecha_vencimiento: normalizeDateString(valor)
  };
  fetch('/api/sstt/vencimientos-cursos/encuesta-vto', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  })
  .then(r => r.json())
  .then(d => {
    if (d && d.success) {
      cargarVencimientos();
      if (accionesCedulaActual) cargarCursosUsuario(accionesCedulaActual);
    } else {
      Swal.fire('Error', (d && d.message) || 'No se pudo actualizar', 'error');
    }
  })
  .catch(() => {});
}

</script>
{% endblock %}
